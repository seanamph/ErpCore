# SYSA1012 - 進銷存月報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1012
- **功能名稱**: 進銷存月報表
- **功能描述**: 提供進銷存月報表的查詢功能，包含商品進銷存月統計、庫存變動分析、進銷存金額統計等
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1012.ascx` (報表頁面)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1012.ascx.cs` (後端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1012.rdlc` (報表定義)
  - `WEB/IMS_CORE/SYSA000/js/SYSA1012.js` (前端腳本)

### 1.2 業務需求
- 支援按月份查詢進銷存統計
- 支援按店別、商品分類篩選
- 支援進貨、銷貨、庫存統計
- 支援報表列印與匯出 (Excel/PDF)
- 支援報表參數設定

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `InventoryMonthlyReport` - 進銷存月報表 (對應舊系統查詢結果)
```sql
-- 此為報表查詢結果，不建立實體表，使用視圖或查詢產生
-- 主要資料來源：
-- 1. InventoryStocks (庫存異動表)
-- 2. Goods (商品主檔)
-- 3. InventoryCost (庫存成本表)
-- 4. PurchaseOrders (採購單)
-- 5. SalesOrders (銷售單)
```

#### 2.1.2 相關資料表
- `InventoryStocks` - 庫存異動表 (參考 SYSA1000)
- `Goods` - 商品主檔 (參考 SYSA1000)
- `InventoryCost` - 庫存成本表 (參考 SYSA1000)
- `PurchaseOrders` - 採購單主檔
- `SalesOrders` - 銷售單主檔

### 2.2 資料字典

| 欄位名稱 | 資料類型 | 說明 | 備註 |
|---------|---------|------|------|
| SiteId | NVARCHAR(50) | 店別代碼 | 查詢條件 |
| GoodsId | NVARCHAR(50) | 商品代碼 | 查詢條件 |
| ReportMonth | NVARCHAR(6) | 報表月份 (YYYYMM) | 查詢條件 |
| BeginQty | DECIMAL(18,2) | 期初數量 | 計算欄位 |
| BeginAmt | DECIMAL(18,2) | 期初金額 | 計算欄位 |
| InQty | DECIMAL(18,2) | 進貨數量 | 計算欄位 |
| InAmt | DECIMAL(18,2) | 進貨金額 | 計算欄位 |
| OutQty | DECIMAL(18,2) | 銷貨數量 | 計算欄位 |
| OutAmt | DECIMAL(18,2) | 銷貨金額 | 計算欄位 |
| EndQty | DECIMAL(18,2) | 期末數量 | 計算欄位 |
| EndAmt | DECIMAL(18,2) | 期末金額 | 計算欄位 |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢進銷存月報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis/inventory-monthly-report`
- **說明**: 查詢進銷存月報表資料
- **請求參數**:
  ```json
  {
    "siteId": "",
    "goodsId": "",
    "bId": "",
    "mId": "",
    "sId": "",
    "reportMonth": "202401",
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "總店",
          "goodsId": "G001",
          "goodsName": "商品A",
          "reportMonth": "202401",
          "beginQty": 100.00,
          "beginAmt": 10000.00,
          "inQty": 50.00,
          "inAmt": 5000.00,
          "outQty": 30.00,
          "outAmt": 3000.00,
          "endQty": 120.00,
          "endAmt": 12000.00
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出進銷存月報表 (Excel)
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis/inventory-monthly-report/export-excel`
- **說明**: 匯出進銷存月報表為 Excel 檔案
- **請求格式**: 同查詢參數
- **回應格式**: Excel 檔案 (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)

#### 3.1.3 匯出進銷存月報表 (PDF)
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis/inventory-monthly-report/export-pdf`
- **說明**: 匯出進銷存月報表為 PDF 檔案
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案 (application/pdf)

### 3.2 後端實作類別

#### 3.2.1 Controller: `InventoryMonthlyReportController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis/inventory-monthly-report")]
    [Authorize]
    public class InventoryMonthlyReportController : ControllerBase
    {
        private readonly IInventoryMonthlyReportService _service;
        
        public InventoryMonthlyReportController(IInventoryMonthlyReportService service)
        {
            _service = service;
        }
        
        [HttpGet]
        public async Task<ActionResult<ApiResponse<PagedResult<InventoryMonthlyReportDto>>>> GetReport([FromQuery] InventoryMonthlyReportQueryDto query)
        {
            var result = await _service.GetReportAsync(query);
            return Ok(ApiResponse.Success(result));
        }
        
        [HttpPost("export-excel")]
        public async Task<IActionResult> ExportExcel([FromBody] InventoryMonthlyReportQueryDto query)
        {
            var file = await _service.ExportExcelAsync(query);
            return File(file.Content, file.ContentType, file.FileName);
        }
        
        [HttpPost("export-pdf")]
        public async Task<IActionResult> ExportPdf([FromBody] InventoryMonthlyReportQueryDto query)
        {
            var file = await _service.ExportPdfAsync(query);
            return File(file.Content, file.ContentType, file.FileName);
        }
    }
}
```

#### 3.2.2 Service: `InventoryMonthlyReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IInventoryMonthlyReportService
    {
        Task<PagedResult<InventoryMonthlyReportDto>> GetReportAsync(InventoryMonthlyReportQueryDto query);
        Task<ExportFileDto> ExportExcelAsync(InventoryMonthlyReportQueryDto query);
        Task<ExportFileDto> ExportPdfAsync(InventoryMonthlyReportQueryDto query);
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 進銷存月報表查詢頁面 (`InventoryMonthlyReport.vue`)
- **路徑**: `/analysis/inventory-monthly-report`
- **功能**: 顯示進銷存月報表查詢結果，支援查詢、列印、匯出
- **主要元件**:
  - 查詢表單 (ReportSearchForm)
  - 資料表格 (ReportDataTable)
  - 報表列印對話框
  - 匯出選項對話框

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`ReportSearchForm.vue`)
```vue
<template>
  <el-form :model="searchForm" inline>
    <el-form-item label="店別">
      <el-select v-model="searchForm.siteId" placeholder="請選擇店別" clearable>
        <el-option v-for="site in siteList" :key="site.siteId" :label="site.siteName" :value="site.siteId" />
      </el-select>
    </el-form-item>
    <el-form-item label="商品代碼">
      <el-input v-model="searchForm.goodsId" placeholder="請輸入商品代碼" clearable />
    </el-form-item>
    <el-form-item label="報表月份">
      <el-date-picker v-model="searchForm.reportMonth" type="month" placeholder="請選擇月份" format="YYYYMM" value-format="YYYYMM" />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button type="success" @click="handleExportExcel">匯出Excel</el-button>
      <el-button type="warning" @click="handleExportPdf">匯出PDF</el-button>
      <el-button type="info" @click="handlePrint">列印</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 資料表格元件 (`ReportDataTable.vue`)
```vue
<template>
  <div>
    <el-table :data="reportList" v-loading="loading" border stripe>
      <el-table-column prop="siteName" label="店別" width="120" fixed="left" />
      <el-table-column prop="goodsId" label="商品代碼" width="120" />
      <el-table-column prop="goodsName" label="商品名稱" width="200" />
      <el-table-column prop="reportMonth" label="報表月份" width="100" />
      <el-table-column prop="beginQty" label="期初數量" width="120" align="right" />
      <el-table-column prop="beginAmt" label="期初金額" width="120" align="right">
        <template #default="{ row }">
          {{ formatCurrency(row.beginAmt) }}
        </template>
      </el-table-column>
      <el-table-column prop="inQty" label="進貨數量" width="120" align="right" />
      <el-table-column prop="inAmt" label="進貨金額" width="120" align="right">
        <template #default="{ row }">
          {{ formatCurrency(row.inAmt) }}
        </template>
      </el-table-column>
      <el-table-column prop="outQty" label="銷貨數量" width="120" align="right" />
      <el-table-column prop="outAmt" label="銷貨金額" width="120" align="right">
        <template #default="{ row }">
          {{ formatCurrency(row.outAmt) }}
        </template>
      </el-table-column>
      <el-table-column prop="endQty" label="期末數量" width="120" align="right" />
      <el-table-column prop="endAmt" label="期末金額" width="120" align="right">
        <template #default="{ row }">
          {{ formatCurrency(row.endAmt) }}
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

### 4.3 API 呼叫 (`inventoryMonthlyReport.api.ts`)
```typescript
import request from '@/utils/request';

export interface InventoryMonthlyReportDto {
  siteId: string;
  siteName: string;
  goodsId: string;
  goodsName: string;
  reportMonth: string;
  beginQty: number;
  beginAmt: number;
  inQty: number;
  inAmt: number;
  outQty: number;
  outAmt: number;
  endQty: number;
  endAmt: number;
}

export interface InventoryMonthlyReportQueryDto {
  siteId?: string;
  goodsId?: string;
  bId?: string;
  mId?: string;
  sId?: string;
  reportMonth?: string;
  pageIndex: number;
  pageSize: number;
}

export const getInventoryMonthlyReport = (query: InventoryMonthlyReportQueryDto) => {
  return request.get<ApiResponse<PagedResult<InventoryMonthlyReportDto>>>('/api/v1/analysis/inventory-monthly-report', { params: query });
};

export const exportInventoryMonthlyReportExcel = (query: InventoryMonthlyReportQueryDto) => {
  return request.post('/api/v1/analysis/inventory-monthly-report/export-excel', query, {
    responseType: 'blob'
  });
};

export const exportInventoryMonthlyReportPdf = (query: InventoryMonthlyReportQueryDto) => {
  return request.post('/api/v1/analysis/inventory-monthly-report/export-pdf', query, {
    responseType: 'blob'
  });
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (0.5天)
- [ ] 確認資料表結構
- [ ] 建立查詢視圖或預存程序
- [ ] 建立索引優化

### 5.2 階段二: 後端開發 (2天)
- [ ] DTO 類別建立
- [ ] Service 實作
- [ ] Controller 實作
- [ ] 報表查詢邏輯實作
- [ ] Excel 匯出功能實作
- [ ] PDF 匯出功能實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 查詢頁面開發
- [ ] 查詢表單開發
- [ ] 資料表格開發
- [ ] Excel 匯出功能
- [ ] PDF 匯出功能
- [ ] 列印功能
- [ ] 元件測試

### 5.4 階段四: 整合測試 (1天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試

### 5.5 階段五: 文件與部署 (0.5天)
- [ ] API 文件更新
- [ ] 使用者手冊

**總計**: 6天

---

## 六、注意事項

### 6.1 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 必須使用快取機制
- 報表查詢建議使用預存程序

### 6.2 資料驗證
- 報表月份必須驗證格式 (YYYYMM)
- 日期範圍必須驗證
- 店別、商品代碼必須驗證存在

### 6.3 業務邏輯
- 期初數量 = 上期期末數量
- 期末數量 = 期初數量 + 進貨數量 - 銷貨數量
- 金額計算必須考慮稅率

---

## 七、測試案例

### 7.1 單元測試
- [ ] 查詢進銷存月報表成功
- [ ] 查詢進銷存月報表失敗 (無資料)
- [ ] 匯出 Excel 成功
- [ ] 匯出 PDF 成功

### 7.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 匯出功能測試
- [ ] 列印功能測試
- [ ] 錯誤處理測試

### 7.3 效能測試
- [ ] 大量資料查詢測試
- [ ] 報表匯出效能測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1012.ascx`
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1012.ascx.cs`
- `WEB/IMS_CORE/SYSA000/js/SYSA1012.js`
- `WEB/IMS_CORE/SYSA000/SYSA1012.rdlc`

### 8.2 資料庫 Schema
- `WEB/IMS_CORE/SYSA000/SYSA1000.xsd`

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

