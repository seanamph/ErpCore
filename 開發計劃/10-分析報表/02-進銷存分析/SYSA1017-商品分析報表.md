# SYSA1017 - 商品分析報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1017
- **功能名稱**: 商品分析報表
- **功能描述**: 提供商品分析報表的查詢功能，支援依組織、店別、年月、篩選類型等條件查詢商品庫存資訊，包含商品名稱、單位、數量、安全庫存量等資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1017.ascx` (查詢頁面)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1017.ascx.cs` (後端邏輯)
  - `WEB/IMS_CORE/SYSA000/js/SYSA1017.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1017.rdlc` (報表定義)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx` (報表展示頁面)

### 1.2 業務需求
- 支援依組織查詢
- 支援依店別查詢
- 支援依年月查詢
- 支援依篩選類型查詢（全部、低於安全庫存量等）
- 支援報表列印與匯出
- 顯示商品庫存資訊（商品名稱、單位、數量、安全庫存量等）
- 支援報表狀態權限控制（report_status）
- 支援組織權限控制（org_id）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `Goods` - 商品主檔 (對應舊系統 `IMS_AM.NAM_GOODS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `Goods` 資料表結構

#### 2.1.2 `InventoryStocks` - 庫存資料表 (對應舊系統 `IMS_AM.NAM_AM_STOCKS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `InventoryStocks` 資料表結構

#### 2.1.3 `Sites` - 店別主檔
- 參考: `開發計劃/02-基本資料管理/04-組織架構/SYSWB60-庫別資料維護作業.md` 的 `Sites` 資料表結構

#### 2.1.4 `Organizations` - 組織主檔
- 參考: `開發計劃/02-基本資料管理/04-組織架構/SYSWB40-部別資料維護作業.md` 的 `Organizations` 資料表結構

#### 2.1.5 `Users` - 使用者主檔
- 參考: `開發計劃/01-系統管理/01-使用者管理/SYS0110-使用者基本資料維護.md` 的 `Users` 資料表結構
- 用於取得使用者的 `report_status` 和 `GROUP` (org_id) 權限

### 2.2 報表資料結構

#### 2.2.1 報表資料集結構
```sql
-- 報表查詢結果結構
SELECT 
    SITE_ID,
    SITE_NAME,
    REPORT_NAME,
    SEQ_NO,
    B_ID,
    M_ID,
    S_ID,
    GOODS_ID,
    GOODS_NAME,
    PACK_UNIT,
    UNIT,
    QTY,
    SAFE_QTY,
    SELECT_TYPE,
    YEAR_MONTH,
    ORG_ID
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作）
```

### 2.3 資料字典

#### 報表查詢結果欄位

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| SiteId | NVARCHAR | 50 | YES | - | 店別代碼 | - |
| SiteName | NVARCHAR | 100 | YES | - | 店別名稱 | - |
| ReportName | NVARCHAR | 100 | NO | '商品分析報表' | 報表名稱 | - |
| SeqNo | INT | - | NO | - | 序號 | - |
| BId | NVARCHAR | 50 | YES | - | 大分類代碼 | - |
| MId | NVARCHAR | 50 | YES | - | 中分類代碼 | - |
| SId | NVARCHAR | 50 | YES | - | 小分類代碼 | - |
| GoodsId | NVARCHAR | 50 | NO | - | 商品代碼 | - |
| GoodsName | NVARCHAR | 200 | YES | - | 商品名稱 | - |
| PackUnit | NVARCHAR | 20 | YES | - | 包裝單位 | - |
| Unit | NVARCHAR | 20 | YES | - | 單位 | - |
| Qty | DECIMAL | 18,2 | NO | 0 | 數量 | - |
| SafeQty | DECIMAL | 18,2 | YES | 0 | 安全庫存量 | - |
| SelectType | NVARCHAR | 50 | YES | - | 篩選類型 | 全部、低於安全庫存量等 |
| YearMonth | NVARCHAR | 6 | YES | - | 年月 (YYYYMM) | - |
| OrgId | NVARCHAR | 50 | YES | - | 組織代碼 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢商品分析報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1017`
- **說明**: 查詢商品分析報表資料
- **請求參數**:
  ```json
  {
    "orgId": "",
    "siteId": "",
    "yearMonth": "",
    "filterType": "", // 篩選類型 (全部、低於安全庫存量等)
    "bId": "",
    "mId": "",
    "sId": "",
    "goodsId": "",
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "店別名稱",
          "reportName": "商品分析報表",
          "seqNo": 1,
          "bId": "B001",
          "mId": "M001",
          "sId": "S001",
          "goodsId": "G001",
          "goodsName": "商品名稱",
          "packUnit": "箱",
          "unit": "個",
          "qty": 100.00,
          "safeQty": 50.00,
          "selectType": "全部",
          "yearMonth": "202401",
          "orgId": "ORG001"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1017/export`
- **說明**: 匯出商品分析報表（Excel/PDF）
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

#### 3.1.3 列印商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1017/print`
- **說明**: 列印商品分析報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

#### 3.1.4 取得使用者報表權限
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/report-permissions`
- **說明**: 取得使用者的報表權限（report_status、org_id、可視店別等）
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "reportStatus": "{}",
      "orgId": "ORG001",
      "viewSites": ["SITE001", "SITE002"]
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

### 3.2 後端實作類別

#### 3.2.1 Controller: `AnalysisReportsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis-reports")]
    [Authorize]
    public class AnalysisReportsController : ControllerBase
    {
        private readonly IAnalysisReportService _analysisReportService;
        
        public AnalysisReportsController(IAnalysisReportService analysisReportService)
        {
            _analysisReportService = analysisReportService;
        }
        
        [HttpGet("sysa1017")]
        public async Task<ActionResult<ApiResponse<PagedResult<SYSA1017ReportDto>>>> GetSYSA1017Report([FromQuery] SYSA1017QueryDto query)
        {
            var result = await _analysisReportService.GetSYSA1017ReportAsync(query);
            return Ok(ApiResponse.Success(result));
        }
        
        [HttpPost("sysa1017/export")]
        public async Task<IActionResult> ExportSYSA1017Report([FromBody] SYSA1017QueryDto query, [FromQuery] string format = "excel")
        {
            var fileBytes = await _analysisReportService.ExportSYSA1017ReportAsync(query, format);
            var fileName = $"SYSA1017_商品分析報表_{DateTime.Now:yyyyMMddHHmmss}.{(format == "excel" ? "xlsx" : "pdf")}";
            return File(fileBytes, format == "excel" ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" : "application/pdf", fileName);
        }
        
        [HttpPost("sysa1017/print")]
        public async Task<IActionResult> PrintSYSA1017Report([FromBody] SYSA1017QueryDto query)
        {
            var fileBytes = await _analysisReportService.PrintSYSA1017ReportAsync(query);
            var fileName = $"SYSA1017_商品分析報表_{DateTime.Now:yyyyMMddHHmmss}.pdf";
            return File(fileBytes, "application/pdf", fileName);
        }
    }
}
```

#### 3.2.2 Service: `AnalysisReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IAnalysisReportService
    {
        Task<PagedResult<SYSA1017ReportDto>> GetSYSA1017ReportAsync(SYSA1017QueryDto query);
        Task<byte[]> ExportSYSA1017ReportAsync(SYSA1017QueryDto query, string format);
        Task<byte[]> PrintSYSA1017ReportAsync(SYSA1017QueryDto query);
    }
    
    public class AnalysisReportService : IAnalysisReportService
    {
        private readonly IDbConnection _db;
        private readonly IExcelService _excelService;
        private readonly IPdfService _pdfService;
        private readonly ICurrentUserService _currentUserService;
        
        public AnalysisReportService(
            IDbConnection db, 
            IExcelService excelService, 
            IPdfService pdfService,
            ICurrentUserService currentUserService)
        {
            _db = db;
            _excelService = excelService;
            _pdfService = pdfService;
            _currentUserService = currentUserService;
        }
        
        public async Task<PagedResult<SYSA1017ReportDto>> GetSYSA1017ReportAsync(SYSA1017QueryDto query)
        {
            // 取得使用者權限
            var user = await _currentUserService.GetCurrentUserAsync();
            var userPermissions = await GetUserReportPermissionsAsync(user.UserId);
            
            // 實作查詢邏輯
            var sql = @"
                SELECT 
                    s.SiteId AS SiteId,
                    s.SiteName AS SiteName,
                    '商品分析報表' AS ReportName,
                    ROW_NUMBER() OVER (ORDER BY g.GoodsId) AS SeqNo,
                    g.BId AS BId,
                    g.MId AS MId,
                    g.SId AS SId,
                    g.GoodsId AS GoodsId,
                    g.GoodsName AS GoodsName,
                    g.PackUnit AS PackUnit,
                    g.Unit AS Unit,
                    ISNULL(st.Qty, 0) AS Qty,
                    ISNULL(g.SafeQty, 0) AS SafeQty,
                    @FilterType AS SelectType,
                    @YearMonth AS YearMonth,
                    st.OrgId AS OrgId
                FROM Goods g
                LEFT JOIN InventoryStocks st ON g.GoodsId = st.GoodsId
                LEFT JOIN Sites s ON st.SiteId = s.SiteId
                WHERE 1=1
                    AND (@SiteId IS NULL OR st.SiteId = @SiteId)
                    AND (@OrgId IS NULL OR st.OrgId = @OrgId)
                    AND (@BId IS NULL OR g.BId = @BId)
                    AND (@MId IS NULL OR g.MId = @MId)
                    AND (@SId IS NULL OR g.SId = @SId)
                    AND (@GoodsId IS NULL OR g.GoodsId = @GoodsId)
                    AND (@YearMonth IS NULL OR FORMAT(st.StockDate, 'yyyyMM') = @YearMonth)
                    AND (@FilterType IS NULL OR @FilterType = '全部' OR (@FilterType = '低於安全庫存量' AND st.Qty < g.SafeQty))
                    -- 權限控制
                    AND (@ViewSites IS NULL OR st.SiteId IN (SELECT value FROM STRING_SPLIT(@ViewSites, ',')))
                ORDER BY g.GoodsId
                OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
            ";
            
            var parameters = new
            {
                SiteId = query.SiteId,
                OrgId = query.OrgId ?? userPermissions.OrgId,
                BId = query.BId,
                MId = query.MId,
                SId = query.SId,
                GoodsId = query.GoodsId,
                YearMonth = query.YearMonth,
                FilterType = query.FilterType ?? "全部",
                ViewSites = userPermissions.ViewSites != null ? string.Join(",", userPermissions.ViewSites) : null,
                Offset = (query.PageIndex - 1) * query.PageSize,
                PageSize = query.PageSize
            };
            
            var items = await _db.QueryAsync<SYSA1017ReportDto>(sql, parameters);
            var totalCount = await _db.QuerySingleAsync<int>("SELECT COUNT(*) FROM ...", parameters);
            
            return new PagedResult<SYSA1017ReportDto>
            {
                Items = items.ToList(),
                TotalCount = totalCount,
                PageIndex = query.PageIndex,
                PageSize = query.PageSize,
                TotalPages = (int)Math.Ceiling(totalCount / (double)query.PageSize)
            };
        }
        
        public async Task<byte[]> ExportSYSA1017ReportAsync(SYSA1017QueryDto query, string format)
        {
            var data = await GetSYSA1017ReportAsync(query);
            
            if (format == "excel")
            {
                return await _excelService.ExportToExcelAsync(data.Items, "商品分析報表");
            }
            else
            {
                return await _pdfService.ExportToPdfAsync(data.Items, "商品分析報表");
            }
        }
        
        public async Task<byte[]> PrintSYSA1017ReportAsync(SYSA1017QueryDto query)
        {
            var data = await GetSYSA1017ReportAsync(query);
            return await _pdfService.PrintReportAsync(data.Items, "SYSA1017", query);
        }
        
        private async Task<UserReportPermissions> GetUserReportPermissionsAsync(string userId)
        {
            var sql = @"
                SELECT 
                    ReportStatus,
                    [Group] AS OrgId
                FROM Users
                WHERE UserId = @UserId;
            ";
            
            var user = await _db.QueryFirstOrDefaultAsync<dynamic>(sql, new { UserId = userId });
            
            // 解析 report_status 取得可視店別
            var viewSites = new List<string>();
            if (!string.IsNullOrEmpty(user?.ReportStatus))
            {
                // 解析 JSON 或字串格式的 report_status
                // 實際實作需根據舊系統的 report_status 格式
            }
            
            return new UserReportPermissions
            {
                ReportStatus = user?.ReportStatus,
                OrgId = user?.OrgId,
                ViewSites = viewSites
            };
        }
    }
    
    public class UserReportPermissions
    {
        public string ReportStatus { get; set; }
        public string OrgId { get; set; }
        public List<string> ViewSites { get; set; }
    }
}
```

#### 3.2.3 DTO: `SYSA1017QueryDto.cs` 和 `SYSA1017ReportDto.cs`
```csharp
namespace RSL.IMS3.Application.DTOs
{
    public class SYSA1017QueryDto : PagedQueryDto
    {
        public string OrgId { get; set; }
        public string SiteId { get; set; }
        public string YearMonth { get; set; } // YYYYMM
        public string FilterType { get; set; } // 全部、低於安全庫存量等
        public string BId { get; set; }
        public string MId { get; set; }
        public string SId { get; set; }
        public string GoodsId { get; set; }
    }
    
    public class SYSA1017ReportDto
    {
        public string SiteId { get; set; }
        public string SiteName { get; set; }
        public string ReportName { get; set; }
        public int SeqNo { get; set; }
        public string BId { get; set; }
        public string MId { get; set; }
        public string SId { get; set; }
        public string GoodsId { get; set; }
        public string GoodsName { get; set; }
        public string PackUnit { get; set; }
        public string Unit { get; set; }
        public decimal Qty { get; set; }
        public decimal SafeQty { get; set; }
        public string SelectType { get; set; }
        public string YearMonth { get; set; }
        public string OrgId { get; set; }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 查詢頁面 (`/analysis-reports/sysa1017`)
- **路由**: `/analysis-reports/sysa1017`
- **組件**: `SYSA1017Query.vue`
- **功能**: 查詢條件設定、報表查詢、報表列印、報表匯出

#### 4.1.2 報表展示頁面 (`/analysis-reports/sysa1017/view`)
- **路由**: `/analysis-reports/sysa1017/view`
- **組件**: `SYSA1017ReportView.vue`
- **功能**: 報表資料展示、報表列印、報表匯出

### 4.2 查詢頁面設計

#### 4.2.1 查詢條件表單
```vue
<template>
  <div class="sysa1017-query">
    <el-card>
      <template #header>
        <span>商品分析報表 - 查詢</span>
      </template>
      
      <el-form :model="queryForm" label-width="120px">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="組織" prop="orgId">
              <el-select v-model="queryForm.orgId" placeholder="請選擇組織" clearable :disabled="!canChangeOrg">
                <el-option
                  v-for="org in orgList"
                  :key="org.orgId"
                  :label="org.orgName"
                  :value="org.orgId"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="店別" prop="siteId">
              <el-select v-model="queryForm.siteId" placeholder="請選擇店別" clearable :disabled="!canChangeSite">
                <el-option
                  v-for="site in siteList"
                  :key="site.siteId"
                  :label="site.siteName"
                  :value="site.siteId"
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="年月" prop="yearMonth">
              <el-date-picker
                v-model="queryForm.yearMonth"
                type="month"
                placeholder="請選擇年月"
                format="yyyyMM"
                value-format="yyyyMM"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="篩選類型" prop="filterType">
              <el-select v-model="queryForm.filterType" placeholder="請選擇篩選類型" clearable>
                <el-option label="全部" value="全部" />
                <el-option label="低於安全庫存量" value="低於安全庫存量" />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="大分類" prop="bId">
              <el-select v-model="queryForm.bId" placeholder="請選擇大分類" clearable>
                <el-option
                  v-for="category in bCategoryList"
                  :key="category.categoryId"
                  :label="category.categoryName"
                  :value="category.categoryId"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="中分類" prop="mId">
              <el-select v-model="queryForm.mId" placeholder="請選擇中分類" clearable>
                <el-option
                  v-for="category in mCategoryList"
                  :key="category.categoryId"
                  :label="category.categoryName"
                  :value="category.categoryId"
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="小分類" prop="sId">
              <el-select v-model="queryForm.sId" placeholder="請選擇小分類" clearable>
                <el-option
                  v-for="category in sCategoryList"
                  :key="category.categoryId"
                  :label="category.categoryName"
                  :value="category.categoryId"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="商品代碼" prop="goodsId">
              <el-input v-model="queryForm.goodsId" placeholder="請輸入商品代碼" clearable />
            </el-form-item>
          </el-col>
        </el-row>
        <el-form-item>
          <el-button type="primary" @click="handleQuery">查詢</el-button>
          <el-button @click="handleReset">重置</el-button>
          <el-button type="success" @click="handleExport">匯出</el-button>
          <el-button type="warning" @click="handlePrint">列印</el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { analysisReportApi } from '@/api/analysis-reports'
import { userApi } from '@/api/user'
import type { SYSA1017QueryDto } from '@/types/analysis-reports'

const router = useRouter()
const queryForm = reactive<SYSA1017QueryDto>({
  orgId: '',
  siteId: '',
  yearMonth: '',
  filterType: '全部',
  bId: '',
  mId: '',
  sId: '',
  goodsId: '',
  pageIndex: 1,
  pageSize: 20
})

const siteList = ref([])
const orgList = ref([])
const bCategoryList = ref([])
const mCategoryList = ref([])
const sCategoryList = ref([])
const canChangeOrg = ref(false)
const canChangeSite = ref(false)

// 載入使用者權限
const loadUserPermissions = async () => {
  try {
    const response = await userApi.getReportPermissions()
    if (response.success) {
      const permissions = response.data
      queryForm.orgId = permissions.orgId || ''
      canChangeOrg.value = false // 根據權限設定
      canChangeSite.value = permissions.viewSites && permissions.viewSites.length > 0 ? false : true
      
      // 載入可視店別列表
      if (permissions.viewSites && permissions.viewSites.length > 0) {
        siteList.value = await loadSites(permissions.viewSites)
      } else {
        siteList.value = await loadAllSites()
      }
    }
  } catch (error) {
    ElMessage.error('載入使用者權限失敗')
  }
}

const handleQuery = async () => {
  // 導航到報表展示頁面
  router.push({
    path: '/analysis-reports/sysa1017/view',
    query: queryForm
  })
}

const handleReset = () => {
  Object.assign(queryForm, {
    orgId: '',
    siteId: '',
    yearMonth: '',
    filterType: '全部',
    bId: '',
    mId: '',
    sId: '',
    goodsId: '',
    pageIndex: 1,
    pageSize: 20
  })
  loadUserPermissions()
}

const handleExport = async () => {
  try {
    const response = await analysisReportApi.exportSYSA1017(queryForm, 'excel')
    const blob = new Blob([response.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = `SYSA1017_商品分析報表_${new Date().toISOString().slice(0, 10)}.xlsx`
    link.click()
    window.URL.revokeObjectURL(url)
    ElMessage.success('匯出成功')
  } catch (error) {
    ElMessage.error('匯出失敗')
  }
}

const handlePrint = async () => {
  try {
    const response = await analysisReportApi.printSYSA1017(queryForm)
    const blob = new Blob([response.data], { type: 'application/pdf' })
    const url = window.URL.createObjectURL(blob)
    window.open(url, '_blank')
    ElMessage.success('列印成功')
  } catch (error) {
    ElMessage.error('列印失敗')
  }
}

onMounted(() => {
  loadUserPermissions()
  loadOrgList()
  loadCategoryList()
})
</script>
```

### 4.3 報表展示頁面設計

#### 4.3.1 報表資料表格
```vue
<template>
  <div class="sysa1017-report-view">
    <el-card>
      <template #header>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <span>商品分析報表 - 查詢結果</span>
          <div>
            <el-button type="success" @click="handleExport">匯出</el-button>
            <el-button type="warning" @click="handlePrint">列印</el-button>
          </div>
        </div>
      </template>
      
      <el-table :data="reportData" border stripe style="width: 100%">
        <el-table-column prop="seqNo" label="序號" width="80" align="center" />
        <el-table-column prop="siteName" label="店別" width="120" />
        <el-table-column prop="goodsId" label="商品代碼" width="120" />
        <el-table-column prop="goodsName" label="商品名稱" width="200" />
        <el-table-column prop="packUnit" label="包裝單位" width="100" />
        <el-table-column prop="unit" label="單位" width="80" />
        <el-table-column prop="qty" label="數量" width="120" align="right" />
        <el-table-column prop="safeQty" label="安全庫存量" width="120" align="right" />
        <el-table-column prop="selectType" label="篩選類型" width="120" />
        <el-table-column prop="yearMonth" label="年月" width="100" />
      </el-table>
      
      <el-pagination
        v-model:current-page="pagination.pageIndex"
        v-model:page-size="pagination.pageSize"
        :total="pagination.totalCount"
        :page-sizes="[20, 50, 100, 200]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleSizeChange"
        @current-change="handlePageChange"
        style="margin-top: 20px; justify-content: flex-end"
      />
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import { analysisReportApi } from '@/api/analysis-reports'
import type { SYSA1017ReportDto } from '@/types/analysis-reports'

const route = useRoute()
const reportData = ref<SYSA1017ReportDto[]>([])
const pagination = ref({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
})

const loadReportData = async () => {
  try {
    const query = {
      ...route.query,
      pageIndex: pagination.value.pageIndex,
      pageSize: pagination.value.pageSize
    }
    const response = await analysisReportApi.getSYSA1017(query)
    if (response.success) {
      reportData.value = response.data.items
      pagination.value.totalCount = response.data.totalCount
    } else {
      ElMessage.error(response.message || '載入報表資料失敗')
    }
  } catch (error) {
    ElMessage.error('載入報表資料失敗')
  }
}

const handleSizeChange = (size: number) => {
  pagination.value.pageSize = size
  pagination.value.pageIndex = 1
  loadReportData()
}

const handlePageChange = (page: number) => {
  pagination.value.pageIndex = page
  loadReportData()
}

const handleExport = async () => {
  // 同查詢頁面的匯出邏輯
}

const handlePrint = async () => {
  // 同查詢頁面的列印邏輯
}

onMounted(() => {
  loadReportData()
})
</script>
```

---

## 五、開發任務清單

### 5.1 後端開發
- [ ] 建立 `SYSA1017QueryDto` 和 `SYSA1017ReportDto` DTO 類別
- [ ] 實作 `AnalysisReportService.GetSYSA1017ReportAsync` 方法
- [ ] 實作 `AnalysisReportService.ExportSYSA1017ReportAsync` 方法
- [ ] 實作 `AnalysisReportService.PrintSYSA1017ReportAsync` 方法
- [ ] 實作 `GetUserReportPermissionsAsync` 方法
- [ ] 建立 `AnalysisReportsController.GetSYSA1017Report` API 端點
- [ ] 建立 `AnalysisReportsController.ExportSYSA1017Report` API 端點
- [ ] 建立 `AnalysisReportsController.PrintSYSA1017Report` API 端點
- [ ] 建立 `UsersController.GetReportPermissions` API 端點
- [ ] 撰寫單元測試

### 5.2 前端開發
- [ ] 建立 `SYSA1017Query.vue` 查詢頁面組件
- [ ] 建立 `SYSA1017ReportView.vue` 報表展示頁面組件
- [ ] 建立 `analysisReportApi.getSYSA1017` API 方法
- [ ] 建立 `analysisReportApi.exportSYSA1017` API 方法
- [ ] 建立 `analysisReportApi.printSYSA1017` API 方法
- [ ] 建立 `userApi.getReportPermissions` API 方法
- [ ] 建立路由設定
- [ ] 建立類型定義
- [ ] 撰寫單元測試

### 5.3 資料庫開發
- [ ] 確認 `Goods` 資料表結構
- [ ] 確認 `InventoryStocks` 資料表結構
- [ ] 確認 `Sites` 資料表結構
- [ ] 確認 `Organizations` 資料表結構
- [ ] 確認 `Users` 資料表的 `ReportStatus` 和 `Group` 欄位
- [ ] 建立必要的索引
- [ ] 撰寫查詢效能測試

### 5.4 測試
- [ ] 單元測試
- [ ] 整合測試
- [ ] 效能測試
- [ ] 使用者驗收測試

---

## 六、注意事項

1. **權限控制**: 需要根據使用者的 `report_status` 和 `org_id` 控制查詢範圍，特別是店別的可視權限
2. **查詢效能**: 由於報表查詢可能涉及大量資料，需要優化查詢效能，建議使用適當的索引和分頁查詢
3. **年月格式**: 年月使用 YYYYMM 格式（如 202401），需要在前端和後端都進行格式驗證
4. **報表格式**: 支援 Excel 和 PDF 兩種格式的匯出，需要確保格式正確
5. **篩選類型**: 篩選類型包括「全部」和「低於安全庫存量」，需要正確實作篩選邏輯
6. **資料快取**: 對於大量資料的報表，可以考慮使用快取機制提升效能

