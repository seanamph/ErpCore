# SYSA1021 - 月成本報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1021
- **功能名稱**: 月成本報表
- **功能描述**: 提供月成本報表的查詢功能，支援依大分類、中分類、小分類、商品代碼、年月等條件查詢商品成本資訊，包含商品名稱、單位、數量、成本金額、平均成本等資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1021.ascx` (查詢頁面)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1021.ascx.cs` (後端邏輯)
  - `WEB/IMS_CORE/SYSA000/js/SYSA1021.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1021.rdlc` (報表定義)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx` (報表展示頁面)

### 1.2 業務需求
- 支援依大分類、中分類、小分類、商品代碼查詢
- 支援依年月查詢
- 支援依篩選類型查詢（全部、有成本、無成本等）
- 支援報表列印與匯出
- 顯示商品成本資訊（商品名稱、單位、數量、成本金額、平均成本等）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `Goods` - 商品主檔 (對應舊系統 `IMS_AM.NAM_GOODS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `Goods` 資料表結構

#### 2.1.2 `GoodsCosts` - 商品成本表
```sql
CREATE TABLE [dbo].[GoodsCosts] (
    [CostId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [GoodsId] NVARCHAR(50) NOT NULL,
    [YearMonth] NVARCHAR(6) NOT NULL, -- YYYYMM
    [SiteId] NVARCHAR(50) NULL,
    [Qty] DECIMAL(18, 2) NOT NULL DEFAULT 0,
    [CostAmount] DECIMAL(18, 2) NOT NULL DEFAULT 0,
    [AvgCost] DECIMAL(18, 2) NOT NULL DEFAULT 0,
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'A',
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_GoodsCosts_Goods] FOREIGN KEY ([GoodsId]) REFERENCES [dbo].[Goods] ([GoodsId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_GoodsCosts_GoodsId] ON [dbo].[GoodsCosts] ([GoodsId]);
CREATE NONCLUSTERED INDEX [IX_GoodsCosts_YearMonth] ON [dbo].[GoodsCosts] ([YearMonth]);
CREATE NONCLUSTERED INDEX [IX_GoodsCosts_SiteId] ON [dbo].[GoodsCosts] ([SiteId]);
CREATE NONCLUSTERED INDEX [IX_GoodsCosts_GoodsId_YearMonth] ON [dbo].[GoodsCosts] ([GoodsId], [YearMonth]);
```

### 2.2 報表資料結構

#### 2.2.1 報表資料集結構
```sql
-- 報表查詢結果結構
SELECT 
    site_id,
    goods_id,
    goods_name,
    SITE_NAME,
    REPORT_NAME,
    year_month,
    b_id,
    m_id,
    s_id,
    qty,
    cost_amount,
    avg_cost
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作）
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢月成本報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1021`
- **說明**: 查詢月成本報表資料
- **請求參數**:
  ```json
  {
    "siteId": "",
    "bId": "",
    "mId": "",
    "sId": "",
    "goodsId": "",
    "yearMonth": "202401",
    "filterType": "全部",
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "店別名稱",
          "reportName": "月成本報表",
          "yearMonth": "202401",
          "bId": "B001",
          "mId": "M001",
          "sId": "S001",
          "goodsId": "G001",
          "goodsName": "商品名稱",
          "qty": 100,
          "costAmount": 10000,
          "avgCost": 100
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出月成本報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1021/export`
- **說明**: 匯出月成本報表（Excel/PDF）
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

#### 3.1.3 列印月成本報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1021/print`
- **說明**: 列印月成本報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

### 3.2 後端實作類別

#### 3.2.1 Controller: `AnalysisReportsController.cs`
```csharp
[HttpGet("sysa1021")]
public async Task<ActionResult<ApiResponse<PagedResult<SYSA1021ReportDto>>>> GetSYSA1021Report([FromQuery] SYSA1021QueryDto query)
{
    var result = await _analysisReportService.GetSYSA1021ReportAsync(query);
    return Ok(ApiResponse.Success(result));
}

[HttpPost("sysa1021/export")]
public async Task<IActionResult> ExportSYSA1021Report([FromBody] SYSA1021QueryDto query, [FromQuery] string format = "excel")
{
    var fileBytes = await _analysisReportService.ExportSYSA1021ReportAsync(query, format);
    var fileName = $"SYSA1021_月成本報表_{DateTime.Now:yyyyMMddHHmmss}.{(format == "excel" ? "xlsx" : "pdf")}";
    return File(fileBytes, format == "excel" ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" : "application/pdf", fileName);
}

[HttpPost("sysa1021/print")]
public async Task<IActionResult> PrintSYSA1021Report([FromBody] SYSA1021QueryDto query)
{
    var fileBytes = await _analysisReportService.PrintSYSA1021ReportAsync(query);
    var fileName = $"SYSA1021_月成本報表_{DateTime.Now:yyyyMMddHHmmss}.pdf";
    return File(fileBytes, "application/pdf", fileName);
}
```

#### 3.2.2 Service: `AnalysisReportService.cs`
```csharp
public async Task<PagedResult<SYSA1021ReportDto>> GetSYSA1021ReportAsync(SYSA1021QueryDto query)
{
    var sql = @"
        SELECT 
            s.SiteId AS SiteId,
            s.SiteName AS SiteName,
            '月成本報表' AS ReportName,
            gc.YearMonth AS YearMonth,
            g.BId AS BId,
            g.MId AS MId,
            g.SId AS SId,
            g.GoodsId AS GoodsId,
            g.GoodsName AS GoodsName,
            gc.Qty AS Qty,
            gc.CostAmount AS CostAmount,
            gc.AvgCost AS AvgCost
        FROM GoodsCosts gc
        INNER JOIN Goods g ON gc.GoodsId = g.GoodsId
        LEFT JOIN Sites s ON gc.SiteId = s.SiteId
        WHERE 1=1
            AND (@SiteId IS NULL OR gc.SiteId = @SiteId)
            AND (@BId IS NULL OR g.BId = @BId)
            AND (@MId IS NULL OR g.MId = @MId)
            AND (@SId IS NULL OR g.SId = @SId)
            AND (@GoodsId IS NULL OR g.GoodsId = @GoodsId)
            AND (@YearMonth IS NULL OR gc.YearMonth = @YearMonth)
            AND (@FilterType = '全部' OR (@FilterType = '有成本' AND gc.CostAmount > 0) OR (@FilterType = '無成本' AND gc.CostAmount = 0))
        ORDER BY g.GoodsId, gc.YearMonth
        OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
    ";
    
    var parameters = new
    {
        SiteId = query.SiteId,
        BId = query.BId,
        MId = query.MId,
        SId = query.SId,
        GoodsId = query.GoodsId,
        YearMonth = query.YearMonth,
        FilterType = query.FilterType,
        Offset = (query.PageIndex - 1) * query.PageSize,
        PageSize = query.PageSize
    };
    
    var items = await _db.QueryAsync<SYSA1021ReportDto>(sql, parameters);
    var totalCount = await _db.QuerySingleAsync<int>("SELECT COUNT(*) FROM ...", parameters);
    
    return new PagedResult<SYSA1021ReportDto>
    {
        Items = items.ToList(),
        TotalCount = totalCount,
        PageIndex = query.PageIndex,
        PageSize = query.PageSize,
        TotalPages = (int)Math.Ceiling(totalCount / (double)query.PageSize)
    };
}
```

#### 3.2.3 DTO: `SYSA1021QueryDto.cs` 和 `SYSA1021ReportDto.cs`
```csharp
public class SYSA1021QueryDto : PagedQueryDto
{
    public string SiteId { get; set; }
    public string BId { get; set; }
    public string MId { get; set; }
    public string SId { get; set; }
    public string GoodsId { get; set; }
    public string YearMonth { get; set; } // YYYYMM
    public string FilterType { get; set; } // 全部、有成本、無成本
}

public class SYSA1021ReportDto
{
    public string SiteId { get; set; }
    public string SiteName { get; set; }
    public string ReportName { get; set; }
    public string YearMonth { get; set; }
    public string BId { get; set; }
    public string MId { get; set; }
    public string SId { get; set; }
    public string GoodsId { get; set; }
    public string GoodsName { get; set; }
    public decimal Qty { get; set; }
    public decimal CostAmount { get; set; }
    public decimal AvgCost { get; set; }
}
```

---

## 四、前端 UI 設計

### 4.1 查詢頁面設計

#### 4.1.1 查詢條件表單
```vue
<template>
  <div class="sysa1021-query">
    <el-form :model="queryForm" label-width="120px">
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="店別" prop="siteId">
            <el-select v-model="queryForm.siteId" placeholder="請選擇店別" clearable>
              <el-option
                v-for="site in siteList"
                :key="site.siteId"
                :label="site.siteName"
                :value="site.siteId"
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="年月" prop="yearMonth" required>
            <el-date-picker
              v-model="queryForm.yearMonth"
              type="month"
              placeholder="請選擇年月"
              format="yyyyMM"
              value-format="yyyyMM"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="大分類" prop="bId">
            <el-select v-model="queryForm.bId" placeholder="請選擇大分類" clearable>
              <el-option
                v-for="category in bCategoryList"
                :key="category.categoryId"
                :label="category.categoryName"
                :value="category.categoryId"
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="中分類" prop="mId">
            <el-select v-model="queryForm.mId" placeholder="請選擇中分類" clearable>
              <el-option
                v-for="category in mCategoryList"
                :key="category.categoryId"
                :label="category.categoryName"
                :value="category.categoryId"
              />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="小分類" prop="sId">
            <el-select v-model="queryForm.sId" placeholder="請選擇小分類" clearable>
              <el-option
                v-for="category in sCategoryList"
                :key="category.categoryId"
                :label="category.categoryName"
                :value="category.categoryId"
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="品項編號" prop="goodsId">
            <el-input v-model="queryForm.goodsId" placeholder="請輸入品項編號" clearable />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="篩選類型" prop="filterType">
            <el-radio-group v-model="queryForm.filterType">
              <el-radio label="全部">全部</el-radio>
              <el-radio label="有成本">有成本</el-radio>
              <el-radio label="無成本">無成本</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-col>
      </el-row>
      <el-form-item>
        <el-button type="primary" @click="handleQuery">查詢</el-button>
        <el-button @click="handleReset">重置</el-button>
        <el-button type="success" @click="handleExport">匯出</el-button>
        <el-button type="warning" @click="handlePrint">列印</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import { useRouter } from 'vue-router'
import { analysisReportApi } from '@/api/analysis-reports'
import type { SYSA1021QueryDto } from '@/types/analysis-reports'

const router = useRouter()
const queryForm = reactive<SYSA1021QueryDto>({
  siteId: '',
  bId: '',
  mId: '',
  sId: '',
  goodsId: '',
  yearMonth: '',
  filterType: '全部',
  pageIndex: 1,
  pageSize: 20
})

const handleQuery = async () => {
  // 驗證必填欄位
  if (!queryForm.yearMonth) {
    ElMessage.warning('請選擇年月')
    return
  }
  
  // 導航到報表展示頁面
  router.push({
    path: '/analysis-reports/sysa1021/view',
    query: queryForm
  })
}

const handleReset = () => {
  Object.assign(queryForm, {
    siteId: '',
    bId: '',
    mId: '',
    sId: '',
    goodsId: '',
    yearMonth: '',
    filterType: '全部',
    pageIndex: 1,
    pageSize: 20
  })
}

const handleExport = async () => {
  try {
    const response = await analysisReportApi.exportSYSA1021(queryForm, 'excel')
    const blob = new Blob([response.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = `SYSA1021_月成本報表_${new Date().toISOString().slice(0, 10)}.xlsx`
    link.click()
    window.URL.revokeObjectURL(url)
    ElMessage.success('匯出成功')
  } catch (error) {
    ElMessage.error('匯出失敗')
  }
}

const handlePrint = async () => {
  try {
    const response = await analysisReportApi.printSYSA1021(queryForm)
    const blob = new Blob([response.data], { type: 'application/pdf' })
    const url = window.URL.createObjectURL(blob)
    window.open(url, '_blank')
    ElMessage.success('列印成功')
  } catch (error) {
    ElMessage.error('列印失敗')
  }
}
</script>
```

---

## 五、開發任務清單

### 5.1 後端開發
- [ ] 建立 `GoodsCosts` 資料表
- [ ] 建立 `SYSA1021QueryDto` 和 `SYSA1021ReportDto` DTO 類別
- [ ] 實作 `AnalysisReportService.GetSYSA1021ReportAsync` 方法
- [ ] 實作 `AnalysisReportService.ExportSYSA1021ReportAsync` 方法
- [ ] 實作 `AnalysisReportService.PrintSYSA1021ReportAsync` 方法
- [ ] 建立 `AnalysisReportsController.GetSYSA1021Report` API 端點
- [ ] 建立 `AnalysisReportsController.ExportSYSA1021Report` API 端點
- [ ] 建立 `AnalysisReportsController.PrintSYSA1021Report` API 端點
- [ ] 撰寫單元測試

### 5.2 前端開發
- [ ] 建立 `SYSA1021Query.vue` 查詢頁面組件
- [ ] 建立 `SYSA1021ReportView.vue` 報表展示頁面組件
- [ ] 建立 `analysisReportApi.getSYSA1021` API 方法
- [ ] 建立 `analysisReportApi.exportSYSA1021` API 方法
- [ ] 建立 `analysisReportApi.printSYSA1021` API 方法
- [ ] 建立路由設定
- [ ] 建立類型定義
- [ ] 撰寫單元測試

### 5.3 資料庫開發
- [ ] 建立 `GoodsCosts` 資料表
- [ ] 建立必要的索引
- [ ] 撰寫查詢效能測試

### 5.4 測試
- [ ] 單元測試
- [ ] 整合測試
- [ ] 效能測試
- [ ] 使用者驗收測試

---

## 六、注意事項

1. **年月格式**: 年月使用 YYYYMM 格式（如 202401），需要在前端和後端都進行驗證
2. **篩選類型**: 支援全部、有成本、無成本三種篩選類型，需要正確處理查詢邏輯
3. **成本計算**: 平均成本需要根據數量和成本金額計算，確保計算邏輯正確
4. **查詢效能**: 由於報表查詢可能涉及大量資料，需要優化查詢效能，建議使用適當的索引和分頁查詢
5. **權限控制**: 需要根據使用者權限控制查詢、匯出、列印功能

