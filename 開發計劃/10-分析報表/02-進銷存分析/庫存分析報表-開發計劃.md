# 庫存分析報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSWC10
- **功能名稱**: 庫存分析報表
- **功能描述**: 提供庫存分析報表的查詢與列印功能，支援多種查詢條件（商品代碼、商品名稱、庫別、店別等），包含庫存數量、庫存金額、庫存狀態等資訊分析
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYSW000/SYSWC10_FQ.asp` (查詢)
  - `WEB/IMS_CORE/ASP/SYSW000/SYSWC10_PR.asp` (報表)
  - `WEB/IMS_CORE/ASP/SYSW000/SYSW9P7_FQ.asp` (庫存分析表查詢)
  - `WEB/IMS_CORE/ASP/SYSW000/SYSW9P7_PR.asp` (庫存分析表報表)

### 1.2 業務需求
- 支援多種查詢條件（商品代碼範圍、商品名稱、庫別、店別、日期範圍等）
- 支援庫存數量統計分析
- 支援庫存金額統計分析
- 支援庫存狀態分析（正常、異常、過期等）
- 支援報表列印與匯出
- 支援多種報表格式（Excel、PDF）
- 支援庫存預警功能

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `InventoryStocks` - 庫存資料表
參考 `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `InventoryStocks` 資料表設計

#### 2.1.2 `Goods` - 商品主檔
參考 `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `Goods` 資料表設計

#### 2.1.3 `Warehouses` - 庫別主檔
```sql
CREATE TABLE [dbo].[Warehouses] (
    [WarehouseId] NVARCHAR(50) NOT NULL PRIMARY KEY, -- 庫別代碼
    [WarehouseName] NVARCHAR(100) NOT NULL, -- 庫別名稱
    [SiteId] NVARCHAR(50) NULL, -- 店別代碼
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1', -- 狀態 (1:啟用, 0:停用)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Warehouses] PRIMARY KEY CLUSTERED ([WarehouseId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_Warehouses_SiteId] ON [dbo].[Warehouses] ([SiteId]);
CREATE NONCLUSTERED INDEX [IX_Warehouses_Status] ON [dbo].[Warehouses] ([Status]);
```

#### 2.1.4 `InventoryAnalysis` - 庫存分析視圖（可選，用於報表查詢優化）
```sql
CREATE VIEW [dbo].[InventoryAnalysis] AS
SELECT 
    s.[SiteId],
    s.[GoodsId],
    g.[GoodsName],
    g.[BId] AS [BigCategoryId],
    g.[MId] AS [MidCategoryId],
    g.[SId] AS [SmallCategoryId],
    w.[WarehouseId],
    w.[WarehouseName],
    SUM(CASE WHEN s.[StocksStatus] IN ('1', '4') THEN s.[Qty] ELSE 0 END) AS [InQty], -- 入庫數量
    SUM(CASE WHEN s.[StocksStatus] IN ('2', '3', '5', '6') THEN s.[Qty] ELSE 0 END) AS [OutQty], -- 出庫數量
    SUM(CASE WHEN s.[StocksStatus] IN ('1', '4') THEN s.[Qty] ELSE -s.[Qty] END) AS [CurrentQty], -- 當前庫存數量
    SUM(CASE WHEN s.[StocksStatus] IN ('1', '4') THEN s.[StocksNtaxAmt] ELSE -s.[StocksNtaxAmt] END) AS [CurrentAmt], -- 當前庫存金額
    MAX(s.[StocksDate]) AS [LastStockDate] -- 最後庫存異動日期
FROM [dbo].[InventoryStocks] s
INNER JOIN [dbo].[Goods] g ON s.[GoodsId] = g.[GoodsId]
LEFT JOIN [dbo].[Warehouses] w ON s.[WarehouseId] = w.[WarehouseId]
GROUP BY s.[SiteId], s.[GoodsId], g.[GoodsName], g.[BId], g.[MId], g.[SId], w.[WarehouseId], w.[WarehouseName];
```

### 2.2 資料字典

#### InventoryAnalysis 視圖欄位

| 欄位名稱 | 資料類型 | 說明 | 備註 |
|---------|---------|------|------|
| SiteId | NVARCHAR | 店別代碼 | - |
| GoodsId | NVARCHAR | 商品代碼 | - |
| GoodsName | NVARCHAR | 商品名稱 | - |
| BigCategoryId | NVARCHAR | 大分類代碼 | - |
| MidCategoryId | NVARCHAR | 中分類代碼 | - |
| SmallCategoryId | NVARCHAR | 小分類代碼 | - |
| WarehouseId | NVARCHAR | 庫別代碼 | - |
| WarehouseName | NVARCHAR | 庫別名稱 | - |
| InQty | DECIMAL | 入庫數量 | 統計值 |
| OutQty | DECIMAL | 出庫數量 | 統計值 |
| CurrentQty | DECIMAL | 當前庫存數量 | 統計值 |
| CurrentAmt | DECIMAL | 當前庫存金額 | 統計值 |
| LastStockDate | DATETIME2 | 最後庫存異動日期 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢庫存分析報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/inventory/analysis`
- **說明**: 查詢庫存分析報表資料，支援多種查詢條件
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "GoodsId",
    "sortOrder": "ASC",
    "filters": {
      "goodsIdFrom": "",
      "goodsIdTo": "",
      "goodsName": "",
      "siteIds": [],
      "warehouseIds": [],
      "categoryIds": [],
      "dateFrom": "",
      "dateTo": "",
      "minQty": null,
      "maxQty": null,
      "status": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "S001",
          "siteName": "總店",
          "goodsId": "G001",
          "goodsName": "商品名稱",
          "bigCategoryId": "B001",
          "bigCategoryName": "大分類",
          "midCategoryId": "M001",
          "midCategoryName": "中分類",
          "smallCategoryId": "S001",
          "smallCategoryName": "小分類",
          "warehouseId": "W001",
          "warehouseName": "庫別名稱",
          "inQty": 100.00,
          "outQty": 50.00,
          "currentQty": 50.00,
          "currentAmt": 5000.00,
          "lastStockDate": "2024-01-01T00:00:00",
          "safeQty": 20.00,
          "isLowStock": false,
          "isOverStock": false
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5,
      "summary": {
        "totalInQty": 1000.00,
        "totalOutQty": 500.00,
        "totalCurrentQty": 500.00,
        "totalCurrentAmt": 50000.00
      }
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出庫存分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/inventory/analysis/export`
- **說明**: 匯出庫存分析報表（Excel、PDF）
- **請求格式**:
  ```json
  {
    "exportType": "Excel",
    "filters": {
      "goodsIdFrom": "",
      "goodsIdTo": "",
      "goodsName": "",
      "siteIds": [],
      "warehouseIds": [],
      "categoryIds": [],
      "dateFrom": "",
      "dateTo": ""
    }
  }
  ```
- **回應格式**: 檔案下載

#### 3.1.3 查詢庫存預警
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/inventory/analysis/warnings`
- **說明**: 查詢庫存預警資訊（低庫存、過期庫存等）
- **請求參數**:
  ```json
  {
    "warningType": "LowStock",
    "siteIds": [],
    "warehouseIds": []
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "lowStockItems": [],
      "overStockItems": [],
      "expiredItems": []
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

---

## 四、前端 UI 設計

### 4.1 查詢頁面 (`InventoryAnalysisQuery.vue`)

#### 4.1.1 查詢條件區域
- **商品代碼範圍**: 商品代碼起、商品代碼迄（文字輸入框）
- **商品名稱**: 商品名稱（文字輸入框，支援模糊查詢）
- **店別**: 多選下拉列表（支援多選）
- **庫別**: 多選下拉列表（支援多選）
- **分類**: 大分類、中分類、小分類（階層式下拉列表）
- **日期範圍**: 日期起、日期迄（日期選擇器）
- **庫存數量範圍**: 最小數量、最大數量（數值輸入框）
- **狀態**: 狀態下拉列表（正常、低庫存、過量庫存等）

#### 4.1.2 查詢結果區域
- **資料表格**: 
  - 店別、商品代碼、商品名稱、大分類、中分類、小分類、庫別
  - 入庫數量、出庫數量、當前庫存數量、當前庫存金額
  - 最後庫存異動日期、安全庫存量、庫存狀態
- **分頁控制**: 頁碼、每頁筆數
- **排序功能**: 點擊欄位標題排序
- **匯出功能**: Excel匯出、PDF匯出按鈕

#### 4.1.3 統計資訊區域
- **總入庫數量**: 統計值
- **總出庫數量**: 統計值
- **總當前庫存數量**: 統計值
- **總當前庫存金額**: 統計值

### 4.2 報表列印頁面 (`InventoryAnalysisReport.vue`)
- **報表標題**: 庫存分析報表
- **報表內容**: 與查詢結果相同格式
- **列印按鈕**: 列印功能
- **匯出按鈕**: Excel、PDF匯出

### 4.3 庫存預警頁面 (`InventoryWarning.vue`)
- **低庫存預警**: 顯示低於安全庫存量的商品
- **過量庫存預警**: 顯示超過最大庫存量的商品
- **過期庫存預警**: 顯示過期商品（如有過期日期欄位）

---

## 五、業務邏輯

### 5.1 查詢邏輯
1. **參數驗證**: 驗證查詢參數的有效性
2. **權限檢查**: 檢查使用者是否有查詢權限
3. **資料查詢**: 根據查詢條件從資料庫查詢庫存分析資料
4. **資料統計**: 計算總入庫數量、總出庫數量、總當前庫存數量、總當前庫存金額
5. **庫存預警**: 判斷是否低庫存、過量庫存
6. **資料分頁**: 對查詢結果進行分頁處理
7. **資料排序**: 根據排序欄位和排序方向排序

### 5.2 匯出邏輯
1. **資料查詢**: 根據查詢條件查詢所有符合條件的資料（不分頁）
2. **格式轉換**: 將資料轉換為Excel或PDF格式
3. **檔案生成**: 生成匯出檔案
4. **檔案下載**: 提供檔案下載連結

### 5.3 庫存預警邏輯
1. **低庫存判斷**: 當前庫存數量 < 安全庫存量
2. **過量庫存判斷**: 當前庫存數量 > 最大庫存量（如有設定）
3. **過期庫存判斷**: 過期日期 < 當前日期（如有過期日期欄位）

---

## 六、開發任務

### 6.1 後端開發
- [ ] 建立 `InventoryAnalysisController` 控制器
- [ ] 建立 `InventoryAnalysisService` 服務層
- [ ] 建立 `InventoryAnalysisRepository` 資料存取層
- [ ] 建立 `InventoryAnalysisDto` 資料傳輸物件
- [ ] 實作查詢API (`GET /api/v1/inventory/analysis`)
- [ ] 實作匯出API (`POST /api/v1/inventory/analysis/export`)
- [ ] 實作庫存預警API (`GET /api/v1/inventory/analysis/warnings`)
- [ ] 建立資料庫視圖 `InventoryAnalysis`（可選）
- [ ] 單元測試

### 6.2 前端開發
- [ ] 建立 `InventoryAnalysisQuery.vue` 查詢頁面
- [ ] 建立 `InventoryAnalysisReport.vue` 報表頁面
- [ ] 建立 `InventoryWarning.vue` 預警頁面
- [ ] 建立 `inventoryAnalysisApi.ts` API服務
- [ ] 建立 `inventoryAnalysisStore.ts` 狀態管理（如需要）
- [ ] 實作查詢功能
- [ ] 實作匯出功能（Excel、PDF）
- [ ] 實作庫存預警功能
- [ ] 單元測試

### 6.3 測試
- [ ] 單元測試
- [ ] 整合測試
- [ ] 效能測試
- [ ] 使用者驗收測試

---

## 七、注意事項

1. **效能優化**: 庫存分析報表可能涉及大量資料，需要優化查詢效能，考慮使用索引、分頁、快取等技術
2. **資料一致性**: 確保庫存資料的一致性，考慮使用事務處理
3. **權限控制**: 確保只有有權限的使用者才能查詢和匯出報表
4. **報表格式**: 確保匯出的Excel和PDF格式符合需求
5. **庫存預警**: 庫存預警功能需要定期執行，可以考慮使用排程任務

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

