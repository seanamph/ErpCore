# SYSA1000 - 進銷存分析報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1000
- **功能名稱**: 進銷存分析報表
- **功能描述**: 提供進銷存分析報表的查詢功能，支援多種報表類型（SYSA1011-SYSA1024），包含耗材庫存查詢、入庫明細、出庫明細、領用發料退回明細、固定資產數量彙總、庫房領料進價成本分攤、工務修繕扣款、工務維修件數統計、工務維修類別統計、盤點差異明細、耗材進銷存月報表、公務費用歸屬統計等報表
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx` (報表頁面)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx.cs` (後端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1011.rdlc` ~ `SYSA1024.rdlc` (報表定義)

### 1.2 業務需求
- 支援多種報表類型查詢（SYSA1011-SYSA1024）
- 支援多種查詢條件（店別、分類、日期範圍、商品、狀態等）
- 支援報表列印與匯出
- 支援報表參數設定
- 支援報表資料快取

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `InventoryStocks` - 庫存資料表 (對應舊系統 `IMS_AM.NAM_AM_STOCKS`)
```sql
CREATE TABLE [dbo].[InventoryStocks] (
    [StockId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [SiteId] NVARCHAR(50) NOT NULL, -- 店別代碼
    [GoodsId] NVARCHAR(50) NOT NULL, -- 商品代碼
    [SourceId] NVARCHAR(50) NULL, -- 來源單號
    [StocksDate] DATETIME2 NOT NULL, -- 庫存日期
    [StocksStatus] NVARCHAR(10) NOT NULL, -- 庫存狀態 (1:入庫, 2:出庫, 3:退貨, 4:退回, 5:報廢, 6:出售, 8:盤點)
    [Qty] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 數量
    [McAmt] DECIMAL(18, 2) NULL DEFAULT 0, -- 單價
    [StocksNtaxAmt] DECIMAL(18, 2) NULL DEFAULT 0, -- 未稅金額
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_InventoryStocks] PRIMARY KEY CLUSTERED ([StockId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_InventoryStocks_SiteId] ON [dbo].[InventoryStocks] ([SiteId]);
CREATE NONCLUSTERED INDEX [IX_InventoryStocks_GoodsId] ON [dbo].[InventoryStocks] ([GoodsId]);
CREATE NONCLUSTERED INDEX [IX_InventoryStocks_StocksDate] ON [dbo].[InventoryStocks] ([StocksDate]);
CREATE NONCLUSTERED INDEX [IX_InventoryStocks_StocksStatus] ON [dbo].[InventoryStocks] ([StocksStatus]);
CREATE NONCLUSTERED INDEX [IX_InventoryStocks_SourceId] ON [dbo].[InventoryStocks] ([SourceId]);
```

#### 2.1.2 `Goods` - 商品主檔 (對應舊系統 `IMS_AM.NAM_GOODS`)
```sql
CREATE TABLE [dbo].[Goods] (
    [GoodsId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [GoodsName] NVARCHAR(200) NOT NULL, -- 商品名稱
    [BId] NVARCHAR(50) NULL, -- 大分類代碼
    [MId] NVARCHAR(50) NULL, -- 中分類代碼
    [SId] NVARCHAR(50) NULL, -- 小分類代碼
    [Unit] NVARCHAR(20) NULL, -- 單位
    [SafeQty] DECIMAL(18, 2) NULL DEFAULT 0, -- 安全庫存量
    [Type] NVARCHAR(10) NULL, -- 類型 (1:耗材, 2:固定資產)
    [AssetType] NVARCHAR(10) NULL, -- 資產類型
    [GoodsBeginDate] DATETIME2 NULL, -- 商品開始日期
    [AssetDate] DATETIME2 NULL, -- 資產日期
    [HoldOrgId] NVARCHAR(50) NULL, -- 持有單位
    [HoldEmpId] NVARCHAR(50) NULL, -- 持有人員
    [UseOrgId] NVARCHAR(50) NULL, -- 使用單位
    [UseEmpId] NVARCHAR(50) NULL, -- 使用人員
    [Notes] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Goods] PRIMARY KEY CLUSTERED ([GoodsId] ASC)
);
```

#### 2.1.3 `InventoryCost` - 庫存成本表 (對應舊系統 `IMS_AM.NAM_COST`)
```sql
CREATE TABLE [dbo].[InventoryCost] (
    [CostId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [SiteId] NVARCHAR(50) NOT NULL,
    [GoodsId] NVARCHAR(50) NOT NULL,
    [CostYm] NVARCHAR(6) NOT NULL, -- 成本年月 (YYYYMM)
    [LastQty] DECIMAL(18, 2) NULL DEFAULT 0, -- 上期數量
    [LastPrice] DECIMAL(18, 2) NULL DEFAULT 0, -- 上期單價
    [LastAmt] DECIMAL(18, 2) NULL DEFAULT 0, -- 上期金額
    [NextQty] DECIMAL(18, 2) NULL DEFAULT 0, -- 下期數量
    [NextPrice] DECIMAL(18, 2) NULL DEFAULT 0, -- 下期單價
    [NextAmt] DECIMAL(18, 2) NULL DEFAULT 0, -- 下期金額
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_InventoryCost] PRIMARY KEY CLUSTERED ([CostId] ASC),
    CONSTRAINT [UQ_InventoryCost_Site_Goods_Ym] UNIQUE ([SiteId], [GoodsId], [CostYm])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_InventoryCost_SiteId] ON [dbo].[InventoryCost] ([SiteId]);
CREATE NONCLUSTERED INDEX [IX_InventoryCost_GoodsId] ON [dbo].[InventoryCost] ([GoodsId]);
CREATE NONCLUSTERED INDEX [IX_InventoryCost_CostYm] ON [dbo].[InventoryCost] ([CostYm]);
```

#### 2.1.4 `AcceptanceM` - 驗收單主檔 (對應舊系統 `IMS_AM.NAM_ACCEPTANCEM`)
```sql
CREATE TABLE [dbo].[AcceptanceM] (
    [TxnNo] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [SiteId] NVARCHAR(50) NOT NULL,
    [OrgId] NVARCHAR(50) NULL, -- 單位代碼
    [SupplierId] NVARCHAR(50) NULL, -- 供應商代碼
    [SupplierName] NVARCHAR(200) NULL, -- 供應商名稱
    [AcceptanceDate] DATETIME2 NULL, -- 驗收日期
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_AcceptanceM] PRIMARY KEY CLUSTERED ([TxnNo] ASC)
);
```

#### 2.1.5 `AcceptanceD` - 驗收單明細 (對應舊系統 `IMS_AM.NAM_ACCEPTANCED`)
```sql
CREATE TABLE [dbo].[AcceptanceD] (
    [TxnNo] NVARCHAR(50) NOT NULL,
    [GoodsId] NVARCHAR(50) NOT NULL,
    [Qty] DECIMAL(18, 2) NOT NULL DEFAULT 0,
    [Price] DECIMAL(18, 2) NULL DEFAULT 0,
    [Amt] DECIMAL(18, 2) NULL DEFAULT 0,
    CONSTRAINT [PK_AcceptanceD] PRIMARY KEY CLUSTERED ([TxnNo], [GoodsId]),
    CONSTRAINT [FK_AcceptanceD_AcceptanceM] FOREIGN KEY ([TxnNo]) REFERENCES [dbo].[AcceptanceM] ([TxnNo]) ON DELETE CASCADE
);
```

#### 2.1.6 `RequisitionM` - 領料單主檔 (對應舊系統 `IMS_AM.NAM_REQUISITIONM`)
```sql
CREATE TABLE [dbo].[RequisitionM] (
    [TxnNo] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [SiteId] NVARCHAR(50) NOT NULL,
    [OrgId] NVARCHAR(50) NULL, -- 單位代碼
    [OrgAllocation] NVARCHAR(200) NULL, -- 單位分配
    [RequisitionDate] DATETIME2 NULL, -- 領料日期
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_RequisitionM] PRIMARY KEY CLUSTERED ([TxnNo] ASC)
);
```

#### 2.1.7 `RequisitionD` - 領料單明細 (對應舊系統 `IMS_AM.NAM_REQUISITIOND`)
```sql
CREATE TABLE [dbo].[RequisitionD] (
    [TxnNo] NVARCHAR(50) NOT NULL,
    [GoodsId] NVARCHAR(50) NOT NULL,
    [Use] NVARCHAR(50) NULL, -- 用途
    [MapplyQty] DECIMAL(18, 2) NULL DEFAULT 0, -- 申請數量
    [Qty] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 實際數量
    CONSTRAINT [PK_RequisitionD] PRIMARY KEY CLUSTERED ([TxnNo], [GoodsId]),
    CONSTRAINT [FK_RequisitionD_RequisitionM] FOREIGN KEY ([TxnNo]) REFERENCES [dbo].[RequisitionM] ([TxnNo]) ON DELETE CASCADE
);
```

#### 2.1.8 `WorkMaintainM` - 工務維修主檔 (對應舊系統 `IMS_AM.NAM_WORK_MAINTAINM`)
```sql
CREATE TABLE [dbo].[WorkMaintainM] (
    [TxnNo] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [SiteId] NVARCHAR(50) NOT NULL,
    [OrgId] NVARCHAR(50) NULL, -- 申請單位
    [ApplyDate] DATETIME2 NULL, -- 申請日期
    [ApplyType] NVARCHAR(500) NULL, -- 請修類別 (多選，以分號分隔)
    [MaintainEmp] NVARCHAR(500) NULL, -- 維保人員 (多選，以分號分隔)
    [BelongStatus] NVARCHAR(10) NULL, -- 歸屬狀態 (1:員工負擔, 2:店別負擔)
    [BelongOrg] NVARCHAR(50) NULL, -- 費用歸屬單位
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_WorkMaintainM] PRIMARY KEY CLUSTERED ([TxnNo] ASC)
);
```

### 2.2 相關資料表

#### 2.2.1 `Classify` - 分類視圖 (對應舊系統 `IMS_AM.VIEW_CLASSIFY`)
- 用於查詢商品分類資訊（大分類、中分類、小分類）
- 參考: 基本資料管理相關設計

#### 2.2.2 `Parameters` - 參數表
- 用於查詢單位、庫存狀態、用途等參數
- 參考: `開發計劃/02-基本資料管理/01-參數設定/SYSBC40-參數資料設定維護作業.md`

#### 2.2.3 `OrgGroup` - 組織群組表
- 用於查詢組織單位資訊
- 參考: 基本資料管理相關設計

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢報表資料
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/{reportId}`
- **說明**: 根據報表ID查詢報表資料
- **路徑參數**:
  - `reportId`: 報表ID (SYSA1011-SYSA1024)
- **查詢參數**:
  ```json
  {
    "siteId": "1100",
    "yearMonth": "2024/01",
    "beginDate": "2024-01-01",
    "endDate": "2024-01-31",
    "bId": "",
    "mId": "",
    "sId": "",
    "goodsId": "",
    "filterType": "0",
    "orgId": "",
    "vendor": "",
    "use": "",
    "belongStatus": "",
    "applyDateB": "",
    "applyDateE": "",
    "startMonth": "",
    "endMonth": "",
    "dateType": "",
    "maintainEmp": "",
    "belongOrg": "",
    "applyType": ""
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "reportId": "SYSA1011",
      "reportName": "耗材庫存查詢表",
      "siteName": "漢神百貨",
      "items": [
        {
          "siteId": "1100",
          "bId": "大分類",
          "mId": "中分類",
          "sId": "小分類",
          "goodsId": "G001",
          "goodsName": "商品名稱",
          "packUnit": "包裝單位",
          "unit": "單位",
          "qty": 100,
          "safeQty": 50,
          "selectType": "全部"
        }
      ],
      "totalCount": 100
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/{reportId}/export`
- **說明**: 匯出報表為Excel或PDF
- **請求格式**:
  ```json
  {
    "format": "Excel", // Excel 或 PDF
    "queryParams": {
      // 同查詢參數
    }
  }
  ```
- **回應**: 檔案下載

#### 3.1.3 列印報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/{reportId}/print`
- **說明**: 產生報表列印資料
- **請求格式**: 同查詢參數
- **回應格式**: 報表列印資料

### 3.2 後端實作類別

#### 3.2.1 Controller: `AnalysisReportsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis-reports")]
    [Authorize]
    public class AnalysisReportsController : ControllerBase
    {
        private readonly IAnalysisReportService _reportService;
        
        public AnalysisReportsController(IAnalysisReportService reportService)
        {
            _reportService = reportService;
        }
        
        [HttpGet("{reportId}")]
        public async Task<ActionResult<ApiResponse<AnalysisReportDto>>> GetReport(
            string reportId, 
            [FromQuery] AnalysisReportQueryDto query)
        {
            // 實作查詢邏輯
        }
        
        [HttpPost("{reportId}/export")]
        public async Task<IActionResult> ExportReport(
            string reportId, 
            [FromBody] ExportReportDto dto)
        {
            // 實作匯出邏輯
        }
        
        [HttpPost("{reportId}/print")]
        public async Task<ActionResult<ApiResponse<PrintReportDto>>> PrintReport(
            string reportId, 
            [FromBody] AnalysisReportQueryDto query)
        {
            // 實作列印邏輯
        }
    }
}
```

#### 3.2.2 Service: `AnalysisReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IAnalysisReportService
    {
        Task<AnalysisReportDto> GetReportAsync(string reportId, AnalysisReportQueryDto query);
        Task<byte[]> ExportReportAsync(string reportId, ExportReportDto dto);
        Task<PrintReportDto> PrintReportAsync(string reportId, AnalysisReportQueryDto query);
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 報表查詢頁面 (`AnalysisReportQuery.vue`)
- **路徑**: `/reports/analysis/{reportId}`
- **功能**: 顯示報表查詢條件與結果
- **主要元件**:
  - 查詢表單 (AnalysisReportSearchForm)
  - 報表顯示區域 (AnalysisReportViewer)
  - 匯出/列印按鈕

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`AnalysisReportSearchForm.vue`)
```vue
<template>
  <el-form :model="searchForm" inline>
    <el-form-item label="店別">
      <el-select v-model="searchForm.siteId" placeholder="請選擇店別">
        <el-option v-for="site in siteList" :key="site.siteId" :label="site.siteName" :value="site.siteId" />
      </el-select>
    </el-form-item>
    <el-form-item label="報表類型">
      <el-select v-model="searchForm.reportId" placeholder="請選擇報表類型">
        <el-option label="耗材庫存查詢表" value="SYSA1011" />
        <el-option label="耗材入庫明細表" value="SYSA1012" />
        <el-option label="耗材出庫明細表" value="SYSA1013" />
        <!-- 其他報表類型 -->
      </el-select>
    </el-form-item>
    <el-form-item label="日期範圍">
      <el-date-picker
        v-model="dateRange"
        type="daterange"
        range-separator="至"
        start-placeholder="開始日期"
        end-placeholder="結束日期"
        format="YYYY/MM/DD"
        value-format="YYYY-MM-DD"
      />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button @click="handleExport">匯出</el-button>
      <el-button @click="handlePrint">列印</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 報表顯示元件 (`AnalysisReportViewer.vue`)
```vue
<template>
  <div>
    <el-table :data="reportData" v-loading="loading" border>
      <!-- 根據報表類型動態顯示欄位 -->
      <el-table-column v-for="column in columns" :key="column.prop" :prop="column.prop" :label="column.label" />
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

### 4.3 API 呼叫 (`analysis-report.api.ts`)
```typescript
import request from '@/utils/request';

export interface AnalysisReportQueryDto {
  siteId?: string;
  yearMonth?: string;
  beginDate?: string;
  endDate?: string;
  bId?: string;
  mId?: string;
  sId?: string;
  goodsId?: string;
  filterType?: string;
  orgId?: string;
  vendor?: string;
  use?: string;
  belongStatus?: string;
  applyDateB?: string;
  applyDateE?: string;
  startMonth?: string;
  endMonth?: string;
  dateType?: string;
  maintainEmp?: string;
  belongOrg?: string;
  applyType?: string;
}

export interface AnalysisReportDto {
  reportId: string;
  reportName: string;
  siteName: string;
  items: any[];
  totalCount: number;
}

// API 函數
export const getAnalysisReport = (reportId: string, query: AnalysisReportQueryDto) => {
  return request.get<ApiResponse<AnalysisReportDto>>(`/api/v1/analysis-reports/${reportId}`, { params: query });
};

export const exportAnalysisReport = (reportId: string, dto: { format: string; queryParams: AnalysisReportQueryDto }) => {
  return request.post(`/api/v1/analysis-reports/${reportId}/export`, dto, { responseType: 'blob' });
};

export const printAnalysisReport = (reportId: string, query: AnalysisReportQueryDto) => {
  return request.post<ApiResponse<any>>(`/api/v1/analysis-reports/${reportId}/print`, query);
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (2天)
- [ ] 建立資料表結構
- [ ] 建立索引
- [ ] 建立視圖
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (5天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作（各報表類型查詢邏輯）
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 報表匯出功能（Excel/PDF）
- [ ] 單元測試

### 5.3 階段三: 前端開發 (4天)
- [ ] API 呼叫函數
- [ ] 查詢表單開發
- [ ] 報表顯示元件開發
- [ ] 報表類型切換功能
- [ ] 匯出功能
- [ ] 列印功能
- [ ] 元件測試

### 5.4 階段四: 整合測試 (2天)
- [ ] API 整合測試
- [ ] 各報表類型測試
- [ ] 效能測試
- [ ] 資料正確性驗證

### 5.5 階段五: 文件與部署 (1天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 14天

---

## 六、注意事項

### 6.1 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 複雜查詢應使用預存程序或視圖
- 報表資料應考慮快取機制

### 6.2 資料驗證
- 查詢參數必須驗證
- 日期範圍必須驗證
- 店別、分類等參數必須驗證

### 6.3 業務邏輯
- 各報表類型的查詢邏輯不同，需分別實作
- 報表資料計算邏輯需與舊系統一致
- 報表格式需與舊系統一致

### 6.4 報表類型說明
- **SYSA1011**: 耗材庫存查詢表
- **SYSA1012**: 耗材入庫明細表
- **SYSA1013**: 耗材出庫明細表
- **SYSA1014**: 耗材領用發料退回明細表
- **SYSA1015**: 固定資產數量彙總表
- **SYSA1016**: 庫房領料進價成本分攤表
- **SYSA1017**: 工務修繕扣款報表
- **SYSA1018**: 工務維修件數統計表
- **SYSA1019**: 工務維修類別統計表
- **SYSA1020**: 盤點差異明細表
- **SYSA1021**: 耗材進銷存月報表
- **SYSA1022**: 公務費用歸屬統計表
- **SYSA1023**: (待補充)
- **SYSA1024**: (待補充)

---

## 七、測試案例

### 7.1 單元測試
- [ ] 各報表類型查詢成功
- [ ] 查詢參數驗證測試
- [ ] 報表資料計算正確性測試

### 7.2 整合測試
- [ ] 完整報表查詢流程測試
- [ ] 報表匯出功能測試
- [ ] 報表列印功能測試
- [ ] 錯誤處理測試

### 7.3 效能測試
- [ ] 大量資料查詢測試
- [ ] 複雜查詢效能測試
- [ ] 並發查詢測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx.cs`
- `WEB/IMS_CORE/SYSA000/SYSA1011.rdlc` ~ `SYSA1024.rdlc`

### 8.2 資料庫 Schema
- 舊系統 `IMS_AM.NAM_AM_STOCKS` 資料表結構
- 舊系統 `IMS_AM.NAM_GOODS` 資料表結構
- 舊系統 `IMS_AM.NAM_COST` 資料表結構

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

