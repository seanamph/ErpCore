# SYSA1015 - 商品分析報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1015
- **功能名稱**: 商品分析報表
- **功能描述**: 提供商品分析報表的查詢功能，支援依大分類、中分類、小分類、商品代碼、店別、年月等條件查詢商品庫存資訊，包含商品名稱、單位、數量、安全庫存量等資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1015.ascx` (查詢頁面)
  - `WEB/IMS_CORE/SYSA000/js/SYSA1015.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1015.rdlc` (報表定義)

### 1.2 業務需求
- 支援依大分類、中分類、小分類、商品代碼查詢
- 支援依店別查詢
- 支援依年月查詢
- 支援依篩選類型查詢（全部、低於安全庫存量等）
- 支援報表列印與匯出
- 顯示商品庫存資訊（商品名稱、單位、數量、安全庫存量等）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `Goods` - 商品主檔 (對應舊系統 `IMS_AM.NAM_GOODS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `Goods` 資料表結構

#### 2.1.2 `InventoryStocks` - 庫存資料表 (對應舊系統 `IMS_AM.NAM_AM_STOCKS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `InventoryStocks` 資料表結構

#### 2.1.3 `GoodsCategories` - 商品分類表
```sql
CREATE TABLE [dbo].[GoodsCategories] (
    [CategoryId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [CategoryName] NVARCHAR(200) NOT NULL,
    [CategoryType] NVARCHAR(10) NOT NULL, -- B:大分類, M:中分類, S:小分類
    [ParentId] NVARCHAR(50) NULL, -- 父分類ID
    [SeqNo] INT NULL DEFAULT 0,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE()
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_GoodsCategories_CategoryType] ON [dbo].[GoodsCategories] ([CategoryType]);
CREATE NONCLUSTERED INDEX [IX_GoodsCategories_ParentId] ON [dbo].[GoodsCategories] ([ParentId]);
```

### 2.2 報表資料結構

#### 2.2.1 報表資料集結構
```sql
-- 報表查詢結果結構
SELECT 
    SITE_ID,
    SITE_NAME,
    REPORT_NAME,
    SEQ_NO,
    B_ID,
    M_ID,
    S_ID,
    GOODS_ID,
    GOODS_NAME,
    PACK_UNIT,
    UNIT,
    QTY,
    SAFE_QTY,
    SELECT_TYPE,
    YEAR_MONTH
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作）
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢商品分析報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1015`
- **說明**: 查詢商品分析報表資料
- **請求參數**:
  ```json
  {
    "siteId": "",
    "bId": "",
    "mId": "",
    "sId": "",
    "goodsId": "",
    "yearMonth": "",
    "filterType": "",
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "店別名稱",
          "reportName": "商品分析報表",
          "seqNo": "1",
          "bId": "B001",
          "mId": "M001",
          "sId": "S001",
          "goodsId": "G001",
          "goodsName": "商品名稱",
          "packUnit": "箱",
          "unit": "個",
          "qty": 100,
          "safeQty": 50,
          "selectType": "全部",
          "yearMonth": "2024-01"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1015/export`
- **說明**: 匯出商品分析報表（Excel/PDF）
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

#### 3.1.3 列印商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1015/print`
- **說明**: 列印商品分析報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

### 3.2 後端實作類別

#### 3.2.1 Controller: `AnalysisReportsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis-reports")]
    [Authorize]
    public class AnalysisReportsController : ControllerBase
    {
        private readonly IAnalysisReportService _analysisReportService;
        
        public AnalysisReportsController(IAnalysisReportService analysisReportService)
        {
            _analysisReportService = analysisReportService;
        }
        
        [HttpGet("sysa1015")]
        public async Task<ActionResult<ApiResponse<PagedResult<SYSA1015ReportDto>>>> GetSYSA1015Report([FromQuery] SYSA1015QueryDto query)
        {
            var result = await _analysisReportService.GetSYSA1015ReportAsync(query);
            return Ok(ApiResponse.Success(result));
        }
        
        [HttpPost("sysa1015/export")]
        public async Task<IActionResult> ExportSYSA1015Report([FromBody] SYSA1015QueryDto query, [FromQuery] string format = "excel")
        {
            var fileBytes = await _analysisReportService.ExportSYSA1015ReportAsync(query, format);
            var fileName = $"SYSA1015_商品分析報表_{DateTime.Now:yyyyMMddHHmmss}.{(format == "excel" ? "xlsx" : "pdf")}";
            return File(fileBytes, format == "excel" ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" : "application/pdf", fileName);
        }
        
        [HttpPost("sysa1015/print")]
        public async Task<IActionResult> PrintSYSA1015Report([FromBody] SYSA1015QueryDto query)
        {
            var fileBytes = await _analysisReportService.PrintSYSA1015ReportAsync(query);
            return File(fileBytes, "application/pdf", $"SYSA1015_商品分析報表_{DateTime.Now:yyyyMMddHHmmss}.pdf");
        }
    }
}
```

#### 3.2.2 Service: `AnalysisReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IAnalysisReportService
    {
        Task<PagedResult<SYSA1015ReportDto>> GetSYSA1015ReportAsync(SYSA1015QueryDto query);
        Task<byte[]> ExportSYSA1015ReportAsync(SYSA1015QueryDto query, string format);
        Task<byte[]> PrintSYSA1015ReportAsync(SYSA1015QueryDto query);
    }
    
    public class AnalysisReportService : IAnalysisReportService
    {
        private readonly IAnalysisReportRepository _repository;
        private readonly IExcelService _excelService;
        private readonly IPdfService _pdfService;
        
        public AnalysisReportService(
            IAnalysisReportRepository repository,
            IExcelService excelService,
            IPdfService pdfService)
        {
            _repository = repository;
            _excelService = excelService;
            _pdfService = pdfService;
        }
        
        public async Task<PagedResult<SYSA1015ReportDto>> GetSYSA1015ReportAsync(SYSA1015QueryDto query)
        {
            return await _repository.GetSYSA1015ReportAsync(query);
        }
        
        public async Task<byte[]> ExportSYSA1015ReportAsync(SYSA1015QueryDto query, string format)
        {
            var data = await _repository.GetSYSA1015ReportAllAsync(query);
            if (format == "excel")
            {
                return await _excelService.ExportToExcelAsync(data, "商品分析報表");
            }
            else
            {
                return await _pdfService.ExportToPdfAsync(data, "商品分析報表");
            }
        }
        
        public async Task<byte[]> PrintSYSA1015ReportAsync(SYSA1015QueryDto query)
        {
            var data = await _repository.GetSYSA1015ReportAllAsync(query);
            return await _pdfService.PrintReportAsync(data, "SYSA1015");
        }
    }
}
```

#### 3.2.3 Repository: `AnalysisReportRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public interface IAnalysisReportRepository
    {
        Task<PagedResult<SYSA1015ReportDto>> GetSYSA1015ReportAsync(SYSA1015QueryDto query);
        Task<List<SYSA1015ReportDto>> GetSYSA1015ReportAllAsync(SYSA1015QueryDto query);
    }
    
    public class AnalysisReportRepository : IAnalysisReportRepository
    {
        private readonly IDbConnection _connection;
        
        public AnalysisReportRepository(IDbConnection connection)
        {
            _connection = connection;
        }
        
        public async Task<PagedResult<SYSA1015ReportDto>> GetSYSA1015ReportAsync(SYSA1015QueryDto query)
        {
            var sql = @"
                SELECT 
                    SITE_ID AS SiteId,
                    SITE_NAME AS SiteName,
                    REPORT_NAME AS ReportName,
                    SEQ_NO AS SeqNo,
                    B_ID AS BId,
                    M_ID AS MId,
                    S_ID AS SId,
                    GOODS_ID AS GoodsId,
                    GOODS_NAME AS GoodsName,
                    PACK_UNIT AS PackUnit,
                    UNIT AS Unit,
                    QTY AS Qty,
                    SAFE_QTY AS SafeQty,
                    SELECT_TYPE AS SelectType,
                    YEAR_MONTH AS YearMonth
                FROM 
                    -- 查詢邏輯（需根據實際業務邏輯實作）
                WHERE 
                    1=1
                    AND (@SiteId IS NULL OR SITE_ID = @SiteId)
                    AND (@BId IS NULL OR B_ID = @BId)
                    AND (@MId IS NULL OR M_ID = @MId)
                    AND (@SId IS NULL OR S_ID = @SId)
                    AND (@GoodsId IS NULL OR GOODS_ID = @GoodsId)
                    AND (@YearMonth IS NULL OR YEAR_MONTH = @YearMonth)
                    AND (@FilterType IS NULL OR (CASE WHEN @FilterType = 'safety' AND QTY < SAFE_QTY THEN 1 ELSE 0 END) = 1)
                ORDER BY SEQ_NO
                OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
            ";
            
            var parameters = new
            {
                SiteId = query.SiteId,
                BId = query.BId,
                MId = query.MId,
                SId = query.SId,
                GoodsId = query.GoodsId,
                YearMonth = query.YearMonth,
                FilterType = query.FilterType,
                Offset = (query.PageIndex - 1) * query.PageSize,
                PageSize = query.PageSize
            };
            
            var items = await _connection.QueryAsync<SYSA1015ReportDto>(sql, parameters);
            var totalCount = await _connection.QuerySingleAsync<int>("SELECT COUNT(*) FROM ...", parameters);
            
            return new PagedResult<SYSA1015ReportDto>
            {
                Items = items.ToList(),
                TotalCount = totalCount,
                PageIndex = query.PageIndex,
                PageSize = query.PageSize,
                TotalPages = (int)Math.Ceiling(totalCount / (double)query.PageSize)
            };
        }
        
        public async Task<List<SYSA1015ReportDto>> GetSYSA1015ReportAllAsync(SYSA1015QueryDto query)
        {
            // 類似 GetSYSA1015ReportAsync，但不分頁
        }
    }
}
```

#### 3.2.4 DTO: `SYSA1015Dto.cs`
```csharp
namespace RSL.IMS3.Application.DTOs
{
    public class SYSA1015QueryDto
    {
        public string? SiteId { get; set; }
        public string? BId { get; set; }
        public string? MId { get; set; }
        public string? SId { get; set; }
        public string? GoodsId { get; set; }
        public string? YearMonth { get; set; }
        public string? FilterType { get; set; }
        public int PageIndex { get; set; } = 1;
        public int PageSize { get; set; } = 20;
    }
    
    public class SYSA1015ReportDto
    {
        public string SiteId { get; set; }
        public string SiteName { get; set; }
        public string ReportName { get; set; }
        public string SeqNo { get; set; }
        public string BId { get; set; }
        public string MId { get; set; }
        public string SId { get; set; }
        public string GoodsId { get; set; }
        public string GoodsName { get; set; }
        public string PackUnit { get; set; }
        public string Unit { get; set; }
        public decimal Qty { get; set; }
        public decimal SafeQty { get; set; }
        public string SelectType { get; set; }
        public string YearMonth { get; set; }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 商品分析報表查詢頁面 (`SYSA1015Report.vue`)
- **路徑**: `/reports/analysis/sysa1015`
- **功能**: 顯示商品分析報表查詢表單與結果
- **主要元件**:
  - 查詢表單 (SYSA1015SearchForm)
  - 報表結果表格 (SYSA1015ReportTable)
  - 報表列印/匯出按鈕

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`SYSA1015SearchForm.vue`)
```vue
<template>
  <el-form :model="searchForm" inline>
    <el-form-item label="店別">
      <el-select v-model="searchForm.siteId" placeholder="請選擇店別">
        <el-option v-for="site in siteList" :key="site.siteId" :label="site.siteName" :value="site.siteId" />
      </el-select>
    </el-form-item>
    <el-form-item label="年月">
      <el-date-picker
        v-model="searchForm.yearMonth"
        type="month"
        placeholder="請選擇年月"
        format="YYYY-MM"
        value-format="YYYY-MM"
      />
    </el-form-item>
    <el-form-item label="大分類">
      <el-select v-model="searchForm.bId" placeholder="請選擇大分類" @change="handleBCategoryChange">
        <el-option v-for="category in bCategoryList" :key="category.categoryId" :label="category.categoryName" :value="category.categoryId" />
      </el-select>
    </el-form-item>
    <el-form-item label="中分類">
      <el-select v-model="searchForm.mId" placeholder="請選擇中分類" @change="handleMCategoryChange" :disabled="!searchForm.bId">
        <el-option v-for="category in mCategoryList" :key="category.categoryId" :label="category.categoryName" :value="category.categoryId" />
      </el-select>
    </el-form-item>
    <el-form-item label="小分類">
      <el-select v-model="searchForm.sId" placeholder="請選擇小分類" :disabled="!searchForm.mId">
        <el-option v-for="category in sCategoryList" :key="category.categoryId" :label="category.categoryName" :value="category.categoryId" />
      </el-select>
    </el-form-item>
    <el-form-item label="商品代碼">
      <el-input v-model="searchForm.goodsId" placeholder="請輸入商品代碼" />
    </el-form-item>
    <el-form-item label="篩選類型">
      <el-radio-group v-model="searchForm.filterType">
        <el-radio label="">全部</el-radio>
        <el-radio label="safety">低於安全庫存量</el-radio>
      </el-radio-group>
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button type="success" @click="handleExport">匯出</el-button>
      <el-button type="warning" @click="handlePrint">列印</el-button>
    </el-form-item>
  </el-form>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { getSYSA1015Report, exportSYSA1015Report, printSYSA1015Report } from '@/api/analysis-report.api';
import type { SYSA1015QueryDto } from '@/api/analysis-report.api';

const searchForm = reactive<SYSA1015QueryDto>({
  siteId: '',
  bId: '',
  mId: '',
  sId: '',
  goodsId: '',
  yearMonth: '',
  filterType: '',
  pageIndex: 1,
  pageSize: 20
});

const emit = defineEmits<{
  (e: 'search', query: SYSA1015QueryDto): void;
  (e: 'reset'): void;
  (e: 'export', query: SYSA1015QueryDto): void;
  (e: 'print', query: SYSA1015QueryDto): void;
}>();

const handleSearch = () => {
  emit('search', { ...searchForm });
};

const handleReset = () => {
  Object.assign(searchForm, {
    siteId: '',
    bId: '',
    mId: '',
    sId: '',
    goodsId: '',
    yearMonth: '',
    filterType: '',
    pageIndex: 1,
    pageSize: 20
  });
  emit('reset');
};

const handleExport = () => {
  emit('export', { ...searchForm });
};

const handlePrint = () => {
  emit('print', { ...searchForm });
};

const handleBCategoryChange = () => {
  searchForm.mId = '';
  searchForm.sId = '';
};

const handleMCategoryChange = () => {
  searchForm.sId = '';
};
</script>
```

#### 4.2.2 報表結果表格元件 (`SYSA1015ReportTable.vue`)
```vue
<template>
  <div>
    <el-table :data="reportList" v-loading="loading">
      <el-table-column prop="seqNo" label="序號" width="80" />
      <el-table-column prop="siteName" label="店別" width="120" />
      <el-table-column prop="goodsId" label="商品代碼" width="120" />
      <el-table-column prop="goodsName" label="商品名稱" width="200" />
      <el-table-column prop="unit" label="單位" width="80" />
      <el-table-column prop="qty" label="數量" width="100" align="right" />
      <el-table-column prop="safeQty" label="安全庫存量" width="120" align="right" />
      <el-table-column label="狀態" width="100">
        <template #default="{ row }">
          <el-tag :type="row.qty < row.safeQty ? 'danger' : 'success'">
            {{ row.qty < row.safeQty ? '低於安全庫存' : '正常' }}
          </el-tag>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import type { SYSA1015ReportDto } from '@/api/analysis-report.api';

const props = defineProps<{
  reportList: SYSA1015ReportDto[];
  loading: boolean;
  pagination: {
    pageIndex: number;
    pageSize: number;
    totalCount: number;
  };
}>();

const emit = defineEmits<{
  (e: 'page-change', pageIndex: number): void;
  (e: 'size-change', pageSize: number): void;
}>();

const handlePageChange = (pageIndex: number) => {
  emit('page-change', pageIndex);
};

const handleSizeChange = (pageSize: number) => {
  emit('size-change', pageSize);
};
</script>
```

### 4.3 API 呼叫 (`analysis-report.api.ts`)
```typescript
import request from '@/utils/request';

export interface SYSA1015ReportDto {
  siteId: string;
  siteName: string;
  reportName: string;
  seqNo: string;
  bId: string;
  mId: string;
  sId: string;
  goodsId: string;
  goodsName: string;
  packUnit: string;
  unit: string;
  qty: number;
  safeQty: number;
  selectType: string;
  yearMonth: string;
}

export interface SYSA1015QueryDto {
  siteId?: string;
  bId?: string;
  mId?: string;
  sId?: string;
  goodsId?: string;
  yearMonth?: string;
  filterType?: string;
  pageIndex: number;
  pageSize: number;
}

// API 函數
export const getSYSA1015Report = (query: SYSA1015QueryDto) => {
  return request.get<ApiResponse<PagedResult<SYSA1015ReportDto>>>('/api/v1/analysis-reports/sysa1015', { params: query });
};

export const exportSYSA1015Report = (query: SYSA1015QueryDto, format: string = 'excel') => {
  return request.post('/api/v1/analysis-reports/sysa1015/export', query, {
    params: { format },
    responseType: 'blob'
  });
};

export const printSYSA1015Report = (query: SYSA1015QueryDto) => {
  return request.post('/api/v1/analysis-reports/sysa1015/print', query, {
    responseType: 'blob'
  });
};
```

---

## 五、開發時程與資源

### 5.1 階段一: 資料庫設計 (0.5天)
- [ ] 確認資料表結構（參考 SYSA1000）
- [ ] 建立報表查詢視圖或預存程序
- [ ] 建立索引

### 5.2 階段二: 後端開發 (2天)
- [ ] DTO 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] 報表匯出功能（Excel/PDF）
- [ ] 報表列印功能

### 5.3 階段三: 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 查詢表單開發
- [ ] 報表結果表格開發
- [ ] 報表匯出功能
- [ ] 報表列印功能

### 5.4 階段四: 整合測試 (0.5天)
- [ ] API 整合測試
- [ ] 報表查詢測試
- [ ] 報表匯出測試
- [ ] 報表列印測試

**總計**: 5天

---

## 六、測試計劃

### 6.1 單元測試
- [ ] 查詢商品分析報表成功
- [ ] 依分類查詢成功
- [ ] 依商品代碼查詢成功
- [ ] 依年月查詢成功
- [ ] 低於安全庫存量篩選成功
- [ ] 報表匯出成功
- [ ] 報表列印成功

### 6.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 報表匯出流程測試
- [ ] 報表列印流程測試
- [ ] 權限檢查測試

---

## 七、部署計劃

### 7.1 部署前置作業
- [ ] 資料庫遷移腳本準備
- [ ] 環境變數設定
- [ ] 權限設定

### 7.2 部署步驟
- [ ] 後端 API 部署
- [ ] 前端頁面部署
- [ ] 報表模板部署

---

## 八、附錄

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1015.ascx`
- `WEB/IMS_CORE/SYSA000/js/SYSA1015.js`
- `WEB/IMS_CORE/SYSA000/SYSA1015.rdlc`

### 8.2 相關開發計劃
- `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md`
- `開發計劃/10-分析報表/02-進銷存分析/SYSA1011-商品分析報表.md`

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

