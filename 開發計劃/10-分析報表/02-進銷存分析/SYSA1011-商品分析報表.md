# SYSA1011 - 商品分析報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1011
- **功能名稱**: 商品分析報表
- **功能描述**: 提供商品分析報表的查詢功能，支援依大分類、中分類、小分類、商品代碼、店別等條件查詢商品庫存資訊，包含商品名稱、單位、數量、安全庫存量等資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1011.ascx` (查詢頁面)
  - `WEB/IMS_CORE/SYSA000/js/SYSA1011.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1011.rdlc` (報表定義)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx` (報表展示頁面)

### 1.2 業務需求
- 支援依大分類、中分類、小分類、商品代碼查詢
- 支援依店別查詢
- 支援依篩選類型查詢（全部、低於安全庫存量等）
- 支援報表列印與匯出
- 顯示商品庫存資訊（商品名稱、單位、數量、安全庫存量等）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `Goods` - 商品主檔 (對應舊系統 `IMS_AM.NAM_GOODS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `Goods` 資料表結構

#### 2.1.2 `InventoryStocks` - 庫存資料表 (對應舊系統 `IMS_AM.NAM_AM_STOCKS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `InventoryStocks` 資料表結構

#### 2.1.3 `GoodsCategories` - 商品分類表
```sql
CREATE TABLE [dbo].[GoodsCategories] (
    [CategoryId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [CategoryName] NVARCHAR(200) NOT NULL,
    [CategoryType] NVARCHAR(10) NOT NULL, -- B:大分類, M:中分類, S:小分類
    [ParentId] NVARCHAR(50) NULL, -- 父分類ID
    [SeqNo] INT NULL DEFAULT 0,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE()
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_GoodsCategories_CategoryType] ON [dbo].[GoodsCategories] ([CategoryType]);
CREATE NONCLUSTERED INDEX [IX_GoodsCategories_ParentId] ON [dbo].[GoodsCategories] ([ParentId]);
```

### 2.2 報表資料結構

#### 2.2.1 報表資料集結構
```sql
-- 報表查詢結果結構
SELECT 
    SITE_ID,
    SITE_NAME,
    REPORT_NAME,
    SEQ_NO,
    B_ID,
    M_ID,
    S_ID,
    GOODS_ID,
    GOODS_NAME,
    PACK_UNIT,
    UNIT,
    QTY,
    SAFE_QTY,
    SELECT_TYPE
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作）
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢商品分析報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1011`
- **說明**: 查詢商品分析報表資料
- **請求參數**:
  ```json
  {
    "siteId": "",
    "bId": "",
    "mId": "",
    "sId": "",
    "goodsId": "",
    "filterType": "", // 篩選類型 (全部、低於安全庫存量等)
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "店別名稱",
          "reportName": "商品分析報表",
          "seqNo": "1",
          "bId": "B001",
          "mId": "M001",
          "sId": "S001",
          "goodsId": "G001",
          "goodsName": "商品名稱",
          "packUnit": "箱",
          "unit": "個",
          "qty": 100,
          "safeQty": 50,
          "selectType": "全部"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1011/export`
- **說明**: 匯出商品分析報表（Excel/PDF）
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

#### 3.1.3 列印商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1011/print`
- **說明**: 列印商品分析報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

### 3.2 後端實作類別

#### 3.2.1 Controller: `AnalysisReportsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis-reports")]
    [Authorize]
    public class AnalysisReportsController : ControllerBase
    {
        private readonly IAnalysisReportService _analysisReportService;
        
        public AnalysisReportsController(IAnalysisReportService analysisReportService)
        {
            _analysisReportService = analysisReportService;
        }
        
        [HttpGet("sysa1011")]
        public async Task<ActionResult<ApiResponse<PagedResult<SYSA1011ReportDto>>>> GetSYSA1011Report([FromQuery] SYSA1011QueryDto query)
        {
            // 實作查詢邏輯
        }
        
        [HttpPost("sysa1011/export")]
        public async Task<IActionResult> ExportSYSA1011Report([FromBody] SYSA1011QueryDto query, [FromQuery] string format = "excel")
        {
            // 實作匯出邏輯
        }
        
        [HttpPost("sysa1011/print")]
        public async Task<IActionResult> PrintSYSA1011Report([FromBody] SYSA1011QueryDto query)
        {
            // 實作列印邏輯
        }
    }
}
```

#### 3.2.2 Service: `AnalysisReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IAnalysisReportService
    {
        Task<PagedResult<SYSA1011ReportDto>> GetSYSA1011ReportAsync(SYSA1011QueryDto query);
        Task<byte[]> ExportSYSA1011ReportAsync(SYSA1011QueryDto query, string format);
        Task<byte[]> PrintSYSA1011ReportAsync(SYSA1011QueryDto query);
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 商品分析報表查詢頁面 (`SYSA1011Report.vue`)
- **路徑**: `/reports/analysis/sysa1011`
- **功能**: 顯示商品分析報表查詢表單與結果
- **主要元件**:
  - 查詢表單 (SYSA1011SearchForm)
  - 報表結果表格 (SYSA1011ReportTable)
  - 報表列印/匯出按鈕

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`SYSA1011SearchForm.vue`)
```vue
<template>
  <el-form :model="searchForm" inline>
    <el-form-item label="店別">
      <el-select v-model="searchForm.siteId" placeholder="請選擇店別">
        <el-option v-for="site in siteList" :key="site.siteId" :label="site.siteName" :value="site.siteId" />
      </el-select>
    </el-form-item>
    <el-form-item label="大分類">
      <el-select v-model="searchForm.bId" placeholder="請選擇大分類" @change="handleBCategoryChange">
        <el-option v-for="category in bCategoryList" :key="category.categoryId" :label="category.categoryName" :value="category.categoryId" />
      </el-select>
    </el-form-item>
    <el-form-item label="中分類">
      <el-select v-model="searchForm.mId" placeholder="請選擇中分類" @change="handleMCategoryChange" :disabled="!searchForm.bId">
        <el-option v-for="category in mCategoryList" :key="category.categoryId" :label="category.categoryName" :value="category.categoryId" />
      </el-select>
    </el-form-item>
    <el-form-item label="小分類">
      <el-select v-model="searchForm.sId" placeholder="請選擇小分類" :disabled="!searchForm.mId">
        <el-option v-for="category in sCategoryList" :key="category.categoryId" :label="category.categoryName" :value="category.categoryId" />
      </el-select>
    </el-form-item>
    <el-form-item label="商品代碼">
      <el-input v-model="searchForm.goodsId" placeholder="請輸入商品代碼" />
    </el-form-item>
    <el-form-item label="篩選類型">
      <el-radio-group v-model="searchForm.filterType">
        <el-radio label="">全部</el-radio>
        <el-radio label="safety">低於安全庫存量</el-radio>
      </el-radio-group>
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button type="success" @click="handleExport">匯出</el-button>
      <el-button type="warning" @click="handlePrint">列印</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 報表結果表格元件 (`SYSA1011ReportTable.vue`)
```vue
<template>
  <div>
    <el-table :data="reportList" v-loading="loading">
      <el-table-column prop="seqNo" label="序號" width="80" />
      <el-table-column prop="siteName" label="店別" width="120" />
      <el-table-column prop="goodsId" label="商品代碼" width="120" />
      <el-table-column prop="goodsName" label="商品名稱" width="200" />
      <el-table-column prop="unit" label="單位" width="80" />
      <el-table-column prop="qty" label="數量" width="100" align="right" />
      <el-table-column prop="safeQty" label="安全庫存量" width="120" align="right" />
      <el-table-column label="狀態" width="100">
        <template #default="{ row }">
          <el-tag :type="row.qty < row.safeQty ? 'danger' : 'success'">
            {{ row.qty < row.safeQty ? '低於安全庫存' : '正常' }}
          </el-tag>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

### 4.3 API 呼叫 (`analysis-report.api.ts`)
```typescript
import request from '@/utils/request';

export interface SYSA1011ReportDto {
  siteId: string;
  siteName: string;
  reportName: string;
  seqNo: string;
  bId: string;
  mId: string;
  sId: string;
  goodsId: string;
  goodsName: string;
  packUnit: string;
  unit: string;
  qty: number;
  safeQty: number;
  selectType: string;
}

export interface SYSA1011QueryDto {
  siteId?: string;
  bId?: string;
  mId?: string;
  sId?: string;
  goodsId?: string;
  filterType?: string;
  pageIndex: number;
  pageSize: number;
}

// API 函數
export const getSYSA1011Report = (query: SYSA1011QueryDto) => {
  return request.get<ApiResponse<PagedResult<SYSA1011ReportDto>>>('/api/v1/analysis-reports/sysa1011', { params: query });
};

export const exportSYSA1011Report = (query: SYSA1011QueryDto, format: string = 'excel') => {
  return request.post('/api/v1/analysis-reports/sysa1011/export', query, {
    params: { format },
    responseType: 'blob'
  });
};

export const printSYSA1011Report = (query: SYSA1011QueryDto) => {
  return request.post('/api/v1/analysis-reports/sysa1011/print', query, {
    responseType: 'blob'
  });
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (0.5天)
- [ ] 確認資料表結構（參考 SYSA1000）
- [ ] 建立報表查詢視圖或預存程序
- [ ] 建立索引

### 5.2 階段二: 後端開發 (2天)
- [ ] DTO 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] 報表匯出功能（Excel/PDF）
- [ ] 報表列印功能

### 5.3 階段三: 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 查詢表單開發
- [ ] 報表結果表格開發
- [ ] 報表匯出功能
- [ ] 報表列印功能

### 5.4 階段四: 整合測試 (0.5天)
- [ ] API 整合測試
- [ ] 報表查詢測試
- [ ] 報表匯出測試
- [ ] 報表列印測試

**總計**: 5天

---

## 六、注意事項

### 6.1 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 報表查詢結果應使用快取機制
- 報表匯出應使用非同步處理

### 6.2 業務邏輯
- 分類選擇應有階層關係（大分類 → 中分類 → 小分類）
- 低於安全庫存量篩選應正確計算
- 報表資料應與實際庫存資料一致

### 6.3 報表功能
- 支援 Excel 匯出
- 支援 PDF 列印
- 報表格式應符合舊系統格式

---

## 七、測試案例

### 7.1 單元測試
- [ ] 查詢商品分析報表成功
- [ ] 依分類查詢成功
- [ ] 依商品代碼查詢成功
- [ ] 低於安全庫存量篩選成功
- [ ] 報表匯出成功
- [ ] 報表列印成功

### 7.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 報表匯出流程測試
- [ ] 報表列印流程測試
- [ ] 權限檢查測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1011.ascx`
- `WEB/IMS_CORE/SYSA000/js/SYSA1011.js`
- `WEB/IMS_CORE/SYSA000/SYSA1011.rdlc`
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx`

### 8.2 相關開發計劃
- `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md`

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

