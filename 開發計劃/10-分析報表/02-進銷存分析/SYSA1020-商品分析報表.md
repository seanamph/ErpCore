# SYSA1020 - 商品分析報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1020
- **功能名稱**: 商品分析報表
- **功能描述**: 提供商品分析報表的查詢功能，支援依店別、計劃ID、顯示類型、篩選類型等條件查詢商品相關資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1020.ascx` (查詢頁面)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1020.ascx.cs` (後端邏輯)
  - `WEB/IMS_CORE/SYSA000/js/SYSA1020.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1020.rdlc` (報表定義)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx` (報表展示頁面)

### 1.2 業務需求
- 支援依店別查詢
- 支援依計劃ID查詢
- 支援依顯示類型查詢
- 支援依篩選類型查詢（全部、特定條件等）
- 支援報表列印與匯出
- 顯示商品相關分析資訊

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `Goods` - 商品主檔 (對應舊系統 `IMS_AM.NAM_GOODS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `Goods` 資料表結構

#### 2.1.2 `InventoryStocks` - 庫存資料表 (對應舊系統 `IMS_AM.NAM_AM_STOCKS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `InventoryStocks` 資料表結構

#### 2.1.3 `Plans` - 計劃主檔
```sql
CREATE TABLE [dbo].[Plans] (
    [PlanId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [PlanName] NVARCHAR(200) NULL,
    [PlanType] NVARCHAR(50) NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE()
);
```

#### 2.1.4 `Sites` - 店別資料表
- 參考: `開發計劃/02-基本資料管理/04-組織架構/SYSWB60-庫別資料維護作業.md` 的 `Sites` 資料表結構

### 2.2 報表資料結構

#### 2.2.1 報表查詢結果結構
```sql
-- 報表查詢結果結構（需根據實際業務邏輯調整）
SELECT 
    SITE_ID,
    SITE_NAME,
    PLAN_ID,
    PLAN_NAME,
    SHOW_TYPE,
    FILTER_TYPE,
    SEQ_NO,
    GOODS_ID,
    GOODS_NAME,
    -- 其他報表欄位（需根據實際報表定義調整）
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作）
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢商品分析報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1020`
- **說明**: 查詢商品分析報表資料
- **請求參數**:
  ```json
  {
    "siteId": "",
    "planId": "",
    "showType": "",
    "filterType": "",
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "店別名稱",
          "planId": "PLAN001",
          "planName": "計劃名稱",
          "showType": "顯示類型",
          "filterType": "全部",
          "seqNo": "1",
          "goodsId": "G001",
          "goodsName": "商品名稱"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1020/export`
- **說明**: 匯出商品分析報表（Excel/PDF）
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

#### 3.1.3 列印商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1020/print`
- **說明**: 列印商品分析報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

### 3.2 後端實作類別

#### 3.2.1 Controller: `AnalysisReportsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis-reports")]
    [Authorize]
    public class AnalysisReportsController : ControllerBase
    {
        private readonly IAnalysisReportService _analysisReportService;
        
        public AnalysisReportsController(IAnalysisReportService analysisReportService)
        {
            _analysisReportService = analysisReportService;
        }
        
        [HttpGet("sysa1020")]
        public async Task<ActionResult<ApiResponse<PagedResult<SYSA1020ReportDto>>>> GetSYSA1020Report([FromQuery] SYSA1020QueryDto query)
        {
            var result = await _analysisReportService.GetSYSA1020ReportAsync(query);
            return Ok(ApiResponse.Success(result));
        }
        
        [HttpPost("sysa1020/export")]
        public async Task<IActionResult> ExportSYSA1020Report([FromBody] SYSA1020QueryDto query, [FromQuery] string format = "excel")
        {
            var fileBytes = await _analysisReportService.ExportSYSA1020ReportAsync(query, format);
            var fileName = $"SYSA1020_商品分析報表_{DateTime.Now:yyyyMMddHHmmss}.{(format == "excel" ? "xlsx" : "pdf")}";
            return File(fileBytes, format == "excel" ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" : "application/pdf", fileName);
        }
        
        [HttpPost("sysa1020/print")]
        public async Task<IActionResult> PrintSYSA1020Report([FromBody] SYSA1020QueryDto query)
        {
            var fileBytes = await _analysisReportService.PrintSYSA1020ReportAsync(query);
            var fileName = $"SYSA1020_商品分析報表_{DateTime.Now:yyyyMMddHHmmss}.pdf";
            return File(fileBytes, "application/pdf", fileName);
        }
    }
}
```

#### 3.2.2 Service: `AnalysisReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IAnalysisReportService
    {
        Task<PagedResult<SYSA1020ReportDto>> GetSYSA1020ReportAsync(SYSA1020QueryDto query);
        Task<byte[]> ExportSYSA1020ReportAsync(SYSA1020QueryDto query, string format);
        Task<byte[]> PrintSYSA1020ReportAsync(SYSA1020QueryDto query);
    }
    
    public class AnalysisReportService : IAnalysisReportService
    {
        private readonly IDbConnection _db;
        private readonly IExcelService _excelService;
        private readonly IPdfService _pdfService;
        
        public AnalysisReportService(IDbConnection db, IExcelService excelService, IPdfService pdfService)
        {
            _db = db;
            _excelService = excelService;
            _pdfService = pdfService;
        }
        
        public async Task<PagedResult<SYSA1020ReportDto>> GetSYSA1020ReportAsync(SYSA1020QueryDto query)
        {
            // 實作查詢邏輯（需根據實際業務邏輯調整）
            var sql = @"
                SELECT 
                    s.SiteId AS SiteId,
                    s.SiteName AS SiteName,
                    p.PlanId AS PlanId,
                    p.PlanName AS PlanName,
                    @ShowType AS ShowType,
                    @FilterType AS FilterType,
                    ROW_NUMBER() OVER (ORDER BY g.GoodsId) AS SeqNo,
                    g.GoodsId AS GoodsId,
                    g.GoodsName AS GoodsName
                FROM Goods g
                LEFT JOIN InventoryStocks st ON g.GoodsId = st.GoodsId
                LEFT JOIN Sites s ON st.SiteId = s.SiteId
                LEFT JOIN Plans p ON st.PlanId = p.PlanId
                WHERE 1=1
                    AND (@SiteId IS NULL OR st.SiteId = @SiteId)
                    AND (@PlanId IS NULL OR st.PlanId = @PlanId)
                    AND (@ShowType IS NULL OR @ShowType = '' OR @ShowType = '全部')
                    AND (@FilterType IS NULL OR @FilterType = '' OR @FilterType = '全部')
                GROUP BY s.SiteId, s.SiteName, p.PlanId, p.PlanName, g.GoodsId, g.GoodsName
                ORDER BY g.GoodsId
                OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
            ";
            
            var parameters = new
            {
                SiteId = query.SiteId,
                PlanId = query.PlanId,
                ShowType = query.ShowType,
                FilterType = query.FilterType,
                Offset = (query.PageIndex - 1) * query.PageSize,
                PageSize = query.PageSize
            };
            
            var items = await _db.QueryAsync<SYSA1020ReportDto>(sql, parameters);
            var totalCount = await _db.QuerySingleAsync<int>("SELECT COUNT(*) FROM ...", parameters);
            
            return new PagedResult<SYSA1020ReportDto>
            {
                Items = items.ToList(),
                TotalCount = totalCount,
                PageIndex = query.PageIndex,
                PageSize = query.PageSize,
                TotalPages = (int)Math.Ceiling(totalCount / (double)query.PageSize)
            };
        }
        
        public async Task<byte[]> ExportSYSA1020ReportAsync(SYSA1020QueryDto query, string format)
        {
            var data = await GetSYSA1020ReportAsync(query);
            
            if (format == "excel")
            {
                return await _excelService.ExportToExcelAsync(data.Items, "商品分析報表");
            }
            else
            {
                return await _pdfService.ExportToPdfAsync(data.Items, "商品分析報表");
            }
        }
        
        public async Task<byte[]> PrintSYSA1020ReportAsync(SYSA1020QueryDto query)
        {
            var data = await GetSYSA1020ReportAsync(query);
            return await _pdfService.PrintReportAsync(data.Items, "SYSA1020", query);
        }
    }
}
```

#### 3.2.3 DTO: `SYSA1020QueryDto.cs` 和 `SYSA1020ReportDto.cs`
```csharp
namespace RSL.IMS3.Application.DTOs
{
    public class SYSA1020QueryDto : PagedQueryDto
    {
        public string SiteId { get; set; }
        public string PlanId { get; set; }
        public string ShowType { get; set; }
        public string FilterType { get; set; }
    }
    
    public class SYSA1020ReportDto
    {
        public string SiteId { get; set; }
        public string SiteName { get; set; }
        public string PlanId { get; set; }
        public string PlanName { get; set; }
        public string ShowType { get; set; }
        public string FilterType { get; set; }
        public string SeqNo { get; set; }
        public string GoodsId { get; set; }
        public string GoodsName { get; set; }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 查詢頁面 (`/analysis-reports/sysa1020`)
- **路由**: `/analysis-reports/sysa1020`
- **組件**: `SYSA1020Query.vue`
- **功能**: 查詢條件設定、報表查詢、報表列印、報表匯出

#### 4.1.2 報表展示頁面 (`/analysis-reports/sysa1020/view`)
- **路由**: `/analysis-reports/sysa1020/view`
- **組件**: `SYSA1020ReportView.vue`
- **功能**: 報表資料展示、報表列印、報表匯出

### 4.2 查詢頁面設計

#### 4.2.1 查詢條件表單
```vue
<template>
  <div class="sysa1020-query">
    <el-form :model="queryForm" label-width="120px">
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="店別" prop="siteId">
            <el-select v-model="queryForm.siteId" placeholder="請選擇店別" clearable>
              <el-option
                v-for="site in siteList"
                :key="site.siteId"
                :label="site.siteName"
                :value="site.siteId"
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="計劃ID" prop="planId">
            <el-select v-model="queryForm.planId" placeholder="請選擇計劃ID" clearable>
              <el-option
                v-for="plan in planList"
                :key="plan.planId"
                :label="plan.planName"
                :value="plan.planId"
              />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="顯示類型" prop="showType">
            <el-select v-model="queryForm.showType" placeholder="請選擇顯示類型" clearable>
              <el-option label="類型1" value="TYPE1" />
              <el-option label="類型2" value="TYPE2" />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="篩選類型" prop="filterType">
            <el-radio-group v-model="queryForm.filterType">
              <el-radio label="全部">全部</el-radio>
              <el-radio label="特定條件">特定條件</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-col>
      </el-row>
      <el-form-item>
        <el-button type="primary" @click="handleQuery">查詢</el-button>
        <el-button @click="handleReset">重置</el-button>
        <el-button type="success" @click="handleExport">匯出</el-button>
        <el-button type="warning" @click="handlePrint">列印</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue'
import { useRouter } from 'vue-router'
import { analysisReportApi } from '@/api/analysis-reports'
import type { SYSA1020QueryDto } from '@/types/analysis-reports'

const router = useRouter()
const queryForm = reactive<SYSA1020QueryDto>({
  siteId: '',
  planId: '',
  showType: '',
  filterType: '全部',
  pageIndex: 1,
  pageSize: 20
})

const siteList = ref([])
const planList = ref([])

const handleQuery = async () => {
  // 驗證必填欄位
  if (!queryForm.siteId || !queryForm.planId) {
    ElMessage.warning('請選擇店別和計劃ID')
    return
  }
  
  // 導航到報表展示頁面
  router.push({
    path: '/analysis-reports/sysa1020/view',
    query: queryForm
  })
}

const handleReset = () => {
  Object.assign(queryForm, {
    siteId: '',
    planId: '',
    showType: '',
    filterType: '全部',
    pageIndex: 1,
    pageSize: 20
  })
}

const handleExport = async () => {
  try {
    const response = await analysisReportApi.exportSYSA1020(queryForm, 'excel')
    const blob = new Blob([response.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = `SYSA1020_商品分析報表_${new Date().toISOString().slice(0, 10)}.xlsx`
    link.click()
    window.URL.revokeObjectURL(url)
    ElMessage.success('匯出成功')
  } catch (error) {
    ElMessage.error('匯出失敗')
  }
}

const handlePrint = async () => {
  try {
    const response = await analysisReportApi.printSYSA1020(queryForm)
    const blob = new Blob([response.data], { type: 'application/pdf' })
    const url = window.URL.createObjectURL(blob)
    window.open(url, '_blank')
    ElMessage.success('列印成功')
  } catch (error) {
    ElMessage.error('列印失敗')
  }
}
</script>
```

### 4.3 報表展示頁面設計

#### 4.3.1 報表資料表格
```vue
<template>
  <div class="sysa1020-report-view">
    <el-table :data="reportData" border stripe style="width: 100%">
      <el-table-column prop="seqNo" label="序號" width="80" />
      <el-table-column prop="siteName" label="店別" width="120" />
      <el-table-column prop="planName" label="計劃名稱" width="120" />
      <el-table-column prop="goodsId" label="品項編號" width="120" />
      <el-table-column prop="goodsName" label="品項名稱" width="200" />
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[20, 50, 100, 200]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRoute } from 'vue-router'
import { analysisReportApi } from '@/api/analysis-reports'
import type { SYSA1020ReportDto } from '@/types/analysis-reports'

const route = useRoute()
const reportData = ref<SYSA1020ReportDto[]>([])
const pagination = ref({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
})

const loadReportData = async () => {
  try {
    const query = {
      ...route.query,
      pageIndex: pagination.value.pageIndex,
      pageSize: pagination.value.pageSize
    }
    const response = await analysisReportApi.getSYSA1020(query)
    reportData.value = response.data.items
    pagination.value.totalCount = response.data.totalCount
  } catch (error) {
    ElMessage.error('載入報表資料失敗')
  }
}

const handleSizeChange = (size: number) => {
  pagination.value.pageSize = size
  loadReportData()
}

const handlePageChange = (page: number) => {
  pagination.value.pageIndex = page
  loadReportData()
}

onMounted(() => {
  loadReportData()
})
</script>
```

---

## 五、開發任務清單

### 5.1 後端開發
- [ ] 建立 `SYSA1020QueryDto` 和 `SYSA1020ReportDto` DTO 類別
- [ ] 實作 `AnalysisReportService.GetSYSA1020ReportAsync` 方法
- [ ] 實作 `AnalysisReportService.ExportSYSA1020ReportAsync` 方法
- [ ] 實作 `AnalysisReportService.PrintSYSA1020ReportAsync` 方法
- [ ] 建立 `AnalysisReportsController.GetSYSA1020Report` API 端點
- [ ] 建立 `AnalysisReportsController.ExportSYSA1020Report` API 端點
- [ ] 建立 `AnalysisReportsController.PrintSYSA1020Report` API 端點
- [ ] 撰寫單元測試

### 5.2 前端開發
- [ ] 建立 `SYSA1020Query.vue` 查詢頁面組件
- [ ] 建立 `SYSA1020ReportView.vue` 報表展示頁面組件
- [ ] 建立 `analysisReportApi.getSYSA1020` API 方法
- [ ] 建立 `analysisReportApi.exportSYSA1020` API 方法
- [ ] 建立 `analysisReportApi.printSYSA1020` API 方法
- [ ] 建立路由設定
- [ ] 建立類型定義
- [ ] 撰寫單元測試

### 5.3 資料庫開發
- [ ] 確認 `Goods` 資料表結構
- [ ] 確認 `InventoryStocks` 資料表結構
- [ ] 確認 `Plans` 資料表結構
- [ ] 確認 `Sites` 資料表結構
- [ ] 建立必要的索引
- [ ] 撰寫查詢效能測試

### 5.4 測試
- [ ] 單元測試
- [ ] 整合測試
- [ ] 效能測試
- [ ] 使用者驗收測試

---

## 六、注意事項

1. **查詢效能**: 由於報表查詢可能涉及大量資料，需要優化查詢效能，建議使用適當的索引和分頁查詢
2. **必填欄位**: 店別和計劃ID為必填欄位，需要在前端和後端都進行驗證
3. **報表格式**: 支援 Excel 和 PDF 兩種格式的匯出，需要確保格式正確
4. **權限控制**: 需要根據使用者權限控制查詢、匯出、列印功能
5. **資料快取**: 對於大量資料的報表，可以考慮使用快取機制提升效能

---

## 七、參考資料

### 7.1 舊程式碼
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1020.ascx`
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1020.ascx.cs`
- `WEB/IMS_CORE/SYSA000/js/SYSA1020.js`
- `WEB/IMS_CORE/SYSA000/SYSA1020.rdlc`

### 7.2 相關功能
- `SYSA1000-進銷存分析報表.md` - 進銷存分析報表主頁面
- `SYSA1019-商品分析報表.md` - 商品分析報表（類似功能）

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

