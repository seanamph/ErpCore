# SYSA1018 - 工務維修件數統計表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1018
- **功能名稱**: 工務維修件數統計表
- **功能描述**: 提供工務維修件數統計報表的查詢功能，支援依組織單位、年月等條件查詢工務維修件數統計資訊，包含維修件數、維修類型、維修狀態等資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1018.ascx` (查詢頁面)
  - `WEB/IMS_CORE/SYSA000/js/SYSA1018.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1018.rdlc` (報表定義)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx` (報表展示頁面)

### 1.2 業務需求
- 支援依組織單位查詢
- 支援依年月查詢
- 支援依篩選類型查詢
- 支援報表列印與匯出
- 顯示工務維修件數統計資訊（維修件數、維修類型、維修狀態等）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `MaintenanceRecords` - 工務維修記錄表
```sql
CREATE TABLE [dbo].[MaintenanceRecords] (
    [RecordId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [OrgId] NVARCHAR(50) NOT NULL, -- 組織單位代號
    [MaintenanceDate] DATETIME2 NOT NULL, -- 維修日期
    [MaintenanceType] NVARCHAR(50) NULL, -- 維修類型
    [MaintenanceStatus] NVARCHAR(20) NOT NULL, -- 維修狀態 (待處理/處理中/已完成/已取消)
    [ItemCount] INT NOT NULL DEFAULT 0, -- 維修件數
    [Description] NVARCHAR(500) NULL, -- 維修說明
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_MaintenanceRecords_Organizations] FOREIGN KEY ([OrgId]) REFERENCES [dbo].[Organizations] ([OrgId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_MaintenanceRecords_OrgId] ON [dbo].[MaintenanceRecords] ([OrgId]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRecords_MaintenanceDate] ON [dbo].[MaintenanceRecords] ([MaintenanceDate]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRecords_MaintenanceStatus] ON [dbo].[MaintenanceRecords] ([MaintenanceStatus]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRecords_MaintenanceType] ON [dbo].[MaintenanceRecords] ([MaintenanceType]);
```

#### 2.1.2 `Organizations` - 組織單位表
- 參考: `開發計劃/02-基本資料管理/04-組織架構/SYSWB40-部別資料維護作業.md` 的 `Organizations` 資料表結構

### 2.2 報表資料結構

#### 2.2.1 報表資料集結構
```sql
-- 報表查詢結果結構
SELECT 
    ORG_ID,
    ORG_NAME,
    REPORT_NAME,
    YEAR_MONTH,
    MAINTENANCE_TYPE,
    MAINTENANCE_STATUS,
    ITEM_COUNT,
    TOTAL_COUNT
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作）
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢工務維修件數統計報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1018`
- **說明**: 查詢工務維修件數統計報表資料
- **請求參數**:
  ```json
  {
    "orgId": "",
    "yearMonth": "2024-01",
    "filterType": "",
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "orgId": "ORG001",
          "orgName": "組織單位名稱",
          "reportName": "工務維修件數統計表",
          "yearMonth": "2024-01",
          "maintenanceType": "維修類型",
          "maintenanceStatus": "已完成",
          "itemCount": 10,
          "totalCount": 100
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出工務維修件數統計報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1018/export`
- **說明**: 匯出工務維修件數統計報表（Excel/PDF）
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

#### 3.1.3 列印工務維修件數統計報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1018/print`
- **說明**: 列印工務維修件數統計報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

### 3.2 後端實作類別

#### 3.2.1 Controller: `AnalysisReportsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis-reports")]
    [Authorize]
    public class AnalysisReportsController : ControllerBase
    {
        private readonly IAnalysisReportService _analysisReportService;
        
        public AnalysisReportsController(IAnalysisReportService analysisReportService)
        {
            _analysisReportService = analysisReportService;
        }
        
        [HttpGet("sysa1018")]
        public async Task<ActionResult<ApiResponse<PagedResult<SYSA1018ReportDto>>>> GetSYSA1018Report([FromQuery] SYSA1018QueryDto query)
        {
            var result = await _analysisReportService.GetSYSA1018ReportAsync(query);
            return Ok(ApiResponse.Success(result));
        }
        
        [HttpPost("sysa1018/export")]
        public async Task<IActionResult> ExportSYSA1018Report([FromBody] SYSA1018QueryDto query, [FromQuery] string format = "excel")
        {
            var fileBytes = await _analysisReportService.ExportSYSA1018ReportAsync(query, format);
            var fileName = $"工務維修件數統計表_{DateTime.Now:yyyyMMddHHmmss}.{(format == "excel" ? "xlsx" : "pdf")}";
            return File(fileBytes, format == "excel" ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" : "application/pdf", fileName);
        }
        
        [HttpPost("sysa1018/print")]
        public async Task<IActionResult> PrintSYSA1018Report([FromBody] SYSA1018QueryDto query)
        {
            var fileBytes = await _analysisReportService.PrintSYSA1018ReportAsync(query);
            return File(fileBytes, "application/pdf", $"工務維修件數統計表_{DateTime.Now:yyyyMMddHHmmss}.pdf");
        }
    }
}
```

#### 3.2.2 Service: `AnalysisReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IAnalysisReportService
    {
        Task<PagedResult<SYSA1018ReportDto>> GetSYSA1018ReportAsync(SYSA1018QueryDto query);
        Task<byte[]> ExportSYSA1018ReportAsync(SYSA1018QueryDto query, string format);
        Task<byte[]> PrintSYSA1018ReportAsync(SYSA1018QueryDto query);
    }
    
    public class AnalysisReportService : IAnalysisReportService
    {
        private readonly IMaintenanceRecordRepository _maintenanceRecordRepository;
        private readonly IReportExportService _reportExportService;
        
        public async Task<PagedResult<SYSA1018ReportDto>> GetSYSA1018ReportAsync(SYSA1018QueryDto query)
        {
            // 實作查詢邏輯
            var records = await _maintenanceRecordRepository.GetMaintenanceRecordsAsync(query);
            var dtos = records.Select(r => new SYSA1018ReportDto
            {
                OrgId = r.OrgId,
                OrgName = r.OrgName,
                ReportName = "工務維修件數統計表",
                YearMonth = query.YearMonth,
                MaintenanceType = r.MaintenanceType,
                MaintenanceStatus = r.MaintenanceStatus,
                ItemCount = r.ItemCount,
                TotalCount = records.Sum(x => x.ItemCount)
            }).ToList();
            
            return new PagedResult<SYSA1018ReportDto>
            {
                Items = dtos,
                TotalCount = dtos.Count,
                PageIndex = query.PageIndex,
                PageSize = query.PageSize
            };
        }
        
        public async Task<byte[]> ExportSYSA1018ReportAsync(SYSA1018QueryDto query, string format)
        {
            var data = await GetSYSA1018ReportAsync(query);
            return await _reportExportService.ExportAsync(data.Items, format);
        }
        
        public async Task<byte[]> PrintSYSA1018ReportAsync(SYSA1018QueryDto query)
        {
            var data = await GetSYSA1018ReportAsync(query);
            return await _reportExportService.GeneratePdfAsync(data.Items, "SYSA1018");
        }
    }
}
```

#### 3.2.3 DTO: `SYSA1018ReportDto.cs`
```csharp
namespace RSL.IMS3.Application.DTOs
{
    public class SYSA1018ReportDto
    {
        public string OrgId { get; set; }
        public string OrgName { get; set; }
        public string ReportName { get; set; }
        public string YearMonth { get; set; }
        public string MaintenanceType { get; set; }
        public string MaintenanceStatus { get; set; }
        public int ItemCount { get; set; }
        public int TotalCount { get; set; }
    }
    
    public class SYSA1018QueryDto
    {
        public string OrgId { get; set; }
        public string YearMonth { get; set; }
        public string FilterType { get; set; }
        public int PageIndex { get; set; } = 1;
        public int PageSize { get; set; } = 20;
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 工務維修件數統計表查詢頁面 (`SYSA1018Report.vue`)
- **路徑**: `/reports/analysis/sysa1018`
- **功能**: 顯示工務維修件數統計表查詢表單與結果
- **主要元件**:
  - 查詢表單 (SYSA1018SearchForm)
  - 報表結果表格 (SYSA1018ReportTable)
  - 報表列印/匯出按鈕

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`SYSA1018SearchForm.vue`)
```vue
<template>
  <el-form :model="searchForm" inline>
    <el-form-item label="組織單位">
      <el-select v-model="searchForm.orgId" placeholder="請選擇組織單位" clearable>
        <el-option v-for="org in orgList" :key="org.orgId" :label="org.orgName" :value="org.orgId" />
      </el-select>
    </el-form-item>
    <el-form-item label="年月">
      <el-date-picker
        v-model="searchForm.yearMonth"
        type="month"
        placeholder="請選擇年月"
        format="YYYY-MM"
        value-format="YYYY-MM"
      />
    </el-form-item>
    <el-form-item label="篩選類型">
      <el-select v-model="searchForm.filterType" placeholder="請選擇篩選類型" clearable>
        <el-option label="全部" value="" />
        <el-option label="待處理" value="pending" />
        <el-option label="處理中" value="processing" />
        <el-option label="已完成" value="completed" />
        <el-option label="已取消" value="cancelled" />
      </el-select>
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button type="success" @click="handleExport">匯出</el-button>
      <el-button type="warning" @click="handlePrint">列印</el-button>
    </el-form-item>
  </el-form>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { getSYSA1018Report, exportSYSA1018Report, printSYSA1018Report } from '@/api/analysis-report.api';

const searchForm = reactive({
  orgId: '',
  yearMonth: '',
  filterType: ''
});

const handleSearch = () => {
  // 查詢邏輯
};

const handleReset = () => {
  Object.assign(searchForm, {
    orgId: '',
    yearMonth: '',
    filterType: ''
  });
};

const handleExport = async () => {
  // 匯出邏輯
};

const handlePrint = async () => {
  // 列印邏輯
};
</script>
```

#### 4.2.2 報表結果表格元件 (`SYSA1018ReportTable.vue`)
```vue
<template>
  <div>
    <el-table :data="reportList" v-loading="loading" border>
      <el-table-column prop="orgName" label="組織單位" width="150" />
      <el-table-column prop="yearMonth" label="年月" width="100" />
      <el-table-column prop="maintenanceType" label="維修類型" width="120" />
      <el-table-column prop="maintenanceStatus" label="維修狀態" width="100">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.maintenanceStatus)">
            {{ row.maintenanceStatus }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="itemCount" label="維修件數" width="100" align="right" />
      <el-table-column prop="totalCount" label="總件數" width="100" align="right" />
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';

const reportList = ref([]);
const loading = ref(false);
const pagination = reactive({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
});

const getStatusType = (status: string) => {
  const statusMap: Record<string, string> = {
    '待處理': 'warning',
    '處理中': 'info',
    '已完成': 'success',
    '已取消': 'danger'
  };
  return statusMap[status] || '';
};

const handleSizeChange = (size: number) => {
  pagination.pageSize = size;
  // 重新查詢
};

const handlePageChange = (page: number) => {
  pagination.pageIndex = page;
  // 重新查詢
};
</script>
```

### 4.3 API 呼叫 (`analysis-report.api.ts`)
```typescript
import request from '@/utils/request';

export interface SYSA1018ReportDto {
  orgId: string;
  orgName: string;
  reportName: string;
  yearMonth: string;
  maintenanceType: string;
  maintenanceStatus: string;
  itemCount: number;
  totalCount: number;
}

export interface SYSA1018QueryDto {
  orgId?: string;
  yearMonth?: string;
  filterType?: string;
  pageIndex: number;
  pageSize: number;
}

// API 函數
export const getSYSA1018Report = (query: SYSA1018QueryDto) => {
  return request.get<ApiResponse<PagedResult<SYSA1018ReportDto>>>('/api/v1/analysis-reports/sysa1018', { params: query });
};

export const exportSYSA1018Report = (query: SYSA1018QueryDto, format: string = 'excel') => {
  return request.post('/api/v1/analysis-reports/sysa1018/export', query, {
    params: { format },
    responseType: 'blob'
  });
};

export const printSYSA1018Report = (query: SYSA1018QueryDto) => {
  return request.post('/api/v1/analysis-reports/sysa1018/print', query, {
    responseType: 'blob'
  });
};
```

---

## 五、開發任務清單

### 5.1 資料庫設計 (0.5天)
- [ ] 建立 MaintenanceRecords 資料表
- [ ] 建立索引
- [ ] 建立外鍵約束
- [ ] 建立報表查詢視圖或預存程序

### 5.2 後端開發 (2天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 報表匯出功能（Excel/PDF）
- [ ] 報表列印功能
- [ ] 單元測試

### 5.3 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 查詢表單開發
- [ ] 報表結果表格開發
- [ ] 報表匯出功能
- [ ] 報表列印功能
- [ ] 元件測試

### 5.4 整合測試 (0.5天)
- [ ] API 整合測試
- [ ] 報表查詢測試
- [ ] 報表匯出測試
- [ ] 報表列印測試

**總計**: 5天

---

## 六、注意事項

### 6.1 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 報表查詢結果應使用快取機制
- 報表匯出應使用非同步處理

### 6.2 業務邏輯
- 年月查詢應支援年月格式 (YYYY-MM)
- 維修狀態應正確統計
- 報表資料應與實際維修記錄一致

### 6.3 報表功能
- 支援 Excel 匯出
- 支援 PDF 列印
- 報表格式應符合舊系統格式

---

## 七、測試案例

### 7.1 單元測試
- [ ] 查詢工務維修件數統計報表成功
- [ ] 依組織單位查詢成功
- [ ] 依年月查詢成功
- [ ] 依篩選類型查詢成功
- [ ] 報表匯出成功
- [ ] 報表列印成功

### 7.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 報表匯出流程測試
- [ ] 報表列印流程測試
- [ ] 權限檢查測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1018.ascx`
- `WEB/IMS_CORE/SYSA000/js/SYSA1018.js`
- `WEB/IMS_CORE/SYSA000/SYSA1018.rdlc`
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx`

### 8.2 相關開發計劃
- `開發計劃/10-分析報表/02-進銷存分析/SYSA1011-商品分析報表.md`
- `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md`

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

