# SYSA1024 - 工務維修統計報表(其他) 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1024
- **功能名稱**: 工務維修統計報表(其他)
- **功能描述**: 提供工務維修統計報表的查詢功能，支援依多種條件查詢工務維修統計資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/js/SYSA1024.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1024.rdlc` (報表定義)

### 1.2 業務需求
- 支援依多種條件查詢工務維修統計
- 支援報表列印與匯出
- 顯示工務維修統計資訊

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `MaintenanceRequests` - 工務維修申請表
參考 `SYSA1022-工務維修統計報表.md` 的資料表設計，使用相同的資料表結構。

#### 2.1.2 `MaintenanceRequestDetails` - 工務維修申請明細表
參考 `SYSA1022-工務維修統計報表.md` 的資料表設計，使用相同的資料表結構。

### 2.2 報表資料結構

#### 2.2.1 報表查詢結果結構
```sql
-- 報表查詢結果結構（其他查詢條件）
SELECT 
    site_id,
    SITE_NAME,
    REPORT_NAME,
    belong_status,
    apply_date_b,
    apply_date_e,
    belong_org,
    maintain_emp,
    apply_type,
    other_condition1,  -- 其他查詢條件1
    other_condition2,  -- 其他查詢條件2
    request_count,
    total_amount
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作，可能包含額外的查詢條件）
```

**注意**: 此報表為查詢類功能，不涉及資料的新增、修改、刪除操作。

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢工務維修統計報表(其他)
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1024`
- **說明**: 查詢工務維修統計報表資料（其他查詢條件）
- **請求參數**:
  ```json
  {
    "belongStatus": "",
    "applyDateB": "2024-01-01",
    "applyDateE": "2024-12-31",
    "belongOrg": "",
    "maintainEmp": "",
    "applyType": "",
    "siteId": "",
    "otherCondition1": "",  // 其他查詢條件1（需根據實際業務需求定義）
    "otherCondition2": "",  // 其他查詢條件2（需根據實際業務需求定義）
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "店別名稱",
          "reportName": "工務維修統計報表(其他)",
          "belongStatus": "費用負擔",
          "applyDateB": "2024-01-01",
          "applyDateE": "2024-12-31",
          "belongOrg": "費用歸屬單位",
          "maintainEmp": "維保人員",
          "applyType": "請修類別",
          "otherCondition1": "其他條件1",
          "otherCondition2": "其他條件2",
          "requestCount": 100,
          "totalAmount": 100000
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出工務維修統計報表(其他)
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1024/export`
- **說明**: 匯出工務維修統計報表（Excel/PDF）
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

#### 3.1.3 列印工務維修統計報表(其他)
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1024/print`
- **說明**: 列印工務維修統計報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

### 3.2 後端實作類別

#### 3.2.1 Service: `MaintenanceReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IMaintenanceReportService
    {
        Task<PagedResult<MaintenanceReportDto>> GetMaintenanceReportOtherAsync(MaintenanceReportOtherQueryDto query);
        Task<byte[]> ExportMaintenanceReportOtherAsync(MaintenanceReportOtherQueryDto query, string format);
        Task<byte[]> PrintMaintenanceReportOtherAsync(MaintenanceReportOtherQueryDto query);
    }
    
    public class MaintenanceReportService : IMaintenanceReportService
    {
        private readonly IMaintenanceReportRepository _repository;
        
        public async Task<PagedResult<MaintenanceReportDto>> GetMaintenanceReportOtherAsync(MaintenanceReportOtherQueryDto query)
        {
            // 實作查詢邏輯（包含其他查詢條件）
            var data = await _repository.GetMaintenanceReportOtherDataAsync(query);
            var count = await _repository.GetMaintenanceReportOtherCountAsync(query);
            
            return new PagedResult<MaintenanceReportDto>
            {
                Items = data,
                TotalCount = count,
                PageIndex = query.PageIndex,
                PageSize = query.PageSize
            };
        }
        
        public async Task<byte[]> ExportMaintenanceReportOtherAsync(MaintenanceReportOtherQueryDto query, string format)
        {
            // 實作匯出邏輯
        }
        
        public async Task<byte[]> PrintMaintenanceReportOtherAsync(MaintenanceReportOtherQueryDto query)
        {
            // 實作列印邏輯
        }
    }
}
```

#### 3.2.2 Repository: `MaintenanceReportRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public interface IMaintenanceReportRepository
    {
        Task<IEnumerable<MaintenanceReportDto>> GetMaintenanceReportOtherDataAsync(MaintenanceReportOtherQueryDto query);
        Task<int> GetMaintenanceReportOtherCountAsync(MaintenanceReportOtherQueryDto query);
    }
    
    public class MaintenanceReportRepository : IMaintenanceReportRepository
    {
        // 使用 Dapper 實作查詢（包含其他查詢條件）
    }
}
```

#### 3.2.3 Controller: `MaintenanceReportController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis-reports")]
    [Authorize]
    public class MaintenanceReportController : ControllerBase
    {
        private readonly IMaintenanceReportService _service;
        
        [HttpGet("sysa1024")]
        public async Task<IActionResult> GetMaintenanceReportOther([FromQuery] MaintenanceReportOtherQueryDto query)
        {
            var result = await _service.GetMaintenanceReportOtherAsync(query);
            return Ok(ApiResponse<PagedResult<MaintenanceReportDto>>.Success(result));
        }
        
        [HttpPost("sysa1024/export")]
        public async Task<IActionResult> ExportMaintenanceReportOther([FromBody] MaintenanceReportOtherQueryDto query, [FromQuery] string format = "excel")
        {
            var fileBytes = await _service.ExportMaintenanceReportOtherAsync(query, format);
            var fileName = $"工務維修統計報表(其他)_{DateTime.Now:yyyyMMddHHmmss}.{format}";
            return File(fileBytes, GetContentType(format), fileName);
        }
        
        [HttpPost("sysa1024/print")]
        public async Task<IActionResult> PrintMaintenanceReportOther([FromBody] MaintenanceReportOtherQueryDto query)
        {
            var fileBytes = await _service.PrintMaintenanceReportOtherAsync(query);
            return File(fileBytes, "application/pdf", $"工務維修統計報表(其他)_{DateTime.Now:yyyyMMddHHmmss}.pdf");
        }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 UI 元件設計

#### 4.1.1 查詢表單 (`MaintenanceReportOtherQuery.vue`)
```vue
<template>
  <div class="maintenance-report-other-query">
    <el-form :model="queryForm" :rules="rules" ref="queryFormRef" label-width="120px">
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="費用負擔" prop="belongStatus">
            <el-select v-model="queryForm.belongStatus" placeholder="請選擇" clearable>
              <el-option label="全部" value="" />
              <el-option label="費用負擔1" value="1" />
              <el-option label="費用負擔2" value="2" />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="店別" prop="siteId">
            <el-select v-model="queryForm.siteId" placeholder="請選擇" clearable filterable>
              <el-option 
                v-for="item in siteList" 
                :key="item.siteId" 
                :label="item.siteName" 
                :value="item.siteId" 
              />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="日統計表起" prop="applyDateB">
            <el-date-picker
              v-model="queryForm.applyDateB"
              type="date"
              placeholder="請選擇日期"
              format="YYYY-MM-DD"
              value-format="YYYY-MM-DD"
            />
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="日統計表迄" prop="applyDateE">
            <el-date-picker
              v-model="queryForm.applyDateE"
              type="date"
              placeholder="請選擇日期"
              format="YYYY-MM-DD"
              value-format="YYYY-MM-DD"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="費用歸屬單位" prop="belongOrg">
            <el-select v-model="queryForm.belongOrg" placeholder="請選擇" clearable filterable>
              <el-option 
                v-for="item in orgList" 
                :key="item.orgId" 
                :label="item.orgName" 
                :value="item.orgId" 
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="維保人員" prop="maintainEmp">
            <el-select v-model="queryForm.maintainEmp" placeholder="請選擇" clearable filterable>
              <el-option 
                v-for="item in empList" 
                :key="item.empId" 
                :label="item.empName" 
                :value="item.empId" 
              />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="請修類別" prop="applyType">
            <el-select v-model="queryForm.applyType" placeholder="請選擇" clearable>
              <el-option label="全部" value="" />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="其他條件1" prop="otherCondition1">
            <el-input v-model="queryForm.otherCondition1" placeholder="請輸入其他條件1" />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="其他條件2" prop="otherCondition2">
            <el-input v-model="queryForm.otherCondition2" placeholder="請輸入其他條件2" />
          </el-form-item>
        </el-col>
      </el-row>
      <el-form-item>
        <el-button type="primary" @click="handleQuery">查詢</el-button>
        <el-button @click="handleReset">重置</el-button>
        <el-button type="success" @click="handleExport">匯出</el-button>
        <el-button type="warning" @click="handlePrint">列印</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { maintenanceReportApi } from '@/api/analysis.api';

const queryFormRef = ref();
const queryForm = reactive({
  belongStatus: '',
  applyDateB: '',
  applyDateE: '',
  belongOrg: '',
  maintainEmp: '',
  applyType: '',
  siteId: '',
  otherCondition1: '',
  otherCondition2: ''
});

const rules = {
  applyDateB: [{ required: true, message: '請選擇日期', trigger: 'change' }],
  applyDateE: [{ required: true, message: '請選擇日期', trigger: 'change' }]
};

const handleQuery = async () => {
  await queryFormRef.value.validate();
  // 查詢邏輯
};

const handleReset = () => {
  queryFormRef.value.resetFields();
};

const handleExport = async () => {
  // 匯出邏輯
};

const handlePrint = async () => {
  // 列印邏輯
};
</script>
```

#### 4.1.2 報表展示頁面 (`MaintenanceReportOtherView.vue`)
參考 `SYSA1022-工務維修統計報表.md` 的報表展示頁面設計，但需包含其他查詢條件的顯示欄位。

### 4.3 API 呼叫 (`analysis.api.ts`)
```typescript
import request from '@/utils/request';

export interface MaintenanceReportOtherQueryDto {
  belongStatus?: string;
  applyDateB: string;
  applyDateE: string;
  belongOrg?: string;
  maintainEmp?: string;
  applyType?: string;
  siteId?: string;
  otherCondition1?: string;
  otherCondition2?: string;
  pageIndex?: number;
  pageSize?: number;
}

// API 函數
export const getMaintenanceReportOther = (query: MaintenanceReportOtherQueryDto) => {
  return request.get<ApiResponse<PagedResult<MaintenanceReportDto>>>('/api/v1/analysis-reports/sysa1024', { params: query });
};

export const exportMaintenanceReportOther = (query: MaintenanceReportOtherQueryDto, format: string = 'excel') => {
  return request.post('/api/v1/analysis-reports/sysa1024/export', query, {
    params: { format },
    responseType: 'blob'
  });
};

export const printMaintenanceReportOther = (query: MaintenanceReportOtherQueryDto) => {
  return request.post('/api/v1/analysis-reports/sysa1024/print', query, {
    responseType: 'blob'
  });
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (0.5天)
- [ ] 確認資料表結構（與SYSA1022相同）

### 5.2 階段二: 後端開發 (2.5天)
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 查詢邏輯實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (2.5天)
- [ ] API 呼叫函數
- [ ] 查詢表單開發
- [ ] 報表展示頁面開發
- [ ] 元件測試

### 5.4 階段四: 整合測試 (1天)
- [ ] API 整合測試
- [ ] 端對端測試

### 5.5 階段五: 文件與部署 (0.5天)
- [ ] API 文件更新
- [ ] 使用者手冊

**總計**: 7天

---

## 六、注意事項

### 6.1 業務邏輯
- 此報表為查詢類功能，不涉及資料的新增、修改、刪除操作
- 需確認具體的查詢條件與SYSA1022、SYSA1023的差異
- 查詢邏輯需根據實際業務需求調整
- 其他查詢條件的具體內容需與業務人員確認

### 6.2 效能優化
- 大量資料查詢需使用分頁
- 複雜查詢需建立適當索引
- 報表匯出需使用非同步處理

### 6.3 安全性
- 查詢條件需驗證
- 報表資料需權限控制
- 匯出檔案需安全處理

---

## 七、測試案例

### 7.1 單元測試
- [ ] 查詢工務維修統計報表(其他)成功
- [ ] 查詢條件驗證

### 7.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 資料驗證測試
- [ ] 錯誤處理測試
- [ ] 效能測試
- [ ] 匯出功能測試
- [ ] 列印功能測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYSA000/js/SYSA1024.js`
- `WEB/IMS_CORE/SYSA000/SYSA1024.rdlc`

### 8.2 相關功能
- `SYSA1022-工務維修統計報表.md` - 類似功能
- `SYSA1023-工務維修統計報表(報表類型).md` - 類似功能

---

**文件版本**: v1.1  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

**備註**: 此功能為報表查詢類功能，僅支援查詢、匯出、列印操作，不支援新增、修改、刪除操作。

