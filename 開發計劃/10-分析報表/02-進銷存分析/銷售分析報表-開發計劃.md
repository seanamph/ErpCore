# 銷售分析報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: 銷售分析報表
- **功能名稱**: 銷售分析報表
- **功能描述**: 提供銷售分析報表的查詢功能，支援依店別、日期範圍、商品分類、商品代碼等條件查詢銷售資訊，包含銷售金額、銷售數量、銷售筆數、平均單價、毛利率等分析資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYSD000/` (銷售管理相關頁面)
  - `WEB/IMS_CORE/ASP/SYS1000/` (銷售報表相關頁面)
  - `WEB/IMS_CORE/ASP/SYSA000/` (分析報表相關頁面)

### 1.2 業務需求
- 支援依店別查詢
- 支援依日期範圍查詢（日期起、日期訖）
- 支援依商品分類查詢（大分類、中分類、小分類）
- 支援依商品代碼查詢
- 支援依廠商查詢
- 支援依銷售人員查詢
- 支援報表列印與匯出（Excel、PDF）
- 顯示銷售分析資訊（銷售金額、銷售數量、銷售筆數、平均單價、毛利率等）
- 支援多種報表格式（日報、月報、年報、自訂期間）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `SalesOrders` - 銷貨單主檔
```sql
CREATE TABLE [dbo].[SalesOrders] (
    [OrderId] NVARCHAR(50) NOT NULL PRIMARY KEY, -- 銷貨單號
    [OrderDate] DATETIME2 NOT NULL, -- 銷貨日期
    [SiteId] NVARCHAR(50) NOT NULL, -- 店別代碼
    [CustomerId] NVARCHAR(50) NULL, -- 客戶代碼
    [SalesPersonId] NVARCHAR(50) NULL, -- 銷售人員代碼
    [TotalAmount] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 總金額
    [TotalQuantity] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 總數量
    [DiscountAmount] DECIMAL(18, 2) NULL DEFAULT 0, -- 折扣金額
    [TaxAmount] DECIMAL(18, 2) NULL DEFAULT 0, -- 稅額
    [NetAmount] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 淨額
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1', -- 狀態 (1:正常, 2:作廢, 3:退貨)
    [PaymentMethod] NVARCHAR(20) NULL, -- 付款方式
    [Notes] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL, -- 建立者
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 建立時間
    [UpdatedBy] NVARCHAR(50) NULL, -- 更新者
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 更新時間
    CONSTRAINT [FK_SalesOrders_Sites] FOREIGN KEY ([SiteId]) REFERENCES [dbo].[Sites] ([SiteId]),
    CONSTRAINT [FK_SalesOrders_Customers] FOREIGN KEY ([CustomerId]) REFERENCES [dbo].[Customers] ([CustomerId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_SalesOrders_OrderDate] ON [dbo].[SalesOrders] ([OrderDate]);
CREATE NONCLUSTERED INDEX [IX_SalesOrders_SiteId] ON [dbo].[SalesOrders] ([SiteId]);
CREATE NONCLUSTERED INDEX [IX_SalesOrders_CustomerId] ON [dbo].[SalesOrders] ([CustomerId]);
CREATE NONCLUSTERED INDEX [IX_SalesOrders_SalesPersonId] ON [dbo].[SalesOrders] ([SalesPersonId]);
CREATE NONCLUSTERED INDEX [IX_SalesOrders_Status] ON [dbo].[SalesOrders] ([Status]);
```

#### 2.1.2 `SalesOrderDetails` - 銷貨單明細
```sql
CREATE TABLE [dbo].[SalesOrderDetails] (
    [DetailId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [OrderId] NVARCHAR(50) NOT NULL, -- 銷貨單號
    [ProductId] NVARCHAR(50) NOT NULL, -- 商品代碼
    [ProductName] NVARCHAR(200) NULL, -- 商品名稱
    [BigClassId] NVARCHAR(50) NULL, -- 大分類代碼
    [MidClassId] NVARCHAR(50) NULL, -- 中分類代碼
    [SmallClassId] NVARCHAR(50) NULL, -- 小分類代碼
    [VendorId] NVARCHAR(50) NULL, -- 廠商代碼
    [Quantity] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 數量
    [UnitPrice] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 單價
    [Amount] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 金額
    [Cost] DECIMAL(18, 2) NULL DEFAULT 0, -- 成本
    [Profit] DECIMAL(18, 2) NULL DEFAULT 0, -- 毛利
    [ProfitRate] DECIMAL(5, 2) NULL DEFAULT 0, -- 毛利率
    [Unit] NVARCHAR(20) NULL, -- 單位
    [Notes] NVARCHAR(500) NULL, -- 備註
    CONSTRAINT [FK_SalesOrderDetails_SalesOrders] FOREIGN KEY ([OrderId]) REFERENCES [dbo].[SalesOrders] ([OrderId]) ON DELETE CASCADE,
    CONSTRAINT [FK_SalesOrderDetails_Products] FOREIGN KEY ([ProductId]) REFERENCES [dbo].[Products] ([ProductId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_SalesOrderDetails_OrderId] ON [dbo].[SalesOrderDetails] ([OrderId]);
CREATE NONCLUSTERED INDEX [IX_SalesOrderDetails_ProductId] ON [dbo].[SalesOrderDetails] ([ProductId]);
CREATE NONCLUSTERED INDEX [IX_SalesOrderDetails_BigClassId] ON [dbo].[SalesOrderDetails] ([BigClassId]);
CREATE NONCLUSTERED INDEX [IX_SalesOrderDetails_MidClassId] ON [dbo].[SalesOrderDetails] ([MidClassId]);
CREATE NONCLUSTERED INDEX [IX_SalesOrderDetails_SmallClassId] ON [dbo].[SalesOrderDetails] ([SmallClassId]);
CREATE NONCLUSTERED INDEX [IX_SalesOrderDetails_VendorId] ON [dbo].[SalesOrderDetails] ([VendorId]);
```

### 2.2 相關資料表

#### 2.2.1 `Products` - 商品主檔
- 參考: `開發計劃/03-進銷存管理/SYSW110-供應商商品資料維護.md` 的 `Products` 資料表結構

#### 2.2.2 `Sites` - 店別主檔
- 參考: `開發計劃/02-基本資料管理/04-組織架構/SYSWB60-庫別資料維護作業.md` 的 `Sites` 資料表結構

#### 2.2.3 `Customers` - 客戶主檔
- 參考: `開發計劃/09-客戶管理/CUS5110-客戶基本資料維護.md` 的 `Customers` 資料表結構

#### 2.2.4 `Vendors` - 廠商主檔
- 參考: `開發計劃/02-基本資料管理/05-廠商客戶/SYSB206-廠客基本資料維護作業.md` 的 `Vendors` 資料表結構

### 2.3 資料字典

#### SalesOrders 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| OrderId | NVARCHAR | 50 | NO | - | 銷貨單號 | 主鍵 |
| OrderDate | DATETIME2 | - | NO | - | 銷貨日期 | - |
| SiteId | NVARCHAR | 50 | NO | - | 店別代碼 | 外鍵至Sites |
| CustomerId | NVARCHAR | 50 | YES | - | 客戶代碼 | 外鍵至Customers |
| SalesPersonId | NVARCHAR | 50 | YES | - | 銷售人員代碼 | 外鍵至Users |
| TotalAmount | DECIMAL | 18,2 | NO | 0 | 總金額 | - |
| TotalQuantity | DECIMAL | 18,2 | NO | 0 | 總數量 | - |
| DiscountAmount | DECIMAL | 18,2 | YES | 0 | 折扣金額 | - |
| TaxAmount | DECIMAL | 18,2 | YES | 0 | 稅額 | - |
| NetAmount | DECIMAL | 18,2 | NO | 0 | 淨額 | - |
| Status | NVARCHAR | 10 | NO | '1' | 狀態 | 1:正常, 2:作廢, 3:退貨 |
| PaymentMethod | NVARCHAR | 20 | YES | - | 付款方式 | - |
| Notes | NVARCHAR | 500 | YES | - | 備註 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

#### SalesOrderDetails 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| DetailId | BIGINT | - | NO | IDENTITY(1,1) | 明細ID | 主鍵，自動遞增 |
| OrderId | NVARCHAR | 50 | NO | - | 銷貨單號 | 外鍵至SalesOrders |
| ProductId | NVARCHAR | 50 | NO | - | 商品代碼 | 外鍵至Products |
| ProductName | NVARCHAR | 200 | YES | - | 商品名稱 | - |
| BigClassId | NVARCHAR | 50 | YES | - | 大分類代碼 | - |
| MidClassId | NVARCHAR | 50 | YES | - | 中分類代碼 | - |
| SmallClassId | NVARCHAR | 50 | YES | - | 小分類代碼 | - |
| VendorId | NVARCHAR | 50 | YES | - | 廠商代碼 | 外鍵至Vendors |
| Quantity | DECIMAL | 18,2 | NO | 0 | 數量 | - |
| UnitPrice | DECIMAL | 18,2 | NO | 0 | 單價 | - |
| Amount | DECIMAL | 18,2 | NO | 0 | 金額 | - |
| Cost | DECIMAL | 18,2 | YES | 0 | 成本 | - |
| Profit | DECIMAL | 18,2 | YES | 0 | 毛利 | - |
| ProfitRate | DECIMAL | 5,2 | YES | 0 | 毛利率 | - |
| Unit | NVARCHAR | 20 | YES | - | 單位 | - |
| Notes | NVARCHAR | 500 | YES | - | 備註 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢銷售分析報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis/sales`
- **說明**: 查詢銷售分析報表，支援多種查詢條件和分頁
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "siteId": "",
    "dateFrom": "2024-01-01",
    "dateTo": "2024-12-31",
    "bigClassId": "",
    "midClassId": "",
    "smallClassId": "",
    "productId": "",
    "vendorId": "",
    "salesPersonId": "",
    "customerId": "",
    "reportType": "daily", // daily, monthly, yearly, custom
    "groupBy": "product" // product, category, site, vendor, salesperson
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "productId": "P001",
          "productName": "商品名稱",
          "bigClassId": "BC001",
          "bigClassName": "大分類名稱",
          "midClassId": "MC001",
          "midClassName": "中分類名稱",
          "smallClassId": "SC001",
          "smallClassName": "小分類名稱",
          "vendorId": "V001",
          "vendorName": "廠商名稱",
          "siteId": "S001",
          "siteName": "店別名稱",
          "salesPersonId": "U001",
          "salesPersonName": "銷售人員名稱",
          "totalQuantity": 100.00,
          "totalAmount": 10000.00,
          "totalCost": 8000.00,
          "totalProfit": 2000.00,
          "profitRate": 20.00,
          "orderCount": 50,
          "avgUnitPrice": 100.00,
          "avgQuantity": 2.00
        }
      ],
      "summary": {
        "totalQuantity": 1000.00,
        "totalAmount": 100000.00,
        "totalCost": 80000.00,
        "totalProfit": 20000.00,
        "avgProfitRate": 20.00,
        "totalOrderCount": 500
      },
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出銷售分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis/sales/export`
- **說明**: 匯出銷售分析報表（Excel、PDF）
- **請求格式**: 同查詢參數，加上 `exportFormat` (excel, pdf)
- **回應格式**: 檔案下載

#### 3.1.3 列印銷售分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis/sales/print`
- **說明**: 列印銷售分析報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

---

## 四、前端 UI 設計

### 4.1 查詢頁面 (`SalesAnalysisQuery.vue`)

#### 4.1.1 頁面結構
```vue
<template>
  <div class="sales-analysis-query">
    <el-card>
      <template #header>
        <span>銷售分析報表 - 查詢</span>
      </template>
      
      <el-form :model="queryForm" ref="queryFormRef" label-width="150px" inline>
        <!-- 店別 -->
        <el-form-item label="店別">
          <el-select 
            v-model="queryForm.siteId" 
            placeholder="請選擇店別"
            clearable
            filterable
            style="width: 200px"
          >
            <el-option
              v-for="item in siteOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <!-- 日期範圍 -->
        <el-form-item label="日期範圍">
          <el-date-picker
            v-model="dateRange"
            type="daterange"
            range-separator="至"
            start-placeholder="開始日期"
            end-placeholder="結束日期"
            format="YYYY-MM-DD"
            value-format="YYYY-MM-DD"
            style="width: 300px"
          />
        </el-form-item>
        
        <!-- 商品分類 -->
        <el-form-item label="大分類">
          <el-select 
            v-model="queryForm.bigClassId" 
            placeholder="請選擇大分類"
            clearable
            filterable
            style="width: 200px"
          >
            <el-option
              v-for="item in bigClassOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <el-form-item label="中分類">
          <el-select 
            v-model="queryForm.midClassId" 
            placeholder="請選擇中分類"
            clearable
            filterable
            :disabled="!queryForm.bigClassId"
            style="width: 200px"
          >
            <el-option
              v-for="item in midClassOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <el-form-item label="小分類">
          <el-select 
            v-model="queryForm.smallClassId" 
            placeholder="請選擇小分類"
            clearable
            filterable
            :disabled="!queryForm.midClassId"
            style="width: 200px"
          >
            <el-option
              v-for="item in smallClassOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <!-- 商品代碼 -->
        <el-form-item label="商品代碼">
          <el-input 
            v-model="queryForm.productId" 
            placeholder="請輸入商品代碼"
            clearable
            style="width: 200px"
          />
        </el-form-item>
        
        <!-- 廠商 -->
        <el-form-item label="廠商">
          <el-select 
            v-model="queryForm.vendorId" 
            placeholder="請選擇廠商"
            clearable
            filterable
            style="width: 200px"
          >
            <el-option
              v-for="item in vendorOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <!-- 銷售人員 -->
        <el-form-item label="銷售人員">
          <el-select 
            v-model="queryForm.salesPersonId" 
            placeholder="請選擇銷售人員"
            clearable
            filterable
            style="width: 200px"
          >
            <el-option
              v-for="item in salesPersonOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <!-- 報表類型 -->
        <el-form-item label="報表類型">
          <el-select 
            v-model="queryForm.reportType" 
            placeholder="請選擇報表類型"
            style="width: 200px"
          >
            <el-option label="日報" value="daily" />
            <el-option label="月報" value="monthly" />
            <el-option label="年報" value="yearly" />
            <el-option label="自訂期間" value="custom" />
          </el-select>
        </el-form-item>
        
        <!-- 群組方式 -->
        <el-form-item label="群組方式">
          <el-select 
            v-model="queryForm.groupBy" 
            placeholder="請選擇群組方式"
            style="width: 200px"
          >
            <el-option label="商品" value="product" />
            <el-option label="分類" value="category" />
            <el-option label="店別" value="site" />
            <el-option label="廠商" value="vendor" />
            <el-option label="銷售人員" value="salesperson" />
          </el-select>
        </el-form-item>
        
        <!-- 查詢按鈕 -->
        <el-form-item>
          <el-button type="primary" icon="Search" @click="handleSearch">查詢</el-button>
          <el-button icon="Refresh" @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 查詢結果 -->
    <el-card v-if="searchResult.length > 0" style="margin-top: 20px">
      <template #header>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <span>查詢結果 (共 {{ totalCount }} 筆)</span>
          <div>
            <el-button type="success" icon="Download" @click="handleExport">匯出</el-button>
            <el-button type="warning" icon="Printer" @click="handlePrint">列印</el-button>
          </div>
        </div>
      </template>
      
      <!-- 彙總資訊 -->
      <el-card v-if="summary" style="margin-bottom: 20px">
        <el-row :gutter="20">
          <el-col :span="6">
            <el-statistic title="總數量" :value="summary.totalQuantity" />
          </el-col>
          <el-col :span="6">
            <el-statistic title="總金額" :value="summary.totalAmount" :precision="2" prefix="NT$" />
          </el-col>
          <el-col :span="6">
            <el-statistic title="總成本" :value="summary.totalCost" :precision="2" prefix="NT$" />
          </el-col>
          <el-col :span="6">
            <el-statistic title="總毛利" :value="summary.totalProfit" :precision="2" prefix="NT$" />
          </el-col>
        </el-row>
        <el-row :gutter="20" style="margin-top: 20px">
          <el-col :span="6">
            <el-statistic title="平均毛利率" :value="summary.avgProfitRate" :precision="2" suffix="%" />
          </el-col>
          <el-col :span="6">
            <el-statistic title="總筆數" :value="summary.totalOrderCount" />
          </el-col>
        </el-row>
      </el-card>
      
      <el-table 
        :data="searchResult" 
        border 
        stripe 
        style="width: 100%"
        v-loading="loading"
      >
        <el-table-column type="index" label="序號" width="60" align="center" />
        <el-table-column prop="productId" label="商品代碼" width="120" sortable />
        <el-table-column prop="productName" label="商品名稱" width="200" sortable />
        <el-table-column prop="bigClassName" label="大分類" width="120" />
        <el-table-column prop="midClassName" label="中分類" width="120" />
        <el-table-column prop="smallClassName" label="小分類" width="120" />
        <el-table-column prop="vendorName" label="廠商" width="150" />
        <el-table-column prop="siteName" label="店別" width="120" />
        <el-table-column prop="salesPersonName" label="銷售人員" width="120" />
        <el-table-column prop="totalQuantity" label="總數量" width="100" align="right" sortable>
          <template #default="scope">
            {{ formatNumber(scope.row.totalQuantity) }}
          </template>
        </el-table-column>
        <el-table-column prop="totalAmount" label="總金額" width="120" align="right" sortable>
          <template #default="scope">
            {{ formatCurrency(scope.row.totalAmount) }}
          </template>
        </el-table-column>
        <el-table-column prop="totalCost" label="總成本" width="120" align="right" sortable>
          <template #default="scope">
            {{ formatCurrency(scope.row.totalCost) }}
          </template>
        </el-table-column>
        <el-table-column prop="totalProfit" label="總毛利" width="120" align="right" sortable>
          <template #default="scope">
            {{ formatCurrency(scope.row.totalProfit) }}
          </template>
        </el-table-column>
        <el-table-column prop="profitRate" label="毛利率" width="100" align="right" sortable>
          <template #default="scope">
            <el-tag :type="scope.row.profitRate >= 20 ? 'success' : scope.row.profitRate >= 10 ? 'warning' : 'danger'">
              {{ formatNumber(scope.row.profitRate) }}%
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="orderCount" label="筆數" width="80" align="right" sortable />
        <el-table-column prop="avgUnitPrice" label="平均單價" width="120" align="right" sortable>
          <template #default="scope">
            {{ formatCurrency(scope.row.avgUnitPrice) }}
          </template>
        </el-table-column>
        <el-table-column prop="avgQuantity" label="平均數量" width="100" align="right" sortable>
          <template #default="scope">
            {{ formatNumber(scope.row.avgQuantity) }}
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分頁 -->
      <el-pagination
        v-model:current-page="pagination.pageIndex"
        v-model:page-size="pagination.pageSize"
        :total="pagination.totalCount"
        :page-sizes="[10, 20, 50, 100]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleSizeChange"
        @current-change="handlePageChange"
        style="margin-top: 20px; justify-content: flex-end"
      />
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { salesAnalysisApi } from '@/api/analysis.api'
import type { SalesAnalysisQuery, SalesAnalysisResult, SalesAnalysisSummary } from '@/types/analysis.d'

// 表單資料
const queryForm = reactive<SalesAnalysisQuery>({
  pageIndex: 1,
  pageSize: 20,
  siteId: '',
  dateFrom: '',
  dateTo: '',
  bigClassId: '',
  midClassId: '',
  smallClassId: '',
  productId: '',
  vendorId: '',
  salesPersonId: '',
  customerId: '',
  reportType: 'custom',
  groupBy: 'product'
})

const dateRange = ref<[string, string]>(['', ''])

// 選項資料
const siteOptions = ref<Array<{ value: string; label: string }>>([])
const bigClassOptions = ref<Array<{ value: string; label: string }>>([])
const midClassOptions = ref<Array<{ value: string; label: string }>>([])
const smallClassOptions = ref<Array<{ value: string; label: string }>>([])
const vendorOptions = ref<Array<{ value: string; label: string }>>([])
const salesPersonOptions = ref<Array<{ value: string; label: string }>>([])

// 查詢結果
const searchResult = ref<SalesAnalysisResult[]>([])
const summary = ref<SalesAnalysisSummary | null>(null)
const loading = ref(false)
const totalCount = ref(0)

// 分頁
const pagination = reactive({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
})

// 查詢
const handleSearch = async () => {
  if (dateRange.value && dateRange.value.length === 2) {
    queryForm.dateFrom = dateRange.value[0]
    queryForm.dateTo = dateRange.value[1]
  }
  
  loading.value = true
  try {
    const response = await salesAnalysisApi.query(queryForm)
    if (response.success) {
      searchResult.value = response.data.items
      summary.value = response.data.summary
      pagination.totalCount = response.data.totalCount
      pagination.pageIndex = response.data.pageIndex
      pagination.pageSize = response.data.pageSize
      totalCount.value = response.data.totalCount
    } else {
      ElMessage.error(response.message || '查詢失敗')
    }
  } catch (error) {
    ElMessage.error('查詢失敗')
    console.error(error)
  } finally {
    loading.value = false
  }
}

// 重置
const handleReset = () => {
  Object.assign(queryForm, {
    pageIndex: 1,
    pageSize: 20,
    siteId: '',
    dateFrom: '',
    dateTo: '',
    bigClassId: '',
    midClassId: '',
    smallClassId: '',
    productId: '',
    vendorId: '',
    salesPersonId: '',
    customerId: '',
    reportType: 'custom',
    groupBy: 'product'
  })
  dateRange.value = ['', '']
  searchResult.value = []
  summary.value = null
  totalCount.value = 0
}

// 匯出
const handleExport = async () => {
  try {
    await salesAnalysisApi.export({
      ...queryForm,
      exportFormat: 'excel'
    })
    ElMessage.success('匯出成功')
  } catch (error) {
    ElMessage.error('匯出失敗')
    console.error(error)
  }
}

// 列印
const handlePrint = async () => {
  try {
    await salesAnalysisApi.print(queryForm)
    ElMessage.success('列印成功')
  } catch (error) {
    ElMessage.error('列印失敗')
    console.error(error)
  }
}

// 分頁變更
const handleSizeChange = (size: number) => {
  pagination.pageSize = size
  queryForm.pageSize = size
  handleSearch()
}

const handlePageChange = (page: number) => {
  pagination.pageIndex = page
  queryForm.pageIndex = page
  handleSearch()
}

// 格式化
const formatNumber = (value: number) => {
  return new Intl.NumberFormat('zh-TW', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value)
}

const formatCurrency = (value: number) => {
  return new Intl.NumberFormat('zh-TW', {
    style: 'currency',
    currency: 'TWD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(value)
}

// 初始化
onMounted(async () => {
  // 載入選項資料
  // TODO: 載入店別、分類、廠商、銷售人員等選項
})
</script>

<style scoped>
.sales-analysis-query {
  padding: 20px;
}
</style>
```

---

## 五、開發任務清單

### 5.1 後端開發
- [ ] 建立 `SalesOrders` 和 `SalesOrderDetails` 資料表
- [ ] 建立 Entity 類別 (`SalesOrder`, `SalesOrderDetail`)
- [ ] 建立 Repository 介面和實作 (`ISalesOrderRepository`, `SalesOrderRepository`)
- [ ] 建立 Service 介面和實作 (`ISalesAnalysisService`, `SalesAnalysisService`)
- [ ] 建立 DTO 類別 (`SalesAnalysisQueryDto`, `SalesAnalysisResultDto`, `SalesAnalysisSummaryDto`)
- [ ] 建立 Controller (`SalesAnalysisController`)
- [ ] 實作查詢 API (`GET /api/v1/analysis/sales`)
- [ ] 實作匯出 API (`POST /api/v1/analysis/sales/export`)
- [ ] 實作列印 API (`POST /api/v1/analysis/sales/print`)
- [ ] 實作查詢邏輯（支援多種查詢條件和群組方式）
- [ ] 實作彙總計算邏輯
- [ ] 實作 Excel 匯出功能
- [ ] 實作 PDF 列印功能
- [ ] 單元測試
- [ ] 整合測試

### 5.2 前端開發
- [ ] 建立 `SalesAnalysisQuery.vue` 頁面
- [ ] 建立 `analysis.api.ts` API 呼叫
- [ ] 建立 `analysis.d.ts` TypeScript 類型定義
- [ ] 實作查詢表單
- [ ] 實作查詢結果表格
- [ ] 實作彙總資訊顯示
- [ ] 實作匯出功能
- [ ] 實作列印功能
- [ ] 實作分頁功能
- [ ] 實作選項資料載入
- [ ] 實作日期範圍選擇
- [ ] 實作分類階層選擇（大分類→中分類→小分類）
- [ ] 元件測試
- [ ] E2E 測試

### 5.3 測試
- [ ] 單元測試（後端）
- [ ] 單元測試（前端）
- [ ] 整合測試
- [ ] API 測試
- [ ] 元件測試
- [ ] E2E 測試
- [ ] 效能測試
- [ ] 安全性測試

---

## 六、測試計劃

### 6.1 功能測試
- 測試各種查詢條件組合
- 測試分頁功能
- 測試匯出功能（Excel、PDF）
- 測試列印功能
- 測試彙總計算正確性
- 測試分類階層選擇

### 6.2 效能測試
- 測試大量資料查詢效能
- 測試報表匯出效能
- 測試報表列印效能

### 6.3 安全性測試
- 測試 SQL 注入防護
- 測試 XSS 防護
- 測試權限控制

---

## 七、部署說明

### 7.1 資料庫部署
- 執行資料表建立腳本
- 建立索引
- 建立外鍵約束

### 7.2 後端部署
- 部署 API 服務
- 設定連線字串
- 設定快取設定

### 7.3 前端部署
- 建置前端專案
- 部署靜態檔案
- 設定 API 端點

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

