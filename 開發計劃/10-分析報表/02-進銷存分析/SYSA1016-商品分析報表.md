# SYSA1016 - 商品分析報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1016
- **功能名稱**: 商品分析報表
- **功能描述**: 提供商品分析報表的查詢功能，支援依組織、店別、年月、篩選類型等條件查詢商品庫存資訊，包含商品名稱、單位、數量、安全庫存量等資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1016.ascx` (查詢頁面)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1016.ascx.cs` (後端邏輯)
  - `WEB/IMS_CORE/SYSA000/js/SYSA1016.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1016.rdlc` (報表定義)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1000.aspx` (報表展示頁面)

### 1.2 業務需求
- 支援依組織查詢
- 支援依店別查詢
- 支援依年月查詢
- 支援依篩選類型查詢（全部、低於安全庫存量等）
- 支援報表列印與匯出
- 顯示商品庫存資訊（商品名稱、單位、數量、安全庫存量等）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `Goods` - 商品主檔 (對應舊系統 `IMS_AM.NAM_GOODS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `Goods` 資料表結構

#### 2.1.2 `InventoryStocks` - 庫存資料表 (對應舊系統 `IMS_AM.NAM_AM_STOCKS`)
- 參考: `開發計劃/10-分析報表/02-進銷存分析/SYSA1000-進銷存分析報表.md` 的 `InventoryStocks` 資料表結構

#### 2.1.3 `Sites` - 店別主檔
- 參考: `開發計劃/02-基本資料管理/04-組織架構/SYSWB60-庫別資料維護作業.md` 的 `Sites` 資料表結構

#### 2.1.4 `Organizations` - 組織主檔
- 參考: `開發計劃/02-基本資料管理/04-組織架構/SYSWB40-部別資料維護作業.md` 的 `Organizations` 資料表結構

### 2.2 報表資料結構

#### 2.2.1 報表資料集結構
```sql
-- 報表查詢結果結構
SELECT 
    SITE_ID,
    SITE_NAME,
    REPORT_NAME,
    SEQ_NO,
    B_ID,
    M_ID,
    S_ID,
    GOODS_ID,
    GOODS_NAME,
    PACK_UNIT,
    UNIT,
    QTY,
    SAFE_QTY,
    SELECT_TYPE,
    YEAR_MONTH
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作）
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢商品分析報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1016`
- **說明**: 查詢商品分析報表資料
- **請求參數**:
  ```json
  {
    "orgId": "",
    "siteId": "",
    "yearMonth": "",
    "filterType": "", // 篩選類型 (全部、低於安全庫存量等)
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "店別名稱",
          "reportName": "商品分析報表",
          "seqNo": 1,
          "bId": "B001",
          "mId": "M001",
          "sId": "S001",
          "goodsId": "G001",
          "goodsName": "商品名稱",
          "packUnit": "箱",
          "unit": "個",
          "qty": 100,
          "safeQty": 50,
          "selectType": "全部",
          "yearMonth": "202401"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1016/export`
- **說明**: 匯出商品分析報表為 Excel
- **請求格式**: 同查詢參數
- **回應格式**: Excel 檔案 (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)

#### 3.1.3 列印商品分析報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1016/print`
- **說明**: 產生報表列印資料
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案 (application/pdf)

---

## 四、前端 UI 設計

### 4.1 查詢頁面 (`SYSA1016Query.vue`)

#### 4.1.1 頁面結構
```vue
<template>
  <div class="sysa1016-query">
    <el-card>
      <template #header>
        <span>商品分析報表 - 查詢</span>
      </template>
      
      <el-form :model="queryForm" ref="queryFormRef" label-width="150px" inline>
        <!-- 組織 -->
        <el-form-item label="組織">
          <el-select 
            v-model="queryForm.orgId" 
            placeholder="請選擇組織"
            clearable
            style="width: 200px"
          >
            <el-option
              v-for="item in orgOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <!-- 店別 -->
        <el-form-item label="店別">
          <el-select 
            v-model="queryForm.siteId" 
            placeholder="請選擇店別"
            clearable
            style="width: 200px"
          >
            <el-option
              v-for="item in siteOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <!-- 年月 -->
        <el-form-item label="年月">
          <el-date-picker
            v-model="queryForm.yearMonth"
            type="month"
            placeholder="請選擇年月"
            format="YYYY-MM"
            value-format="YYYYMM"
            style="width: 200px"
          />
        </el-form-item>
        
        <!-- 篩選類型 -->
        <el-form-item label="篩選類型">
          <el-radio-group v-model="queryForm.filterType">
            <el-radio label="">全部</el-radio>
            <el-radio label="1">低於安全庫存量</el-radio>
          </el-radio-group>
        </el-form-item>
        
        <!-- 查詢按鈕 -->
        <el-form-item>
          <el-button type="primary" icon="Search" @click="handleSearch">查詢</el-button>
          <el-button icon="Refresh" @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 查詢結果 -->
    <el-card v-if="searchResult.length > 0" style="margin-top: 20px">
      <template #header>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <span>查詢結果 (共 {{ totalCount }} 筆)</span>
          <div>
            <el-button type="success" icon="Printer" @click="handlePrint">列印</el-button>
            <el-button type="warning" icon="Download" @click="handleExport">匯出</el-button>
          </div>
        </div>
      </template>
      
      <el-table 
        :data="searchResult" 
        border 
        stripe 
        style="width: 100%"
      >
        <el-table-column type="index" label="序號" width="60" align="center" />
        <el-table-column prop="siteName" label="店別" width="120" />
        <el-table-column prop="goodsId" label="商品代碼" width="120" />
        <el-table-column prop="goodsName" label="商品名稱" width="200" />
        <el-table-column prop="packUnit" label="包裝單位" width="100" align="center" />
        <el-table-column prop="unit" label="單位" width="80" align="center" />
        <el-table-column prop="qty" label="數量" width="100" align="right" />
        <el-table-column prop="safeQty" label="安全庫存量" width="120" align="right" />
        <el-table-column prop="selectType" label="篩選類型" width="120" />
        <el-table-column prop="yearMonth" label="年月" width="100" align="center" />
      </el-table>
      
      <!-- 分頁 -->
      <el-pagination
        v-model:current-page="pagination.pageIndex"
        v-model:page-size="pagination.pageSize"
        :total="pagination.totalCount"
        :page-sizes="[10, 20, 50, 100]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleSizeChange"
        @current-change="handlePageChange"
        style="margin-top: 20px; justify-content: flex-end"
      />
    </el-card>
  </div>
</template>
```

#### 4.1.2 腳本邏輯
```typescript
<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { analysisReportApi } from '@/api/analysis-report'

// 表單資料
const queryForm = reactive({
  orgId: '',
  siteId: '',
  yearMonth: '',
  filterType: ''
})

// 查詢結果
const searchResult = ref([])
const totalCount = ref(0)
const pagination = reactive({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
})

// 選項資料
const orgOptions = ref([])
const siteOptions = ref([])

// 查詢
const handleSearch = async () => {
  try {
    const response = await analysisReportApi.getSysa1016({
      orgId: queryForm.orgId || undefined,
      siteId: queryForm.siteId || undefined,
      yearMonth: queryForm.yearMonth || undefined,
      filterType: queryForm.filterType || undefined,
      pageIndex: pagination.pageIndex,
      pageSize: pagination.pageSize
    })
    
    if (response.success) {
      searchResult.value = response.data.items
      pagination.totalCount = response.data.totalCount
      totalCount.value = response.data.totalCount
    } else {
      ElMessage.error(response.message || '查詢失敗')
    }
  } catch (error) {
    ElMessage.error('查詢失敗：' + error.message)
  }
}

// 重置
const handleReset = () => {
  queryForm.orgId = ''
  queryForm.siteId = ''
  queryForm.yearMonth = ''
  queryForm.filterType = ''
  searchResult.value = []
  pagination.pageIndex = 1
  pagination.totalCount = 0
  totalCount.value = 0
}

// 列印
const handlePrint = async () => {
  try {
    const response = await analysisReportApi.printSysa1016({
      orgId: queryForm.orgId || undefined,
      siteId: queryForm.siteId || undefined,
      yearMonth: queryForm.yearMonth || undefined,
      filterType: queryForm.filterType || undefined
    })
    
    if (response.success) {
      // 開啟列印視窗
      const blob = new Blob([response.data], { type: 'application/pdf' })
      const url = window.URL.createObjectURL(blob)
      window.open(url, '_blank')
    } else {
      ElMessage.error(response.message || '列印失敗')
    }
  } catch (error) {
    ElMessage.error('列印失敗：' + error.message)
  }
}

// 匯出
const handleExport = async () => {
  try {
    const response = await analysisReportApi.exportSysa1016({
      orgId: queryForm.orgId || undefined,
      siteId: queryForm.siteId || undefined,
      yearMonth: queryForm.yearMonth || undefined,
      filterType: queryForm.filterType || undefined
    })
    
    if (response.success) {
      // 下載 Excel
      const blob = new Blob([response.data], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
      const url = window.URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = `商品分析報表_${new Date().getTime()}.xlsx`
      link.click()
      ElMessage.success('匯出成功')
    } else {
      ElMessage.error(response.message || '匯出失敗')
    }
  } catch (error) {
    ElMessage.error('匯出失敗：' + error.message)
  }
}

// 分頁變更
const handleSizeChange = (size: number) => {
  pagination.pageSize = size
  pagination.pageIndex = 1
  handleSearch()
}

const handlePageChange = (page: number) => {
  pagination.pageIndex = page
  handleSearch()
}

// 初始化
onMounted(async () => {
  // 載入組織選項
  try {
    const orgResponse = await analysisReportApi.getOrganizations()
    if (orgResponse.success) {
      orgOptions.value = orgResponse.data
    }
  } catch (error) {
    ElMessage.error('載入組織選項失敗：' + error.message)
  }
  
  // 載入店別選項
  try {
    const siteResponse = await analysisReportApi.getSites()
    if (siteResponse.success) {
      siteOptions.value = siteResponse.data
    }
  } catch (error) {
    ElMessage.error('載入店別選項失敗：' + error.message)
  }
})
</script>
```

---

## 五、後端實作

### 5.1 Controller (`AnalysisReportController.cs`)

```csharp
[ApiController]
[Route("api/v1/analysis-reports")]
[Authorize]
public class AnalysisReportController : ControllerBase
{
    private readonly IAnalysisReportService _analysisReportService;
    private readonly ILogger<AnalysisReportController> _logger;

    public AnalysisReportController(
        IAnalysisReportService analysisReportService,
        ILogger<AnalysisReportController> logger)
    {
        _analysisReportService = analysisReportService;
        _logger = logger;
    }

    /// <summary>
    /// 查詢商品分析報表 (SYSA1016)
    /// </summary>
    [HttpGet("sysa1016")]
    public async Task<ActionResult<ApiResponse<PagedResult<Sysa1016ReportDto>>>> GetSysa1016(
        [FromQuery] Sysa1016QueryDto query)
    {
        try
        {
            var result = await _analysisReportService.GetSysa1016Async(query);
            return Ok(ApiResponse<PagedResult<Sysa1016ReportDto>>.Success(result));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "查詢商品分析報表失敗");
            return BadRequest(ApiResponse<PagedResult<Sysa1016ReportDto>>.Error("查詢失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 匯出商品分析報表 (SYSA1016)
    /// </summary>
    [HttpPost("sysa1016/export")]
    public async Task<ActionResult> ExportSysa1016([FromBody] Sysa1016QueryDto query)
    {
        try
        {
            var result = await _analysisReportService.ExportSysa1016Async(query);
            return File(result, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", 
                $"商品分析報表_{DateTime.Now:yyyyMMddHHmmss}.xlsx");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "匯出商品分析報表失敗");
            return BadRequest(ApiResponse<object>.Error("匯出失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 列印商品分析報表 (SYSA1016)
    /// </summary>
    [HttpPost("sysa1016/print")]
    public async Task<ActionResult> PrintSysa1016([FromBody] Sysa1016QueryDto query)
    {
        try
        {
            var result = await _analysisReportService.PrintSysa1016Async(query);
            return File(result, "application/pdf", 
                $"商品分析報表_{DateTime.Now:yyyyMMddHHmmss}.pdf");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "列印商品分析報表失敗");
            return BadRequest(ApiResponse<object>.Error("列印失敗：" + ex.Message));
        }
    }
}
```

### 5.2 Service (`AnalysisReportService.cs`)

```csharp
public class AnalysisReportService : IAnalysisReportService
{
    private readonly IDbConnection _db;
    private readonly ILogger<AnalysisReportService> _logger;
    private readonly IExcelService _excelService;
    private readonly IPdfService _pdfService;

    public AnalysisReportService(
        IDbConnection db,
        ILogger<AnalysisReportService> logger,
        IExcelService excelService,
        IPdfService pdfService)
    {
        _db = db;
        _logger = logger;
        _excelService = excelService;
        _pdfService = pdfService;
    }

    public async Task<PagedResult<Sysa1016ReportDto>> GetSysa1016Async(Sysa1016QueryDto query)
    {
        var sql = @"
            SELECT 
                s.SiteId AS SiteId,
                s.SiteName AS SiteName,
                '商品分析報表' AS ReportName,
                ROW_NUMBER() OVER (ORDER BY s.SiteId, g.GoodsId) AS SeqNo,
                g.BId AS BId,
                g.MId AS MId,
                g.SId AS SId,
                g.GoodsId AS GoodsId,
                g.GoodsName AS GoodsName,
                g.PackUnit AS PackUnit,
                g.Unit AS Unit,
                ISNULL(st.Qty, 0) AS Qty,
                ISNULL(g.SafeQty, 0) AS SafeQty,
                @FilterType AS SelectType,
                @YearMonth AS YearMonth
            FROM Goods g
            LEFT JOIN InventoryStocks st ON st.GoodsId = g.GoodsId 
                AND st.SiteId = @SiteId
                AND st.YearMonth = @YearMonth
            LEFT JOIN Sites s ON s.SiteId = @SiteId
            WHERE 1 = 1
                AND (@OrgId IS NULL OR s.OrgId = @OrgId)
                AND (@SiteId IS NULL OR s.SiteId = @SiteId)
                AND (@FilterType IS NULL OR @FilterType = '' OR 
                    (@FilterType = '1' AND ISNULL(st.Qty, 0) < ISNULL(g.SafeQty, 0)))
            ORDER BY s.SiteId, g.GoodsId
            OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
            
            SELECT COUNT(*) AS TotalCount
            FROM Goods g
            LEFT JOIN InventoryStocks st ON st.GoodsId = g.GoodsId 
                AND st.SiteId = @SiteId
                AND st.YearMonth = @YearMonth
            LEFT JOIN Sites s ON s.SiteId = @SiteId
            WHERE 1 = 1
                AND (@OrgId IS NULL OR s.OrgId = @OrgId)
                AND (@SiteId IS NULL OR s.SiteId = @SiteId)
                AND (@FilterType IS NULL OR @FilterType = '' OR 
                    (@FilterType = '1' AND ISNULL(st.Qty, 0) < ISNULL(g.SafeQty, 0)));
        ";

        var parameters = new
        {
            OrgId = string.IsNullOrEmpty(query.OrgId) ? (string?)null : query.OrgId,
            SiteId = string.IsNullOrEmpty(query.SiteId) ? (string?)null : query.SiteId,
            YearMonth = string.IsNullOrEmpty(query.YearMonth) ? (string?)null : query.YearMonth,
            FilterType = string.IsNullOrEmpty(query.FilterType) ? (string?)null : query.FilterType,
            Offset = (query.PageIndex - 1) * query.PageSize,
            PageSize = query.PageSize
        };

        using var multi = await _db.QueryMultipleAsync(sql, parameters);
        var items = (await multi.ReadAsync<Sysa1016ReportDto>()).ToList();
        var totalCount = await multi.ReadSingleAsync<int>();

        return new PagedResult<Sysa1016ReportDto>
        {
            Items = items,
            TotalCount = totalCount,
            PageIndex = query.PageIndex,
            PageSize = query.PageSize,
            TotalPages = (int)Math.Ceiling(totalCount / (double)query.PageSize)
        };
    }

    public async Task<byte[]> ExportSysa1016Async(Sysa1016QueryDto query)
    {
        var data = await GetSysa1016AllAsync(query);
        return await _excelService.ExportToExcelAsync(data, "商品分析報表");
    }

    public async Task<byte[]> PrintSysa1016Async(Sysa1016QueryDto query)
    {
        var data = await GetSysa1016AllAsync(query);
        return await _pdfService.GeneratePdfAsync(data, "SYSA1016.rdlc");
    }

    private async Task<List<Sysa1016ReportDto>> GetSysa1016AllAsync(Sysa1016QueryDto query)
    {
        // 取得所有資料（不分頁）
        var sql = @"
            SELECT 
                s.SiteId AS SiteId,
                s.SiteName AS SiteName,
                '商品分析報表' AS ReportName,
                ROW_NUMBER() OVER (ORDER BY s.SiteId, g.GoodsId) AS SeqNo,
                g.BId AS BId,
                g.MId AS MId,
                g.SId AS SId,
                g.GoodsId AS GoodsId,
                g.GoodsName AS GoodsName,
                g.PackUnit AS PackUnit,
                g.Unit AS Unit,
                ISNULL(st.Qty, 0) AS Qty,
                ISNULL(g.SafeQty, 0) AS SafeQty,
                @FilterType AS SelectType,
                @YearMonth AS YearMonth
            FROM Goods g
            LEFT JOIN InventoryStocks st ON st.GoodsId = g.GoodsId 
                AND st.SiteId = @SiteId
                AND st.YearMonth = @YearMonth
            LEFT JOIN Sites s ON s.SiteId = @SiteId
            WHERE 1 = 1
                AND (@OrgId IS NULL OR s.OrgId = @OrgId)
                AND (@SiteId IS NULL OR s.SiteId = @SiteId)
                AND (@FilterType IS NULL OR @FilterType = '' OR 
                    (@FilterType = '1' AND ISNULL(st.Qty, 0) < ISNULL(g.SafeQty, 0)))
            ORDER BY s.SiteId, g.GoodsId;
        ";

        var parameters = new
        {
            OrgId = string.IsNullOrEmpty(query.OrgId) ? (string?)null : query.OrgId,
            SiteId = string.IsNullOrEmpty(query.SiteId) ? (string?)null : query.SiteId,
            YearMonth = string.IsNullOrEmpty(query.YearMonth) ? (string?)null : query.YearMonth,
            FilterType = string.IsNullOrEmpty(query.FilterType) ? (string?)null : query.FilterType
        };

        return (await _db.QueryAsync<Sysa1016ReportDto>(sql, parameters)).ToList();
    }
}
```

### 5.3 DTO 定義

```csharp
// 查詢條件 DTO
public class Sysa1016QueryDto
{
    public string? OrgId { get; set; }
    public string? SiteId { get; set; }
    public string? YearMonth { get; set; }
    public string? FilterType { get; set; }
    public int PageIndex { get; set; } = 1;
    public int PageSize { get; set; } = 20;
}

// 報表資料 DTO
public class Sysa1016ReportDto
{
    public string SiteId { get; set; }
    public string SiteName { get; set; }
    public string ReportName { get; set; }
    public int SeqNo { get; set; }
    public string? BId { get; set; }
    public string? MId { get; set; }
    public string? SId { get; set; }
    public string GoodsId { get; set; }
    public string GoodsName { get; set; }
    public string? PackUnit { get; set; }
    public string? Unit { get; set; }
    public decimal Qty { get; set; }
    public decimal SafeQty { get; set; }
    public string? SelectType { get; set; }
    public string? YearMonth { get; set; }
}
```

---

## 六、開發時程

### 6.1 開發階段
1. **資料庫設計** (0.5 天)
   - 確認相關資料表結構
   - 建立必要索引

2. **後端 API 開發** (2 天)
   - 實作 Service 層
   - 實作 Controller 層
   - 實作 DTO 定義
   - 單元測試

3. **前端 UI 開發** (2 天)
   - 查詢頁面
   - 報表展示
   - 列印功能
   - 匯出功能
   - 整合測試

4. **測試與優化** (0.5 天)
   - 功能測試
   - 效能測試
   - Bug 修復

**總計**: 5 天

---

## 七、注意事項

### 7.1 資料驗證
- 年月格式必須為 YYYYMM
- 組織和店別必須為有效值
- 篩選類型必須為有效值

### 7.2 效能優化
- 使用索引加速查詢
- 大量資料時使用分頁查詢
- 考慮使用 Redis 快取常用查詢結果

### 7.3 報表功能
- 支援 Excel 匯出
- 支援 PDF 列印
- 支援報表範本自訂

---

## 八、測試案例

### 8.1 功能測試
1. **查詢測試**
   - 依組織查詢
   - 依店別查詢
   - 依年月查詢
   - 依篩選類型查詢
   - 組合條件查詢
   - 分頁查詢

2. **匯出測試**
   - Excel 匯出
   - 大量資料匯出

3. **列印測試**
   - PDF 列印
   - 報表格式正確性

### 8.2 效能測試
- 大量資料查詢效能（10萬筆以上）
- 分頁查詢效能
- 匯出效能

### 8.3 安全性測試
- SQL Injection 測試
- 權限驗證測試
- 輸入驗證測試

