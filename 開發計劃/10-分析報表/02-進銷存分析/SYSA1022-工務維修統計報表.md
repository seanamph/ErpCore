# SYSA1022 - 工務維修統計報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYSA1022
- **功能名稱**: 工務維修統計報表
- **功能描述**: 提供工務維修統計報表的查詢功能，支援依報表類型、費用負擔、日期範圍、費用歸屬單位、維保人員、請修類別等條件查詢工務維修統計資訊，支援報表列印與匯出
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYSA000/js/SYSA1022.js` (前端邏輯)
  - `WEB/IMS_CORE/SYSA000/SYSA1022_1.rdlc` (報表定義)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1022.ascx` (查詢頁面)
  - `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1022.ascx.cs` (後端邏輯)

### 1.2 業務需求
- 支援依報表類型查詢
- 支援依費用負擔查詢
- 支援依日期範圍查詢（日統計表起、日統計表迄）
- 支援依費用歸屬單位查詢
- 支援依維保人員查詢
- 支援依請修類別查詢
- 支援報表列印與匯出
- 顯示工務維修統計資訊

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `MaintenanceRequests` - 工務維修申請表
```sql
CREATE TABLE [dbo].[MaintenanceRequests] (
    [RequestId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [ApplyDate] DATETIME2 NOT NULL, -- 申請日期
    [BelongStatus] NVARCHAR(50) NULL, -- 費用負擔
    [BelongOrg] NVARCHAR(50) NULL, -- 費用歸屬單位
    [MaintainEmp] NVARCHAR(50) NULL, -- 維保人員
    [ApplyType] NVARCHAR(50) NULL, -- 請修類別
    [SiteId] NVARCHAR(50) NULL, -- 店別
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1', -- 狀態
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE()
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_MaintenanceRequests_ApplyDate] ON [dbo].[MaintenanceRequests] ([ApplyDate]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRequests_BelongStatus] ON [dbo].[MaintenanceRequests] ([BelongStatus]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRequests_BelongOrg] ON [dbo].[MaintenanceRequests] ([BelongOrg]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRequests_MaintainEmp] ON [dbo].[MaintenanceRequests] ([MaintainEmp]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRequests_ApplyType] ON [dbo].[MaintenanceRequests] ([ApplyType]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRequests_SiteId] ON [dbo].[MaintenanceRequests] ([SiteId]);
```

#### 2.1.2 `MaintenanceRequestDetails` - 工務維修申請明細表
```sql
CREATE TABLE [dbo].[MaintenanceRequestDetails] (
    [DetailId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [RequestId] NVARCHAR(50) NOT NULL,
    [GoodsId] NVARCHAR(50) NULL, -- 商品代碼
    [Qty] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 數量
    [Amount] DECIMAL(18, 2) NOT NULL DEFAULT 0, -- 金額
    [Notes] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_MaintenanceRequestDetails_MaintenanceRequests] FOREIGN KEY ([RequestId]) REFERENCES [dbo].[MaintenanceRequests] ([RequestId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_MaintenanceRequestDetails_RequestId] ON [dbo].[MaintenanceRequestDetails] ([RequestId]);
CREATE NONCLUSTERED INDEX [IX_MaintenanceRequestDetails_GoodsId] ON [dbo].[MaintenanceRequestDetails] ([GoodsId]);
```

### 2.2 報表資料結構

#### 2.2.1 報表資料集結構
```sql
-- 報表查詢結果結構
SELECT 
    site_id,
    SITE_NAME,
    REPORT_NAME,
    belong_status,
    apply_date_b,
    apply_date_e,
    belong_org,
    maintain_emp,
    apply_type,
    request_count,
    total_amount
FROM 
    -- 查詢邏輯（需根據實際業務邏輯實作）
```

### 2.3 資料字典

#### MaintenanceRequests 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| RequestId | NVARCHAR | 50 | NO | - | 申請單號 | 主鍵 |
| ApplyDate | DATETIME2 | - | NO | - | 申請日期 | - |
| BelongStatus | NVARCHAR | 50 | YES | - | 費用負擔 | - |
| BelongOrg | NVARCHAR | 50 | YES | - | 費用歸屬單位 | - |
| MaintainEmp | NVARCHAR | 50 | YES | - | 維保人員 | - |
| ApplyType | NVARCHAR | 50 | YES | - | 請修類別 | - |
| SiteId | NVARCHAR | 50 | YES | - | 店別 | - |
| Status | NVARCHAR | 10 | NO | '1' | 狀態 | 1:啟用, 0:停用 |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢工務維修統計報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/analysis-reports/sysa1022`
- **說明**: 查詢工務維修統計報表資料
- **請求參數**:
  ```json
  {
    "belongStatus": "",
    "applyDateB": "2024-01-01",
    "applyDateE": "2024-12-31",
    "belongOrg": "",
    "maintainEmp": "",
    "applyType": "",
    "siteId": "",
    "pageIndex": 1,
    "pageSize": 20
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "siteId": "SITE001",
          "siteName": "店別名稱",
          "reportName": "工務維修統計報表",
          "belongStatus": "費用負擔",
          "applyDateB": "2024-01-01",
          "applyDateE": "2024-12-31",
          "belongOrg": "費用歸屬單位",
          "maintainEmp": "維保人員",
          "applyType": "請修類別",
          "requestCount": 100,
          "totalAmount": 100000
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出工務維修統計報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1022/export`
- **說明**: 匯出工務維修統計報表（Excel/PDF）
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

#### 3.1.3 列印工務維修統計報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/analysis-reports/sysa1022/print`
- **說明**: 列印工務維修統計報表
- **請求格式**: 同查詢參數
- **回應格式**: PDF 檔案

### 3.2 後端實作類別

#### 3.2.1 Service: `MaintenanceReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IMaintenanceReportService
    {
        Task<PagedResult<MaintenanceReportDto>> GetMaintenanceReportAsync(MaintenanceReportQueryDto query);
        Task<byte[]> ExportMaintenanceReportAsync(MaintenanceReportQueryDto query, string format);
        Task<byte[]> PrintMaintenanceReportAsync(MaintenanceReportQueryDto query);
    }
    
    public class MaintenanceReportService : IMaintenanceReportService
    {
        private readonly IMaintenanceReportRepository _repository;
        
        public async Task<PagedResult<MaintenanceReportDto>> GetMaintenanceReportAsync(MaintenanceReportQueryDto query)
        {
            // 實作查詢邏輯
        }
    }
}
```

#### 3.2.2 Repository: `MaintenanceReportRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public interface IMaintenanceReportRepository
    {
        Task<IEnumerable<MaintenanceReportDto>> GetMaintenanceReportDataAsync(MaintenanceReportQueryDto query);
        Task<int> GetMaintenanceReportCountAsync(MaintenanceReportQueryDto query);
    }
    
    public class MaintenanceReportRepository : IMaintenanceReportRepository
    {
        // 使用 Dapper 實作查詢
    }
}
```

#### 3.2.3 Controller: `MaintenanceReportController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/analysis-reports")]
    public class MaintenanceReportController : ControllerBase
    {
        private readonly IMaintenanceReportService _service;
        
        [HttpGet("sysa1022")]
        public async Task<IActionResult> GetMaintenanceReport([FromQuery] MaintenanceReportQueryDto query)
        {
            // 實作查詢邏輯
        }
        
        [HttpPost("sysa1022/export")]
        public async Task<IActionResult> ExportMaintenanceReport([FromBody] MaintenanceReportQueryDto query, [FromQuery] string format = "excel")
        {
            // 實作匯出邏輯
        }
        
        [HttpPost("sysa1022/print")]
        public async Task<IActionResult> PrintMaintenanceReport([FromBody] MaintenanceReportQueryDto query)
        {
            // 實作列印邏輯
        }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 UI 元件設計

#### 4.1.1 查詢表單 (`MaintenanceReportQuery.vue`)
```vue
<template>
  <div class="maintenance-report-query">
    <el-form :model="queryForm" :rules="rules" ref="queryFormRef" label-width="120px">
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="報表類型" prop="belongStatus">
            <el-select v-model="queryForm.belongStatus" placeholder="請選擇" clearable>
              <el-option label="全部" value="" />
              <el-option label="費用負擔1" value="1" />
              <el-option label="費用負擔2" value="2" />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="費用負擔" prop="belongStatus">
            <el-select v-model="queryForm.belongStatus" placeholder="請選擇" clearable>
              <el-option label="全部" value="" />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="日統計表起" prop="applyDateB">
            <el-date-picker
              v-model="queryForm.applyDateB"
              type="date"
              placeholder="請選擇日期"
              format="YYYY-MM-DD"
              value-format="YYYY-MM-DD"
            />
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="日統計表迄" prop="applyDateE">
            <el-date-picker
              v-model="queryForm.applyDateE"
              type="date"
              placeholder="請選擇日期"
              format="YYYY-MM-DD"
              value-format="YYYY-MM-DD"
            />
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="費用歸屬單位" prop="belongOrg">
            <el-select v-model="queryForm.belongOrg" placeholder="請選擇" clearable filterable>
              <el-option 
                v-for="item in orgList" 
                :key="item.orgId" 
                :label="item.orgName" 
                :value="item.orgId" 
              />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="維保人員" prop="maintainEmp">
            <el-select v-model="queryForm.maintainEmp" placeholder="請選擇" clearable filterable>
              <el-option 
                v-for="item in empList" 
                :key="item.empId" 
                :label="item.empName" 
                :value="item.empId" 
              />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="請修類別" prop="applyType">
            <el-select v-model="queryForm.applyType" placeholder="請選擇" clearable>
              <el-option label="全部" value="" />
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="12">
          <el-form-item label="店別" prop="siteId">
            <el-select v-model="queryForm.siteId" placeholder="請選擇" clearable filterable>
              <el-option 
                v-for="item in siteList" 
                :key="item.siteId" 
                :label="item.siteName" 
                :value="item.siteId" 
              />
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>
      <el-form-item>
        <el-button type="primary" @click="handleQuery">查詢</el-button>
        <el-button @click="handleReset">重置</el-button>
        <el-button type="success" @click="handleExport">匯出</el-button>
        <el-button type="warning" @click="handlePrint">列印</el-button>
      </el-form-item>
    </el-form>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { maintenanceReportApi } from '@/api/analysis.api';

const queryFormRef = ref();
const queryForm = reactive({
  belongStatus: '',
  applyDateB: '',
  applyDateE: '',
  belongOrg: '',
  maintainEmp: '',
  applyType: '',
  siteId: ''
});

const rules = {
  applyDateB: [{ required: true, message: '請選擇日期', trigger: 'change' }],
  applyDateE: [{ required: true, message: '請選擇日期', trigger: 'change' }]
};

const handleQuery = async () => {
  await queryFormRef.value.validate();
  // 查詢邏輯
};

const handleReset = () => {
  queryFormRef.value.resetFields();
};

const handleExport = async () => {
  // 匯出邏輯
};

const handlePrint = async () => {
  // 列印邏輯
};
</script>
```

#### 4.1.2 報表展示頁面 (`MaintenanceReportView.vue`)
```vue
<template>
  <div class="maintenance-report-view">
    <el-table :data="reportData" border stripe>
      <el-table-column prop="siteId" label="店別" width="120" />
      <el-table-column prop="siteName" label="店別名稱" width="150" />
      <el-table-column prop="belongStatus" label="費用負擔" width="120" />
      <el-table-column prop="belongOrg" label="費用歸屬單位" width="150" />
      <el-table-column prop="maintainEmp" label="維保人員" width="120" />
      <el-table-column prop="applyType" label="請修類別" width="120" />
      <el-table-column prop="requestCount" label="申請件數" width="120" align="right" />
      <el-table-column prop="totalAmount" label="總金額" width="120" align="right">
        <template #default="{ row }">
          {{ formatCurrency(row.totalAmount) }}
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue';

const reportData = ref([]);
const pagination = reactive({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
});

const formatCurrency = (value: number) => {
  return new Intl.NumberFormat('zh-TW', {
    style: 'currency',
    currency: 'TWD'
  }).format(value);
};

const handleSizeChange = (size: number) => {
  pagination.pageSize = size;
  loadData();
};

const handlePageChange = (page: number) => {
  pagination.pageIndex = page;
  loadData();
};

const loadData = async () => {
  // 載入資料邏輯
};

onMounted(() => {
  loadData();
});
</script>
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (1天)
- [ ] 建立 MaintenanceRequests 資料表
- [ ] 建立 MaintenanceRequestDetails 資料表
- [ ] 建立索引
- [ ] 建立外鍵約束
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (3天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 查詢邏輯實作
- [ ] 匯出邏輯實作
- [ ] 列印邏輯實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (3天)
- [ ] API 呼叫函數
- [ ] 查詢表單開發
- [ ] 報表展示頁面開發
- [ ] 資料表格開發
- [ ] 表單驗證
- [ ] 匯出功能
- [ ] 列印功能
- [ ] 元件測試

### 5.4 階段四: 整合測試 (1.5天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 安全性測試

### 5.5 階段五: 文件與部署 (0.5天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 9天

---

## 六、注意事項

### 6.1 業務邏輯
- 日期範圍查詢需包含起迄日期
- 費用負擔、費用歸屬單位、維保人員、請修類別等條件可多選或單選
- 報表統計需依查詢條件彙總

### 6.2 效能優化
- 大量資料查詢需使用分頁
- 複雜查詢需建立適當索引
- 報表匯出需使用非同步處理

### 6.3 安全性
- 查詢條件需驗證
- 報表資料需權限控制
- 匯出檔案需安全處理

---

## 七、測試案例

### 7.1 單元測試
- [ ] 查詢工務維修統計報表成功
- [ ] 查詢條件驗證
- [ ] 分頁功能測試
- [ ] 匯出功能測試
- [ ] 列印功能測試

### 7.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 資料驗證測試
- [ ] 錯誤處理測試
- [ ] 效能測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYSA000/js/SYSA1022.js`
- `WEB/IMS_CORE/SYSA000/SYSA1022_1.rdlc`
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1022.ascx`
- `WEB/IMS_CORE/SYSA000/backup/奇怪的程式碼/SYSA1022.ascx.cs`

### 8.2 相關功能
- `SYSA1023-工務維修統計報表(報表類型).md` - 類似功能，但包含報表類型
- `SYSA1024-工務維修統計報表(其他).md` - 類似功能，但查詢條件不同

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

