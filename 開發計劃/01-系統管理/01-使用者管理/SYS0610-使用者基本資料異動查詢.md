# SYS0610 - 使用者基本資料異動查詢 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0610
- **功能名稱**: 使用者基本資料異動查詢
- **功能描述**: 提供使用者基本資料異動記錄的查詢功能，可查詢指定使用者或所有使用者的資料異動歷史記錄
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0610_FQ.asp` (查詢條件頁面)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0610_FB.ASP` (查詢結果頁面)
  - `WEB/IMS_CORE/SYS0000/SYS0610_FB.aspx` (ASP.NET 版本)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0610_FB.aspx` (ASP.NET 版本)

### 1.2 業務需求
- 查詢使用者基本資料的異動記錄
- 支援依異動使用者代碼查詢
- 支援依被異動的使用者代碼查詢
- 支援依日期範圍查詢
- 顯示異動詳細資訊（異動欄位、異動前的值、異動後的值）
- 顯示異動狀態（新增、刪除、修改）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `ChangeLogs` (對應舊系統 `MNG_LOG`)

```sql
CREATE TABLE [dbo].[ChangeLogs] (
    [LogId] BIGINT NOT NULL IDENTITY(1,1) PRIMARY KEY,
    [ProgramId] NVARCHAR(50) NOT NULL, -- 程式代碼 (SYS0110)
    [ChangeUserId] NVARCHAR(50) NULL, -- 異動使用者代碼
    [ChangeDate] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 異動時間
    [ChangeStatus] NVARCHAR(10) NOT NULL, -- 異動狀態: 1=新增, 2=刪除, 3=修改
    [ChangeField] NVARCHAR(500) NULL, -- 異動欄位名稱 (多個欄位以逗號分隔)
    [OldValue] NVARCHAR(MAX) NULL, -- 異動前的值 (多個值以逗號分隔)
    [NewValue] NVARCHAR(MAX) NULL, -- 異動後的值 (多個值以逗號分隔)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_ChangeLogs] PRIMARY KEY CLUSTERED ([LogId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ProgramId] ON [dbo].[ChangeLogs] ([ProgramId]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ChangeUserId] ON [dbo].[ChangeLogs] ([ChangeUserId]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ChangeDate] ON [dbo].[ChangeLogs] ([ChangeDate]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ProgramId_ChangeDate] ON [dbo].[ChangeLogs] ([ProgramId], [ChangeDate] DESC);
```

### 2.2 相關資料表

#### 2.2.1 `Users` - 使用者主檔
- 用於查詢使用者名稱
- 參考: `開發計劃/01-系統管理/01-使用者管理/SYS0110-使用者基本資料維護.md`

---

## 三、API 設計

### 3.1 查詢使用者異動記錄

#### 3.1.1 查詢條件頁面資料
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/change-logs/users/query-form`
- **說明**: 取得查詢條件表單的初始資料
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "defaultBeginDate": "2024-01-01",
      "defaultEndDate": "2024-12-31"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢使用者異動記錄列表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/change-logs/users/search`
- **說明**: 查詢使用者基本資料異動記錄
- **請求格式**:
  ```json
  {
    "changeUserId": "U001", // 異動使用者代碼 (可選)
    "targetUserId": "U002", // 被異動的使用者代碼 (可選，在 OLD_VALUE 或 NEW_VALUE 中搜尋)
    "beginDate": "2024-01-01", // 起始日期 (必填)
    "endDate": "2024-12-31", // 結束日期 (必填)
    "pageIndex": 1, // 頁碼 (可選，預設 1)
    "pageSize": 20 // 每頁筆數 (可選，預設 20)
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5,
      "items": [
        {
          "logId": 1,
          "changeUserId": "U001",
          "changeUserName": "張三",
          "changeDate": "2024-01-01T10:00:00",
          "changeStatus": "3",
          "changeStatusName": "修改",
          "changeFields": ["使用者名稱", "部門代碼", "狀態"],
          "oldValues": ["張三", "DEPT001", "A"],
          "newValues": ["張三豐", "DEPT002", "I"],
          "changeFieldDisplay": "使用者名稱,部門代碼,狀態",
          "oldValueDisplay": "張三,DEPT001,A",
          "newValueDisplay": "張三豐,DEPT002,I"
        }
      ]
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 查詢單筆異動記錄詳情
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/change-logs/{logId}`
- **說明**: 查詢單筆異動記錄的詳細資訊
- **路徑參數**:
  - `logId`: 異動記錄編號
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "logId": 1,
      "programId": "SYS0110",
      "changeUserId": "U001",
      "changeUserName": "張三",
      "changeDate": "2024-01-01T10:00:00",
      "changeStatus": "3",
      "changeStatusName": "修改",
      "changeFields": ["使用者名稱", "部門代碼", "狀態"],
      "oldValues": ["張三", "DEPT001", "A"],
      "newValues": ["張三豐", "DEPT002", "I"],
      "changeFieldDisplay": "使用者名稱,部門代碼,狀態",
      "oldValueDisplay": "張三,DEPT001,A",
      "newValueDisplay": "張三豐,DEPT002,I"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

---

## 四、前端 UI 設計

### 4.1 查詢條件頁面 (`SYS0610Query.vue`)

#### 4.1.1 頁面結構
```vue
<template>
  <div class="sys0610-query">
    <el-card>
      <template #header>
        <span>使用者基本資料異動查詢</span>
      </template>
      
      <el-form :model="queryForm" :rules="rules" ref="queryFormRef" label-width="150px">
        <!-- 異動使用者代碼 -->
        <el-form-item label="異動使用者代碼" prop="changeUserId">
          <el-input 
            v-model="queryForm.changeUserId" 
            placeholder="請輸入異動使用者代碼"
            clearable
            style="width: 200px"
          />
          <el-button 
            type="primary" 
            icon="Search" 
            @click="openUserListDialog('changeUser')"
            style="margin-left: 10px"
          >
            選擇
          </el-button>
          <el-input 
            v-model="changeUserName" 
            readonly 
            style="width: 200px; margin-left: 10px"
            placeholder="異動使用者名稱"
          />
        </el-form-item>
        
        <!-- 使用者代碼 (被異動的使用者) -->
        <el-form-item label="使用者代碼" prop="targetUserId">
          <el-input 
            v-model="queryForm.targetUserId" 
            placeholder="請輸入使用者代碼"
            clearable
            style="width: 200px"
          />
          <el-button 
            type="primary" 
            icon="Search" 
            @click="openUserListDialog('targetUser')"
            style="margin-left: 10px"
          >
            選擇
          </el-button>
          <el-input 
            v-model="targetUserName" 
            readonly 
            style="width: 200px; margin-left: 10px"
            placeholder="使用者名稱"
          />
        </el-form-item>
        
        <!-- 日期範圍 -->
        <el-form-item label="日期範圍" prop="dateRange" required>
          <el-date-picker
            v-model="dateRange"
            type="daterange"
            range-separator="~"
            start-placeholder="起始日期"
            end-placeholder="結束日期"
            format="YYYY/MM/DD"
            value-format="YYYY-MM-DD"
            style="width: 300px"
          />
        </el-form-item>
        
        <!-- 查詢按鈕 -->
        <el-form-item>
          <el-button type="primary" icon="Search" @click="handleQuery">查詢</el-button>
          <el-button icon="Refresh" @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>
  </div>
</template>
```

#### 4.1.2 資料結構
```typescript
interface QueryForm {
  changeUserId: string; // 異動使用者代碼
  targetUserId: string; // 被異動的使用者代碼
  beginDate: string; // 起始日期
  endDate: string; // 結束日期
}

interface ChangeLogItem {
  logId: number;
  changeUserId: string;
  changeUserName: string;
  changeDate: string;
  changeStatus: string; // 1=新增, 2=刪除, 3=修改
  changeStatusName: string;
  changeFields: string[];
  oldValues: string[];
  newValues: string[];
  changeFieldDisplay: string;
  oldValueDisplay: string;
  newValueDisplay: string;
}
```

### 4.2 查詢結果頁面 (`SYS0610Result.vue`)

#### 4.2.1 頁面結構
```vue
<template>
  <div class="sys0610-result">
    <el-card>
      <template #header>
        <div class="header-content">
          <span>查詢結果</span>
          <div class="header-info">
            <span v-if="changeUserId">
              異動使用者代碼: <strong>{{ changeUserId }}</strong>，
              異動使用者名稱: <strong>{{ changeUserName }}</strong>
            </span>
            <span v-if="dateRange">
              日期範圍: <strong>{{ dateRange[0] }} ~ {{ dateRange[1] }}</strong>
            </span>
          </div>
        </div>
      </template>
      
      <!-- 查詢結果統計 -->
      <div class="result-summary">
        <el-alert 
          :title="`符合條件者共 ${totalCount} 筆`" 
          type="info" 
          :closable="false"
        />
      </div>
      
      <!-- 查詢結果列表 -->
      <div class="result-list">
        <el-collapse v-model="activeNames">
          <el-collapse-item 
            v-for="(item, index) in changeLogList" 
            :key="item.logId"
            :name="index.toString()"
          >
            <template #title>
              <div class="collapse-title">
                <span class="seq-no">序號: {{ index + 1 }}</span>
                <span class="change-user">異動者代碼: <strong>{{ item.changeUserId }}</strong></span>
                <span class="change-date">異動時間: <strong>{{ formatDateTime(item.changeDate) }}</strong></span>
                <span class="change-status">異動狀態: <strong>{{ item.changeStatusName }}</strong></span>
              </div>
            </template>
            
            <!-- 異動詳細資訊 -->
            <div class="change-detail">
              <el-table :data="detailTableData(item)" border style="width: 100%">
                <el-table-column prop="field" label="異動欄位" width="200" />
                <el-table-column prop="oldValue" label="異動前的值" />
                <el-table-column prop="newValue" label="異動後的值" />
              </el-table>
            </div>
          </el-collapse-item>
        </el-collapse>
      </div>
      
      <!-- 分頁 -->
      <div class="pagination">
        <el-pagination
          v-model:current-page="pageIndex"
          v-model:page-size="pageSize"
          :page-sizes="[10, 20, 50, 100]"
          :total="totalCount"
          layout="total, sizes, prev, pager, next, jumper"
          @size-change="handleSizeChange"
          @current-change="handleCurrentChange"
        />
      </div>
    </el-card>
  </div>
</template>
```

#### 4.2.2 方法實作
```typescript
// 將異動記錄轉換為表格資料
const detailTableData = (item: ChangeLogItem) => {
  const fields = item.changeFields || [];
  const oldValues = item.oldValues || [];
  const newValues = item.newValues || [];
  
  return fields.map((field, index) => ({
    field: field,
    oldValue: oldValues[index] || '--',
    newValue: newValues[index] || '--'
  }));
};

// 格式化日期時間
const formatDateTime = (dateTime: string) => {
  return dayjs(dateTime).format('YYYY/MM/DD HH:mm:ss');
};
```

---

## 五、後端實作

### 5.1 Repository 層 (`ChangeLogRepository.cs`)

```csharp
public interface IChangeLogRepository
{
    Task<PagedResult<ChangeLogDto>> GetUserChangeLogsAsync(
        string programId,
        string changeUserId,
        string targetUserId,
        DateTime beginDate,
        DateTime endDate,
        int pageIndex,
        int pageSize);
    
    Task<ChangeLogDto> GetChangeLogByIdAsync(long logId);
}

public class ChangeLogRepository : IChangeLogRepository
{
    private readonly IDbConnection _connection;
    
    public ChangeLogRepository(IDbConnection connection)
    {
        _connection = connection;
    }
    
    public async Task<PagedResult<ChangeLogDto>> GetUserChangeLogsAsync(
        string programId,
        string changeUserId,
        string targetUserId,
        DateTime beginDate,
        DateTime endDate,
        int pageIndex,
        int pageSize)
    {
        var sql = @"
            SELECT 
                cl.LogId,
                cl.ChangeUserId,
                u.UserName AS ChangeUserName,
                cl.ChangeDate,
                cl.ChangeStatus,
                cl.ChangeField,
                cl.OldValue,
                cl.NewValue
            FROM ChangeLogs cl
            LEFT JOIN Users u ON cl.ChangeUserId = u.UserId
            WHERE cl.ProgramId = @ProgramId
                AND (@ChangeUserId IS NULL OR cl.ChangeUserId = @ChangeUserId)
                AND (@TargetUserId IS NULL OR cl.OldValue LIKE '%' + @TargetUserId + '%' OR cl.NewValue LIKE '%' + @TargetUserId + '%')
                AND cl.ChangeDate >= @BeginDate
                AND cl.ChangeDate < DATEADD(DAY, 1, @EndDate)
                AND (cl.OldValue != cl.NewValue OR cl.OldValue IS NULL OR cl.NewValue IS NULL)
            ORDER BY cl.ChangeDate DESC, cl.ChangeUserId
            OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
            
            SELECT COUNT(*)
            FROM ChangeLogs cl
            WHERE cl.ProgramId = @ProgramId
                AND (@ChangeUserId IS NULL OR cl.ChangeUserId = @ChangeUserId)
                AND (@TargetUserId IS NULL OR cl.OldValue LIKE '%' + @TargetUserId + '%' OR cl.NewValue LIKE '%' + @TargetUserId + '%')
                AND cl.ChangeDate >= @BeginDate
                AND cl.ChangeDate < DATEADD(DAY, 1, @EndDate)
                AND (cl.OldValue != cl.NewValue OR cl.OldValue IS NULL OR cl.NewValue IS NULL);
        ";
        
        var parameters = new
        {
            ProgramId = programId,
            ChangeUserId = string.IsNullOrWhiteSpace(changeUserId) ? (string?)null : changeUserId,
            TargetUserId = string.IsNullOrWhiteSpace(targetUserId) ? (string?)null : targetUserId,
            BeginDate = beginDate,
            EndDate = endDate,
            Offset = (pageIndex - 1) * pageSize,
            PageSize = pageSize
        };
        
        using var multi = await _connection.QueryMultipleAsync(sql, parameters);
        var items = await multi.ReadAsync<ChangeLogDto>();
        var totalCount = await multi.ReadSingleAsync<int>();
        
        return new PagedResult<ChangeLogDto>
        {
            Items = items.ToList(),
            TotalCount = totalCount,
            PageIndex = pageIndex,
            PageSize = pageSize,
            TotalPages = (int)Math.Ceiling(totalCount / (double)pageSize)
        };
    }
    
    public async Task<ChangeLogDto> GetChangeLogByIdAsync(long logId)
    {
        var sql = @"
            SELECT 
                cl.LogId,
                cl.ProgramId,
                cl.ChangeUserId,
                u.UserName AS ChangeUserName,
                cl.ChangeDate,
                cl.ChangeStatus,
                cl.ChangeField,
                cl.OldValue,
                cl.NewValue
            FROM ChangeLogs cl
            LEFT JOIN Users u ON cl.ChangeUserId = u.UserId
            WHERE cl.LogId = @LogId;
        ";
        
        return await _connection.QueryFirstOrDefaultAsync<ChangeLogDto>(sql, new { LogId = logId });
    }
}
```

### 5.2 Service 層 (`ChangeLogService.cs`)

```csharp
public interface IChangeLogService
{
    Task<ApiResponse<PagedResult<ChangeLogDto>>> GetUserChangeLogsAsync(UserChangeLogQueryDto query);
    Task<ApiResponse<ChangeLogDto>> GetChangeLogByIdAsync(long logId);
}

public class ChangeLogService : IChangeLogService
{
    private readonly IChangeLogRepository _repository;
    private readonly IMapper _mapper;
    
    public ChangeLogService(IChangeLogRepository repository, IMapper mapper)
    {
        _repository = repository;
        _mapper = mapper;
    }
    
    public async Task<ApiResponse<PagedResult<ChangeLogDto>>> GetUserChangeLogsAsync(UserChangeLogQueryDto query)
    {
        var result = await _repository.GetUserChangeLogsAsync(
            "SYS0110",
            query.ChangeUserId,
            query.TargetUserId,
            query.BeginDate,
            query.EndDate,
            query.PageIndex ?? 1,
            query.PageSize ?? 20
        );
        
        // 處理異動狀態名稱
        foreach (var item in result.Items)
        {
            item.ChangeStatusName = GetChangeStatusName(item.ChangeStatus);
            item.ChangeFields = item.ChangeField?.Split(',').ToList() ?? new List<string>();
            item.OldValues = item.OldValue?.Split(',').ToList() ?? new List<string>();
            item.NewValues = item.NewValue?.Split(',').ToList() ?? new List<string>();
            item.ChangeFieldDisplay = item.ChangeField ?? "";
            item.OldValueDisplay = item.OldValue ?? "--";
            item.NewValueDisplay = item.NewValue ?? "--";
        }
        
        return ApiResponse<PagedResult<ChangeLogDto>>.Success(result);
    }
    
    public async Task<ApiResponse<ChangeLogDto>> GetChangeLogByIdAsync(long logId)
    {
        var result = await _repository.GetChangeLogByIdAsync(logId);
        
        if (result == null)
        {
            return ApiResponse<ChangeLogDto>.Fail("查無資料");
        }
        
        // 處理異動狀態名稱
        result.ChangeStatusName = GetChangeStatusName(result.ChangeStatus);
        result.ChangeFields = result.ChangeField?.Split(',').ToList() ?? new List<string>();
        result.OldValues = result.OldValue?.Split(',').ToList() ?? new List<string>();
        result.NewValues = result.NewValue?.Split(',').ToList() ?? new List<string>();
        result.ChangeFieldDisplay = result.ChangeField ?? "";
        result.OldValueDisplay = result.OldValue ?? "--";
        result.NewValueDisplay = result.NewValue ?? "--";
        
        return ApiResponse<ChangeLogDto>.Success(result);
    }
    
    private string GetChangeStatusName(string status)
    {
        return status switch
        {
            "1" => "新增",
            "2" => "刪除",
            "3" => "修改",
            _ => status
        };
    }
}
```

### 5.3 Controller 層 (`ChangeLogController.cs`)

```csharp
[ApiController]
[Route("api/v1/change-logs")]
[Authorize]
public class ChangeLogController : ControllerBase
{
    private readonly IChangeLogService _service;
    
    public ChangeLogController(IChangeLogService service)
    {
        _service = service;
    }
    
    /// <summary>
    /// 查詢使用者異動記錄
    /// </summary>
    [HttpPost("users/search")]
    public async Task<IActionResult> GetUserChangeLogs([FromBody] UserChangeLogQueryDto query)
    {
        var result = await _service.GetUserChangeLogsAsync(query);
        return Ok(result);
    }
    
    /// <summary>
    /// 查詢單筆異動記錄
    /// </summary>
    [HttpGet("{logId}")]
    public async Task<IActionResult> GetChangeLogById(long logId)
    {
        var result = await _service.GetChangeLogByIdAsync(logId);
        return Ok(result);
    }
}
```

---

## 六、開發時程

### 6.1 階段一: 資料庫設計 (1天)
- [x] 建立 `ChangeLogs` 資料表
- [x] 建立索引
- [x] 資料遷移腳本

### 6.2 階段二: 後端開發 (2天)
- [ ] Repository 層實作
- [ ] Service 層實作
- [ ] Controller 層實作
- [ ] DTO 定義
- [ ] 單元測試

### 6.3 階段三: 前端開發 (2天)
- [ ] 查詢條件頁面
- [ ] 查詢結果頁面
- [ ] API 整合
- [ ] 使用者選擇對話框
- [ ] 單元測試

### 6.4 階段四: 整合測試 (1天)
- [ ] 功能測試
- [ ] 效能測試
- [ ] 使用者驗收測試

---

## 七、注意事項

### 7.1 資料處理
- 異動欄位、異動前的值、異動後的值以逗號分隔儲存
- 前端顯示時需要將逗號分隔的字串轉換為陣列
- 空值顯示為 "--"

### 7.2 查詢效能
- 日期範圍查詢使用索引優化
- 大量資料時使用分頁查詢
- 考慮使用全文檢索優化使用者代碼搜尋

### 7.3 權限控制
- 需要查詢權限
- 可考慮限制查詢日期範圍（如最多查詢一年）

### 7.4 資料遷移
- 從舊系統 `MNG_LOG` 表遷移資料到新系統 `ChangeLogs` 表
- 確保 `ProgramId = 'SYS0110'` 的記錄正確遷移

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

