# SYS0117 - 使用者權限代理 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0117
- **功能名稱**: 使用者權限代理
- **功能描述**: 提供使用者權限代理功能，允許委託人將自己的權限委託給代理人，在指定時間範圍內代理人可以行使委託人的權限
- **參考舊程式**: 
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0117` (需確認實際檔案路徑)
  - 相關資料表: `UserAgent` (已在 SYS0110 中定義)

### 1.2 業務需求
- 支援委託人設定代理人
- 支援設定代理時間範圍（開始時間、結束時間）
- 支援代理人行使委託人權限
- 支援查詢代理關係
- 支援代理關係的啟用/停用
- 支援代理記錄的查詢與報表

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `UserAgent`

```sql
CREATE TABLE [dbo].[UserAgent] (
    [AgentId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [PrincipalUserId] NVARCHAR(50) NOT NULL, -- 委託人
    [AgentUserId] NVARCHAR(50) NOT NULL, -- 代理人
    [BeginTime] DATETIME2 NOT NULL, -- 代理開始時間
    [EndTime] DATETIME2 NOT NULL, -- 代理結束時間
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'A', -- A:啟用, I:停用
    [Notes] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_UserAgent_PrincipalUser] FOREIGN KEY ([PrincipalUserId]) REFERENCES [dbo].[Users] ([UserId]),
    CONSTRAINT [FK_UserAgent_AgentUser] FOREIGN KEY ([AgentUserId]) REFERENCES [dbo].[Users] ([UserId]),
    CONSTRAINT [CK_UserAgent_TimeRange] CHECK ([EndTime] > [BeginTime]),
    CONSTRAINT [CK_UserAgent_DifferentUser] CHECK ([PrincipalUserId] <> [AgentUserId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_UserAgent_PrincipalUserId] ON [dbo].[UserAgent] ([PrincipalUserId]);
CREATE NONCLUSTERED INDEX [IX_UserAgent_AgentUserId] ON [dbo].[UserAgent] ([AgentUserId]);
CREATE NONCLUSTERED INDEX [IX_UserAgent_Status] ON [dbo].[UserAgent] ([Status]);
CREATE NONCLUSTERED INDEX [IX_UserAgent_TimeRange] ON [dbo].[UserAgent] ([BeginTime], [EndTime]);
```

### 2.2 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| AgentId | UNIQUEIDENTIFIER | - | NO | NEWID() | 代理記錄ID | 主鍵 |
| PrincipalUserId | NVARCHAR | 50 | NO | - | 委託人使用者編號 | 外鍵至 Users |
| AgentUserId | NVARCHAR | 50 | NO | - | 代理人使用者編號 | 外鍵至 Users |
| BeginTime | DATETIME2 | - | NO | - | 代理開始時間 | - |
| EndTime | DATETIME2 | - | NO | - | 代理結束時間 | 必須大於開始時間 |
| Status | NVARCHAR | 10 | NO | 'A' | 狀態 | A:啟用, I:停用 |
| Notes | NVARCHAR | 500 | YES | - | 備註 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢代理列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/user-agents`
- **說明**: 查詢使用者權限代理列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "CreatedAt",
    "sortOrder": "DESC",
    "filters": {
      "principalUserId": "",
      "agentUserId": "",
      "status": "",
      "beginTimeFrom": "",
      "beginTimeTo": "",
      "endTimeFrom": "",
      "endTimeTo": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "agentId": "550e8400-e29b-41d4-a716-446655440000",
          "principalUserId": "U001",
          "principalUserName": "張三",
          "agentUserId": "U002",
          "agentUserName": "李四",
          "beginTime": "2024-01-01T00:00:00",
          "endTime": "2024-01-31T23:59:59",
          "status": "A",
          "notes": "代理說明",
          "createdBy": "ADMIN",
          "createdAt": "2024-01-01T10:00:00"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆代理記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/user-agents/{agentId}`
- **說明**: 根據代理記錄ID查詢單筆代理資料
- **路徑參數**:
  - `agentId`: 代理記錄ID (GUID)
- **回應格式**: 同查詢列表中的單筆資料

#### 3.1.3 查詢委託人的代理記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/agent-as-principal`
- **說明**: 查詢指定使用者作為委託人的所有代理記錄
- **路徑參數**:
  - `userId`: 使用者編號
- **回應格式**: 同查詢列表

#### 3.1.4 查詢代理人的代理記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/agent-as-agent`
- **說明**: 查詢指定使用者作為代理人的所有代理記錄
- **路徑參數**:
  - `userId`: 使用者編號
- **回應格式**: 同查詢列表

#### 3.1.5 查詢有效代理記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/user-agents/active`
- **說明**: 查詢當前時間有效的代理記錄
- **請求參數**:
  ```json
  {
    "principalUserId": "",
    "agentUserId": "",
    "currentTime": "2024-01-15T10:00:00"
  }
  ```
- **回應格式**: 同查詢列表

#### 3.1.6 新增代理記錄
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/user-agents`
- **說明**: 新增使用者權限代理記錄
- **請求格式**:
  ```json
  {
    "principalUserId": "U001",
    "agentUserId": "U002",
    "beginTime": "2024-01-01T00:00:00",
    "endTime": "2024-01-31T23:59:59",
    "status": "A",
    "notes": "代理說明"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "新增成功",
    "data": {
      "agentId": "550e8400-e29b-41d4-a716-446655440000"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```
- **驗證規則**:
  - 委託人和代理人必須不同
  - 結束時間必須大於開始時間
  - 委託人和代理人必須存在
  - 時間範圍不能與現有代理記錄重疊（可選）

#### 3.1.7 修改代理記錄
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/user-agents/{agentId}`
- **說明**: 修改代理記錄資料
- **路徑參數**:
  - `agentId`: 代理記錄ID (GUID)
- **請求格式**: 同新增，但 `agentId` 不可修改
- **回應格式**: 同新增

#### 3.1.8 刪除代理記錄
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/user-agents/{agentId}`
- **說明**: 刪除代理記錄（軟刪除或硬刪除）
- **路徑參數**:
  - `agentId`: 代理記錄ID (GUID)
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.9 批次刪除代理記錄
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/user-agents/batch`
- **說明**: 批次刪除多筆代理記錄
- **請求格式**:
  ```json
  {
    "agentIds": [
      "550e8400-e29b-41d4-a716-446655440000",
      "660e8400-e29b-41d4-a716-446655440001"
    ]
  }
  ```

#### 3.1.10 啟用/停用代理記錄
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/user-agents/{agentId}/status`
- **說明**: 啟用或停用代理記錄
- **路徑參數**:
  - `agentId`: 代理記錄ID (GUID)
- **請求格式**:
  ```json
  {
    "status": "A" // A:啟用, I:停用
  }
  ```

#### 3.1.11 檢查代理權限
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/user-agents/check-permission`
- **說明**: 檢查代理人是否可以行使委託人的權限
- **請求格式**:
  ```json
  {
    "agentUserId": "U002",
    "principalUserId": "U001",
    "checkTime": "2024-01-15T10:00:00"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "檢查成功",
    "data": {
      "hasPermission": true,
      "agentId": "550e8400-e29b-41d4-a716-446655440000",
      "beginTime": "2024-01-01T00:00:00",
      "endTime": "2024-01-31T23:59:59"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 代理列表頁面 (`/user-agents`)
- **功能**: 顯示所有代理記錄列表
- **主要元件**:
  - 搜尋表單（委託人、代理人、狀態、時間範圍）
  - 資料表格（顯示代理記錄）
  - 分頁元件
  - 操作按鈕（新增、修改、刪除、啟用/停用）

#### 4.1.2 新增/修改代理頁面 (`/user-agents/add`, `/user-agents/edit/:id`)
- **功能**: 新增或修改代理記錄
- **主要元件**:
  - 表單元件
    - 委託人選擇器（使用者下拉選單）
    - 代理人選擇器（使用者下拉選單）
    - 開始時間選擇器（日期時間選擇器）
    - 結束時間選擇器（日期時間選擇器）
    - 狀態選擇器（下拉選單：啟用/停用）
    - 備註輸入框（多行文字）
  - 驗證提示
  - 提交/取消按鈕

#### 4.1.3 代理詳情頁面 (`/user-agents/:id`)
- **功能**: 顯示代理記錄詳細資訊
- **主要元件**:
  - 資訊展示卡片
  - 操作按鈕（修改、刪除、啟用/停用）

### 4.2 UI 元件設計

#### 4.2.1 代理列表表格
```vue
<template>
  <el-table :data="agentList" style="width: 100%">
    <el-table-column prop="principalUserName" label="委託人" width="120" />
    <el-table-column prop="agentUserName" label="代理人" width="120" />
    <el-table-column prop="beginTime" label="開始時間" width="180" />
    <el-table-column prop="endTime" label="結束時間" width="180" />
    <el-table-column prop="status" label="狀態" width="100">
      <template #default="scope">
        <el-tag :type="scope.row.status === 'A' ? 'success' : 'info'">
          {{ scope.row.status === 'A' ? '啟用' : '停用' }}
        </el-tag>
      </template>
    </el-table-column>
    <el-table-column label="操作" width="200" fixed="right">
      <template #default="scope">
        <el-button size="small" @click="handleEdit(scope.row)">修改</el-button>
        <el-button size="small" type="danger" @click="handleDelete(scope.row)">刪除</el-button>
        <el-button 
          size="small" 
          :type="scope.row.status === 'A' ? 'warning' : 'success'"
          @click="handleToggleStatus(scope.row)"
        >
          {{ scope.row.status === 'A' ? '停用' : '啟用' }}
        </el-button>
      </template>
    </el-table-column>
  </el-table>
</template>
```

#### 4.2.2 代理表單
```vue
<template>
  <el-form :model="form" :rules="rules" ref="formRef" label-width="120px">
    <el-form-item label="委託人" prop="principalUserId">
      <el-select v-model="form.principalUserId" placeholder="請選擇委託人">
        <el-option
          v-for="user in userList"
          :key="user.userId"
          :label="user.userName"
          :value="user.userId"
        />
      </el-select>
    </el-form-item>
    <el-form-item label="代理人" prop="agentUserId">
      <el-select v-model="form.agentUserId" placeholder="請選擇代理人">
        <el-option
          v-for="user in userList"
          :key="user.userId"
          :label="user.userName"
          :value="user.userId"
        />
      </el-select>
    </el-form-item>
    <el-form-item label="開始時間" prop="beginTime">
      <el-date-picker
        v-model="form.beginTime"
        type="datetime"
        placeholder="選擇開始時間"
        style="width: 100%"
      />
    </el-form-item>
    <el-form-item label="結束時間" prop="endTime">
      <el-date-picker
        v-model="form.endTime"
        type="datetime"
        placeholder="選擇結束時間"
        style="width: 100%"
      />
    </el-form-item>
    <el-form-item label="狀態" prop="status">
      <el-select v-model="form.status" placeholder="請選擇狀態">
        <el-option label="啟用" value="A" />
        <el-option label="停用" value="I" />
      </el-select>
    </el-form-item>
    <el-form-item label="備註" prop="notes">
      <el-input
        v-model="form.notes"
        type="textarea"
        :rows="4"
        placeholder="請輸入備註"
      />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSubmit">提交</el-button>
      <el-button @click="handleCancel">取消</el-button>
    </el-form-item>
  </el-form>
</template>
```

### 4.3 路由配置

```typescript
{
  path: '/user-agents',
  name: 'UserAgents',
  component: () => import('@/views/user/UserAgentList.vue'),
  meta: {
    title: '使用者權限代理',
    requiresAuth: true,
    permission: 'SYS0117'
  }
},
{
  path: '/user-agents/add',
  name: 'UserAgentAdd',
  component: () => import('@/views/user/UserAgentForm.vue'),
  meta: {
    title: '新增代理',
    requiresAuth: true,
    permission: 'SYS0117_FI'
  }
},
{
  path: '/user-agents/edit/:id',
  name: 'UserAgentEdit',
  component: () => import('@/views/user/UserAgentForm.vue'),
  meta: {
    title: '修改代理',
    requiresAuth: true,
    permission: 'SYS0117_FU'
  }
}
```

---

## 五、業務邏輯

### 5.1 新增代理記錄
1. 驗證委託人和代理人必須不同
2. 驗證結束時間必須大於開始時間
3. 驗證委託人和代理人必須存在
4. 可選：檢查時間範圍是否與現有代理記錄重疊
5. 建立代理記錄
6. 記錄操作日誌

### 5.2 修改代理記錄
1. 驗證代理記錄存在
2. 執行新增時的驗證邏輯
3. 更新代理記錄
4. 記錄操作日誌

### 5.3 刪除代理記錄
1. 驗證代理記錄存在
2. 執行軟刪除（更新狀態為已刪除）或硬刪除
3. 記錄操作日誌

### 5.4 檢查代理權限
1. 查詢有效的代理記錄（狀態為啟用，當前時間在時間範圍內）
2. 檢查代理人是否可以行使委託人的權限
3. 返回檢查結果

### 5.5 代理權限應用
在權限檢查時，需要同時檢查：
1. 使用者本身的權限
2. 使用者作為代理人的代理權限（在有效時間範圍內）

---

## 六、開發時程

### 6.1 後端開發 (3天)
- Day 1: 資料庫設計與遷移腳本、Repository 層開發
- Day 2: Service 層開發、API Controller 開發
- Day 3: 單元測試、API 測試

### 6.2 前端開發 (3天)
- Day 1: 頁面結構與路由配置、列表頁面開發
- Day 2: 新增/修改頁面開發、表單驗證
- Day 3: 整合測試、UI 優化

### 6.3 整合測試 (1天)
- 前後端整合測試
- 權限檢查功能測試
- 效能測試

**總計**: 7天

---

## 七、注意事項

1. **時間範圍驗證**: 必須確保結束時間大於開始時間
2. **使用者驗證**: 委託人和代理人必須不同，且都必須存在
3. **權限檢查**: 在權限系統中需要整合代理權限檢查邏輯
4. **時間重疊**: 可選功能，檢查時間範圍是否重疊
5. **效能考量**: 代理權限檢查可能影響效能，需要適當的快取機制
6. **安全性**: 代理權限的授予需要適當的權限控制

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

