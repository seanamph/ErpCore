# SYS0130 - 使用者帳戶原則管理 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0130
- **功能名稱**: 使用者帳戶原則管理
- **功能描述**: 提供使用者帳戶原則管理功能，允許管理員修改使用者的密碼和帳號終止日，需要驗證使用者編號和密碼
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0130_FQ.ASP` (查詢畫面)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0130_FB.ASP` (修改畫面)

### 1.2 業務需求
- 支援修改使用者密碼
- 支援修改帳號終止日
- 需要驗證使用者編號和密碼（確保操作者知道正確的使用者資訊）
- 提供查詢介面，輸入使用者編號、密碼、帳號終止日
- 修改成功後顯示成功訊息
- 驗證失敗時顯示錯誤訊息

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Users`
與 SYS0110 共用相同的資料表結構，請參考 SYS0110 的資料庫設計。

主要使用的欄位：
- `UserId` - 使用者編號（用於驗證）
- `UserPassword` - 使用者密碼（用於驗證，加密儲存）
- `EndDate` - 帳號終止日（可修改）

### 2.2 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| UserId | NVARCHAR | 50 | NO | - | 使用者編號 | 主鍵，用於驗證 |
| UserPassword | NVARCHAR | 255 | YES | - | 使用者密碼 | 加密儲存，用於驗證 |
| EndDate | DATETIME2 | - | YES | - | 帳號終止日 | 可修改 |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 驗證使用者資訊
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/validate`
- **說明**: 驗證使用者編號和密碼是否正確
- **請求格式**:
  ```json
  {
    "userId": "U001",
    "password": "Password123!"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "驗證成功",
    "data": {
      "userId": "U001",
      "userName": "張三",
      "isValid": true
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```
- **錯誤回應**:
  ```json
  {
    "success": false,
    "code": 400,
    "message": "使用者編號或密碼錯誤",
    "data": {
      "errorCode": "USER_INVALID",
      "errorMessage": "使用者編號錯誤"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 修改使用者帳戶原則
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/users/{userId}/account-policy`
- **說明**: 修改使用者的密碼和帳號終止日
- **路徑參數**:
  - `userId`: 使用者編號
- **請求格式**:
  ```json
  {
    "password": "OldPassword123!",
    "newPassword": "NewPassword123!",
    "endDate": "2024-12-31"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "修改成功",
    "data": {
      "userId": "U001",
      "endDate": "2024-12-31"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```
- **錯誤回應**:
  ```json
  {
    "success": false,
    "code": 400,
    "message": "密碼錯誤",
    "data": {
      "errorCode": "PASSWORD_INVALID",
      "errorMessage": "使用者密碼錯誤"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 僅修改帳號終止日
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/users/{userId}/end-date`
- **說明**: 僅修改帳號終止日（不需要修改密碼時使用）
- **路徑參數**:
  - `userId`: 使用者編號
- **請求格式**:
  ```json
  {
    "password": "Password123!",
    "endDate": "2024-12-31"
  }
  ```
- **回應格式**: 同修改使用者帳戶原則

### 3.2 後端實作類別

#### 3.2.1 Controller: `UserAccountPolicyController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/users")]
    [Authorize]
    public class UserAccountPolicyController : ControllerBase
    {
        private readonly IUserService _userService;
        
        public UserAccountPolicyController(IUserService userService)
        {
            _userService = userService;
        }
        
        [HttpPost("validate")]
        public async Task<ActionResult<ApiResponse<UserValidationDto>>> ValidateUser([FromBody] UserValidationDto dto)
        {
            // 實作驗證邏輯
            var result = await _userService.ValidateUserAsync(dto.UserId, dto.Password);
            if (!result.IsValid)
            {
                return BadRequest(new ApiResponse
                {
                    Success = false,
                    Code = 400,
                    Message = result.ErrorCode == "USER_INVALID" ? "使用者編號錯誤" : "使用者密碼錯誤",
                    Data = new { errorCode = result.ErrorCode, errorMessage = result.ErrorMessage }
                });
            }
            return Ok(new ApiResponse<UserValidationDto>
            {
                Success = true,
                Code = 200,
                Message = "驗證成功",
                Data = result
            });
        }
        
        [HttpPut("{userId}/account-policy")]
        public async Task<ActionResult<ApiResponse>> UpdateAccountPolicy(string userId, [FromBody] UpdateAccountPolicyDto dto)
        {
            // 驗證使用者編號和密碼
            var validation = await _userService.ValidateUserAsync(userId, dto.Password);
            if (!validation.IsValid)
            {
                return BadRequest(new ApiResponse
                {
                    Success = false,
                    Code = 400,
                    Message = validation.ErrorCode == "USER_INVALID" ? "使用者編號錯誤" : "使用者密碼錯誤",
                    Data = new { errorCode = validation.ErrorCode, errorMessage = validation.ErrorMessage }
                });
            }
            
            // 修改帳戶原則
            await _userService.UpdateAccountPolicyAsync(userId, dto.NewPassword, dto.EndDate);
            
            return Ok(new ApiResponse
            {
                Success = true,
                Code = 200,
                Message = "修改成功",
                Data = new { userId, endDate = dto.EndDate }
            });
        }
        
        [HttpPut("{userId}/end-date")]
        public async Task<ActionResult<ApiResponse>> UpdateEndDate(string userId, [FromBody] UpdateEndDateDto dto)
        {
            // 驗證使用者編號和密碼
            var validation = await _userService.ValidateUserAsync(userId, dto.Password);
            if (!validation.IsValid)
            {
                return BadRequest(new ApiResponse
                {
                    Success = false,
                    Code = 400,
                    Message = validation.ErrorCode == "USER_INVALID" ? "使用者編號錯誤" : "使用者密碼錯誤",
                    Data = new { errorCode = validation.ErrorCode, errorMessage = validation.ErrorMessage }
                });
            }
            
            // 修改帳號終止日
            await _userService.UpdateEndDateAsync(userId, dto.EndDate);
            
            return Ok(new ApiResponse
            {
                Success = true,
                Code = 200,
                Message = "修改成功",
                Data = new { userId, endDate = dto.EndDate }
            });
        }
    }
}
```

#### 3.2.2 Service: `UserService.cs`
在現有的 `IUserService` 中新增以下方法：

```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IUserService
    {
        // ... 現有方法 ...
        
        Task<UserValidationResult> ValidateUserAsync(string userId, string password);
        Task UpdateAccountPolicyAsync(string userId, string newPassword, DateTime? endDate);
        Task UpdateEndDateAsync(string userId, DateTime? endDate);
    }
    
    public class UserValidationResult
    {
        public bool IsValid { get; set; }
        public string ErrorCode { get; set; } // "USER_INVALID" 或 "PASSWORD_INVALID"
        public string ErrorMessage { get; set; }
        public string UserId { get; set; }
        public string UserName { get; set; }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 使用者帳戶原則管理頁面 (`UserAccountPolicy.vue`)
- **路徑**: `/system/users/account-policy`
- **功能**: 提供使用者帳戶原則管理功能，包含驗證和修改
- **主要元件**:
  - 查詢表單 (UserAccountPolicyForm) - 輸入使用者編號、密碼、帳號終止日
  - 修改按鈕
  - 成功/錯誤訊息顯示

### 4.2 UI 元件設計

#### 4.2.1 帳戶原則管理表單 (`UserAccountPolicyForm.vue`)
```vue
<template>
  <div class="user-account-policy">
    <el-card>
      <template #header>
        <span>使用者帳戶原則管理</span>
      </template>
      <el-form :model="form" :rules="rules" ref="formRef" label-width="150px">
        <el-form-item label="使用者編號" prop="userId">
          <el-input 
            v-model="form.userId" 
            placeholder="請輸入使用者編號" 
            :maxlength="50"
            clearable
          />
        </el-form-item>
        <el-form-item label="使用者密碼" prop="password">
          <el-input 
            v-model="form.password" 
            type="password" 
            placeholder="請輸入使用者密碼" 
            :maxlength="20"
            show-password
            clearable
          />
          <el-text type="info" size="small" style="margin-left: 10px;">
            用於驗證使用者身份
          </el-text>
        </el-form-item>
        <el-form-item label="新密碼" prop="newPassword">
          <el-input 
            v-model="form.newPassword" 
            type="password" 
            placeholder="請輸入新密碼（選填）" 
            :maxlength="20"
            show-password
            clearable
          />
          <el-text type="info" size="small" style="margin-left: 10px;">
            如不需要修改密碼，請留空
          </el-text>
        </el-form-item>
        <el-form-item label="帳號終止日" prop="endDate">
          <el-date-picker
            v-model="form.endDate"
            type="date"
            placeholder="請選擇帳號終止日"
            format="YYYY/MM/DD"
            value-format="YYYY-MM-DD"
            style="width: 100%"
          />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSubmit" :loading="loading">
            修改
          </el-button>
          <el-button @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 成功訊息 -->
    <el-dialog
      v-model="successDialogVisible"
      title="修改成功"
      width="400px"
      :close-on-click-modal="false"
    >
      <div style="text-align: center; padding: 20px;">
        <el-icon :size="48" color="#67C23A" style="margin-bottom: 10px;">
          <Check />
        </el-icon>
        <p style="font-size: 16px; margin-top: 10px;">修改成功</p>
      </div>
      <template #footer>
        <el-button type="primary" @click="handleSuccessConfirm">確定</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { ElMessage } from 'element-plus';
import { Check } from '@element-plus/icons-vue';
import { updateAccountPolicy, validateUser } from '@/api/user';

const formRef = ref();
const loading = ref(false);
const successDialogVisible = ref(false);

const form = reactive({
  userId: '',
  password: '',
  newPassword: '',
  endDate: null as string | null
});

const rules = {
  userId: [
    { required: true, message: '請輸入使用者編號', trigger: 'blur' },
    { max: 50, message: '使用者編號長度不能超過50個字元', trigger: 'blur' }
  ],
  password: [
    { required: true, message: '請輸入使用者密碼', trigger: 'blur' },
    { max: 20, message: '密碼長度不能超過20個字元', trigger: 'blur' }
  ],
  newPassword: [
    { max: 20, message: '新密碼長度不能超過20個字元', trigger: 'blur' }
  ],
  endDate: [
    { required: true, message: '請選擇帳號終止日', trigger: 'change' }
  ]
};

const handleSubmit = async () => {
  if (!formRef.value) return;
  
  await formRef.value.validate(async (valid: boolean) => {
    if (!valid) return;
    
    loading.value = true;
    try {
      // 先驗證使用者編號和密碼
      const validation = await validateUser({
        userId: form.userId,
        password: form.password
      });
      
      if (!validation.data.isValid) {
        ElMessage.error(validation.message || '驗證失敗');
        return;
      }
      
      // 修改帳戶原則
      if (form.newPassword) {
        // 修改密碼和終止日
        await updateAccountPolicy(form.userId, {
          password: form.password,
          newPassword: form.newPassword,
          endDate: form.endDate
        });
      } else {
        // 僅修改終止日
        await updateAccountPolicy(form.userId, {
          password: form.password,
          endDate: form.endDate
        });
      }
      
      successDialogVisible.value = true;
    } catch (error: any) {
      ElMessage.error(error.response?.data?.message || '修改失敗');
    } finally {
      loading.value = false;
    }
  });
};

const handleReset = () => {
  formRef.value?.resetFields();
  form.userId = '';
  form.password = '';
  form.newPassword = '';
  form.endDate = null;
};

const handleSuccessConfirm = () => {
  successDialogVisible.value = false;
  handleReset();
};
</script>
```

### 4.3 API 呼叫 (`user.api.ts`)
在現有的 `user.api.ts` 中新增以下 API 函數：

```typescript
// 驗證使用者
export interface UserValidationDto {
  userId: string;
  password: string;
}

export interface UserValidationResponse {
  userId: string;
  userName: string;
  isValid: boolean;
}

export const validateUser = (data: UserValidationDto) => {
  return request.post<ApiResponse<UserValidationResponse>>('/api/v1/users/validate', data);
};

// 修改帳戶原則
export interface UpdateAccountPolicyDto {
  password: string;
  newPassword?: string;
  endDate: string;
}

export const updateAccountPolicy = (userId: string, data: UpdateAccountPolicyDto) => {
  return request.put<ApiResponse>(`/api/v1/users/${userId}/account-policy`, data);
};

// 僅修改帳號終止日
export interface UpdateEndDateDto {
  password: string;
  endDate: string;
}

export const updateEndDate = (userId: string, data: UpdateEndDateDto) => {
  return request.put<ApiResponse>(`/api/v1/users/${userId}/end-date`, data);
};
```

---

## 五、開發時程

### 5.1 階段一: 後端開發 (2天)
- [ ] 新增驗證使用者 API 端點
- [ ] 新增修改帳戶原則 API 端點
- [ ] 實作密碼驗證邏輯
- [ ] 實作密碼修改邏輯
- [ ] 實作帳號終止日修改邏輯
- [ ] 單元測試

### 5.2 階段二: 前端開發 (2天)
- [ ] 帳戶原則管理頁面開發
- [ ] 表單元件開發
- [ ] 驗證邏輯實作
- [ ] 成功/錯誤訊息處理
- [ ] API 呼叫函數
- [ ] 元件測試

### 5.3 階段三: 整合測試 (1天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 錯誤處理測試
- [ ] 安全性測試

**總計**: 5天

---

## 六、注意事項

### 6.1 安全性
- 密碼必須加密儲存和傳輸
- 驗證使用者時必須檢查密碼是否正確
- 修改密碼時必須符合密碼規則
- 必須記錄操作日誌

### 6.2 業務邏輯
- 修改前必須驗證使用者編號和密碼
- 新密碼為選填，如不填則不修改密碼
- 帳號終止日為必填
- 驗證失敗時必須明確指出是使用者編號錯誤還是密碼錯誤

### 6.3 資料驗證
- 使用者編號必須存在
- 密碼必須正確
- 帳號終止日必須為有效日期
- 新密碼（如提供）必須符合密碼規則

### 6.4 錯誤處理
- 使用者編號不存在時顯示「使用者編號錯誤」
- 密碼不正確時顯示「使用者密碼錯誤」
- 日期格式錯誤時顯示相應錯誤訊息
- 新密碼不符合規則時顯示密碼規則說明

---

## 七、測試案例

### 7.1 單元測試
- [ ] 驗證使用者成功（正確的使用者編號和密碼）
- [ ] 驗證使用者失敗（錯誤的使用者編號）
- [ ] 驗證使用者失敗（錯誤的密碼）
- [ ] 修改帳戶原則成功（修改密碼和終止日）
- [ ] 修改帳戶原則成功（僅修改終止日）
- [ ] 修改帳戶原則失敗（使用者編號錯誤）
- [ ] 修改帳戶原則失敗（密碼錯誤）

### 7.2 整合測試
- [ ] 完整修改流程測試
- [ ] 驗證流程測試
- [ ] 錯誤處理測試
- [ ] 安全性測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ASP/SYS0000/SYS0130_FQ.ASP` - 查詢畫面
- `WEB/IMS_CORE/ASP/SYS0000/SYS0130_FB.ASP` - 修改畫面

### 8.2 相關功能
- SYS0110 - 使用者基本資料維護（完整 CRUD 功能）
- ch_passwd - 密碼修改作業（使用者自行修改密碼）

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

