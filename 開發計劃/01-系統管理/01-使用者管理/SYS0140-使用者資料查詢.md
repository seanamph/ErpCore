# SYS0140 - 使用者資料查詢 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0140
- **功能名稱**: 使用者資料查詢
- **功能描述**: 提供使用者資料的查詢功能，支援多條件查詢、排序、分頁等功能，僅供查詢，不支援新增、修改、刪除操作
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYS0000/SYS0140_FQ.aspx` (查詢)

### 1.2 業務需求
- 提供使用者資料的查詢功能
- 支援多條件組合查詢
- 支援查詢結果的排序
- 支援查詢結果的分頁顯示
- 支援查詢結果的匯出功能
- 不支援資料的新增、修改、刪除操作

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Users`
與 SYS0110 共用相同的資料表結構，請參考 SYS0110 的資料庫設計。

### 2.2 查詢視圖
本功能主要使用查詢功能，不需要額外的資料表設計。

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢使用者列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/query`
- **說明**: 查詢使用者列表，支援多條件查詢、排序、分頁
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "UserId",
    "sortOrder": "ASC",
    "filters": {
      "userId": "",
      "userName": "",
      "orgId": "",
      "status": "",
      "userType": "",
      "title": "",
      "shopId": "",
      "startDateFrom": "",
      "startDateTo": "",
      "endDateFrom": "",
      "endDateTo": "",
      "lastLoginDateFrom": "",
      "lastLoginDateTo": ""
    }
  }
  ```
- **回應格式**: 與 SYS0110 的查詢回應相同

#### 3.1.2 查詢單筆使用者
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/query`
- **說明**: 根據使用者編號查詢單筆使用者資料
- **路徑參數**:
  - `userId`: 使用者編號
- **回應格式**: 與 SYS0110 的查詢單筆回應相同

#### 3.1.3 匯出查詢結果
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/export`
- **說明**: 匯出查詢結果為 Excel 檔案
- **請求格式**: 與查詢列表的請求參數相同
- **回應格式**: 檔案下載

### 3.2 後端實作類別

#### 3.2.1 Controller: `UsersController.cs`
在現有的 `UsersController` 中新增查詢相關的端點：

```csharp
[HttpGet("query")]
public async Task<ActionResult<ApiResponse<PagedResult<UserDto>>>> QueryUsers([FromQuery] UserQueryDto query)
{
    // 實作查詢邏輯（支援多條件查詢）
}

[HttpGet("{userId}/query")]
public async Task<ActionResult<ApiResponse<UserDto>>> QueryUser(string userId)
{
    // 實作查詢單筆邏輯
}

[HttpPost("export")]
public async Task<IActionResult> ExportUsers([FromBody] UserQueryDto query)
{
    // 實作匯出邏輯
    var users = await _userService.QueryUsersAsync(query);
    var excelBytes = await _excelService.ExportUsersAsync(users);
    return File(excelBytes, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "users.xlsx");
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 使用者查詢頁面 (`UserQuery.vue`)
- **路徑**: `/system/users/query`
- **功能**: 提供使用者資料的查詢功能，支援多條件查詢、排序、分頁、匯出
- **主要元件**:
  - 查詢表單 (UserQueryForm) - 支援多條件查詢
  - 資料表格 (UserQueryTable) - 支援排序、分頁
  - 匯出按鈕
  - 詳細資料對話框 (UserDetailDialog) - 只讀模式

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`UserQueryForm.vue`)
```vue
<template>
  <el-form :model="queryForm" inline>
    <el-form-item label="使用者編號">
      <el-input v-model="queryForm.filters.userId" placeholder="請輸入使用者編號" />
    </el-form-item>
    <el-form-item label="使用者名稱">
      <el-input v-model="queryForm.filters.userName" placeholder="請輸入使用者名稱" />
    </el-form-item>
    <el-form-item label="組織">
      <el-select v-model="queryForm.filters.orgId" placeholder="請選擇組織" clearable>
        <el-option v-for="org in orgList" :key="org.orgId" :label="org.orgName" :value="org.orgId" />
      </el-select>
    </el-form-item>
    <el-form-item label="狀態">
      <el-select v-model="queryForm.filters.status" placeholder="請選擇狀態" clearable>
        <el-option label="啟用" value="A" />
        <el-option label="停用" value="I" />
        <el-option label="鎖定" value="L" />
      </el-select>
    </el-form-item>
    <el-form-item label="使用者型態">
      <el-select v-model="queryForm.filters.userType" placeholder="請選擇使用者型態" clearable>
        <el-option label="內部" value="INTERNAL" />
        <el-option label="外部" value="EXTERNAL" />
      </el-select>
    </el-form-item>
    <el-form-item label="職稱">
      <el-input v-model="queryForm.filters.title" placeholder="請輸入職稱" />
    </el-form-item>
    <el-form-item label="有效起始日（起）">
      <el-date-picker v-model="queryForm.filters.startDateFrom" type="date" placeholder="請選擇日期" />
    </el-form-item>
    <el-form-item label="有效起始日（迄）">
      <el-date-picker v-model="queryForm.filters.startDateTo" type="date" placeholder="請選擇日期" />
    </el-form-item>
    <el-form-item label="最後登入（起）">
      <el-date-picker v-model="queryForm.filters.lastLoginDateFrom" type="date" placeholder="請選擇日期" />
    </el-form-item>
    <el-form-item label="最後登入（迄）">
      <el-date-picker v-model="queryForm.filters.lastLoginDateTo" type="date" placeholder="請選擇日期" />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleQuery">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button type="success" @click="handleExport">匯出</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 查詢表格元件 (`UserQueryTable.vue`)
```vue
<template>
  <div>
    <el-table 
      :data="userList" 
      v-loading="loading"
      @sort-change="handleSortChange"
    >
      <el-table-column prop="userId" label="使用者編號" width="120" sortable="custom" />
      <el-table-column prop="userName" label="使用者名稱" width="150" sortable="custom" />
      <el-table-column prop="title" label="職稱" width="100" sortable="custom" />
      <el-table-column prop="orgName" label="組織" width="150" sortable="custom" />
      <el-table-column prop="status" label="狀態" width="80" sortable="custom">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)">
            {{ getStatusText(row.status) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="userType" label="使用者型態" width="100" sortable="custom" />
      <el-table-column prop="startDate" label="有效起始日" width="120" sortable="custom" />
      <el-table-column prop="endDate" label="有效終止日" width="120" sortable="custom" />
      <el-table-column prop="lastLoginDate" label="最後登入" width="160" sortable="custom" />
      <el-table-column prop="loginCount" label="登入次數" width="100" sortable="custom" />
      <el-table-column label="操作" width="100" fixed="right">
        <template #default="{ row }">
          <el-button type="primary" size="small" @click="handleView(row)">查看</el-button>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

### 4.3 API 呼叫 (`user.api.ts`)
在現有的 `user.api.ts` 中新增查詢相關的 API 函數：

```typescript
// 查詢使用者列表
export const queryUserList = (query: UserQueryDto) => {
  return request.get<ApiResponse<PagedResult<UserDto>>>('/api/v1/users/query', { params: query });
};

// 查詢單筆使用者
export const queryUserById = (userId: string) => {
  return request.get<ApiResponse<UserDto>>(`/api/v1/users/${userId}/query`);
};

// 匯出查詢結果
export const exportUsers = (query: UserQueryDto) => {
  return request.post('/api/v1/users/export', query, {
    responseType: 'blob'
  });
};
```

---

## 五、開發時程

### 5.1 階段一: 後端開發 (2天)
- [ ] 新增查詢相關的 API 端點
- [ ] 實作多條件查詢邏輯
- [ ] 實作匯出功能
- [ ] 單元測試

### 5.2 階段二: 前端開發 (3天)
- [ ] 查詢頁面開發
- [ ] 查詢表單元件開發（支援多條件）
- [ ] 查詢表格元件開發（支援排序）
- [ ] 匯出功能開發
- [ ] API 呼叫函數
- [ ] 元件測試

### 5.3 階段三: 整合測試 (1天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 匯出功能測試

**總計**: 6天

---

## 六、注意事項

### 6.1 功能限制
- 本功能僅提供查詢功能，不支援新增、修改、刪除操作
- 所有資料欄位均為只讀模式
- 不提供編輯相關的按鈕和功能

### 6.2 查詢功能
- 支援多條件組合查詢
- 支援模糊查詢（使用者編號、使用者名稱、職稱等）
- 支援日期範圍查詢
- 支援排序功能
- 支援分頁功能

### 6.3 匯出功能
- 支援匯出為 Excel 格式
- 匯出的資料應包含所有查詢條件下的結果
- 匯出檔案應包含表頭和格式設定

### 6.4 權限控制
- 查詢功能需要適當的權限控制
- 確保使用者只能查詢有權限查看的資料

### 6.5 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 匯出大量資料時應考慮使用背景任務

---

## 七、測試案例

### 7.1 單元測試
- [ ] 單條件查詢測試
- [ ] 多條件組合查詢測試
- [ ] 排序功能測試
- [ ] 分頁功能測試
- [ ] 匯出功能測試
- [ ] 權限檢查測試

### 7.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 匯出流程測試
- [ ] 權限檢查測試
- [ ] 錯誤處理測試
- [ ] 大量資料查詢測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYS0000/SYS0140_FQ.aspx`

### 8.2 相關功能
- SYS0110 - 使用者基本資料維護（完整 CRUD 功能）
- SYS0120 - 使用者資料瀏覽（瀏覽功能）

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

