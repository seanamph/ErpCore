# SYS0113 - 使用者基本資料維護(分店廠商部門) 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0113
- **功能名稱**: 使用者基本資料維護(分店廠商部門)
- **功能描述**: 提供使用者基本資料的新增、修改、刪除、查詢功能，特別針對總公司/分店、廠商、部門權限設定，並支援重設密碼功能
- **參考舊程式**: 
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0113.ascx`
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0113.ascx.cs`

### 1.2 業務需求
- 管理系統使用者帳號資訊
- 支援使用者總公司/分店權限設定（階層式選擇）
- 支援使用者廠商權限設定
- 支援使用者部門權限設定
- 支援使用者按鈕權限設定
- 支援重設密碼功能
- 支援使用者帳號的啟用/停用
- 記錄使用者登入資訊
- 支援密碼管理
- 支援多組織架構

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Users`
參考 `SYS0110-使用者基本資料維護.md` 的 `Users` 資料表設計

### 2.2 相關資料表

#### 2.2.1 `UserShops` - 使用者總公司/分店權限
```sql
CREATE TABLE [dbo].[UserShops] (
    [Id] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [UserId] NVARCHAR(50) NOT NULL,
    [PShopId] NVARCHAR(50) NULL, -- 總公司代號
    [ShopId] NVARCHAR(50) NULL, -- 分店代號
    [SiteId] NVARCHAR(50) NULL, -- 據點代號
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_UserShops_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_UserShops_UserId] ON [dbo].[UserShops] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_UserShops_PShopId] ON [dbo].[UserShops] ([PShopId]);
CREATE NONCLUSTERED INDEX [IX_UserShops_ShopId] ON [dbo].[UserShops] ([ShopId]);
```

#### 2.2.2 `UserVendors` - 使用者廠商權限
```sql
CREATE TABLE [dbo].[UserVendors] (
    [Id] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [UserId] NVARCHAR(50) NOT NULL,
    [VendorId] NVARCHAR(50) NOT NULL, -- 廠商代號
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_UserVendors_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_UserVendors_UserId] ON [dbo].[UserVendors] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_UserVendors_VendorId] ON [dbo].[UserVendors] ([VendorId]);
```

#### 2.2.3 `UserDepartments` - 使用者部門權限
```sql
CREATE TABLE [dbo].[UserDepartments] (
    [Id] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [UserId] NVARCHAR(50) NOT NULL,
    [DeptId] NVARCHAR(50) NOT NULL, -- 部門代號
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_UserDepartments_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_UserDepartments_UserId] ON [dbo].[UserDepartments] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_UserDepartments_DeptId] ON [dbo].[UserDepartments] ([DeptId]);
```

#### 2.2.4 `UserButtons` - 使用者按鈕權限
參考 `SYS0110-使用者基本資料維護.md` 的 `UserButtons` 資料表設計

### 2.3 資料字典

#### UserShops 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| Id | BIGINT | - | NO | IDENTITY(1,1) | 主鍵 | 自動遞增 |
| UserId | NVARCHAR | 50 | NO | - | 使用者編號 | 外鍵至Users表 |
| PShopId | NVARCHAR | 50 | YES | - | 總公司代號 | 可選擇"xx"表示全部 |
| ShopId | NVARCHAR | 50 | YES | - | 分店代號 | - |
| SiteId | NVARCHAR | 50 | YES | - | 據點代號 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |

#### UserVendors 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| Id | BIGINT | - | NO | IDENTITY(1,1) | 主鍵 | 自動遞增 |
| UserId | NVARCHAR | 50 | NO | - | 使用者編號 | 外鍵至Users表 |
| VendorId | NVARCHAR | 50 | NO | - | 廠商代號 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |

#### UserDepartments 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| Id | BIGINT | - | NO | IDENTITY(1,1) | 主鍵 | 自動遞增 |
| UserId | NVARCHAR | 50 | NO | - | 使用者編號 | 外鍵至Users表 |
| DeptId | NVARCHAR | 50 | NO | - | 部門代號 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢使用者列表
參考 `SYS0110-使用者基本資料維護.md`

#### 3.1.2 查詢單筆使用者（含分店廠商部門資訊）
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/detail`
- **說明**: 根據使用者編號查詢單筆使用者資料，包含總公司/分店、廠商、部門等權限資訊
- **路徑參數**:
  - `userId`: 使用者編號
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "userId": "U001",
      "userName": "張三",
      "shops": [
        {
          "pShopId": "PS001",
          "pShopName": "總公司A",
          "shopId": "SH001",
          "shopName": "分店A",
          "siteId": "SI001",
          "siteName": "據點A"
        }
      ],
      "vendors": [
        {
          "vendorId": "V001",
          "vendorName": "廠商A"
        }
      ],
      "departments": [
        {
          "deptId": "D001",
          "deptName": "部門A"
        }
      ],
      "buttons": [
        {
          "buttonId": "B001",
          "buttonName": "按鈕A"
        }
      ]
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 新增使用者（含分店廠商部門設定）
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users`
- **說明**: 新增使用者資料，包含總公司/分店、廠商、部門、按鈕權限設定
- **請求格式**:
  ```json
  {
    "userId": "U001",
    "userName": "張三",
    "userPassword": "Password123!",
    "title": "經理",
    "orgId": "ORG001",
    "startDate": "2024-01-01",
    "endDate": null,
    "status": "A",
    "userType": "INTERNAL",
    "notes": "備註",
    "userPriority": 1,
    "shopId": "SHOP001",
    "shops": [
      {
        "pShopId": "PS001",
        "shopId": "SH001",
        "siteId": "SI001"
      }
    ],
    "vendors": [
      {
        "vendorId": "V001"
      }
    ],
    "departments": [
      {
        "deptId": "D001"
      }
    ],
    "buttons": [
      {
        "buttonId": "B001"
      }
    ]
  }
  ```

#### 3.1.4 修改使用者（含分店廠商部門設定）
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/users/{userId}`
- **說明**: 修改使用者資料，包含總公司/分店、廠商、部門、按鈕權限設定
- **路徑參數**:
  - `userId`: 使用者編號
- **請求格式**: 同新增

#### 3.1.5 重設密碼
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/{userId}/reset-password`
- **說明**: 管理員重設使用者密碼（自動產生或指定新密碼）
- **路徑參數**:
  - `userId`: 使用者編號
- **請求格式**:
  ```json
  {
    "newPassword": "NewPassword123!",
    "autoGenerate": false
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "密碼重設成功",
    "data": {
      "newPassword": "NewPassword123!"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.6 查詢總公司列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/shops/parent`
- **說明**: 查詢總公司列表，用於下拉選單
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": [
      {
        "pShopId": "PS001",
        "pShopName": "總公司A"
      }
    ],
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.7 查詢分店列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/shops`
- **說明**: 根據總公司查詢分店列表
- **請求參數**:
  - `pShopId`: 總公司代號
- **回應格式**: 類似總公司

#### 3.1.8 查詢廠商列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/vendors`
- **說明**: 查詢廠商列表，用於下拉選單
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": [
      {
        "vendorId": "V001",
        "vendorName": "廠商A"
      }
    ],
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.9 查詢部門列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/departments`
- **說明**: 查詢部門列表，用於下拉選單
- **回應格式**: 類似廠商

### 3.2 後端實作類別

#### 3.2.1 Controller: `UsersController.cs`
參考 `SYS0110-使用者基本資料維護.md`，並新增以下方法：
```csharp
[HttpPost("{userId}/reset-password")]
public async Task<ActionResult<ApiResponse<ResetPasswordResultDto>>> ResetPassword(string userId, [FromBody] ResetPasswordDto dto)
{
    // 實作重設密碼邏輯
}

[HttpGet("shops/parent")]
public async Task<ActionResult<ApiResponse<List<ParentShopDto>>>> GetParentShops()
{
    // 實作查詢總公司邏輯
}

[HttpGet("shops")]
public async Task<ActionResult<ApiResponse<List<ShopDto>>>> GetShops([FromQuery] string pShopId)
{
    // 實作查詢分店邏輯
}

[HttpGet("vendors")]
public async Task<ActionResult<ApiResponse<List<VendorDto>>>> GetVendors()
{
    // 實作查詢廠商邏輯
}

[HttpGet("departments")]
public async Task<ActionResult<ApiResponse<List<DepartmentDto>>>> GetDepartments()
{
    // 實作查詢部門邏輯
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 使用者列表頁面 (`UserList.vue`)
參考 `SYS0110-使用者基本資料維護.md`

#### 4.1.2 使用者詳細頁面 (`UserDetail.vue`)
參考 `SYS0110-使用者基本資料維護.md`，並新增總公司/分店、廠商、部門設定區塊

### 4.2 UI 元件設計

#### 4.2.1 新增/修改對話框 (`UserDialog.vue`)
參考 `SYS0110-使用者基本資料維護.md`，並新增以下區塊：

```vue
<template>
  <el-dialog
    :title="dialogTitle"
    v-model="visible"
    width="1200px"
    @close="handleClose"
  >
    <el-form :model="form" :rules="rules" ref="formRef" label-width="120px">
      <!-- 基本資料區塊 -->
      <!-- 參考 SYS0110 -->
      
      <!-- 總公司/分店權限設定區塊 -->
      <el-divider>總公司/分店權限設定</el-divider>
      <el-table :data="form.shops" border>
        <el-table-column type="selection" width="55" />
        <el-table-column label="總公司" width="150">
          <template #default="{ row, $index }">
            <el-select 
              v-model="row.pShopId" 
              placeholder="請選擇"
              @change="handlePShopChange($index)"
            >
              <el-option label="全部" value="xx" />
              <el-option 
                v-for="item in pShopList" 
                :key="item.pShopId" 
                :label="item.pShopName" 
                :value="item.pShopId" 
              />
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="分店" width="150">
          <template #default="{ row, $index }">
            <el-select 
              v-model="row.shopId" 
              placeholder="請選擇"
              :disabled="!row.pShopId || row.pShopId === 'xx'"
              @change="handleShopChange($index)"
            >
              <el-option 
                v-for="item in getShopList(row.pShopId)" 
                :key="item.shopId" 
                :label="item.shopName" 
                :value="item.shopId" 
              />
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="據點" width="150">
          <template #default="{ row }">
            <el-select 
              v-model="row.siteId" 
              placeholder="請選擇"
              :disabled="!row.shopId"
            >
              <el-option 
                v-for="item in getSiteList(row.shopId)" 
                :key="item.siteId" 
                :label="item.siteName" 
                :value="item.siteId" 
              />
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="100">
          <template #default="{ $index }">
            <el-button type="danger" size="small" @click="removeShop($index)">刪除</el-button>
          </template>
        </el-table-column>
      </el-table>
      <el-button type="primary" size="small" @click="addShop" style="margin-top: 10px;">新增總公司/分店</el-button>
      
      <!-- 廠商權限設定區塊 -->
      <el-divider>廠商權限設定</el-divider>
      <el-table :data="form.vendors" border>
        <el-table-column type="selection" width="55" />
        <el-table-column label="廠商" width="200">
          <template #default="{ row }">
            <el-select v-model="row.vendorId" placeholder="請選擇">
              <el-option 
                v-for="item in vendorList" 
                :key="item.vendorId" 
                :label="item.vendorName" 
                :value="item.vendorId" 
              />
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="100">
          <template #default="{ $index }">
            <el-button type="danger" size="small" @click="removeVendor($index)">刪除</el-button>
          </template>
        </el-table-column>
      </el-table>
      <el-button type="primary" size="small" @click="addVendor" style="margin-top: 10px;">新增廠商</el-button>
      
      <!-- 部門權限設定區塊 -->
      <el-divider>部門權限設定</el-divider>
      <el-table :data="form.departments" border>
        <el-table-column type="selection" width="55" />
        <el-table-column label="部門" width="200">
          <template #default="{ row }">
            <el-select v-model="row.deptId" placeholder="請選擇">
              <el-option 
                v-for="item in departmentList" 
                :key="item.deptId" 
                :label="item.deptName" 
                :value="item.deptId" 
              />
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="100">
          <template #default="{ $index }">
            <el-button type="danger" size="small" @click="removeDepartment($index)">刪除</el-button>
          </template>
        </el-table-column>
      </el-table>
      <el-button type="primary" size="small" @click="addDepartment" style="margin-top: 10px;">新增部門</el-button>
      
      <!-- 按鈕權限設定區塊 -->
      <el-divider>按鈕權限設定</el-divider>
      <el-table :data="form.buttons" border>
        <el-table-column type="selection" width="55" />
        <el-table-column label="按鈕" width="200">
          <template #default="{ row }">
            <el-select v-model="row.buttonId" placeholder="請選擇">
              <el-option 
                v-for="item in buttonList" 
                :key="item.buttonId" 
                :label="item.buttonName" 
                :value="item.buttonId" 
              />
            </el-select>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="100">
          <template #default="{ $index }">
            <el-button type="danger" size="small" @click="removeButton($index)">刪除</el-button>
          </template>
        </el-table-column>
      </el-table>
      <el-button type="primary" size="small" @click="addButton" style="margin-top: 10px;">新增按鈕</el-button>
    </el-form>
    <template #footer>
      <el-button @click="handleClose">取消</el-button>
      <el-button type="primary" @click="handleSubmit">確定</el-button>
    </template>
  </el-dialog>
</template>
```

#### 4.2.2 重設密碼對話框 (`ResetPasswordDialog.vue`)
```vue
<template>
  <el-dialog
    title="重設密碼"
    v-model="visible"
    width="500px"
    @close="handleClose"
  >
    <el-form :model="form" :rules="rules" ref="formRef" label-width="120px">
      <el-form-item label="使用者編號">
        <el-input v-model="userId" disabled />
      </el-form-item>
      <el-form-item label="自動產生密碼">
        <el-switch v-model="form.autoGenerate" @change="handleAutoGenerateChange" />
      </el-form-item>
      <el-form-item label="新密碼" prop="newPassword" v-if="!form.autoGenerate">
        <el-input v-model="form.newPassword" type="password" placeholder="請輸入新密碼" />
      </el-form-item>
      <el-form-item label="確認密碼" prop="confirmPassword" v-if="!form.autoGenerate">
        <el-input v-model="form.confirmPassword" type="password" placeholder="請再次輸入密碼" />
      </el-form-item>
      <el-form-item v-if="form.autoGenerate && resetResult">
        <el-alert
          :title="`新密碼: ${resetResult.newPassword}`"
          type="success"
          :closable="false"
        />
      </el-form-item>
    </el-form>
    <template #footer>
      <el-button @click="handleClose">取消</el-button>
      <el-button type="primary" @click="handleSubmit">確定</el-button>
    </template>
  </el-dialog>
</template>
```

### 4.3 API 呼叫 (`user.api.ts`)
參考 `SYS0110-使用者基本資料維護.md`，並新增以下函數：

```typescript
export const resetPassword = (userId: string, data: ResetPasswordDto) => {
  return request.post<ApiResponse<ResetPasswordResultDto>>(`/api/v1/users/${userId}/reset-password`, data);
};

export const getParentShops = () => {
  return request.get<ApiResponse<List<ParentShopDto>>>('/api/v1/shops/parent');
};

export const getShops = (pShopId: string) => {
  return request.get<ApiResponse<List<ShopDto>>>(`/api/v1/shops?pShopId=${pShopId}`);
};

export const getVendors = () => {
  return request.get<ApiResponse<List<VendorDto>>>('/api/v1/vendors');
};

export const getDepartments = () => {
  return request.get<ApiResponse<List<DepartmentDto>>>('/api/v1/departments');
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (1.5天)
- [ ] 建立 UserShops 資料表
- [ ] 建立 UserVendors 資料表
- [ ] 建立 UserDepartments 資料表
- [ ] 建立索引
- [ ] 建立外鍵約束
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (4天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 驗證邏輯實作
- [ ] 重設密碼邏輯實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (4天)
- [ ] API 呼叫函數
- [ ] 列表頁面開發
- [ ] 新增/修改對話框開發（含分店廠商部門設定）
- [ ] 重設密碼對話框開發
- [ ] 查詢表單開發
- [ ] 資料表格開發
- [ ] 表單驗證
- [ ] 元件測試

### 5.4 階段四: 整合測試 (1.5天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 安全性測試

### 5.5 階段五: 文件與部署 (1天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 12天

---

## 六、注意事項

### 6.1 業務邏輯
- 總公司/分店設定為階層式（總公司→分店→據點），選擇上層時需載入下層選項
- 總公司可選擇「全部」選項（值為"xx"），選擇全部時分店和據點不可選擇
- 廠商、部門、按鈕可多選
- 刪除使用者時需同步刪除相關的總公司/分店、廠商、部門、按鈕權限
- 重設密碼時，若選擇自動產生，系統需產生符合複雜度要求的密碼

### 6.2 資料驗證
- 總公司/分店設定必須符合階層關係
- 廠商、部門、按鈕代號必須存在
- 重設密碼時，新密碼必須符合複雜度要求

### 6.3 安全性
- 重設密碼功能必須記錄操作日誌
- 自動產生的密碼必須安全儲存並提供給管理員

### 6.4 效能
- 總公司/分店下拉選單需使用快取機制
- 大量資料查詢必須使用分頁

---

## 七、測試案例

### 7.1 單元測試
- [ ] 新增使用者（含分店廠商部門）成功
- [ ] 修改使用者（含分店廠商部門）成功
- [ ] 查詢使用者詳細資料（含分店廠商部門）成功
- [ ] 重設密碼成功
- [ ] 自動產生密碼成功
- [ ] 總公司/分店階層查詢正確

### 7.2 整合測試
- [ ] 完整 CRUD 流程測試（含分店廠商部門）
- [ ] 總公司/分店階層選擇流程測試
- [ ] 重設密碼流程測試
- [ ] 資料驗證測試
- [ ] 錯誤處理測試

---

## 八、參考資料

### 8.1 舊程式碼
- `IMS3/HANSHIN/IMS3/SYS0000/SYS0113.ascx`
- `IMS3/HANSHIN/IMS3/SYS0000/SYS0113.ascx.cs`

### 8.2 相關功能
- `SYS0110-使用者基本資料維護.md` - 基本使用者管理功能

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

