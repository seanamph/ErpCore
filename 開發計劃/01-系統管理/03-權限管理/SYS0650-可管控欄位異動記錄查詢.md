# SYS0650 - 可管控欄位異動記錄查詢 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0650
- **功能名稱**: 可管控欄位異動記錄查詢
- **功能描述**: 提供可管控欄位資料異動記錄的查詢功能，可查詢指定使用者或欄位的異動歷史記錄
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0650_FQ.asp` (查詢條件頁面)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0650_FB.ASP` (查詢結果頁面)

### 1.2 業務需求
- 查詢可管控欄位資料的異動記錄
- 支援依異動使用者代碼查詢
- 支援依被異動的使用者代碼查詢
- 支援依欄位代碼查詢
- 支援依日期範圍查詢
- 顯示異動詳細資訊（異動欄位、異動前的值、異動後的值）
- 顯示異動狀態（新增、刪除、修改）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `ChangeLogs` (對應舊系統 `MNG_LOG`)

```sql
CREATE TABLE [dbo].[ChangeLogs] (
    [LogId] BIGINT NOT NULL IDENTITY(1,1) PRIMARY KEY,
    [ProgramId] NVARCHAR(50) NOT NULL, -- 程式代碼 (SYS0510)
    [ChangeUserId] NVARCHAR(50) NULL, -- 異動使用者代碼 (CH_USER_ID)
    [ChangeDate] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 異動時間 (CH_DATE)
    [ChangeStatus] NVARCHAR(10) NOT NULL, -- 異動狀態: 1=新增, 2=刪除, 3=修改 (CH_STATUS)
    [ChangeField] NVARCHAR(500) NULL, -- 異動欄位名稱 (CH_FIELD)
    [OldValue] NVARCHAR(MAX) NULL, -- 異動前的值 (OLD_VALUE)
    [NewValue] NVARCHAR(MAX) NULL, -- 異動後的值 (NEW_VALUE)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_ChangeLogs] PRIMARY KEY CLUSTERED ([LogId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ProgramId] ON [dbo].[ChangeLogs] ([ProgramId]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ChangeUserId] ON [dbo].[ChangeLogs] ([ChangeUserId]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ChangeDate] ON [dbo].[ChangeLogs] ([ChangeDate]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ProgramId_ChangeDate] ON [dbo].[ChangeLogs] ([ProgramId], [ChangeDate]);
```

### 2.2 相關資料表

#### 2.2.1 `Users` - 使用者主檔
- 用於查詢使用者名稱
- 參考: `開發計劃/01-系統管理/01-使用者管理/SYS0110-使用者基本資料維護.md`

#### 2.2.2 `ControllableFields` - 可管控欄位表
- 用於查詢欄位資訊
- 參考: `開發計劃/01-系統管理/03-權限管理/SYS0510-可管控欄位資料維護.md`

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| LogId | BIGINT | - | NO | - | 主鍵 | IDENTITY(1,1) |
| ProgramId | NVARCHAR | 50 | NO | - | 程式代碼 | SYS0510 |
| ChangeUserId | NVARCHAR | 50 | YES | - | 異動使用者代碼 | 外鍵至Users |
| ChangeDate | DATETIME2 | - | NO | GETDATE() | 異動時間 | - |
| ChangeStatus | NVARCHAR | 10 | NO | - | 異動狀態 | 1=新增, 2=刪除, 3=修改 |
| ChangeField | NVARCHAR | 500 | YES | - | 異動欄位名稱 | - |
| OldValue | NVARCHAR(MAX) | - | YES | - | 異動前的值 | - |
| NewValue | NVARCHAR(MAX) | - | YES | - | 異動後的值 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢可管控欄位異動記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/change-logs/controllable-fields`
- **說明**: 查詢可管控欄位異動記錄列表，支援分頁、排序、篩選
- **請求參數**: 標準查詢參數
- **回應格式**: 標準列表回應格式

#### 3.1.2 查詢單筆可管控欄位異動記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/change-logs/controllable-fields/{logId}`
- **說明**: 根據主鍵查詢單筆可管控欄位異動記錄
- **回應格式**: 標準單筆回應格式

#### 3.1.3 匯出可管控欄位異動記錄報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/change-logs/controllable-fields/export`
- **說明**: 匯出可管控欄位異動記錄報表 (Excel/PDF)
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 可管控欄位異動記錄查詢頁面 (`ControllableFieldChangeLogQuery.vue`)
- **路徑**: `/system/change-logs/controllable-fields`
- **功能**: 顯示可管控欄位異動記錄查詢表單與結果列表
- **主要元件**:
  - 查詢表單 (ControllableFieldChangeLogSearchForm)
  - 資料表格 (ControllableFieldChangeLogDataTable)
  - 匯出按鈕

### 4.2 主要元件

#### 4.2.1 查詢表單元件
- 異動使用者代碼（可選擇）
- 被異動使用者代碼（可選擇）
- 欄位代碼（可選擇）
- 日期範圍（必填）
- 查詢、重置、匯出按鈕

#### 4.2.2 資料表格元件
- 顯示異動時間、異動者、異動狀態、異動欄位、異動前的值、異動後的值
- 支援排序、分頁

---

## 五、開發時程

**總計**: 9天
- 資料庫設計: 1天
- 後端API開發: 3天
- 前端UI開發: 3天
- 測試與修正: 2天

---

## 六、注意事項

### 6.1 安全性
- 必須驗證使用者權限
- 敏感資料必須加密傳輸

### 6.2 效能
- 查詢結果需支援分頁
- 大量資料需使用索引優化
- 日期範圍查詢需使用索引優化

### 6.3 業務邏輯
- 查詢條件需包含 SYS0510 程式代碼
- 異動前的值和異動後的值需解析並顯示欄位資訊
- 支援依欄位代碼模糊查詢
- 日期範圍查詢需包含結束日期當天

---

## 七、測試案例

### 7.1 單元測試
- [ ] 查詢可管控欄位異動記錄成功
- [ ] 依異動使用者代碼查詢成功
- [ ] 依被異動使用者代碼查詢成功
- [ ] 依欄位代碼查詢成功
- [ ] 依日期範圍查詢成功
- [ ] 匯出 Excel 報表成功
- [ ] 匯出 PDF 報表成功

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ASP/SYS0000/SYS0650_FQ.asp`
- `WEB/IMS_CORE/ASP/SYS0000/SYS0650_FB.ASP`

### 8.2 相關功能
- SYS0510 - 可管控欄位資料維護
- SYS0610 - 使用者基本資料異動查詢
- SYS0620 - 角色基本資料異動查詢
- SYS0630 - 使用者角色對應設定異動查詢
- SYS0640 - 系統權限異動記錄查詢

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

