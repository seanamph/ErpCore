# SYS0731 - 角色系統權限列表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0731
- **功能名稱**: 角色系統權限列表
- **功能描述**: 查詢指定角色的系統權限列表，以報表形式顯示該角色擁有的系統、選單、作業及按鈕權限的完整結構
- **參考舊程式**: 
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0731_PR.aspx` (報表)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0731_PR.aspx.cs` (報表後端)
  - `WEB/IMS_CORE/SYS0000/SYS0731_PR.rdlc` (報表定義)
  - `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_USER_ROLE.cs` (GetUserRoleButton方法)

### 1.2 業務需求
- 支援依角色代碼查詢系統權限列表
- 顯示系統、選單、作業、按鈕的階層式權限結構
- 顯示角色的基本資訊
- 支援報表列印功能
- 支援報表匯出功能（Excel、PDF）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

本功能為查詢報表功能，主要使用以下資料表進行查詢：

#### 2.1.1 `Roles` - 角色主檔
- 參考: `開發計劃/01-系統管理/02-角色管理/SYS0210-角色基本資料維護.md`

#### 2.1.2 `Systems` - 系統主檔
- 參考: `開發計劃/01-系統管理/04-系統設定/SYS0410-主系統項目資料維護.md`

#### 2.1.3 `Menus` - 選單主檔
```sql
CREATE TABLE [dbo].[Menus] (
    [MenuId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [SystemId] NVARCHAR(50) NOT NULL,
    [MenuName] NVARCHAR(100) NOT NULL,
    [MenuNote] NVARCHAR(500) NULL,
    [ParentMenuId] NVARCHAR(50) NULL,
    [SortOrder] INT NULL DEFAULT 0,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Menus] PRIMARY KEY CLUSTERED ([MenuId] ASC),
    CONSTRAINT [FK_Menus_Systems] FOREIGN KEY ([SystemId]) REFERENCES [dbo].[Systems] ([SystemId]),
    CONSTRAINT [FK_Menus_ParentMenu] FOREIGN KEY ([ParentMenuId]) REFERENCES [dbo].[Menus] ([MenuId])
);
```

#### 2.1.4 `Programs` - 作業主檔
```sql
CREATE TABLE [dbo].[Programs] (
    [ProgramId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [MenuId] NVARCHAR(50) NOT NULL,
    [ProgramName] NVARCHAR(100) NOT NULL,
    [ProgramNote] NVARCHAR(500) NULL,
    [ProgramUrl] NVARCHAR(500) NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [SortOrder] INT NULL DEFAULT 0,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Programs] PRIMARY KEY CLUSTERED ([ProgramId] ASC),
    CONSTRAINT [FK_Programs_Menus] FOREIGN KEY ([MenuId]) REFERENCES [dbo].[Menus] ([MenuId])
);
```

#### 2.1.5 `Buttons` - 按鈕主檔
```sql
CREATE TABLE [dbo].[Buttons] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [ProgramId] NVARCHAR(50) NOT NULL,
    [PageId] NVARCHAR(50) NULL,
    [ButtonId] NVARCHAR(50) NOT NULL,
    [ButtonName] NVARCHAR(100) NOT NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [SortOrder] INT NULL DEFAULT 0,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_Buttons_Programs] FOREIGN KEY ([ProgramId]) REFERENCES [dbo].[Programs] ([ProgramId])
);
```

#### 2.1.6 `RoleButtons` - 角色按鈕權限
```sql
CREATE TABLE [dbo].[RoleButtons] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [RoleId] NVARCHAR(50) NULL,
    [UserId] NVARCHAR(50) NULL,
    [ButtonKey] BIGINT NOT NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_RoleButtons_Roles] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[Roles] ([RoleId]) ON DELETE CASCADE,
    CONSTRAINT [FK_RoleButtons_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE,
    CONSTRAINT [FK_RoleButtons_Buttons] FOREIGN KEY ([ButtonKey]) REFERENCES [dbo].[Buttons] ([TKey]),
    CONSTRAINT [CK_RoleButtons_UserOrRole] CHECK (([RoleId] IS NOT NULL AND [UserId] IS NULL) OR ([RoleId] IS NULL AND [UserId] IS NOT NULL))
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_RoleButtons_RoleId] ON [dbo].[RoleButtons] ([RoleId]);
CREATE NONCLUSTERED INDEX [IX_RoleButtons_ButtonKey] ON [dbo].[RoleButtons] ([ButtonKey]);
```

### 2.2 查詢視圖 (View)

為了方便查詢，建議建立以下視圖：

#### 2.2.1 `V_RoleSystemPermission` - 角色系統權限視圖
```sql
CREATE VIEW [dbo].[V_RoleSystemPermission] AS
SELECT 
    R.RoleId AS ROLE_ID,
    R.RoleName AS ROLE_NAME,
    S.SystemId AS SYS_ID,
    S.SystemName AS SYS_NAME,
    M.MenuId AS MENU_ID,
    M.MenuName AS MENU_NAME,
    P.ProgramId AS PROG_ID,
    P.ProgramName AS PROG_NAME,
    B.TKey AS BUTTON_KEY,
    B.ButtonId AS BUTTON_ID,
    B.ButtonName AS BUTTON_NAME,
    B.PageId AS PAGE_ID
FROM [dbo].[RoleButtons] RB
INNER JOIN [dbo].[Roles] R ON RB.RoleId = R.RoleId
INNER JOIN [dbo].[Buttons] B ON RB.ButtonKey = B.TKey
INNER JOIN [dbo].[Programs] P ON B.ProgramId = P.ProgramId
INNER JOIN [dbo].[Menus] M ON P.MenuId = M.MenuId
INNER JOIN [dbo].[Systems] S ON M.SystemId = S.SystemId
WHERE RB.RoleId IS NOT NULL
  AND RB.UserId IS NULL
  AND B.Status = '1' 
  AND P.Status = '1'
  AND M.Status = '1'
  AND S.Status = 'A';
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| RoleId | NVARCHAR | 50 | NO | - | 角色代碼 | 主鍵，外鍵至Roles |
| RoleName | NVARCHAR | 100 | NO | - | 角色名稱 | - |
| SystemId | NVARCHAR | 50 | NO | - | 系統代碼 | 外鍵至Systems |
| SystemName | NVARCHAR | 100 | NO | - | 系統名稱 | - |
| MenuId | NVARCHAR | 50 | NO | - | 選單代碼 | 外鍵至Menus |
| MenuName | NVARCHAR | 100 | NO | - | 選單名稱 | - |
| ProgramId | NVARCHAR | 50 | NO | - | 作業代碼 | 外鍵至Programs |
| ProgramName | NVARCHAR | 100 | NO | - | 作業名稱 | - |
| ButtonKey | BIGINT | - | NO | - | 按鈕主鍵 | 外鍵至Buttons |
| ButtonId | NVARCHAR | 50 | NO | - | 按鈕代碼 | - |
| ButtonName | NVARCHAR | 100 | NO | - | 按鈕名稱 | - |
| PageId | NVARCHAR | 50 | YES | - | 頁面代碼 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢角色系統權限列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/role-system-permissions/list`
- **說明**: 查詢指定角色的系統權限列表
- **請求參數**:
  ```json
  {
    "roleId": "string",        // 角色代碼（必填）
    "systemId": "string",      // 系統代碼（可選，篩選條件）
    "menuId": "string",        // 選單代碼（可選，篩選條件）
    "programId": "string"      // 作業代碼（可選，篩選條件）
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "roleId": "ROLE001",
      "roleName": "系統管理員",
      "permissions": [
        {
          "systemId": "SYS0000",
          "systemName": "系統管理",
          "menus": [
            {
              "menuId": "MENU001",
              "menuName": "使用者管理",
              "programs": [
                {
                  "programId": "SYS0110",
                  "programName": "使用者基本資料維護",
                  "buttons": [
                    {
                      "buttonId": "BTN001",
                      "buttonName": "新增",
                      "pageId": "FI"
                    },
                    {
                      "buttonId": "BTN002",
                      "buttonName": "修改",
                      "pageId": "FU"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出角色系統權限報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/role-system-permissions/export`
- **說明**: 匯出角色系統權限報表（Excel、PDF）
- **請求參數**:
  ```json
  {
    "roleId": "string",
    "exportFormat": "Excel|PDF",
    "filters": {
      "systemId": "string",
      "menuId": "string",
      "programId": "string"
    }
  }
  ```
- **回應格式**: 檔案下載

### 3.2 資料傳輸物件 (DTO)

#### 3.2.1 `RoleSystemPermissionListRequestDto`
```csharp
public class RoleSystemPermissionListRequestDto
{
    [Required(ErrorMessage = "角色代碼為必填")]
    public string RoleId { get; set; } = string.Empty;
    
    public string? SystemId { get; set; }
    public string? MenuId { get; set; }
    public string? ProgramId { get; set; }
}
```

#### 3.2.2 `RoleSystemPermissionListResponseDto`
```csharp
public class RoleSystemPermissionListResponseDto
{
    public string RoleId { get; set; } = string.Empty;
    public string RoleName { get; set; } = string.Empty;
    public List<SystemPermissionDto> Permissions { get; set; } = new();
}

public class SystemPermissionDto
{
    public string SystemId { get; set; } = string.Empty;
    public string SystemName { get; set; } = string.Empty;
    public List<MenuPermissionDto> Menus { get; set; } = new();
}

public class MenuPermissionDto
{
    public string MenuId { get; set; } = string.Empty;
    public string MenuName { get; set; } = string.Empty;
    public List<ProgramPermissionDto> Programs { get; set; } = new();
}

public class ProgramPermissionDto
{
    public string ProgramId { get; set; } = string.Empty;
    public string ProgramName { get; set; } = string.Empty;
    public List<ButtonPermissionDto> Buttons { get; set; } = new();
}

public class ButtonPermissionDto
{
    public string ButtonId { get; set; } = string.Empty;
    public string ButtonName { get; set; } = string.Empty;
    public string? PageId { get; set; }
}
```

### 3.3 Service 層設計

#### 3.3.1 `IRoleSystemPermissionService`
```csharp
public interface IRoleSystemPermissionService
{
    Task<RoleSystemPermissionListResponseDto> GetRoleSystemPermissionListAsync(
        RoleSystemPermissionListRequestDto request, 
        CancellationToken cancellationToken = default);
    
    Task<byte[]> ExportRoleSystemPermissionReportAsync(
        RoleSystemPermissionListRequestDto request, 
        string exportFormat, 
        CancellationToken cancellationToken = default);
}
```

#### 3.3.2 `RoleSystemPermissionService` 實作重點
- 根據角色代碼查詢權限
- 組織階層式權限結構（系統→選單→作業→按鈕）
- 支援篩選條件
- 按鈕權限需依頁面代碼分組顯示

### 3.4 Repository 層設計

#### 3.4.1 `IRoleSystemPermissionRepository`
```csharp
public interface IRoleSystemPermissionRepository
{
    Task<Role?> GetRoleByIdAsync(string roleId, CancellationToken cancellationToken = default);
    Task<IEnumerable<RoleSystemPermissionQueryResult>> GetRoleSystemPermissionsAsync(
        string roleId, 
        string? systemId = null,
        string? menuId = null,
        string? programId = null,
        CancellationToken cancellationToken = default);
}
```

#### 3.4.2 `RoleSystemPermissionQueryResult`
```csharp
public class RoleSystemPermissionQueryResult
{
    public string ROLE_ID { get; set; } = string.Empty;
    public string ROLE_NAME { get; set; } = string.Empty;
    public string SYS_ID { get; set; } = string.Empty;
    public string SYS_NAME { get; set; } = string.Empty;
    public string MENU_ID { get; set; } = string.Empty;
    public string MENU_NAME { get; set; } = string.Empty;
    public string PROG_ID { get; set; } = string.Empty;
    public string PROG_NAME { get; set; } = string.Empty;
    public string BUTTON_ID { get; set; } = string.Empty;
    public string BUTTON_NAME { get; set; } = string.Empty;
    public string? PAGE_ID { get; set; }
}
```

---

## 四、前端 UI 設計

### 4.1 查詢頁面 (`RoleSystemPermissionListQuery.vue`)

#### 4.1.1 頁面結構
- **查詢條件區塊**
  - 角色代碼輸入框（支援自動完成，必填）
  - 系統代碼下拉選單（可選）
  - 選單代碼下拉選單（可選）
  - 作業代碼下拉選單（可選）
  - 查詢按鈕
  - 重置按鈕
  - 匯出按鈕（Excel、PDF）

#### 4.1.2 功能需求
- 角色代碼為必填欄位
- 支援角色代碼自動完成（參考 `ROLE_LIST`）
- 查詢結果以階層式樹狀結構顯示
- 支援展開/收合節點
- 支援報表列印
- 支援報表匯出（Excel、PDF）

### 4.2 報表顯示頁面 (`RoleSystemPermissionListReport.vue`)

#### 4.2.1 頁面結構
- **報表標題區塊**
  - 角色資訊（角色代碼、角色名稱）
  - 查詢時間

- **報表內容區塊**
  - 階層式表格顯示
    - 第一層：系統（系統代碼、系統名稱）
    - 第二層：選單（選單代碼、選單名稱）
    - 第三層：作業（作業代碼、作業名稱）
    - 第四層：按鈕（按鈕名稱列表，依頁面代碼分組）

#### 4.2.2 功能需求
- 支援報表列印
- 支援報表匯出（Excel、PDF）
- 支援分頁顯示（如果資料量大）

### 4.3 元件設計

#### 4.3.1 `RoleSystemPermissionTree.vue`
- 樹狀結構顯示角色系統權限
- 支援展開/收合
- 支援搜尋過濾

#### 4.3.2 `RoleSystemPermissionTable.vue`
- 表格形式顯示角色系統權限
- 支援排序
- 支援匯出

### 4.4 API 呼叫 (`role-system-permission.api.ts`)
```typescript
import request from '@/utils/request';

export interface RoleSystemPermissionListRequestDto {
  roleId: string;
  systemId?: string;
  menuId?: string;
  programId?: string;
}

export interface RoleSystemPermissionListResponseDto {
  roleId: string;
  roleName: string;
  permissions: SystemPermissionDto[];
}

// API 函數
export const getRoleSystemPermissionList = (request: RoleSystemPermissionListRequestDto) => {
  return request.get<ApiResponse<RoleSystemPermissionListResponseDto>>(
    '/api/v1/role-system-permissions/list',
    { params: request }
  );
};

export const exportRoleSystemPermissionReport = (
  request: RoleSystemPermissionListRequestDto,
  format: 'Excel' | 'PDF'
) => {
  return request.post<Blob>(
    '/api/v1/role-system-permissions/export',
    { request, exportFormat: format },
    { responseType: 'blob' }
  );
};
```

---

## 五、後端實作類別

### 5.1 Controller: `RoleSystemPermissionController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/role-system-permissions")]
    [Authorize]
    public class RoleSystemPermissionController : ControllerBase
    {
        private readonly IRoleSystemPermissionService _roleSystemPermissionService;
        private readonly ILogger<RoleSystemPermissionController> _logger;
        
        public RoleSystemPermissionController(
            IRoleSystemPermissionService roleSystemPermissionService,
            ILogger<RoleSystemPermissionController> logger)
        {
            _roleSystemPermissionService = roleSystemPermissionService;
            _logger = logger;
        }
        
        [HttpGet("list")]
        public async Task<ActionResult<ApiResponse<RoleSystemPermissionListResponseDto>>> GetRoleSystemPermissionList(
            [FromQuery] RoleSystemPermissionListRequestDto request,
            CancellationToken cancellationToken = default)
        {
            try
            {
                var result = await _roleSystemPermissionService.GetRoleSystemPermissionListAsync(request, cancellationToken);
                
                return Ok(new ApiResponse<RoleSystemPermissionListResponseDto>
                {
                    Success = true,
                    Data = result,
                    Message = "查詢成功"
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "查詢角色系統權限列表失敗");
                return StatusCode(500, new ApiResponse<RoleSystemPermissionListResponseDto>
                {
                    Success = false,
                    Message = "查詢角色系統權限列表失敗"
                });
            }
        }
        
        [HttpPost("export")]
        public async Task<IActionResult> ExportRoleSystemPermissionReport(
            [FromBody] RoleSystemPermissionExportRequestDto request,
            CancellationToken cancellationToken = default)
        {
            try
            {
                var fileBytes = await _roleSystemPermissionService.ExportRoleSystemPermissionReportAsync(
                    request.Request,
                    request.ExportFormat,
                    cancellationToken);

                var contentType = request.ExportFormat == "Excel" 
                    ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    : "application/pdf";
                
                var fileName = $"角色系統權限列表_{request.Request.RoleId}_{DateTime.Now:yyyyMMddHHmmss}.{(request.ExportFormat == "Excel" ? "xlsx" : "pdf")}";

                return File(fileBytes, contentType, fileName);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "匯出角色系統權限報表失敗");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "匯出角色系統權限報表失敗"
                });
            }
        }
    }
}
```

### 5.2 Service: `RoleSystemPermissionService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public class RoleSystemPermissionService : IRoleSystemPermissionService
    {
        private readonly IRoleSystemPermissionRepository _repository;
        private readonly ILogger<RoleSystemPermissionService> _logger;

        public RoleSystemPermissionService(
            IRoleSystemPermissionRepository repository,
            ILogger<RoleSystemPermissionService> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        public async Task<RoleSystemPermissionListResponseDto> GetRoleSystemPermissionListAsync(
            RoleSystemPermissionListRequestDto request,
            CancellationToken cancellationToken = default)
        {
            // 驗證角色是否存在
            var role = await _repository.GetRoleByIdAsync(request.RoleId, cancellationToken);
            if (role == null)
            {
                throw new NotFoundException($"角色 {request.RoleId} 不存在");
            }

            // 查詢權限資料
            var queryResults = await _repository.GetRoleSystemPermissionsAsync(
                request.RoleId,
                request.SystemId,
                request.MenuId,
                request.ProgramId,
                cancellationToken);

            // 組織階層式結構
            var response = new RoleSystemPermissionListResponseDto
            {
                RoleId = role.RoleId,
                RoleName = role.RoleName,
                Permissions = new List<SystemPermissionDto>()
            };

            var systemDict = new Dictionary<string, SystemPermissionDto>();
            var menuDict = new Dictionary<string, MenuPermissionDto>();
            var programDict = new Dictionary<string, ProgramPermissionDto>();

            foreach (var item in queryResults)
            {
                // 系統層級
                if (!systemDict.ContainsKey(item.SYS_ID))
                {
                    systemDict[item.SYS_ID] = new SystemPermissionDto
                    {
                        SystemId = item.SYS_ID,
                        SystemName = item.SYS_NAME,
                        Menus = new List<MenuPermissionDto>()
                    };
                }

                // 選單層級
                var menuKey = $"{item.SYS_ID}_{item.MENU_ID}";
                if (!menuDict.ContainsKey(menuKey))
                {
                    var menu = new MenuPermissionDto
                    {
                        MenuId = item.MENU_ID,
                        MenuName = item.MENU_NAME,
                        Programs = new List<ProgramPermissionDto>()
                    };
                    menuDict[menuKey] = menu;
                    systemDict[item.SYS_ID].Menus.Add(menu);
                }

                // 作業層級
                var programKey = $"{item.SYS_ID}_{item.MENU_ID}_{item.PROG_ID}";
                if (!programDict.ContainsKey(programKey))
                {
                    var program = new ProgramPermissionDto
                    {
                        ProgramId = item.PROG_ID,
                        ProgramName = item.PROG_NAME,
                        Buttons = new List<ButtonPermissionDto>()
                    };
                    programDict[programKey] = program;
                    menuDict[menuKey].Programs.Add(program);
                }

                // 按鈕層級
                var button = new ButtonPermissionDto
                {
                    ButtonId = item.BUTTON_ID,
                    ButtonName = item.BUTTON_NAME,
                    PageId = item.PAGE_ID
                };
                programDict[programKey].Buttons.Add(button);
            }

            response.Permissions = systemDict.Values.OrderBy(x => x.SystemId).ToList();
            return response;
        }

        public async Task<byte[]> ExportRoleSystemPermissionReportAsync(
            RoleSystemPermissionListRequestDto request,
            string exportFormat,
            CancellationToken cancellationToken = default)
        {
            var data = await GetRoleSystemPermissionListAsync(request, cancellationToken);

            if (exportFormat == "Excel")
            {
                return ExportToExcel(data);
            }
            else
            {
                return ExportToPdf(data);
            }
        }

        private byte[] ExportToExcel(RoleSystemPermissionListResponseDto data)
        {
            // 使用 EPPlus 或 NPOI 實作 Excel 匯出
            // ...
            throw new NotImplementedException();
        }

        private byte[] ExportToPdf(RoleSystemPermissionListResponseDto data)
        {
            // 使用 iTextSharp 或 QuestPDF 實作 PDF 匯出
            // ...
            throw new NotImplementedException();
        }
    }
}
```

### 5.3 Repository: `RoleSystemPermissionRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public class RoleSystemPermissionRepository : IRoleSystemPermissionRepository
    {
        private readonly IDbConnection _dbConnection;

        public RoleSystemPermissionRepository(IDbConnection dbConnection)
        {
            _dbConnection = dbConnection;
        }

        public async Task<Role?> GetRoleByIdAsync(string roleId, CancellationToken cancellationToken = default)
        {
            const string sql = @"
                SELECT RoleId, RoleName, RoleNote, Status, CreatedBy, CreatedAt, UpdatedBy, UpdatedAt
                FROM [dbo].[Roles]
                WHERE RoleId = @RoleId";

            var result = await _dbConnection.QueryFirstOrDefaultAsync<Role>(
                sql,
                new { RoleId = roleId },
                cancellationToken: cancellationToken);

            return result;
        }

        public async Task<IEnumerable<RoleSystemPermissionQueryResult>> GetRoleSystemPermissionsAsync(
            string roleId,
            string? systemId = null,
            string? menuId = null,
            string? programId = null,
            CancellationToken cancellationToken = default)
        {
            var sql = @"
                SELECT 
                    R.RoleId AS ROLE_ID,
                    R.RoleName AS ROLE_NAME,
                    S.SystemId AS SYS_ID,
                    S.SystemName AS SYS_NAME,
                    M.MenuId AS MENU_ID,
                    M.MenuName AS MENU_NAME,
                    P.ProgramId AS PROG_ID,
                    P.ProgramName AS PROG_NAME,
                    B.ButtonId AS BUTTON_ID,
                    B.ButtonName AS BUTTON_NAME,
                    B.PageId AS PAGE_ID
                FROM [dbo].[V_RoleSystemPermission] V
                WHERE V.ROLE_ID = @RoleId";

            var parameters = new DynamicParameters();
            parameters.Add("RoleId", roleId);

            if (!string.IsNullOrEmpty(systemId))
            {
                sql += " AND V.SYS_ID = @SystemId";
                parameters.Add("SystemId", systemId);
            }

            if (!string.IsNullOrEmpty(menuId))
            {
                sql += " AND V.MENU_ID = @MenuId";
                parameters.Add("MenuId", menuId);
            }

            if (!string.IsNullOrEmpty(programId))
            {
                sql += " AND V.PROG_ID = @ProgramId";
                parameters.Add("ProgramId", programId);
            }

            sql += " ORDER BY V.SYS_ID, V.MENU_ID, V.PROG_ID, V.PAGE_ID, V.BUTTON_ID";

            var results = await _dbConnection.QueryAsync<RoleSystemPermissionQueryResult>(
                sql,
                parameters,
                cancellationToken: cancellationToken);

            return results;
        }
    }
}
```

---

## 六、開發時程

### 6.1 階段一: 資料庫設計 (0.5天)
- [ ] 建立查詢視圖 `V_RoleSystemPermission`
- [ ] 建立索引
- [ ] 驗證查詢效能

### 6.2 階段二: 後端開發 (2天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 驗證邏輯實作
- [ ] 單元測試

### 6.3 階段三: 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 查詢頁面開發
- [ ] 報表顯示頁面開發
- [ ] 樹狀元件開發
- [ ] 表格元件開發
- [ ] 表單驗證
- [ ] 元件測試

### 6.4 階段四: 整合測試 (0.5天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試

### 6.5 階段五: 文件與部署 (0.5天)
- [ ] API 文件更新
- [ ] 使用者手冊

**總計**: 5.5天

---

## 七、注意事項

### 7.1 效能優化
- 使用視圖 `V_RoleSystemPermission` 簡化查詢
- 建立適當的索引以提升查詢效能
- 如果資料量大，考慮使用分頁或虛擬滾動

### 7.2 資料驗證
- 角色代碼必須存在
- 角色代碼為必填欄位

### 7.3 業務邏輯
- 只查詢角色直接權限（不包含使用者權限）
- 按鈕權限需依頁面代碼分組顯示
- 報表格式需符合舊系統格式

### 7.4 多語言支援
- 系統名稱、選單名稱、作業名稱、按鈕名稱需支援多語言顯示

---

## 八、測試案例

### 8.1 單元測試
- [ ] 查詢角色系統權限列表成功
- [ ] 查詢角色系統權限列表失敗（角色不存在）
- [ ] 查詢角色系統權限列表失敗（角色代碼為空）
- [ ] 資料轉換邏輯測試

### 8.2 整合測試
- [ ] API 端點測試
- [ ] 資料庫查詢測試
- [ ] 權限驗證測試

### 8.3 前端測試
- [ ] 查詢表單驗證測試
- [ ] 資料顯示測試
- [ ] 匯出功能測試

---

## 九、參考資料

### 9.1 舊程式碼
- `IMS3/HANSHIN/IMS3/SYS0000/SYS0731_PR.aspx.cs`
- `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_USER_ROLE.cs` (GetUserRoleButton方法)

### 9.2 相關功能
- SYS0710 - 系統權限列表
- SYS0310 - 角色系統權限設定
- SYS0210 - 角色基本資料維護

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

