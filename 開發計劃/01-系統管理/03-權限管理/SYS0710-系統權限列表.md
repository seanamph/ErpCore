# SYS0710 - 系統權限列表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0710
- **功能名稱**: 系統權限列表
- **功能描述**: 查詢指定使用者或角色的系統權限列表，以報表形式顯示該使用者/角色擁有的系統、選單、作業及按鈕權限的完整結構
- **參考舊程式**: 
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0710.ascx`
  - `WEB/IMS_CORE/SYS0000/SYS0710_PR.aspx` (報表)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0710_PR.ASP` (報表)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0710_FQ.ASP` (查詢)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0710_FB.ASP` (瀏覽)

### 1.2 業務需求
- 支援依使用者代碼查詢系統權限列表
- 支援依角色代碼查詢系統權限列表
- 顯示系統、選單、作業、按鈕的階層式權限結構
- 顯示使用者/角色的基本資訊
- 支援報表列印功能
- 支援報表匯出功能（Excel、PDF）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

本功能為查詢報表功能，主要使用以下資料表進行查詢：

#### 2.1.1 `Users` - 使用者主檔
- 參考: `開發計劃/01-系統管理/01-使用者管理/SYS0110-使用者基本資料維護.md`

#### 2.1.2 `Roles` - 角色主檔
- 參考: `開發計劃/01-系統管理/02-角色管理/SYS0210-角色基本資料維護.md`

#### 2.1.3 `UserRoles` - 使用者角色對應
```sql
CREATE TABLE [dbo].[UserRoles] (
    [UserId] NVARCHAR(50) NOT NULL,
    [RoleId] NVARCHAR(50) NOT NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_UserRoles] PRIMARY KEY CLUSTERED ([UserId], [RoleId]),
    CONSTRAINT [FK_UserRoles_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE,
    CONSTRAINT [FK_UserRoles_Roles] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[Roles] ([RoleId]) ON DELETE CASCADE
);
```

#### 2.1.4 `Systems` - 系統主檔
- 參考: `開發計劃/01-系統管理/04-系統設定/SYS0410-主系統項目資料維護.md`

#### 2.1.5 `Menus` - 選單主檔
```sql
CREATE TABLE [dbo].[Menus] (
    [MenuId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [SystemId] NVARCHAR(50) NOT NULL,
    [MenuName] NVARCHAR(100) NOT NULL,
    [MenuNote] NVARCHAR(500) NULL,
    [ParentMenuId] NVARCHAR(50) NULL,
    [SortOrder] INT NULL DEFAULT 0,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Menus] PRIMARY KEY CLUSTERED ([MenuId] ASC),
    CONSTRAINT [FK_Menus_Systems] FOREIGN KEY ([SystemId]) REFERENCES [dbo].[Systems] ([SystemId]),
    CONSTRAINT [FK_Menus_ParentMenu] FOREIGN KEY ([ParentMenuId]) REFERENCES [dbo].[Menus] ([MenuId])
);
```

#### 2.1.6 `Programs` - 作業主檔
```sql
CREATE TABLE [dbo].[Programs] (
    [ProgramId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [MenuId] NVARCHAR(50) NOT NULL,
    [ProgramName] NVARCHAR(100) NOT NULL,
    [ProgramNote] NVARCHAR(500) NULL,
    [ProgramUrl] NVARCHAR(500) NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [SortOrder] INT NULL DEFAULT 0,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Programs] PRIMARY KEY CLUSTERED ([ProgramId] ASC),
    CONSTRAINT [FK_Programs_Menus] FOREIGN KEY ([MenuId]) REFERENCES [dbo].[Menus] ([MenuId])
);
```

#### 2.1.7 `Buttons` - 按鈕主檔
```sql
CREATE TABLE [dbo].[Buttons] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [ProgramId] NVARCHAR(50) NOT NULL,
    [PageId] NVARCHAR(50) NULL,
    [ButtonId] NVARCHAR(50) NOT NULL,
    [ButtonName] NVARCHAR(100) NOT NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [SortOrder] INT NULL DEFAULT 0,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_Buttons_Programs] FOREIGN KEY ([ProgramId]) REFERENCES [dbo].[Programs] ([ProgramId])
);
```

#### 2.1.8 `RoleButtons` - 角色按鈕權限
```sql
CREATE TABLE [dbo].[RoleButtons] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [RoleId] NVARCHAR(50) NULL,
    [UserId] NVARCHAR(50) NULL,
    [ButtonKey] BIGINT NOT NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_RoleButtons_Roles] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[Roles] ([RoleId]) ON DELETE CASCADE,
    CONSTRAINT [FK_RoleButtons_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE,
    CONSTRAINT [FK_RoleButtons_Buttons] FOREIGN KEY ([ButtonKey]) REFERENCES [dbo].[Buttons] ([TKey]),
    CONSTRAINT [CK_RoleButtons_UserOrRole] CHECK (([RoleId] IS NOT NULL AND [UserId] IS NULL) OR ([RoleId] IS NULL AND [UserId] IS NOT NULL))
);
```

### 2.2 查詢視圖 (View)

為了方便查詢，建議建立以下視圖：

#### 2.2.1 `V_UserButtonRoleButton` - 使用者按鈕權限視圖
```sql
CREATE VIEW [dbo].[V_UserButtonRoleButton] AS
SELECT 
    U.UserId AS USER_ID,
    U.UserName AS USER_NAME,
    R.RoleId AS ROLE_ID,
    R.RoleName AS ROLE_NAME,
    S.SystemId AS SYS_ID,
    S.SystemName AS SYS_NAME,
    M.MenuId AS MENU_ID,
    M.MenuName AS MENU_NAME,
    P.ProgramId AS PG_ID,
    P.ProgramName AS PG_ID_NAME,
    B.ButtonName AS BTN_NAME,
    B.PageId AS PAGE_ID,
    B.ButtonId AS BUTTON_ID
FROM [dbo].[Buttons] B
INNER JOIN [dbo].[Programs] P ON B.ProgramId = P.ProgramId
INNER JOIN [dbo].[Menus] M ON P.MenuId = M.MenuId
INNER JOIN [dbo].[Systems] S ON M.SystemId = S.SystemId
LEFT JOIN [dbo].[RoleButtons] RB ON B.TKey = RB.ButtonKey
LEFT JOIN [dbo].[Users] U ON RB.UserId = U.UserId
LEFT JOIN [dbo].[Roles] R ON RB.RoleId = R.RoleId
LEFT JOIN [dbo].[UserRoles] UR ON U.UserId = UR.UserId AND R.RoleId = UR.RoleId
WHERE B.Status = '1' 
  AND P.Status = '1'
  AND M.Status = '1'
  AND S.Status = 'A';
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢系統權限列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/system-permissions/list`
- **說明**: 查詢指定使用者或角色的系統權限列表
- **請求參數**:
  ```json
  {
    "userId": "string",      // 使用者代碼（可選）
    "roleId": "string",       // 角色代碼（可選）
    "systemId": "string",     // 系統代碼（可選，篩選條件）
    "menuId": "string",       // 選單代碼（可選，篩選條件）
    "programId": "string"     // 作業代碼（可選，篩選條件）
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "data": {
      "userId": "string",
      "userName": "string",
      "roleId": "string",
      "roleName": "string",
      "permissions": [
        {
          "systemId": "string",
          "systemName": "string",
          "menus": [
            {
              "menuId": "string",
              "menuName": "string",
              "programs": [
                {
                  "programId": "string",
                  "programName": "string",
                  "buttons": [
                    {
                      "buttonId": "string",
                      "buttonName": "string",
                      "pageId": "string"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "message": "string"
  }
  ```

#### 3.1.2 匯出系統權限報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/system-permissions/export`
- **說明**: 匯出系統權限報表（Excel、PDF）
- **請求參數**:
  ```json
  {
    "userId": "string",
    "roleId": "string",
    "exportFormat": "Excel|PDF",
    "filters": {
      "systemId": "string",
      "menuId": "string",
      "programId": "string"
    }
  }
  ```
- **回應格式**: 檔案下載

### 3.2 資料傳輸物件 (DTO)

#### 3.2.1 `SystemPermissionListRequestDto`
```csharp
public class SystemPermissionListRequestDto
{
    public string? UserId { get; set; }
    public string? RoleId { get; set; }
    public string? SystemId { get; set; }
    public string? MenuId { get; set; }
    public string? ProgramId { get; set; }
}
```

#### 3.2.2 `SystemPermissionListResponseDto`
```csharp
public class SystemPermissionListResponseDto
{
    public string? UserId { get; set; }
    public string? UserName { get; set; }
    public string? RoleId { get; set; }
    public string? RoleName { get; set; }
    public List<SystemPermissionDto> Permissions { get; set; } = new();
}

public class SystemPermissionDto
{
    public string SystemId { get; set; } = string.Empty;
    public string SystemName { get; set; } = string.Empty;
    public List<MenuPermissionDto> Menus { get; set; } = new();
}

public class MenuPermissionDto
{
    public string MenuId { get; set; } = string.Empty;
    public string MenuName { get; set; } = string.Empty;
    public List<ProgramPermissionDto> Programs { get; set; } = new();
}

public class ProgramPermissionDto
{
    public string ProgramId { get; set; } = string.Empty;
    public string ProgramName { get; set; } = string.Empty;
    public List<ButtonPermissionDto> Buttons { get; set; } = new();
}

public class ButtonPermissionDto
{
    public string ButtonId { get; set; } = string.Empty;
    public string ButtonName { get; set; } = string.Empty;
    public string? PageId { get; set; }
}
```

### 3.3 Service 層設計

#### 3.3.1 `ISystemPermissionService`
```csharp
public interface ISystemPermissionService
{
    Task<SystemPermissionListResponseDto> GetSystemPermissionListAsync(
        SystemPermissionListRequestDto request, 
        CancellationToken cancellationToken = default);
    
    Task<byte[]> ExportSystemPermissionReportAsync(
        SystemPermissionListRequestDto request, 
        string exportFormat, 
        CancellationToken cancellationToken = default);
}
```

#### 3.3.2 `SystemPermissionService` 實作重點
- 根據使用者代碼或角色代碼查詢權限
- 如果提供使用者代碼，需查詢該使用者的角色，並合併使用者直接權限與角色權限
- 如果提供角色代碼，直接查詢角色權限
- 組織階層式權限結構（系統→選單→作業→按鈕）
- 支援篩選條件

---

## 四、前端 UI 設計

### 4.1 查詢頁面 (`SystemPermissionListQuery.vue`)

#### 4.1.1 頁面結構
- **查詢條件區塊**
  - 使用者代碼輸入框（支援自動完成）
  - 角色代碼輸入框（支援自動完成）
  - 系統代碼下拉選單（可選）
  - 選單代碼下拉選單（可選）
  - 作業代碼下拉選單（可選）
  - 查詢按鈕
  - 重置按鈕

#### 4.1.2 功能需求
- 使用者代碼與角色代碼至少需輸入一個
- 支援使用者代碼自動完成（參考 `USER_LIST`）
- 支援角色代碼自動完成（參考 `ROLE_LIST`）
- 查詢結果以階層式樹狀結構顯示
- 支援展開/收合節點
- 支援報表列印
- 支援報表匯出（Excel、PDF）

### 4.2 報表顯示頁面 (`SystemPermissionListReport.vue`)

#### 4.2.1 頁面結構
- **報表標題區塊**
  - 使用者資訊（使用者代碼、使用者名稱）
  - 角色資訊（角色代碼、角色名稱）
  - 查詢時間

- **報表內容區塊**
  - 階層式表格顯示
    - 第一層：系統（系統代碼、系統名稱）
    - 第二層：選單（選單代碼、選單名稱）
    - 第三層：作業（作業代碼、作業名稱）
    - 第四層：按鈕（按鈕名稱列表）

#### 4.2.2 功能需求
- 支援報表列印
- 支援報表匯出（Excel、PDF）
- 支援分頁顯示（如果資料量大）

### 4.3 元件設計

#### 4.3.1 `SystemPermissionTree.vue`
- 樹狀結構顯示系統權限
- 支援展開/收合
- 支援搜尋過濾

#### 4.3.2 `SystemPermissionTable.vue`
- 表格形式顯示系統權限
- 支援排序
- 支援匯出

---

## 五、API 實作範例

### 5.1 Controller

```csharp
[ApiController]
[Route("api/v1/system-permissions")]
[Authorize]
public class SystemPermissionController : ControllerBase
{
    private readonly ISystemPermissionService _systemPermissionService;
    private readonly ILogger<SystemPermissionController> _logger;

    public SystemPermissionController(
        ISystemPermissionService systemPermissionService,
        ILogger<SystemPermissionController> logger)
    {
        _systemPermissionService = systemPermissionService;
        _logger = logger;
    }

    /// <summary>
    /// 查詢系統權限列表
    /// </summary>
    [HttpGet("list")]
    public async Task<ActionResult<ApiResponse<SystemPermissionListResponseDto>>> GetSystemPermissionList(
        [FromQuery] SystemPermissionListRequestDto request,
        CancellationToken cancellationToken = default)
    {
        try
        {
            if (string.IsNullOrEmpty(request.UserId) && string.IsNullOrEmpty(request.RoleId))
            {
                return BadRequest(new ApiResponse<SystemPermissionListResponseDto>
                {
                    Success = false,
                    Message = "請至少輸入使用者代碼或角色代碼"
                });
            }

            var result = await _systemPermissionService.GetSystemPermissionListAsync(request, cancellationToken);
            
            return Ok(new ApiResponse<SystemPermissionListResponseDto>
            {
                Success = true,
                Data = result,
                Message = "查詢成功"
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "查詢系統權限列表失敗");
            return StatusCode(500, new ApiResponse<SystemPermissionListResponseDto>
            {
                Success = false,
                Message = "查詢系統權限列表失敗"
            });
        }
    }

    /// <summary>
    /// 匯出系統權限報表
    /// </summary>
    [HttpPost("export")]
    public async Task<IActionResult> ExportSystemPermissionReport(
        [FromBody] SystemPermissionExportRequestDto request,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var fileBytes = await _systemPermissionService.ExportSystemPermissionReportAsync(
                request.Request,
                request.ExportFormat,
                cancellationToken);

            var contentType = request.ExportFormat == "Excel" 
                ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                : "application/pdf";
            
            var fileName = $"系統權限列表_{DateTime.Now:yyyyMMddHHmmss}.{(request.ExportFormat == "Excel" ? "xlsx" : "pdf")}";

            return File(fileBytes, contentType, fileName);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "匯出系統權限報表失敗");
            return StatusCode(500, new ApiResponse<object>
            {
                Success = false,
                Message = "匯出系統權限報表失敗"
            });
        }
    }
}
```

### 5.2 Service 實作

```csharp
public class SystemPermissionService : ISystemPermissionService
{
    private readonly IDbConnection _dbConnection;
    private readonly ILogger<SystemPermissionService> _logger;

    public SystemPermissionService(
        IDbConnection dbConnection,
        ILogger<SystemPermissionService> logger)
    {
        _dbConnection = dbConnection;
        _logger = logger;
    }

    public async Task<SystemPermissionListResponseDto> GetSystemPermissionListAsync(
        SystemPermissionListRequestDto request,
        CancellationToken cancellationToken = default)
    {
        var sql = @"
            SELECT 
                U.UserId AS USER_ID,
                U.UserName AS USER_NAME,
                R.RoleId AS ROLE_ID,
                R.RoleName AS ROLE_NAME,
                S.SystemId AS SYS_ID,
                S.SystemName AS SYS_NAME,
                M.MenuId AS MENU_ID,
                M.MenuName AS MENU_NAME,
                P.ProgramId AS PG_ID,
                P.ProgramName AS PG_ID_NAME,
                B.ButtonName AS BTN_NAME,
                B.PageId AS PAGE_ID,
                B.ButtonId AS BUTTON_ID
            FROM [dbo].[V_UserButtonRoleButton] V
            WHERE 1 = 1";

        var parameters = new DynamicParameters();

        if (!string.IsNullOrEmpty(request.UserId))
        {
            sql += " AND V.USER_ID = @UserId";
            parameters.Add("UserId", request.UserId);
        }

        if (!string.IsNullOrEmpty(request.RoleId))
        {
            sql += " AND V.ROLE_ID = @RoleId";
            parameters.Add("RoleId", request.RoleId);
        }

        if (!string.IsNullOrEmpty(request.SystemId))
        {
            sql += " AND V.SYS_ID = @SystemId";
            parameters.Add("SystemId", request.SystemId);
        }

        if (!string.IsNullOrEmpty(request.MenuId))
        {
            sql += " AND V.MENU_ID = @MenuId";
            parameters.Add("MenuId", request.MenuId);
        }

        if (!string.IsNullOrEmpty(request.ProgramId))
        {
            sql += " AND V.PG_ID = @ProgramId";
            parameters.Add("ProgramId", request.ProgramId);
        }

        sql += " ORDER BY V.SYS_ID, V.MENU_ID, V.PG_ID, V.BUTTON_ID";

        var results = await _dbConnection.QueryAsync<SystemPermissionQueryResult>(
            sql, 
            parameters, 
            cancellationToken);

        // 組織階層式結構
        var response = new SystemPermissionListResponseDto();
        var permissionDict = new Dictionary<string, SystemPermissionDto>();
        var menuDict = new Dictionary<string, MenuPermissionDto>();
        var programDict = new Dictionary<string, ProgramPermissionDto>();

        foreach (var item in results)
        {
            // 設定使用者/角色資訊
            if (string.IsNullOrEmpty(response.UserId) && !string.IsNullOrEmpty(item.USER_ID))
            {
                response.UserId = item.USER_ID;
                response.UserName = item.USER_NAME;
            }
            if (string.IsNullOrEmpty(response.RoleId) && !string.IsNullOrEmpty(item.ROLE_ID))
            {
                response.RoleId = item.ROLE_ID;
                response.RoleName = item.ROLE_NAME;
            }

            // 系統層級
            if (!permissionDict.ContainsKey(item.SYS_ID))
            {
                permissionDict[item.SYS_ID] = new SystemPermissionDto
                {
                    SystemId = item.SYS_ID,
                    SystemName = item.SYS_NAME,
                    Menus = new List<MenuPermissionDto>()
                };
            }

            // 選單層級
            var menuKey = $"{item.SYS_ID}_{item.MENU_ID}";
            if (!menuDict.ContainsKey(menuKey))
            {
                var menu = new MenuPermissionDto
                {
                    MenuId = item.MENU_ID,
                    MenuName = item.MENU_NAME,
                    Programs = new List<ProgramPermissionDto>()
                };
                menuDict[menuKey] = menu;
                permissionDict[item.SYS_ID].Menus.Add(menu);
            }

            // 作業層級
            var programKey = $"{item.SYS_ID}_{item.MENU_ID}_{item.PG_ID}";
            if (!programDict.ContainsKey(programKey))
            {
                var program = new ProgramPermissionDto
                {
                    ProgramId = item.PG_ID,
                    ProgramName = item.PG_ID_NAME,
                    Buttons = new List<ButtonPermissionDto>()
                };
                programDict[programKey] = program;
                menuDict[menuKey].Programs.Add(program);
            }

            // 按鈕層級
            if (!string.IsNullOrEmpty(item.BTN_NAME))
            {
                var button = new ButtonPermissionDto
                {
                    ButtonId = item.BUTTON_ID,
                    ButtonName = item.BTN_NAME,
                    PageId = item.PAGE_ID
                };
                programDict[programKey].Buttons.Add(button);
            }
        }

        response.Permissions = permissionDict.Values.ToList();
        return response;
    }

    public async Task<byte[]> ExportSystemPermissionReportAsync(
        SystemPermissionListRequestDto request,
        string exportFormat,
        CancellationToken cancellationToken = default)
    {
        var data = await GetSystemPermissionListAsync(request, cancellationToken);

        if (exportFormat == "Excel")
        {
            return ExportToExcel(data);
        }
        else
        {
            return ExportToPdf(data);
        }
    }

    private byte[] ExportToExcel(SystemPermissionListResponseDto data)
    {
        // 使用 EPPlus 或 NPOI 實作 Excel 匯出
        // ...
        throw new NotImplementedException();
    }

    private byte[] ExportToPdf(SystemPermissionListResponseDto data)
    {
        // 使用 iTextSharp 或 QuestPDF 實作 PDF 匯出
        // ...
        throw new NotImplementedException();
    }
}

// 查詢結果模型
public class SystemPermissionQueryResult
{
    public string? USER_ID { get; set; }
    public string? USER_NAME { get; set; }
    public string? ROLE_ID { get; set; }
    public string? ROLE_NAME { get; set; }
    public string SYS_ID { get; set; } = string.Empty;
    public string SYS_NAME { get; set; } = string.Empty;
    public string MENU_ID { get; set; } = string.Empty;
    public string MENU_NAME { get; set; } = string.Empty;
    public string PG_ID { get; set; } = string.Empty;
    public string PG_ID_NAME { get; set; } = string.Empty;
    public string? BTN_NAME { get; set; }
    public string? PAGE_ID { get; set; }
    public string? BUTTON_ID { get; set; }
}
```

---

## 六、前端實作範例

### 6.1 查詢頁面 (`SystemPermissionListQuery.vue`)

```vue
<template>
  <div class="system-permission-query">
    <el-card>
      <template #header>
        <span>系統權限列表查詢</span>
      </template>

      <el-form :model="queryForm" :rules="queryRules" ref="queryFormRef" label-width="120px">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="使用者代碼" prop="userId">
              <el-autocomplete
                v-model="queryForm.userId"
                :fetch-suggestions="searchUsers"
                placeholder="請輸入使用者代碼"
                clearable
                style="width: 100%"
              />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="角色代碼" prop="roleId">
              <el-autocomplete
                v-model="queryForm.roleId"
                :fetch-suggestions="searchRoles"
                placeholder="請輸入角色代碼"
                clearable
                style="width: 100%"
              />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="系統代碼">
              <el-select v-model="queryForm.systemId" placeholder="請選擇系統" clearable style="width: 100%">
                <el-option
                  v-for="system in systems"
                  :key="system.systemId"
                  :label="system.systemName"
                  :value="system.systemId"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="選單代碼">
              <el-select v-model="queryForm.menuId" placeholder="請選擇選單" clearable style="width: 100%">
                <el-option
                  v-for="menu in menus"
                  :key="menu.menuId"
                  :label="menu.menuName"
                  :value="menu.menuId"
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>

        <el-form-item>
          <el-button type="primary" @click="handleQuery" :loading="loading">查詢</el-button>
          <el-button @click="handleReset">重置</el-button>
          <el-button type="success" @click="handleExport('Excel')" :disabled="!hasData">匯出Excel</el-button>
          <el-button type="success" @click="handleExport('PDF')" :disabled="!hasData">匯出PDF</el-button>
        </el-form-item>
      </el-form>
    </el-card>

    <el-card v-if="hasData" style="margin-top: 20px">
      <template #header>
        <span>查詢結果</span>
      </template>

      <SystemPermissionTree :data="permissionData" />
    </el-card>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, computed } from 'vue'
import { ElMessage } from 'element-plus'
import { systemPermissionApi } from '@/api/system-permission'
import SystemPermissionTree from './components/SystemPermissionTree.vue'

const queryFormRef = ref()
const loading = ref(false)
const permissionData = ref<SystemPermissionListResponseDto | null>(null)
const systems = ref([])
const menus = ref([])

const queryForm = reactive({
  userId: '',
  roleId: '',
  systemId: '',
  menuId: '',
  programId: ''
})

const queryRules = {
  userId: [
    {
      validator: (rule: any, value: string, callback: Function) => {
        if (!queryForm.userId && !queryForm.roleId) {
          callback(new Error('請至少輸入使用者代碼或角色代碼'))
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ],
  roleId: [
    {
      validator: (rule: any, value: string, callback: Function) => {
        if (!queryForm.userId && !queryForm.roleId) {
          callback(new Error('請至少輸入使用者代碼或角色代碼'))
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ]
}

const hasData = computed(() => permissionData.value !== null)

const searchUsers = async (queryString: string, cb: Function) => {
  // 呼叫使用者列表 API
  // ...
}

const searchRoles = async (queryString: string, cb: Function) => {
  // 呼叫角色列表 API
  // ...
}

const handleQuery = async () => {
  await queryFormRef.value.validate(async (valid: boolean) => {
    if (!valid) return

    loading.value = true
    try {
      const response = await systemPermissionApi.getSystemPermissionList(queryForm)
      if (response.success) {
        permissionData.value = response.data
        ElMessage.success('查詢成功')
      } else {
        ElMessage.error(response.message || '查詢失敗')
      }
    } catch (error) {
      ElMessage.error('查詢失敗')
    } finally {
      loading.value = false
    }
  })
}

const handleReset = () => {
  queryFormRef.value.resetFields()
  permissionData.value = null
}

const handleExport = async (format: 'Excel' | 'PDF') => {
  try {
    const response = await systemPermissionApi.exportSystemPermissionReport({
      request: queryForm,
      exportFormat: format
    })
    
    // 下載檔案
    const blob = new Blob([response], {
      type: format === 'Excel' 
        ? 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        : 'application/pdf'
    })
    const url = window.URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = `系統權限列表_${new Date().toISOString().slice(0, 10)}.${format === 'Excel' ? 'xlsx' : 'pdf'}`
    link.click()
    window.URL.revokeObjectURL(url)
    
    ElMessage.success('匯出成功')
  } catch (error) {
    ElMessage.error('匯出失敗')
  }
}
</script>
```

---

## 七、測試計劃

### 7.1 單元測試
- Service 層查詢邏輯測試
- DTO 驗證測試
- 資料轉換邏輯測試

### 7.2 整合測試
- API 端點測試
- 資料庫查詢測試
- 權限驗證測試

### 7.3 前端測試
- 查詢表單驗證測試
- 資料顯示測試
- 匯出功能測試

---

## 八、注意事項

1. **權限合併邏輯**：如果查詢使用者權限，需合併使用者直接權限與角色權限
2. **效能優化**：如果資料量大，建議使用分頁或虛擬滾動
3. **快取策略**：系統、選單、作業等基礎資料可考慮快取
4. **報表格式**：Excel 匯出需注意欄位寬度與格式
5. **多語言支援**：系統名稱、選單名稱、作業名稱需支援多語言顯示

---

## 九、相關功能

- SYS0310 - 角色系統權限設定
- SYS0320 - 使用者系統權限設定
- SYS0731 - 角色系統權限列表
- SYS0720 - 作業權限之使用者列表
- SYS0740 - 作業權限之角色列表
- SYS0750 - 角色之使用者列表

