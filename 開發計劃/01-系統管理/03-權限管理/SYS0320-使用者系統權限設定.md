# SYS0320 - 使用者系統權限設定 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0320
- **功能名稱**: 使用者系統權限設定
- **功能描述**: 為指定使用者設定系統、選單、作業、按鈕等層級的權限，管理使用者對系統功能的存取控制。當設定使用者直接權限時，會移除該使用者的角色權限對應關係
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0320_FQ.ASP` (查詢)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0320_SYS_LIST.asp` (系統列表)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0320_SET_SYS_AC.asp` (設定系統權限)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0320_SET_PROG_AC.asp` (設定作業權限)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0320_SET_MENU_AC.asp` (設定選單權限)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0320_SET_BUTTON_AC.asp` (設定按鈕權限)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0320_SET_SYS_AC.aspx.cs`
  - `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_USER_BUTTON.cs`

### 1.2 業務需求
- 為指定使用者設定系統層級權限（全選/未選）
- 為指定使用者設定選單層級權限
- 為指定使用者設定作業層級權限
- 為指定使用者設定按鈕層級權限
- 支援批量設定權限
- 支援權限繼承（系統→選單→作業→按鈕）
- 查看使用者已設定的權限列表
- **重要**: 當設定使用者直接權限時，需移除該使用者的角色權限對應（UserRoles表中的記錄）
- 支援權限的查詢、新增、修改、刪除

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `UserButtons` (使用者按鈕權限)

```sql
CREATE TABLE [dbo].[UserButtons] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [UserId] NVARCHAR(50) NOT NULL,
    [ButtonKey] BIGINT NOT NULL, -- 對應到 Buttons 表的 TKey
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [CreatedPriority] INT NULL,
    [CreatedGroup] NVARCHAR(50) NULL,
    CONSTRAINT [PK_UserButtons] PRIMARY KEY CLUSTERED ([TKey] ASC),
    CONSTRAINT [FK_UserButtons_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE,
    CONSTRAINT [FK_UserButtons_Buttons] FOREIGN KEY ([ButtonKey]) REFERENCES [dbo].[Buttons] ([TKey]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_UserButtons_UserId] ON [dbo].[UserButtons] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_UserButtons_ButtonKey] ON [dbo].[UserButtons] ([ButtonKey]);
CREATE UNIQUE NONCLUSTERED INDEX [IX_UserButtons_UserId_ButtonKey] ON [dbo].[UserButtons] ([UserId], [ButtonKey]);
```

### 2.2 相關資料表

#### 2.2.1 `Users` - 使用者基本資料
```sql
-- 參考 SYS0110 開發計劃
```

#### 2.2.2 `UserRoles` - 使用者角色對應（需清除）
```sql
-- 當設定使用者直接權限時，需清除此表中的使用者角色對應記錄
-- 參考 SYS0220 開發計劃
```

#### 2.2.3 `Systems`, `Menus`, `Programs`, `Buttons` - 系統、選單、作業、按鈕主檔
```sql
-- 參考 SYS0310 開發計劃
```

### 2.3 資料字典

#### UserButtons 表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| TKey | BIGINT | - | NO | IDENTITY | 主鍵 | 自動遞增 |
| UserId | NVARCHAR | 50 | NO | - | 使用者代碼 | 外鍵至 Users |
| ButtonKey | BIGINT | - | NO | - | 按鈕主鍵 | 外鍵至 Buttons.TKey |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| CreatedPriority | INT | - | YES | - | 建立者等級 | - |
| CreatedGroup | NVARCHAR | 50 | YES | - | 建立者群組 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢使用者權限列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/permissions`
- **說明**: 查詢指定使用者的權限列表，支援分頁、排序、篩選
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求參數**: 同 SYS0310
- **回應格式**: 同 SYS0310（將 roleId 改為 userId）

#### 3.1.2 查詢使用者系統列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/systems`
- **說明**: 查詢指定使用者可存取的系統列表，包含權限統計
- **路徑參數**:
  - `userId`: 使用者代碼
- **回應格式**: 同 SYS0310（將 roleId 改為 userId）

#### 3.1.3 查詢使用者選單列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/menus`
- **說明**: 查詢指定使用者在指定系統下的選單列表
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求參數**:
  - `systemId`: 系統代碼（可選）
- **回應格式**: 同 SYS0310（將 roleId 改為 userId）

#### 3.1.4 查詢使用者作業列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/programs`
- **說明**: 查詢指定使用者在指定選單下的作業列表
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求參數**:
  - `menuId`: 選單代碼（可選）
- **回應格式**: 同 SYS0310（將 roleId 改為 userId）

#### 3.1.5 查詢使用者按鈕列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/buttons`
- **說明**: 查詢指定使用者在指定作業下的按鈕列表
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求參數**:
  - `programId`: 作業代碼（可選）
- **回應格式**: 同 SYS0310（將 roleId 改為 userId）

#### 3.1.6 新增使用者權限
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/{userId}/permissions`
- **說明**: 為指定使用者新增權限（可批量）。**重要**: 新增前需清除該使用者的角色權限對應
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求格式**:
  ```json
  {
    "buttonKeys": [1001, 1002, 1003],
    "clearRolePermissions": true
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "新增成功",
    "data": {
      "addedCount": 3,
      "skippedCount": 0,
      "clearedRoleCount": 2
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.7 設定使用者系統權限（批量）
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/{userId}/systems/permissions`
- **說明**: 批量設定使用者對系統的權限（全選/未選）。**重要**: 設定前需清除該使用者的角色權限對應
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求格式**:
  ```json
  {
    "systemPermissions": [
      {
        "systemId": "SYS001",
        "isAuthorized": true
      }
    ],
    "clearRolePermissions": true
  }
  ```
- **回應格式**: 同 SYS0310（增加 clearedRoleCount 欄位）

#### 3.1.8 設定使用者選單權限（批量）
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/{userId}/menus/permissions`
- **說明**: 批量設定使用者對選單的權限。**重要**: 設定前需清除該使用者的角色權限對應
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求格式**: 同 SYS0310（增加 clearRolePermissions 參數）

#### 3.1.9 設定使用者作業權限（批量）
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/{userId}/programs/permissions`
- **說明**: 批量設定使用者對作業的權限。**重要**: 設定前需清除該使用者的角色權限對應
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求格式**: 同 SYS0310（增加 clearRolePermissions 參數）

#### 3.1.10 設定使用者按鈕權限（批量）
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/{userId}/buttons/permissions`
- **說明**: 批量設定使用者對按鈕的權限。**重要**: 設定前需清除該使用者的角色權限對應
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求格式**: 同 SYS0310（增加 clearRolePermissions 參數）

#### 3.1.11 修改使用者權限
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/users/{userId}/permissions/{tKey}`
- **說明**: 修改單筆使用者權限
- **路徑參數**:
  - `userId`: 使用者代碼
  - `tKey`: 權限主鍵
- **請求格式**: 同 SYS0310

#### 3.1.12 刪除使用者權限
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/users/{userId}/permissions/{tKey}`
- **說明**: 刪除單筆使用者權限
- **路徑參數**:
  - `userId`: 使用者代碼
  - `tKey`: 權限主鍵
- **回應格式**: 同 SYS0310

#### 3.1.13 批量刪除使用者權限
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/users/{userId}/permissions`
- **說明**: 批量刪除使用者權限
- **路徑參數**:
  - `userId`: 使用者代碼
- **請求格式**: 同 SYS0310

---

## 四、前端 UI 設計

### 4.1 主要頁面

#### 4.1.1 使用者權限查詢頁面 (`/sys/users/{userId}/permissions`)
- **功能**: 查詢指定使用者的權限列表
- **主要元件**: 同 SYS0310（將角色改為使用者）

#### 4.1.2 使用者系統權限設定頁面 (`/sys/users/{userId}/systems`)
- **功能**: 設定使用者對系統的權限
- **主要元件**: 同 SYS0310（將角色改為使用者）
- **特殊提示**: 需顯示警告訊息「設定權限後，所有的權限將以本使用者為主，對應之角色將移除」

#### 4.1.3 使用者選單權限設定頁面 (`/sys/users/{userId}/menus`)
- **功能**: 設定使用者對選單的權限
- **主要元件**: 同 SYS0310（將角色改為使用者）

#### 4.1.4 使用者作業權限設定頁面 (`/sys/users/{userId}/programs`)
- **功能**: 設定使用者對作業的權限
- **主要元件**: 同 SYS0310（將角色改為使用者）

#### 4.1.5 使用者按鈕權限設定頁面 (`/sys/users/{userId}/buttons`)
- **功能**: 設定使用者對按鈕的權限
- **主要元件**: 同 SYS0310（將角色改為使用者）

#### 4.1.6 使用者權限新增/修改頁面
- **功能**: 新增或修改單筆使用者權限
- **主要元件**: 同 SYS0310（將角色改為使用者）

### 4.2 UI 元件設計

同 SYS0310

### 4.3 互動流程

#### 4.3.1 系統權限設定流程
1. 選擇使用者
2. **顯示警告**: 「設定權限後，所有的權限將以本使用者為主，對應之角色將移除」
3. 使用者確認後，顯示系統列表（含權限統計）
4. 勾選/取消勾選系統
5. 點擊「設定權限」
6. **後端處理**: 清除該使用者的角色權限對應（UserRoles表）
7. 系統自動設定該系統下所有按鈕的權限
8. 顯示設定結果

其他流程同 SYS0310，但需在設定前清除角色權限對應

---

## 五、業務邏輯

### 5.1 權限繼承規則
同 SYS0310

### 5.2 權限統計計算
同 SYS0310

### 5.3 權限驗證
- 同 SYS0310
- **額外驗證**: 檢查使用者是否存在

### 5.4 批量操作邏輯
- 同 SYS0310
- **重要**: 在批量設定權限前，需先清除該使用者的角色權限對應（UserRoles表中的記錄）

### 5.5 角色權限清除邏輯
- 當設定使用者直接權限時，需清除該使用者在 UserRoles 表中的所有記錄
- 清除操作需在交易中執行，確保資料一致性
- 清除後需記錄操作日誌

---

## 六、錯誤處理

### 6.1 驗證錯誤
- 使用者代碼為空：`ERR_USER_ID_REQUIRED`
- 使用者不存在：`ERR_USER_NOT_FOUND`
- 其他同 SYS0310

### 6.2 業務錯誤
- 無權限操作：`ERR_NO_PERMISSION`
- 清除角色權限失敗：`ERR_CLEAR_ROLE_PERMISSIONS_FAILED`
- 其他同 SYS0310

### 6.3 系統錯誤
同 SYS0310

---

## 七、測試計劃

### 7.1 單元測試
- 同 SYS0310
- **額外測試**: 清除角色權限對應功能測試

### 7.2 整合測試
- 同 SYS0310
- **額外測試**: 設定使用者權限時清除角色權限對應的整合測試

### 7.3 效能測試
同 SYS0310

---

## 八、開發時程

同 SYS0310（6週）

