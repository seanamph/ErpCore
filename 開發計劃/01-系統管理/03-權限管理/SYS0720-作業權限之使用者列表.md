# SYS0720 - 作業權限之使用者列表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0720
- **功能名稱**: 作業權限之使用者列表
- **功能描述**: 查詢指定作業代碼下，哪些使用者擁有該作業的權限，以及這些使用者擁有的按鈕權限列表
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0720_PR.ASP` (報表)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0720_FQ.asp` (查詢)
  - `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_USER_ROLE.cs` (GetProgUserButton方法)

### 1.2 業務需求
- 支援依作業代碼查詢使用者權限列表
- 顯示作業基本資訊（作業代碼、作業名稱）
- 顯示擁有該作業權限的使用者列表（使用者代碼、使用者名稱）
- 顯示每個使用者擁有的按鈕權限（按鈕名稱、頁面代碼）
- 支援報表列印功能
- 支援報表匯出功能（Excel、PDF）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

本功能為查詢報表功能，主要使用以下資料表進行查詢：

#### 2.1.1 `Users` - 使用者主檔
- 參考: `開發計劃/01-系統管理/01-使用者管理/SYS0110-使用者基本資料維護.md`

#### 2.1.2 `Programs` - 作業主檔
```sql
CREATE TABLE [dbo].[Programs] (
    [ProgramId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [MenuId] NVARCHAR(50) NOT NULL,
    [ProgramName] NVARCHAR(100) NOT NULL,
    [ProgramNote] NVARCHAR(500) NULL,
    [ProgramUrl] NVARCHAR(500) NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [SortOrder] INT NULL DEFAULT 0,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Programs] PRIMARY KEY CLUSTERED ([ProgramId] ASC),
    CONSTRAINT [FK_Programs_Menus] FOREIGN KEY ([MenuId]) REFERENCES [dbo].[Menus] ([MenuId])
);
```

#### 2.1.3 `Buttons` - 按鈕主檔
```sql
CREATE TABLE [dbo].[Buttons] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [ProgramId] NVARCHAR(50) NOT NULL,
    [PageId] NVARCHAR(50) NULL,
    [ButtonId] NVARCHAR(50) NOT NULL,
    [ButtonName] NVARCHAR(100) NOT NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1',
    [SortOrder] INT NULL DEFAULT 0,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_Buttons_Programs] FOREIGN KEY ([ProgramId]) REFERENCES [dbo].[Programs] ([ProgramId])
);
```

#### 2.1.4 `RoleButtons` - 使用者/角色按鈕權限
```sql
CREATE TABLE [dbo].[RoleButtons] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [RoleId] NVARCHAR(50) NULL,
    [UserId] NVARCHAR(50) NULL,
    [ButtonKey] BIGINT NOT NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_RoleButtons_Roles] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[Roles] ([RoleId]) ON DELETE CASCADE,
    CONSTRAINT [FK_RoleButtons_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE,
    CONSTRAINT [FK_RoleButtons_Buttons] FOREIGN KEY ([ButtonKey]) REFERENCES [dbo].[Buttons] ([TKey]),
    CONSTRAINT [CK_RoleButtons_UserOrRole] CHECK (([RoleId] IS NOT NULL AND [UserId] IS NULL) OR ([RoleId] IS NULL AND [UserId] IS NOT NULL))
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_RoleButtons_UserId] ON [dbo].[RoleButtons] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_RoleButtons_ButtonKey] ON [dbo].[RoleButtons] ([ButtonKey]);
```

### 2.2 查詢視圖 (View)

為了方便查詢，建議建立以下視圖：

#### 2.2.1 `V_ProgramUserPermission` - 作業使用者權限視圖
```sql
CREATE VIEW [dbo].[V_ProgramUserPermission] AS
SELECT DISTINCT
    P.ProgramId AS PROG_ID,
    P.ProgramName AS PROG_NAME,
    U.UserId AS USER_ID,
    U.UserName AS USER_NAME,
    B.ButtonId AS BUTTON_ID,
    B.ButtonName AS BUTTON_NAME,
    B.PageId AS PAGE_ID
FROM [dbo].[Programs] P
INNER JOIN [dbo].[Buttons] B ON P.ProgramId = B.ProgramId
INNER JOIN [dbo].[RoleButtons] RB ON B.TKey = RB.ButtonKey
INNER JOIN [dbo].[Users] U ON RB.UserId = U.UserId
WHERE RB.UserId IS NOT NULL
  AND RB.RoleId IS NULL
  AND B.Status = '1' 
  AND P.Status = '1';
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| ProgramId | NVARCHAR | 50 | NO | - | 作業代碼 | 主鍵，外鍵至Programs |
| ProgramName | NVARCHAR | 100 | NO | - | 作業名稱 | - |
| UserId | NVARCHAR | 50 | NO | - | 使用者代碼 | 外鍵至Users |
| UserName | NVARCHAR | 100 | NO | - | 使用者名稱 | - |
| ButtonId | NVARCHAR | 50 | NO | - | 按鈕代碼 | - |
| ButtonName | NVARCHAR | 100 | NO | - | 按鈕名稱 | - |
| PageId | NVARCHAR | 50 | YES | - | 頁面代碼 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢作業權限之使用者列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/program-user-permissions/list`
- **說明**: 查詢指定作業代碼下，哪些使用者擁有該作業的權限
- **請求參數**:
  ```json
  {
    "programId": "string"        // 作業代碼（必填）
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "programId": "SYS0110",
      "programName": "使用者基本資料維護",
      "users": [
        {
          "userId": "U001",
          "userName": "張三",
          "buttons": [
            {
              "buttonId": "BTN001",
              "buttonName": "新增",
              "pageId": "FI"
            },
            {
              "buttonId": "BTN002",
              "buttonName": "修改",
              "pageId": "FU"
            }
          ]
        }
      ]
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出作業權限之使用者報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/program-user-permissions/export`
- **說明**: 匯出作業權限之使用者報表（Excel、PDF）
- **請求參數**:
  ```json
  {
    "programId": "string",
    "exportFormat": "Excel|PDF"
  }
  ```
- **回應格式**: 檔案下載

### 3.2 資料傳輸物件 (DTO)

#### 3.2.1 `ProgramUserPermissionListRequestDto`
```csharp
public class ProgramUserPermissionListRequestDto
{
    [Required(ErrorMessage = "作業代碼為必填")]
    public string ProgramId { get; set; } = string.Empty;
}
```

#### 3.2.2 `ProgramUserPermissionListResponseDto`
```csharp
public class ProgramUserPermissionListResponseDto
{
    public string ProgramId { get; set; } = string.Empty;
    public string ProgramName { get; set; } = string.Empty;
    public List<UserPermissionDto> Users { get; set; } = new();
}

public class UserPermissionDto
{
    public string UserId { get; set; } = string.Empty;
    public string UserName { get; set; } = string.Empty;
    public List<ButtonPermissionDto> Buttons { get; set; } = new();
}

public class ButtonPermissionDto
{
    public string ButtonId { get; set; } = string.Empty;
    public string ButtonName { get; set; } = string.Empty;
    public string? PageId { get; set; }
}
```

### 3.3 Service 層設計

#### 3.3.1 `IProgramUserPermissionService`
```csharp
public interface IProgramUserPermissionService
{
    Task<ProgramUserPermissionListResponseDto> GetProgramUserPermissionListAsync(
        ProgramUserPermissionListRequestDto request, 
        CancellationToken cancellationToken = default);
    
    Task<byte[]> ExportProgramUserPermissionReportAsync(
        ProgramUserPermissionListRequestDto request, 
        string exportFormat, 
        CancellationToken cancellationToken = default);
}
```

#### 3.3.2 `ProgramUserPermissionService` 實作重點
- 根據作業代碼查詢使用者權限
- 只查詢使用者直接權限（不包含角色權限）
- 按鈕權限需依頁面代碼分組顯示
- 組織使用者與按鈕權限的對應關係

### 3.4 Repository 層設計

#### 3.4.1 `IProgramUserPermissionRepository`
```csharp
public interface IProgramUserPermissionRepository
{
    Task<Program?> GetProgramByIdAsync(string programId, CancellationToken cancellationToken = default);
    Task<IEnumerable<ProgramUserPermissionQueryResult>> GetProgramUserPermissionsAsync(
        string programId,
        CancellationToken cancellationToken = default);
}
```

#### 3.4.2 `ProgramUserPermissionQueryResult`
```csharp
public class ProgramUserPermissionQueryResult
{
    public string PROG_ID { get; set; } = string.Empty;
    public string PROG_NAME { get; set; } = string.Empty;
    public string USER_ID { get; set; } = string.Empty;
    public string USER_NAME { get; set; } = string.Empty;
    public string BUTTON_ID { get; set; } = string.Empty;
    public string BUTTON_NAME { get; set; } = string.Empty;
    public string? PAGE_ID { get; set; }
}
```

---

## 四、前端 UI 設計

### 4.1 查詢頁面 (`ProgramUserPermissionListQuery.vue`)

#### 4.1.1 頁面結構
- **查詢條件區塊**
  - 作業代碼輸入框（支援自動完成，必填）
  - 查詢按鈕
  - 重置按鈕
  - 匯出按鈕（Excel、PDF）

#### 4.1.2 功能需求
- 作業代碼為必填欄位
- 支援作業代碼自動完成（參考 `PROG_LIST`）
- 查詢結果以表格形式顯示
- 支援報表列印
- 支援報表匯出（Excel、PDF）

### 4.2 報表顯示頁面 (`ProgramUserPermissionListReport.vue`)

#### 4.2.1 頁面結構
- **報表標題區塊**
  - 作業資訊（作業代碼、作業名稱）
  - 查詢時間

- **報表內容區塊**
  - 表格顯示
    - 使用者代碼
    - 使用者名稱
    - 具有權限之功能按鍵（按鈕名稱列表，依頁面代碼分組）

#### 4.2.2 功能需求
- 支援報表列印
- 支援報表匯出（Excel、PDF）
- 支援分頁顯示（如果資料量大）

### 4.3 元件設計

#### 4.3.1 `ProgramUserPermissionTable.vue`
- 表格形式顯示作業使用者權限
- 支援排序
- 支援匯出

### 4.4 API 呼叫 (`program-user-permission.api.ts`)
```typescript
import request from '@/utils/request';

export interface ProgramUserPermissionListRequestDto {
  programId: string;
}

export interface ProgramUserPermissionListResponseDto {
  programId: string;
  programName: string;
  users: UserPermissionDto[];
}

// API 函數
export const getProgramUserPermissionList = (request: ProgramUserPermissionListRequestDto) => {
  return request.get<ApiResponse<ProgramUserPermissionListResponseDto>>(
    '/api/v1/program-user-permissions/list',
    { params: request }
  );
};

export const exportProgramUserPermissionReport = (
  request: ProgramUserPermissionListRequestDto,
  format: 'Excel' | 'PDF'
) => {
  return request.post<Blob>(
    '/api/v1/program-user-permissions/export',
    { request, exportFormat: format },
    { responseType: 'blob' }
  );
};
```

---

## 五、後端實作類別

### 5.1 Controller: `ProgramUserPermissionController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/program-user-permissions")]
    [Authorize]
    public class ProgramUserPermissionController : ControllerBase
    {
        private readonly IProgramUserPermissionService _programUserPermissionService;
        private readonly ILogger<ProgramUserPermissionController> _logger;
        
        public ProgramUserPermissionController(
            IProgramUserPermissionService programUserPermissionService,
            ILogger<ProgramUserPermissionController> logger)
        {
            _programUserPermissionService = programUserPermissionService;
            _logger = logger;
        }
        
        [HttpGet("list")]
        public async Task<ActionResult<ApiResponse<ProgramUserPermissionListResponseDto>>> GetProgramUserPermissionList(
            [FromQuery] ProgramUserPermissionListRequestDto request,
            CancellationToken cancellationToken = default)
        {
            try
            {
                var result = await _programUserPermissionService.GetProgramUserPermissionListAsync(request, cancellationToken);
                
                return Ok(new ApiResponse<ProgramUserPermissionListResponseDto>
                {
                    Success = true,
                    Data = result,
                    Message = "查詢成功"
                });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "查詢作業權限之使用者列表失敗");
                return StatusCode(500, new ApiResponse<ProgramUserPermissionListResponseDto>
                {
                    Success = false,
                    Message = "查詢作業權限之使用者列表失敗"
                });
            }
        }
        
        [HttpPost("export")]
        public async Task<IActionResult> ExportProgramUserPermissionReport(
            [FromBody] ProgramUserPermissionExportRequestDto request,
            CancellationToken cancellationToken = default)
        {
            try
            {
                var fileBytes = await _programUserPermissionService.ExportProgramUserPermissionReportAsync(
                    request.Request,
                    request.ExportFormat,
                    cancellationToken);

                var contentType = request.ExportFormat == "Excel" 
                    ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                    : "application/pdf";
                
                var fileName = $"作業權限之使用者列表_{request.Request.ProgramId}_{DateTime.Now:yyyyMMddHHmmss}.{(request.ExportFormat == "Excel" ? "xlsx" : "pdf")}";

                return File(fileBytes, contentType, fileName);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "匯出作業權限之使用者報表失敗");
                return StatusCode(500, new ApiResponse<object>
                {
                    Success = false,
                    Message = "匯出作業權限之使用者報表失敗"
                });
            }
        }
    }
}
```

### 5.2 Service: `ProgramUserPermissionService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public class ProgramUserPermissionService : IProgramUserPermissionService
    {
        private readonly IProgramUserPermissionRepository _repository;
        private readonly ILogger<ProgramUserPermissionService> _logger;

        public ProgramUserPermissionService(
            IProgramUserPermissionRepository repository,
            ILogger<ProgramUserPermissionService> logger)
        {
            _repository = repository;
            _logger = logger;
        }

        public async Task<ProgramUserPermissionListResponseDto> GetProgramUserPermissionListAsync(
            ProgramUserPermissionListRequestDto request,
            CancellationToken cancellationToken = default)
        {
            // 驗證作業是否存在
            var program = await _repository.GetProgramByIdAsync(request.ProgramId, cancellationToken);
            if (program == null)
            {
                throw new NotFoundException($"作業 {request.ProgramId} 不存在");
            }

            // 查詢權限資料
            var queryResults = await _repository.GetProgramUserPermissionsAsync(
                request.ProgramId,
                cancellationToken);

            // 組織使用者與按鈕權限的對應關係
            var response = new ProgramUserPermissionListResponseDto
            {
                ProgramId = program.ProgramId,
                ProgramName = program.ProgramName,
                Users = new List<UserPermissionDto>()
            };

            var userDict = new Dictionary<string, UserPermissionDto>();

            foreach (var item in queryResults)
            {
                // 使用者層級
                if (!userDict.ContainsKey(item.USER_ID))
                {
                    userDict[item.USER_ID] = new UserPermissionDto
                    {
                        UserId = item.USER_ID,
                        UserName = item.USER_NAME,
                        Buttons = new List<ButtonPermissionDto>()
                    };
                }

                // 按鈕層級
                var button = new ButtonPermissionDto
                {
                    ButtonId = item.BUTTON_ID,
                    ButtonName = item.BUTTON_NAME,
                    PageId = item.PAGE_ID
                };
                userDict[item.USER_ID].Buttons.Add(button);
            }

            response.Users = userDict.Values.OrderBy(x => x.UserId).ToList();
            return response;
        }

        public async Task<byte[]> ExportProgramUserPermissionReportAsync(
            ProgramUserPermissionListRequestDto request,
            string exportFormat,
            CancellationToken cancellationToken = default)
        {
            var data = await GetProgramUserPermissionListAsync(request, cancellationToken);

            if (exportFormat == "Excel")
            {
                return ExportToExcel(data);
            }
            else
            {
                return ExportToPdf(data);
            }
        }

        private byte[] ExportToExcel(ProgramUserPermissionListResponseDto data)
        {
            // 使用 EPPlus 或 NPOI 實作 Excel 匯出
            // ...
            throw new NotImplementedException();
        }

        private byte[] ExportToPdf(ProgramUserPermissionListResponseDto data)
        {
            // 使用 iTextSharp 或 QuestPDF 實作 PDF 匯出
            // ...
            throw new NotImplementedException();
        }
    }
}
```

### 5.3 Repository: `ProgramUserPermissionRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public class ProgramUserPermissionRepository : IProgramUserPermissionRepository
    {
        private readonly IDbConnection _dbConnection;

        public ProgramUserPermissionRepository(IDbConnection dbConnection)
        {
            _dbConnection = dbConnection;
        }

        public async Task<Program?> GetProgramByIdAsync(string programId, CancellationToken cancellationToken = default)
        {
            const string sql = @"
                SELECT ProgramId, ProgramName, MenuId, ProgramNote, ProgramUrl, Status, SortOrder, CreatedBy, CreatedAt, UpdatedBy, UpdatedAt
                FROM [dbo].[Programs]
                WHERE ProgramId = @ProgramId AND Status = '1'";

            var result = await _dbConnection.QueryFirstOrDefaultAsync<Program>(
                sql,
                new { ProgramId = programId },
                cancellationToken: cancellationToken);

            return result;
        }

        public async Task<IEnumerable<ProgramUserPermissionQueryResult>> GetProgramUserPermissionsAsync(
            string programId,
            CancellationToken cancellationToken = default)
        {
            const string sql = @"
                SELECT 
                    V.PROG_ID,
                    V.PROG_NAME,
                    V.USER_ID,
                    V.USER_NAME,
                    V.BUTTON_ID,
                    V.BUTTON_NAME,
                    V.PAGE_ID
                FROM [dbo].[V_ProgramUserPermission] V
                WHERE V.PROG_ID = @ProgramId
                ORDER BY V.USER_ID, V.PAGE_ID, V.BUTTON_ID";

            var results = await _dbConnection.QueryAsync<ProgramUserPermissionQueryResult>(
                sql,
                new { ProgramId = programId },
                cancellationToken: cancellationToken);

            return results;
        }
    }
}
```

---

## 六、開發時程

### 6.1 階段一: 資料庫設計 (0.5天)
- [ ] 建立查詢視圖 `V_ProgramUserPermission`
- [ ] 建立索引
- [ ] 驗證查詢效能

### 6.2 階段二: 後端開發 (2天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 驗證邏輯實作
- [ ] 單元測試

### 6.3 階段三: 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 查詢頁面開發
- [ ] 報表顯示頁面開發
- [ ] 表格元件開發
- [ ] 表單驗證
- [ ] 元件測試

### 6.4 階段四: 整合測試 (0.5天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試

### 6.5 階段五: 文件與部署 (0.5天)
- [ ] API 文件更新
- [ ] 使用者手冊

**總計**: 5.5天

---

## 七、注意事項

### 7.1 效能優化
- 使用視圖 `V_ProgramUserPermission` 簡化查詢
- 建立適當的索引以提升查詢效能
- 如果資料量大，考慮使用分頁或虛擬滾動

### 7.2 資料驗證
- 作業代碼必須存在
- 作業代碼為必填欄位

### 7.3 業務邏輯
- 只查詢使用者直接權限（不包含角色權限）
- 按鈕權限需依頁面代碼分組顯示
- 報表格式需符合舊系統格式

### 7.4 多語言支援
- 作業名稱、按鈕名稱需支援多語言顯示

---

## 八、測試案例

### 8.1 單元測試
- [ ] 查詢作業權限之使用者列表成功
- [ ] 查詢作業權限之使用者列表失敗（作業不存在）
- [ ] 查詢作業權限之使用者列表失敗（作業代碼為空）
- [ ] 資料轉換邏輯測試

### 8.2 整合測試
- [ ] API 端點測試
- [ ] 資料庫查詢測試
- [ ] 權限驗證測試

### 8.3 前端測試
- [ ] 查詢表單驗證測試
- [ ] 資料顯示測試
- [ ] 匯出功能測試

---

## 九、參考資料

### 9.1 舊程式碼
- `WEB/IMS_CORE/ASP/SYS0000/SYS0720_PR.ASP`
- `WEB/IMS_CORE/ASP/SYS0000/SYS0720_FQ.asp`
- `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_USER_ROLE.cs` (GetProgUserButton方法)

### 9.2 相關功能
- SYS0740 - 作業權限之角色列表
- SYS0320 - 使用者系統權限設定
- SYS0430 - 系統作業資料維護

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

