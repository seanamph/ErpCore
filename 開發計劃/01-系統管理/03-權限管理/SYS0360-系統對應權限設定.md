# SYS0360 - 系統對應權限設定 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0360
- **功能名稱**: 系統對應權限設定作業
- **功能描述**: 為指定項目（ITEM_ID）設定系統、選單、作業、按鈕等層級的權限，管理項目對系統功能的存取控制。項目對應表（MNG_IP_CORRESPOND）用於定義可設定權限的項目類型
- **參考舊程式**: 
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0360.ascx`
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0360_SYS_LIST.aspx` (系統列表)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0360_SET_SYS_AC.aspx` (設定系統權限)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0360_SET_MENU_AC.aspx` (設定選單權限)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0360_SET_PROG_AC.aspx` (設定作業權限)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0360_SET_BUTTON_AC.aspx` (設定按鈕權限)
  - `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_IP_BUTTON.cs`

### 1.2 業務需求
- 為指定項目（ITEM_ID）設定系統層級權限（全選/未選）
- 為指定項目設定選單層級權限
- 為指定項目設定作業層級權限
- 為指定項目設定按鈕層級權限
- 支援批量設定權限
- 支援權限繼承（系統→選單→作業→按鈕）
- 查看項目已設定的權限列表
- 支援權限的查詢、新增、修改、刪除
- 項目對應表管理（MNG_IP_CORRESPOND）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `ItemPermissions` (項目權限對應，對應舊系統 `MNG_IP_BUTTON`)

```sql
CREATE TABLE [dbo].[ItemPermissions] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [ItemId] NVARCHAR(50) NOT NULL, -- 項目代碼 (ITEM_ID)
    [ProgramId] NVARCHAR(50) NOT NULL, -- 作業代碼 (PROG_ID)
    [PageId] NVARCHAR(50) NOT NULL, -- 頁面代碼 (PAGE_ID)
    [ButtonId] NVARCHAR(50) NOT NULL, -- 按鈕代碼 (BUTTON_ID)
    [ButtonKey] BIGINT NULL, -- 對應到 Buttons 表的 TKey
    [CreatedBy] NVARCHAR(50) NULL, -- 建立者 (BUSER)
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 建立時間 (BTIME)
    [UpdatedBy] NVARCHAR(50) NULL, -- 更新者 (CUSER)
    [UpdatedAt] DATETIME2 NULL, -- 更新時間 (CTIME)
    [CreatedPriority] INT NULL, -- 建立者等級 (CPRIORITY)
    [CreatedGroup] NVARCHAR(50) NULL, -- 建立者群組 (CGROUP)
    CONSTRAINT [PK_ItemPermissions] PRIMARY KEY CLUSTERED ([TKey] ASC),
    CONSTRAINT [FK_ItemPermissions_Items] FOREIGN KEY ([ItemId]) REFERENCES [dbo].[ItemCorresponds] ([ItemId]) ON DELETE CASCADE,
    CONSTRAINT [FK_ItemPermissions_Buttons] FOREIGN KEY ([ButtonKey]) REFERENCES [dbo].[Buttons] ([TKey]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ItemPermissions_ItemId] ON [dbo].[ItemPermissions] ([ItemId]);
CREATE NONCLUSTERED INDEX [IX_ItemPermissions_ProgramId] ON [dbo].[ItemPermissions] ([ProgramId]);
CREATE NONCLUSTERED INDEX [IX_ItemPermissions_PageId] ON [dbo].[ItemPermissions] ([PageId]);
CREATE NONCLUSTERED INDEX [IX_ItemPermissions_ButtonId] ON [dbo].[ItemPermissions] ([ButtonId]);
CREATE UNIQUE NONCLUSTERED INDEX [IX_ItemPermissions_ItemId_ProgramId_PageId_ButtonId] 
    ON [dbo].[ItemPermissions] ([ItemId], [ProgramId], [PageId], [ButtonId]);
```

### 2.2 相關資料表

#### 2.2.1 `ItemCorresponds` - 項目對應主檔 (對應舊系統 `MNG_IP_CORRESPOND`)
```sql
CREATE TABLE [dbo].[ItemCorresponds] (
    [ItemId] NVARCHAR(50) NOT NULL PRIMARY KEY, -- 項目代碼 (ITEM_ID)
    [ItemName] NVARCHAR(100) NOT NULL, -- 項目名稱 (ITEM_NAME)
    [ItemType] NVARCHAR(20) NULL, -- 項目類型
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1', -- 狀態 (1:啟用, 0:停用)
    [Notes] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NULL,
    CONSTRAINT [PK_ItemCorresponds] PRIMARY KEY CLUSTERED ([ItemId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ItemCorresponds_ItemName] ON [dbo].[ItemCorresponds] ([ItemName]);
CREATE NONCLUSTERED INDEX [IX_ItemCorresponds_ItemType] ON [dbo].[ItemCorresponds] ([ItemType]);
```

#### 2.2.2 `Systems` - 系統主檔
```sql
-- 參考 SYS0310 開發計劃
```

#### 2.2.3 `Menus` - 選單主檔
```sql
-- 參考 SYS0310 開發計劃
```

#### 2.2.4 `Programs` - 作業主檔
```sql
-- 參考 SYS0310 開發計劃
```

#### 2.2.5 `Buttons` - 按鈕主檔
```sql
-- 參考 SYS0310 開發計劃
```

### 2.3 資料字典

#### ItemPermissions 表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| TKey | BIGINT | - | NO | IDENTITY | 主鍵 | 自動遞增 |
| ItemId | NVARCHAR | 50 | NO | - | 項目代碼 | 外鍵至 ItemCorresponds |
| ProgramId | NVARCHAR | 50 | NO | - | 作業代碼 | - |
| PageId | NVARCHAR | 50 | NO | - | 頁面代碼 | - |
| ButtonId | NVARCHAR | 50 | NO | - | 按鈕代碼 | - |
| ButtonKey | BIGINT | - | YES | - | 按鈕主鍵 | 外鍵至 Buttons.TKey |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | YES | - | 更新時間 | - |
| CreatedPriority | INT | - | YES | - | 建立者等級 | - |
| CreatedGroup | NVARCHAR | 50 | YES | - | 建立者群組 | - |

#### ItemCorresponds 表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| ItemId | NVARCHAR | 50 | NO | - | 項目代碼 | 主鍵，唯一 |
| ItemName | NVARCHAR | 100 | NO | - | 項目名稱 | - |
| ItemType | NVARCHAR | 20 | YES | - | 項目類型 | - |
| Status | NVARCHAR | 10 | NO | '1' | 狀態 | 1:啟用, 0:停用 |
| Notes | NVARCHAR | 500 | YES | - | 備註 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | YES | - | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢項目列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/item-corresponds`
- **說明**: 查詢項目對應列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "ItemId",
    "sortOrder": "ASC",
    "filters": {
      "itemId": "",
      "itemName": "",
      "itemType": "",
      "status": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "itemId": "ITEM001",
          "itemName": "項目名稱",
          "itemType": "TYPE001",
          "status": "1",
          "notes": "備註",
          "createdBy": "ADMIN",
          "createdAt": "2024-01-01T10:00:00"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20
    }
  }
  ```

#### 3.1.2 查詢項目系統列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/item-corresponds/{itemId}/systems`
- **說明**: 查詢指定項目的系統列表及權限狀態
- **路徑參數**:
  - `itemId`: 項目代碼
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "systemId": "SYS001",
          "systemName": "系統管理",
          "permissionCount": 10,
          "totalCount": 15,
          "status": "全選" // 全選/部份/未選
        }
      ]
    }
  }
  ```

#### 3.1.3 設定項目系統權限
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/item-corresponds/{itemId}/systems/permissions`
- **說明**: 批量設定指定項目的系統權限
- **路徑參數**:
  - `itemId`: 項目代碼
- **請求格式**:
  ```json
  {
    "systemIds": ["SYS001", "SYS002"], // 要設定的系統ID列表
    "action": "grant" // grant: 授予權限, revoke: 撤銷權限
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "設定成功",
    "data": {
      "grantedCount": 10,
      "revokedCount": 5
    }
  }
  ```

#### 3.1.4 查詢項目選單列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/item-corresponds/{itemId}/systems/{systemId}/menus`
- **說明**: 查詢指定項目在指定系統下的選單列表及權限狀態
- **路徑參數**:
  - `itemId`: 項目代碼
  - `systemId`: 系統代碼
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "menuId": "MENU001",
          "menuName": "使用者管理",
          "permissionCount": 5,
          "totalCount": 8,
          "status": "部份"
        }
      ]
    }
  }
  ```

#### 3.1.5 設定項目選單權限
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/item-corresponds/{itemId}/menus/permissions`
- **說明**: 批量設定指定項目的選單權限
- **路徑參數**:
  - `itemId`: 項目代碼
- **請求格式**:
  ```json
  {
    "menuIds": ["MENU001", "MENU002"],
    "action": "grant"
  }
  ```

#### 3.1.6 查詢項目作業列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/item-corresponds/{itemId}/menus/{menuId}/programs`
- **說明**: 查詢指定項目在指定選單下的作業列表及權限狀態
- **路徑參數**:
  - `itemId`: 項目代碼
  - `menuId`: 選單代碼
- **請求參數**:
  ```json
  {
    "filter": "" // 篩選條件
  }
  ```

#### 3.1.7 設定項目作業權限
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/item-corresponds/{itemId}/programs/permissions`
- **說明**: 批量設定指定項目的作業權限
- **路徑參數**:
  - `itemId`: 項目代碼
- **請求格式**:
  ```json
  {
    "programIds": ["SYS0110", "SYS0210"],
    "action": "grant"
  }
  ```

#### 3.1.8 查詢項目按鈕列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/item-corresponds/{itemId}/programs/{programId}/buttons`
- **說明**: 查詢指定項目在指定作業下的按鈕列表及權限狀態
- **路徑參數**:
  - `itemId`: 項目代碼
  - `programId`: 作業代碼

#### 3.1.9 設定項目按鈕權限
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/item-corresponds/{itemId}/buttons/permissions`
- **說明**: 批量設定指定項目的按鈕權限
- **路徑參數**:
  - `itemId`: 項目代碼
- **請求格式**:
  ```json
  {
    "buttonKeys": [1001, 1002, 1003],
    "action": "grant"
  }
  ```

#### 3.1.10 新增項目對應
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/item-corresponds`
- **說明**: 新增項目對應資料
- **請求格式**:
  ```json
  {
    "itemId": "ITEM001",
    "itemName": "項目名稱",
    "itemType": "TYPE001",
    "status": "1",
    "notes": "備註"
  }
  ```

#### 3.1.11 修改項目對應
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/item-corresponds/{itemId}`
- **說明**: 修改項目對應資料
- **路徑參數**:
  - `itemId`: 項目代碼

#### 3.1.12 刪除項目對應
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/item-corresponds/{itemId}`
- **說明**: 刪除項目對應資料（會級聯刪除相關權限）
- **路徑參數**:
  - `itemId`: 項目代碼

#### 3.1.13 查詢項目權限列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/item-corresponds/{itemId}/permissions`
- **說明**: 查詢指定項目的完整權限列表
- **路徑參數**:
  - `itemId`: 項目代碼
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "filters": {
      "systemId": "",
      "menuId": "",
      "programId": "",
      "buttonKey": ""
    }
  }
  ```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 項目選擇頁面 (`/sys0360`)
- **功能**: 選擇要設定權限的項目
- **主要元件**:
  - 項目查詢表單（項目代碼、項目名稱、項目類型）
  - 項目列表表格（支援分頁、排序）
  - 操作按鈕：查詢、重置、設定權限

#### 4.1.2 系統權限設定頁面 (`/sys0360/{itemId}/systems`)
- **功能**: 設定項目的系統層級權限
- **主要元件**:
  - 項目資訊顯示（項目代碼、項目名稱）
  - 系統列表表格
    - 序號
    - 是否全選（下拉選單：全選/部份/未選）
    - 系統代碼
    - 系統名稱
    - 權限統計（已設定/總數）
  - 操作按鈕：設定權限、重新設定其他項目、返回

#### 4.1.3 選單權限設定頁面 (`/sys0360/{itemId}/systems/{systemId}/menus`)
- **功能**: 設定項目在指定系統下的選單權限
- **主要元件**:
  - 系統資訊顯示
  - 選單列表表格
  - 操作按鈕：設定權限、返回

#### 4.1.4 作業權限設定頁面 (`/sys0360/{itemId}/menus/{menuId}/programs`)
- **功能**: 設定項目在指定選單下的作業權限
- **主要元件**:
  - 選單資訊顯示
  - 作業列表表格（支援篩選）
  - 操作按鈕：設定權限、返回

#### 4.1.5 按鈕權限設定頁面 (`/sys0360/{itemId}/programs/{programId}/buttons`)
- **功能**: 設定項目在指定作業下的按鈕權限
- **主要元件**:
  - 作業資訊顯示
  - 按鈕列表表格
  - 操作按鈕：設定權限、返回

### 4.2 UI 元件設計

#### 4.2.1 項目選擇元件
```vue
<template>
  <div class="item-select-page">
    <el-form :model="queryForm" inline>
      <el-form-item label="項目代碼">
        <el-input v-model="queryForm.itemId" />
      </el-form-item>
      <el-form-item label="項目名稱">
        <el-input v-model="queryForm.itemName" />
      </el-form-item>
      <el-form-item>
        <el-button type="primary" @click="handleSearch">查詢</el-button>
        <el-button @click="handleReset">重置</el-button>
      </el-form-item>
    </el-form>
    
    <el-table :data="itemList" v-loading="loading">
      <el-table-column prop="itemId" label="項目代碼" />
      <el-table-column prop="itemName" label="項目名稱" />
      <el-table-column prop="itemType" label="項目類型" />
      <el-table-column prop="status" label="狀態" />
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button type="primary" @click="handleSetPermission(row.itemId)">
            設定權限
          </el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

#### 4.2.2 系統權限設定元件
```vue
<template>
  <div class="system-permission-page">
    <div class="item-info">
      <el-tag>項目代碼: {{ itemId }}</el-tag>
      <el-tag>項目名稱: {{ itemName }}</el-tag>
    </div>
    
    <el-table :data="systemList" v-loading="loading">
      <el-table-column type="index" label="序號" width="80" />
      <el-table-column label="是否全選" width="120">
        <template #default="{ row }">
          <el-select v-model="row.status" @change="handleStatusChange(row)">
            <el-option label="全選" value="全選" />
            <el-option label="部份" value="部份" />
            <el-option label="未選" value="未選" />
          </el-select>
        </template>
      </el-table-column>
      <el-table-column prop="systemId" label="系統代碼" />
      <el-table-column prop="systemName" label="系統名稱" />
      <el-table-column label="權限統計">
        <template #default="{ row }">
          {{ row.permissionCount }} / {{ row.totalCount }}
        </template>
      </el-table-column>
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button type="primary" @click="handleSetMenuPermission(row)">
            設定選單權限
          </el-button>
        </template>
      </el-table-column>
    </el-table>
    
    <div class="action-buttons">
      <el-button type="primary" @click="handleSave">設定權限</el-button>
      <el-button @click="handleReset">重新設定其他項目</el-button>
    </div>
  </div>
</template>
```

### 4.3 狀態管理

使用 Pinia 管理狀態：
- `itemCorrespondStore`: 項目對應資料
- `itemPermissionStore`: 項目權限資料

---

## 五、業務邏輯

### 5.1 權限設定邏輯

#### 5.1.1 系統權限設定
- 當選擇「全選」時，自動為該系統下的所有選單、作業、按鈕授予權限
- 當選擇「未選」時，自動撤銷該系統下的所有權限
- 當選擇「部份」時，保持現有權限狀態

#### 5.1.2 選單權限設定
- 當設定選單權限時，會影響該選單下的所有作業和按鈕
- 支援批量設定多個選單

#### 5.1.3 作業權限設定
- 當設定作業權限時，會影響該作業下的所有按鈕
- 支援篩選功能，方便查找特定作業

#### 5.1.4 按鈕權限設定
- 最細粒度的權限控制
- 支援批量設定多個按鈕

### 5.2 權限繼承邏輯

- 系統 → 選單 → 作業 → 按鈕的層級繼承
- 上層權限撤銷時，下層權限自動撤銷
- 下層權限設定時，不影響上層權限狀態

### 5.3 資料驗證

- 項目代碼必須存在於 ItemCorresponds 表
- 系統、選單、作業、按鈕必須存在且狀態為啟用
- 權限設定時需檢查重複設定

---

## 六、錯誤處理

### 6.1 常見錯誤

- **項目不存在**: 當查詢的項目代碼不存在時，返回錯誤訊息
- **權限設定失敗**: 當批量設定權限時，部分失敗需記錄詳細錯誤
- **資料庫錯誤**: 交易失敗時需回滾所有變更

### 6.2 錯誤訊息

- 使用統一的錯誤回應格式
- 記錄詳細的錯誤日誌
- 提供使用者友善的錯誤提示

---

## 七、測試計劃

### 7.1 單元測試

- ItemPermissionService 的 CRUD 操作
- 權限設定邏輯測試
- 權限繼承邏輯測試

### 7.2 整合測試

- API 端點測試
- 資料庫交易測試
- 權限設定流程測試

### 7.3 前端測試

- 元件渲染測試
- 使用者互動測試
- 表單驗證測試

---

## 八、開發時程

- **階段一**: 資料庫設計與 API 開發（3天）
- **階段二**: 前端頁面開發（4天）
- **階段三**: 業務邏輯實作（2天）
- **階段四**: 測試與優化（2天）

**總計**: 11天

---

## 九、注意事項

1. 項目對應表（ItemCorresponds）需先建立，才能設定權限
2. 權限設定會影響系統的存取控制，需謹慎操作
3. 批量設定權限時，建議使用交易確保資料一致性
4. 權限統計需即時更新，確保顯示準確
5. 支援權限匯出/匯入功能（可選）

