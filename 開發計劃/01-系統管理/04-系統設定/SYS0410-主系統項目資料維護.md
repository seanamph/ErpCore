# SYS0410 - 主系統項目資料維護 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0410
- **功能名稱**: 主系統項目資料維護
- **功能描述**: 提供主系統項目資料的新增、修改、刪除、查詢功能，包含主系統代碼、主系統名稱、系統型態、伺服器主機名稱等資訊管理
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0410_FB.ASP` (瀏覽)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0410_FI.ASP` (新增)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0410_FU.ASP` (修改)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0410_FD.ASP` (刪除)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0410_FQ.ASP` (查詢)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0410_PR.ASP` (報表)
  - `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_SYS.cs` (業務邏輯)

### 1.2 業務需求
- 管理系統主系統項目資訊
- 支援主系統的新增、修改、刪除、查詢
- 記錄主系統的建立與變更資訊
- 支援系統型態設定
- 支援排序序號設定
- 與子系統、作業、按鈕權限系統整合

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Systems` (對應舊系統 `MNG_SYS`)

```sql
CREATE TABLE [dbo].[Systems] (
    [SystemId] NVARCHAR(50) NOT NULL PRIMARY KEY, -- 主系統代碼 (SYS_ID)
    [SystemName] NVARCHAR(100) NOT NULL, -- 主系統名稱 (SYS_NAME)
    [SeqNo] INT NULL, -- 排序序號 (SEQ_NO)
    [SystemType] NVARCHAR(20) NULL, -- 系統型態 (SYS_TYPE)
    [ServerIp] NVARCHAR(100) NULL, -- 伺服器主機名稱 (SERVER_IP)
    [ModuleId] NVARCHAR(50) NULL, -- 模組代碼 (MODULE_ID)
    [DbUser] NVARCHAR(50) NULL, -- 資料庫使用者 (DB_USER)
    [DbPass] NVARCHAR(255) NULL, -- 資料庫密碼 (DB_PASS，加密儲存)
    [Notes] NVARCHAR(500) NULL, -- 備註 (NOTES)
    [Status] NVARCHAR(10) NULL DEFAULT 'A', -- 狀態 (STATUS)
    [CreatedBy] NVARCHAR(50) NULL, -- 建立者 (BUSER)
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 建立時間 (BTIME)
    [UpdatedBy] NVARCHAR(50) NULL, -- 更新者 (CUSER)
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 更新時間 (CTIME)
    [CreatedPriority] INT NULL, -- 建立者等級 (CPRIORITY)
    [CreatedGroup] NVARCHAR(50) NULL, -- 建立者群組 (CGROUP)
    CONSTRAINT [PK_Systems] PRIMARY KEY CLUSTERED ([SystemId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_Systems_SystemName] ON [dbo].[Systems] ([SystemName]);
CREATE NONCLUSTERED INDEX [IX_Systems_SystemType] ON [dbo].[Systems] ([SystemType]);
CREATE NONCLUSTERED INDEX [IX_Systems_SeqNo] ON [dbo].[Systems] ([SeqNo]);
```

### 2.2 相關資料表

#### 2.2.1 `SubSystems` - 子系統主檔
- 用於查詢子系統列表
- 參考: `開發計劃/01-系統管理/04-系統設定/SYS0420-子系統項目資料維護.md`

#### 2.2.2 `Programs` - 作業主檔
- 用於查詢作業列表
- 參考: `開發計劃/01-系統管理/04-系統設定/SYS0430-系統作業資料維護.md`

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| SystemId | NVARCHAR | 50 | NO | - | 主系統代碼 | 主鍵，唯一 |
| SystemName | NVARCHAR | 100 | NO | - | 主系統名稱 | - |
| SeqNo | INT | - | YES | - | 排序序號 | - |
| SystemType | NVARCHAR | 20 | YES | - | 系統型態 | 參考參數表 PARAM (TITLE='PROG_TYPE') |
| ServerIp | NVARCHAR | 100 | YES | - | 伺服器主機名稱 | - |
| ModuleId | NVARCHAR | 50 | YES | - | 模組代碼 | - |
| DbUser | NVARCHAR | 50 | YES | - | 資料庫使用者 | - |
| DbPass | NVARCHAR | 255 | YES | - | 資料庫密碼 | 加密儲存 |
| Notes | NVARCHAR | 500 | YES | - | 備註 | - |
| Status | NVARCHAR | 10 | YES | 'A' | 狀態 | A:啟用, I:停用 |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |
| CreatedPriority | INT | - | YES | - | 建立者等級 | - |
| CreatedGroup | NVARCHAR | 50 | YES | - | 建立者群組 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢主系統列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/systems`
- **說明**: 查詢主系統列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "SystemId",
    "sortOrder": "ASC",
    "filters": {
      "systemId": "",
      "systemName": "",
      "systemType": "",
      "serverIp": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "systemId": "SYS0000",
          "systemName": "系統管理",
          "seqNo": 1,
          "systemType": "1",
          "systemTypeName": "主系統",
          "serverIp": "192.168.1.1",
          "moduleId": "MOD001",
          "notes": "備註",
          "status": "A",
          "createdAt": "2024-01-01T00:00:00",
          "updatedAt": "2024-01-01T00:00:00"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆主系統
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/systems/{systemId}`
- **說明**: 根據主系統代碼查詢單筆主系統資料
- **路徑參數**:
  - `systemId`: 主系統代碼
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "systemId": "SYS0000",
      "systemName": "系統管理",
      "seqNo": 1,
      "systemType": "1",
      "systemTypeName": "主系統",
      "serverIp": "192.168.1.1",
      "moduleId": "MOD001",
      "dbUser": "dbuser",
      "notes": "備註",
      "status": "A",
      "createdBy": "U001",
      "createdAt": "2024-01-01T00:00:00",
      "updatedBy": "U001",
      "updatedAt": "2024-01-01T00:00:00"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 新增主系統
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/systems`
- **說明**: 新增主系統資料
- **請求格式**:
  ```json
  {
    "systemId": "SYS0000",
    "systemName": "系統管理",
    "seqNo": 1,
    "systemType": "1",
    "serverIp": "192.168.1.1",
    "moduleId": "MOD001",
    "dbUser": "dbuser",
    "dbPass": "dbpassword",
    "notes": "備註",
    "status": "A"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "新增成功",
    "data": {
      "systemId": "SYS0000"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 修改主系統
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/systems/{systemId}`
- **說明**: 修改主系統資料
- **路徑參數**:
  - `systemId`: 主系統代碼
- **請求格式**: 同新增，但 `systemId` 不可修改
- **回應格式**: 同新增

#### 3.1.5 刪除主系統
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/systems/{systemId}`
- **說明**: 刪除主系統資料（需檢查是否有子系統、作業、按鈕等關聯資料）
- **路徑參數**:
  - `systemId`: 主系統代碼
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.6 批次刪除主系統
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/systems/batch`
- **說明**: 批次刪除多筆主系統
- **請求格式**:
  ```json
  {
    "systemIds": ["SYS0000", "SYS0001", "SYS0002"]
  }
  ```

#### 3.1.7 取得系統型態選項
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/systems/system-types`
- **說明**: 取得系統型態選項列表（從參數表 PARAM 取得，TITLE='PROG_TYPE'）
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": [
      {
        "value": "1",
        "label": "主系統"
      },
      {
        "value": "2",
        "label": "子系統"
      }
    ],
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

---

## 四、前端 UI 設計

### 4.1 查詢頁面 (`SYS0410Query.vue`)

#### 4.1.1 頁面結構
```vue
<template>
  <div class="sys0410-query">
    <el-card>
      <template #header>
        <span>主系統項目資料維護 - 查詢</span>
      </template>
      
      <el-form :model="queryForm" ref="queryFormRef" label-width="150px" inline>
        <!-- 主系統代碼 -->
        <el-form-item label="主系統代碼">
          <el-input 
            v-model="queryForm.systemId" 
            placeholder="請輸入主系統代碼"
            clearable
            style="width: 200px"
          />
        </el-form-item>
        
        <!-- 主系統名稱 -->
        <el-form-item label="主系統名稱">
          <el-input 
            v-model="queryForm.systemName" 
            placeholder="請輸入主系統名稱"
            clearable
            style="width: 200px"
          />
        </el-form-item>
        
        <!-- 系統型態 -->
        <el-form-item label="系統型態">
          <el-select 
            v-model="queryForm.systemType" 
            placeholder="請選擇系統型態"
            clearable
            multiple
            style="width: 200px"
          >
            <el-option
              v-for="item in systemTypeOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            />
          </el-select>
        </el-form-item>
        
        <!-- 伺服器主機名稱 -->
        <el-form-item label="伺服器主機名稱">
          <el-input 
            v-model="queryForm.serverIp" 
            placeholder="請輸入伺服器主機名稱"
            clearable
            style="width: 200px"
          />
        </el-form-item>
        
        <!-- 查詢按鈕 -->
        <el-form-item>
          <el-button type="primary" icon="Search" @click="handleSearch">查詢</el-button>
          <el-button icon="Refresh" @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 查詢結果 -->
    <el-card v-if="searchResult.length > 0" style="margin-top: 20px">
      <template #header>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <span>查詢結果 (共 {{ totalCount }} 筆)</span>
          <div>
            <el-button type="primary" icon="Plus" @click="handleAdd">新增</el-button>
            <el-button type="danger" icon="Delete" @click="handleBatchDelete" :disabled="selectedRows.length === 0">批次刪除</el-button>
            <el-button type="success" icon="Printer" @click="handlePrint">列印</el-button>
          </div>
        </div>
      </template>
      
      <el-table 
        :data="searchResult" 
        border 
        stripe 
        style="width: 100%"
        @selection-change="handleSelectionChange"
      >
        <el-table-column type="selection" width="55" align="center" />
        <el-table-column type="index" label="序號" width="60" align="center" />
        <el-table-column prop="systemId" label="主系統代碼" width="120" sortable />
        <el-table-column prop="systemName" label="主系統名稱" width="200" sortable />
        <el-table-column prop="seqNo" label="排序序號" width="100" align="center" sortable />
        <el-table-column prop="systemTypeName" label="系統型態" width="120" />
        <el-table-column prop="serverIp" label="伺服器主機名稱" width="150" />
        <el-table-column prop="moduleId" label="模組代碼" width="120" />
        <el-table-column prop="notes" label="備註" min-width="200" show-overflow-tooltip />
        <el-table-column prop="status" label="狀態" width="80" align="center">
          <template #default="scope">
            <el-tag :type="scope.row.status === 'A' ? 'success' : 'danger'">
              {{ scope.row.status === 'A' ? '啟用' : '停用' }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="150" align="center" fixed="right">
          <template #default="scope">
            <el-button type="primary" link @click="handleEdit(scope.row)">修改</el-button>
            <el-button type="danger" link @click="handleDelete(scope.row)">刪除</el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分頁 -->
      <el-pagination
        v-model:current-page="pagination.pageIndex"
        v-model:page-size="pagination.pageSize"
        :total="pagination.totalCount"
        :page-sizes="[10, 20, 50, 100]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleSizeChange"
        @current-change="handlePageChange"
        style="margin-top: 20px; justify-content: flex-end"
      />
    </el-card>
  </div>
  
  <!-- 新增/修改對話框 -->
  <el-dialog 
    v-model="dialogVisible" 
    :title="dialogTitle" 
    width="800px"
    @close="handleDialogClose"
  >
    <el-form 
      :model="formData" 
      :rules="rules" 
      ref="formRef" 
      label-width="150px"
    >
      <el-form-item label="主系統代碼" prop="systemId">
        <el-input 
          v-model="formData.systemId" 
          :disabled="isEdit"
          placeholder="請輸入主系統代碼"
          maxlength="50"
        />
      </el-form-item>
      
      <el-form-item label="主系統名稱" prop="systemName">
        <el-input 
          v-model="formData.systemName" 
          placeholder="請輸入主系統名稱"
          maxlength="100"
        />
      </el-form-item>
      
      <el-form-item label="排序序號" prop="seqNo">
        <el-input-number 
          v-model="formData.seqNo" 
          :min="0"
          placeholder="請輸入排序序號"
          style="width: 100%"
        />
      </el-form-item>
      
      <el-form-item label="系統型態" prop="systemType">
        <el-select 
          v-model="formData.systemType" 
          placeholder="請選擇系統型態"
          style="width: 100%"
        >
          <el-option
            v-for="item in systemTypeOptions"
            :key="item.value"
            :label="item.label"
            :value="item.value"
          />
        </el-select>
      </el-form-item>
      
      <el-form-item label="伺服器主機名稱" prop="serverIp">
        <el-input 
          v-model="formData.serverIp" 
          placeholder="請輸入伺服器主機名稱"
          maxlength="100"
        />
      </el-form-item>
      
      <el-form-item label="模組代碼" prop="moduleId">
        <el-input 
          v-model="formData.moduleId" 
          placeholder="請輸入模組代碼"
          maxlength="50"
        />
      </el-form-item>
      
      <el-form-item label="資料庫使用者" prop="dbUser">
        <el-input 
          v-model="formData.dbUser" 
          placeholder="請輸入資料庫使用者"
          maxlength="50"
        />
      </el-form-item>
      
      <el-form-item label="資料庫密碼" prop="dbPass">
        <el-input 
          v-model="formData.dbPass" 
          type="password"
          placeholder="請輸入資料庫密碼"
          maxlength="255"
          show-password
        />
      </el-form-item>
      
      <el-form-item label="備註" prop="notes">
        <el-input 
          v-model="formData.notes" 
          type="textarea"
          :rows="3"
          placeholder="請輸入備註"
          maxlength="500"
          show-word-limit
        />
      </el-form-item>
      
      <el-form-item label="狀態" prop="status">
        <el-radio-group v-model="formData.status">
          <el-radio label="A">啟用</el-radio>
          <el-radio label="I">停用</el-radio>
        </el-radio-group>
      </el-form-item>
    </el-form>
    
    <template #footer>
      <el-button @click="dialogVisible = false">取消</el-button>
      <el-button type="primary" @click="handleSubmit">確定</el-button>
    </template>
  </el-dialog>
</template>
```

#### 4.1.2 腳本邏輯
```typescript
<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { systemApi } from '@/api/system'

// 表單資料
const queryForm = reactive({
  systemId: '',
  systemName: '',
  systemType: [] as string[],
  serverIp: ''
})

// 查詢結果
const searchResult = ref([])
const totalCount = ref(0)
const selectedRows = ref([])
const pagination = reactive({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
})

// 對話框
const dialogVisible = ref(false)
const dialogTitle = ref('新增主系統')
const isEdit = ref(false)
const formData = reactive({
  systemId: '',
  systemName: '',
  seqNo: null as number | null,
  systemType: '',
  serverIp: '',
  moduleId: '',
  dbUser: '',
  dbPass: '',
  notes: '',
  status: 'A'
})

// 系統型態選項
const systemTypeOptions = ref([])

// 表單驗證規則
const rules = {
  systemId: [
    { required: true, message: '請輸入主系統代碼', trigger: 'blur' },
    { max: 50, message: '主系統代碼長度不能超過50個字元', trigger: 'blur' }
  ],
  systemName: [
    { required: true, message: '請輸入主系統名稱', trigger: 'blur' },
    { max: 100, message: '主系統名稱長度不能超過100個字元', trigger: 'blur' }
  ],
  systemType: [
    { required: true, message: '請選擇系統型態', trigger: 'change' }
  ]
}

// 查詢
const handleSearch = async () => {
  try {
    const response = await systemApi.getSystems({
      pageIndex: pagination.pageIndex,
      pageSize: pagination.pageSize,
      filters: {
        systemId: queryForm.systemId || undefined,
        systemName: queryForm.systemName || undefined,
        systemType: queryForm.systemType.length > 0 ? queryForm.systemType.join(',') : undefined,
        serverIp: queryForm.serverIp || undefined
      }
    })
    
    if (response.success) {
      searchResult.value = response.data.items
      pagination.totalCount = response.data.totalCount
      totalCount.value = response.data.totalCount
    } else {
      ElMessage.error(response.message || '查詢失敗')
    }
  } catch (error) {
    ElMessage.error('查詢失敗：' + error.message)
  }
}

// 重置
const handleReset = () => {
  queryForm.systemId = ''
  queryForm.systemName = ''
  queryForm.systemType = []
  queryForm.serverIp = ''
  searchResult.value = []
  pagination.pageIndex = 1
  pagination.totalCount = 0
  totalCount.value = 0
}

// 新增
const handleAdd = () => {
  isEdit.value = false
  dialogTitle.value = '新增主系統'
  resetForm()
  dialogVisible.value = true
}

// 修改
const handleEdit = (row: any) => {
  isEdit.value = true
  dialogTitle.value = '修改主系統'
  Object.assign(formData, {
    systemId: row.systemId,
    systemName: row.systemName,
    seqNo: row.seqNo,
    systemType: row.systemType,
    serverIp: row.serverIp,
    moduleId: row.moduleId,
    dbUser: row.dbUser || '',
    dbPass: '', // 不顯示密碼
    notes: row.notes || '',
    status: row.status || 'A'
  })
  dialogVisible.value = true
}

// 刪除
const handleDelete = async (row: any) => {
  try {
    await ElMessageBox.confirm(
      `確定要刪除主系統「${row.systemName}」嗎？`,
      '確認刪除',
      {
        confirmButtonText: '確定',
        cancelButtonText: '取消',
        type: 'warning'
      }
    )
    
    const response = await systemApi.deleteSystem(row.systemId)
    if (response.success) {
      ElMessage.success('刪除成功')
      handleSearch()
    } else {
      ElMessage.error(response.message || '刪除失敗')
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('刪除失敗：' + error.message)
    }
  }
}

// 批次刪除
const handleBatchDelete = async () => {
  if (selectedRows.value.length === 0) {
    ElMessage.warning('請選擇要刪除的資料')
    return
  }
  
  try {
    await ElMessageBox.confirm(
      `確定要刪除選取的 ${selectedRows.value.length} 筆資料嗎？`,
      '確認批次刪除',
      {
        confirmButtonText: '確定',
        cancelButtonText: '取消',
        type: 'warning'
      }
    )
    
    const systemIds = selectedRows.value.map((row: any) => row.systemId)
    const response = await systemApi.batchDeleteSystems({ systemIds })
    if (response.success) {
      ElMessage.success('批次刪除成功')
      handleSearch()
    } else {
      ElMessage.error(response.message || '批次刪除失敗')
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('批次刪除失敗：' + error.message)
    }
  }
}

// 提交表單
const handleSubmit = async () => {
  try {
    await formRef.value.validate()
    
    if (isEdit.value) {
      const response = await systemApi.updateSystem(formData.systemId, formData)
      if (response.success) {
        ElMessage.success('修改成功')
        dialogVisible.value = false
        handleSearch()
      } else {
        ElMessage.error(response.message || '修改失敗')
      }
    } else {
      const response = await systemApi.createSystem(formData)
      if (response.success) {
        ElMessage.success('新增成功')
        dialogVisible.value = false
        handleSearch()
      } else {
        ElMessage.error(response.message || '新增失敗')
      }
    }
  } catch (error) {
    if (error !== false) {
      ElMessage.error('操作失敗：' + error.message)
    }
  }
}

// 重置表單
const resetForm = () => {
  Object.assign(formData, {
    systemId: '',
    systemName: '',
    seqNo: null,
    systemType: '',
    serverIp: '',
    moduleId: '',
    dbUser: '',
    dbPass: '',
    notes: '',
    status: 'A'
  })
  formRef.value?.resetFields()
}

// 對話框關閉
const handleDialogClose = () => {
  resetForm()
}

// 選擇變更
const handleSelectionChange = (selection: any[]) => {
  selectedRows.value = selection
}

// 分頁變更
const handleSizeChange = (size: number) => {
  pagination.pageSize = size
  pagination.pageIndex = 1
  handleSearch()
}

const handlePageChange = (page: number) => {
  pagination.pageIndex = page
  handleSearch()
}

// 列印
const handlePrint = () => {
  // 實作列印功能
  ElMessage.info('列印功能開發中')
}

// 初始化
onMounted(async () => {
  // 載入系統型態選項
  try {
    const response = await systemApi.getSystemTypes()
    if (response.success) {
      systemTypeOptions.value = response.data
    }
  } catch (error) {
    ElMessage.error('載入系統型態選項失敗：' + error.message)
  }
})
</script>
```

---

## 五、後端實作

### 5.1 Controller (`SystemController.cs`)

```csharp
[ApiController]
[Route("api/v1/systems")]
[Authorize]
public class SystemController : ControllerBase
{
    private readonly ISystemService _systemService;
    private readonly ILogger<SystemController> _logger;

    public SystemController(
        ISystemService systemService,
        ILogger<SystemController> logger)
    {
        _systemService = systemService;
        _logger = logger;
    }

    /// <summary>
    /// 查詢主系統列表
    /// </summary>
    [HttpGet]
    public async Task<ActionResult<ApiResponse<PagedResult<SystemDto>>>> GetSystems(
        [FromQuery] SystemQueryDto query)
    {
        try
        {
            var result = await _systemService.GetSystemsAsync(query);
            return Ok(ApiResponse<PagedResult<SystemDto>>.Success(result));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "查詢主系統列表失敗");
            return BadRequest(ApiResponse<PagedResult<SystemDto>>.Error("查詢失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 查詢單筆主系統
    /// </summary>
    [HttpGet("{systemId}")]
    public async Task<ActionResult<ApiResponse<SystemDto>>> GetSystem(string systemId)
    {
        try
        {
            var result = await _systemService.GetSystemAsync(systemId);
            if (result == null)
            {
                return NotFound(ApiResponse<SystemDto>.Error("找不到主系統"));
            }
            return Ok(ApiResponse<SystemDto>.Success(result));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "查詢主系統失敗");
            return BadRequest(ApiResponse<SystemDto>.Error("查詢失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 新增主系統
    /// </summary>
    [HttpPost]
    public async Task<ActionResult<ApiResponse<object>>> CreateSystem([FromBody] CreateSystemDto dto)
    {
        try
        {
            await _systemService.CreateSystemAsync(dto);
            return Ok(ApiResponse<object>.Success(new { systemId = dto.SystemId }));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "新增主系統失敗");
            return BadRequest(ApiResponse<object>.Error("新增失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 修改主系統
    /// </summary>
    [HttpPut("{systemId}")]
    public async Task<ActionResult<ApiResponse<object>>> UpdateSystem(
        string systemId,
        [FromBody] UpdateSystemDto dto)
    {
        try
        {
            await _systemService.UpdateSystemAsync(systemId, dto);
            return Ok(ApiResponse<object>.Success(new { systemId }));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "修改主系統失敗");
            return BadRequest(ApiResponse<object>.Error("修改失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 刪除主系統
    /// </summary>
    [HttpDelete("{systemId}")]
    public async Task<ActionResult<ApiResponse<object>>> DeleteSystem(string systemId)
    {
        try
        {
            await _systemService.DeleteSystemAsync(systemId);
            return Ok(ApiResponse<object>.Success(null));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "刪除主系統失敗");
            return BadRequest(ApiResponse<object>.Error("刪除失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 批次刪除主系統
    /// </summary>
    [HttpDelete("batch")]
    public async Task<ActionResult<ApiResponse<object>>> BatchDeleteSystems(
        [FromBody] BatchDeleteSystemsDto dto)
    {
        try
        {
            await _systemService.BatchDeleteSystemsAsync(dto.SystemIds);
            return Ok(ApiResponse<object>.Success(null));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "批次刪除主系統失敗");
            return BadRequest(ApiResponse<object>.Error("批次刪除失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 取得系統型態選項
    /// </summary>
    [HttpGet("system-types")]
    public async Task<ActionResult<ApiResponse<List<SystemTypeOptionDto>>>> GetSystemTypes()
    {
        try
        {
            var result = await _systemService.GetSystemTypesAsync();
            return Ok(ApiResponse<List<SystemTypeOptionDto>>.Success(result));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "取得系統型態選項失敗");
            return BadRequest(ApiResponse<List<SystemTypeOptionDto>>.Error("查詢失敗：" + ex.Message));
        }
    }
}
```

### 5.2 Service (`SystemService.cs`)

```csharp
public class SystemService : ISystemService
{
    private readonly IDbConnection _db;
    private readonly ILogger<SystemService> _logger;
    private readonly IChangeLogService _changeLogService;

    public SystemService(
        IDbConnection db,
        ILogger<SystemService> logger,
        IChangeLogService changeLogService)
    {
        _db = db;
        _logger = logger;
        _changeLogService = changeLogService;
    }

    public async Task<PagedResult<SystemDto>> GetSystemsAsync(SystemQueryDto query)
    {
        var sql = @"
            SELECT 
                s.SystemId,
                s.SystemName,
                s.SeqNo,
                s.SystemType,
                pt.Content AS SystemTypeName,
                s.ServerIp,
                s.ModuleId,
                s.Notes,
                s.Status,
                s.CreatedBy,
                s.CreatedAt,
                s.UpdatedBy,
                s.UpdatedAt
            FROM Systems s
            LEFT JOIN Parameters pt ON pt.Title = 'PROG_TYPE' AND pt.Tag = s.SystemType
            WHERE 1 = 1
                AND (@SystemId IS NULL OR s.SystemId LIKE '%' + @SystemId + '%')
                AND (@SystemName IS NULL OR s.SystemName LIKE '%' + @SystemName + '%')
                AND (@SystemType IS NULL OR s.SystemType IN (SELECT value FROM STRING_SPLIT(@SystemType, ',')))
                AND (@ServerIp IS NULL OR s.ServerIp LIKE '%' + @ServerIp + '%')
            ORDER BY s.SeqNo, s.SystemId
            OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
            
            SELECT COUNT(*) AS TotalCount
            FROM Systems s
            WHERE 1 = 1
                AND (@SystemId IS NULL OR s.SystemId LIKE '%' + @SystemId + '%')
                AND (@SystemName IS NULL OR s.SystemName LIKE '%' + @SystemName + '%')
                AND (@SystemType IS NULL OR s.SystemType IN (SELECT value FROM STRING_SPLIT(@SystemType, ',')))
                AND (@ServerIp IS NULL OR s.ServerIp LIKE '%' + @ServerIp + '%');
        ";

        var parameters = new
        {
            SystemId = string.IsNullOrEmpty(query.Filters?.SystemId) ? (string?)null : query.Filters.SystemId,
            SystemName = string.IsNullOrEmpty(query.Filters?.SystemName) ? (string?)null : query.Filters.SystemName,
            SystemType = string.IsNullOrEmpty(query.Filters?.SystemType) ? (string?)null : query.Filters.SystemType,
            ServerIp = string.IsNullOrEmpty(query.Filters?.ServerIp) ? (string?)null : query.Filters.ServerIp,
            Offset = (query.PageIndex - 1) * query.PageSize,
            PageSize = query.PageSize
        };

        using var multi = await _db.QueryMultipleAsync(sql, parameters);
        var items = (await multi.ReadAsync<SystemDto>()).ToList();
        var totalCount = await multi.ReadSingleAsync<int>();

        return new PagedResult<SystemDto>
        {
            Items = items,
            TotalCount = totalCount,
            PageIndex = query.PageIndex,
            PageSize = query.PageSize,
            TotalPages = (int)Math.Ceiling(totalCount / (double)query.PageSize)
        };
    }

    public async Task<SystemDto> GetSystemAsync(string systemId)
    {
        var sql = @"
            SELECT 
                s.SystemId,
                s.SystemName,
                s.SeqNo,
                s.SystemType,
                pt.Content AS SystemTypeName,
                s.ServerIp,
                s.ModuleId,
                s.DbUser,
                s.Notes,
                s.Status,
                s.CreatedBy,
                s.CreatedAt,
                s.UpdatedBy,
                s.UpdatedAt
            FROM Systems s
            LEFT JOIN Parameters pt ON pt.Title = 'PROG_TYPE' AND pt.Tag = s.SystemType
            WHERE s.SystemId = @SystemId;
        ";

        return await _db.QueryFirstOrDefaultAsync<SystemDto>(sql, new { SystemId = systemId });
    }

    public async Task CreateSystemAsync(CreateSystemDto dto)
    {
        // 檢查唯一性
        var existing = await _db.QueryFirstOrDefaultAsync<SystemDto>(
            "SELECT SystemId FROM Systems WHERE SystemId = @SystemId",
            new { SystemId = dto.SystemId });
        
        if (existing != null)
        {
            throw new BusinessException("主系統代碼已存在");
        }

        // 加密資料庫密碼
        var encryptedDbPass = string.IsNullOrEmpty(dto.DbPass) 
            ? null 
            : EncryptPassword(dto.DbPass);

        var sql = @"
            INSERT INTO Systems (
                SystemId, SystemName, SeqNo, SystemType, ServerIp, ModuleId,
                DbUser, DbPass, Notes, Status,
                CreatedBy, CreatedAt, UpdatedBy, UpdatedAt, CreatedPriority, CreatedGroup
            ) VALUES (
                @SystemId, @SystemName, @SeqNo, @SystemType, @ServerIp, @ModuleId,
                @DbUser, @DbPass, @Notes, @Status,
                @CreatedBy, GETDATE(), @UpdatedBy, GETDATE(), @CreatedPriority, @CreatedGroup
            );
        ";

        var parameters = new
        {
            dto.SystemId,
            dto.SystemName,
            dto.SeqNo,
            dto.SystemType,
            dto.ServerIp,
            dto.ModuleId,
            dto.DbUser,
            DbPass = encryptedDbPass,
            dto.Notes,
            dto.Status,
            CreatedBy = GetCurrentUserId(),
            UpdatedBy = GetCurrentUserId(),
            CreatedPriority = GetCurrentUserPriority(),
            CreatedGroup = GetCurrentUserGroup()
        };

        await _db.ExecuteAsync(sql, parameters);

        // 記錄異動日誌
        await _changeLogService.LogChangeAsync("SYS0410", dto.SystemId, "1", "新增", null, null);
    }

    public async Task UpdateSystemAsync(string systemId, UpdateSystemDto dto)
    {
        // 檢查是否存在
        var existing = await GetSystemAsync(systemId);
        if (existing == null)
        {
            throw new BusinessException("找不到主系統");
        }

        // 檢查唯一性（如果修改了 SystemId）
        if (dto.SystemId != systemId)
        {
            var duplicate = await _db.QueryFirstOrDefaultAsync<SystemDto>(
                "SELECT SystemId FROM Systems WHERE SystemId = @SystemId",
                new { SystemId = dto.SystemId });
            
            if (duplicate != null)
            {
                throw new BusinessException("主系統代碼已存在");
            }
        }

        // 取得舊值
        var oldValues = new Dictionary<string, object>
        {
            { "SystemName", existing.SystemName },
            { "SeqNo", existing.SeqNo },
            { "SystemType", existing.SystemType },
            { "ServerIp", existing.ServerIp },
            { "ModuleId", existing.ModuleId },
            { "Notes", existing.Notes },
            { "Status", existing.Status }
        };

        // 加密資料庫密碼（如果有提供）
        var encryptedDbPass = existing.DbPass; // 預設保持原值
        if (!string.IsNullOrEmpty(dto.DbPass))
        {
            encryptedDbPass = EncryptPassword(dto.DbPass);
        }

        var sql = @"
            UPDATE Systems SET
                SystemName = @SystemName,
                SeqNo = @SeqNo,
                SystemType = @SystemType,
                ServerIp = @ServerIp,
                ModuleId = @ModuleId,
                DbUser = @DbUser,
                DbPass = @DbPass,
                Notes = @Notes,
                Status = @Status,
                UpdatedBy = @UpdatedBy,
                UpdatedAt = GETDATE()
            WHERE SystemId = @SystemId;
        ";

        var parameters = new
        {
            SystemId = systemId,
            dto.SystemName,
            dto.SeqNo,
            dto.SystemType,
            dto.ServerIp,
            dto.ModuleId,
            dto.DbUser,
            DbPass = encryptedDbPass,
            dto.Notes,
            dto.Status,
            UpdatedBy = GetCurrentUserId()
        };

        await _db.ExecuteAsync(sql, parameters);

        // 取得新值
        var newValues = new Dictionary<string, object>
        {
            { "SystemName", dto.SystemName },
            { "SeqNo", dto.SeqNo ?? 0 },
            { "SystemType", dto.SystemType },
            { "ServerIp", dto.ServerIp ?? "" },
            { "ModuleId", dto.ModuleId ?? "" },
            { "Notes", dto.Notes ?? "" },
            { "Status", dto.Status }
        };

        // 記錄異動日誌
        var changedFields = new List<string>();
        var oldValueList = new List<string>();
        var newValueList = new List<string>();

        foreach (var key in oldValues.Keys)
        {
            var oldVal = oldValues[key]?.ToString() ?? "";
            var newVal = newValues[key]?.ToString() ?? "";
            if (oldVal != newVal)
            {
                changedFields.Add(key);
                oldValueList.Add(oldVal);
                newValueList.Add(newVal);
            }
        }

        if (changedFields.Count > 0)
        {
            await _changeLogService.LogChangeAsync(
                "SYS0410",
                systemId,
                "3",
                "修改",
                string.Join(",", changedFields),
                string.Join(",", oldValueList),
                string.Join(",", newValueList));
        }
    }

    public async Task DeleteSystemAsync(string systemId)
    {
        // 檢查是否有子系統關聯
        var hasSubSystems = await _db.QueryFirstOrDefaultAsync<int>(
            "SELECT COUNT(*) FROM SubSystems WHERE SystemId = @SystemId",
            new { SystemId = systemId });
        
        if (hasSubSystems > 0)
        {
            throw new BusinessException("此主系統下存在子系統，無法刪除");
        }

        // 檢查是否有作業關聯
        var hasPrograms = await _db.QueryFirstOrDefaultAsync<int>(
            "SELECT COUNT(*) FROM Programs WHERE SystemId = @SystemId",
            new { SystemId = systemId });
        
        if (hasPrograms > 0)
        {
            throw new BusinessException("此主系統下存在作業，無法刪除");
        }

        // 取得刪除前的資料
        var existing = await GetSystemAsync(systemId);
        if (existing == null)
        {
            throw new BusinessException("找不到主系統");
        }

        var sql = "DELETE FROM Systems WHERE SystemId = @SystemId";
        await _db.ExecuteAsync(sql, new { SystemId = systemId });

        // 記錄異動日誌
        await _changeLogService.LogChangeAsync(
            "SYS0410",
            systemId,
            "2",
            "刪除",
            "SystemId,SystemName,SeqNo,SystemType,ServerIp,ModuleId,Notes,Status",
            $"{existing.SystemId},{existing.SystemName},{existing.SeqNo},{existing.SystemType},{existing.ServerIp},{existing.ModuleId},{existing.Notes},{existing.Status}",
            null);
    }

    public async Task BatchDeleteSystemsAsync(List<string> systemIds)
    {
        foreach (var systemId in systemIds)
        {
            await DeleteSystemAsync(systemId);
        }
    }

    public async Task<List<SystemTypeOptionDto>> GetSystemTypesAsync()
    {
        var sql = @"
            SELECT Tag AS Value, Content AS Label
            FROM Parameters
            WHERE Title = 'PROG_TYPE'
            ORDER BY Tag;
        ";

        return (await _db.QueryAsync<SystemTypeOptionDto>(sql)).ToList();
    }

    private string EncryptPassword(string password)
    {
        // 實作密碼加密邏輯
        // 可以使用 AES 加密或其他加密方式
        return password; // 暫時直接返回，需實作加密
    }

    private string GetCurrentUserId()
    {
        // 從 JWT Token 或 Session 取得目前使用者 ID
        return "U001"; // 暫時返回固定值，需實作
    }

    private int GetCurrentUserPriority()
    {
        // 從 JWT Token 或 Session 取得目前使用者等級
        return 1; // 暫時返回固定值，需實作
    }

    private string GetCurrentUserGroup()
    {
        // 從 JWT Token 或 Session 取得目前使用者群組
        return "GROUP001"; // 暫時返回固定值，需實作
    }
}
```

### 5.3 DTO 定義

```csharp
// 查詢條件 DTO
public class SystemQueryDto
{
    public int PageIndex { get; set; } = 1;
    public int PageSize { get; set; } = 20;
    public string? SortField { get; set; }
    public string? SortOrder { get; set; }
    public SystemQueryFilters? Filters { get; set; }
}

public class SystemQueryFilters
{
    public string? SystemId { get; set; }
    public string? SystemName { get; set; }
    public string? SystemType { get; set; }
    public string? ServerIp { get; set; }
}

// 主系統 DTO
public class SystemDto
{
    public string SystemId { get; set; }
    public string SystemName { get; set; }
    public int? SeqNo { get; set; }
    public string? SystemType { get; set; }
    public string? SystemTypeName { get; set; }
    public string? ServerIp { get; set; }
    public string? ModuleId { get; set; }
    public string? DbUser { get; set; }
    public string? Notes { get; set; }
    public string? Status { get; set; }
    public string? CreatedBy { get; set; }
    public DateTime CreatedAt { get; set; }
    public string? UpdatedBy { get; set; }
    public DateTime UpdatedAt { get; set; }
}

// 新增主系統 DTO
public class CreateSystemDto
{
    [Required]
    [MaxLength(50)]
    public string SystemId { get; set; }
    
    [Required]
    [MaxLength(100)]
    public string SystemName { get; set; }
    
    public int? SeqNo { get; set; }
    
    [Required]
    [MaxLength(20)]
    public string SystemType { get; set; }
    
    [MaxLength(100)]
    public string? ServerIp { get; set; }
    
    [MaxLength(50)]
    public string? ModuleId { get; set; }
    
    [MaxLength(50)]
    public string? DbUser { get; set; }
    
    [MaxLength(255)]
    public string? DbPass { get; set; }
    
    [MaxLength(500)]
    public string? Notes { get; set; }
    
    [MaxLength(10)]
    public string Status { get; set; } = "A";
}

// 修改主系統 DTO
public class UpdateSystemDto : CreateSystemDto
{
    // 繼承 CreateSystemDto 的所有屬性
}

// 批次刪除 DTO
public class BatchDeleteSystemsDto
{
    [Required]
    public List<string> SystemIds { get; set; }
}

// 系統型態選項 DTO
public class SystemTypeOptionDto
{
    public string Value { get; set; }
    public string Label { get; set; }
}
```

---

## 六、開發時程

### 6.1 開發階段
1. **資料庫設計** (0.5 天)
   - 建立 Systems 資料表
   - 建立索引
   - 建立外鍵約束

2. **後端 API 開發** (2 天)
   - 實作 Service 層
   - 實作 Controller 層
   - 實作 DTO 定義
   - 單元測試

3. **前端 UI 開發** (2 天)
   - 查詢頁面
   - 新增/修改對話框
   - 刪除確認
   - 批次操作
   - 整合測試

4. **測試與優化** (0.5 天)
   - 功能測試
   - 效能測試
   - Bug 修復

**總計**: 5 天

---

## 七、注意事項

### 7.1 資料驗證
- 主系統代碼必須唯一
- 主系統名稱必填
- 系統型態必須從參數表取得有效值
- 刪除前需檢查是否有子系統、作業等關聯資料

### 7.2 安全性
- 資料庫密碼需加密儲存
- 需驗證使用者權限
- 防止 SQL Injection（使用參數化查詢）

### 7.3 效能優化
- 使用索引加速查詢
- 大量資料時使用分頁查詢
- 考慮使用 Redis 快取系統型態選項

### 7.4 異動日誌
- 記錄新增、修改、刪除操作
- 記錄異動欄位和異動前後的值
- 記錄異動使用者和異動時間

---

## 八、測試案例

### 8.1 功能測試
1. **查詢測試**
   - 依主系統代碼查詢
   - 依主系統名稱查詢
   - 依系統型態查詢
   - 依伺服器主機名稱查詢
   - 組合條件查詢
   - 分頁查詢

2. **新增測試**
   - 正常新增
   - 主系統代碼重複
   - 必填欄位驗證
   - 欄位長度驗證

3. **修改測試**
   - 正常修改
   - 主系統代碼修改（需檢查唯一性）
   - 必填欄位驗證
   - 欄位長度驗證

4. **刪除測試**
   - 正常刪除
   - 有子系統關聯時無法刪除
   - 有作業關聯時無法刪除
   - 批次刪除

### 8.2 效能測試
- 大量資料查詢效能（10萬筆以上）
- 分頁查詢效能
- 索引使用情況

### 8.3 安全性測試
- SQL Injection 測試
- 權限驗證測試
- 輸入驗證測試
- 密碼加密測試

