# SYS0230 - 角色之使用者設定維護 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0230
- **功能名稱**: 角色之使用者設定維護
- **功能描述**: 為指定角色分配或移除使用者，管理角色與使用者的對應關係。當角色分配給使用者時，會清除使用者原有的直接權限設定，改以角色權限為主
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0230_SET_ROLE_USER.asp` (設定角色使用者)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0230_USER_LIST.asp` (使用者列表)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0230_DEPT_LIST.asp` (部門列表)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0230_OTHER_LIST.asp` (其他列表)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0230_STORE_LIST.asp` (店別列表)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0230_CASHIER_LIST.asp` (專櫃人員列表)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0230_SET_ROLE_USER.aspx.cs`
  - `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_USER_ROLE.cs`

### 1.2 業務需求
- 為指定角色分配一個或多個使用者
- 移除角色的使用者
- 查看角色已分配的使用者列表
- 支援依部門、店別、專櫃等條件篩選使用者
- 支援批量操作
- 變更角色使用者時需清除使用者直接權限資料（MNG_USER_B）
- 支援多種使用者類型（公司人員、專櫃人員等）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `UserRoles`

```sql
CREATE TABLE [dbo].[UserRoles] (
    [UserId] NVARCHAR(50) NOT NULL,
    [RoleId] NVARCHAR(50) NOT NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NULL,
    [CreatedPriority] INT NULL,
    [CreatedGroup] NVARCHAR(50) NULL,
    CONSTRAINT [PK_UserRoles] PRIMARY KEY CLUSTERED ([UserId], [RoleId]),
    CONSTRAINT [FK_UserRoles_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE,
    CONSTRAINT [FK_UserRoles_Roles] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[Roles] ([RoleId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_UserRoles_UserId] ON [dbo].[UserRoles] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_UserRoles_RoleId] ON [dbo].[UserRoles] ([RoleId]);
```

### 2.2 相關資料表

#### 2.2.1 `Users` - 使用者基本資料
```sql
-- 參考 SYS0110 開發計劃
```

#### 2.2.2 `Roles` - 角色基本資料
```sql
-- 參考 SYS0210 開發計劃
```

#### 2.2.3 `UserButtons` - 使用者按鈕權限（需清除）
```sql
-- 當角色分配給使用者時，需清除此表中的使用者直接權限
CREATE TABLE [dbo].[UserButtons] (
    [UserId] NVARCHAR(50) NOT NULL,
    [ButtonId] NVARCHAR(50) NOT NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_UserButtons] PRIMARY KEY CLUSTERED ([UserId], [ButtonId])
);
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| UserId | NVARCHAR | 50 | NO | - | 使用者代碼 | 主鍵，外鍵至 Users |
| RoleId | NVARCHAR | 50 | NO | - | 角色代碼 | 主鍵，外鍵至 Roles |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | YES | - | 更新時間 | - |
| CreatedPriority | INT | - | YES | - | 建立者等級 | - |
| CreatedGroup | NVARCHAR | 50 | YES | - | 建立者群組 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢角色使用者列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/roles/{roleId}/users`
- **說明**: 查詢指定角色已分配的使用者列表
- **查詢參數**:
  - `roleId` (path): 角色代碼
  - `orgId` (query, optional): 部門代碼
  - `storeId` (query, optional): 店別代碼
  - `userType` (query, optional): 使用者類型 (1:公司人員, 2:專櫃人員)
  - `filter` (query, optional): 篩選條件（使用者代碼或名稱）
  - `page` (query, optional): 頁碼，預設 1
  - `pageSize` (query, optional): 每頁筆數，預設 20
- **回應範例**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "userId": "U001",
        "userName": "張三",
        "orgId": "ORG001",
        "orgName": "資訊部",
        "isAssigned": true
      }
    ],
    "total": 100,
    "page": 1,
    "pageSize": 20
  }
}
```

#### 3.1.2 查詢可用使用者列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/roles/{roleId}/users/available`
- **說明**: 查詢可分配給角色的使用者列表（排除已分配的使用者）
- **查詢參數**: 同 3.1.1

#### 3.1.3 設定角色使用者（批量）
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/roles/{roleId}/users/assign`
- **說明**: 批量設定角色的使用者（新增或移除）
- **請求主體**:
```json
{
  "addUserIds": ["U001", "U002"],
  "removeUserIds": ["U003", "U004"]
}
```
- **回應範例**:
```json
{
  "success": true,
  "message": "設定成功",
  "data": {
    "addedCount": 2,
    "removedCount": 2
  }
}
```

#### 3.1.4 新增角色使用者
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/roles/{roleId}/users`
- **說明**: 為角色新增使用者
- **請求主體**:
```json
{
  "userId": "U001"
}
```

#### 3.1.5 移除角色使用者
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/roles/{roleId}/users/{userId}`
- **說明**: 移除角色的使用者

#### 3.1.6 查詢部門列表（用於篩選）
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/roles/{roleId}/users/departments`
- **說明**: 查詢可用的部門列表

#### 3.1.7 查詢店別列表（用於篩選）
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/roles/{roleId}/users/stores`
- **說明**: 查詢可用的店別列表

### 3.2 業務邏輯

#### 3.2.1 設定角色使用者流程
1. 驗證角色是否存在
2. 驗證使用者是否存在
3. 檢查是否已存在對應關係
4. **清除使用者直接權限**（重要：當角色分配給使用者時，需清除 MNG_USER_B 中的使用者直接權限）
5. 新增或更新 UserRoles 資料
6. 清除相關快取
7. 記錄操作日誌

#### 3.2.2 清除使用者直接權限
```csharp
// 當角色分配給使用者時，需清除使用者的直接權限設定
public void ClearUserDirectPermissions(string userId)
{
    // DELETE FROM UserButtons WHERE UserId = @userId
    // 清除使用者的直接按鈕權限
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 角色選擇頁面 (`SYS0230_FQ.vue`)
- **功能**: 選擇要設定的角色
- **元件**: 
  - 角色查詢表單
  - 角色列表（支援 LOV 選擇）

#### 4.1.2 部門列表頁面 (`SYS0230_DEPT_LIST.vue`)
- **功能**: 依部門選擇使用者
- **元件**:
  - 角色資訊顯示
  - 部門樹狀列表
  - 部門選擇按鈕

#### 4.1.3 使用者列表頁面 (`SYS0230_USER_LIST.vue`)
- **功能**: 顯示並設定角色的使用者
- **元件**:
  - 角色資訊顯示區
  - 部門資訊顯示區（如有）
  - 篩選條件輸入框（使用者代碼/名稱）
  - 使用者列表表格
    - 欄位：勾選框、使用者代碼、使用者名稱、部門代碼、部門名稱、是否已分配
  - 操作按鈕：設定角色、重新設定、重新設定其他角色、回上一頁

#### 4.1.4 店別列表頁面 (`SYS0230_STORE_LIST.vue`)
- **功能**: 依店別選擇使用者
- **元件**: 類似部門列表，但以店別為篩選條件

#### 4.1.5 專櫃人員列表頁面 (`SYS0230_CASHIER_LIST.vue`)
- **功能**: 顯示專櫃人員並設定角色
- **元件**: 類似使用者列表，但僅顯示專櫃人員

### 4.2 UI 元件設計

#### 4.2.1 角色資訊顯示區
```vue
<template>
  <div class="role-info">
    <el-descriptions :column="2" border>
      <el-descriptions-item label="角色代碼">{{ roleId }}</el-descriptions-item>
      <el-descriptions-item label="角色名稱">{{ roleName }}</el-descriptions-item>
    </el-descriptions>
  </div>
</template>
```

#### 4.2.2 使用者列表表格
```vue
<template>
  <el-table :data="userList" border>
    <el-table-column type="selection" width="55" />
    <el-table-column prop="userId" label="使用者代碼" width="120" />
    <el-table-column prop="userName" label="使用者名稱" width="150" />
    <el-table-column prop="orgId" label="部門代碼" width="120" />
    <el-table-column prop="orgName" label="部門名稱" width="150" />
    <el-table-column prop="isAssigned" label="已分配" width="80">
      <template #default="{ row }">
        <el-tag :type="row.isAssigned ? 'success' : 'info'">
          {{ row.isAssigned ? '是' : '否' }}
        </el-tag>
      </template>
    </el-table-column>
  </el-table>
</template>
```

#### 4.2.3 篩選條件表單
```vue
<template>
  <el-form :inline="true" :model="filterForm">
    <el-form-item label="篩選條件">
      <el-input 
        v-model="filterForm.keyword" 
        placeholder="使用者代碼或名稱"
        clearable
      />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
    </el-form-item>
  </el-form>
</template>
```

### 4.3 操作流程

1. **選擇角色**: 進入功能後，先選擇要設定的角色
2. **選擇篩選條件**: 可選擇依部門、店別或直接查詢使用者
3. **顯示使用者列表**: 顯示符合條件的使用者，標示已分配狀態
4. **勾選使用者**: 勾選要新增或移除的使用者
5. **執行設定**: 點擊「設定角色」按鈕，系統會：
   - 新增勾選且未分配的使用者
   - 移除未勾選但已分配的使用者
   - 清除相關使用者的直接權限
6. **確認結果**: 顯示設定成功訊息並重新載入列表

---

## 五、功能詳細設計

### 5.1 新增功能

#### 5.1.1 業務邏輯
- 驗證角色和使用者是否存在
- 檢查是否已存在對應關係（避免重複）
- **清除使用者的直接權限設定**
- 新增 UserRoles 記錄
- 記錄操作日誌

#### 5.1.2 API 實作
```csharp
[HttpPost("roles/{roleId}/users")]
public async Task<IActionResult> AssignUserToRole(string roleId, [FromBody] AssignUserRequest request)
{
    // 1. 驗證角色存在
    var role = await _roleRepository.GetByIdAsync(roleId);
    if (role == null)
        return NotFound("角色不存在");
    
    // 2. 驗證使用者存在
    var user = await _userRepository.GetByIdAsync(request.UserId);
    if (user == null)
        return NotFound("使用者不存在");
    
    // 3. 檢查是否已存在
    var existing = await _userRoleRepository.GetByUserAndRoleAsync(request.UserId, roleId);
    if (existing != null)
        return BadRequest("使用者已分配此角色");
    
    // 4. 清除使用者直接權限
    await _userButtonRepository.DeleteByUserIdAsync(request.UserId);
    
    // 5. 新增對應關係
    var userRole = new UserRole
    {
        UserId = request.UserId,
        RoleId = roleId,
        CreatedBy = User.Identity.Name,
        CreatedAt = DateTime.Now
    };
    await _userRoleRepository.InsertAsync(userRole);
    
    return Ok(new { success = true, message = "設定成功" });
}
```

### 5.2 修改功能

#### 5.2.1 業務邏輯
- 此功能主要為批量設定，單筆修改可視為先刪除再新增
- 批量設定時，系統會比較變更前後的狀態，只處理有變更的項目

#### 5.2.2 API 實作
```csharp
[HttpPost("roles/{roleId}/users/assign")]
public async Task<IActionResult> BatchAssignUsers(string roleId, [FromBody] BatchAssignRequest request)
{
    var addedCount = 0;
    var removedCount = 0;
    
    // 處理新增
    foreach (var userId in request.AddUserIds)
    {
        // 清除使用者直接權限
        await _userButtonRepository.DeleteByUserIdAsync(userId);
        
        // 新增對應關係
        var userRole = new UserRole
        {
            UserId = userId,
            RoleId = roleId,
            CreatedBy = User.Identity.Name,
            CreatedAt = DateTime.Now
        };
        await _userRoleRepository.InsertAsync(userRole);
        addedCount++;
    }
    
    // 處理移除
    foreach (var userId in request.RemoveUserIds)
    {
        await _userRoleRepository.DeleteAsync(userId, roleId);
        removedCount++;
    }
    
    return Ok(new { 
        success = true, 
        message = "設定成功",
        data = new { addedCount, removedCount }
    });
}
```

### 5.3 刪除功能

#### 5.3.1 業務邏輯
- 驗證對應關係存在
- 刪除 UserRoles 記錄
- 記錄操作日誌

#### 5.3.2 API 實作
```csharp
[HttpDelete("roles/{roleId}/users/{userId}")]
public async Task<IActionResult> RemoveUserFromRole(string roleId, string userId)
{
    var userRole = await _userRoleRepository.GetByUserAndRoleAsync(userId, roleId);
    if (userRole == null)
        return NotFound("對應關係不存在");
    
    await _userRoleRepository.DeleteAsync(userId, roleId);
    
    return Ok(new { success = true, message = "移除成功" });
}
```

### 5.4 查詢功能

#### 5.4.1 查詢角色使用者列表
- **功能**: 查詢指定角色已分配的使用者
- **篩選條件**: 
  - 角色代碼（必填）
  - 部門代碼（選填）
  - 店別代碼（選填）
  - 使用者類型（選填）
  - 關鍵字（使用者代碼或名稱，選填）
- **排序**: 預設依使用者代碼排序
- **分頁**: 支援分頁查詢

#### 5.4.2 API 實作
```csharp
[HttpGet("roles/{roleId}/users")]
public async Task<IActionResult> GetRoleUsers(
    string roleId,
    [FromQuery] string orgId = null,
    [FromQuery] string storeId = null,
    [FromQuery] string userType = null,
    [FromQuery] string filter = null,
    [FromQuery] int page = 1,
    [FromQuery] int pageSize = 20)
{
    var query = new RoleUserQuery
    {
        RoleId = roleId,
        OrgId = orgId,
        StoreId = storeId,
        UserType = userType,
        Filter = filter,
        Page = page,
        PageSize = pageSize
    };
    
    var result = await _userRoleRepository.GetRoleUsersAsync(query);
    
    return Ok(new {
        success = true,
        data = new {
            items = result.Items,
            total = result.Total,
            page = result.Page,
            pageSize = result.PageSize
        }
    });
}
```

---

## 六、資料存取層設計

### 6.1 Repository 介面

```csharp
public interface IUserRoleRepository
{
    Task<UserRole> GetByUserAndRoleAsync(string userId, string roleId);
    Task<IEnumerable<UserRole>> GetByRoleIdAsync(string roleId);
    Task<IEnumerable<UserRole>> GetByUserIdAsync(string userId);
    Task<PagedResult<UserRoleListItem>> GetRoleUsersAsync(RoleUserQuery query);
    Task InsertAsync(UserRole userRole);
    Task DeleteAsync(string userId, string roleId);
    Task BatchInsertAsync(IEnumerable<UserRole> userRoles);
    Task BatchDeleteAsync(IEnumerable<(string userId, string roleId)> keys);
}
```

### 6.2 Dapper 實作

```csharp
public class UserRoleRepository : IUserRoleRepository
{
    private readonly IDbConnection _connection;
    
    public async Task<UserRole> GetByUserAndRoleAsync(string userId, string roleId)
    {
        const string sql = @"
            SELECT UserId, RoleId, CreatedBy, CreatedAt, UpdatedBy, UpdatedAt, CreatedPriority, CreatedGroup
            FROM UserRoles
            WHERE UserId = @UserId AND RoleId = @RoleId";
        
        return await _connection.QueryFirstOrDefaultAsync<UserRole>(sql, new { UserId = userId, RoleId = roleId });
    }
    
    public async Task<PagedResult<UserRoleListItem>> GetRoleUsersAsync(RoleUserQuery query)
    {
        var sql = new StringBuilder(@"
            SELECT 
                u.UserId,
                u.UserName,
                u.OrgId,
                o.OrgName,
                CASE WHEN ur.UserId IS NOT NULL THEN 1 ELSE 0 END AS IsAssigned
            FROM Users u
            LEFT JOIN UserRoles ur ON u.UserId = ur.UserId AND ur.RoleId = @RoleId
            LEFT JOIN Organizations o ON u.OrgId = o.OrgId
            WHERE 1=1");
        
        var parameters = new DynamicParameters();
        parameters.Add("RoleId", query.RoleId);
        
        if (!string.IsNullOrEmpty(query.OrgId))
        {
            sql.Append(" AND u.OrgId = @OrgId");
            parameters.Add("OrgId", query.OrgId);
        }
        
        if (!string.IsNullOrEmpty(query.Filter))
        {
            sql.Append(" AND (u.UserId LIKE @Filter OR u.UserName LIKE @Filter)");
            parameters.Add("Filter", $"%{query.Filter}%");
        }
        
        sql.Append(" ORDER BY u.UserId");
        
        // 分頁處理
        var countSql = $"SELECT COUNT(*) FROM ({sql}) AS Total";
        var total = await _connection.QuerySingleAsync<int>(countSql, parameters);
        
        sql.Append(" OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY");
        parameters.Add("Offset", (query.Page - 1) * query.PageSize);
        parameters.Add("PageSize", query.PageSize);
        
        var items = await _connection.QueryAsync<UserRoleListItem>(sql.ToString(), parameters);
        
        return new PagedResult<UserRoleListItem>
        {
            Items = items.ToList(),
            Total = total,
            Page = query.Page,
            PageSize = query.PageSize
        };
    }
    
    public async Task InsertAsync(UserRole userRole)
    {
        const string sql = @"
            INSERT INTO UserRoles (UserId, RoleId, CreatedBy, CreatedAt, CreatedPriority, CreatedGroup)
            VALUES (@UserId, @RoleId, @CreatedBy, @CreatedAt, @CreatedPriority, @CreatedGroup)";
        
        await _connection.ExecuteAsync(sql, userRole);
    }
    
    public async Task DeleteAsync(string userId, string roleId)
    {
        const string sql = "DELETE FROM UserRoles WHERE UserId = @UserId AND RoleId = @RoleId";
        await _connection.ExecuteAsync(sql, new { UserId = userId, RoleId = roleId });
    }
}
```

---

## 七、錯誤處理

### 7.1 錯誤碼定義

| 錯誤碼 | 說明 | HTTP 狀態碼 |
|--------|------|------------|
| ROLE_USER_001 | 角色不存在 | 404 |
| ROLE_USER_002 | 使用者不存在 | 404 |
| ROLE_USER_003 | 對應關係已存在 | 400 |
| ROLE_USER_004 | 對應關係不存在 | 404 |
| ROLE_USER_005 | 清除使用者權限失敗 | 500 |

### 7.2 錯誤處理範例

```csharp
try
{
    await _userRoleRepository.InsertAsync(userRole);
}
catch (SqlException ex) when (ex.Number == 2627) // 主鍵違反
{
    return BadRequest(new { 
        success = false, 
        errorCode = "ROLE_USER_003",
        message = "使用者已分配此角色" 
    });
}
catch (Exception ex)
{
    _logger.LogError(ex, "設定角色使用者失敗");
    return StatusCode(500, new { 
        success = false, 
        errorCode = "ROLE_USER_005",
        message = "設定失敗，請稍後再試" 
    });
}
```

---

## 八、測試計劃

### 8.1 單元測試
- Repository 層的 CRUD 操作
- 業務邏輯層的驗證邏輯
- 清除使用者權限的邏輯

### 8.2 整合測試
- API 端點的功能測試
- 資料庫交易測試
- 權限清除的整合測試

### 8.3 前端測試
- 使用者列表顯示
- 批量設定功能
- 篩選功能

---

## 九、注意事項

1. **清除使用者直接權限**: 當角色分配給使用者時，必須清除使用者在 UserButtons 表中的直接權限設定，這是此功能的核心業務邏輯
2. **交易處理**: 新增角色使用者時，清除權限和新增對應關係應在同一個交易中完成
3. **快取清除**: 變更角色使用者後，需清除相關的權限快取
4. **操作日誌**: 所有變更操作都應記錄日誌，包含操作者、時間、變更內容
5. **效能考量**: 批量操作時，應使用批量 SQL 語句，避免逐筆處理
6. **多使用者類型**: 需支援不同類型的使用者（公司人員、專櫃人員等）

---

## 十、開發時程

- **資料庫設計**: 0.5 天
- **後端 API 開發**: 2 天
- **前端 UI 開發**: 2 天
- **測試**: 1 天
- **文件撰寫**: 0.5 天
- **總計**: 6 天

