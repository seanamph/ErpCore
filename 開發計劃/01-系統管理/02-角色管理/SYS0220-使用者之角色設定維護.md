# SYS0220 - 使用者之角色設定維護 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0220
- **功能名稱**: 使用者之角色設定維護
- **功能描述**: 為指定使用者分配或移除角色，管理使用者與角色的對應關係
- **參考舊程式**: 
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0220_ROLE_LIST.aspx` (角色列表)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0220_SET_USER_ROLE.aspx` (設定角色)
  - `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_USER_ROLE.cs` (業務邏輯)
  - `WEB/IMS_CORE/SYS0000/SYS0220_ROLE_LIST.aspx`
  - `WEB/IMS_CORE/SYS0000/SYS0220_SET_USER_ROLE.aspx`

### 1.2 業務需求
- 為指定使用者分配一個或多個角色
- 移除使用者的角色
- 查看使用者已分配的角色列表
- 查看所有可用角色列表
- 支援批量操作
- 變更角色時需清除使用者權限快取

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `UserRoles`

```sql
CREATE TABLE [dbo].[UserRoles] (
    [UserId] NVARCHAR(50) NOT NULL,
    [RoleId] NVARCHAR(50) NOT NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NULL,
    [CreatedPriority] INT NULL,
    [CreatedGroup] NVARCHAR(50) NULL,
    CONSTRAINT [PK_UserRoles] PRIMARY KEY CLUSTERED ([UserId], [RoleId]),
    CONSTRAINT [FK_UserRoles_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId]) ON DELETE CASCADE,
    CONSTRAINT [FK_UserRoles_Roles] FOREIGN KEY ([RoleId]) REFERENCES [dbo].[Roles] ([RoleId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_UserRoles_UserId] ON [dbo].[UserRoles] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_UserRoles_RoleId] ON [dbo].[UserRoles] ([RoleId]);
```

### 2.2 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| UserId | NVARCHAR | 50 | NO | - | 使用者代碼 | 主鍵，外鍵至 Users |
| RoleId | NVARCHAR | 50 | NO | - | 角色代碼 | 主鍵，外鍵至 Roles |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | YES | - | 更新時間 | - |
| CreatedPriority | INT | - | YES | - | 建立者等級 | - |
| CreatedGroup | NVARCHAR | 50 | YES | - | 建立者群組 | - |

### 2.3 相關資料表

#### 2.3.1 `Users` - 使用者主檔
- 用於驗證使用者是否存在
- 用於顯示使用者資訊

#### 2.3.2 `Roles` - 角色主檔
- 用於驗證角色是否存在
- 用於顯示角色資訊

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢使用者已分配的角色列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/roles`
- **說明**: 查詢指定使用者已分配的角色列表
- **路徑參數**:
  - `userId` (string, required): 使用者代碼
- **查詢參數**:
  - `pageIndex` (int, optional): 頁碼，預設 1
  - `pageSize` (int, optional): 每頁筆數，預設 20
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "userId": "USER001",
          "roleId": "ROLE001",
          "roleName": "系統管理員",
          "createdBy": "ADMIN",
          "createdAt": "2024-01-01T00:00:00Z"
        }
      ],
      "totalCount": 1,
      "pageIndex": 1,
      "pageSize": 20
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢所有可用角色列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/users/{userId}/roles/available`
- **說明**: 查詢指定使用者可分配的角色列表（排除已分配的角色）
- **路徑參數**:
  - `userId` (string, required): 使用者代碼
- **查詢參數**:
  - `keyword` (string, optional): 搜尋關鍵字（角色代碼或名稱）
  - `pageIndex` (int, optional): 頁碼，預設 1
  - `pageSize` (int, optional): 每頁筆數，預設 20
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "roleId": "ROLE002",
          "roleName": "一般使用者",
          "roleNote": "一般使用者角色"
        }
      ],
      "totalCount": 1,
      "pageIndex": 1,
      "pageSize": 20
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 為使用者分配角色（新增）
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/users/{userId}/roles`
- **說明**: 為指定使用者分配一個或多個角色
- **路徑參數**:
  - `userId` (string, required): 使用者代碼
- **請求主體**:
  ```json
  {
    "roleIds": ["ROLE001", "ROLE002"]
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "角色分配成功",
    "data": {
      "assignedCount": 2
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 移除使用者的角色（刪除）
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/users/{userId}/roles`
- **說明**: 移除指定使用者的一個或多個角色
- **路徑參數**:
  - `userId` (string, required): 使用者代碼
- **請求主體**:
  ```json
  {
    "roleIds": ["ROLE001"]
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "角色移除成功",
    "data": {
      "removedCount": 1
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.5 批量更新使用者角色
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/users/{userId}/roles/batch`
- **說明**: 批量更新使用者的角色（先刪除舊角色，再新增新角色）
- **路徑參數**:
  - `userId` (string, required): 使用者代碼
- **請求主體**:
  ```json
  {
    "roleIds": ["ROLE001", "ROLE002", "ROLE003"]
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "角色更新成功",
    "data": {
      "addedCount": 2,
      "removedCount": 1
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

### 3.2 業務邏輯

#### 3.2.1 新增角色分配
1. 驗證使用者是否存在
2. 驗證角色是否存在
3. 檢查是否已存在該使用者-角色對應關係
4. 建立使用者-角色對應關係
5. 清除使用者權限快取
6. 記錄操作日誌

#### 3.2.2 刪除角色分配
1. 驗證使用者是否存在
2. 驗證角色是否存在
3. 檢查是否存在該使用者-角色對應關係
4. 刪除使用者-角色對應關係
5. 清除使用者權限快取
6. 記錄操作日誌

#### 3.2.3 批量更新角色分配
1. 查詢使用者目前分配的角色
2. 計算需要新增的角色（新角色列表 - 目前角色列表）
3. 計算需要刪除的角色（目前角色列表 - 新角色列表）
4. 執行刪除操作
5. 執行新增操作
6. 清除使用者權限快取
7. 記錄操作日誌

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 角色列表頁面 (`UserRoleList.vue`)
- **路由**: `/system/users/:userId/roles`
- **功能**: 顯示使用者已分配的角色列表，並提供分配/移除功能

**頁面布局**:
```
┌─────────────────────────────────────────┐
│  使用者角色設定維護                      │
├─────────────────────────────────────────┤
│  使用者資訊: [USER001] 張三              │
├─────────────────────────────────────────┤
│  [查詢] [新增角色] [批量更新]            │
├─────────────────────────────────────────┤
│  已分配角色列表:                         │
│  ┌───────────────────────────────────┐ │
│  │ ☑ 角色代碼 │ 角色名稱 │ 建立時間 │ │
│  │ ☑ ROLE001  │ 系統管理員│ 2024-01-01│ │
│  │ ☐ ROLE002  │ 一般使用者│ 2024-01-02│ │
│  └───────────────────────────────────┘ │
│  [移除選取] [全選] [取消全選]            │
└─────────────────────────────────────────┘
```

**主要元件**:
- `UserInfoCard`: 顯示使用者基本資訊
- `RoleListTable`: 角色列表表格（支援複選）
- `RoleSearchDialog`: 角色搜尋對話框（用於新增角色）
- `BatchUpdateDialog`: 批量更新對話框

#### 4.1.2 角色選擇對話框 (`RoleSelectDialog.vue`)
- **功能**: 選擇要分配給使用者的角色

**對話框布局**:
```
┌─────────────────────────────────────────┐
│  選擇角色                        [X]     │
├─────────────────────────────────────────┤
│  搜尋: [________________] [搜尋]        │
├─────────────────────────────────────────┤
│  ┌───────────────────────────────────┐ │
│  │ ☐ 角色代碼 │ 角色名稱 │ 角色說明 │ │
│  │ ☐ ROLE001  │ 系統管理員│ 系統管理 │ │
│  │ ☐ ROLE002  │ 一般使用者│ 一般使用 │ │
│  └───────────────────────────────────┘ │
│  [確定] [取消]                           │
└─────────────────────────────────────────┘
```

### 4.2 UI 元件設計

#### 4.2.1 角色列表表格 (`RoleListTable.vue`)
**Props**:
- `userId` (string, required): 使用者代碼
- `roles` (array, required): 角色列表
- `loading` (boolean, optional): 載入狀態

**Events**:
- `selection-change`: 選取變更事件
- `remove`: 移除角色事件

**功能**:
- 顯示角色列表
- 支援複選
- 支援排序
- 支援分頁

#### 4.2.2 角色搜尋對話框 (`RoleSearchDialog.vue`)
**Props**:
- `visible` (boolean, required): 顯示狀態
- `userId` (string, required): 使用者代碼
- `excludeRoleIds` (array, optional): 排除的角色ID列表

**Events**:
- `confirm`: 確認選擇事件
- `cancel`: 取消事件

**功能**:
- 搜尋可用角色
- 多選角色
- 過濾已分配的角色

### 4.3 互動流程

#### 4.3.1 新增角色流程
1. 使用者點擊「新增角色」按鈕
2. 開啟角色搜尋對話框
3. 使用者搜尋並選擇角色
4. 點擊「確定」
5. 呼叫 API 新增角色
6. 更新角色列表
7. 顯示成功訊息

#### 4.3.2 移除角色流程
1. 使用者在角色列表中勾選要移除的角色
2. 點擊「移除選取」按鈕
3. 顯示確認對話框
4. 確認後呼叫 API 移除角色
5. 更新角色列表
6. 顯示成功訊息

#### 4.3.3 批量更新流程
1. 使用者點擊「批量更新」按鈕
2. 開啟批量更新對話框
3. 顯示所有可用角色（已選中的角色預設勾選）
4. 使用者勾選/取消勾選角色
5. 點擊「確定」
6. 呼叫 API 批量更新
7. 更新角色列表
8. 顯示成功訊息

---

## 五、CRUD 操作詳細設計

### 5.1 查詢 (Read)

#### 5.1.1 查詢使用者已分配的角色
**後端實作**:
```csharp
public async Task<ApiResponse<PagedResult<UserRoleDto>>> GetUserRolesAsync(
    string userId, 
    int pageIndex = 1, 
    int pageSize = 20)
{
    // 1. 驗證使用者是否存在
    var user = await _userRepository.GetByIdAsync(userId);
    if (user == null)
        return ApiResponse<PagedResult<UserRoleDto>>.Fail("使用者不存在");

    // 2. 查詢使用者角色
    var userRoles = await _userRoleRepository.GetByUserIdAsync(userId, pageIndex, pageSize);
    
    // 3. 組裝回應資料
    var result = new PagedResult<UserRoleDto>
    {
        Items = userRoles.Items.Select(ur => new UserRoleDto
        {
            UserId = ur.UserId,
            RoleId = ur.RoleId,
            RoleName = ur.Role?.RoleName,
            CreatedBy = ur.CreatedBy,
            CreatedAt = ur.CreatedAt
        }).ToList(),
        TotalCount = userRoles.TotalCount,
        PageIndex = pageIndex,
        PageSize = pageSize
    };

    return ApiResponse<PagedResult<UserRoleDto>>.Success(result);
}
```

**前端實作**:
```typescript
async function loadUserRoles(userId: string) {
  loading.value = true;
  try {
    const response = await userRoleApi.getUserRoles(userId, {
      pageIndex: pagination.pageIndex,
      pageSize: pagination.pageSize
    });
    roles.value = response.data.items;
    pagination.total = response.data.totalCount;
  } catch (error) {
    ElMessage.error('載入角色列表失敗');
  } finally {
    loading.value = false;
  }
}
```

#### 5.1.2 查詢可用角色列表
**後端實作**:
```csharp
public async Task<ApiResponse<PagedResult<RoleDto>>> GetAvailableRolesAsync(
    string userId, 
    string? keyword = null,
    int pageIndex = 1, 
    int pageSize = 20)
{
    // 1. 查詢使用者已分配的角色ID
    var assignedRoleIds = await _userRoleRepository.GetRoleIdsByUserIdAsync(userId);
    
    // 2. 查詢所有角色（排除已分配的）
    var roles = await _roleRepository.GetAvailableRolesAsync(
        assignedRoleIds, 
        keyword, 
        pageIndex, 
        pageSize);
    
    // 3. 組裝回應資料
    var result = new PagedResult<RoleDto>
    {
        Items = roles.Items.Select(r => new RoleDto
        {
            RoleId = r.RoleId,
            RoleName = r.RoleName,
            RoleNote = r.RoleNote
        }).ToList(),
        TotalCount = roles.TotalCount,
        PageIndex = pageIndex,
        PageSize = pageSize
    };

    return ApiResponse<PagedResult<RoleDto>>.Success(result);
}
```

### 5.2 新增 (Create)

#### 5.2.1 為使用者分配角色
**後端實作**:
```csharp
public async Task<ApiResponse<AssignRoleResult>> AssignRolesAsync(
    string userId, 
    List<string> roleIds)
{
    // 1. 驗證使用者是否存在
    var user = await _userRepository.GetByIdAsync(userId);
    if (user == null)
        return ApiResponse<AssignRoleResult>.Fail("使用者不存在");

    // 2. 驗證角色是否存在
    var roles = await _roleRepository.GetByIdsAsync(roleIds);
    if (roles.Count != roleIds.Count)
        return ApiResponse<AssignRoleResult>.Fail("部分角色不存在");

    // 3. 檢查是否已存在
    var existingUserRoles = await _userRoleRepository.GetByUserIdAndRoleIdsAsync(userId, roleIds);
    var existingRoleIds = existingUserRoles.Select(ur => ur.RoleId).ToList();
    var newRoleIds = roleIds.Except(existingRoleIds).ToList();

    if (newRoleIds.Count == 0)
        return ApiResponse<AssignRoleResult>.Fail("所有角色已分配");

    // 4. 新增角色分配
    var currentUser = _currentUserService.GetCurrentUser();
    var userRoles = newRoleIds.Select(roleId => new UserRole
    {
        UserId = userId,
        RoleId = roleId,
        CreatedBy = currentUser.UserId,
        CreatedAt = DateTime.UtcNow,
        CreatedPriority = currentUser.Priority,
        CreatedGroup = currentUser.GroupId
    }).ToList();

    await _userRoleRepository.AddRangeAsync(userRoles);

    // 5. 清除使用者權限快取
    await _cacheService.RemoveAsync($"user_permissions_{userId}");

    // 6. 記錄操作日誌
    await _logService.LogAsync(new OperationLog
    {
        UserId = currentUser.UserId,
        Action = "AssignRoles",
        TargetType = "UserRole",
        TargetId = userId,
        Description = $"為使用者 {userId} 分配角色: {string.Join(", ", newRoleIds)}"
    });

    return ApiResponse<AssignRoleResult>.Success(new AssignRoleResult
    {
        AssignedCount = newRoleIds.Count
    });
}
```

**前端實作**:
```typescript
async function assignRoles(userId: string, roleIds: string[]) {
  try {
    const response = await userRoleApi.assignRoles(userId, { roleIds });
    ElMessage.success(`成功分配 ${response.data.assignedCount} 個角色`);
    await loadUserRoles(userId);
  } catch (error: any) {
    ElMessage.error(error.message || '分配角色失敗');
  }
}
```

### 5.3 刪除 (Delete)

#### 5.3.1 移除使用者的角色
**後端實作**:
```csharp
public async Task<ApiResponse<RemoveRoleResult>> RemoveRolesAsync(
    string userId, 
    List<string> roleIds)
{
    // 1. 驗證使用者是否存在
    var user = await _userRepository.GetByIdAsync(userId);
    if (user == null)
        return ApiResponse<RemoveRoleResult>.Fail("使用者不存在");

    // 2. 查詢要刪除的使用者角色
    var userRoles = await _userRoleRepository.GetByUserIdAndRoleIdsAsync(userId, roleIds);
    if (userRoles.Count == 0)
        return ApiResponse<RemoveRoleResult>.Fail("未找到要移除的角色");

    // 3. 刪除角色分配
    await _userRoleRepository.RemoveRangeAsync(userRoles);

    // 4. 清除使用者權限快取
    await _cacheService.RemoveAsync($"user_permissions_{userId}");

    // 5. 記錄操作日誌
    var currentUser = _currentUserService.GetCurrentUser();
    await _logService.LogAsync(new OperationLog
    {
        UserId = currentUser.UserId,
        Action = "RemoveRoles",
        TargetType = "UserRole",
        TargetId = userId,
        Description = $"移除使用者 {userId} 的角色: {string.Join(", ", roleIds)}"
    });

    return ApiResponse<RemoveRoleResult>.Success(new RemoveRoleResult
    {
        RemovedCount = userRoles.Count
    });
}
```

**前端實作**:
```typescript
async function removeRoles(userId: string, roleIds: string[]) {
  try {
    await ElMessageBox.confirm(
      `確定要移除選取的 ${roleIds.length} 個角色嗎？`,
      '確認移除',
      {
        confirmButtonText: '確定',
        cancelButtonText: '取消',
        type: 'warning'
      }
    );

    const response = await userRoleApi.removeRoles(userId, { roleIds });
    ElMessage.success(`成功移除 ${response.data.removedCount} 個角色`);
    await loadUserRoles(userId);
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error(error.message || '移除角色失敗');
    }
  }
}
```

### 5.4 更新 (Update)

#### 5.4.1 批量更新使用者角色
**後端實作**:
```csharp
public async Task<ApiResponse<BatchUpdateResult>> BatchUpdateRolesAsync(
    string userId, 
    List<string> roleIds)
{
    // 1. 驗證使用者是否存在
    var user = await _userRepository.GetByIdAsync(userId);
    if (user == null)
        return ApiResponse<BatchUpdateResult>.Fail("使用者不存在");

    // 2. 驗證角色是否存在
    var roles = await _roleRepository.GetByIdsAsync(roleIds);
    if (roles.Count != roleIds.Count)
        return ApiResponse<BatchUpdateResult>.Fail("部分角色不存在");

    // 3. 查詢目前分配的角色
    var currentUserRoles = await _userRoleRepository.GetByUserIdAsync(userId);
    var currentRoleIds = currentUserRoles.Select(ur => ur.RoleId).ToList();

    // 4. 計算需要新增和刪除的角色
    var roleIdsToAdd = roleIds.Except(currentRoleIds).ToList();
    var roleIdsToRemove = currentRoleIds.Except(roleIds).ToList();

    var currentUser = _currentUserService.GetCurrentUser();

    // 5. 執行刪除
    if (roleIdsToRemove.Count > 0)
    {
        var userRolesToRemove = currentUserRoles
            .Where(ur => roleIdsToRemove.Contains(ur.RoleId))
            .ToList();
        await _userRoleRepository.RemoveRangeAsync(userRolesToRemove);
    }

    // 6. 執行新增
    if (roleIdsToAdd.Count > 0)
    {
        var userRolesToAdd = roleIdsToAdd.Select(roleId => new UserRole
        {
            UserId = userId,
            RoleId = roleId,
            CreatedBy = currentUser.UserId,
            CreatedAt = DateTime.UtcNow,
            CreatedPriority = currentUser.Priority,
            CreatedGroup = currentUser.GroupId
        }).ToList();
        await _userRoleRepository.AddRangeAsync(userRolesToAdd);
    }

    // 7. 清除使用者權限快取
    await _cacheService.RemoveAsync($"user_permissions_{userId}");

    // 8. 記錄操作日誌
    await _logService.LogAsync(new OperationLog
    {
        UserId = currentUser.UserId,
        Action = "BatchUpdateRoles",
        TargetType = "UserRole",
        TargetId = userId,
        Description = $"批量更新使用者 {userId} 的角色。新增: {string.Join(", ", roleIdsToAdd)}, 移除: {string.Join(", ", roleIdsToRemove)}"
    });

    return ApiResponse<BatchUpdateResult>.Success(new BatchUpdateResult
    {
        AddedCount = roleIdsToAdd.Count,
        RemovedCount = roleIdsToRemove.Count
    });
}
```

**前端實作**:
```typescript
async function batchUpdateRoles(userId: string, roleIds: string[]) {
  try {
    const response = await userRoleApi.batchUpdateRoles(userId, { roleIds });
    const { addedCount, removedCount } = response.data;
    let message = '';
    if (addedCount > 0 && removedCount > 0) {
      message = `成功新增 ${addedCount} 個角色，移除 ${removedCount} 個角色`;
    } else if (addedCount > 0) {
      message = `成功新增 ${addedCount} 個角色`;
    } else if (removedCount > 0) {
      message = `成功移除 ${removedCount} 個角色`;
    } else {
      message = '角色設定未變更';
    }
    ElMessage.success(message);
    await loadUserRoles(userId);
  } catch (error: any) {
    ElMessage.error(error.message || '批量更新失敗');
  }
}
```

---

## 六、錯誤處理

### 6.1 常見錯誤情況

1. **使用者不存在**
   - HTTP 狀態碼: 404
   - 錯誤訊息: "使用者不存在"

2. **角色不存在**
   - HTTP 狀態碼: 404
   - 錯誤訊息: "角色不存在"

3. **角色已分配**
   - HTTP 狀態碼: 400
   - 錯誤訊息: "角色已分配給該使用者"

4. **角色未分配**
   - HTTP 狀態碼: 400
   - 錯誤訊息: "該角色未分配給使用者"

5. **無權限操作**
   - HTTP 狀態碼: 403
   - 錯誤訊息: "無權限執行此操作"

### 6.2 前端錯誤處理

```typescript
try {
  await userRoleApi.assignRoles(userId, { roleIds });
} catch (error: any) {
  if (error.response?.status === 404) {
    ElMessage.error('使用者或角色不存在');
  } else if (error.response?.status === 400) {
    ElMessage.error(error.response.data.message || '操作失敗');
  } else if (error.response?.status === 403) {
    ElMessage.error('無權限執行此操作');
  } else {
    ElMessage.error('系統錯誤，請稍後再試');
  }
}
```

---

## 七、測試計劃

### 7.1 單元測試

1. **後端服務測試**
   - 測試新增角色分配
   - 測試移除角色分配
   - 測試批量更新角色
   - 測試查詢功能
   - 測試錯誤處理

2. **前端元件測試**
   - 測試角色列表顯示
   - 測試角色選擇對話框
   - 測試批量更新對話框
   - 測試錯誤訊息顯示

### 7.2 整合測試

1. **API 整合測試**
   - 測試完整的 CRUD 流程
   - 測試權限驗證
   - 測試快取清除

2. **前端整合測試**
   - 測試完整的操作流程
   - 測試資料同步

### 7.3 E2E 測試

1. **使用者角色設定流程**
   - 登入系統
   - 進入使用者角色設定頁面
   - 新增角色
   - 移除角色
   - 批量更新角色
   - 驗證結果

---

## 八、開發時程

- **後端開發**: 2 天
  - API 設計與實作: 1 天
  - 單元測試: 0.5 天
  - 整合測試: 0.5 天

- **前端開發**: 2 天
  - UI 元件開發: 1 天
  - 頁面整合: 0.5 天
  - 測試與優化: 0.5 天

- **總計**: 4 天

---

## 九、注意事項

1. **權限快取**: 變更使用者角色後，必須清除該使用者的權限快取，確保權限即時生效

2. **資料完整性**: 刪除使用者或角色時，會自動刪除相關的使用者角色對應關係（CASCADE）

3. **操作日誌**: 所有角色分配/移除操作都需記錄操作日誌，便於追蹤與審計

4. **並發控制**: 批量更新時需考慮並發情況，建議使用資料庫事務確保資料一致性

5. **效能優化**: 查詢使用者角色時，可考慮使用快取機制提升效能

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

