# SYS0630 - 使用者角色對應設定異動查詢 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0630
- **功能名稱**: 使用者角色對應設定異動查詢
- **功能描述**: 提供使用者與角色對應設定異動記錄的查詢功能，可查詢指定使用者或角色的對應設定異動歷史記錄
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0630_FQ.asp` (查詢條件頁面)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0630_FB.ASP` (查詢結果頁面)

### 1.2 業務需求
- 查詢使用者與角色對應設定的異動記錄
- 支援依異動使用者代碼查詢
- 支援依被異動的使用者代碼查詢
- 支援依被異動的角色代碼查詢
- 支援依日期範圍查詢
- 顯示異動詳細資訊（異動欄位、異動前的值、異動後的值）
- 顯示異動狀態（新增、刪除、修改）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `ChangeLogs` (對應舊系統 `MNG_LOG`)

```sql
CREATE TABLE [dbo].[ChangeLogs] (
    [LogId] BIGINT NOT NULL IDENTITY(1,1) PRIMARY KEY,
    [ProgramId] NVARCHAR(50) NOT NULL, -- 程式代碼 (SYS0220, SYS0230)
    [ChangeUserId] NVARCHAR(50) NULL, -- 異動使用者代碼 (CH_USER_ID)
    [ChangeDate] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 異動時間 (CH_DATE)
    [ChangeStatus] NVARCHAR(10) NOT NULL, -- 異動狀態: 1=新增, 2=刪除, 3=修改 (CH_STATUS)
    [ChangeField] NVARCHAR(500) NULL, -- 異動欄位名稱 (CH_FIELD)
    [OldValue] NVARCHAR(MAX) NULL, -- 異動前的值 (OLD_VALUE)
    [NewValue] NVARCHAR(MAX) NULL, -- 異動後的值 (NEW_VALUE)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_ChangeLogs] PRIMARY KEY CLUSTERED ([LogId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ProgramId] ON [dbo].[ChangeLogs] ([ProgramId]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ChangeUserId] ON [dbo].[ChangeLogs] ([ChangeUserId]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ChangeDate] ON [dbo].[ChangeLogs] ([ChangeDate]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ProgramId_ChangeDate] ON [dbo].[ChangeLogs] ([ProgramId], [ChangeDate]);
```

### 2.2 相關資料表

#### 2.2.1 `Users` - 使用者主檔
- 用於查詢使用者名稱
- 參考: `開發計劃/01-系統管理/01-使用者管理/SYS0110-使用者基本資料維護.md`

#### 2.2.2 `Roles` - 角色主檔
- 用於查詢角色名稱
- 參考: `開發計劃/01-系統管理/02-角色管理/SYS0210-角色基本資料維護.md`

#### 2.2.3 `UserRoles` - 使用者角色對應表
- 用於查詢使用者與角色的對應關係
- 參考: `開發計劃/01-系統管理/02-角色管理/SYS0220-使用者角色設定維護.md`

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| LogId | BIGINT | - | NO | - | 主鍵 | IDENTITY(1,1) |
| ProgramId | NVARCHAR | 50 | NO | - | 程式代碼 | SYS0220, SYS0230 |
| ChangeUserId | NVARCHAR | 50 | YES | - | 異動使用者代碼 | 外鍵至Users |
| ChangeDate | DATETIME2 | - | NO | GETDATE() | 異動時間 | - |
| ChangeStatus | NVARCHAR | 10 | NO | - | 異動狀態 | 1=新增, 2=刪除, 3=修改 |
| ChangeField | NVARCHAR | 500 | YES | - | 異動欄位名稱 | - |
| OldValue | NVARCHAR(MAX) | - | YES | - | 異動前的值 | - |
| NewValue | NVARCHAR(MAX) | - | YES | - | 異動後的值 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢使用者角色對應設定異動記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/change-logs/user-roles`
- **說明**: 查詢使用者角色對應設定異動記錄列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "ChangeDate",
    "sortOrder": "DESC",
    "filters": {
      "changeUserId": "USER001",
      "searchUserId": "USER002",
      "searchRoleId": "ROLE001",
      "startDate": "2024-01-01",
      "endDate": "2024-01-31"
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "logId": 1,
          "programId": "SYS0220",
          "programName": "使用者角色設定維護",
          "changeUserId": "USER001",
          "changeUserName": "張三",
          "changeDate": "2024-01-01T10:30:00",
          "changeStatus": "1",
          "changeStatusName": "新增",
          "changeField": "USER_ID,ROLE_ID",
          "oldValue": "",
          "newValue": "USER002,ROLE001",
          "oldValueDisplay": {
            "userId": null,
            "userName": null,
            "roleId": null,
            "roleName": null
          },
          "newValueDisplay": {
            "userId": "USER002",
            "userName": "李四",
            "roleId": "ROLE001",
            "roleName": "系統管理員"
          }
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出異動記錄報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/change-logs/user-roles/export`
- **說明**: 匯出異動記錄報表 (Excel/PDF)
- **請求格式**: 同查詢參數
- **回應格式**: 檔案下載

### 3.2 資料傳輸物件 (DTO)

#### 3.2.1 `UserRoleChangeLogQueryDto`
```csharp
public class UserRoleChangeLogQueryDto
{
    public int PageIndex { get; set; } = 1;
    public int PageSize { get; set; } = 20;
    public string? SortField { get; set; }
    public string SortOrder { get; set; } = "DESC";
    public UserRoleChangeLogFilterDto? Filters { get; set; }
}

public class UserRoleChangeLogFilterDto
{
    public string? ChangeUserId { get; set; }
    public string? SearchUserId { get; set; }
    public string? SearchRoleId { get; set; }
    public DateTime? StartDate { get; set; }
    public DateTime? EndDate { get; set; }
}
```

#### 3.2.2 `UserRoleChangeLogDto`
```csharp
public class UserRoleChangeLogDto
{
    public long LogId { get; set; }
    public string ProgramId { get; set; } = string.Empty;
    public string? ProgramName { get; set; }
    public string? ChangeUserId { get; set; }
    public string? ChangeUserName { get; set; }
    public DateTime ChangeDate { get; set; }
    public string ChangeStatus { get; set; } = string.Empty;
    public string? ChangeStatusName { get; set; }
    public string? ChangeField { get; set; }
    public string? OldValue { get; set; }
    public string? NewValue { get; set; }
    public UserRoleValueDisplayDto? OldValueDisplay { get; set; }
    public UserRoleValueDisplayDto? NewValueDisplay { get; set; }
}

public class UserRoleValueDisplayDto
{
    public string? UserId { get; set; }
    public string? UserName { get; set; }
    public string? RoleId { get; set; }
    public string? RoleName { get; set; }
}
```

### 3.3 Service 層設計

#### 3.3.1 `IUserRoleChangeLogService`
```csharp
public interface IUserRoleChangeLogService
{
    Task<PagedResult<UserRoleChangeLogDto>> GetUserRoleChangeLogsAsync(UserRoleChangeLogQueryDto query, CancellationToken cancellationToken = default);
    Task<byte[]> ExportUserRoleChangeLogReportAsync(UserRoleChangeLogQueryDto query, string format, CancellationToken cancellationToken = default);
}
```

#### 3.3.2 `UserRoleChangeLogService` 實作重點
- 查詢條件需包含 SYS0220 和 SYS0230 兩個程式代碼
- 異動前的值和異動後的值需解析並顯示使用者名稱和角色名稱
- 支援依被異動的使用者代碼和角色代碼模糊查詢
- 日期範圍查詢需包含結束日期當天

### 3.4 Repository 層設計

#### 3.4.1 `IChangeLogRepository`
```csharp
public interface IChangeLogRepository
{
    Task<PagedResult<ChangeLog>> GetUserRoleChangeLogsAsync(UserRoleChangeLogQuery query, CancellationToken cancellationToken = default);
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 使用者角色對應設定異動查詢頁面 (`UserRoleChangeLogQuery.vue`)
- **路徑**: `/system/change-logs/user-roles`
- **功能**: 顯示使用者角色對應設定異動記錄查詢表單與結果列表
- **主要元件**:
  - 查詢表單 (UserRoleChangeLogSearchForm)
  - 資料表格 (UserRoleChangeLogDataTable)
  - 匯出按鈕

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`UserRoleChangeLogSearchForm.vue`)
```vue
<template>
  <el-form :model="searchForm" inline>
    <el-form-item label="異動使用者代碼">
      <el-input v-model="searchForm.changeUserId" placeholder="請輸入異動使用者代碼" clearable />
      <el-button type="primary" icon="Search" @click="openUserListDialog('changeUser')" style="margin-left: 10px">選擇</el-button>
      <el-input v-model="changeUserName" readonly style="width: 200px; margin-left: 10px" placeholder="異動使用者名稱" />
    </el-form-item>
    <el-form-item label="被異動使用者代碼">
      <el-input v-model="searchForm.searchUserId" placeholder="請輸入被異動使用者代碼" clearable />
      <el-button type="primary" icon="Search" @click="openUserListDialog('searchUser')" style="margin-left: 10px">選擇</el-button>
    </el-form-item>
    <el-form-item label="被異動角色代碼">
      <el-input v-model="searchForm.searchRoleId" placeholder="請輸入被異動角色代碼" clearable />
      <el-button type="primary" icon="Search" @click="openRoleListDialog()" style="margin-left: 10px">選擇</el-button>
      <el-input v-model="roleName" readonly style="width: 200px; margin-left: 10px" placeholder="角色名稱" />
    </el-form-item>
    <el-form-item label="日期範圍" required>
      <el-date-picker v-model="dateRange" type="daterange" range-separator="至" start-placeholder="開始日期" end-placeholder="結束日期" format="YYYY/MM/DD" value-format="YYYY-MM-DD" />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button type="success" @click="handleExport">匯出</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 資料表格元件 (`UserRoleChangeLogDataTable.vue`)
```vue
<template>
  <div>
    <el-table :data="changeLogList" v-loading="loading" border>
      <el-table-column type="index" label="序號" width="60" />
      <el-table-column prop="changeDate" label="異動時間" width="160" sortable="custom" />
      <el-table-column prop="changeUserId" label="異動者代碼" width="120" />
      <el-table-column prop="changeUserName" label="異動者名稱" width="150" />
      <el-table-column prop="changeStatusName" label="異動狀態" width="100">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.changeStatus)">
            {{ row.changeStatusName }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="changeField" label="異動欄位" width="200" />
      <el-table-column label="異動前的值" width="300">
        <template #default="{ row }">
          <div v-if="row.oldValueDisplay">
            <div v-if="row.oldValueDisplay.userId">
              <strong>使用者:</strong> {{ row.oldValueDisplay.userId }} - {{ row.oldValueDisplay.userName }}
            </div>
            <div v-if="row.oldValueDisplay.roleId">
              <strong>角色:</strong> {{ row.oldValueDisplay.roleId }} - {{ row.oldValueDisplay.roleName }}
            </div>
            <div v-if="!row.oldValueDisplay.userId && !row.oldValueDisplay.roleId">
              {{ row.oldValue || '(無)' }}
            </div>
          </div>
          <span v-else>{{ row.oldValue || '(無)' }}</span>
        </template>
      </el-table-column>
      <el-table-column label="異動後的值" width="300">
        <template #default="{ row }">
          <div v-if="row.newValueDisplay">
            <div v-if="row.newValueDisplay.userId">
              <strong>使用者:</strong> {{ row.newValueDisplay.userId }} - {{ row.newValueDisplay.userName }}
            </div>
            <div v-if="row.newValueDisplay.roleId">
              <strong>角色:</strong> {{ row.newValueDisplay.roleId }} - {{ row.newValueDisplay.roleName }}
            </div>
            <div v-if="!row.newValueDisplay.userId && !row.newValueDisplay.roleId">
              {{ row.newValue || '(無)' }}
            </div>
          </div>
          <span v-else>{{ row.newValue || '(無)' }}</span>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

### 4.3 API 呼叫 (`userRoleChangeLog.api.ts`)
```typescript
import request from '@/utils/request';

export interface UserRoleChangeLogDto {
  logId: number;
  programId: string;
  programName?: string;
  changeUserId?: string;
  changeUserName?: string;
  changeDate: string;
  changeStatus: string;
  changeStatusName?: string;
  changeField?: string;
  oldValue?: string;
  newValue?: string;
  oldValueDisplay?: {
    userId?: string;
    userName?: string;
    roleId?: string;
    roleName?: string;
  };
  newValueDisplay?: {
    userId?: string;
    userName?: string;
    roleId?: string;
    roleName?: string;
  };
}

export interface UserRoleChangeLogQueryDto {
  pageIndex: number;
  pageSize: number;
  sortField?: string;
  sortOrder?: 'ASC' | 'DESC';
  filters?: {
    changeUserId?: string;
    searchUserId?: string;
    searchRoleId?: string;
    startDate?: string;
    endDate?: string;
  };
}

// API 函數
export const getUserRoleChangeLogList = (query: UserRoleChangeLogQueryDto) => {
  return request.get<ApiResponse<PagedResult<UserRoleChangeLogDto>>>('/api/v1/change-logs/user-roles', { params: query });
};

export const exportUserRoleChangeLogReport = (query: UserRoleChangeLogQueryDto, format: 'excel' | 'pdf') => {
  return request.post(`/api/v1/change-logs/user-roles/export?format=${format}`, query, {
    responseType: 'blob'
  });
};
```

---

## 五、後端實作類別

### 5.1 Controller: `UserRoleChangeLogsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/change-logs/user-roles")]
    [Authorize]
    public class UserRoleChangeLogsController : ControllerBase
    {
        private readonly IUserRoleChangeLogService _userRoleChangeLogService;
        
        public UserRoleChangeLogsController(IUserRoleChangeLogService userRoleChangeLogService)
        {
            _userRoleChangeLogService = userRoleChangeLogService;
        }
        
        [HttpGet]
        public async Task<ActionResult<ApiResponse<PagedResult<UserRoleChangeLogDto>>>> GetUserRoleChangeLogs([FromQuery] UserRoleChangeLogQueryDto query)
        {
            // 實作查詢邏輯
        }
        
        [HttpPost("export")]
        public async Task<IActionResult> ExportUserRoleChangeLogReport([FromBody] UserRoleChangeLogQueryDto query, [FromQuery] string format = "excel")
        {
            // 實作匯出邏輯
        }
    }
}
```

### 5.2 Service: `UserRoleChangeLogService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IUserRoleChangeLogService
    {
        Task<PagedResult<UserRoleChangeLogDto>> GetUserRoleChangeLogsAsync(UserRoleChangeLogQueryDto query);
        Task<byte[]> ExportUserRoleChangeLogReportAsync(UserRoleChangeLogQueryDto query, string format);
    }
}
```

### 5.3 Repository: `ChangeLogRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public interface IChangeLogRepository
    {
        Task<PagedResult<ChangeLog>> GetUserRoleChangeLogsAsync(UserRoleChangeLogQuery query);
    }
}
```

---

## 六、開發時程

### 6.1 階段一: 資料庫設計 (1天)
- [ ] 確認 ChangeLogs 資料表結構
- [ ] 確認索引
- [ ] 資料庫遷移腳本

### 6.2 階段二: 後端開發 (3天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 值解析邏輯實作
- [ ] 匯出功能實作
- [ ] 單元測試

### 6.3 階段三: 前端開發 (3天)
- [ ] API 呼叫函數
- [ ] 查詢頁面開發
- [ ] 查詢表單開發
- [ ] 資料表格開發
- [ ] 值顯示元件開發
- [ ] 匯出功能整合
- [ ] 元件測試

### 6.4 階段四: 整合測試 (1天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 大量資料查詢測試

### 6.5 階段五: 文件與部署 (1天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 9天

---

## 七、注意事項

### 7.1 安全性
- 必須實作權限檢查
- 敏感資料必須加密傳輸 (HTTPS)

### 7.2 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 日期範圍查詢需使用索引優化
- 值解析需考慮效能，避免 N+1 查詢

### 7.3 資料驗證
- 日期格式驗證
- 日期範圍合理性檢查
- 使用者代碼和角色代碼存在性檢查

### 7.4 業務邏輯
- 查詢條件需包含 SYS0220 和 SYS0230 兩個程式代碼
- 異動前的值和異動後的值需解析並顯示使用者名稱和角色名稱
- 支援依被異動的使用者代碼和角色代碼模糊查詢
- 日期範圍查詢需包含結束日期當天

### 7.5 資料顯示
- 異動前的值和異動後的值需格式化顯示
- 新增狀態時，異動前的值為空
- 刪除狀態時，異動後的值為空
- 修改狀態時，需顯示異動前後對比

---

## 八、測試案例

### 8.1 單元測試
- [ ] 查詢使用者角色對應設定異動記錄成功
- [ ] 依異動使用者代碼查詢成功
- [ ] 依被異動使用者代碼查詢成功
- [ ] 依被異動角色代碼查詢成功
- [ ] 依日期範圍查詢成功
- [ ] 值解析邏輯測試
- [ ] 匯出 Excel 報表成功
- [ ] 匯出 PDF 報表成功

### 8.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 權限檢查測試
- [ ] 資料驗證測試
- [ ] 錯誤處理測試
- [ ] 值顯示測試

### 8.3 效能測試
- [ ] 大量資料查詢測試
- [ ] 並發查詢測試
- [ ] 值解析效能測試

---

## 九、參考資料

### 9.1 舊程式碼
- `WEB/IMS_CORE/ASP/SYS0000/SYS0630_FQ.asp`
- `WEB/IMS_CORE/ASP/SYS0000/SYS0630_FB.ASP`

### 9.2 相關功能
- SYS0220 - 使用者角色設定維護
- SYS0230 - 角色之使用者設定維護
- SYS0610 - 使用者基本資料異動查詢
- SYS0620 - 角色基本資料異動查詢

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

