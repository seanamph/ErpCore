# SYS0620 - 角色基本資料異動查詢 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0620
- **功能名稱**: 角色基本資料異動查詢
- **功能描述**: 提供角色基本資料異動記錄的查詢功能，可查詢指定角色或所有角色的資料異動歷史記錄
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0620_FQ.asp` (查詢條件頁面)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0620_FB.ASP` (查詢結果頁面)
  - `WEB/IMS_CORE/SYS0000/SYS0620_FB.aspx` (ASP.NET 版本)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0620_FB.aspx` (ASP.NET 版本)

### 1.2 業務需求
- 查詢角色基本資料的異動記錄
- 支援依異動使用者代碼查詢
- 支援依角色代碼查詢
- 支援依日期範圍查詢
- 顯示異動詳細資訊（異動欄位、異動前的值、異動後的值）
- 顯示異動狀態（新增、刪除、修改）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `ChangeLogs` (對應舊系統 `MNG_LOG`)

```sql
CREATE TABLE [dbo].[ChangeLogs] (
    [LogId] BIGINT NOT NULL IDENTITY(1,1) PRIMARY KEY,
    [ProgramId] NVARCHAR(50) NOT NULL, -- 程式代碼 (SYS0210)
    [ChangeUserId] NVARCHAR(50) NULL, -- 異動使用者代碼
    [ChangeDate] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 異動時間
    [ChangeStatus] NVARCHAR(10) NOT NULL, -- 異動狀態: 1=新增, 2=刪除, 3=修改
    [ChangeField] NVARCHAR(500) NULL, -- 異動欄位名稱 (多個欄位以逗號分隔)
    [OldValue] NVARCHAR(MAX) NULL, -- 異動前的值 (多個值以逗號分隔)
    [NewValue] NVARCHAR(MAX) NULL, -- 異動後的值 (多個值以逗號分隔)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_ChangeLogs] PRIMARY KEY CLUSTERED ([LogId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ProgramId] ON [dbo].[ChangeLogs] ([ProgramId]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ChangeUserId] ON [dbo].[ChangeLogs] ([ChangeUserId]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ChangeDate] ON [dbo].[ChangeLogs] ([ChangeDate]);
CREATE NONCLUSTERED INDEX [IX_ChangeLogs_ProgramId_ChangeDate] ON [dbo].[ChangeLogs] ([ProgramId], [ChangeDate] DESC);
```

### 2.2 相關資料表

#### 2.2.1 `Roles` - 角色主檔
- 用於查詢角色名稱
- 參考: `開發計劃/01-系統管理/02-角色管理/SYS0210-角色基本資料維護.md`

#### 2.2.2 `Users` - 使用者主檔
- 用於查詢異動使用者名稱
- 參考: `開發計劃/01-系統管理/01-使用者管理/SYS0110-使用者基本資料維護.md`

---

## 三、API 設計

### 3.1 查詢角色異動記錄

#### 3.1.1 查詢條件頁面資料
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/change-logs/roles/query-form`
- **說明**: 取得查詢條件表單的初始資料
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "defaultBeginDate": "2024-01-01",
      "defaultEndDate": "2024-12-31"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢角色異動記錄列表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/change-logs/roles/search`
- **說明**: 查詢角色基本資料異動記錄
- **請求格式**:
  ```json
  {
    "changeUserId": "U001", // 異動使用者代碼 (可選)
    "roleId": "R001", // 角色代碼 (可選，在 OLD_VALUE 或 NEW_VALUE 中搜尋)
    "beginDate": "2024-01-01", // 起始日期 (必填)
    "endDate": "2024-12-31", // 結束日期 (必填)
    "pageIndex": 1, // 頁碼 (可選，預設 1)
    "pageSize": 20 // 每頁筆數 (可選，預設 20)
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5,
      "items": [
        {
          "logId": 1,
          "changeUserId": "U001",
          "changeUserName": "張三",
          "changeDate": "2024-01-01T10:00:00",
          "changeStatus": "3",
          "changeStatusName": "修改",
          "changeFields": ["角色名稱", "角色敘述"],
          "oldValues": ["系統管理員", "系統管理員角色"],
          "newValues": ["系統管理員(修改)", "系統管理員角色(已更新)"],
          "changeFieldDisplay": "角色名稱,角色敘述",
          "oldValueDisplay": "系統管理員,系統管理員角色",
          "newValueDisplay": "系統管理員(修改),系統管理員角色(已更新)"
        }
      ]
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 查詢單筆異動記錄詳情
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/change-logs/{logId}`
- **說明**: 查詢單筆異動記錄的詳細資訊
- **路徑參數**:
  - `logId`: 異動記錄編號
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "logId": 1,
      "programId": "SYS0210",
      "changeUserId": "U001",
      "changeUserName": "張三",
      "changeDate": "2024-01-01T10:00:00",
      "changeStatus": "3",
      "changeStatusName": "修改",
      "changeFields": ["角色名稱", "角色敘述"],
      "oldValues": ["系統管理員", "系統管理員角色"],
      "newValues": ["系統管理員(修改)", "系統管理員角色(已更新)"],
      "changeFieldDisplay": "角色名稱,角色敘述",
      "oldValueDisplay": "系統管理員,系統管理員角色",
      "newValueDisplay": "系統管理員(修改),系統管理員角色(已更新)"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

---

## 四、前端 UI 設計

### 4.1 查詢條件頁面 (`SYS0620Query.vue`)

#### 4.1.1 頁面結構
```vue
<template>
  <div class="sys0620-query">
    <el-card>
      <template #header>
        <span>角色基本資料異動查詢</span>
      </template>
      
      <el-form :model="queryForm" :rules="rules" ref="queryFormRef" label-width="150px">
        <!-- 異動使用者代碼 -->
        <el-form-item label="異動使用者代碼" prop="changeUserId">
          <el-input 
            v-model="queryForm.changeUserId" 
            placeholder="請輸入異動使用者代碼"
            clearable
            style="width: 200px"
          />
          <el-button 
            type="primary" 
            icon="Search" 
            @click="openUserListDialog('changeUser')"
            style="margin-left: 10px"
          >
            選擇
          </el-button>
          <el-input 
            v-model="changeUserName" 
            readonly 
            style="width: 200px; margin-left: 10px"
            placeholder="異動使用者名稱"
          />
        </el-form-item>
        
        <!-- 角色代碼 -->
        <el-form-item label="角色代碼" prop="roleId">
          <el-input 
            v-model="queryForm.roleId" 
            placeholder="請輸入角色代碼"
            clearable
            style="width: 200px"
          />
          <el-button 
            type="primary" 
            icon="Search" 
            @click="openRoleListDialog()"
            style="margin-left: 10px"
          >
            選擇
          </el-button>
          <el-input 
            v-model="roleName" 
            readonly 
            style="width: 200px; margin-left: 10px"
            placeholder="角色名稱"
          />
        </el-form-item>
        
        <!-- 日期範圍 -->
        <el-form-item label="日期範圍" prop="dateRange" required>
          <el-date-picker
            v-model="queryForm.dateRange"
            type="daterange"
            range-separator="至"
            start-placeholder="起始日期"
            end-placeholder="結束日期"
            format="YYYY/MM/DD"
            value-format="YYYY-MM-DD"
            style="width: 300px"
          />
        </el-form-item>
        
        <!-- 查詢按鈕 -->
        <el-form-item>
          <el-button type="primary" icon="Search" @click="handleSearch">查詢</el-button>
          <el-button icon="Refresh" @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    
    <!-- 查詢結果 -->
    <el-card v-if="searchResult.length > 0" style="margin-top: 20px">
      <template #header>
        <span>查詢結果 (共 {{ totalCount }} 筆)</span>
      </template>
      
      <el-table :data="searchResult" border stripe style="width: 100%">
        <el-table-column type="index" label="序號" width="60" align="center" />
        <el-table-column prop="changeUserId" label="異動使用者代碼" width="120" />
        <el-table-column prop="changeUserName" label="異動使用者名稱" width="150" />
        <el-table-column prop="changeDate" label="異動時間" width="160" />
        <el-table-column prop="changeStatusName" label="異動狀態" width="100" align="center">
          <template #default="scope">
            <el-tag :type="getStatusTagType(scope.row.changeStatus)">
              {{ scope.row.changeStatusName }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="changeFieldDisplay" label="異動欄位" min-width="200" show-overflow-tooltip />
        <el-table-column label="操作" width="100" align="center" fixed="right">
          <template #default="scope">
            <el-button type="primary" link @click="viewDetail(scope.row)">詳情</el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分頁 -->
      <el-pagination
        v-model:current-page="pagination.pageIndex"
        v-model:page-size="pagination.pageSize"
        :total="pagination.totalCount"
        :page-sizes="[10, 20, 50, 100]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleSizeChange"
        @current-change="handlePageChange"
        style="margin-top: 20px; justify-content: flex-end"
      />
    </el-card>
  </div>
  
  <!-- 詳情對話框 -->
  <el-dialog v-model="detailDialogVisible" title="異動記錄詳情" width="800px">
    <el-descriptions :column="2" border v-if="currentDetail">
      <el-descriptions-item label="異動記錄編號">{{ currentDetail.logId }}</el-descriptions-item>
      <el-descriptions-item label="程式代碼">{{ currentDetail.programId }}</el-descriptions-item>
      <el-descriptions-item label="異動使用者代碼">{{ currentDetail.changeUserId }}</el-descriptions-item>
      <el-descriptions-item label="異動使用者名稱">{{ currentDetail.changeUserName }}</el-descriptions-item>
      <el-descriptions-item label="異動時間">{{ currentDetail.changeDate }}</el-descriptions-item>
      <el-descriptions-item label="異動狀態">
        <el-tag :type="getStatusTagType(currentDetail.changeStatus)">
          {{ currentDetail.changeStatusName }}
        </el-tag>
      </el-descriptions-item>
      <el-descriptions-item label="異動欄位" :span="2">
        {{ currentDetail.changeFieldDisplay }}
      </el-descriptions-item>
      <el-descriptions-item label="異動前的值" :span="2">
        <pre style="white-space: pre-wrap; word-break: break-all;">{{ currentDetail.oldValueDisplay }}</pre>
      </el-descriptions-item>
      <el-descriptions-item label="異動後的值" :span="2">
        <pre style="white-space: pre-wrap; word-break: break-all;">{{ currentDetail.newValueDisplay }}</pre>
      </el-descriptions-item>
    </el-descriptions>
  </el-dialog>
  
  <!-- 使用者選擇對話框 -->
  <UserListDialog 
    v-model="userListDialogVisible" 
    @confirm="handleUserSelected"
  />
  
  <!-- 角色選擇對話框 -->
  <RoleListDialog 
    v-model="roleListDialogVisible" 
    @confirm="handleRoleSelected"
  />
</template>
```

#### 4.1.2 腳本邏輯
```typescript
<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { changeLogApi } from '@/api/changeLog'
import UserListDialog from '@/components/UserListDialog.vue'
import RoleListDialog from '@/components/RoleListDialog.vue'

// 表單資料
const queryForm = reactive({
  changeUserId: '',
  roleId: '',
  dateRange: [] as string[]
})

const changeUserName = ref('')
const roleName = ref('')

// 表單驗證規則
const rules = {
  dateRange: [
    { required: true, message: '請選擇日期範圍', trigger: 'change' }
  ]
}

// 查詢結果
const searchResult = ref([])
const totalCount = ref(0)
const pagination = reactive({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
})

// 詳情對話框
const detailDialogVisible = ref(false)
const currentDetail = ref(null)

// 選擇對話框
const userListDialogVisible = ref(false)
const roleListDialogVisible = ref(false)
const currentUserType = ref('')

// 查詢
const handleSearch = async () => {
  if (!queryForm.dateRange || queryForm.dateRange.length !== 2) {
    ElMessage.warning('請選擇日期範圍')
    return
  }
  
  try {
    const response = await changeLogApi.searchRoleChangeLogs({
      changeUserId: queryForm.changeUserId || undefined,
      roleId: queryForm.roleId || undefined,
      beginDate: queryForm.dateRange[0],
      endDate: queryForm.dateRange[1],
      pageIndex: pagination.pageIndex,
      pageSize: pagination.pageSize
    })
    
    if (response.success) {
      searchResult.value = response.data.items
      pagination.totalCount = response.data.totalCount
      totalCount.value = response.data.totalCount
    } else {
      ElMessage.error(response.message || '查詢失敗')
    }
  } catch (error) {
    ElMessage.error('查詢失敗：' + error.message)
  }
}

// 重置
const handleReset = () => {
  queryForm.changeUserId = ''
  queryForm.roleId = ''
  queryForm.dateRange = []
  changeUserName.value = ''
  roleName.value = ''
  searchResult.value = []
  pagination.pageIndex = 1
  pagination.totalCount = 0
  totalCount.value = 0
}

// 查看詳情
const viewDetail = async (row: any) => {
  try {
    const response = await changeLogApi.getChangeLogDetail(row.logId)
    if (response.success) {
      currentDetail.value = response.data
      detailDialogVisible.value = true
    } else {
      ElMessage.error(response.message || '查詢詳情失敗')
    }
  } catch (error) {
    ElMessage.error('查詢詳情失敗：' + error.message)
  }
}

// 開啟使用者選擇對話框
const openUserListDialog = (type: string) => {
  currentUserType.value = type
  userListDialogVisible.value = true
}

// 使用者選擇確認
const handleUserSelected = (user: any) => {
  if (currentUserType.value === 'changeUser') {
    queryForm.changeUserId = user.userId
    changeUserName.value = user.userName
  }
}

// 開啟角色選擇對話框
const openRoleListDialog = () => {
  roleListDialogVisible.value = true
}

// 角色選擇確認
const handleRoleSelected = (role: any) => {
  queryForm.roleId = role.roleId
  roleName.value = role.roleName
}

// 狀態標籤類型
const getStatusTagType = (status: string) => {
  switch (status) {
    case '1': return 'success' // 新增
    case '2': return 'danger'  // 刪除
    case '3': return 'warning' // 修改
    default: return 'info'
  }
}

// 分頁變更
const handleSizeChange = (size: number) => {
  pagination.pageSize = size
  pagination.pageIndex = 1
  handleSearch()
}

const handlePageChange = (page: number) => {
  pagination.pageIndex = page
  handleSearch()
}

// 初始化
onMounted(() => {
  const today = new Date()
  const oneYearAgo = new Date(today.getFullYear() - 1, today.getMonth(), today.getDate())
  queryForm.dateRange = [
    oneYearAgo.toISOString().split('T')[0],
    today.toISOString().split('T')[0]
  ]
})
</script>
```

---

## 五、後端實作

### 5.1 Controller (`ChangeLogController.cs`)

```csharp
[ApiController]
[Route("api/v1/change-logs")]
[Authorize]
public class ChangeLogController : ControllerBase
{
    private readonly IChangeLogService _changeLogService;
    private readonly ILogger<ChangeLogController> _logger;

    public ChangeLogController(
        IChangeLogService changeLogService,
        ILogger<ChangeLogController> logger)
    {
        _changeLogService = changeLogService;
        _logger = logger;
    }

    /// <summary>
    /// 查詢角色異動記錄
    /// </summary>
    [HttpPost("roles/search")]
    public async Task<ActionResult<ApiResponse<PagedResult<RoleChangeLogDto>>>> SearchRoleChangeLogs(
        [FromBody] RoleChangeLogQueryDto query)
    {
        try
        {
            var result = await _changeLogService.SearchRoleChangeLogsAsync(query);
            return Ok(ApiResponse<PagedResult<RoleChangeLogDto>>.Success(result));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "查詢角色異動記錄失敗");
            return BadRequest(ApiResponse<PagedResult<RoleChangeLogDto>>.Error("查詢失敗：" + ex.Message));
        }
    }

    /// <summary>
    /// 查詢單筆異動記錄詳情
    /// </summary>
    [HttpGet("{logId}")]
    public async Task<ActionResult<ApiResponse<ChangeLogDetailDto>>> GetChangeLogDetail(long logId)
    {
        try
        {
            var result = await _changeLogService.GetChangeLogDetailAsync(logId);
            if (result == null)
            {
                return NotFound(ApiResponse<ChangeLogDetailDto>.Error("找不到異動記錄"));
            }
            return Ok(ApiResponse<ChangeLogDetailDto>.Success(result));
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "查詢異動記錄詳情失敗");
            return BadRequest(ApiResponse<ChangeLogDetailDto>.Error("查詢失敗：" + ex.Message));
        }
    }
}
```

### 5.2 Service (`ChangeLogService.cs`)

```csharp
public class ChangeLogService : IChangeLogService
{
    private readonly IDbConnection _db;
    private readonly ILogger<ChangeLogService> _logger;

    public ChangeLogService(
        IDbConnection db,
        ILogger<ChangeLogService> logger)
    {
        _db = db;
        _logger = logger;
    }

    public async Task<PagedResult<RoleChangeLogDto>> SearchRoleChangeLogsAsync(RoleChangeLogQueryDto query)
    {
        var sql = @"
            SELECT 
                cl.LogId,
                cl.ProgramId,
                cl.ChangeUserId,
                u.UserName AS ChangeUserName,
                cl.ChangeDate,
                cl.ChangeStatus,
                CASE cl.ChangeStatus
                    WHEN '1' THEN '新增'
                    WHEN '2' THEN '刪除'
                    WHEN '3' THEN '修改'
                    ELSE ''
                END AS ChangeStatusName,
                cl.ChangeField AS ChangeFieldDisplay,
                cl.OldValue AS OldValueDisplay,
                cl.NewValue AS NewValueDisplay
            FROM ChangeLogs cl
            LEFT JOIN Users u ON cl.ChangeUserId = u.UserId
            WHERE cl.ProgramId = 'SYS0210'
                AND (@ChangeUserId IS NULL OR cl.ChangeUserId = @ChangeUserId)
                AND (@RoleId IS NULL OR cl.OldValue LIKE '%' + @RoleId + '%' OR cl.NewValue LIKE '%' + @RoleId + '%')
                AND cl.ChangeDate >= @BeginDate
                AND cl.ChangeDate < DATEADD(DAY, 1, @EndDate)
                AND (cl.OldValue != cl.NewValue OR cl.OldValue IS NULL OR cl.NewValue IS NULL)
            ORDER BY cl.ChangeDate DESC, cl.ChangeUserId
            OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
            
            SELECT COUNT(*) AS TotalCount
            FROM ChangeLogs cl
            WHERE cl.ProgramId = 'SYS0210'
                AND (@ChangeUserId IS NULL OR cl.ChangeUserId = @ChangeUserId)
                AND (@RoleId IS NULL OR cl.OldValue LIKE '%' + @RoleId + '%' OR cl.NewValue LIKE '%' + @RoleId + '%')
                AND cl.ChangeDate >= @BeginDate
                AND cl.ChangeDate < DATEADD(DAY, 1, @EndDate)
                AND (cl.OldValue != cl.NewValue OR cl.OldValue IS NULL OR cl.NewValue IS NULL);
        ";

        var parameters = new
        {
            ChangeUserId = string.IsNullOrEmpty(query.ChangeUserId) ? (string?)null : query.ChangeUserId,
            RoleId = string.IsNullOrEmpty(query.RoleId) ? (string?)null : query.RoleId,
            BeginDate = DateTime.Parse(query.BeginDate),
            EndDate = DateTime.Parse(query.EndDate),
            Offset = (query.PageIndex - 1) * query.PageSize,
            PageSize = query.PageSize
        };

        using var multi = await _db.QueryMultipleAsync(sql, parameters);
        var items = (await multi.ReadAsync<RoleChangeLogDto>()).ToList();
        var totalCount = await multi.ReadSingleAsync<int>();

        // 解析異動欄位和值
        foreach (var item in items)
        {
            if (!string.IsNullOrEmpty(item.ChangeFieldDisplay))
            {
                item.ChangeFields = item.ChangeFieldDisplay.Split(',').Select(s => s.Trim()).ToArray();
            }
            if (!string.IsNullOrEmpty(item.OldValueDisplay))
            {
                item.OldValues = item.OldValueDisplay.Split(',').Select(s => s.Trim()).ToArray();
            }
            if (!string.IsNullOrEmpty(item.NewValueDisplay))
            {
                item.NewValues = item.NewValueDisplay.Split(',').Select(s => s.Trim()).ToArray();
            }
        }

        return new PagedResult<RoleChangeLogDto>
        {
            Items = items,
            TotalCount = totalCount,
            PageIndex = query.PageIndex,
            PageSize = query.PageSize,
            TotalPages = (int)Math.Ceiling(totalCount / (double)query.PageSize)
        };
    }

    public async Task<ChangeLogDetailDto> GetChangeLogDetailAsync(long logId)
    {
        var sql = @"
            SELECT 
                cl.LogId,
                cl.ProgramId,
                cl.ChangeUserId,
                u.UserName AS ChangeUserName,
                cl.ChangeDate,
                cl.ChangeStatus,
                CASE cl.ChangeStatus
                    WHEN '1' THEN '新增'
                    WHEN '2' THEN '刪除'
                    WHEN '3' THEN '修改'
                    ELSE ''
                END AS ChangeStatusName,
                cl.ChangeField AS ChangeFieldDisplay,
                cl.OldValue AS OldValueDisplay,
                cl.NewValue AS NewValueDisplay
            FROM ChangeLogs cl
            LEFT JOIN Users u ON cl.ChangeUserId = u.UserId
            WHERE cl.LogId = @LogId;
        ";

        var result = await _db.QueryFirstOrDefaultAsync<ChangeLogDetailDto>(sql, new { LogId = logId });
        
        if (result != null)
        {
            // 解析異動欄位和值
            if (!string.IsNullOrEmpty(result.ChangeFieldDisplay))
            {
                result.ChangeFields = result.ChangeFieldDisplay.Split(',').Select(s => s.Trim()).ToArray();
            }
            if (!string.IsNullOrEmpty(result.OldValueDisplay))
            {
                result.OldValues = result.OldValueDisplay.Split(',').Select(s => s.Trim()).ToArray();
            }
            if (!string.IsNullOrEmpty(result.NewValueDisplay))
            {
                result.NewValues = result.NewValueDisplay.Split(',').Select(s => s.Trim()).ToArray();
            }
        }

        return result;
    }
}
```

### 5.3 DTO 定義

```csharp
// 查詢條件 DTO
public class RoleChangeLogQueryDto
{
    public string? ChangeUserId { get; set; }
    public string? RoleId { get; set; }
    public string BeginDate { get; set; }
    public string EndDate { get; set; }
    public int PageIndex { get; set; } = 1;
    public int PageSize { get; set; } = 20;
}

// 角色異動記錄 DTO
public class RoleChangeLogDto
{
    public long LogId { get; set; }
    public string ProgramId { get; set; }
    public string ChangeUserId { get; set; }
    public string ChangeUserName { get; set; }
    public DateTime ChangeDate { get; set; }
    public string ChangeStatus { get; set; }
    public string ChangeStatusName { get; set; }
    public string ChangeFieldDisplay { get; set; }
    public string[] ChangeFields { get; set; }
    public string OldValueDisplay { get; set; }
    public string[] OldValues { get; set; }
    public string NewValueDisplay { get; set; }
    public string[] NewValues { get; set; }
}

// 異動記錄詳情 DTO
public class ChangeLogDetailDto
{
    public long LogId { get; set; }
    public string ProgramId { get; set; }
    public string ChangeUserId { get; set; }
    public string ChangeUserName { get; set; }
    public DateTime ChangeDate { get; set; }
    public string ChangeStatus { get; set; }
    public string ChangeStatusName { get; set; }
    public string ChangeFieldDisplay { get; set; }
    public string[] ChangeFields { get; set; }
    public string OldValueDisplay { get; set; }
    public string[] OldValues { get; set; }
    public string NewValueDisplay { get; set; }
    public string[] NewValues { get; set; }
}
```

---

## 六、開發時程

### 6.1 開發階段
1. **資料庫設計** (0.5 天)
   - 確認 ChangeLogs 資料表結構
   - 建立索引

2. **後端 API 開發** (1 天)
   - 實作 Service 層
   - 實作 Controller 層
   - 單元測試

3. **前端 UI 開發** (1.5 天)
   - 查詢條件頁面
   - 查詢結果列表
   - 詳情對話框
   - 整合測試

4. **測試與優化** (0.5 天)
   - 功能測試
   - 效能測試
   - Bug 修復

**總計**: 3.5 天

---

## 七、注意事項

### 7.1 資料查詢
- 日期範圍查詢需包含結束日期的整天（結束日期 + 1 天）
- 角色代碼搜尋需在 OLD_VALUE 和 NEW_VALUE 中進行模糊搜尋
- 需過濾掉沒有實際異動的記錄（OLD_VALUE = NEW_VALUE）

### 7.2 效能優化
- 使用索引加速查詢（ProgramId, ChangeDate, ChangeUserId）
- 大量資料時使用分頁查詢
- 考慮使用 Redis 快取常用查詢結果

### 7.3 安全性
- 需驗證使用者權限（僅允許查詢有權限的資料）
- 防止 SQL Injection（使用參數化查詢）
- 驗證輸入參數格式

### 7.4 使用者體驗
- 提供清楚的查詢條件說明
- 顯示查詢結果總筆數
- 提供詳情查看功能
- 支援匯出查詢結果（可選）

---

## 八、測試案例

### 8.1 功能測試
1. **查詢測試**
   - 依異動使用者代碼查詢
   - 依角色代碼查詢
   - 依日期範圍查詢
   - 組合條件查詢
   - 無資料時的提示

2. **分頁測試**
   - 切換頁碼
   - 變更每頁筆數
   - 邊界條件測試

3. **詳情查看測試**
   - 查看單筆異動記錄詳情
   - 驗證異動欄位和值的顯示

### 8.2 效能測試
- 大量資料查詢效能（10萬筆以上）
- 分頁查詢效能
- 索引使用情況

### 8.3 安全性測試
- SQL Injection 測試
- 權限驗證測試
- 輸入驗證測試

