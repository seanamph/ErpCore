# SYS0240 - 角色複製 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS0240
- **功能名稱**: 角色複製
- **功能描述**: 將來源角色的權限設定和使用者分配複製到目的角色。複製前會清除目的角色原有的權限和使用者設定
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0240_FC.asp` (角色複製執行)
  - `WEB/IMS_CORE/ASP/SYS0000/SYS0240_FQ.ASP` (角色複製查詢)
  - `IMS3/HANSHIN/IMS3/SYS0000/SYS0240_FC.aspx.cs`
  - `IMS3/HANSHIN/RSL_CLASS/IMS3_SYS/MNG_USER_ROLE.cs` (CopyUserRole 方法)

### 1.2 業務需求
- 複製來源角色的權限設定（MNG_ROLE_BUTTON）到目的角色
- 可選擇是否複製使用者分配（MNG_USER_ROLE）
- 複製前需清除目的角色原有的權限和使用者設定
- 驗證來源和目的角色不能相同
- 驗證來源角色必須存在且有權限設定
- 記錄操作日誌

---

## 二、資料庫設計 (Schema)

### 2.1 相關資料表

#### 2.1.1 `Roles` - 角色基本資料
```sql
-- 參考 SYS0210 開發計劃
```

#### 2.1.2 `RoleButtons` - 角色按鈕權限
```sql
CREATE TABLE [dbo].[RoleButtons] (
    [RoleId] NVARCHAR(50) NOT NULL,
    [SystemId] NVARCHAR(50) NOT NULL,
    [ProgramId] NVARCHAR(50) NOT NULL,
    [PageId] NVARCHAR(50) NULL,
    [ButtonId] NVARCHAR(50) NOT NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [CreatedPriority] INT NULL,
    [CreatedGroup] NVARCHAR(50) NULL,
    CONSTRAINT [PK_RoleButtons] PRIMARY KEY CLUSTERED ([RoleId], [SystemId], [ProgramId], [ButtonId])
);
```

#### 2.1.3 `UserRoles` - 使用者角色對應
```sql
-- 參考 SYS0230 開發計劃
```

### 2.2 資料字典

| 資料表 | 說明 | 複製內容 |
|--------|------|---------|
| RoleButtons | 角色按鈕權限 | 複製來源角色的所有按鈕權限 |
| UserRoles | 使用者角色對應 | 可選擇是否複製使用者分配 |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 複製角色
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/roles/copy`
- **說明**: 複製來源角色的權限和使用者設定到目的角色
- **請求主體**:
```json
{
  "sourceRoleId": "ROLE001",
  "targetRoleId": "ROLE002",
  "copyUsers": true
}
```
- **回應範例**:
```json
{
  "success": true,
  "message": "角色複製成功",
  "data": {
    "sourceRoleId": "ROLE001",
    "targetRoleId": "ROLE002",
    "permissionsCopied": 50,
    "usersCopied": 10
  }
}
```

#### 3.1.2 驗證角色複製
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/roles/copy/validate`
- **說明**: 驗證角色複製的可行性
- **請求主體**:
```json
{
  "sourceRoleId": "ROLE001",
  "targetRoleId": "ROLE002"
}
```
- **回應範例**:
```json
{
  "success": true,
  "valid": true,
  "message": "可以複製",
  "data": {
    "sourceRoleExists": true,
    "targetRoleExists": true,
    "sourceHasPermissions": true,
    "isSameRole": false
  }
}
```

### 3.2 業務邏輯

#### 3.2.1 複製角色流程
1. 驗證來源角色和目的角色不能相同
2. 驗證來源角色存在
3. 驗證目的角色存在
4. 驗證來源角色有權限設定
5. **清除目的角色的權限設定**（RoleButtons）
6. **複製來源角色的權限設定**到目的角色
7. 如果 `copyUsers = true`：
   - **清除目的角色的使用者分配**（UserRoles）
   - **複製來源角色的使用者分配**到目的角色
8. 清除相關快取
9. 記錄操作日誌

#### 3.2.2 複製權限邏輯
```csharp
// 1. 清除目的角色權限
DELETE FROM RoleButtons WHERE RoleId = @targetRoleId

// 2. 複製來源角色權限
INSERT INTO RoleButtons (RoleId, SystemId, ProgramId, PageId, ButtonId, CreatedBy, CreatedAt, CreatedPriority, CreatedGroup)
SELECT @targetRoleId, SystemId, ProgramId, PageId, ButtonId, @currentUser, GETDATE(), @priority, @group
FROM RoleButtons
WHERE RoleId = @sourceRoleId
```

#### 3.2.3 複製使用者分配邏輯
```csharp
// 1. 清除目的角色使用者
DELETE FROM UserRoles WHERE RoleId = @targetRoleId

// 2. 複製來源角色使用者
INSERT INTO UserRoles (UserId, RoleId, CreatedBy, CreatedAt, CreatedPriority, CreatedGroup)
SELECT UserId, @targetRoleId, @currentUser, GETDATE(), @priority, @group
FROM UserRoles
WHERE RoleId = @sourceRoleId
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 角色複製頁面 (`SYS0240_FQ.vue`)
- **功能**: 選擇來源和目的角色，執行複製
- **元件**: 
  - 來源角色選擇（支援 LOV）
  - 目的角色選擇（支援 LOV）
  - 複製選項（是否複製使用者）
  - 確認對話框
  - 執行按鈕

### 4.2 UI 元件設計

#### 4.2.1 角色選擇表單
```vue
<template>
  <el-form :model="copyForm" :rules="rules" ref="copyFormRef">
    <el-form-item label="來源角色代碼" prop="sourceRoleId">
      <el-input 
        v-model="copyForm.sourceRoleId" 
        placeholder="請選擇來源角色"
        readonly
      >
        <template #append>
          <el-button @click="showRoleLOV('source')">選擇</el-button>
        </template>
      </el-input>
      <span v-if="sourceRoleName" class="role-name">{{ sourceRoleName }}</span>
    </el-form-item>
    
    <el-form-item label="目的角色代碼" prop="targetRoleId">
      <el-input 
        v-model="copyForm.targetRoleId" 
        placeholder="請選擇目的角色"
        readonly
      >
        <template #append>
          <el-button @click="showRoleLOV('target')">選擇</el-button>
        </template>
      </el-input>
      <span v-if="targetRoleName" class="role-name">{{ targetRoleName }}</span>
    </el-form-item>
    
    <el-form-item label="複製選項">
      <el-checkbox v-model="copyForm.copyUsers">同時複製使用者分配</el-checkbox>
    </el-form-item>
    
    <el-form-item>
      <el-button type="primary" @click="handleValidate">驗證</el-button>
      <el-button type="danger" @click="handleCopy" :loading="copying">執行複製</el-button>
      <el-button @click="handleReset">重置</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 確認對話框
```vue
<template>
  <el-dialog
    v-model="confirmVisible"
    title="確認複製"
    width="500px"
  >
    <div class="confirm-content">
      <el-alert
        type="warning"
        :closable="false"
        show-icon
      >
        <template #title>
          <div>
            <p>複製角色會將目的角色原有的權限和使用者設定清除！</p>
            <p>來源角色：{{ sourceRoleName }}</p>
            <p>目的角色：{{ targetRoleName }}</p>
            <p v-if="copyForm.copyUsers">將同時複製使用者分配</p>
          </div>
        </template>
      </el-alert>
    </div>
    <template #footer>
      <el-button @click="confirmVisible = false">取消</el-button>
      <el-button type="danger" @click="executeCopy">確認複製</el-button>
    </template>
  </el-dialog>
</template>
```

### 4.3 操作流程

1. **選擇來源角色**: 使用 LOV 選擇要複製的來源角色
2. **選擇目的角色**: 使用 LOV 選擇要複製到的目的角色
3. **選擇複製選項**: 決定是否同時複製使用者分配
4. **驗證**: 點擊「驗證」按鈕，檢查是否可以複製
5. **確認**: 點擊「執行複製」按鈕，顯示確認對話框
6. **執行**: 確認後執行複製操作
7. **結果**: 顯示複製結果（成功筆數、失敗原因等）

---

## 五、功能詳細設計

### 5.1 複製功能

#### 5.1.1 業務邏輯
- 驗證來源和目的角色不能相同
- 驗證來源角色存在且有權限設定
- 驗證目的角色存在
- 在交易中執行：
  1. 清除目的角色權限
  2. 複製來源角色權限
  3. 如果選擇複製使用者：
     - 清除目的角色使用者
     - 複製來源角色使用者
- 記錄操作日誌

#### 5.1.2 API 實作
```csharp
[HttpPost("roles/copy")]
public async Task<IActionResult> CopyRole([FromBody] CopyRoleRequest request)
{
    // 1. 驗證
    if (request.SourceRoleId == request.TargetRoleId)
    {
        return BadRequest(new { success = false, message = "來源角色和目的角色不能相同" });
    }
    
    var sourceRole = await _roleRepository.GetByIdAsync(request.SourceRoleId);
    if (sourceRole == null)
    {
        return NotFound(new { success = false, message = "來源角色不存在" });
    }
    
    var targetRole = await _roleRepository.GetByIdAsync(request.TargetRoleId);
    if (targetRole == null)
    {
        return NotFound(new { success = false, message = "目的角色不存在" });
    }
    
    // 2. 檢查來源角色是否有權限
    var sourcePermissions = await _roleButtonRepository.GetByRoleIdAsync(request.SourceRoleId);
    if (!sourcePermissions.Any())
    {
        return BadRequest(new { success = false, message = "來源角色沒有權限設定" });
    }
    
    // 3. 執行複製（在交易中）
    using var transaction = await _connection.BeginTransactionAsync();
    try
    {
        // 清除目的角色權限
        await _roleButtonRepository.DeleteByRoleIdAsync(request.TargetRoleId, transaction);
        
        // 複製權限
        var permissionsCopied = await _roleButtonRepository.CopyFromRoleAsync(
            request.SourceRoleId, 
            request.TargetRoleId, 
            User.Identity.Name,
            transaction
        );
        
        int usersCopied = 0;
        if (request.CopyUsers)
        {
            // 清除目的角色使用者
            await _userRoleRepository.DeleteByRoleIdAsync(request.TargetRoleId, transaction);
            
            // 複製使用者
            usersCopied = await _userRoleRepository.CopyFromRoleAsync(
                request.SourceRoleId,
                request.TargetRoleId,
                User.Identity.Name,
                transaction
            );
        }
        
        await transaction.CommitAsync();
        
        // 清除快取
        await _cacheService.RemoveAsync($"role_permissions_{request.TargetRoleId}");
        
        return Ok(new
        {
            success = true,
            message = "角色複製成功",
            data = new
            {
                sourceRoleId = request.SourceRoleId,
                targetRoleId = request.TargetRoleId,
                permissionsCopied,
                usersCopied
            }
        });
    }
    catch (Exception ex)
    {
        await transaction.RollbackAsync();
        _logger.LogError(ex, "複製角色失敗");
        return StatusCode(500, new { success = false, message = "複製失敗，請稍後再試" });
    }
}
```

### 5.2 驗證功能

#### 5.2.1 業務邏輯
- 檢查來源和目的角色是否相同
- 檢查來源角色是否存在
- 檢查目的角色是否存在
- 檢查來源角色是否有權限設定

#### 5.2.2 API 實作
```csharp
[HttpPost("roles/copy/validate")]
public async Task<IActionResult> ValidateCopy([FromBody] ValidateCopyRequest request)
{
    var result = new ValidateCopyResult();
    
    // 檢查是否相同
    if (request.SourceRoleId == request.TargetRoleId)
    {
        return Ok(new
        {
            success = false,
            valid = false,
            message = "來源角色和目的角色不能相同",
            data = result
        });
    }
    
    // 檢查來源角色
    var sourceRole = await _roleRepository.GetByIdAsync(request.SourceRoleId);
    result.SourceRoleExists = sourceRole != null;
    
    // 檢查目的角色
    var targetRole = await _roleRepository.GetByIdAsync(request.TargetRoleId);
    result.TargetRoleExists = targetRole != null;
    
    // 檢查來源角色權限
    if (result.SourceRoleExists)
    {
        var permissions = await _roleButtonRepository.GetByRoleIdAsync(request.SourceRoleId);
        result.SourceHasPermissions = permissions.Any();
    }
    
    result.IsSameRole = false;
    
    var isValid = result.SourceRoleExists 
                  && result.TargetRoleExists 
                  && result.SourceHasPermissions;
    
    return Ok(new
    {
        success = true,
        valid = isValid,
        message = isValid ? "可以複製" : "無法複製，請檢查角色設定",
        data = result
    });
}
```

---

## 六、資料存取層設計

### 6.1 Repository 介面擴充

```csharp
public interface IRoleButtonRepository
{
    Task<IEnumerable<RoleButton>> GetByRoleIdAsync(string roleId);
    Task DeleteByRoleIdAsync(string roleId, IDbTransaction transaction = null);
    Task<int> CopyFromRoleAsync(string sourceRoleId, string targetRoleId, string createdBy, IDbTransaction transaction = null);
}

public interface IUserRoleRepository
{
    Task DeleteByRoleIdAsync(string roleId, IDbTransaction transaction = null);
    Task<int> CopyFromRoleAsync(string sourceRoleId, string targetRoleId, string createdBy, IDbTransaction transaction = null);
}
```

### 6.2 Dapper 實作

```csharp
public class RoleButtonRepository : IRoleButtonRepository
{
    private readonly IDbConnection _connection;
    
    public async Task<int> CopyFromRoleAsync(string sourceRoleId, string targetRoleId, string createdBy, IDbTransaction transaction = null)
    {
        const string sql = @"
            INSERT INTO RoleButtons (RoleId, SystemId, ProgramId, PageId, ButtonId, CreatedBy, CreatedAt, CreatedPriority, CreatedGroup)
            SELECT @TargetRoleId, SystemId, ProgramId, PageId, ButtonId, @CreatedBy, GETDATE(), 
                   (SELECT CreatedPriority FROM Users WHERE UserId = @CreatedBy),
                   (SELECT CreatedGroup FROM Users WHERE UserId = @CreatedBy)
            FROM RoleButtons
            WHERE RoleId = @SourceRoleId";
        
        var parameters = new
        {
            SourceRoleId = sourceRoleId,
            TargetRoleId = targetRoleId,
            CreatedBy = createdBy
        };
        
        return await _connection.ExecuteAsync(sql, parameters, transaction);
    }
    
    public async Task DeleteByRoleIdAsync(string roleId, IDbTransaction transaction = null)
    {
        const string sql = "DELETE FROM RoleButtons WHERE RoleId = @RoleId";
        await _connection.ExecuteAsync(sql, new { RoleId = roleId }, transaction);
    }
}

public class UserRoleRepository : IUserRoleRepository
{
    private readonly IDbConnection _connection;
    
    public async Task<int> CopyFromRoleAsync(string sourceRoleId, string targetRoleId, string createdBy, IDbTransaction transaction = null)
    {
        const string sql = @"
            INSERT INTO UserRoles (UserId, RoleId, CreatedBy, CreatedAt, CreatedPriority, CreatedGroup)
            SELECT UserId, @TargetRoleId, @CreatedBy, GETDATE(),
                   (SELECT CreatedPriority FROM Users WHERE UserId = @CreatedBy),
                   (SELECT CreatedGroup FROM Users WHERE UserId = @CreatedBy)
            FROM UserRoles
            WHERE RoleId = @SourceRoleId";
        
        var parameters = new
        {
            SourceRoleId = sourceRoleId,
            TargetRoleId = targetRoleId,
            CreatedBy = createdBy
        };
        
        return await _connection.ExecuteAsync(sql, parameters, transaction);
    }
    
    public async Task DeleteByRoleIdAsync(string roleId, IDbTransaction transaction = null)
    {
        const string sql = "DELETE FROM UserRoles WHERE RoleId = @RoleId";
        await _connection.ExecuteAsync(sql, new { RoleId = roleId }, transaction);
    }
}
```

---

## 七、錯誤處理

### 7.1 錯誤碼定義

| 錯誤碼 | 說明 | HTTP 狀態碼 |
|--------|------|------------|
| ROLE_COPY_001 | 來源角色和目的角色不能相同 | 400 |
| ROLE_COPY_002 | 來源角色不存在 | 404 |
| ROLE_COPY_003 | 目的角色不存在 | 404 |
| ROLE_COPY_004 | 來源角色沒有權限設定 | 400 |
| ROLE_COPY_005 | 複製失敗 | 500 |

### 7.2 錯誤處理範例

```csharp
try
{
    await CopyRoleAsync(request);
}
catch (SqlException ex)
{
    _logger.LogError(ex, "複製角色時發生資料庫錯誤");
    return StatusCode(500, new
    {
        success = false,
        errorCode = "ROLE_COPY_005",
        message = "複製失敗，請稍後再試"
    });
}
```

---

## 八、測試計劃

### 8.1 單元測試
- Repository 層的複製操作
- 業務邏輯層的驗證邏輯
- 交易處理測試

### 8.2 整合測試
- API 端點的功能測試
- 資料庫交易測試
- 權限複製的完整性測試

### 8.3 前端測試
- 角色選擇功能
- 確認對話框
- 複製結果顯示

---

## 九、注意事項

1. **交易處理**: 複製操作必須在資料庫交易中執行，確保資料一致性
2. **清除目的角色**: 複製前必須清除目的角色原有的權限和使用者設定
3. **快取清除**: 複製完成後需清除相關的權限快取
4. **操作日誌**: 所有複製操作都應記錄日誌，包含操作者、時間、複製內容
5. **效能考量**: 大量權限和使用者時，應使用批量 SQL 語句
6. **確認機制**: 複製前必須顯示確認對話框，提醒使用者會清除目的角色的設定
7. **可選複製**: 使用者分配可選擇是否複製，但權限必須複製

---

## 十、開發時程

- **資料庫設計**: 0.5 天
- **後端 API 開發**: 2 天
- **前端 UI 開發**: 1.5 天
- **測試**: 1 天
- **文件撰寫**: 0.5 天
- **總計**: 5.5 天

