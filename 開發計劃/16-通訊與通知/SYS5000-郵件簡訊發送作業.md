# SYS5000 - 郵件簡訊發送作業 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS5000
- **功能名稱**: 郵件簡訊發送作業
- **功能描述**: 提供系統郵件和簡訊發送功能，支援SMTP郵件發送、簡訊發送、自動處理郵件、資料編碼等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYS5000/SendSMSMail.aspx`
  - `WEB/IMS_CORE/ASP/SYS5000/js/project.js`
  - `WEB/IMS_CORE/ASP/SYSH000_NEW/Mail_Service.asp`
  - `WEB/IMS_CORE/ASP/SYS2000/AUTOMAIL/Mail_Service.asp`

### 1.2 業務需求
- 支援SMTP郵件發送
- 支援簡訊發送
- 支援郵件自動處理
- 支援資料編碼處理
- 支援郵件模板管理
- 支援郵件發送記錄查詢
- 支援簡訊發送記錄查詢
- 支援郵件附件功能
- 支援郵件優先權設定
- 支援郵件回條功能

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `EmailLogs` (郵件發送記錄)

```sql
CREATE TABLE [dbo].[EmailLogs] (
    [Id] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [FromAddress] NVARCHAR(255) NOT NULL, -- 寄件者地址
    [FromName] NVARCHAR(100) NULL, -- 寄件者名稱
    [ToAddress] NVARCHAR(MAX) NOT NULL, -- 收件者地址（可多個，逗號分隔）
    [CcAddress] NVARCHAR(MAX) NULL, -- 副本地址
    [BccAddress] NVARCHAR(MAX) NULL, -- 密件副本地址
    [Subject] NVARCHAR(500) NOT NULL, -- 郵件主旨
    [Body] NVARCHAR(MAX) NULL, -- 郵件內容
    [BodyType] NVARCHAR(20) NULL DEFAULT 'Text', -- 內容類型 (Text/HTML)
    [Priority] INT NULL DEFAULT 3, -- 優先權 (1-5)
    [Status] NVARCHAR(20) NOT NULL DEFAULT 'Pending', -- 狀態 (Pending/Sent/Failed)
    [ErrorMessage] NVARCHAR(MAX) NULL, -- 錯誤訊息
    [SentAt] DATETIME2 NULL, -- 發送時間
    [CreatedBy] NVARCHAR(50) NULL, -- 建立者
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 建立時間
    [SmtpServer] NVARCHAR(255) NULL, -- SMTP伺服器
    [SmtpPort] INT NULL, -- SMTP埠號
    [HasAttachment] BIT NOT NULL DEFAULT 0, -- 是否有附件
    [AttachmentCount] INT NULL DEFAULT 0 -- 附件數量
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_EmailLogs_Status] ON [dbo].[EmailLogs] ([Status]);
CREATE NONCLUSTERED INDEX [IX_EmailLogs_CreatedAt] ON [dbo].[EmailLogs] ([CreatedAt]);
CREATE NONCLUSTERED INDEX [IX_EmailLogs_FromAddress] ON [dbo].[EmailLogs] ([FromAddress]);
```

### 2.2 主要資料表: `EmailAttachments` (郵件附件)

```sql
CREATE TABLE [dbo].[EmailAttachments] (
    [Id] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [EmailLogId] BIGINT NOT NULL, -- 郵件記錄ID
    [FileName] NVARCHAR(255) NOT NULL, -- 檔案名稱
    [FilePath] NVARCHAR(500) NOT NULL, -- 檔案路徑
    [FileSize] BIGINT NULL, -- 檔案大小（位元組）
    [ContentType] NVARCHAR(100) NULL, -- 內容類型
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_EmailAttachments_EmailLogs] FOREIGN KEY ([EmailLogId]) REFERENCES [dbo].[EmailLogs] ([Id]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_EmailAttachments_EmailLogId] ON [dbo].[EmailAttachments] ([EmailLogId]);
```

### 2.3 主要資料表: `SmsLogs` (簡訊發送記錄)

```sql
CREATE TABLE [dbo].[SmsLogs] (
    [Id] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [PhoneNumber] NVARCHAR(20) NOT NULL, -- 手機號碼
    [Message] NVARCHAR(500) NOT NULL, -- 簡訊內容
    [Status] NVARCHAR(20) NOT NULL DEFAULT 'Pending', -- 狀態 (Pending/Sent/Failed)
    [ErrorMessage] NVARCHAR(MAX) NULL, -- 錯誤訊息
    [SentAt] DATETIME2 NULL, -- 發送時間
    [CreatedBy] NVARCHAR(50) NULL, -- 建立者
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 建立時間
    [Provider] NVARCHAR(50) NULL, -- 簡訊服務提供商
    [ProviderMessageId] NVARCHAR(100) NULL -- 服務商訊息ID
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_SmsLogs_Status] ON [dbo].[SmsLogs] ([Status]);
CREATE NONCLUSTERED INDEX [IX_SmsLogs_CreatedAt] ON [dbo].[SmsLogs] ([CreatedAt]);
CREATE NONCLUSTERED INDEX [IX_SmsLogs_PhoneNumber] ON [dbo].[SmsLogs] ([PhoneNumber]);
```

### 2.4 主要資料表: `NotificationTemplates` (通知模板)

```sql
CREATE TABLE [dbo].[NotificationTemplates] (
    [Id] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [TemplateCode] NVARCHAR(50) NOT NULL, -- 模板代碼
    [TemplateName] NVARCHAR(100) NOT NULL, -- 模板名稱
    [TemplateType] NVARCHAR(20) NOT NULL, -- 模板類型 (Email/SMS)
    [Subject] NVARCHAR(500) NULL, -- 主旨（Email用）
    [Body] NVARCHAR(MAX) NOT NULL, -- 內容
    [BodyType] NVARCHAR(20) NULL DEFAULT 'Text', -- 內容類型
    [Parameters] NVARCHAR(MAX) NULL, -- 參數說明（JSON格式）
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1', -- 狀態 (1:啟用, 0:停用)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [UQ_NotificationTemplates_TemplateCode] UNIQUE ([TemplateCode])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_NotificationTemplates_TemplateCode] ON [dbo].[NotificationTemplates] ([TemplateCode]);
CREATE NONCLUSTERED INDEX [IX_NotificationTemplates_TemplateType] ON [dbo].[NotificationTemplates] ([TemplateType]);
```

### 2.5 資料字典

#### EmailLogs 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| Id | BIGINT | - | NO | IDENTITY(1,1) | 主鍵 | 自動遞增 |
| FromAddress | NVARCHAR | 255 | NO | - | 寄件者地址 | - |
| FromName | NVARCHAR | 100 | YES | - | 寄件者名稱 | - |
| ToAddress | NVARCHAR(MAX) | - | NO | - | 收件者地址 | 可多個，逗號分隔 |
| CcAddress | NVARCHAR(MAX) | - | YES | - | 副本地址 | - |
| BccAddress | NVARCHAR(MAX) | - | YES | - | 密件副本地址 | - |
| Subject | NVARCHAR | 500 | NO | - | 郵件主旨 | - |
| Body | NVARCHAR(MAX) | - | YES | - | 郵件內容 | - |
| BodyType | NVARCHAR | 20 | YES | 'Text' | 內容類型 | Text/HTML |
| Priority | INT | - | YES | 3 | 優先權 | 1-5 |
| Status | NVARCHAR | 20 | NO | 'Pending' | 狀態 | Pending/Sent/Failed |
| ErrorMessage | NVARCHAR(MAX) | - | YES | - | 錯誤訊息 | - |
| SentAt | DATETIME2 | - | YES | - | 發送時間 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| SmtpServer | NVARCHAR | 255 | YES | - | SMTP伺服器 | - |
| SmtpPort | INT | - | YES | - | SMTP埠號 | - |
| HasAttachment | BIT | - | NO | 0 | 是否有附件 | - |
| AttachmentCount | INT | - | YES | 0 | 附件數量 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 發送郵件
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/notifications/email/send`
- **說明**: 發送郵件
- **請求格式**:
  ```json
  {
    "fromAddress": "service@example.com",
    "fromName": "系統服務",
    "toAddress": "user@example.com",
    "ccAddress": "cc@example.com",
    "bccAddress": "bcc@example.com",
    "subject": "郵件主旨",
    "body": "郵件內容",
    "bodyType": "HTML",
    "priority": 3,
    "attachments": [
      {
        "fileName": "file.pdf",
        "filePath": "/uploads/file.pdf"
      }
    ]
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "郵件發送成功",
    "data": {
      "emailLogId": 1,
      "status": "Sent",
      "sentAt": "2024-01-01T00:00:00"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 使用模板發送郵件
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/notifications/email/send-template`
- **說明**: 使用模板發送郵件
- **請求格式**:
  ```json
  {
    "templateCode": "AUDIT_MAIL",
    "toAddress": "user@example.com",
    "parameters": {
      "PG_Name": "程式名稱",
      "Item_Name": "項目名稱",
      "CUser": "建立者",
      "AUser": "審核者"
    }
  }
  ```

#### 3.1.3 發送簡訊
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/notifications/sms/send`
- **說明**: 發送簡訊
- **請求格式**:
  ```json
  {
    "phoneNumber": "0912345678",
    "message": "簡訊內容"
  }
  ```

#### 3.1.4 查詢郵件發送記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/notifications/email/logs`
- **說明**: 查詢郵件發送記錄，支援分頁、排序、篩選
- **請求參數**:
  - `pageIndex`: 頁碼
  - `pageSize`: 每頁筆數
  - `fromAddress`: 寄件者地址（篩選）
  - `toAddress`: 收件者地址（篩選）
  - `status`: 狀態（篩選）
  - `startDate`: 開始日期（篩選）
  - `endDate`: 結束日期（篩選）

#### 3.1.5 查詢簡訊發送記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/notifications/sms/logs`
- **說明**: 查詢簡訊發送記錄，支援分頁、排序、篩選

#### 3.1.6 查詢郵件附件
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/notifications/email/{emailLogId}/attachments`
- **說明**: 查詢郵件的附件列表

#### 3.1.7 下載郵件附件
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/notifications/email/attachments/{attachmentId}/download`
- **說明**: 下載郵件附件

### 3.2 後端實作類別

#### 3.2.1 Service: `EmailService.cs`
```csharp
namespace RSL.IMS3.Application.Services.Notification
{
    public interface IEmailService
    {
        Task<EmailLogDto> SendEmailAsync(SendEmailRequest request);
        Task<EmailLogDto> SendEmailWithTemplateAsync(SendEmailTemplateRequest request);
        Task<PagedResult<EmailLogDto>> GetEmailLogsAsync(EmailLogQueryRequest request);
        Task<EmailLogDto> GetEmailLogByIdAsync(long id);
        Task<List<EmailAttachmentDto>> GetEmailAttachmentsAsync(long emailLogId);
    }
    
    public class EmailService : IEmailService
    {
        // 實作郵件發送邏輯
        // 使用 MailKit 或 System.Net.Mail
    }
}
```

#### 3.2.2 Service: `SmsService.cs`
```csharp
namespace RSL.IMS3.Application.Services.Notification
{
    public interface ISmsService
    {
        Task<SmsLogDto> SendSmsAsync(SendSmsRequest request);
        Task<PagedResult<SmsLogDto>> GetSmsLogsAsync(SmsLogQueryRequest request);
        Task<SmsLogDto> GetSmsLogByIdAsync(long id);
    }
    
    public class SmsService : ISmsService
    {
        // 實作簡訊發送邏輯
        // 整合簡訊服務提供商API
    }
}
```

#### 3.2.3 Service: `NotificationTemplateService.cs`
```csharp
namespace RSL.IMS3.Application.Services.Notification
{
    public interface INotificationTemplateService
    {
        Task<NotificationTemplateDto> GetTemplateByCodeAsync(string templateCode);
        Task<string> RenderTemplateAsync(string templateCode, Dictionary<string, object> parameters);
    }
}
```

---

## 四、前端 UI 設計

### 4.1 UI 元件設計

#### 4.1.1 郵件發送頁面 (`EmailSend.vue`)
```vue
<template>
  <div class="email-send">
    <el-form :model="form" :rules="rules" ref="formRef" label-width="120px">
      <el-form-item label="寄件者地址" prop="fromAddress">
        <el-input v-model="form.fromAddress" placeholder="請輸入寄件者地址" />
      </el-form-item>
      <el-form-item label="寄件者名稱" prop="fromName">
        <el-input v-model="form.fromName" placeholder="請輸入寄件者名稱" />
      </el-form-item>
      <el-form-item label="收件者地址" prop="toAddress">
        <el-input v-model="form.toAddress" placeholder="請輸入收件者地址（多個用逗號分隔）" />
      </el-form-item>
      <el-form-item label="副本地址" prop="ccAddress">
        <el-input v-model="form.ccAddress" placeholder="請輸入副本地址（多個用逗號分隔）" />
      </el-form-item>
      <el-form-item label="密件副本" prop="bccAddress">
        <el-input v-model="form.bccAddress" placeholder="請輸入密件副本地址（多個用逗號分隔）" />
      </el-form-item>
      <el-form-item label="主旨" prop="subject">
        <el-input v-model="form.subject" placeholder="請輸入郵件主旨" />
      </el-form-item>
      <el-form-item label="內容類型" prop="bodyType">
        <el-radio-group v-model="form.bodyType">
          <el-radio label="Text">純文字</el-radio>
          <el-radio label="HTML">HTML</el-radio>
        </el-radio-group>
      </el-form-item>
      <el-form-item label="郵件內容" prop="body">
        <el-input 
          v-if="form.bodyType === 'Text'"
          v-model="form.body" 
          type="textarea" 
          :rows="10"
          placeholder="請輸入郵件內容" 
        />
        <div v-else>
          <editor v-model="form.body" />
        </div>
      </el-form-item>
      <el-form-item label="優先權" prop="priority">
        <el-select v-model="form.priority" placeholder="請選擇優先權">
          <el-option label="最高" :value="1" />
          <el-option label="高" :value="2" />
          <el-option label="一般" :value="3" />
          <el-option label="低" :value="4" />
          <el-option label="最低" :value="5" />
        </el-select>
      </el-form-item>
      <el-form-item label="附件">
        <el-upload
          :file-list="fileList"
          :on-change="handleFileChange"
          :on-remove="handleFileRemove"
          multiple
        >
          <el-button type="primary">選擇檔案</el-button>
        </el-upload>
      </el-form-item>
    </el-form>
    <div class="button-group">
      <el-button @click="handleCancel">取消</el-button>
      <el-button type="primary" @click="handleSend" :loading="sending">發送</el-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive } from 'vue';
import { ElMessage } from 'element-plus';
import { sendEmail } from '@/api/notification';

const form = reactive({
  fromAddress: '',
  fromName: '',
  toAddress: '',
  ccAddress: '',
  bccAddress: '',
  subject: '',
  body: '',
  bodyType: 'Text',
  priority: 3,
  attachments: [] as any[]
});

const sending = ref(false);

const handleSend = async () => {
  sending.value = true;
  try {
    await sendEmail(form);
    ElMessage.success('郵件發送成功');
    // 重置表單
  } catch (error) {
    ElMessage.error('郵件發送失敗');
  } finally {
    sending.value = false;
  }
};
</script>
```

#### 4.1.2 郵件發送記錄查詢頁面 (`EmailLogs.vue`)
- 查詢表單（寄件者、收件者、狀態、日期範圍）
- 資料表格（顯示郵件記錄）
- 分頁元件
- 查看詳情對話框
- 附件下載功能

#### 4.1.3 簡訊發送頁面 (`SmsSend.vue`)
- 手機號碼輸入
- 簡訊內容輸入
- 發送按鈕

#### 4.1.4 簡訊發送記錄查詢頁面 (`SmsLogs.vue`)
- 查詢表單（手機號碼、狀態、日期範圍）
- 資料表格（顯示簡訊記錄）
- 分頁元件

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (2天)
- [ ] 建立 EmailLogs 資料表
- [ ] 建立 EmailAttachments 資料表
- [ ] 建立 SmsLogs 資料表
- [ ] 建立 NotificationTemplates 資料表
- [ ] 建立索引
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (8天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] EmailService 實作（使用 MailKit）
- [ ] SmsService 實作（整合簡訊服務提供商）
- [ ] NotificationTemplateService 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 驗證邏輯實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (6天)
- [ ] API 呼叫函數
- [ ] 郵件發送頁面開發
- [ ] 郵件發送記錄查詢頁面開發
- [ ] 簡訊發送頁面開發
- [ ] 簡訊發送記錄查詢頁面開發
- [ ] 附件上傳功能
- [ ] 附件下載功能
- [ ] 表單驗證
- [ ] 元件測試

### 5.4 階段四: 整合測試 (3天)
- [ ] API 整合測試
- [ ] 郵件發送測試（多種情境）
- [ ] 簡訊發送測試
- [ ] 附件功能測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 安全性測試

### 5.5 階段五: 文件與部署 (1天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件
- [ ] SMTP設定文件
- [ ] 簡訊服務設定文件

**總計**: 20天

---

## 六、注意事項

### 6.1 SMTP設定
- 需配置SMTP伺服器位址、埠號、帳號、密碼
- 支援SSL/TLS加密
- 支援認證方式設定
- 需處理SMTP連線失敗的情況

### 6.2 簡訊服務整合
- 需整合簡訊服務提供商API（如：中華電信、遠傳等）
- 需處理API呼叫失敗的情況
- 需記錄服務商回傳的訊息ID

### 6.3 郵件模板
- 支援參數替換（如：{PG_Name}、{Item_Name}等）
- 支援多語言模板
- 模板內容需支援HTML格式

### 6.4 附件處理
- 附件檔案需上傳至伺服器
- 需限制附件大小
- 需限制附件類型
- 附件檔案需定期清理（可選）

### 6.5 安全性
- 郵件內容需防止XSS攻擊
- 附件檔案需進行病毒掃描（可選）
- 需記錄所有發送記錄
- 敏感資訊需加密儲存

### 6.6 效能優化
- 大量郵件發送需使用佇列處理
- 簡訊發送需控制發送頻率
- 需實作重試機制

---

## 七、測試案例

### 7.1 單元測試
- [ ] 發送郵件成功
- [ ] 發送郵件失敗處理
- [ ] 使用模板發送郵件成功
- [ ] 發送簡訊成功
- [ ] 發送簡訊失敗處理
- [ ] 附件上傳成功
- [ ] 附件下載成功

### 7.2 整合測試
- [ ] SMTP連線測試
- [ ] 郵件發送完整流程測試
- [ ] 簡訊發送完整流程測試
- [ ] 模板渲染測試
- [ ] 附件功能測試
- [ ] 錯誤處理測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/SYS5000/SendSMSMail.aspx`
- `WEB/IMS_CORE/ASP/SYS5000/js/project.js`
- `WEB/IMS_CORE/ASP/SYSH000_NEW/Mail_Service.asp`
- `WEB/IMS_CORE/ASP/SYS2000/AUTOMAIL/Mail_Service.asp`

### 8.2 相關技術
- MailKit (郵件發送)
- System.Net.Mail (郵件發送)
- 簡訊服務提供商API

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

