# CUS5120 - 客戶查詢作業 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: CUS5120
- **功能名稱**: 客戶查詢作業
- **功能描述**: 提供客戶資料的查詢功能，支援多條件篩選、進階查詢、匯出Excel等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/CUS5000/SYS5120_FQ.ASP` (查詢)
  - `WEB/IMS_CORE/ASP/CUS5000/SYS5120_FB.ASP` (瀏覽)
  - `WEB/IMS_CORE/ASP/CUS5000/SYS5120_PR.ASP` (報表)

### 1.2 業務需求
- 提供客戶資料的快速查詢功能
- 支援多條件組合查詢
- 支援模糊搜尋（客戶名稱、統一編號、電話等）
- 支援查詢結果匯出Excel
- 支援查詢結果列印
- 支援查詢歷史記錄
- 支援常用查詢條件儲存

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Customers` (共用CUS5110的資料表)

參考: `開發計劃/09-客戶管理/CUS5110-客戶基本資料維護.md` 的資料表設計

### 2.2 相關資料表

#### 2.2.1 `CustomerTransactions` - 客戶交易記錄（用於查詢交易資訊）
```sql
CREATE TABLE [dbo].[CustomerTransactions] (
    [TransactionId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [CustomerId] NVARCHAR(50) NOT NULL,
    [TransactionDate] DATETIME2 NOT NULL,
    [TransactionNo] NVARCHAR(50) NOT NULL,
    [TransactionType] NVARCHAR(20) NULL, -- 交易類型: SALE, RETURN, ADJUST
    [Amount] DECIMAL(18,2) NOT NULL DEFAULT 0,
    [Status] NVARCHAR(10) NULL,
    [Notes] NVARCHAR(500) NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_CustomerTransactions_Customers] FOREIGN KEY ([CustomerId]) REFERENCES [dbo].[Customers] ([CustomerId])
);

CREATE NONCLUSTERED INDEX [IX_CustomerTransactions_CustomerId] ON [dbo].[CustomerTransactions] ([CustomerId]);
CREATE NONCLUSTERED INDEX [IX_CustomerTransactions_TransactionDate] ON [dbo].[CustomerTransactions] ([TransactionDate]);
CREATE NONCLUSTERED INDEX [IX_CustomerTransactions_TransactionNo] ON [dbo].[CustomerTransactions] ([TransactionNo]);
```

#### 2.2.2 `QueryHistory` - 查詢歷史記錄（可選）
```sql
CREATE TABLE [dbo].[QueryHistory] (
    [HistoryId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [UserId] NVARCHAR(50) NOT NULL,
    [ModuleCode] NVARCHAR(50) NOT NULL, -- 模組代碼: CUS5120
    [QueryName] NVARCHAR(100) NULL, -- 查詢名稱
    [QueryConditions] NVARCHAR(MAX) NULL, -- 查詢條件(JSON格式)
    [IsFavorite] BIT NULL DEFAULT 0, -- 是否為常用查詢
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_QueryHistory_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId])
);

CREATE NONCLUSTERED INDEX [IX_QueryHistory_UserId] ON [dbo].[QueryHistory] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_QueryHistory_ModuleCode] ON [dbo].[QueryHistory] ([ModuleCode]);
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢客戶列表（進階查詢）
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/customers/query`
- **說明**: 提供進階查詢功能，支援多條件組合查詢
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "CustomerId",
    "sortOrder": "ASC",
    "filters": {
      "customerId": "",
      "customerName": "",
      "guiId": "",
      "guiType": "",
      "contactStaff": "",
      "compTel": "",
      "cell": "",
      "email": "",
      "city": "",
      "canton": "",
      "salesId": "",
      "status": "",
      "discountYn": "",
      "monthlyYn": "",
      "transDateFrom": "",
      "transDateTo": "",
      "accAmtFrom": "",
      "accAmtTo": ""
    },
    "dateRange": {
      "field": "TransDate",
      "from": "2024-01-01",
      "to": "2024-12-31"
    },
    "amountRange": {
      "field": "AccAmt",
      "from": 0,
      "to": 999999999
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "customerId": "C001",
          "customerName": "測試客戶",
          "guiId": "12345678",
          "guiType": "1",
          "shortName": "測試",
          "contactStaff": "張三",
          "compTel": "02-12345678",
          "cell": "0912345678",
          "email": "test@example.com",
          "city": "台北市",
          "canton": "信義區",
          "status": "A",
          "salesId": "U001",
          "salesName": "業務員A",
          "accAmt": 100000.00,
          "transDate": "2024-01-01T00:00:00",
          "transNo": "T001",
          "monthlyYn": "N",
          "discountYn": "Y"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 快速搜尋客戶
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/customers/search`
- **說明**: 提供快速搜尋功能，支援客戶編號、名稱、統一編號、電話等模糊搜尋
- **請求參數**:
  - `keyword`: 搜尋關鍵字（Query String）
  - `limit`: 回傳筆數限制（預設10）
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "搜尋成功",
    "data": [
      {
        "customerId": "C001",
        "customerName": "測試客戶",
        "guiId": "12345678",
        "shortName": "測試",
        "compTel": "02-12345678",
        "cell": "0912345678"
      }
    ],
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 查詢客戶交易記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/customers/{customerId}/transactions`
- **說明**: 查詢指定客戶的交易記錄
- **路徑參數**:
  - `customerId`: 客戶編號
- **請求參數**:
  - `pageIndex`: 頁碼
  - `pageSize`: 每頁筆數
  - `dateFrom`: 起始日期
  - `dateTo`: 結束日期
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "transactionId": "guid-here",
          "transactionDate": "2024-01-01T00:00:00",
          "transactionNo": "T001",
          "transactionType": "SALE",
          "amount": 10000.00,
          "status": "COMPLETED"
        }
      ],
      "totalCount": 50,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 3
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 匯出Excel
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/customers/export`
- **說明**: 將查詢結果匯出為Excel檔案
- **請求格式**:
  ```json
  {
    "filters": {
      "customerId": "",
      "customerName": "",
      "status": ""
    },
    "columns": ["customerId", "customerName", "guiId", "compTel", "cell", "email", "status"]
  }
  ```
- **回應格式**: 回傳Excel檔案（application/vnd.openxmlformats-officedocument.spreadsheetml.sheet）

#### 3.1.5 儲存查詢條件
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/customers/query-history`
- **說明**: 儲存常用查詢條件
- **請求格式**:
  ```json
  {
    "queryName": "我的常用查詢",
    "queryConditions": {
      "filters": {
        "status": "A",
        "city": "台北市"
      }
    },
    "isFavorite": true
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "儲存成功",
    "data": {
      "historyId": "guid-here",
      "queryName": "我的常用查詢"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.6 取得查詢歷史
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/customers/query-history`
- **說明**: 取得使用者的查詢歷史記錄
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": [
      {
        "historyId": "guid-here",
        "queryName": "我的常用查詢",
        "queryConditions": {},
        "isFavorite": true,
        "createdAt": "2024-01-01T00:00:00"
      }
    ],
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 查詢條件區域
- **客戶編號**: 文字輸入框（支援模糊搜尋）
- **客戶名稱**: 文字輸入框（支援模糊搜尋）
- **統一編號**: 文字輸入框
- **識別類型**: 下拉選單（統一編號/身份證字號/自編編號）
- **聯絡人**: 文字輸入框
- **電話**: 文字輸入框（公司電話/手機）
- **電子郵件**: 文字輸入框
- **城市**: 下拉選單
- **區域**: 下拉選單（依城市動態載入）
- **業務員**: 下拉選單（使用者選擇）
- **狀態**: 下拉選單（啟用/停用）
- **是否享有折扣**: 下拉選單（是/否）
- **是否為月結客戶**: 下拉選單（是/否）
- **最近交易日期**: 日期範圍選擇器（起日/迄日）
- **消費累積金額**: 數值範圍輸入（起值/迄值）
- **進階查詢**: 展開/收合按鈕

#### 4.1.2 查詢結果區域
- **資料表格**: 
  - 欄位: 客戶編號、客戶名稱、統一編號、聯絡人、公司電話、手機、電子郵件、城市、區域、業務員、狀態、最近交易日期、消費累積金額
  - 支援排序（點擊欄位標題）
  - 支援欄位顯示/隱藏設定
  - 支援欄位寬度調整
- **分頁控制**: 
  - 頁碼選擇
  - 每頁筆數選擇（10/20/50/100）
  - 總筆數顯示
- **操作按鈕**:
  - 查詢
  - 重置
  - 匯出Excel
  - 列印
  - 儲存查詢條件
  - 載入查詢條件

#### 4.1.3 快速搜尋區域
- **搜尋框**: 輸入關鍵字後即時搜尋
- **搜尋結果下拉列表**: 顯示符合的客戶（最多10筆）

### 4.2 功能說明

#### 4.2.1 查詢功能
- 支援多條件組合查詢
- 支援模糊搜尋（客戶名稱、統一編號、電話等）
- 支援日期範圍查詢
- 支援數值範圍查詢
- 查詢結果即時顯示

#### 4.2.2 匯出功能
- 支援匯出Excel
- 可選擇匯出欄位
- 支援大量資料匯出（分批處理）

#### 4.2.3 列印功能
- 支援查詢結果列印
- 支援自訂列印格式

#### 4.2.4 查詢歷史功能
- 儲存常用查詢條件
- 快速載入已儲存的查詢條件
- 管理查詢歷史記錄

### 4.3 UI 元件

#### 4.3.1 查詢表單元件
- 使用 Element Plus / Ant Design Vue 的表單元件
- 支援表單驗證
- 支援表單重置

#### 4.3.2 資料表格元件
- 使用 Element Plus / Ant Design Vue 的表格元件
- 支援排序、篩選、分頁
- 支援欄位顯示/隱藏
- 支援欄位寬度調整

#### 4.3.3 日期選擇器
- 使用 Element Plus / Ant Design Vue 的日期選擇器
- 支援日期範圍選擇

#### 4.3.4 下拉選單
- 使用 Element Plus / Ant Design Vue 的下拉選單
- 支援搜尋功能

---

## 五、開發注意事項

### 5.1 效能優化
- 查詢結果使用分頁，避免一次載入過多資料
- 大量資料匯出使用背景處理
- 建立適當的資料庫索引以提升查詢效能

### 5.2 安全性
- 驗證使用者權限
- 防止SQL注入（使用參數化查詢）
- 限制匯出資料量

### 5.3 使用者體驗
- 提供查詢進度提示
- 提供錯誤訊息提示
- 支援鍵盤快捷鍵操作

---

## 六、測試項目

### 6.1 功能測試
- 單一條件查詢
- 多條件組合查詢
- 模糊搜尋
- 日期範圍查詢
- 數值範圍查詢
- 快速搜尋
- 匯出Excel
- 列印功能
- 查詢歷史儲存與載入

### 6.2 效能測試
- 大量資料查詢效能
- 匯出大量資料效能

### 6.3 安全性測試
- 權限驗證
- SQL注入防護

---

## 七、相關功能
- **CUS5110**: 客戶基本資料維護
- **CUS5130**: 客戶報表

