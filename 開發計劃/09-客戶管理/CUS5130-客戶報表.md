# CUS5130 - 客戶報表 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: CUS5130
- **功能名稱**: 客戶報表
- **功能描述**: 提供客戶相關報表的查詢與列印功能，包含客戶基本資料報表、客戶交易報表、客戶統計報表等
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/CUS5000/SYS5130_FB.ASP` (瀏覽)
  - `WEB/IMS_CORE/ASP/CUS5000/SYS5130_FD.ASP` (刪除)
  - 相關報表檔案

### 1.2 業務需求
- 查詢客戶基本資料報表
- 查詢客戶交易記錄報表
- 查詢客戶統計報表
- 支援多條件篩選
- 支援報表列印與匯出功能

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表
- `Customers` - 客戶主檔（參考 CUS5110）
- `CustomerTransactions` - 客戶交易記錄
- `CustomerContacts` - 客戶聯絡人

### 2.2 報表查詢視圖: `V_CUS5130_Report`

```sql
CREATE VIEW [dbo].[V_CUS5130_Report] AS
SELECT 
    c.[CustomerId],
    c.[CustomerName],
    c.[GuiId],
    c.[GuiType],
    c.[ContactStaff],
    c.[CompTel],
    c.[Cell],
    c.[Email],
    c.[City],
    c.[Canton],
    c.[Addr],
    c.[Status],
    c.[TransDate],
    c.[AccAmt],
    c.[MonthlyYn],
    COUNT(ct.[TransactionId]) AS TransactionCount,
    SUM(ct.[Amount]) AS TotalAmount
FROM [dbo].[Customers] c
LEFT JOIN [dbo].[CustomerTransactions] ct ON c.[CustomerId] = ct.[CustomerId]
GROUP BY 
    c.[CustomerId], c.[CustomerName], c.[GuiId], c.[GuiType],
    c.[ContactStaff], c.[CompTel], c.[Cell], c.[Email],
    c.[City], c.[Canton], c.[Addr], c.[Status],
    c.[TransDate], c.[AccAmt], c.[MonthlyYn];
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢客戶報表資料
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/customers/reports/cus5130`
- **說明**: 查詢客戶報表資料，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "CustomerId",
    "sortOrder": "ASC",
    "filters": {
      "customerId": "",
      "customerName": "",
      "guiId": "",
      "status": "",
      "city": "",
      "canton": "",
      "monthlyYn": "",
      "transDateFrom": "",
      "transDateTo": ""
    }
  }
  ```

#### 3.1.2 匯出與列印
- `POST /api/v1/customers/reports/cus5130/export/excel` - 匯出Excel
- `POST /api/v1/customers/reports/cus5130/export/pdf` - 匯出PDF
- `POST /api/v1/customers/reports/cus5130/print` - 列印報表

---

## 四、前端 UI 設計

### 4.1 頁面結構
- 查詢條件區塊：客戶編號、客戶名稱、統一編號、狀態、城市、區域、月結客戶、交易日期範圍
- 報表資料區塊：客戶報表表格
- 統計資訊區塊：總客戶數、總交易金額等

### 4.2 元件設計
- 參考 CUS5110 的元件設計結構

---

## 五、實作細節

### 5.1 後端實作
- Repository: `GetCUS5130ReportAsync()`
- Service: `GetCUS5130ReportAsync()`
- Controller: `GetCUS5130Report()`

### 5.2 前端實作
- API 服務: `getCUS5130Report()`
- 頁面元件: `CUS5130Report.vue`

---

## 六、相關文件
- [CUS5110-客戶基本資料維護](../CUS5110-客戶基本資料維護.md)
- [CUS5120-客戶查詢作業](../CUS5120-客戶查詢作業.md)

