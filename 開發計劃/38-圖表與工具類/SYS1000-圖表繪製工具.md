# SYS1000 - 圖表繪製工具 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS1000
- **功能名稱**: 圖表繪製工具
- **功能描述**: 提供多種圖表繪製功能，包括柱狀圖、折線圖、餅圖等，支援從資料庫查詢資料並生成圖表
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/INCLUDE/SYS1000/Make_Chart.INC`
  - `WEB/IMS_CORE/ASP/INCLUDE/SYS1000/ASP_CHART_DRAW.INC`
  - `WEB/IMS_CORE/ASP/SYS1000/SYS11C0_PR.ASP`

### 1.2 業務需求
- 支援多種圖表類型（柱狀圖、折線圖、餅圖、3D圖表等）
- 支援從資料庫動態查詢資料生成圖表
- 支援圖表參數設定（標題、軸標籤、顏色、字體等）
- 支援圖表匯出功能（PNG、PDF、Excel）
- 支援響應式設計，適配不同螢幕尺寸

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `ChartConfigs`

```sql
CREATE TABLE [dbo].[ChartConfigs] (
    [ChartConfigId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [ChartName] NVARCHAR(100) NOT NULL,
    [ChartType] NVARCHAR(20) NOT NULL, -- BAR, LINE, PIE, COLUMN, AREA, etc.
    [DataSource] NVARCHAR(500) NULL, -- SQL Query or API Endpoint
    [XField] NVARCHAR(100) NULL,
    [YField] NVARCHAR(100) NULL,
    [Title] NVARCHAR(200) NULL,
    [XAxisTitle] NVARCHAR(100) NULL,
    [YAxisTitle] NVARCHAR(100) NULL,
    [Width] INT NULL DEFAULT 800,
    [Height] INT NULL DEFAULT 400,
    [Colors] NVARCHAR(MAX) NULL, -- JSON array of colors
    [Options] NVARCHAR(MAX) NULL, -- JSON object for chart options
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_ChartConfigs] PRIMARY KEY CLUSTERED ([ChartConfigId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ChartConfigs_ChartName] ON [dbo].[ChartConfigs] ([ChartName]);
CREATE NONCLUSTERED INDEX [IX_ChartConfigs_ChartType] ON [dbo].[ChartConfigs] ([ChartType]);
```

### 2.2 相關資料表

#### 2.2.1 `ChartData` - 圖表資料快取
```sql
CREATE TABLE [dbo].[ChartData] (
    [ChartDataId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [ChartConfigId] UNIQUEIDENTIFIER NOT NULL,
    [DataJson] NVARCHAR(MAX) NOT NULL, -- JSON format chart data
    [GeneratedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [ExpiresAt] DATETIME2 NULL,
    CONSTRAINT [FK_ChartData_ChartConfigs] FOREIGN KEY ([ChartConfigId]) REFERENCES [dbo].[ChartConfigs] ([ChartConfigId]) ON DELETE CASCADE
);

CREATE NONCLUSTERED INDEX [IX_ChartData_ChartConfigId] ON [dbo].[ChartData] ([ChartConfigId]);
CREATE NONCLUSTERED INDEX [IX_ChartData_ExpiresAt] ON [dbo].[ChartData] ([ExpiresAt]);
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| ChartConfigId | UNIQUEIDENTIFIER | - | NO | NEWID() | 圖表配置ID | 主鍵 |
| ChartName | NVARCHAR | 100 | NO | - | 圖表名稱 | 唯一 |
| ChartType | NVARCHAR | 20 | NO | - | 圖表類型 | BAR, LINE, PIE等 |
| DataSource | NVARCHAR | 500 | YES | - | 資料來源 | SQL查詢或API端點 |
| XField | NVARCHAR | 100 | YES | - | X軸欄位 | - |
| YField | NVARCHAR | 100 | YES | - | Y軸欄位 | - |
| Title | NVARCHAR | 200 | YES | - | 圖表標題 | - |
| XAxisTitle | NVARCHAR | 100 | YES | - | X軸標題 | - |
| YAxisTitle | NVARCHAR | 100 | YES | - | Y軸標題 | - |
| Width | INT | - | YES | 800 | 圖表寬度 | 像素 |
| Height | INT | - | YES | 400 | 圖表高度 | 像素 |
| Colors | NVARCHAR(MAX) | - | YES | - | 顏色配置 | JSON格式 |
| Options | NVARCHAR(MAX) | - | YES | - | 圖表選項 | JSON格式 |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢圖表配置列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/charts/configs`
- **說明**: 查詢圖表配置列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "ChartName",
    "sortOrder": "ASC",
    "filters": {
      "chartName": "",
      "chartType": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "chartConfigId": "guid",
          "chartName": "銷售統計圖",
          "chartType": "BAR",
          "title": "月度銷售統計",
          "width": 800,
          "height": 400
        }
      ],
      "totalCount": 10,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 1
    }
  }
  ```

#### 3.1.2 查詢單筆圖表配置
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/charts/configs/{chartConfigId}`
- **說明**: 根據配置ID查詢單筆圖表配置

#### 3.1.3 新增圖表配置
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/charts/configs`
- **說明**: 新增圖表配置
- **請求格式**:
  ```json
  {
    "chartName": "銷售統計圖",
    "chartType": "BAR",
    "dataSource": "SELECT Month, SUM(Amount) as Total FROM Sales GROUP BY Month",
    "xField": "Month",
    "yField": "Total",
    "title": "月度銷售統計",
    "xAxisTitle": "月份",
    "yAxisTitle": "銷售額",
    "width": 800,
    "height": 400,
    "colors": ["#FF6384", "#36A2EB", "#FFCE56"],
    "options": {
      "legend": true,
      "tooltip": true
    }
  }
  ```

#### 3.1.4 修改圖表配置
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/charts/configs/{chartConfigId}`
- **說明**: 修改圖表配置

#### 3.1.5 刪除圖表配置
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/charts/configs/{chartConfigId}`
- **說明**: 刪除圖表配置

#### 3.1.6 生成圖表資料
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/charts/generate`
- **說明**: 根據圖表配置生成圖表資料
- **請求格式**:
  ```json
  {
    "chartConfigId": "guid",
    "parameters": {
      "startDate": "2024-01-01",
      "endDate": "2024-12-31"
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "生成成功",
    "data": {
      "labels": ["1月", "2月", "3月"],
      "datasets": [
        {
          "label": "銷售額",
          "data": [1000, 2000, 1500],
          "backgroundColor": ["#FF6384", "#36A2EB", "#FFCE56"]
        }
      ]
    }
  }
  ```

#### 3.1.7 匯出圖表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/charts/export`
- **說明**: 匯出圖表為圖片或PDF
- **請求格式**:
  ```json
  {
    "chartConfigId": "guid",
    "format": "PNG", // PNG, PDF, JPEG
    "width": 800,
    "height": 400
  }
  ```

### 3.2 後端實作類別

#### 3.2.1 Controller: `ChartsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/charts")]
    [Authorize]
    public class ChartsController : ControllerBase
    {
        private readonly IChartService _chartService;
        
        public ChartsController(IChartService chartService)
        {
            _chartService = chartService;
        }
        
        [HttpGet("configs")]
        public async Task<ActionResult<ApiResponse<PagedResult<ChartConfigDto>>>> GetChartConfigs([FromQuery] ChartConfigQueryDto query)
        {
            // 實作查詢邏輯
        }
        
        [HttpPost("configs")]
        public async Task<ActionResult<ApiResponse<Guid>>> CreateChartConfig([FromBody] CreateChartConfigDto dto)
        {
            // 實作新增邏輯
        }
        
        [HttpPost("generate")]
        public async Task<ActionResult<ApiResponse<ChartDataDto>>> GenerateChart([FromBody] GenerateChartDto dto)
        {
            // 實作生成圖表資料邏輯
        }
        
        [HttpPost("export")]
        public async Task<ActionResult> ExportChart([FromBody] ExportChartDto dto)
        {
            // 實作匯出邏輯
        }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 圖表配置列表頁面 (`ChartConfigList.vue`)
- **路徑**: `/charts/configs`
- **功能**: 顯示圖表配置列表，支援查詢、新增、修改、刪除

#### 4.1.2 圖表配置編輯頁面 (`ChartConfigEdit.vue`)
- **路徑**: `/charts/configs/:chartConfigId`
- **功能**: 編輯圖表配置，包含預覽功能

#### 4.1.3 圖表顯示頁面 (`ChartViewer.vue`)
- **路徑**: `/charts/view/:chartConfigId`
- **功能**: 顯示圖表，支援匯出

### 4.2 UI 元件設計

#### 4.2.1 圖表元件 (`ChartComponent.vue`)
```vue
<template>
  <div class="chart-container">
    <canvas ref="chartCanvas"></canvas>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, watch } from 'vue';
import Chart from 'chart.js/auto';

interface Props {
  chartData: ChartDataDto;
  chartType: string;
  options?: any;
}

const props = defineProps<Props>();
const chartCanvas = ref<HTMLCanvasElement | null>(null);
let chartInstance: Chart | null = null;

onMounted(() => {
  if (chartCanvas.value && props.chartData) {
    createChart();
  }
});

watch(() => props.chartData, () => {
  if (chartInstance) {
    chartInstance.data = props.chartData;
    chartInstance.update();
  }
}, { deep: true });

const createChart = () => {
  if (!chartCanvas.value) return;
  
  const ctx = chartCanvas.value.getContext('2d');
  if (!ctx) return;
  
  chartInstance = new Chart(ctx, {
    type: props.chartType.toLowerCase() as any,
    data: props.chartData,
    options: props.options || {}
  });
};
</script>
```

### 4.3 API 呼叫 (`chart.api.ts`)
```typescript
import request from '@/utils/request';

export interface ChartConfigDto {
  chartConfigId: string;
  chartName: string;
  chartType: string;
  title?: string;
  xAxisTitle?: string;
  yAxisTitle?: string;
  width?: number;
  height?: number;
}

export interface ChartDataDto {
  labels: string[];
  datasets: Array<{
    label: string;
    data: number[];
    backgroundColor?: string[];
  }>;
}

export const getChartConfigs = (query: any) => {
  return request.get<ApiResponse<PagedResult<ChartConfigDto>>>('/api/v1/charts/configs', { params: query });
};

export const createChartConfig = (data: CreateChartConfigDto) => {
  return request.post<ApiResponse<string>>('/api/v1/charts/configs', data);
};

export const generateChart = (data: GenerateChartDto) => {
  return request.post<ApiResponse<ChartDataDto>>('/api/v1/charts/generate', data);
};

export const exportChart = (data: ExportChartDto) => {
  return request.post('/api/v1/charts/export', data, { responseType: 'blob' });
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (1天)
- [ ] 建立資料表結構
- [ ] 建立索引
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (4天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作（包含圖表生成邏輯）
- [ ] Controller 實作
- [ ] 圖表匯出功能（使用 Chart.js 或 ECharts）
- [ ] 單元測試

### 5.3 階段三: 前端開發 (4天)
- [ ] API 呼叫函數
- [ ] 圖表配置列表頁面
- [ ] 圖表配置編輯頁面
- [ ] 圖表顯示元件（使用 Chart.js 或 ECharts）
- [ ] 圖表匯出功能
- [ ] 元件測試

### 5.4 階段四: 整合測試 (1.5天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 不同圖表類型測試

### 5.5 階段五: 文件與部署 (0.5天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 11天

---

## 六、注意事項

### 6.1 安全性
- 必須驗證 SQL 查詢的安全性（防止 SQL 注入）
- 必須限制資料來源的存取權限
- 必須驗證圖表配置的合法性

### 6.2 效能
- 大量資料查詢必須使用分頁
- 圖表資料必須使用快取機制
- 圖表生成必須使用非同步處理

### 6.3 資料驗證
- 圖表類型必須在允許範圍內
- 資料來源必須驗證
- 圖表參數必須驗證

### 6.4 業務邏輯
- 必須支援動態 SQL 查詢
- 必須支援參數化查詢
- 必須支援多種圖表類型

---

## 七、測試案例

### 7.1 單元測試
- [ ] 新增圖表配置成功
- [ ] 修改圖表配置成功
- [ ] 刪除圖表配置成功
- [ ] 生成圖表資料成功
- [ ] 匯出圖表成功

### 7.2 整合測試
- [ ] 完整圖表生成流程測試
- [ ] 不同圖表類型測試
- [ ] 圖表匯出功能測試
- [ ] 錯誤處理測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ASP/INCLUDE/SYS1000/Make_Chart.INC`
- `WEB/IMS_CORE/ASP/INCLUDE/SYS1000/ASP_CHART_DRAW.INC`
- `WEB/IMS_CORE/ASP/SYS1000/SYS11C0_PR.ASP`

### 8.2 技術參考
- Chart.js 官方文件
- ECharts 官方文件
- .NET Core 圖表生成庫

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

