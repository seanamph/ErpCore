# SYS4000 - 日期處理工具 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS4000
- **功能名稱**: 日期處理工具
- **功能描述**: 提供日期輸入、查詢、格式化等工具功能，支援多種日期格式和日期範圍處理
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/INCLUDE/SYS4000/SYS4000_DATE_INPUT.INC`
  - `WEB/IMS_CORE/ASP/INCLUDE/SYS4000/SYS4000_DATE_GET.INC`
  - `WEB/IMS_CORE/ASP/INCLUDE/SYS4000/SYS4000_DATE_INPUT1.INC`
  - `WEB/IMS_CORE/ASP/INCLUDE/SYS4000/SYS4000_DATE_GET1.INC`

### 1.2 業務需求
- 提供統一的日期輸入元件
- 支援多種日期格式（YYYY-MM-DD, YYYY/MM/DD等）
- 支援日期範圍選擇
- 支援日期驗證
- 支援日期計算（加減天數、月份、年份）
- 支援工作日計算
- 支援多語言日期顯示

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `DateFormats`

```sql
CREATE TABLE [dbo].[DateFormats] (
    [DateFormatId] INT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [FormatCode] NVARCHAR(20) NOT NULL UNIQUE,
    [FormatPattern] NVARCHAR(50) NOT NULL,
    [DisplayName] NVARCHAR(100) NOT NULL,
    [IsDefault] BIT NOT NULL DEFAULT 0,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE()
);

-- 預設資料
INSERT INTO [dbo].[DateFormats] ([FormatCode], [FormatPattern], [DisplayName], [IsDefault]) VALUES
('YYYY-MM-DD', 'yyyy-MM-dd', '西元年-月-日', 1),
('YYYY/MM/DD', 'yyyy/MM/dd', '西元年/月/日', 0),
('MM/DD/YYYY', 'MM/dd/yyyy', '月/日/西元年', 0),
('DD/MM/YYYY', 'dd/MM/yyyy', '日/月/西元年', 0);
```

### 2.2 相關資料表

#### 2.2.1 `Holidays` - 假日設定
```sql
CREATE TABLE [dbo].[Holidays] (
    [HolidayId] INT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [HolidayDate] DATE NOT NULL,
    [HolidayName] NVARCHAR(100) NOT NULL,
    [HolidayType] NVARCHAR(20) NULL, -- NATIONAL, REGIONAL, COMPANY
    [IsRecurring] BIT NOT NULL DEFAULT 0,
    [RecurringRule] NVARCHAR(100) NULL, -- JSON format
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [UQ_Holidays_Date] UNIQUE ([HolidayDate])
);

CREATE NONCLUSTERED INDEX [IX_Holidays_Date] ON [dbo].[Holidays] ([HolidayDate]);
CREATE NONCLUSTERED INDEX [IX_Holidays_Type] ON [dbo].[Holidays] ([HolidayType]);
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| DateFormatId | INT | - | NO | IDENTITY | 日期格式ID | 主鍵 |
| FormatCode | NVARCHAR | 20 | NO | - | 格式代碼 | 唯一 |
| FormatPattern | NVARCHAR | 50 | NO | - | 格式模式 | .NET日期格式 |
| DisplayName | NVARCHAR | 100 | NO | - | 顯示名稱 | - |
| IsDefault | BIT | - | NO | 0 | 是否預設 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 取得日期格式列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/date/formats`
- **說明**: 取得所有可用的日期格式
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": [
      {
        "formatCode": "YYYY-MM-DD",
        "formatPattern": "yyyy-MM-dd",
        "displayName": "西元年-月-日",
        "isDefault": true
      }
    ]
  }
  ```

#### 3.1.2 日期格式化
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/date/format`
- **說明**: 將日期格式化為指定格式
- **請求格式**:
  ```json
  {
    "date": "2024-01-01",
    "formatCode": "YYYY-MM-DD"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "格式化成功",
    "data": {
      "formattedDate": "2024-01-01"
    }
  }
  ```

#### 3.1.3 日期驗證
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/date/validate`
- **說明**: 驗證日期是否有效
- **請求格式**:
  ```json
  {
    "date": "2024-01-01",
    "formatCode": "YYYY-MM-DD"
  }
  ```

#### 3.1.4 日期計算
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/date/calculate`
- **說明**: 計算日期（加減天數、月份、年份）
- **請求格式**:
  ```json
  {
    "date": "2024-01-01",
    "operation": "ADD", // ADD, SUBTRACT
    "value": 30,
    "unit": "DAYS" // DAYS, MONTHS, YEARS
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "計算成功",
    "data": {
      "resultDate": "2024-01-31"
    }
  }
  ```

#### 3.1.5 工作日計算
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/date/workdays`
- **說明**: 計算兩個日期之間的工作日數
- **請求格式**:
  ```json
  {
    "startDate": "2024-01-01",
    "endDate": "2024-01-31",
    "includeStartDate": true,
    "includeEndDate": true
  }
  ```

#### 3.1.6 查詢假日列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/date/holidays`
- **說明**: 查詢指定日期範圍內的假日
- **請求參數**:
  - `startDate`: 開始日期
  - `endDate`: 結束日期
  - `holidayType`: 假日類型（可選）

### 3.2 後端實作類別

#### 3.2.1 Controller: `DateController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/date")]
    [Authorize]
    public class DateController : ControllerBase
    {
        private readonly IDateService _dateService;
        
        public DateController(IDateService dateService)
        {
            _dateService = dateService;
        }
        
        [HttpGet("formats")]
        public async Task<ActionResult<ApiResponse<List<DateFormatDto>>>> GetDateFormats()
        {
            var formats = await _dateService.GetDateFormatsAsync();
            return Ok(ApiResponse.Success(formats));
        }
        
        [HttpPost("format")]
        public async Task<ActionResult<ApiResponse<FormattedDateDto>>> FormatDate([FromBody] FormatDateDto dto)
        {
            var result = await _dateService.FormatDateAsync(dto);
            return Ok(ApiResponse.Success(result));
        }
        
        [HttpPost("validate")]
        public async Task<ActionResult<ApiResponse<bool>>> ValidateDate([FromBody] ValidateDateDto dto)
        {
            var isValid = await _dateService.ValidateDateAsync(dto);
            return Ok(ApiResponse.Success(isValid));
        }
        
        [HttpPost("calculate")]
        public async Task<ActionResult<ApiResponse<CalculatedDateDto>>> CalculateDate([FromBody] CalculateDateDto dto)
        {
            var result = await _dateService.CalculateDateAsync(dto);
            return Ok(ApiResponse.Success(result));
        }
        
        [HttpPost("workdays")]
        public async Task<ActionResult<ApiResponse<int>>> CalculateWorkdays([FromBody] WorkdaysDto dto)
        {
            var count = await _dateService.CalculateWorkdaysAsync(dto);
            return Ok(ApiResponse.Success(count));
        }
        
        [HttpGet("holidays")]
        public async Task<ActionResult<ApiResponse<List<HolidayDto>>>> GetHolidays([FromQuery] HolidayQueryDto query)
        {
            var holidays = await _dateService.GetHolidaysAsync(query);
            return Ok(ApiResponse.Success(holidays));
        }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 UI 元件設計

#### 4.1.1 日期輸入元件 (`DateInput.vue`)
```vue
<template>
  <el-date-picker
    v-model="dateValue"
    :type="type"
    :format="format"
    :value-format="valueFormat"
    :placeholder="placeholder"
    :disabled="disabled"
    :clearable="clearable"
    :range-separator="rangeSeparator"
    @change="handleChange"
  />
</template>

<script setup lang="ts">
import { ref, watch } from 'vue';

interface Props {
  modelValue: string | [string, string] | null;
  type?: 'date' | 'daterange' | 'datetime' | 'datetimerange';
  format?: string;
  valueFormat?: string;
  placeholder?: string;
  disabled?: boolean;
  clearable?: boolean;
  rangeSeparator?: string;
}

const props = withDefaults(defineProps<Props>(), {
  type: 'date',
  format: 'YYYY-MM-DD',
  valueFormat: 'YYYY-MM-DD',
  placeholder: '請選擇日期',
  disabled: false,
  clearable: true,
  rangeSeparator: '至'
});

const emit = defineEmits<{
  'update:modelValue': [value: string | [string, string] | null];
  'change': [value: string | [string, string] | null];
}>();

const dateValue = ref(props.modelValue);

watch(() => props.modelValue, (newVal) => {
  dateValue.value = newVal;
});

const handleChange = (value: string | [string, string] | null) => {
  emit('update:modelValue', value);
  emit('change', value);
};
</script>
```

#### 4.1.2 日期範圍選擇元件 (`DateRangePicker.vue`)
```vue
<template>
  <el-date-picker
    v-model="dateRange"
    type="daterange"
    :format="format"
    :value-format="valueFormat"
    :placeholder="placeholder"
    :disabled="disabled"
    :clearable="clearable"
    range-separator="至"
    start-placeholder="開始日期"
    end-placeholder="結束日期"
    @change="handleChange"
  />
</template>

<script setup lang="ts">
import { ref, watch } from 'vue';

interface Props {
  modelValue: [string, string] | null;
  format?: string;
  valueFormat?: string;
  placeholder?: string;
  disabled?: boolean;
  clearable?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  format: 'YYYY-MM-DD',
  valueFormat: 'YYYY-MM-DD',
  placeholder: '請選擇日期範圍',
  disabled: false,
  clearable: true
});

const emit = defineEmits<{
  'update:modelValue': [value: [string, string] | null];
  'change': [value: [string, string] | null];
}>();

const dateRange = ref(props.modelValue);

watch(() => props.modelValue, (newVal) => {
  dateRange.value = newVal;
});

const handleChange = (value: [string, string] | null) => {
  emit('update:modelValue', value);
  emit('change', value);
};
</script>
```

### 4.3 API 呼叫 (`date.api.ts`)
```typescript
import request from '@/utils/request';

export interface DateFormatDto {
  formatCode: string;
  formatPattern: string;
  displayName: string;
  isDefault: boolean;
}

export interface FormatDateDto {
  date: string;
  formatCode: string;
}

export interface CalculateDateDto {
  date: string;
  operation: 'ADD' | 'SUBTRACT';
  value: number;
  unit: 'DAYS' | 'MONTHS' | 'YEARS';
}

export interface WorkdaysDto {
  startDate: string;
  endDate: string;
  includeStartDate: boolean;
  includeEndDate: boolean;
}

export const getDateFormats = () => {
  return request.get<ApiResponse<DateFormatDto[]>>('/api/v1/date/formats');
};

export const formatDate = (data: FormatDateDto) => {
  return request.post<ApiResponse<{ formattedDate: string }>>('/api/v1/date/format', data);
};

export const validateDate = (data: FormatDateDto) => {
  return request.post<ApiResponse<boolean>>('/api/v1/date/validate', data);
};

export const calculateDate = (data: CalculateDateDto) => {
  return request.post<ApiResponse<{ resultDate: string }>>('/api/v1/date/calculate', data);
};

export const calculateWorkdays = (data: WorkdaysDto) => {
  return request.post<ApiResponse<number>>('/api/v1/date/workdays', data);
};

export const getHolidays = (query: { startDate: string; endDate: string; holidayType?: string }) => {
  return request.get<ApiResponse<any[]>>('/api/v1/date/holidays', { params: query });
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (0.5天)
- [ ] 建立資料表結構
- [ ] 建立索引
- [ ] 預設資料匯入

### 5.2 階段二: 後端開發 (2天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作（日期處理邏輯）
- [ ] Controller 實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 日期輸入元件
- [ ] 日期範圍選擇元件
- [ ] 日期格式化工具函數
- [ ] 元件測試

### 5.4 階段四: 整合測試 (0.5天)
- [ ] API 整合測試
- [ ] 元件整合測試
- [ ] 多語言測試

### 5.5 階段五: 文件與部署 (0.5天)
- [ ] API 文件更新
- [ ] 元件使用文件
- [ ] 部署文件

**總計**: 5.5天

---

## 六、注意事項

### 6.1 時區處理
- 必須考慮時區問題
- 必須統一使用 UTC 時間儲存
- 必須根據使用者時區顯示

### 6.2 多語言支援
- 必須支援多種日期格式
- 必須支援多語言月份名稱
- 必須支援多語言星期名稱

### 6.3 日期驗證
- 必須驗證日期格式
- 必須驗證日期範圍
- 必須處理閏年

### 6.4 效能
- 日期計算必須高效
- 假日查詢必須使用快取
- 大量日期處理必須優化

---

## 七、測試案例

### 7.1 單元測試
- [ ] 日期格式化成功
- [ ] 日期驗證成功
- [ ] 日期計算成功
- [ ] 工作日計算成功
- [ ] 假日查詢成功

### 7.2 整合測試
- [ ] 日期輸入元件測試
- [ ] 日期範圍選擇測試
- [ ] 多語言日期顯示測試
- [ ] 時區處理測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ASP/INCLUDE/SYS4000/SYS4000_DATE_INPUT.INC`
- `WEB/IMS_CORE/ASP/INCLUDE/SYS4000/SYS4000_DATE_GET.INC`
- `WEB/IMS_CORE/ASP/INCLUDE/SYS4000/SYS4000_DATE_INPUT1.INC`
- `WEB/IMS_CORE/ASP/INCLUDE/SYS4000/SYS4000_DATE_GET1.INC`

### 8.2 技術參考
- .NET DateTime 文件
- Vue DatePicker 元件文件
- Element Plus DatePicker 文件

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

