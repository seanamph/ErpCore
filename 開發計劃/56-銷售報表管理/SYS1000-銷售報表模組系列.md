# SYS1000 - 銷售報表模組系列 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS1000 系列
- **功能名稱**: 銷售報表模組系列
- **功能描述**: 提供銷售報表、實時報表、商品管理等功能，包含多種報表查詢、商品新增和查詢、報表列印等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1100_*.ASP` (報表查詢系列)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1410_*.ASP` (商品新增和查詢)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1510_*.ASP` (報表功能)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS16A0_*.ASP` ~ `SYS16E0_*.ASP` (報表功能)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1880_*.ASP` (報表功能)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1A00_*.ASP` ~ `SYS1AD2_*.ASP` (報表功能)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1B10_*.ASP` ~ `SYS1B50_*.ASP` (報表功能)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1C10_*.ASP` ~ `SYS1C90_*.ASP` (報表功能)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1D10_*.ASP` (報表功能)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1Y10_*.ASP` (商品新增和查詢)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1Z10_*.ASP` (商品瀏覽、刪除、新增、查詢、保存、修改)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1ZA0_*.ASP` ~ `SYS1ZA3_*.ASP` (商品擴展功能)
  - `WEB/IMS_CORE/ASP/SYS1000/SYS1000_SALEKIND_LIST.ASP` (銷售類型列表)
  - `WEB/IMS_CORE/ASP/SYS1000/INCLUDE/SYS1000_INIT.inc` (初始化)

### 1.2 業務需求
- 提供銷售報表查詢功能
- 支援實時報表查詢
- 支援商品管理功能（新增、修改、刪除、查詢）
- 支援多種報表格式（Excel、PDF、列印）
- 支援報表參數設定
- 支援客戶特定報表需求
- 支援報表資料快取
- 支援報表列印功能

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表

#### 2.1.1 `SalesReports` - 銷售報表資料表
```sql
CREATE TABLE [dbo].[SalesReports] (
    [ReportId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [ReportCode] NVARCHAR(50) NOT NULL, -- 報表代碼 (SYS1100-SYS1D10等)
    [ReportName] NVARCHAR(200) NOT NULL, -- 報表名稱
    [ReportType] NVARCHAR(50) NULL, -- 報表類型
    [ShopId] NVARCHAR(50) NULL, -- 店別代碼
    [StartDate] DATETIME2 NULL, -- 起始日期
    [EndDate] DATETIME2 NULL, -- 結束日期
    [ReportData] NVARCHAR(MAX) NULL, -- 報表資料 (JSON格式)
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'A', -- 狀態
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_SalesReports] PRIMARY KEY CLUSTERED ([ReportId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_SalesReports_ReportCode] ON [dbo].[SalesReports] ([ReportCode]);
CREATE NONCLUSTERED INDEX [IX_SalesReports_ShopId] ON [dbo].[SalesReports] ([ShopId]);
CREATE NONCLUSTERED INDEX [IX_SalesReports_StartDate_EndDate] ON [dbo].[SalesReports] ([StartDate], [EndDate]);
```

#### 2.1.2 `ProductReports` - 商品報表資料表
```sql
CREATE TABLE [dbo].[ProductReports] (
    [ProductReportId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [ProductId] NVARCHAR(50) NULL, -- 商品編號
    [BarcodeId] NVARCHAR(50) NULL, -- 商品條碼
    [ProductName] NVARCHAR(200) NULL, -- 商品名稱
    [ShopId] NVARCHAR(50) NULL, -- 店別代碼
    [ReportDate] DATETIME2 NULL, -- 報表日期
    [SalesQty] DECIMAL(18, 4) NULL DEFAULT 0, -- 銷售數量
    [SalesAmount] DECIMAL(18, 4) NULL DEFAULT 0, -- 銷售金額
    [CostAmount] DECIMAL(18, 4) NULL DEFAULT 0, -- 成本金額
    [ProfitAmount] DECIMAL(18, 4) NULL DEFAULT 0, -- 利潤金額
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_ProductReports_Products] FOREIGN KEY ([ProductId]) REFERENCES [dbo].[Products] ([ProductId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ProductReports_ProductId] ON [dbo].[ProductReports] ([ProductId]);
CREATE NONCLUSTERED INDEX [IX_ProductReports_ShopId] ON [dbo].[ProductReports] ([ShopId]);
CREATE NONCLUSTERED INDEX [IX_ProductReports_ReportDate] ON [dbo].[ProductReports] ([ReportDate]);
```

### 2.2 相關資料表

#### 2.2.1 `Products` - 商品主檔
```sql
-- 參考商品主檔設計
-- 用於商品管理功能
```

#### 2.2.2 `Shops` - 店別主檔
```sql
-- 參考店別主檔設計
-- 用於報表查詢的店別篩選
```

#### 2.2.3 `SalesTransactions` - 銷售交易資料表
```sql
-- 用於銷售報表資料來源
-- 參考銷售交易設計
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| ReportId | NVARCHAR | 50 | NO | - | 報表編號 | 主鍵，唯一 |
| ReportCode | NVARCHAR | 50 | NO | - | 報表代碼 | SYS1100-SYS1D10等 |
| ReportName | NVARCHAR | 200 | NO | - | 報表名稱 | - |
| ReportType | NVARCHAR | 50 | YES | - | 報表類型 | - |
| ShopId | NVARCHAR | 50 | YES | - | 店別代碼 | 外鍵至店別表 |
| StartDate | DATETIME2 | - | YES | - | 起始日期 | - |
| EndDate | DATETIME2 | - | YES | - | 結束日期 | - |
| ReportData | NVARCHAR(MAX) | - | YES | - | 報表資料 | JSON格式 |
| Status | NVARCHAR | 10 | NO | 'A' | 狀態 | A:啟用, I:停用 |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢銷售報表列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/sales-reports`
- **說明**: 查詢銷售報表列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "ReportId",
    "sortOrder": "ASC",
    "filters": {
      "reportCode": "",
      "shopId": "",
      "startDate": "",
      "endDate": "",
      "status": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "reportId": "RPT001",
          "reportCode": "SYS1100",
          "reportName": "銷售報表",
          "reportType": "SALES",
          "shopId": "SHOP001",
          "startDate": "2024-01-01",
          "endDate": "2024-01-31",
          "status": "A"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆銷售報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/sales-reports/{reportId}`
- **說明**: 根據報表編號查詢單筆銷售報表資料
- **路徑參數**:
  - `reportId`: 報表編號
- **回應格式**: 同查詢列表的單筆資料格式

#### 3.1.3 新增銷售報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/sales-reports`
- **說明**: 新增銷售報表資料
- **請求格式**:
  ```json
  {
    "reportCode": "SYS1100",
    "reportName": "銷售報表",
    "reportType": "SALES",
    "shopId": "SHOP001",
    "startDate": "2024-01-01",
    "endDate": "2024-01-31",
    "reportData": {}
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "新增成功",
    "data": {
      "reportId": "RPT001"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 修改銷售報表
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/sales-reports/{reportId}`
- **說明**: 修改銷售報表資料
- **路徑參數**:
  - `reportId`: 報表編號
- **請求格式**: 同新增，但 `reportId` 不可修改
- **回應格式**: 同新增

#### 3.1.5 刪除銷售報表
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/sales-reports/{reportId}`
- **說明**: 刪除銷售報表資料（軟刪除或硬刪除）
- **路徑參數**:
  - `reportId`: 報表編號
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.6 生成報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/sales-reports/generate`
- **說明**: 根據參數生成銷售報表
- **請求格式**:
  ```json
  {
    "reportCode": "SYS1100",
    "shopId": "SHOP001",
    "startDate": "2024-01-01",
    "endDate": "2024-01-31",
    "parameters": {}
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "報表生成成功",
    "data": {
      "reportId": "RPT001",
      "reportUrl": "/api/v1/sales-reports/RPT001/download"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.7 下載報表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/sales-reports/{reportId}/download`
- **說明**: 下載報表檔案（Excel、PDF等）
- **路徑參數**:
  - `reportId`: 報表編號
- **查詢參數**:
  - `format`: 檔案格式 (excel, pdf, csv)
- **回應**: 檔案下載

### 3.2 後端實作類別

#### 3.2.1 Controller: `SalesReportsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/sales-reports")]
    [Authorize]
    public class SalesReportsController : ControllerBase
    {
        private readonly ISalesReportService _salesReportService;
        
        public SalesReportsController(ISalesReportService salesReportService)
        {
            _salesReportService = salesReportService;
        }
        
        [HttpGet]
        public async Task<ActionResult<ApiResponse<PagedResult<SalesReportDto>>>> GetSalesReports([FromQuery] SalesReportQueryDto query)
        {
            // 實作查詢邏輯
        }
        
        [HttpGet("{reportId}")]
        public async Task<ActionResult<ApiResponse<SalesReportDto>>> GetSalesReport(string reportId)
        {
            // 實作查詢單筆邏輯
        }
        
        [HttpPost]
        public async Task<ActionResult<ApiResponse<string>>> CreateSalesReport([FromBody] CreateSalesReportDto dto)
        {
            // 實作新增邏輯
        }
        
        [HttpPut("{reportId}")]
        public async Task<ActionResult<ApiResponse>> UpdateSalesReport(string reportId, [FromBody] UpdateSalesReportDto dto)
        {
            // 實作修改邏輯
        }
        
        [HttpDelete("{reportId}")]
        public async Task<ActionResult<ApiResponse>> DeleteSalesReport(string reportId)
        {
            // 實作刪除邏輯
        }
        
        [HttpPost("generate")]
        public async Task<ActionResult<ApiResponse<GenerateReportResponseDto>>> GenerateReport([FromBody] GenerateReportDto dto)
        {
            // 實作報表生成邏輯
        }
        
        [HttpGet("{reportId}/download")]
        public async Task<IActionResult> DownloadReport(string reportId, [FromQuery] string format = "excel")
        {
            // 實作報表下載邏輯
        }
    }
}
```

#### 3.2.2 Service: `SalesReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface ISalesReportService
    {
        Task<PagedResult<SalesReportDto>> GetSalesReportsAsync(SalesReportQueryDto query);
        Task<SalesReportDto> GetSalesReportByIdAsync(string reportId);
        Task<string> CreateSalesReportAsync(CreateSalesReportDto dto);
        Task UpdateSalesReportAsync(string reportId, UpdateSalesReportDto dto);
        Task DeleteSalesReportAsync(string reportId);
        Task<GenerateReportResponseDto> GenerateReportAsync(GenerateReportDto dto);
        Task<byte[]> DownloadReportAsync(string reportId, string format);
    }
}
```

#### 3.2.3 Repository: `SalesReportRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public interface ISalesReportRepository
    {
        Task<SalesReport> GetByIdAsync(string reportId);
        Task<PagedResult<SalesReport>> GetPagedAsync(SalesReportQuery query);
        Task<SalesReport> CreateAsync(SalesReport report);
        Task<SalesReport> UpdateAsync(SalesReport report);
        Task DeleteAsync(string reportId);
        Task<bool> ExistsAsync(string reportId);
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 銷售報表列表頁面 (`SalesReportList.vue`)
- **路徑**: `/sales/reports`
- **功能**: 顯示銷售報表列表，支援查詢、新增、修改、刪除、生成報表
- **主要元件**:
  - 查詢表單 (SalesReportSearchForm)
  - 資料表格 (SalesReportDataTable)
  - 新增/修改對話框 (SalesReportDialog)
  - 刪除確認對話框
  - 報表生成對話框

#### 4.1.2 銷售報表詳細頁面 (`SalesReportDetail.vue`)
- **路徑**: `/sales/reports/:reportId`
- **功能**: 顯示銷售報表詳細資料，支援修改、下載

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`SalesReportSearchForm.vue`)
```vue
<template>
  <el-form :model="searchForm" inline>
    <el-form-item label="報表代碼">
      <el-input v-model="searchForm.reportCode" placeholder="請輸入報表代碼" />
    </el-form-item>
    <el-form-item label="店別">
      <el-select v-model="searchForm.shopId" placeholder="請選擇店別">
        <el-option v-for="shop in shopList" :key="shop.shopId" :label="shop.shopName" :value="shop.shopId" />
      </el-select>
    </el-form-item>
    <el-form-item label="起始日期">
      <el-date-picker v-model="searchForm.startDate" type="date" placeholder="請選擇日期" />
    </el-form-item>
    <el-form-item label="結束日期">
      <el-date-picker v-model="searchForm.endDate" type="date" placeholder="請選擇日期" />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 資料表格元件 (`SalesReportDataTable.vue`)
```vue
<template>
  <div>
    <el-table :data="reportList" v-loading="loading">
      <el-table-column prop="reportCode" label="報表代碼" width="120" />
      <el-table-column prop="reportName" label="報表名稱" width="200" />
      <el-table-column prop="reportType" label="報表類型" width="100" />
      <el-table-column prop="shopName" label="店別" width="150" />
      <el-table-column prop="startDate" label="起始日期" width="120" />
      <el-table-column prop="endDate" label="結束日期" width="120" />
      <el-table-column prop="status" label="狀態" width="80">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)">
            {{ getStatusText(row.status) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="300" fixed="right">
        <template #default="{ row }">
          <el-button type="primary" size="small" @click="handleEdit(row)">修改</el-button>
          <el-button type="danger" size="small" @click="handleDelete(row)">刪除</el-button>
          <el-button type="success" size="small" @click="handleGenerate(row)">生成報表</el-button>
          <el-button type="info" size="small" @click="handleDownload(row)">下載</el-button>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

### 4.3 API 呼叫 (`salesReport.api.ts`)
```typescript
import request from '@/utils/request';

export interface SalesReportDto {
  reportId: string;
  reportCode: string;
  reportName: string;
  reportType?: string;
  shopId?: string;
  startDate?: string;
  endDate?: string;
  reportData?: any;
  status: string;
}

export interface SalesReportQueryDto {
  pageIndex: number;
  pageSize: number;
  sortField?: string;
  sortOrder?: 'ASC' | 'DESC';
  filters?: {
    reportCode?: string;
    shopId?: string;
    startDate?: string;
    endDate?: string;
    status?: string;
  };
}

export interface CreateSalesReportDto {
  reportCode: string;
  reportName: string;
  reportType?: string;
  shopId?: string;
  startDate?: string;
  endDate?: string;
  reportData?: any;
}

export interface UpdateSalesReportDto extends Omit<CreateSalesReportDto, 'reportCode'> {}

export interface GenerateReportDto {
  reportCode: string;
  shopId?: string;
  startDate?: string;
  endDate?: string;
  parameters?: any;
}

// API 函數
export const getSalesReportList = (query: SalesReportQueryDto) => {
  return request.get<ApiResponse<PagedResult<SalesReportDto>>>('/api/v1/sales-reports', { params: query });
};

export const getSalesReportById = (reportId: string) => {
  return request.get<ApiResponse<SalesReportDto>>(`/api/v1/sales-reports/${reportId}`);
};

export const createSalesReport = (data: CreateSalesReportDto) => {
  return request.post<ApiResponse<string>>('/api/v1/sales-reports', data);
};

export const updateSalesReport = (reportId: string, data: UpdateSalesReportDto) => {
  return request.put<ApiResponse>(`/api/v1/sales-reports/${reportId}`, data);
};

export const deleteSalesReport = (reportId: string) => {
  return request.delete<ApiResponse>(`/api/v1/sales-reports/${reportId}`);
};

export const generateReport = (data: GenerateReportDto) => {
  return request.post<ApiResponse<GenerateReportResponseDto>>('/api/v1/sales-reports/generate', data);
};

export const downloadReport = (reportId: string, format: string = 'excel') => {
  return request.get(`/api/v1/sales-reports/${reportId}/download?format=${format}`, {
    responseType: 'blob'
  });
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (2天)
- [ ] 建立資料表結構
- [ ] 建立索引
- [ ] 建立外鍵約束
- [ ] 建立預設值
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (5天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 驗證邏輯實作
- [ ] 報表生成邏輯實作
- [ ] 報表下載邏輯實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (5天)
- [ ] API 呼叫函數
- [ ] 列表頁面開發
- [ ] 新增/修改對話框開發
- [ ] 查詢表單開發
- [ ] 資料表格開發
- [ ] 報表生成對話框開發
- [ ] 報表下載功能開發
- [ ] 表單驗證
- [ ] 元件測試

### 5.4 階段四: 整合測試 (2天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 安全性測試
- [ ] 報表生成測試
- [ ] 報表下載測試

### 5.5 階段五: 文件與部署 (1天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 15天

---

## 六、注意事項

### 6.1 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 必須使用快取機制
- 報表生成必須使用背景任務處理

### 6.2 資料驗證
- 報表代碼必須唯一
- 必填欄位必須驗證
- 日期範圍必須驗證
- 狀態值必須在允許範圍內

### 6.3 業務邏輯
- 刪除報表前必須檢查是否有相關資料
- 報表生成必須檢查參數有效性
- 報表下載必須檢查檔案是否存在
- 報表資料必須定期清理

### 6.4 安全性
- 必須實作權限檢查
- 報表資料必須加密傳輸
- 報表下載必須驗證使用者權限

---

## 七、測試案例

### 7.1 單元測試
- [ ] 新增報表成功
- [ ] 新增報表失敗 (重複代碼)
- [ ] 修改報表成功
- [ ] 修改報表失敗 (不存在)
- [ ] 刪除報表成功
- [ ] 查詢報表列表成功
- [ ] 查詢單筆報表成功
- [ ] 生成報表成功
- [ ] 下載報表成功

### 7.2 整合測試
- [ ] 完整 CRUD 流程測試
- [ ] 權限檢查測試
- [ ] 資料驗證測試
- [ ] 錯誤處理測試
- [ ] 報表生成流程測試
- [ ] 報表下載流程測試

### 7.3 效能測試
- [ ] 大量資料查詢測試
- [ ] 並發操作測試
- [ ] 報表生成效能測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ASP/SYS1000/SYS1100_*.ASP`
- `WEB/IMS_CORE/ASP/SYS1000/SYS1410_*.ASP`
- `WEB/IMS_CORE/ASP/SYS1000/SYS1510_*.ASP`
- `WEB/IMS_CORE/ASP/SYS1000/INCLUDE/SYS1000_INIT.inc`

### 8.2 資料庫 Schema
- `WEB/IMS_CORE/SYS1000/SYS1100.xsd` (如果存在)

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

