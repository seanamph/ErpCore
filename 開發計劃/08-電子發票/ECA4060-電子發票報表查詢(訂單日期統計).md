# ECA4060 - 電子發票報表查詢(訂單日期統計) 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: ECA4060
- **功能名稱**: 電子發票報表查詢(訂單日期統計)
- **功能描述**: 提供電子發票訂單日期統計報表的查詢與列印功能，包含訂單日期、已開立發票(Y)、未開立發票(N)、全部(A)的銷售數量、銷售金額、運費、銷售占比等統計資訊
- **參考舊程式**: 
  - `WEB/IMS_CORE/ECA4000/ECA4060_PR.aspx` (報表頁面)
  - `WEB/IMS_CORE/ECA4000/ECA4060_PR.rdlc` (報表定義)
  - `WEB/IMS_CORE/ECA4000/ECA4000.xsd` (資料結構定義)

### 1.2 業務需求
- 查詢電子發票訂單日期統計資料
- 支援多條件篩選（訂單日期範圍等）
- 支援已開立/未開立/全部發票的統計
- 支援銷售統計（數量、金額、運費、占比）
- 支援報表列印與匯出功能

---

## 二、資料庫設計 (Schema)

### 2.1 報表查詢視圖: `V_ECA4060_Report`

```sql
CREATE VIEW [dbo].[V_ECA4060_Report] AS
SELECT 
    ei.[OrderDate] AS ORDERM_DATE,
    SUM(CASE WHEN ei.[InvoiceStatus] = 'Y' THEN ei.[OrderQty] ELSE 0 END) AS SUM_Y_QTY,
    SUM(CASE WHEN ei.[InvoiceStatus] = 'Y' THEN ei.[OrderSubtotal] ELSE 0 END) AS SUM_Y_SUBTOTAL,
    SUM(CASE WHEN ei.[InvoiceStatus] = 'Y' THEN ei.[OrderShippingFee] ELSE 0 END) AS SUM_Y_FEE,
    CASE 
        WHEN (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED' AND [InvoiceStatus] = 'Y') > 0
        THEN (SUM(CASE WHEN ei.[InvoiceStatus] = 'Y' THEN ei.[OrderSubtotal] ELSE 0 END) * 100.0) / (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED' AND [InvoiceStatus] = 'Y')
        ELSE 0
    END AS SALES_Y_PERCENT,
    SUM(CASE WHEN ei.[InvoiceStatus] = 'N' THEN ei.[OrderQty] ELSE 0 END) AS SUM_N_QTY,
    SUM(CASE WHEN ei.[InvoiceStatus] = 'N' THEN ei.[OrderSubtotal] ELSE 0 END) AS SUM_N_SUBTOTAL,
    SUM(CASE WHEN ei.[InvoiceStatus] = 'N' THEN ei.[OrderShippingFee] ELSE 0 END) AS SUM_N_FEE,
    CASE 
        WHEN (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED' AND [InvoiceStatus] = 'N') > 0
        THEN (SUM(CASE WHEN ei.[InvoiceStatus] = 'N' THEN ei.[OrderSubtotal] ELSE 0 END) * 100.0) / (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED' AND [InvoiceStatus] = 'N')
        ELSE 0
    END AS SALES_N_PERCENT,
    SUM(ei.[OrderQty]) AS SUM_A_QTY,
    SUM(ei.[OrderSubtotal]) AS SUM_A_SUBTOTAL,
    SUM(ei.[OrderShippingFee]) AS SUM_A_FEE,
    CASE 
        WHEN (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED') > 0
        THEN (SUM(ei.[OrderSubtotal]) * 100.0) / (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED')
        ELSE 0
    END AS SALES_A_PERCENT
FROM [dbo].[EInvoices] ei
WHERE ei.[ProcessStatus] = 'COMPLETED'
GROUP BY ei.[OrderDate];
```

---

## 三、後端 API 設計

### 3.1 API 端點
- `GET /api/v1/einvoices/reports/eca4060` - 查詢報表資料
- `POST /api/v1/einvoices/reports/eca4060/export/excel` - 匯出Excel
- `POST /api/v1/einvoices/reports/eca4060/export/pdf` - 匯出PDF
- `POST /api/v1/einvoices/reports/eca4060/print` - 列印報表

---

## 四、前端 UI 設計

### 4.1 頁面結構
- 查詢條件區塊：訂單日期範圍
- 報表資料區塊：訂單日期統計表格（含已開立/未開立/全部）
- 統計資訊區塊：總數量、總金額等

---

## 五、實作細節

### 5.1 後端實作
- Repository: `GetECA4060ReportAsync()`
- Service: `GetECA4060ReportAsync()`
- Controller: `GetECA4060Report()`

### 5.2 前端實作
- API 服務: `getECA4060Report()`
- 頁面元件: `ECA4060Report.vue`

---

## 六、相關文件
- [ECA4010-電子發票報表查詢(訂單明細)](../ECA4010-電子發票報表查詢(訂單明細).md)

