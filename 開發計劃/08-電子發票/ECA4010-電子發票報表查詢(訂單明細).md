# ECA4010 - 電子發票報表查詢(訂單明細) 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: ECA4010
- **功能名稱**: 電子發票報表查詢(訂單明細)
- **功能描述**: 提供電子發票訂單明細報表的查詢與列印功能，包含店別、零售商、訂單、商品等資訊的報表查詢
- **參考舊程式**: 
  - `WEB/IMS_CORE/ECA4000/ECA4010_PR.aspx` (報表頁面)
  - `WEB/IMS_CORE/ECA4000/ECA4010_PR.rdlc` (報表定義)
  - `WEB/IMS_CORE/ECA4000/ECA4000.xsd` (資料結構定義)

### 1.2 業務需求
- 查詢電子發票訂單明細資料
- 支援多條件篩選（店別、零售商、訂單日期、訂單狀態等）
- 支援報表列印功能
- 支援報表匯出功能（Excel、PDF）
- 支援資料統計與彙總

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `EInvoices` (對應舊系統電子發票主檔)

```sql
-- 參考 ECA3010 開發計劃中的 EInvoices 資料表
-- 此報表主要查詢 EInvoices 資料表的資料
```

### 2.2 報表查詢視圖: `V_ECA4010_Report`

```sql
CREATE VIEW [dbo].[V_ECA4010_Report] AS
SELECT 
    ei.[InvoiceId],
    ei.[OrderNo] AS ORDERM_NO,
    ei.[OrderDate] AS ORDERM_DATE,
    ei.[OrderStatus] AS ORDERM_STATUS,
    ei.[OrderQty] AS ORDERM_QTY,
    ei.[OrderSubtotal] AS ORDERM_SUBTOTAL,
    s.[StoreId] AS STORE_ID,
    s.[StoreName] AS STORE_NAME,
    r.[RetailerId] AS RETAILER_ID,
    r.[RetailerName] AS RETAILER_NAME,
    sc.[ScId] AS SC_ID,
    sc.[ScName] AS SC_NAME,
    ei.[GoodsId] AS GOODS_ID,
    ei.[GoodsName] AS GOODS_NAME,
    ei.[SpecId] AS SPEC_ID,
    ei.[ProviderGoodsId] AS PROVIDER_GOODS_ID,
    ei.[ProviderId] AS PROVIDER_ID,
    ei.[CreatedAt],
    ei.[UpdatedAt]
FROM [dbo].[EInvoices] ei
LEFT JOIN [dbo].[Stores] s ON ei.[StoreId] = s.[StoreId]
LEFT JOIN [dbo].[Retailers] r ON ei.[RetailerId] = r.[RetailerId]
LEFT JOIN [dbo].[StoreCounters] sc ON ei.[ScId] = sc.[ScId]
WHERE ei.[ProcessStatus] = 'COMPLETED';
```

### 2.3 資料字典

#### V_ECA4010_Report 視圖欄位

| 欄位名稱 | 資料類型 | 說明 | 備註 |
|---------|---------|------|------|
| InvoiceId | BIGINT | 發票ID | 主鍵 |
| ORDERM_NO | NVARCHAR(100) | 訂單編號 | - |
| ORDERM_DATE | DATETIME2 | 訂單日期 | - |
| ORDERM_STATUS | NVARCHAR(50) | 訂單狀態 | - |
| ORDERM_QTY | INT | 訂單數量 | - |
| ORDERM_SUBTOTAL | DECIMAL(18,2) | 訂單小計 | - |
| STORE_ID | NVARCHAR(50) | 店別ID | - |
| STORE_NAME | NVARCHAR(200) | 店別名稱 | - |
| RETAILER_ID | NVARCHAR(50) | 零售商ID | - |
| RETAILER_NAME | NVARCHAR(200) | 零售商名稱 | - |
| SC_ID | NVARCHAR(50) | 專櫃ID | - |
| SC_NAME | NVARCHAR(200) | 專櫃名稱 | - |
| GOODS_ID | NVARCHAR(100) | 商品ID | - |
| GOODS_NAME | NVARCHAR(500) | 商品名稱 | - |
| SPEC_ID | NVARCHAR(100) | 規格ID | - |
| PROVIDER_GOODS_ID | NVARCHAR(100) | 供應商商品ID | - |
| PROVIDER_ID | NVARCHAR(50) | 供應商ID | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢報表資料
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/reports/eca4010`
- **說明**: 查詢電子發票訂單明細報表資料，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "ORDERM_DATE",
    "sortOrder": "DESC",
    "filters": {
      "storeId": "",
      "retailerId": "",
      "orderNo": "",
      "orderDateFrom": "",
      "orderDateTo": "",
      "orderStatus": "",
      "goodsId": "",
      "goodsName": "",
      "scId": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "invoiceId": 1,
          "orderNo": "ORD20240101001",
          "orderDate": "2024-01-01T10:00:00",
          "orderStatus": "COMPLETED",
          "orderQty": 10,
          "orderSubtotal": 1000.00,
          "storeId": "ST001",
          "storeName": "店別一",
          "retailerId": "RT001",
          "retailerName": "零售商一",
          "scId": "SC001",
          "scName": "專櫃一",
          "goodsId": "GD001",
          "goodsName": "商品一",
          "specId": "SP001",
          "providerGoodsId": "PG001",
          "providerId": "PR001"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 匯出報表 (Excel)
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/reports/eca4010/export/excel`
- **說明**: 匯出電子發票訂單明細報表為 Excel 格式
- **請求參數**: 同查詢報表資料的請求參數
- **回應格式**: Excel 檔案 (application/vnd.openxmlformats-officedocument.spreadsheetml.sheet)

#### 3.1.3 匯出報表 (PDF)
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/reports/eca4010/export/pdf`
- **說明**: 匯出電子發票訂單明細報表為 PDF 格式
- **請求參數**: 同查詢報表資料的請求參數
- **回應格式**: PDF 檔案 (application/pdf)

#### 3.1.4 列印報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/reports/eca4010/print`
- **說明**: 列印電子發票訂單明細報表
- **請求參數**: 同查詢報表資料的請求參數
- **回應格式**: PDF 檔案 (application/pdf)

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 查詢條件區塊
- **店別選擇**: 下拉選單 (可多選)
- **零售商選擇**: 下拉選單 (可多選)
- **訂單編號**: 文字輸入框
- **訂單日期範圍**: 日期選擇器 (開始日期 ~ 結束日期)
- **訂單狀態**: 下拉選單 (可多選)
- **商品ID**: 文字輸入框
- **商品名稱**: 文字輸入框
- **專櫃ID**: 下拉選單 (可多選)
- **查詢按鈕**: 執行查詢
- **重置按鈕**: 清空查詢條件

#### 4.1.2 報表資料區塊
- **資料表格**: 
  - 欄位: 店別、零售商、訂單編號、訂單日期、訂單狀態、訂單數量、訂單小計、專櫃、商品ID、商品名稱、規格ID、供應商商品ID、供應商ID
  - 支援排序
  - 支援分頁
- **操作按鈕**:
  - 列印按鈕
  - 匯出Excel按鈕
  - 匯出PDF按鈕

#### 4.1.3 統計資訊區塊
- **總筆數**: 顯示查詢結果總筆數
- **總數量**: 顯示訂單數量總和
- **總金額**: 顯示訂單小計總和

### 4.2 元件設計

#### 4.2.1 查詢表單元件
```vue
<template>
  <el-form :model="queryForm" :inline="true">
    <el-form-item label="店別">
      <el-select v-model="queryForm.storeIds" multiple placeholder="請選擇店別">
        <el-option v-for="store in storeList" :key="store.storeId" :label="store.storeName" :value="store.storeId" />
      </el-select>
    </el-form-item>
    <el-form-item label="零售商">
      <el-select v-model="queryForm.retailerIds" multiple placeholder="請選擇零售商">
        <el-option v-for="retailer in retailerList" :key="retailer.retailerId" :label="retailer.retailerName" :value="retailer.retailerId" />
      </el-select>
    </el-form-item>
    <el-form-item label="訂單編號">
      <el-input v-model="queryForm.orderNo" placeholder="請輸入訂單編號" />
    </el-form-item>
    <el-form-item label="訂單日期">
      <el-date-picker v-model="queryForm.orderDateRange" type="daterange" range-separator="至" start-placeholder="開始日期" end-placeholder="結束日期" />
    </el-form-item>
    <el-form-item label="訂單狀態">
      <el-select v-model="queryForm.orderStatuses" multiple placeholder="請選擇訂單狀態">
        <el-option label="已完成" value="COMPLETED" />
        <el-option label="處理中" value="PROCESSING" />
        <el-option label="已取消" value="CANCELLED" />
      </el-select>
    </el-form-item>
    <el-form-item label="商品ID">
      <el-input v-model="queryForm.goodsId" placeholder="請輸入商品ID" />
    </el-form-item>
    <el-form-item label="商品名稱">
      <el-input v-model="queryForm.goodsName" placeholder="請輸入商品名稱" />
    </el-form-item>
    <el-form-item label="專櫃">
      <el-select v-model="queryForm.scIds" multiple placeholder="請選擇專櫃">
        <el-option v-for="sc in scList" :key="sc.scId" :label="sc.scName" :value="sc.scId" />
      </el-select>
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleQuery">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 報表表格元件
```vue
<template>
  <div>
    <div class="toolbar">
      <el-button type="primary" @click="handlePrint">列印</el-button>
      <el-button type="success" @click="handleExportExcel">匯出Excel</el-button>
      <el-button type="warning" @click="handleExportPdf">匯出PDF</el-button>
    </div>
    <el-table :data="tableData" v-loading="loading" border stripe>
      <el-table-column prop="storeName" label="店別" width="120" />
      <el-table-column prop="retailerName" label="零售商" width="150" />
      <el-table-column prop="orderNo" label="訂單編號" width="150" />
      <el-table-column prop="orderDate" label="訂單日期" width="120" :formatter="formatDate" />
      <el-table-column prop="orderStatus" label="訂單狀態" width="100" :formatter="formatOrderStatus" />
      <el-table-column prop="orderQty" label="訂單數量" width="100" align="right" />
      <el-table-column prop="orderSubtotal" label="訂單小計" width="120" align="right" :formatter="formatCurrency" />
      <el-table-column prop="scName" label="專櫃" width="120" />
      <el-table-column prop="goodsId" label="商品ID" width="120" />
      <el-table-column prop="goodsName" label="商品名稱" width="200" />
      <el-table-column prop="specId" label="規格ID" width="120" />
      <el-table-column prop="providerGoodsId" label="供應商商品ID" width="150" />
      <el-table-column prop="providerId" label="供應商ID" width="120" />
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

---

## 五、實作細節

### 5.1 後端實作

#### 5.1.1 Repository 層
- `IEInvoiceReportRepository`: 定義報表查詢介面
- `EInvoiceReportRepository`: 實作報表查詢邏輯
  - `GetECA4010ReportAsync()`: 查詢 ECA4010 報表資料
  - `ExportECA4010ToExcelAsync()`: 匯出 Excel
  - `ExportECA4010ToPdfAsync()`: 匯出 PDF

#### 5.1.2 Service 層
- `IEInvoiceReportService`: 定義報表服務介面
- `EInvoiceReportService`: 實作報表服務邏輯
  - `GetECA4010ReportAsync()`: 取得報表資料
  - `ExportECA4010ToExcelAsync()`: 匯出 Excel
  - `ExportECA4010ToPdfAsync()`: 匯出 PDF

#### 5.1.3 Controller 層
- `EInvoiceReportController`: 報表 API 控制器
  - `GetECA4010Report()`: GET `/api/v1/einvoices/reports/eca4010`
  - `ExportECA4010ToExcel()`: POST `/api/v1/einvoices/reports/eca4010/export/excel`
  - `ExportECA4010ToPdf()`: POST `/api/v1/einvoices/reports/eca4010/export/pdf`
  - `PrintECA4010()`: POST `/api/v1/einvoices/reports/eca4010/print`

### 5.2 前端實作

#### 5.2.1 API 服務
- `einvoiceReportApi.ts`: 定義報表 API 呼叫函數
  - `getECA4010Report()`: 查詢報表資料
  - `exportECA4010ToExcel()`: 匯出 Excel
  - `exportECA4010ToPdf()`: 匯出 PDF
  - `printECA4010()`: 列印報表

#### 5.2.2 頁面元件
- `ECA4010Report.vue`: 報表查詢頁面
  - 查詢表單
  - 報表表格
  - 分頁元件
  - 匯出功能

---

## 六、測試計劃

### 6.1 單元測試
- Repository 層測試
- Service 層測試
- Controller 層測試

### 6.2 整合測試
- API 端點測試
- 資料庫查詢測試

### 6.3 前端測試
- 元件測試
- E2E 測試

---

## 七、注意事項

1. **效能優化**: 報表查詢可能涉及大量資料，需注意查詢效能，建議使用索引與分頁
2. **權限控制**: 報表查詢需根據使用者權限控制可查詢的資料範圍
3. **資料格式**: 日期、金額等欄位需統一格式顯示
4. **匯出功能**: Excel、PDF 匯出需注意大量資料的處理，建議使用非同步處理
5. **報表列印**: 列印功能需注意報表格式與版面配置

---

## 八、相關文件

- [ECA3010-電子發票處理作業](../ECA3010-電子發票處理作業.md)
- [ECA3020-電子發票查詢作業](../ECA3020-電子發票查詢作業.md)
- [ECA3030-電子發票上傳作業](../ECA3030-電子發票上傳作業.md)
- [ECA3040-電子發票報表查詢](../ECA3040-電子發票報表查詢.md)

