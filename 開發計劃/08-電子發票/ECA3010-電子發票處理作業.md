# ECA3010 - 電子發票處理作業 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: ECA3010
- **功能名稱**: 電子發票處理作業
- **功能描述**: 提供電子發票檔案上傳、處理、查詢功能，包含電子發票資料的上傳、驗證、處理狀態追蹤等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/ECA3000/ECA3010_UPLOAD.aspx` (上傳)
  - `WEB/IMS_CORE/ECA3000/ECA3010_DOING.aspx` (處理中)
  - `WEB/IMS_CORE/ECA3000/AjaxFileHandler_ECA3010.ashx` (檔案處理)
  - `WEB/IMS_CORE/ECA3000/ECA3000.xsd` (資料結構)

### 1.2 業務需求
- 支援電子發票檔案上傳（Excel、XML等格式）
- 支援電子發票資料驗證
- 支援電子發票資料處理（批次處理）
- 支援處理狀態追蹤
- 支援處理結果查詢
- 支援錯誤資料回報
- 支援處理進度顯示

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `EInvoiceUploads` (對應舊系統電子發票上傳記錄)

```sql
CREATE TABLE [dbo].[EInvoiceUploads] (
    [UploadId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1), -- 主鍵
    [FileName] NVARCHAR(500) NOT NULL, -- 檔案名稱
    [FileSize] BIGINT NULL, -- 檔案大小 (bytes)
    [FileType] NVARCHAR(50) NULL, -- 檔案類型 (Excel, XML等)
    [UploadDate] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 上傳時間
    [UploadBy] NVARCHAR(50) NULL, -- 上傳者
    [Status] NVARCHAR(20) NOT NULL DEFAULT 'PENDING', -- 狀態 (PENDING, PROCESSING, COMPLETED, FAILED)
    [ProcessStartDate] DATETIME2 NULL, -- 處理開始時間
    [ProcessEndDate] DATETIME2 NULL, -- 處理結束時間
    [TotalRecords] INT NULL DEFAULT 0, -- 總筆數
    [SuccessRecords] INT NULL DEFAULT 0, -- 成功筆數
    [FailedRecords] INT NULL DEFAULT 0, -- 失敗筆數
    [ErrorMessage] NVARCHAR(MAX) NULL, -- 錯誤訊息
    [ProcessLog] NVARCHAR(MAX) NULL, -- 處理日誌
    [StoreId] NVARCHAR(50) NULL, -- 店別ID
    [RetailerId] NVARCHAR(50) NULL, -- 零售商ID
    [CreatedBy] NVARCHAR(50) NULL, -- 建立者
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 建立時間
    [UpdatedBy] NVARCHAR(50) NULL, -- 更新者
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 更新時間
    CONSTRAINT [PK_EInvoiceUploads] PRIMARY KEY CLUSTERED ([UploadId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_EInvoiceUploads_Status] ON [dbo].[EInvoiceUploads] ([Status]);
CREATE NONCLUSTERED INDEX [IX_EInvoiceUploads_UploadDate] ON [dbo].[EInvoiceUploads] ([UploadDate]);
CREATE NONCLUSTERED INDEX [IX_EInvoiceUploads_UploadBy] ON [dbo].[EInvoiceUploads] ([UploadBy]);
CREATE NONCLUSTERED INDEX [IX_EInvoiceUploads_StoreId] ON [dbo].[EInvoiceUploads] ([StoreId]);
```

### 2.2 主要資料表: `EInvoices` (對應舊系統電子發票主檔)

```sql
CREATE TABLE [dbo].[EInvoices] (
    [InvoiceId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1), -- 主鍵
    [UploadId] BIGINT NULL, -- 上傳記錄ID
    [OrderNo] NVARCHAR(100) NULL, -- 訂單編號 (ORDERM_NO)
    [RetailerOrderNo] NVARCHAR(100) NULL, -- 零售商訂單編號 (RETAILER_ORDERM_NO)
    [RetailerOrderDetailNo] NVARCHAR(100) NULL, -- 零售商訂單明細編號 (RETAILER_ORDERD_NO)
    [OrderDate] DATETIME2 NULL, -- 訂單日期 (ORDERM_DATE)
    [StoreId] NVARCHAR(50) NULL, -- 店別ID (STORE_ID)
    [ProviderId] NVARCHAR(50) NULL, -- 供應商ID (PROVIDER_ID)
    [NdType] NVARCHAR(50) NULL, -- 類型 (ND_TYPE)
    [GoodsId] NVARCHAR(100) NULL, -- 商品ID (GOODS_ID)
    [GoodsName] NVARCHAR(500) NULL, -- 商品名稱 (GOODS_NAME)
    [SpecId] NVARCHAR(100) NULL, -- 規格ID (SPEC_ID)
    [ProviderGoodsId] NVARCHAR(100) NULL, -- 供應商商品ID (PROVIDER_GOODS_ID)
    [SpecColor] NVARCHAR(100) NULL, -- 規格顏色 (SPEC_COLOR)
    [SpecSize] NVARCHAR(100) NULL, -- 規格尺寸 (SPEC_SIZE)
    [SuggestPrice] DECIMAL(18,2) NULL, -- 建議價格 (SUGGEST_PRICE)
    [InternetPrice] DECIMAL(18,2) NULL, -- 網路價格 (INTERNET_PRICE)
    [ShippingType] NVARCHAR(50) NULL, -- 運送類型 (SHIPPING_TYPE)
    [ShippingFee] DECIMAL(18,2) NULL, -- 運費 (SHIPPING_FEE)
    [OrderQty] INT NULL, -- 訂單數量 (ORDERM_QTY)
    [OrderShippingFee] DECIMAL(18,2) NULL, -- 訂單運費 (ORDERM_SHIPPING_FEE)
    [OrderSubtotal] DECIMAL(18,2) NULL, -- 訂單小計 (ORDERM_SUBTOTAL)
    [OrderTotal] DECIMAL(18,2) NULL, -- 訂單總計 (ORDERM_TOTAL)
    [OrderStatus] NVARCHAR(50) NULL, -- 訂單狀態 (ORDERM_STATUS)
    [ProcessStatus] NVARCHAR(20) NOT NULL DEFAULT 'PENDING', -- 處理狀態
    [ErrorMessage] NVARCHAR(MAX) NULL, -- 錯誤訊息
    [CreatedBy] NVARCHAR(50) NULL, -- 建立者
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 建立時間
    [UpdatedBy] NVARCHAR(50) NULL, -- 更新者
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 更新時間
    CONSTRAINT [PK_EInvoices] PRIMARY KEY CLUSTERED ([InvoiceId] ASC),
    CONSTRAINT [FK_EInvoices_EInvoiceUploads] FOREIGN KEY ([UploadId]) REFERENCES [dbo].[EInvoiceUploads] ([UploadId]) ON DELETE SET NULL
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_EInvoices_UploadId] ON [dbo].[EInvoices] ([UploadId]);
CREATE NONCLUSTERED INDEX [IX_EInvoices_OrderNo] ON [dbo].[EInvoices] ([OrderNo]);
CREATE NONCLUSTERED INDEX [IX_EInvoices_OrderDate] ON [dbo].[EInvoices] ([OrderDate]);
CREATE NONCLUSTERED INDEX [IX_EInvoices_StoreId] ON [dbo].[EInvoices] ([StoreId]);
CREATE NONCLUSTERED INDEX [IX_EInvoices_ProcessStatus] ON [dbo].[EInvoices] ([ProcessStatus]);
```

### 2.3 相關資料表

#### 2.3.1 `Stores` - 店別主檔
- 用於查詢店別列表
- 參考: 基本資料管理相關模組

#### 2.3.2 `Providers` - 供應商主檔
- 用於查詢供應商列表
- 參考: 基本資料管理相關模組

### 2.4 資料字典

#### EInvoiceUploads 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| UploadId | BIGINT | - | NO | IDENTITY(1,1) | 主鍵 | 自動遞增 |
| FileName | NVARCHAR | 500 | NO | - | 檔案名稱 | - |
| FileSize | BIGINT | - | YES | - | 檔案大小 | bytes |
| FileType | NVARCHAR | 50 | YES | - | 檔案類型 | Excel, XML等 |
| UploadDate | DATETIME2 | - | NO | GETDATE() | 上傳時間 | - |
| UploadBy | NVARCHAR | 50 | YES | - | 上傳者 | - |
| Status | NVARCHAR | 20 | NO | 'PENDING' | 狀態 | PENDING, PROCESSING, COMPLETED, FAILED |
| ProcessStartDate | DATETIME2 | - | YES | - | 處理開始時間 | - |
| ProcessEndDate | DATETIME2 | - | YES | - | 處理結束時間 | - |
| TotalRecords | INT | - | YES | 0 | 總筆數 | - |
| SuccessRecords | INT | - | YES | 0 | 成功筆數 | - |
| FailedRecords | INT | - | YES | 0 | 失敗筆數 | - |
| ErrorMessage | NVARCHAR(MAX) | - | YES | - | 錯誤訊息 | - |
| ProcessLog | NVARCHAR(MAX) | - | YES | - | 處理日誌 | - |
| StoreId | NVARCHAR | 50 | YES | - | 店別ID | - |
| RetailerId | NVARCHAR | 50 | YES | - | 零售商ID | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

#### EInvoices 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| InvoiceId | BIGINT | - | NO | IDENTITY(1,1) | 主鍵 | 自動遞增 |
| UploadId | BIGINT | - | YES | - | 上傳記錄ID | 外鍵 |
| OrderNo | NVARCHAR | 100 | YES | - | 訂單編號 | - |
| RetailerOrderNo | NVARCHAR | 100 | YES | - | 零售商訂單編號 | - |
| RetailerOrderDetailNo | NVARCHAR | 100 | YES | - | 零售商訂單明細編號 | - |
| OrderDate | DATETIME2 | - | YES | - | 訂單日期 | - |
| StoreId | NVARCHAR | 50 | YES | - | 店別ID | - |
| ProviderId | NVARCHAR | 50 | YES | - | 供應商ID | - |
| NdType | NVARCHAR | 50 | YES | - | 類型 | - |
| GoodsId | NVARCHAR | 100 | YES | - | 商品ID | - |
| GoodsName | NVARCHAR | 500 | YES | - | 商品名稱 | - |
| SpecId | NVARCHAR | 100 | YES | - | 規格ID | - |
| ProviderGoodsId | NVARCHAR | 100 | YES | - | 供應商商品ID | - |
| SpecColor | NVARCHAR | 100 | YES | - | 規格顏色 | - |
| SpecSize | NVARCHAR | 100 | YES | - | 規格尺寸 | - |
| SuggestPrice | DECIMAL | 18,2 | YES | - | 建議價格 | - |
| InternetPrice | DECIMAL | 18,2 | YES | - | 網路價格 | - |
| ShippingType | NVARCHAR | 50 | YES | - | 運送類型 | - |
| ShippingFee | DECIMAL | 18,2 | YES | - | 運費 | - |
| OrderQty | INT | - | YES | - | 訂單數量 | - |
| OrderShippingFee | DECIMAL | 18,2 | YES | - | 訂單運費 | - |
| OrderSubtotal | DECIMAL | 18,2 | YES | - | 訂單小計 | - |
| OrderTotal | DECIMAL | 18,2 | YES | - | 訂單總計 | - |
| OrderStatus | NVARCHAR | 50 | YES | - | 訂單狀態 | - |
| ProcessStatus | NVARCHAR | 20 | NO | 'PENDING' | 處理狀態 | - |
| ErrorMessage | NVARCHAR(MAX) | - | YES | - | 錯誤訊息 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 上傳電子發票檔案
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/upload`
- **說明**: 上傳電子發票檔案（Excel、XML等格式）
- **請求格式**: `multipart/form-data`
- **請求參數**:
  - `file`: 檔案 (必填)
  - `storeId`: 店別ID (選填)
  - `retailerId`: 零售商ID (選填)
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "上傳成功",
    "data": {
      "uploadId": 1,
      "fileName": "invoice_20240101.xlsx",
      "fileSize": 102400,
      "status": "PENDING"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢上傳記錄列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/uploads`
- **說明**: 查詢電子發票上傳記錄列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "UploadDate",
    "sortOrder": "DESC",
    "filters": {
      "status": "",
      "uploadBy": "",
      "storeId": "",
      "startDate": "",
      "endDate": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "uploadId": 1,
          "fileName": "invoice_20240101.xlsx",
          "fileSize": 102400,
          "fileType": "Excel",
          "uploadDate": "2024-01-01T00:00:00",
          "uploadBy": "U001",
          "status": "COMPLETED",
          "totalRecords": 100,
          "successRecords": 95,
          "failedRecords": 5,
          "processStartDate": "2024-01-01T00:01:00",
          "processEndDate": "2024-01-01T00:05:00"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 查詢單筆上傳記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/uploads/{uploadId}`
- **說明**: 查詢單筆上傳記錄詳細資料
- **路徑參數**:
  - `uploadId`: 上傳記錄ID
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "uploadId": 1,
      "fileName": "invoice_20240101.xlsx",
      "fileSize": 102400,
      "fileType": "Excel",
      "uploadDate": "2024-01-01T00:00:00",
      "uploadBy": "U001",
      "status": "COMPLETED",
      "totalRecords": 100,
      "successRecords": 95,
      "failedRecords": 5,
      "errorMessage": null,
      "processLog": "處理完成",
      "processStartDate": "2024-01-01T00:01:00",
      "processEndDate": "2024-01-01T00:05:00",
      "storeId": "S001",
      "retailerId": "R001"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 查詢處理狀態
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/uploads/{uploadId}/status`
- **說明**: 查詢上傳記錄的處理狀態（用於即時更新處理進度）
- **路徑參數**:
  - `uploadId`: 上傳記錄ID
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "uploadId": 1,
      "status": "PROCESSING",
      "totalRecords": 100,
      "successRecords": 50,
      "failedRecords": 0,
      "currentProcessed": 50,
      "progress": 50.0,
      "processStartDate": "2024-01-01T00:01:00",
      "estimatedEndDate": "2024-01-01T00:05:00"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.5 開始處理上傳檔案
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/uploads/{uploadId}/process`
- **說明**: 開始處理上傳的電子發票檔案
- **路徑參數**:
  - `uploadId`: 上傳記錄ID
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "處理已開始",
    "data": {
      "uploadId": 1,
      "status": "PROCESSING"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.6 查詢電子發票列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices`
- **說明**: 查詢電子發票列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "OrderDate",
    "sortOrder": "DESC",
    "filters": {
      "uploadId": "",
      "orderNo": "",
      "storeId": "",
      "providerId": "",
      "orderDateFrom": "",
      "orderDateTo": "",
      "processStatus": ""
    }
  }
  ```
- **回應格式**: 類似查詢上傳記錄列表

#### 3.1.7 查詢單筆電子發票
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/{invoiceId}`
- **說明**: 查詢單筆電子發票詳細資料
- **路徑參數**:
  - `invoiceId`: 電子發票ID
- **回應格式**: 包含所有電子發票欄位

#### 3.1.8 下載處理結果
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/uploads/{uploadId}/download`
- **說明**: 下載處理結果檔案（成功/失敗清單）
- **路徑參數**:
  - `uploadId`: 上傳記錄ID
- **查詢參數**:
  - `type`: 下載類型 (success, failed, all)
- **回應格式**: 檔案下載

#### 3.1.9 刪除上傳記錄
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/einvoices/uploads/{uploadId}`
- **說明**: 刪除上傳記錄（僅限未處理或失敗的記錄）
- **路徑參數**:
  - `uploadId`: 上傳記錄ID
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

### 3.2 後端實作類別

#### 3.2.1 Controller: `EInvoicesController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/einvoices")]
    [Authorize]
    public class EInvoicesController : ControllerBase
    {
        private readonly IEInvoiceService _eInvoiceService;
        
        public EInvoicesController(IEInvoiceService eInvoiceService)
        {
            _eInvoiceService = eInvoiceService;
        }
        
        [HttpPost("upload")]
        public async Task<ActionResult<ApiResponse<EInvoiceUploadDto>>> UploadFile(IFormFile file, [FromForm] string storeId = null, [FromForm] string retailerId = null)
        {
            // 實作上傳邏輯
        }
        
        [HttpGet("uploads")]
        public async Task<ActionResult<ApiResponse<PagedResult<EInvoiceUploadDto>>>> GetUploads([FromQuery] EInvoiceUploadQueryDto query)
        {
            // 實作查詢上傳記錄列表邏輯
        }
        
        [HttpGet("uploads/{uploadId}")]
        public async Task<ActionResult<ApiResponse<EInvoiceUploadDto>>> GetUpload(long uploadId)
        {
            // 實作查詢單筆上傳記錄邏輯
        }
        
        [HttpGet("uploads/{uploadId}/status")]
        public async Task<ActionResult<ApiResponse<EInvoiceProcessStatusDto>>> GetProcessStatus(long uploadId)
        {
            // 實作查詢處理狀態邏輯
        }
        
        [HttpPost("uploads/{uploadId}/process")]
        public async Task<ActionResult<ApiResponse>> StartProcess(long uploadId)
        {
            // 實作開始處理邏輯
        }
        
        [HttpGet]
        public async Task<ActionResult<ApiResponse<PagedResult<EInvoiceDto>>>> GetEInvoices([FromQuery] EInvoiceQueryDto query)
        {
            // 實作查詢電子發票列表邏輯
        }
        
        [HttpGet("{invoiceId}")]
        public async Task<ActionResult<ApiResponse<EInvoiceDto>>> GetEInvoice(long invoiceId)
        {
            // 實作查詢單筆電子發票邏輯
        }
        
        [HttpGet("uploads/{uploadId}/download")]
        public async Task<IActionResult> DownloadResult(long uploadId, [FromQuery] string type = "all")
        {
            // 實作下載處理結果邏輯
        }
        
        [HttpDelete("uploads/{uploadId}")]
        public async Task<ActionResult<ApiResponse>> DeleteUpload(long uploadId)
        {
            // 實作刪除邏輯
        }
    }
}
```

#### 3.2.2 Service: `EInvoiceService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IEInvoiceService
    {
        Task<EInvoiceUploadDto> UploadFileAsync(IFormFile file, string storeId, string retailerId, string userId);
        Task<PagedResult<EInvoiceUploadDto>> GetUploadsAsync(EInvoiceUploadQueryDto query);
        Task<EInvoiceUploadDto> GetUploadAsync(long uploadId);
        Task<EInvoiceProcessStatusDto> GetProcessStatusAsync(long uploadId);
        Task StartProcessAsync(long uploadId, string userId);
        Task<PagedResult<EInvoiceDto>> GetEInvoicesAsync(EInvoiceQueryDto query);
        Task<EInvoiceDto> GetEInvoiceAsync(long invoiceId);
        Task<Stream> DownloadResultAsync(long uploadId, string type);
        Task DeleteUploadAsync(long uploadId, string userId);
    }
}
```

#### 3.2.3 Repository: `EInvoiceRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public interface IEInvoiceRepository
    {
        Task<EInvoiceUpload> GetUploadByIdAsync(long uploadId);
        Task<PagedResult<EInvoiceUpload>> GetUploadsPagedAsync(EInvoiceUploadQuery query);
        Task<EInvoiceUpload> CreateUploadAsync(EInvoiceUpload upload);
        Task<EInvoiceUpload> UpdateUploadAsync(EInvoiceUpload upload);
        Task DeleteUploadAsync(long uploadId);
        Task<List<EInvoice>> GetEInvoicesByUploadIdAsync(long uploadId);
        Task<PagedResult<EInvoice>> GetEInvoicesPagedAsync(EInvoiceQuery query);
        Task<EInvoice> GetEInvoiceByIdAsync(long invoiceId);
        Task<EInvoice> CreateEInvoiceAsync(EInvoice invoice);
        Task<EInvoice> UpdateEInvoiceAsync(EInvoice invoice);
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 電子發票上傳頁面 (`EInvoiceUpload.vue`)
- **路徑**: `/einvoices/upload`
- **功能**: 電子發票檔案上傳、處理狀態顯示
- **主要元件**:
  - 檔案上傳元件 (FileUpload)
  - 上傳記錄列表 (UploadList)
  - 處理狀態顯示 (ProcessStatus)

#### 4.1.2 電子發票查詢頁面 (`EInvoiceList.vue`)
- **路徑**: `/einvoices`
- **功能**: 電子發票列表查詢、詳細資料顯示
- **主要元件**:
  - 查詢表單 (EInvoiceSearchForm)
  - 資料表格 (EInvoiceDataTable)
  - 詳細資料對話框 (EInvoiceDetailDialog)

### 4.2 UI 元件設計

#### 4.2.1 檔案上傳元件 (`FileUpload.vue`)
```vue
<template>
  <div>
    <el-upload
      ref="uploadRef"
      :action="uploadUrl"
      :headers="uploadHeaders"
      :data="uploadData"
      :on-success="handleUploadSuccess"
      :on-error="handleUploadError"
      :on-progress="handleUploadProgress"
      :before-upload="beforeUpload"
      :file-list="fileList"
      :auto-upload="false"
      drag
    >
      <el-icon class="el-icon--upload"><upload-filled /></el-icon>
      <div class="el-upload__text">
        將檔案拖到此處，或<em>點擊上傳</em>
      </div>
      <template #tip>
        <div class="el-upload__tip">
          支援 Excel (.xlsx, .xls) 和 XML 格式，檔案大小不超過 10MB
        </div>
      </template>
    </el-upload>
    <el-button type="primary" @click="submitUpload" :loading="uploading">開始上傳</el-button>
  </div>
</template>
```

#### 4.2.2 處理狀態顯示元件 (`ProcessStatus.vue`)
```vue
<template>
  <div>
    <el-card>
      <template #header>
        <span>處理狀態</span>
      </template>
      <el-steps :active="currentStep" finish-status="success">
        <el-step title="上傳完成" />
        <el-step title="處理中" />
        <el-step title="處理完成" />
      </el-steps>
      <el-progress :percentage="progress" :status="progressStatus" />
      <div class="status-info">
        <p>總筆數: {{ totalRecords }}</p>
        <p>成功筆數: {{ successRecords }}</p>
        <p>失敗筆數: {{ failedRecords }}</p>
      </div>
    </el-card>
  </div>
</template>
```

#### 4.2.3 上傳記錄列表元件 (`UploadList.vue`)
```vue
<template>
  <div>
    <el-table :data="uploadList" v-loading="loading">
      <el-table-column prop="fileName" label="檔案名稱" width="200" />
      <el-table-column prop="fileSize" label="檔案大小" width="100">
        <template #default="{ row }">
          {{ formatFileSize(row.fileSize) }}
        </template>
      </el-table-column>
      <el-table-column prop="uploadDate" label="上傳時間" width="180" />
      <el-table-column prop="status" label="狀態" width="120">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)">
            {{ getStatusText(row.status) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="totalRecords" label="總筆數" width="100" />
      <el-table-column prop="successRecords" label="成功" width="100" />
      <el-table-column prop="failedRecords" label="失敗" width="100" />
      <el-table-column label="操作" width="200" fixed="right">
        <template #default="{ row }">
          <el-button type="primary" size="small" @click="handleView(row)">查看</el-button>
          <el-button type="success" size="small" @click="handleDownload(row)" v-if="row.status === 'COMPLETED'">下載</el-button>
          <el-button type="danger" size="small" @click="handleDelete(row)" v-if="row.status === 'FAILED' || row.status === 'PENDING'">刪除</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>
```

### 4.3 API 呼叫 (`einvoice.api.ts`)
```typescript
import request from '@/utils/request';

export interface EInvoiceUploadDto {
  uploadId: number;
  fileName: string;
  fileSize: number;
  fileType: string;
  uploadDate: string;
  uploadBy: string;
  status: string;
  totalRecords?: number;
  successRecords?: number;
  failedRecords?: number;
  errorMessage?: string;
  processLog?: string;
  processStartDate?: string;
  processEndDate?: string;
  storeId?: string;
  retailerId?: string;
}

export interface EInvoiceDto {
  invoiceId: number;
  uploadId?: number;
  orderNo?: string;
  retailerOrderNo?: string;
  retailerOrderDetailNo?: string;
  orderDate?: string;
  storeId?: string;
  providerId?: string;
  ndType?: string;
  goodsId?: string;
  goodsName?: string;
  specId?: string;
  providerGoodsId?: string;
  specColor?: string;
  specSize?: string;
  suggestPrice?: number;
  internetPrice?: number;
  shippingType?: string;
  shippingFee?: number;
  orderQty?: number;
  orderShippingFee?: number;
  orderSubtotal?: number;
  orderTotal?: number;
  orderStatus?: string;
  processStatus: string;
  errorMessage?: string;
  createdAt: string;
  updatedAt: string;
}

export interface EInvoiceUploadQueryDto {
  pageIndex: number;
  pageSize: number;
  sortField?: string;
  sortOrder?: 'ASC' | 'DESC';
  filters?: {
    status?: string;
    uploadBy?: string;
    storeId?: string;
    startDate?: string;
    endDate?: string;
  };
}

export interface EInvoiceQueryDto {
  pageIndex: number;
  pageSize: number;
  sortField?: string;
  sortOrder?: 'ASC' | 'DESC';
  filters?: {
    uploadId?: number;
    orderNo?: string;
    storeId?: string;
    providerId?: string;
    orderDateFrom?: string;
    orderDateTo?: string;
    processStatus?: string;
  };
}

export interface EInvoiceProcessStatusDto {
  uploadId: number;
  status: string;
  totalRecords: number;
  successRecords: number;
  failedRecords: number;
  currentProcessed: number;
  progress: number;
  processStartDate?: string;
  estimatedEndDate?: string;
}

// API 函數
export const uploadEInvoiceFile = (file: File, storeId?: string, retailerId?: string) => {
  const formData = new FormData();
  formData.append('file', file);
  if (storeId) formData.append('storeId', storeId);
  if (retailerId) formData.append('retailerId', retailerId);
  return request.post<ApiResponse<EInvoiceUploadDto>>('/api/v1/einvoices/upload', formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });
};

export const getEInvoiceUploads = (query: EInvoiceUploadQueryDto) => {
  return request.get<ApiResponse<PagedResult<EInvoiceUploadDto>>>('/api/v1/einvoices/uploads', { params: query });
};

export const getEInvoiceUpload = (uploadId: number) => {
  return request.get<ApiResponse<EInvoiceUploadDto>>(`/api/v1/einvoices/uploads/${uploadId}`);
};

export const getEInvoiceProcessStatus = (uploadId: number) => {
  return request.get<ApiResponse<EInvoiceProcessStatusDto>>(`/api/v1/einvoices/uploads/${uploadId}/status`);
};

export const startEInvoiceProcess = (uploadId: number) => {
  return request.post<ApiResponse>(`/api/v1/einvoices/uploads/${uploadId}/process`);
};

export const getEInvoices = (query: EInvoiceQueryDto) => {
  return request.get<ApiResponse<PagedResult<EInvoiceDto>>>('/api/v1/einvoices', { params: query });
};

export const getEInvoice = (invoiceId: number) => {
  return request.get<ApiResponse<EInvoiceDto>>(`/api/v1/einvoices/${invoiceId}`);
};

export const downloadEInvoiceResult = (uploadId: number, type: string = 'all') => {
  return request.get(`/api/v1/einvoices/uploads/${uploadId}/download`, {
    params: { type },
    responseType: 'blob'
  });
};

export const deleteEInvoiceUpload = (uploadId: number) => {
  return request.delete<ApiResponse>(`/api/v1/einvoices/uploads/${uploadId}`);
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (2天)
- [ ] 建立 EInvoiceUploads 資料表
- [ ] 建立 EInvoices 資料表
- [ ] 建立索引
- [ ] 建立外鍵約束
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (5天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作（包含檔案處理邏輯）
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 檔案上傳處理邏輯
- [ ] Excel/XML 解析邏輯
- [ ] 批次處理邏輯
- [ ] 驗證邏輯實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (4天)
- [ ] API 呼叫函數
- [ ] 檔案上傳頁面開發
- [ ] 處理狀態顯示元件開發
- [ ] 上傳記錄列表開發
- [ ] 電子發票查詢頁面開發
- [ ] 查詢表單開發
- [ ] 資料表格開發
- [ ] 詳細資料對話框開發
- [ ] 表單驗證
- [ ] 元件測試

### 5.4 階段四: 整合測試 (2天)
- [ ] API 整合測試
- [ ] 檔案上傳測試
- [ ] 批次處理測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 安全性測試

### 5.5 階段五: 文件與部署 (1天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 14天

---

## 六、注意事項

### 6.1 安全性
- 檔案上傳必須驗證檔案類型
- 檔案大小必須限制（建議 10MB 以內）
- 檔案上傳必須實作權限檢查
- 檔案處理必須記錄操作日誌
- 敏感資料必須加密儲存

### 6.2 效能
- 大量資料處理必須使用批次處理
- 必須建立適當的索引
- 必須使用非同步處理
- 處理進度必須即時更新
- 檔案處理必須支援背景作業

### 6.3 資料驗證
- 檔案格式必須驗證
- 資料欄位必須驗證
- 必填欄位必須驗證
- 資料型別必須驗證
- 業務規則必須驗證

### 6.4 業務邏輯
- 檔案上傳後必須驗證格式
- 資料處理必須支援錯誤處理
- 處理失敗必須記錄錯誤訊息
- 處理成功必須更新狀態
- 處理進度必須即時更新

### 6.5 錯誤處理
- 檔案上傳失敗必須回報錯誤
- 資料處理失敗必須記錄錯誤
- 網路錯誤必須重試機制
- 系統錯誤必須記錄日誌

### 6.6 檔案處理
- 支援 Excel (.xlsx, .xls) 格式
- 支援 XML 格式
- 檔案解析必須錯誤處理
- 大量資料必須分批處理
- 處理結果必須可下載

---

## 七、測試案例

### 7.1 單元測試
- [ ] 檔案上傳成功
- [ ] 檔案上傳失敗 (檔案格式錯誤)
- [ ] 檔案上傳失敗 (檔案大小超限)
- [ ] 查詢上傳記錄列表成功
- [ ] 查詢單筆上傳記錄成功
- [ ] 開始處理成功
- [ ] 查詢處理狀態成功
- [ ] 查詢電子發票列表成功
- [ ] 查詢單筆電子發票成功
- [ ] 下載處理結果成功
- [ ] 刪除上傳記錄成功

### 7.2 整合測試
- [ ] 完整上傳處理流程測試
- [ ] 檔案格式驗證測試
- [ ] 資料驗證測試
- [ ] 批次處理測試
- [ ] 錯誤處理測試
- [ ] 權限檢查測試

### 7.3 效能測試
- [ ] 大量資料上傳測試
- [ ] 大量資料處理測試
- [ ] 並發上傳測試
- [ ] 處理進度更新測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ECA3000/ECA3010_UPLOAD.aspx`
- `WEB/IMS_CORE/ECA3000/ECA3010_DOING.aspx`
- `WEB/IMS_CORE/ECA3000/AjaxFileHandler_ECA3010.ashx`
- `WEB/IMS_CORE/ECA3000/ECA3000.xsd`

### 8.2 資料庫 Schema
- 舊系統電子發票相關資料表結構

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

