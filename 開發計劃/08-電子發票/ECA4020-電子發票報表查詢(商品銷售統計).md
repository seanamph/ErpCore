# ECA4020 - 電子發票報表查詢(商品銷售統計) 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: ECA4020
- **功能名稱**: 電子發票報表查詢(商品銷售統計)
- **功能描述**: 提供電子發票商品銷售統計報表的查詢與列印功能，包含專櫃、商品、銷售數量、銷售金額、平均價格、銷售占比、銷售排名等統計資訊
- **參考舊程式**: 
  - `WEB/IMS_CORE/ECA4000/ECA4020_PR.aspx` (報表頁面)
  - `WEB/IMS_CORE/ECA4000/ECA4020_PR.rdlc` (報表定義)
  - `WEB/IMS_CORE/ECA4000/ECA4000.xsd` (資料結構定義)

### 1.2 業務需求
- 查詢電子發票商品銷售統計資料
- 支援多條件篩選（專櫃、商品、日期範圍等）
- 支援銷售統計（數量、金額、平均價格、占比、排名）
- 支援報表列印功能
- 支援報表匯出功能（Excel、PDF）

---

## 二、資料庫設計 (Schema)

### 2.1 報表查詢視圖: `V_ECA4020_Report`

```sql
CREATE VIEW [dbo].[V_ECA4020_Report] AS
SELECT 
    sc.[ScId] AS SC_ID,
    sc.[ScName] AS SC_NAME,
    ei.[GoodsId] AS GOODS_ID,
    ei.[GoodsName] AS GOODS_NAME,
    ei.[ProviderGoodsId] AS PROVIDER_GOODS_ID,
    SUM(ei.[OrderQty]) AS SUM_QTY,
    SUM(ei.[OrderSubtotal]) AS SUM_SUBTOTAL,
    SUM(ei.[OrderShippingFee]) AS SUM_FEE,
    CASE 
        WHEN SUM(ei.[OrderQty]) > 0 
        THEN SUM(ei.[OrderSubtotal]) / SUM(ei.[OrderQty])
        ELSE 0 
    END AS AVG_PRICE,
    CASE 
        WHEN (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED') > 0
        THEN (SUM(ei.[OrderSubtotal]) * 100.0) / (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED')
        ELSE 0
    END AS SALES_PERCENT,
    ROW_NUMBER() OVER (ORDER BY SUM(ei.[OrderSubtotal]) DESC) AS SALES_RANKING
FROM [dbo].[EInvoices] ei
LEFT JOIN [dbo].[StoreCounters] sc ON ei.[ScId] = sc.[ScId]
WHERE ei.[ProcessStatus] = 'COMPLETED'
GROUP BY sc.[ScId], sc.[ScName], ei.[GoodsId], ei.[GoodsName], ei.[ProviderGoodsId];
```

### 2.2 資料字典

| 欄位名稱 | 資料類型 | 說明 | 備註 |
|---------|---------|------|------|
| SC_ID | NVARCHAR(50) | 專櫃ID | - |
| SC_NAME | NVARCHAR(200) | 專櫃名稱 | - |
| GOODS_ID | NVARCHAR(100) | 商品ID | - |
| GOODS_NAME | NVARCHAR(500) | 商品名稱 | - |
| PROVIDER_GOODS_ID | NVARCHAR(100) | 供應商商品ID | - |
| SUM_QTY | INT | 總數量 | 彙總 |
| SUM_SUBTOTAL | DECIMAL(18,2) | 總金額 | 彙總 |
| SUM_FEE | DECIMAL(18,2) | 總運費 | 彙總 |
| AVG_PRICE | DECIMAL(18,2) | 平均價格 | 計算欄位 |
| SALES_PERCENT | DECIMAL(18,2) | 銷售占比 | 計算欄位 (%) |
| SALES_RANKING | INT | 銷售排名 | 計算欄位 |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢報表資料
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/reports/eca4020`
- **說明**: 查詢電子發票商品銷售統計報表資料
- **請求參數**: 同 ECA4010，增加專櫃、商品篩選條件
- **回應格式**: 同 ECA4010 結構

#### 3.1.2 匯出與列印
- 同 ECA4010 的匯出與列印 API

---

## 四、前端 UI 設計

### 4.1 頁面結構
- 查詢條件區塊：專櫃、商品、日期範圍等
- 報表資料區塊：商品銷售統計表格（含排名、占比）
- 統計資訊區塊：總數量、總金額、平均價格等

### 4.2 元件設計
- 參考 ECA4010 的元件設計結構

---

## 五、實作細節

### 5.1 後端實作
- Repository: `GetECA4020ReportAsync()` - 商品銷售統計查詢
- Service: `GetECA4020ReportAsync()` - 業務邏輯處理
- Controller: `GetECA4020Report()` - API 端點

### 5.2 前端實作
- API 服務: `getECA4020Report()`
- 頁面元件: `ECA4020Report.vue`

---

## 六、測試計劃
- 單元測試、整合測試、前端測試

---

## 七、注意事項
1. 統計計算需注意資料準確性
2. 排名計算需考慮相同金額的處理
3. 占比計算需避免除零錯誤

---

## 八、相關文件
- [ECA4010-電子發票報表查詢(訂單明細)](../ECA4010-電子發票報表查詢(訂單明細).md)

