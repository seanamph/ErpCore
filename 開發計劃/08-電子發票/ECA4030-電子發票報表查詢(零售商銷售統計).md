# ECA4030 - 電子發票報表查詢(零售商銷售統計) 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: ECA4030
- **功能名稱**: 電子發票報表查詢(零售商銷售統計)
- **功能描述**: 提供電子發票零售商銷售統計報表的查詢與列印功能，包含零售商、銷售數量、銷售金額、銷售占比、銷售排名等統計資訊
- **參考舊程式**: 
  - `WEB/IMS_CORE/ECA4000/ECA4030_PR.aspx` (報表頁面)
  - `WEB/IMS_CORE/ECA4000/ECA4030_PR.rdlc` (報表定義)
  - `WEB/IMS_CORE/ECA4000/ECA4000.xsd` (資料結構定義)

### 1.2 業務需求
- 查詢電子發票零售商銷售統計資料
- 支援多條件篩選（零售商、日期範圍等）
- 支援銷售統計（數量、金額、占比、排名）
- 支援報表列印與匯出功能

---

## 二、資料庫設計 (Schema)

### 2.1 報表查詢視圖: `V_ECA4030_Report`

```sql
CREATE VIEW [dbo].[V_ECA4030_Report] AS
SELECT 
    r.[RetailerId] AS RETAILER_ID,
    r.[RetailerName] AS RETAILER_NAME,
    SUM(ei.[OrderQty]) AS SUM_QTY,
    SUM(ei.[OrderSubtotal]) AS SUM_SUBTOTAL,
    SUM(ei.[OrderShippingFee]) AS SUM_FEE,
    CASE 
        WHEN (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED') > 0
        THEN (SUM(ei.[OrderSubtotal]) * 100.0) / (SELECT SUM([OrderSubtotal]) FROM [dbo].[EInvoices] WHERE [ProcessStatus] = 'COMPLETED')
        ELSE 0
    END AS SALES_PERCENT,
    ROW_NUMBER() OVER (ORDER BY SUM(ei.[OrderSubtotal]) DESC) AS SALES_RANKING
FROM [dbo].[EInvoices] ei
LEFT JOIN [dbo].[Retailers] r ON ei.[RetailerId] = r.[RetailerId]
WHERE ei.[ProcessStatus] = 'COMPLETED'
GROUP BY r.[RetailerId], r.[RetailerName];
```

---

## 三、後端 API 設計

### 3.1 API 端點
- `GET /api/v1/einvoices/reports/eca4030` - 查詢報表資料
- `POST /api/v1/einvoices/reports/eca4030/export/excel` - 匯出Excel
- `POST /api/v1/einvoices/reports/eca4030/export/pdf` - 匯出PDF
- `POST /api/v1/einvoices/reports/eca4030/print` - 列印報表

---

## 四、前端 UI 設計

### 4.1 頁面結構
- 查詢條件區塊：零售商、日期範圍
- 報表資料區塊：零售商銷售統計表格
- 統計資訊區塊：總數量、總金額等

---

## 五、實作細節

### 5.1 後端實作
- Repository: `GetECA4030ReportAsync()`
- Service: `GetECA4030ReportAsync()`
- Controller: `GetECA4030Report()`

### 5.2 前端實作
- API 服務: `getECA4030Report()`
- 頁面元件: `ECA4030Report.vue`

---

## 六、相關文件
- [ECA4010-電子發票報表查詢(訂單明細)](../ECA4010-電子發票報表查詢(訂單明細).md)
- [ECA4020-電子發票報表查詢(商品銷售統計)](../ECA4020-電子發票報表查詢(商品銷售統計).md)

