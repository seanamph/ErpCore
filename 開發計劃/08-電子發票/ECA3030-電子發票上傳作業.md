# ECA3030 - 電子發票上傳作業 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: ECA3030
- **功能名稱**: 電子發票上傳作業
- **功能描述**: 提供電子發票檔案上傳功能，用於上傳電子發票資料檔案（Excel、XML等格式），支援檔案驗證、上傳進度顯示等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/ECA0000/ECA3030_UPLOAD.aspx` (上傳頁面)
  - `WEB/IMS_CORE/ECA3000/ECA3030_UPLOAD.aspx` (上傳頁面)

### 1.2 業務需求
- 支援電子發票檔案上傳（Excel、XML等格式）
- 支援檔案格式驗證
- 支援檔案大小限制
- 支援上傳進度顯示
- 支援批次上傳
- 支援上傳記錄查詢
- 與 ECA3010 處理作業整合

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `EInvoiceUploads` (對應舊系統電子發票上傳記錄)

**說明**: 與 ECA3010 共用同一資料表

```sql
-- 參考 ECA3010 的 EInvoiceUploads 資料表結構
-- 上傳作業主要使用此資料表記錄上傳資訊
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 上傳電子發票檔案
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/upload`
- **說明**: 上傳電子發票檔案
- **請求格式**: `multipart/form-data`
  - `file`: 檔案（必填）
  - `storeId`: 店別ID（選填）
  - `retailerId`: 零售商ID（選填）
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "上傳成功",
    "data": {
      "uploadId": 1,
      "fileName": "invoice.xlsx",
      "fileSize": 1024000,
      "uploadDate": "2024-01-01T00:00:00"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢上傳記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/uploads`
- **說明**: 查詢上傳記錄列表
- **請求參數**: 同 ECA3010 的查詢參數
- **回應格式**: 同 ECA3010 的查詢回應

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 電子發票上傳頁面 (`EInvoiceUpload.vue`)
- **路徑**: `/einvoice/upload`
- **功能**: 提供電子發票檔案上傳功能
- **主要元件**:
  - 檔案上傳元件 (FileUpload)
  - 上傳進度顯示
  - 上傳記錄列表

### 4.2 UI 元件設計

#### 4.2.1 檔案上傳元件 (`EInvoiceUploadForm.vue`)
```vue
<template>
  <el-upload
    ref="uploadRef"
    :action="uploadUrl"
    :headers="uploadHeaders"
    :data="uploadData"
    :before-upload="beforeUpload"
    :on-progress="onProgress"
    :on-success="onSuccess"
    :on-error="onError"
    :file-list="fileList"
    :limit="1"
    :auto-upload="false"
    drag
  >
    <el-icon class="el-icon--upload"><upload-filled /></el-icon>
    <div class="el-upload__text">
      將檔案拖到此處，或<em>點擊上傳</em>
    </div>
    <template #tip>
      <div class="el-upload__tip">
        支援 Excel (.xlsx, .xls) 和 XML (.xml) 格式，檔案大小不超過 10MB
      </div>
    </template>
  </el-upload>
  <el-form :model="form" style="margin-top: 20px;">
    <el-form-item label="店別">
      <el-select v-model="form.storeId" placeholder="請選擇店別" filterable>
        <el-option v-for="store in storeList" :key="store.storeId" :label="store.storeName" :value="store.storeId" />
      </el-select>
    </el-form-item>
    <el-form-item label="零售商">
      <el-select v-model="form.retailerId" placeholder="請選擇零售商" filterable>
        <el-option v-for="retailer in retailerList" :key="retailer.retailerId" :label="retailer.retailerName" :value="retailer.retailerId" />
      </el-select>
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleUpload">上傳</el-button>
      <el-button @click="handleReset">重置</el-button>
    </el-form-item>
  </el-form>
  <el-progress v-if="uploading" :percentage="uploadProgress" :status="uploadStatus" />
</template>
```

---

## 五、開發任務清單

### 5.1 階段一: 資料庫設計 (0.5天)
- [x] 確認資料表結構（與ECA3010共用）

### 5.2 階段二: 後端開發 (1.5天)
- [ ] Controller 實作
- [ ] 檔案上傳處理
- [ ] 檔案驗證邏輯
- [ ] 單元測試

### 5.3 階段三: 前端開發 (1.5天)
- [ ] API 呼叫函數
- [ ] 上傳頁面開發
- [ ] 檔案上傳元件開發
- [ ] 上傳進度顯示
- [ ] 元件測試

### 5.4 階段四: 整合測試 (0.5天)
- [ ] API 整合測試
- [ ] 端對端測試

**總計**: 4天

---

## 六、注意事項

### 6.1 安全性
- 檔案類型必須驗證
- 檔案大小必須限制
- 檔案內容必須驗證
- 上傳權限必須檢查

### 6.2 效能
- 大檔案上傳必須使用分塊上傳
- 上傳進度必須即時顯示
- 上傳失敗必須提供錯誤訊息

---

## 七、參考資料

### 7.1 舊程式碼
- `WEB/IMS_CORE/ECA0000/ECA3030_UPLOAD.aspx`
- `WEB/IMS_CORE/ECA3000/ECA3030_UPLOAD.aspx`

### 7.2 相關開發計劃
- `開發計劃/08-電子發票/ECA3010-電子發票處理作業.md`

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

