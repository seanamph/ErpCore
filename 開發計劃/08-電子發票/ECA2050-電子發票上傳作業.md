# ECA2050 - 電子發票上傳作業 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: ECA2050
- **功能名稱**: 電子發票上傳作業
- **功能描述**: 提供電子發票檔案上傳功能，用於上傳電子發票資料檔案（Excel、XML等格式），支援檔案驗證、上傳進度顯示等功能，屬於ECA2000系列電子發票上傳作業
- **參考舊程式**: 
  - `WEB/IMS_CORE/ECA0000/ECA2050_UPLOAD.aspx` (上傳頁面)
  - `WEB/IMS_CORE/ECA2000/ECA2050_UPLOAD.aspx` (上傳頁面)

### 1.2 業務需求
- 支援電子發票檔案上傳（Excel、XML等格式）
- 支援檔案格式驗證
- 支援檔案大小限制
- 支援上傳進度顯示
- 支援批次上傳
- 支援上傳記錄查詢
- 與 ECA3010 處理作業整合
- 支援不同類型的電子發票資料上傳

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `EInvoiceUploads` (對應舊系統電子發票上傳記錄)

**說明**: 與 ECA3010、ECA3030 共用同一資料表

```sql
-- 參考 ECA3010 的 EInvoiceUploads 資料表結構
-- 上傳作業主要使用此資料表記錄上傳資訊
-- 可透過 UploadType 欄位區分不同類型的上傳作業
```

### 2.2 資料表結構

參考 `開發計劃/08-電子發票/ECA3010-電子發票處理作業.md` 的 `EInvoiceUploads` 資料表設計，並新增以下欄位：

```sql
ALTER TABLE [dbo].[EInvoiceUploads] ADD 
    [UploadType] NVARCHAR(50) NULL DEFAULT 'ECA2050'; -- 上傳類型 (ECA2050, ECA3010, ECA3030等)
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| UploadType | NVARCHAR | 50 | YES | 'ECA2050' | 上傳類型 | 用於區分不同上傳作業 |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 上傳電子發票檔案
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/upload`
- **說明**: 上傳電子發票檔案（ECA2050專用）
- **請求格式**: `multipart/form-data`
  - `file`: 檔案（必填）
  - `uploadType`: 上傳類型，固定為 'ECA2050'（選填，預設為 'ECA2050'）
  - `storeId`: 店別ID（選填）
  - `retailerId`: 零售商ID（選填）
  - `description`: 說明（選填）
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "上傳成功",
    "data": {
      "uploadId": 1,
      "fileName": "invoice.xlsx",
      "fileSize": 1024000,
      "fileType": "Excel",
      "uploadType": "ECA2050",
      "uploadDate": "2024-01-01T00:00:00",
      "status": "PENDING"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢上傳記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/uploads`
- **說明**: 查詢上傳記錄列表（可篩選 ECA2050 類型）
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "uploadType": "ECA2050",
    "status": "",
    "fileName": "",
    "startDate": "",
    "endDate": ""
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "uploadId": 1,
          "fileName": "invoice.xlsx",
          "fileSize": 1024000,
          "fileType": "Excel",
          "uploadType": "ECA2050",
          "uploadDate": "2024-01-01T00:00:00",
          "uploadBy": "U001",
          "status": "COMPLETED",
          "totalRecords": 100,
          "successRecords": 95,
          "failedRecords": 5
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 查詢單筆上傳記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/uploads/{uploadId}`
- **說明**: 根據上傳ID查詢單筆上傳記錄
- **路徑參數**:
  - `uploadId`: 上傳ID
- **回應格式**: 同查詢列表的單筆資料格式

#### 3.1.4 刪除上傳記錄
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/einvoices/uploads/{uploadId}`
- **說明**: 刪除上傳記錄（僅刪除記錄，不刪除檔案）
- **路徑參數**:
  - `uploadId`: 上傳ID
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.5 下載上傳檔案
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/uploads/{uploadId}/download`
- **說明**: 下載上傳的檔案
- **路徑參數**:
  - `uploadId`: 上傳ID
- **回應格式**: 檔案下載

---

## 四、前端 UI 設計

### 4.1 上傳頁面 (`ECA2050Upload.vue`)

#### 4.1.1 頁面結構
```vue
<template>
  <div class="eca2050-upload">
    <el-card>
      <template #header>
        <span>電子發票上傳作業 (ECA2050)</span>
      </template>
      
      <!-- 上傳區域 -->
      <el-upload
        ref="uploadRef"
        :action="uploadUrl"
        :headers="uploadHeaders"
        :data="uploadData"
        :file-list="fileList"
        :on-success="handleUploadSuccess"
        :on-error="handleUploadError"
        :on-progress="handleUploadProgress"
        :before-upload="beforeUpload"
        :limit="1"
        :auto-upload="false"
        drag
      >
        <el-icon class="el-icon--upload"><upload-filled /></el-icon>
        <div class="el-upload__text">
          將檔案拖到此處，或<em>點擊上傳</em>
        </div>
        <template #tip>
          <div class="el-upload__tip">
            支援 Excel (.xlsx, .xls) 和 XML 格式，檔案大小不超過 50MB
          </div>
        </template>
      </el-upload>
      
      <!-- 上傳參數 -->
      <el-form :model="uploadForm" label-width="120px" style="margin-top: 20px">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="店別ID">
              <el-select 
                v-model="uploadForm.storeId" 
                placeholder="請選擇店別"
                clearable
                filterable
                style="width: 100%"
              >
                <el-option
                  v-for="item in storeOptions"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="零售商ID">
              <el-select 
                v-model="uploadForm.retailerId" 
                placeholder="請選擇零售商"
                clearable
                filterable
                style="width: 100%"
              >
                <el-option
                  v-for="item in retailerOptions"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        <el-form-item label="說明">
          <el-input 
            v-model="uploadForm.description" 
            type="textarea"
            :rows="3"
            placeholder="請輸入說明"
            maxlength="500"
            show-word-limit
          />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSubmit">開始上傳</el-button>
          <el-button @click="handleReset">重置</el-button>
        </el-form-item>
      </el-form>
      
      <!-- 上傳進度 -->
      <el-progress 
        v-if="uploadProgress > 0 && uploadProgress < 100"
        :percentage="uploadProgress"
        :status="uploadStatus"
        style="margin-top: 20px"
      />
    </el-card>
    
    <!-- 上傳記錄 -->
    <el-card style="margin-top: 20px">
      <template #header>
        <div style="display: flex; justify-content: space-between; align-items: center">
          <span>上傳記錄</span>
          <el-button type="primary" icon="Refresh" @click="handleRefresh">刷新</el-button>
        </div>
      </template>
      
      <el-table 
        :data="uploadRecords" 
        border 
        stripe 
        style="width: 100%"
        v-loading="loading"
      >
        <el-table-column type="index" label="序號" width="60" align="center" />
        <el-table-column prop="fileName" label="檔案名稱" min-width="200" show-overflow-tooltip />
        <el-table-column prop="fileSize" label="檔案大小" width="120" align="right">
          <template #default="scope">
            {{ formatFileSize(scope.row.fileSize) }}
          </template>
        </el-table-column>
        <el-table-column prop="fileType" label="檔案類型" width="100" align="center" />
        <el-table-column prop="uploadDate" label="上傳時間" width="180" align="center">
          <template #default="scope">
            {{ formatDateTime(scope.row.uploadDate) }}
          </template>
        </el-table-column>
        <el-table-column prop="uploadBy" label="上傳者" width="120" />
        <el-table-column prop="status" label="狀態" width="120" align="center">
          <template #default="scope">
            <el-tag :type="getStatusType(scope.row.status)">
              {{ getStatusText(scope.row.status) }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="totalRecords" label="總筆數" width="100" align="right" />
        <el-table-column prop="successRecords" label="成功" width="100" align="right">
          <template #default="scope">
            <span style="color: #67c23a">{{ scope.row.successRecords }}</span>
          </template>
        </el-table-column>
        <el-table-column prop="failedRecords" label="失敗" width="100" align="right">
          <template #default="scope">
            <span style="color: #f56c6c">{{ scope.row.failedRecords }}</span>
          </template>
        </el-table-column>
        <el-table-column label="操作" width="200" align="center" fixed="right">
          <template #default="scope">
            <el-button type="primary" link @click="handleView(scope.row)">查看</el-button>
            <el-button type="success" link @click="handleDownload(scope.row)">下載</el-button>
            <el-button type="danger" link @click="handleDelete(scope.row)">刪除</el-button>
          </template>
        </el-table-column>
      </el-table>
      
      <!-- 分頁 -->
      <el-pagination
        v-model:current-page="pagination.pageIndex"
        v-model:page-size="pagination.pageSize"
        :total="pagination.totalCount"
        :page-sizes="[10, 20, 50, 100]"
        layout="total, sizes, prev, pager, next, jumper"
        @size-change="handleSizeChange"
        @current-change="handlePageChange"
        style="margin-top: 20px; justify-content: flex-end"
      />
    </el-card>
  </div>
</template>
```

#### 4.1.2 腳本邏輯
```typescript
<script setup lang="ts">
import { ref, reactive, onMounted } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import { UploadFilled } from '@element-plus/icons-vue'
import { einvoiceApi } from '@/api/einvoice'
import { useStore } from '@/stores'

const uploadRef = ref()
const fileList = ref([])
const uploadProgress = ref(0)
const uploadStatus = ref<'success' | 'exception' | 'warning' | ''>('')
const loading = ref(false)
const uploadRecords = ref([])

const uploadForm = reactive({
  storeId: '',
  retailerId: '',
  description: ''
})

const pagination = reactive({
  pageIndex: 1,
  pageSize: 20,
  totalCount: 0
})

const storeOptions = ref([])
const retailerOptions = ref([])

const uploadUrl = '/api/v1/einvoices/upload'
const uploadHeaders = {
  Authorization: `Bearer ${useStore().token}`
}

const uploadData = computed(() => ({
  uploadType: 'ECA2050',
  storeId: uploadForm.storeId || undefined,
  retailerId: uploadForm.retailerId || undefined,
  description: uploadForm.description || undefined
}))

// 上傳前驗證
const beforeUpload = (file: File) => {
  const isValidType = ['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 
                       'application/vnd.ms-excel', 
                       'text/xml', 
                       'application/xml'].includes(file.type)
  const isLt50M = file.size / 1024 / 1024 < 50

  if (!isValidType) {
    ElMessage.error('只能上傳 Excel 或 XML 格式的檔案！')
    return false
  }
  if (!isLt50M) {
    ElMessage.error('檔案大小不能超過 50MB！')
    return false
  }
  return true
}

// 上傳進度
const handleUploadProgress = (event: any) => {
  uploadProgress.value = Math.round(event.percent)
  uploadStatus.value = ''
}

// 上傳成功
const handleUploadSuccess = (response: any) => {
  if (response.success) {
    ElMessage.success('上傳成功')
    uploadProgress.value = 100
    uploadStatus.value = 'success'
    handleRefresh()
    handleReset()
  } else {
    ElMessage.error(response.message || '上傳失敗')
    uploadStatus.value = 'exception'
  }
}

// 上傳失敗
const handleUploadError = (error: any) => {
  ElMessage.error('上傳失敗：' + error.message)
  uploadStatus.value = 'exception'
  uploadProgress.value = 0
}

// 提交上傳
const handleSubmit = () => {
  if (fileList.value.length === 0) {
    ElMessage.warning('請選擇要上傳的檔案')
    return
  }
  uploadRef.value.submit()
}

// 重置
const handleReset = () => {
  fileList.value = []
  uploadForm.storeId = ''
  uploadForm.retailerId = ''
  uploadForm.description = ''
  uploadProgress.value = 0
  uploadStatus.value = ''
}

// 查詢上傳記錄
const handleRefresh = async () => {
  loading.value = true
  try {
    const response = await einvoiceApi.getUploads({
      pageIndex: pagination.pageIndex,
      pageSize: pagination.pageSize,
      uploadType: 'ECA2050'
    })
    
    if (response.success) {
      uploadRecords.value = response.data.items
      pagination.totalCount = response.data.totalCount
    } else {
      ElMessage.error(response.message || '查詢失敗')
    }
  } catch (error) {
    ElMessage.error('查詢失敗：' + error.message)
  } finally {
    loading.value = false
  }
}

// 查看詳情
const handleView = (row: any) => {
  // 跳轉到詳情頁面或開啟對話框
  ElMessage.info('查看功能開發中')
}

// 下載檔案
const handleDownload = async (row: any) => {
  try {
    const response = await einvoiceApi.downloadUpload(row.uploadId)
    // 處理檔案下載
    const url = window.URL.createObjectURL(new Blob([response.data]))
    const link = document.createElement('a')
    link.href = url
    link.setAttribute('download', row.fileName)
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    window.URL.revokeObjectURL(url)
    ElMessage.success('下載成功')
  } catch (error) {
    ElMessage.error('下載失敗：' + error.message)
  }
}

// 刪除記錄
const handleDelete = async (row: any) => {
  try {
    await ElMessageBox.confirm(
      `確定要刪除上傳記錄「${row.fileName}」嗎？`,
      '確認刪除',
      {
        confirmButtonText: '確定',
        cancelButtonText: '取消',
        type: 'warning'
      }
    )
    
    const response = await einvoiceApi.deleteUpload(row.uploadId)
    if (response.success) {
      ElMessage.success('刪除成功')
      handleRefresh()
    } else {
      ElMessage.error(response.message || '刪除失敗')
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('刪除失敗：' + error.message)
    }
  }
}

// 格式化檔案大小
const formatFileSize = (bytes: number) => {
  if (bytes === 0) return '0 B'
  const k = 1024
  const sizes = ['B', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
}

// 格式化日期時間
const formatDateTime = (date: string) => {
  return new Date(date).toLocaleString('zh-TW')
}

// 取得狀態類型
const getStatusType = (status: string) => {
  const statusMap: Record<string, string> = {
    'PENDING': 'info',
    'PROCESSING': 'warning',
    'COMPLETED': 'success',
    'FAILED': 'danger'
  }
  return statusMap[status] || 'info'
}

// 取得狀態文字
const getStatusText = (status: string) => {
  const statusMap: Record<string, string> = {
    'PENDING': '待處理',
    'PROCESSING': '處理中',
    'COMPLETED': '已完成',
    'FAILED': '失敗'
  }
  return statusMap[status] || status
}

// 分頁變更
const handleSizeChange = (size: number) => {
  pagination.pageSize = size
  pagination.pageIndex = 1
  handleRefresh()
}

const handlePageChange = (page: number) => {
  pagination.pageIndex = page
  handleRefresh()
}

// 初始化
onMounted(async () => {
  await handleRefresh()
  // 載入店別和零售商選項
  // ...
})
</script>
```

---

## 五、後端實作

### 5.1 Controller (`EInvoiceController.cs`)

參考 `開發計劃/08-電子發票/ECA3030-電子發票上傳作業.md` 的 Controller 實作，並確保支援 `uploadType` 參數。

### 5.2 Service (`EInvoiceService.cs`)

參考 `開發計劃/08-電子發票/ECA3030-電子發票上傳作業.md` 的 Service 實作，並在新增上傳記錄時設定 `UploadType = 'ECA2050'`。

### 5.3 DTO 定義

```csharp
// 上傳請求 DTO
public class EInvoiceUploadDto
{
    public IFormFile File { get; set; }
    public string? UploadType { get; set; } = "ECA2050";
    public string? StoreId { get; set; }
    public string? RetailerId { get; set; }
    public string? Description { get; set; }
}
```

---

## 六、開發時程

### 6.1 開發階段
1. **資料庫設計** (0.5 天)
   - 修改 EInvoiceUploads 資料表，新增 UploadType 欄位
   - 建立索引

2. **後端 API 開發** (1.5 天)
   - 實作上傳 API
   - 實作查詢 API
   - 實作刪除 API
   - 實作下載 API
   - 單元測試

3. **前端 UI 開發** (2 天)
   - 上傳頁面
   - 上傳記錄列表
   - 檔案上傳功能
   - 整合測試

4. **測試與優化** (0.5 天)
   - 功能測試
   - 效能測試
   - Bug 修復

**總計**: 4.5 天

---

## 七、注意事項

### 7.1 資料驗證
- 檔案格式必須為 Excel 或 XML
- 檔案大小限制為 50MB
- 上傳類型固定為 'ECA2050'

### 7.2 安全性
- 檔案上傳需驗證使用者權限
- 檔案路徑需防止路徑遍歷攻擊
- 檔案類型需嚴格驗證

### 7.3 效能優化
- 大檔案上傳使用分塊上傳
- 上傳進度即時顯示
- 使用非同步處理

### 7.4 錯誤處理
- 檔案格式錯誤提示
- 檔案大小超限提示
- 上傳失敗錯誤記錄

---

## 八、測試案例

### 8.1 功能測試
1. **上傳測試**
   - 正常上傳 Excel 檔案
   - 正常上傳 XML 檔案
   - 檔案格式錯誤
   - 檔案大小超限
   - 批次上傳

2. **查詢測試**
   - 查詢上傳記錄列表
   - 分頁查詢
   - 篩選查詢

3. **下載測試**
   - 下載上傳檔案
   - 檔案不存在處理

4. **刪除測試**
   - 正常刪除記錄
   - 刪除不存在的記錄

### 8.2 效能測試
- 大檔案上傳效能（50MB）
- 大量記錄查詢效能（10萬筆以上）

### 8.3 安全性測試
- 檔案類型驗證
- 路徑遍歷攻擊測試
- 權限驗證測試

