# ECA3020 - 電子發票查詢作業 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: ECA3020
- **功能名稱**: 電子發票查詢作業
- **功能描述**: 提供電子發票資料的查詢與報表列印功能，包含訂單編號、零售商訂單編號、商品資訊、價格、數量、狀態等資訊查詢
- **參考舊程式**: 
  - `WEB/IMS_CORE/ECA0000/ECA3020_PR.aspx` (報表頁面)
  - `WEB/IMS_CORE/ECA0000/ECA3020_PR.rdlc` (報表定義)
  - `WEB/IMS_CORE/ECA3000/ECA3000.xsd` (資料結構)

### 1.2 業務需求
- 支援電子發票資料查詢（多條件篩選）
- 支援訂單編號查詢
- 支援零售商訂單編號查詢
- 支援商品資訊查詢
- 支援日期區間查詢
- 支援店別、供應商篩選
- 支援訂單狀態篩選
- 支援報表列印功能
- 支援資料匯出功能（Excel）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `EInvoices` (對應舊系統電子發票主檔)

**說明**: 與 ECA3010 共用同一資料表

```sql
-- 參考 ECA3010 的 EInvoices 資料表結構
-- 查詢作業主要使用此資料表進行資料查詢
```

### 2.2 相關資料表

#### 2.2.1 `EInvoiceUploads` - 電子發票上傳記錄
- 用於查詢上傳記錄資訊
- 參考: `開發計劃/08-電子發票/ECA3010-電子發票處理作業.md`

#### 2.2.2 `Stores` - 店別主檔
- 用於查詢店別資訊
- 參考: 基本資料管理相關文件

#### 2.2.3 `Vendors` - 供應商主檔
- 用於查詢供應商資訊
- 參考: `開發計劃/02-基本資料管理/05-廠商客戶/SYSB206-廠客基本資料維護作業.md`

### 2.3 查詢欄位對應

| 查詢欄位 | 資料表欄位 | 資料類型 | 說明 |
|---------|-----------|---------|------|
| 訂單編號 | OrderNo | NVARCHAR(100) | 訂單編號 |
| 零售商訂單編號 | RetailerOrderNo | NVARCHAR(100) | 零售商訂單編號 |
| 零售商訂單明細編號 | RetailerOrderDetailNo | NVARCHAR(100) | 零售商訂單明細編號 |
| 訂單日期 | OrderDate | DATETIME2 | 訂單日期 |
| 店別ID | StoreId | NVARCHAR(50) | 店別ID |
| 供應商ID | ProviderId | NVARCHAR(50) | 供應商ID |
| 類型 | NdType | NVARCHAR(50) | 類型 |
| 商品ID | GoodsId | NVARCHAR(100) | 商品ID |
| 商品名稱 | GoodsName | NVARCHAR(500) | 商品名稱 |
| 規格ID | SpecId | NVARCHAR(100) | 規格ID |
| 供應商商品ID | ProviderGoodsId | NVARCHAR(100) | 供應商商品ID |
| 規格顏色 | SpecColor | NVARCHAR(100) | 規格顏色 |
| 規格尺寸 | SpecSize | NVARCHAR(100) | 規格尺寸 |
| 建議價格 | SuggestPrice | DECIMAL(18,2) | 建議價格 |
| 網路價格 | InternetPrice | DECIMAL(18,2) | 網路價格 |
| 運送類型 | ShippingType | NVARCHAR(50) | 運送類型 |
| 運費 | ShippingFee | DECIMAL(18,2) | 運費 |
| 訂單數量 | OrderQty | INT | 訂單數量 |
| 訂單運費 | OrderShippingFee | DECIMAL(18,2) | 訂單運費 |
| 訂單小計 | OrderSubtotal | DECIMAL(18,2) | 訂單小計 |
| 訂單總計 | OrderTotal | DECIMAL(18,2) | 訂單總計 |
| 訂單狀態 | OrderStatus | NVARCHAR(50) | 訂單狀態 |
| 處理狀態 | ProcessStatus | NVARCHAR(20) | 處理狀態 |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢電子發票列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/query`
- **說明**: 查詢電子發票列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "OrderDate",
    "sortOrder": "DESC",
    "filters": {
      "orderNo": "",
      "retailerOrderNo": "",
      "orderDateFrom": "",
      "orderDateTo": "",
      "storeId": "",
      "providerId": "",
      "goodsId": "",
      "goodsName": "",
      "orderStatus": "",
      "processStatus": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "invoiceId": 1,
          "orderNo": "ORD20240101001",
          "retailerOrderNo": "RETAILER001",
          "retailerOrderDetailNo": "DETAIL001",
          "orderDate": "2024-01-01T00:00:00",
          "storeId": "STORE001",
          "storeName": "店別名稱",
          "providerId": "PROVIDER001",
          "providerName": "供應商名稱",
          "ndType": "TYPE001",
          "goodsId": "GOODS001",
          "goodsName": "商品名稱",
          "specId": "SPEC001",
          "providerGoodsId": "PROVIDER_GOODS001",
          "specColor": "紅色",
          "specSize": "L",
          "suggestPrice": 1000.00,
          "internetPrice": 900.00,
          "shippingType": "EXPRESS",
          "shippingFee": 100.00,
          "orderQty": 10,
          "orderShippingFee": 100.00,
          "orderSubtotal": 9000.00,
          "orderTotal": 9100.00,
          "orderStatus": "COMPLETED",
          "processStatus": "COMPLETED",
          "createdAt": "2024-01-01T00:00:00"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆電子發票
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/einvoices/{invoiceId}`
- **說明**: 根據發票ID查詢單筆電子發票資料
- **路徑參數**:
  - `invoiceId`: 發票ID
- **回應格式**: 同查詢列表的單筆資料格式

#### 3.1.3 匯出電子發票資料
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/export`
- **說明**: 匯出電子發票資料為Excel檔案
- **請求格式**: 同查詢列表的請求參數
- **回應格式**: Excel檔案（二進位資料流）

#### 3.1.4 列印電子發票報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/einvoices/print`
- **說明**: 產生電子發票報表資料（PDF格式）
- **請求格式**: 同查詢列表的請求參數
- **回應格式**: PDF檔案（二進位資料流）

### 3.2 後端實作類別

#### 3.2.1 Controller: `EInvoiceQueryController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/einvoices")]
    [Authorize]
    public class EInvoiceQueryController : ControllerBase
    {
        private readonly IEInvoiceQueryService _eInvoiceQueryService;
        
        public EInvoiceQueryController(IEInvoiceQueryService eInvoiceQueryService)
        {
            _eInvoiceQueryService = eInvoiceQueryService;
        }
        
        [HttpGet("query")]
        public async Task<ActionResult<ApiResponse<PagedResult<EInvoiceQueryDto>>>> QueryEInvoices([FromQuery] EInvoiceQueryRequestDto request)
        {
            // 實作查詢邏輯
        }
        
        [HttpGet("{invoiceId}")]
        public async Task<ActionResult<ApiResponse<EInvoiceQueryDto>>> GetEInvoice(long invoiceId)
        {
            // 實作查詢單筆邏輯
        }
        
        [HttpPost("export")]
        public async Task<IActionResult> ExportEInvoices([FromBody] EInvoiceQueryRequestDto request)
        {
            // 實作匯出邏輯
        }
        
        [HttpPost("print")]
        public async Task<IActionResult> PrintEInvoices([FromBody] EInvoiceQueryRequestDto request)
        {
            // 實作列印邏輯
        }
    }
}
```

#### 3.2.2 Service: `EInvoiceQueryService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IEInvoiceQueryService
    {
        Task<PagedResult<EInvoiceQueryDto>> QueryEInvoicesAsync(EInvoiceQueryRequestDto request);
        Task<EInvoiceQueryDto> GetEInvoiceAsync(long invoiceId);
        Task<byte[]> ExportEInvoicesAsync(EInvoiceQueryRequestDto request);
        Task<byte[]> PrintEInvoicesAsync(EInvoiceQueryRequestDto request);
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 電子發票查詢頁面 (`EInvoiceQuery.vue`)
- **路徑**: `/einvoice/query`
- **功能**: 顯示電子發票查詢列表，支援查詢、匯出、列印
- **主要元件**:
  - 查詢表單 (EInvoiceQueryForm)
  - 資料表格 (EInvoiceQueryTable)
  - 匯出按鈕
  - 列印按鈕

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`EInvoiceQueryForm.vue`)
```vue
<template>
  <el-form :model="queryForm" inline>
    <el-form-item label="訂單編號">
      <el-input v-model="queryForm.orderNo" placeholder="請輸入訂單編號" />
    </el-form-item>
    <el-form-item label="零售商訂單編號">
      <el-input v-model="queryForm.retailerOrderNo" placeholder="請輸入零售商訂單編號" />
    </el-form-item>
    <el-form-item label="訂單日期">
      <el-date-picker
        v-model="queryForm.orderDateRange"
        type="daterange"
        range-separator="至"
        start-placeholder="開始日期"
        end-placeholder="結束日期"
      />
    </el-form-item>
    <el-form-item label="店別">
      <el-select v-model="queryForm.storeId" placeholder="請選擇店別" filterable>
        <el-option v-for="store in storeList" :key="store.storeId" :label="store.storeName" :value="store.storeId" />
      </el-select>
    </el-form-item>
    <el-form-item label="供應商">
      <el-select v-model="queryForm.providerId" placeholder="請選擇供應商" filterable>
        <el-option v-for="provider in providerList" :key="provider.providerId" :label="provider.providerName" :value="provider.providerId" />
      </el-select>
    </el-form-item>
    <el-form-item label="商品ID">
      <el-input v-model="queryForm.goodsId" placeholder="請輸入商品ID" />
    </el-form-item>
    <el-form-item label="商品名稱">
      <el-input v-model="queryForm.goodsName" placeholder="請輸入商品名稱" />
    </el-form-item>
    <el-form-item label="訂單狀態">
      <el-select v-model="queryForm.orderStatus" placeholder="請選擇訂單狀態">
        <el-option label="全部" value="" />
        <el-option label="已完成" value="COMPLETED" />
        <el-option label="處理中" value="PROCESSING" />
        <el-option label="已取消" value="CANCELLED" />
      </el-select>
    </el-form-item>
    <el-form-item label="處理狀態">
      <el-select v-model="queryForm.processStatus" placeholder="請選擇處理狀態">
        <el-option label="全部" value="" />
        <el-option label="待處理" value="PENDING" />
        <el-option label="處理中" value="PROCESSING" />
        <el-option label="已完成" value="COMPLETED" />
        <el-option label="失敗" value="FAILED" />
      </el-select>
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleQuery">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button type="success" @click="handleExport">匯出</el-button>
      <el-button type="warning" @click="handlePrint">列印</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 資料表格元件 (`EInvoiceQueryTable.vue`)
```vue
<template>
  <div>
    <el-table :data="invoiceList" v-loading="loading" border>
      <el-table-column prop="orderNo" label="訂單編號" width="150" />
      <el-table-column prop="retailerOrderNo" label="零售商訂單編號" width="150" />
      <el-table-column prop="orderDate" label="訂單日期" width="120" :formatter="formatDate" />
      <el-table-column prop="storeName" label="店別" width="120" />
      <el-table-column prop="providerName" label="供應商" width="150" />
      <el-table-column prop="goodsId" label="商品ID" width="120" />
      <el-table-column prop="goodsName" label="商品名稱" width="200" show-overflow-tooltip />
      <el-table-column prop="orderQty" label="數量" width="80" align="right" />
      <el-table-column prop="orderTotal" label="總計" width="120" align="right" :formatter="formatCurrency" />
      <el-table-column prop="orderStatus" label="訂單狀態" width="100">
        <template #default="{ row }">
          <el-tag :type="getOrderStatusType(row.orderStatus)">
            {{ getOrderStatusText(row.orderStatus) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column prop="processStatus" label="處理狀態" width="100">
        <template #default="{ row }">
          <el-tag :type="getProcessStatusType(row.processStatus)">
            {{ getProcessStatusText(row.processStatus) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="150" fixed="right">
        <template #default="{ row }">
          <el-button type="primary" size="small" @click="handleView(row)">查看</el-button>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

### 4.3 API 呼叫 (`einvoice-query.api.ts`)
```typescript
import request from '@/utils/request';

export interface EInvoiceQueryDto {
  invoiceId: number;
  orderNo: string;
  retailerOrderNo?: string;
  retailerOrderDetailNo?: string;
  orderDate: string;
  storeId?: string;
  storeName?: string;
  providerId?: string;
  providerName?: string;
  ndType?: string;
  goodsId?: string;
  goodsName?: string;
  specId?: string;
  providerGoodsId?: string;
  specColor?: string;
  specSize?: string;
  suggestPrice?: number;
  internetPrice?: number;
  shippingType?: string;
  shippingFee?: number;
  orderQty?: number;
  orderShippingFee?: number;
  orderSubtotal?: number;
  orderTotal?: number;
  orderStatus?: string;
  processStatus: string;
  createdAt?: string;
}

export interface EInvoiceQueryRequestDto {
  pageIndex: number;
  pageSize: number;
  sortField?: string;
  sortOrder?: 'ASC' | 'DESC';
  filters?: {
    orderNo?: string;
    retailerOrderNo?: string;
    orderDateFrom?: string;
    orderDateTo?: string;
    storeId?: string;
    providerId?: string;
    goodsId?: string;
    goodsName?: string;
    orderStatus?: string;
    processStatus?: string;
  };
}

// API 函數
export const queryEInvoices = (request: EInvoiceQueryRequestDto) => {
  return request.get<ApiResponse<PagedResult<EInvoiceQueryDto>>>('/api/v1/einvoices/query', { params: request });
};

export const getEInvoice = (invoiceId: number) => {
  return request.get<ApiResponse<EInvoiceQueryDto>>(`/api/v1/einvoices/${invoiceId}`);
};

export const exportEInvoices = (request: EInvoiceQueryRequestDto) => {
  return request.post('/api/v1/einvoices/export', request, { responseType: 'blob' });
};

export const printEInvoices = (request: EInvoiceQueryRequestDto) => {
  return request.post('/api/v1/einvoices/print', request, { responseType: 'blob' });
};
```

---

## 五、開發任務清單

### 5.1 階段一: 資料庫設計 (0.5天)
- [x] 確認資料表結構（與ECA3010共用）
- [ ] 確認索引設計
- [ ] 確認查詢效能優化

### 5.2 階段二: 後端開發 (2天)
- [ ] DTO 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] 查詢邏輯實作
- [ ] 匯出功能實作（Excel）
- [ ] 列印功能實作（PDF）
- [ ] 單元測試

### 5.3 階段三: 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 查詢頁面開發
- [ ] 查詢表單開發
- [ ] 資料表格開發
- [ ] 匯出功能開發
- [ ] 列印功能開發
- [ ] 元件測試

### 5.4 階段四: 整合測試 (1天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 安全性測試

### 5.5 階段五: 文件與部署 (0.5天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 6天

---

## 六、注意事項

### 6.1 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 複雜查詢必須優化
- 匯出大量資料時必須使用批次處理

### 6.2 資料驗證
- 日期區間必須驗證
- 查詢條件必須驗證
- 匯出資料量必須限制

### 6.3 業務邏輯
- 查詢權限必須檢查
- 資料權限必須過濾（依使用者權限）
- 匯出功能必須記錄操作日誌

---

## 七、測試案例

### 7.1 單元測試
- [ ] 查詢電子發票列表成功
- [ ] 查詢單筆電子發票成功
- [ ] 查詢條件篩選成功
- [ ] 分頁查詢成功
- [ ] 排序查詢成功
- [ ] 匯出功能成功
- [ ] 列印功能成功

### 7.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 權限檢查測試
- [ ] 資料驗證測試
- [ ] 錯誤處理測試
- [ ] 匯出功能測試
- [ ] 列印功能測試

### 7.3 效能測試
- [ ] 大量資料查詢測試
- [ ] 複雜條件查詢測試
- [ ] 匯出大量資料測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ECA0000/ECA3020_PR.aspx`
- `WEB/IMS_CORE/ECA0000/ECA3020_PR.rdlc`
- `WEB/IMS_CORE/ECA3000/ECA3000.xsd`

### 8.2 相關開發計劃
- `開發計劃/08-電子發票/ECA3010-電子發票處理作業.md`

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

