# 採購報表列印 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: 採購報表列印
- **功能名稱**: 採購報表列印
- **功能描述**: 提供採購相關報表的列印功能，包含採購單報表、供應商報表、付款單報表等，支援PDF格式列印、報表預覽、列印設定等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP110_PR.asp` (採購單報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP120_PR.ASP` (供應商報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP130_PR.ASP` (付款單報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP140_PR.ASP` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP150_PR.ASP` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP210_PR.ASP` (供應商報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP225_PR.ASP` (供應商報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP276_PR.asp` (付款單報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP462_PR.asp` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP4B0_PR.asp` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP4G0_PR.ASP` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP4H0_PR.asp` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP491_PR.asp` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP491_PR2.asp` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSP520_PR.ASP` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSPA15_PR.asp` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSPB10_PR.ASP` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSPB25_PR.asp` (採購報表列印)
  - `WEB/IMS_CORE/ASP/SYSP000/SYSPB60_PR.ASP` (採購報表列印)

### 1.2 業務需求
- 提供採購相關報表的列印功能
- 支援PDF格式列印
- 支援報表預覽
- 支援列印設定（頁面大小、邊界等）
- 支援報表資料查詢與篩選
- 記錄報表列印記錄
- 支援報表匯出（Excel、PDF）
- 支援多種報表類型（採購單、供應商、付款單等）
- 支援報表模板管理

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `PurchaseReportPrints` (採購報表列印記錄)

```sql
CREATE TABLE [dbo].[PurchaseReportPrints] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1), -- 主鍵
    [ReportType] NVARCHAR(50) NOT NULL, -- 報表類型 (REPORT_TYPE) PO:採購單, SU:供應商, PY:付款單
    [ReportCode] NVARCHAR(50) NOT NULL, -- 報表代碼 (REPORT_CODE)
    [ReportName] NVARCHAR(200) NOT NULL, -- 報表名稱 (REPORT_NAME)
    [PrintDate] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 列印日期 (PRINT_DATE)
    [PrintUserId] NVARCHAR(50) NOT NULL, -- 列印使用者 (PRINT_USER_ID)
    [PrintUserName] NVARCHAR(100) NULL, -- 列印使用者名稱 (PRINT_USER_NAME)
    [FilterConditions] NVARCHAR(MAX) NULL, -- 篩選條件 (FILTER_CONDITIONS, JSON格式)
    [PrintSettings] NVARCHAR(MAX) NULL, -- 列印設定 (PRINT_SETTINGS, JSON格式)
    [FileFormat] NVARCHAR(20) NULL DEFAULT 'PDF', -- 檔案格式 (FILE_FORMAT) PDF, Excel
    [FilePath] NVARCHAR(500) NULL, -- 檔案路徑 (FILE_PATH)
    [FileName] NVARCHAR(200) NULL, -- 檔案名稱 (FILE_NAME)
    [FileSize] BIGINT NULL, -- 檔案大小 (FILE_SIZE, bytes)
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'S', -- 狀態 (STATUS) S:成功, F:失敗, P:處理中
    [ErrorMessage] NVARCHAR(MAX) NULL, -- 錯誤訊息 (ERROR_MESSAGE)
    [PageCount] INT NULL DEFAULT 0, -- 頁數 (PAGE_COUNT)
    [RecordCount] INT NULL DEFAULT 0, -- 記錄數 (RECORD_COUNT)
    [Notes] NVARCHAR(500) NULL, -- 備註 (NOTES)
    [CreatedBy] NVARCHAR(50) NULL, -- 建立者 (CREATED_BY)
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 建立時間 (CREATED_AT)
    [UpdatedBy] NVARCHAR(50) NULL, -- 更新者 (UPDATED_BY)
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 更新時間 (UPDATED_AT)
    CONSTRAINT [PK_PurchaseReportPrints] PRIMARY KEY CLUSTERED ([TKey] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_PurchaseReportPrints_ReportType] ON [dbo].[PurchaseReportPrints] ([ReportType]);
CREATE NONCLUSTERED INDEX [IX_PurchaseReportPrints_ReportCode] ON [dbo].[PurchaseReportPrints] ([ReportCode]);
CREATE NONCLUSTERED INDEX [IX_PurchaseReportPrints_PrintDate] ON [dbo].[PurchaseReportPrints] ([PrintDate]);
CREATE NONCLUSTERED INDEX [IX_PurchaseReportPrints_PrintUserId] ON [dbo].[PurchaseReportPrints] ([PrintUserId]);
CREATE NONCLUSTERED INDEX [IX_PurchaseReportPrints_Status] ON [dbo].[PurchaseReportPrints] ([Status]);
```

### 2.2 相關資料表

#### 2.2.1 `PurchaseReportTemplates` - 採購報表模板
```sql
CREATE TABLE [dbo].[PurchaseReportTemplates] (
    [TemplateId] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [ReportType] NVARCHAR(50) NOT NULL, -- 報表類型
    [ReportCode] NVARCHAR(50) NOT NULL, -- 報表代碼
    [TemplateName] NVARCHAR(200) NOT NULL, -- 模板名稱
    [TemplatePath] NVARCHAR(500) NULL, -- 模板路徑 (RDLC, Crystal Reports等)
    [TemplateType] NVARCHAR(20) NOT NULL, -- 模板類型 (RDLC, Crystal, HTML)
    [TemplateContent] NVARCHAR(MAX) NULL, -- 模板內容
    [IsDefault] BIT NOT NULL DEFAULT 0, -- 是否為預設模板
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1', -- 狀態 (1:啟用, 0:停用)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [UQ_PurchaseReportTemplates_ReportCode] UNIQUE ([ReportCode])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_PurchaseReportTemplates_ReportType] ON [dbo].[PurchaseReportTemplates] ([ReportType]);
CREATE NONCLUSTERED INDEX [IX_PurchaseReportTemplates_ReportCode] ON [dbo].[PurchaseReportTemplates] ([ReportCode]);
CREATE NONCLUSTERED INDEX [IX_PurchaseReportTemplates_Status] ON [dbo].[PurchaseReportTemplates] ([Status]);
```

#### 2.2.2 `PurchaseOrders` - 採購單主檔
```sql
-- 用於查詢採購單資料
-- 參考: `開發計劃/04-採購管理/SYSW315-訂退貨申請作業.md`
```

#### 2.2.3 `Vendors` - 供應商主檔
```sql
-- 用於查詢供應商資料
-- 參考: `開發計劃/02-基本資料管理/05-廠商客戶/SYSB206-廠客基本資料維護作業.md`
```

#### 2.2.4 `PaymentOrders` - 付款單主檔
```sql
-- 用於查詢付款單資料
-- 參考付款單相關功能
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| TKey | BIGINT | - | NO | IDENTITY(1,1) | 主鍵 | 自動遞增 |
| ReportType | NVARCHAR | 50 | NO | - | 報表類型 | PO:採購單, SU:供應商, PY:付款單 |
| ReportCode | NVARCHAR | 50 | NO | - | 報表代碼 | - |
| ReportName | NVARCHAR | 200 | NO | - | 報表名稱 | - |
| PrintDate | DATETIME2 | - | NO | GETDATE() | 列印日期 | - |
| PrintUserId | NVARCHAR | 50 | NO | - | 列印使用者 | 外鍵至Users表 |
| PrintUserName | NVARCHAR | 100 | YES | - | 列印使用者名稱 | - |
| FilterConditions | NVARCHAR(MAX) | - | YES | - | 篩選條件 | JSON格式 |
| PrintSettings | NVARCHAR(MAX) | - | YES | - | 列印設定 | JSON格式 |
| FileFormat | NVARCHAR | 20 | YES | 'PDF' | 檔案格式 | PDF, Excel |
| FilePath | NVARCHAR | 500 | YES | - | 檔案路徑 | - |
| FileName | NVARCHAR | 200 | YES | - | 檔案名稱 | - |
| FileSize | BIGINT | - | YES | - | 檔案大小 | bytes |
| Status | NVARCHAR | 10 | NO | 'S' | 狀態 | S:成功, F:失敗, P:處理中 |
| ErrorMessage | NVARCHAR(MAX) | - | YES | - | 錯誤訊息 | - |
| PageCount | INT | - | YES | 0 | 頁數 | - |
| RecordCount | INT | - | YES | 0 | 記錄數 | - |
| Notes | NVARCHAR | 500 | YES | - | 備註 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢採購報表列印記錄列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/purchase-report-prints`
- **說明**: 查詢採購報表列印記錄列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "PrintDate",
    "sortOrder": "DESC",
    "filters": {
      "reportType": "",
      "reportCode": "",
      "printUserId": "",
      "status": "",
      "startDate": "",
      "endDate": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "tKey": 1,
          "reportType": "PO",
          "reportTypeName": "採購單",
          "reportCode": "SYSP110",
          "reportName": "採購單報表",
          "printDate": "2024-01-01T10:00:00",
          "printUserId": "U001",
          "printUserName": "張三",
          "fileFormat": "PDF",
          "fileName": "採購單報表_20240101.pdf",
          "fileSize": 1024000,
          "status": "S",
          "statusName": "成功",
          "pageCount": 10,
          "recordCount": 100
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆採購報表列印記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/purchase-report-prints/{tKey}`
- **說明**: 根據主鍵查詢單筆採購報表列印記錄
- **路徑參數**:
  - `tKey`: 主鍵
- **回應格式**: 同查詢列表單筆資料

#### 3.1.3 新增採購報表列印記錄
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/purchase-report-prints`
- **說明**: 新增採購報表列印記錄
- **請求格式**:
  ```json
  {
    "reportType": "PO",
    "reportCode": "SYSP110",
    "reportName": "採購單報表",
    "filterConditions": {
      "orderId": "",
      "supplierId": "",
      "startDate": "2024-01-01",
      "endDate": "2024-01-31"
    },
    "printSettings": {
      "pageSize": "A4",
      "orientation": "Portrait",
      "margins": {
        "top": 20,
        "bottom": 20,
        "left": 20,
        "right": 20
      }
    },
    "fileFormat": "PDF"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "新增成功",
    "data": {
      "tKey": 1,
      "filePath": "/reports/purchase/SYSP110_20240101_001.pdf",
      "fileName": "採購單報表_20240101.pdf"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 修改採購報表列印記錄
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/purchase-report-prints/{tKey}`
- **說明**: 修改採購報表列印記錄（主要用於更新狀態、錯誤訊息等）
- **路徑參數**:
  - `tKey`: 主鍵
- **請求格式**: 同新增，但僅允許修改部分欄位
- **回應格式**: 同新增

#### 3.1.5 刪除採購報表列印記錄
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/purchase-report-prints/{tKey}`
- **說明**: 刪除採購報表列印記錄（軟刪除或硬刪除）
- **路徑參數**:
  - `tKey`: 主鍵
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.6 批次刪除採購報表列印記錄
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/purchase-report-prints/batch`
- **說明**: 批次刪除多筆採購報表列印記錄
- **請求格式**:
  ```json
  {
    "tKeys": [1, 2, 3]
  }
  ```

#### 3.1.7 下載報表檔案
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/purchase-report-prints/{tKey}/download`
- **說明**: 下載報表檔案
- **路徑參數**:
  - `tKey`: 主鍵
- **回應**: 檔案下載

#### 3.1.8 預覽報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/purchase-report-prints/preview`
- **說明**: 預覽報表（不保存記錄）
- **請求格式**: 同新增
- **回應格式**: 返回預覽資料（Base64編碼的PDF或圖片）

#### 3.1.9 取得報表模板列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/purchase-report-templates`
- **說明**: 取得報表模板列表
- **請求參數**:
  ```json
  {
    "reportType": "",
    "reportCode": ""
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": [
      {
        "templateId": 1,
        "reportType": "PO",
        "reportCode": "SYSP110",
        "templateName": "採購單報表模板",
        "templateType": "RDLC",
        "isDefault": true,
        "status": "1"
      }
    ],
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

### 3.2 後端實作類別

#### 3.2.1 Controller: `PurchaseReportPrintsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/purchase-report-prints")]
    [Authorize]
    public class PurchaseReportPrintsController : ControllerBase
    {
        private readonly IPurchaseReportPrintService _service;
        
        public PurchaseReportPrintsController(IPurchaseReportPrintService service)
        {
            _service = service;
        }
        
        [HttpGet]
        public async Task<ActionResult<ApiResponse<PagedResult<PurchaseReportPrintDto>>>> GetPurchaseReportPrints([FromQuery] PurchaseReportPrintQueryDto query)
        {
            // 實作查詢邏輯
        }
        
        [HttpGet("{tKey}")]
        public async Task<ActionResult<ApiResponse<PurchaseReportPrintDto>>> GetPurchaseReportPrint(long tKey)
        {
            // 實作查詢單筆邏輯
        }
        
        [HttpPost]
        public async Task<ActionResult<ApiResponse<PurchaseReportPrintResultDto>>> CreatePurchaseReportPrint([FromBody] CreatePurchaseReportPrintDto dto)
        {
            // 實作新增邏輯
        }
        
        [HttpPut("{tKey}")]
        public async Task<ActionResult<ApiResponse>> UpdatePurchaseReportPrint(long tKey, [FromBody] UpdatePurchaseReportPrintDto dto)
        {
            // 實作修改邏輯
        }
        
        [HttpDelete("{tKey}")]
        public async Task<ActionResult<ApiResponse>> DeletePurchaseReportPrint(long tKey)
        {
            // 實作刪除邏輯
        }
        
        [HttpGet("{tKey}/download")]
        public async Task<IActionResult> DownloadPurchaseReportPrint(long tKey)
        {
            // 實作下載邏輯
        }
        
        [HttpPost("preview")]
        public async Task<ActionResult<ApiResponse<ReportPreviewDto>>> PreviewPurchaseReportPrint([FromBody] CreatePurchaseReportPrintDto dto)
        {
            // 實作預覽邏輯
        }
    }
}
```

#### 3.2.2 Service: `PurchaseReportPrintService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface IPurchaseReportPrintService
    {
        Task<PagedResult<PurchaseReportPrintDto>> GetPurchaseReportPrintsAsync(PurchaseReportPrintQueryDto query);
        Task<PurchaseReportPrintDto> GetPurchaseReportPrintByIdAsync(long tKey);
        Task<PurchaseReportPrintResultDto> CreatePurchaseReportPrintAsync(CreatePurchaseReportPrintDto dto);
        Task UpdatePurchaseReportPrintAsync(long tKey, UpdatePurchaseReportPrintDto dto);
        Task DeletePurchaseReportPrintAsync(long tKey);
        Task<byte[]> DownloadPurchaseReportPrintAsync(long tKey);
        Task<ReportPreviewDto> PreviewPurchaseReportPrintAsync(CreatePurchaseReportPrintDto dto);
        Task<List<PurchaseReportTemplateDto>> GetPurchaseReportTemplatesAsync(string reportType, string reportCode);
    }
}
```

#### 3.2.3 Repository: `PurchaseReportPrintRepository.cs`
```csharp
namespace RSL.IMS3.Infrastructure.Data.Repositories
{
    public interface IPurchaseReportPrintRepository
    {
        Task<PurchaseReportPrint> GetByIdAsync(long tKey);
        Task<PagedResult<PurchaseReportPrint>> GetPagedAsync(PurchaseReportPrintQuery query);
        Task<PurchaseReportPrint> CreateAsync(PurchaseReportPrint entity);
        Task<PurchaseReportPrint> UpdateAsync(PurchaseReportPrint entity);
        Task DeleteAsync(long tKey);
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 採購報表列印頁面 (`PurchaseReportPrint.vue`)
- **路徑**: `/procurement/report-print`
- **功能**: 提供採購報表列印功能，支援報表選擇、篩選條件設定、列印預覽、列印執行
- **主要元件**:
  - 報表類型選擇 (ReportTypeSelect)
  - 篩選條件表單 (FilterForm)
  - 列印設定表單 (PrintSettingsForm)
  - 預覽區域 (PreviewArea)
  - 列印記錄列表 (PrintHistoryList)

#### 4.1.2 採購報表列印記錄頁面 (`PurchaseReportPrintHistory.vue`)
- **路徑**: `/procurement/report-print/history`
- **功能**: 顯示採購報表列印記錄列表，支援查詢、下載、刪除

### 4.2 UI 元件設計

#### 4.2.1 報表類型選擇元件 (`ReportTypeSelect.vue`)
```vue
<template>
  <el-form-item label="報表類型" prop="reportType">
    <el-select v-model="reportType" placeholder="請選擇報表類型" @change="handleReportTypeChange">
      <el-option label="採購單報表" value="PO" />
      <el-option label="供應商報表" value="SU" />
      <el-option label="付款單報表" value="PY" />
    </el-select>
  </el-form-item>
  <el-form-item label="報表代碼" prop="reportCode" v-if="reportType">
    <el-select v-model="reportCode" placeholder="請選擇報表代碼">
      <el-option 
        v-for="report in reportList" 
        :key="report.code" 
        :label="report.name" 
        :value="report.code" 
      />
    </el-select>
  </el-form-item>
</template>
```

#### 4.2.2 篩選條件表單元件 (`FilterForm.vue`)
```vue
<template>
  <el-form :model="filterForm" label-width="120px">
    <el-row :gutter="20">
      <el-col :span="12">
        <el-form-item label="採購單號" prop="orderId">
          <el-input v-model="filterForm.orderId" placeholder="請輸入採購單號" />
        </el-form-item>
      </el-col>
      <el-col :span="12">
        <el-form-item label="供應商" prop="supplierId">
          <el-select v-model="filterForm.supplierId" placeholder="請選擇供應商" filterable>
            <el-option 
              v-for="supplier in supplierList" 
              :key="supplier.supplierId" 
              :label="supplier.supplierName" 
              :value="supplier.supplierId" 
            />
          </el-select>
        </el-form-item>
      </el-col>
    </el-row>
    <el-row :gutter="20">
      <el-col :span="12">
        <el-form-item label="開始日期" prop="startDate">
          <el-date-picker 
            v-model="filterForm.startDate" 
            type="date" 
            placeholder="請選擇開始日期" 
            format="YYYY-MM-DD"
            value-format="YYYY-MM-DD"
          />
        </el-form-item>
      </el-col>
      <el-col :span="12">
        <el-form-item label="結束日期" prop="endDate">
          <el-date-picker 
            v-model="filterForm.endDate" 
            type="date" 
            placeholder="請選擇結束日期" 
            format="YYYY-MM-DD"
            value-format="YYYY-MM-DD"
          />
        </el-form-item>
      </el-col>
    </el-row>
  </el-form>
</template>
```

#### 4.2.3 列印設定表單元件 (`PrintSettingsForm.vue`)
```vue
<template>
  <el-form :model="printSettings" label-width="120px">
    <el-form-item label="檔案格式" prop="fileFormat">
      <el-radio-group v-model="printSettings.fileFormat">
        <el-radio label="PDF">PDF</el-radio>
        <el-radio label="Excel">Excel</el-radio>
      </el-radio-group>
    </el-form-item>
    <el-form-item label="頁面大小" prop="pageSize">
      <el-select v-model="printSettings.pageSize">
        <el-option label="A4" value="A4" />
        <el-option label="A3" value="A3" />
        <el-option label="Letter" value="Letter" />
      </el-select>
    </el-form-item>
    <el-form-item label="方向" prop="orientation">
      <el-radio-group v-model="printSettings.orientation">
        <el-radio label="Portrait">直向</el-radio>
        <el-radio label="Landscape">橫向</el-radio>
      </el-radio-group>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.4 預覽區域元件 (`PreviewArea.vue`)
```vue
<template>
  <div class="preview-area">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>報表預覽</span>
          <el-button type="primary" size="small" @click="handlePreview">預覽</el-button>
        </div>
      </template>
      <div v-loading="loading" class="preview-content">
        <iframe 
          v-if="previewUrl" 
          :src="previewUrl" 
          class="preview-iframe"
        />
        <el-empty v-else description="請點擊預覽按鈕進行預覽" />
      </div>
    </el-card>
  </div>
</template>
```

#### 4.2.5 列印記錄列表元件 (`PrintHistoryList.vue`)
```vue
<template>
  <div>
    <el-table :data="printHistoryList" v-loading="loading">
      <el-table-column prop="reportName" label="報表名稱" width="200" />
      <el-table-column prop="reportTypeName" label="報表類型" width="120" />
      <el-table-column prop="printDate" label="列印日期" width="160" />
      <el-table-column prop="printUserName" label="列印人員" width="120" />
      <el-table-column prop="fileFormat" label="檔案格式" width="100" />
      <el-table-column prop="fileSize" label="檔案大小" width="120">
        <template #default="{ row }">
          {{ formatFileSize(row.fileSize) }}
        </template>
      </el-table-column>
      <el-table-column prop="statusName" label="狀態" width="100">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)">
            {{ row.statusName }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="200" fixed="right">
        <template #default="{ row }">
          <el-button type="primary" size="small" @click="handleDownload(row)">下載</el-button>
          <el-button type="danger" size="small" @click="handleDelete(row)">刪除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

### 4.3 API 呼叫 (`purchaseReportPrint.api.ts`)
```typescript
import request from '@/utils/request';

export interface PurchaseReportPrintDto {
  tKey: number;
  reportType: string;
  reportTypeName: string;
  reportCode: string;
  reportName: string;
  printDate: string;
  printUserId: string;
  printUserName: string;
  fileFormat: string;
  fileName: string;
  fileSize: number;
  status: string;
  statusName: string;
  pageCount: number;
  recordCount: number;
}

export interface PurchaseReportPrintQueryDto {
  pageIndex: number;
  pageSize: number;
  sortField?: string;
  sortOrder?: 'ASC' | 'DESC';
  filters?: {
    reportType?: string;
    reportCode?: string;
    printUserId?: string;
    status?: string;
    startDate?: string;
    endDate?: string;
  };
}

export interface CreatePurchaseReportPrintDto {
  reportType: string;
  reportCode: string;
  reportName: string;
  filterConditions: Record<string, any>;
  printSettings: {
    pageSize: string;
    orientation: string;
    margins?: {
      top: number;
      bottom: number;
      left: number;
      right: number;
    };
  };
  fileFormat: string;
}

export interface PurchaseReportPrintResultDto {
  tKey: number;
  filePath: string;
  fileName: string;
}

// API 函數
export const getPurchaseReportPrintList = (query: PurchaseReportPrintQueryDto) => {
  return request.get<ApiResponse<PagedResult<PurchaseReportPrintDto>>>('/api/v1/purchase-report-prints', { params: query });
};

export const getPurchaseReportPrintById = (tKey: number) => {
  return request.get<ApiResponse<PurchaseReportPrintDto>>(`/api/v1/purchase-report-prints/${tKey}`);
};

export const createPurchaseReportPrint = (data: CreatePurchaseReportPrintDto) => {
  return request.post<ApiResponse<PurchaseReportPrintResultDto>>('/api/v1/purchase-report-prints', data);
};

export const updatePurchaseReportPrint = (tKey: number, data: Partial<CreatePurchaseReportPrintDto>) => {
  return request.put<ApiResponse>(`/api/v1/purchase-report-prints/${tKey}`, data);
};

export const deletePurchaseReportPrint = (tKey: number) => {
  return request.delete<ApiResponse>(`/api/v1/purchase-report-prints/${tKey}`);
};

export const downloadPurchaseReportPrint = (tKey: number) => {
  return request.get(`/api/v1/purchase-report-prints/${tKey}/download`, {
    responseType: 'blob'
  });
};

export const previewPurchaseReportPrint = (data: CreatePurchaseReportPrintDto) => {
  return request.post<ApiResponse<ReportPreviewDto>>('/api/v1/purchase-report-prints/preview', data);
};

export const getPurchaseReportTemplates = (reportType?: string, reportCode?: string) => {
  return request.get<ApiResponse<PurchaseReportTemplateDto[]>>('/api/v1/purchase-report-templates', {
    params: { reportType, reportCode }
  });
};
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (1天)
- [ ] 建立資料表結構
- [ ] 建立索引
- [ ] 建立外鍵約束
- [ ] 建立預設值
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (4天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作（包含報表生成邏輯）
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 報表模板管理
- [ ] 報表生成服務（RDLC/Crystal Reports）
- [ ] 檔案儲存服務
- [ ] 驗證邏輯實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (4天)
- [ ] API 呼叫函數
- [ ] 報表列印頁面開發
- [ ] 報表類型選擇元件
- [ ] 篩選條件表單元件
- [ ] 列印設定表單元件
- [ ] 預覽區域元件
- [ ] 列印記錄列表頁面
- [ ] 表單驗證
- [ ] 元件測試

### 5.4 階段四: 整合測試 (2天)
- [ ] API 整合測試
- [ ] 報表生成測試
- [ ] 檔案下載測試
- [ ] 預覽功能測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 安全性測試

### 5.5 階段五: 文件與部署 (1天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 12天

---

## 六、注意事項

### 6.1 安全性
- 報表檔案必須安全儲存
- 報表下載必須驗證權限
- 敏感資料必須加密傳輸 (HTTPS)
- 必須實作權限檢查
- 報表檔案必須定期清理

### 6.2 效能
- 大量資料報表必須使用分頁
- 報表生成必須使用非同步處理
- 報表檔案必須使用快取機制
- 報表生成必須使用佇列處理（大量資料時）

### 6.3 資料驗證
- 篩選條件必須驗證
- 報表類型必須驗證
- 報表代碼必須驗證
- 日期範圍必須驗證

### 6.4 業務邏輯
- 報表生成前必須檢查資料是否存在
- 報表生成失敗必須記錄錯誤訊息
- 報表檔案必須定期清理（保留期限設定）
- 報表列印記錄必須記錄操作人員

### 6.5 報表模板
- 支援多種報表模板格式（RDLC、Crystal Reports、HTML）
- 支援報表模板動態載入
- 支援報表模板版本管理
- 支援報表模板預覽

---

## 七、測試案例

### 7.1 單元測試
- [ ] 新增報表列印記錄成功
- [ ] 新增報表列印記錄失敗（參數錯誤）
- [ ] 查詢報表列印記錄列表成功
- [ ] 查詢單筆報表列印記錄成功
- [ ] 修改報表列印記錄成功
- [ ] 刪除報表列印記錄成功
- [ ] 下載報表檔案成功
- [ ] 預覽報表成功

### 7.2 整合測試
- [ ] 完整報表列印流程測試
- [ ] 報表生成測試（不同報表類型）
- [ ] 檔案下載測試
- [ ] 預覽功能測試
- [ ] 權限檢查測試
- [ ] 資料驗證測試
- [ ] 錯誤處理測試

### 7.3 效能測試
- [ ] 大量資料報表生成測試
- [ ] 並發報表生成測試
- [ ] 報表檔案下載效能測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ASP/SYSP000/SYSP110_PR.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP120_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP130_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP140_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP150_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP210_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP225_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP276_PR.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP462_PR.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP4B0_PR.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP4G0_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP4H0_PR.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP491_PR.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP491_PR2.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSP520_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSPA15_PR.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSPB10_PR.ASP`
- `WEB/IMS_CORE/ASP/SYSP000/SYSPB25_PR.asp`
- `WEB/IMS_CORE/ASP/SYSP000/SYSPB60_PR.ASP`

### 8.2 資料庫 Schema
- 參考採購相關資料表設計
- 參考報表相關資料表設計

### 8.3 相關功能
- `開發計劃/10-報表管理/01-業務報表/SYSL150-業務報表列印作業.md`
- `開發計劃/14-報表擴展/SYS7B10-報表列印作業.md`
- `開發計劃/22-核心功能類/03-資料維護功能/IMS30_PR-資料列印功能.md`

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

