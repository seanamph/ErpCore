# SYS7B30 - 報表列印作業 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS7B30
- **功能名稱**: 報表列印作業
- **功能描述**: 提供報表模組7的報表列印功能，使用Crystal Reports進行報表列印，支援PDF格式列印、報表預覽、列印設定等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYS7000/SYS7B30.ascx` (使用者控制項)

### 1.2 業務需求
- 提供報表列印功能
- 支援PDF格式列印
- 支援報表預覽
- 支援列印設定（頁面大小、邊界等）
- 支援報表資料查詢與篩選
- 記錄報表列印記錄
- 支援報表匯出

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `ReportPrints` (報表列印記錄)
參考 `SYS7B10-報表列印作業.md` 的 `ReportPrints` 資料表設計，使用相同的資料表結構，透過 `ReportCode` 欄位區分不同報表。

### 2.2 相關資料表

#### 2.2.1 `ReportQueries` - 報表查詢設定
- 參考: `開發計劃/14-報表擴展/SYS7000-報表模組7-報表查詢.md`

#### 2.2.2 `ReportPrintDetails` - 報表列印明細
參考 `SYS7B10-報表列印作業.md` 的 `ReportPrintDetails` 資料表設計

### 2.3 資料字典
參考 `SYS7B10-報表列印作業.md` 的資料字典

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢報表列印記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/reports/sys7000/sys7b30/prints`
- **說明**: 查詢報表列印記錄列表，支援分頁、排序、篩選
- **請求參數**: 參考 `SYS7B10-報表列印作業.md`
- **回應格式**: 參考 `SYS7B10-報表列印作業.md`

#### 3.1.2 執行報表列印
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/reports/sys7000/sys7b30/print`
- **說明**: 執行報表列印，產生PDF檔案
- **請求格式**: 參考 `SYS7B10-報表列印作業.md`
- **回應格式**: 參考 `SYS7B10-報表列印作業.md`

#### 3.1.3 查詢單筆報表列印記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/reports/sys7000/sys7b30/prints/{printId}`
- **說明**: 根據列印ID查詢單筆報表列印記錄

#### 3.1.4 下載報表檔案
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/reports/sys7000/sys7b30/prints/{printId}/download`
- **說明**: 下載報表檔案

#### 3.1.5 預覽報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/reports/sys7000/sys7b30/preview`
- **說明**: 預覽報表（不產生檔案，直接返回預覽資料）

#### 3.1.6 刪除報表列印記錄
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/reports/sys7000/sys7b30/prints/{printId}`
- **說明**: 刪除報表列印記錄及相關檔案

---

## 四、前端 UI 設計

### 4.1 報表列印頁面 (`SYS7B30Print.vue`)

#### 4.1.1 頁面結構
參考 `SYS7B10-報表列印作業.md` 的前端 UI 設計，將報表代碼改為 `SYS7B30`

#### 4.1.2 腳本邏輯
參考 `SYS7B10-報表列印作業.md` 的腳本邏輯，將報表代碼改為 `SYS7B30`

---

## 五、後端實作

### 5.1 Controller (`SYS7B30ReportPrintController.cs`)
參考 `SYS7B10-報表列印作業.md` 的 Controller 設計，將報表代碼改為 `SYS7B30`

### 5.2 Service (`ReportPrintService.cs`)
參考 `SYS7B10-報表列印作業.md` 的 Service 設計，使用相同的 Service，透過報表代碼區分不同報表

---

## 六、開發時程

### 6.1 開發階段
1. **資料庫設計** (0.5 天)
   - 使用現有的 ReportPrints 資料表
   - 確認索引設定

2. **後端 API 開發** (2 天)
   - 實作 Controller 層（參考 SYS7B10）
   - 實作報表資料查詢邏輯
   - 單元測試

3. **前端 UI 開發** (1.5 天)
   - 報表列印頁面（參考 SYS7B10）
   - 報表預覽功能
   - 整合測試

4. **測試與優化** (0.5 天)
   - 功能測試
   - 效能測試
   - Bug 修復

**總計**: 4.5 天

---

## 七、注意事項

### 7.1 報表產生
- 使用 RDLC (Report Definition Language Client) 或 iTextSharp 產生 PDF
- 支援多種報表格式（PDF、Excel、Word）
- 注意報表資料量，避免記憶體溢出

### 7.2 檔案管理
- 報表檔案需儲存在安全的目錄
- 定期清理過期的報表檔案
- 檔案下載需驗證權限

### 7.3 效能優化
- 大量資料時使用分頁查詢
- 報表產生使用非同步處理
- 考慮使用背景任務處理報表產生

### 7.4 安全性
- 驗證使用者權限
- 防止路徑遍歷攻擊
- 檔案下載需驗證權限
- 記錄報表列印操作

---

## 八、測試案例

### 8.1 功能測試
1. **列印測試**
   - 正常列印報表
   - 不同格式列印（PDF、Excel）
   - 大量資料列印

2. **預覽測試**
   - 報表預覽功能
   - 預覽資料正確性

3. **查詢測試**
   - 依日期範圍查詢
   - 依狀態查詢
   - 分頁查詢

4. **下載測試**
   - 檔案下載功能
   - 檔案完整性驗證

5. **刪除測試**
   - 刪除列印記錄
   - 刪除相關檔案

### 8.2 效能測試
- 大量資料列印效能
- 並發列印測試

### 8.3 安全性測試
- 權限驗證測試
- 檔案下載權限測試

