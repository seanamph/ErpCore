# SYS7000 - 報表模組7-報表查詢 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS7A00-SYS7A60
- **功能名稱**: 報表模組7-報表查詢
- **功能描述**: 提供報表模組7的報表查詢功能，包含多種報表查詢類型（SYS7A00-SYS7A60），支援條件查詢、資料篩選、報表預覽等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/SYS7000/SYS7A00.ascx` - SYS7A00 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A10.ascx` - SYS7A10 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A21.ascx` - SYS7A21 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A22.ascx` - SYS7A22 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A23.ascx` - SYS7A23 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A24.ascx` - SYS7A24 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A25.ascx` - SYS7A25 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A30.ascx` - SYS7A30 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A40.ascx` - SYS7A40 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A50.ascx` - SYS7A50 報表查詢
  - `WEB/IMS_CORE/SYS7000/SYS7A60.ascx` - SYS7A60 報表查詢
  - `WEB/IMS_CORE/ASP/SYS7000/` - ASP 版本的報表查詢功能

### 1.2 業務需求
- 提供多種報表查詢功能（SYS7A00-SYS7A60）
- 支援條件查詢與資料篩選
- 支援報表資料預覽
- 支援報表資料匯出（Excel、PDF）
- 支援報表列印
- 支援報表資料統計
- 支援多種報表格式

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `ReportQueries` (報表查詢設定)

```sql
CREATE TABLE [dbo].[ReportQueries] (
    [QueryId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [ReportCode] NVARCHAR(50) NOT NULL, -- 報表代碼 (SYS7A00-SYS7A60)
    [ReportName] NVARCHAR(200) NOT NULL, -- 報表名稱
    [QueryName] NVARCHAR(200) NULL, -- 查詢名稱
    [QueryParams] NVARCHAR(MAX) NULL, -- 查詢參數 (JSON格式)
    [QuerySql] NVARCHAR(MAX) NULL, -- 查詢SQL
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1', -- 狀態 (1:啟用, 0:停用)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_ReportQueries] PRIMARY KEY CLUSTERED ([QueryId] ASC)
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ReportQueries_ReportCode] ON [dbo].[ReportQueries] ([ReportCode]);
CREATE NONCLUSTERED INDEX [IX_ReportQueries_Status] ON [dbo].[ReportQueries] ([Status]);
```

### 2.2 相關資料表

#### 2.2.1 `ReportQueryLogs` - 報表查詢記錄
```sql
CREATE TABLE [dbo].[ReportQueryLogs] (
    [LogId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [QueryId] UNIQUEIDENTIFIER NULL,
    [ReportCode] NVARCHAR(50) NOT NULL,
    [UserId] NVARCHAR(50) NOT NULL,
    [QueryParams] NVARCHAR(MAX) NULL,
    [QueryTime] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [ExecutionTime] INT NULL, -- 執行時間(毫秒)
    [RecordCount] INT NULL, -- 記錄數
    [Status] NVARCHAR(10) NOT NULL DEFAULT '1', -- 狀態
    CONSTRAINT [FK_ReportQueryLogs_ReportQueries] FOREIGN KEY ([QueryId]) REFERENCES [dbo].[ReportQueries] ([QueryId]),
    CONSTRAINT [FK_ReportQueryLogs_Users] FOREIGN KEY ([UserId]) REFERENCES [dbo].[Users] ([UserId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_ReportQueryLogs_ReportCode] ON [dbo].[ReportQueryLogs] ([ReportCode]);
CREATE NONCLUSTERED INDEX [IX_ReportQueryLogs_UserId] ON [dbo].[ReportQueryLogs] ([UserId]);
CREATE NONCLUSTERED INDEX [IX_ReportQueryLogs_QueryTime] ON [dbo].[ReportQueryLogs] ([QueryTime]);
```

### 2.3 資料字典

#### ReportQueries 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| QueryId | UNIQUEIDENTIFIER | - | NO | NEWID() | 查詢ID | 主鍵 |
| ReportCode | NVARCHAR | 50 | NO | - | 報表代碼 | SYS7A00-SYS7A60 |
| ReportName | NVARCHAR | 200 | NO | - | 報表名稱 | - |
| QueryName | NVARCHAR | 200 | YES | - | 查詢名稱 | - |
| QueryParams | NVARCHAR(MAX) | - | YES | - | 查詢參數 | JSON格式 |
| QuerySql | NVARCHAR(MAX) | - | YES | - | 查詢SQL | - |
| Status | NVARCHAR | 10 | NO | '1' | 狀態 | 1:啟用, 0:停用 |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢報表列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/reports/sys7000`
- **說明**: 查詢報表模組7的報表列表
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "reportCode": "",
    "status": ""
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "reportCode": "SYS7A00",
          "reportName": "報表查詢A00",
          "status": "1",
          "createdAt": "2024-01-01T00:00:00"
        }
      ],
      "totalCount": 10,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 1
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 執行報表查詢
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/reports/sys7000/{reportCode}/query`
- **說明**: 執行報表查詢
- **路徑參數**:
  - `reportCode`: 報表代碼 (SYS7A00-SYS7A60)
- **請求格式**:
  ```json
  {
    "queryParams": {
      "dateFrom": "2024-01-01",
      "dateTo": "2024-12-31",
      "shopId": "",
      "status": ""
    },
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "",
    "sortOrder": "ASC"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [...],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5,
      "executionTime": 150
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 匯出報表資料
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/reports/sys7000/{reportCode}/export`
- **說明**: 匯出報表資料（Excel、PDF）
- **請求格式**:
  ```json
  {
    "queryParams": {...},
    "exportFormat": "Excel", // Excel, PDF
    "fileName": "報表名稱"
  }
  ```

#### 3.1.4 查詢報表查詢記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/reports/sys7000/query-logs`
- **說明**: 查詢報表查詢記錄
- **請求參數**: 支援分頁、篩選

### 3.2 後端實作類別

#### 3.2.1 Controller: `Sys7000ReportsController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/reports/sys7000")]
    [Authorize]
    public class Sys7000ReportsController : ControllerBase
    {
        private readonly ISys7000ReportService _reportService;
        
        public Sys7000ReportsController(ISys7000ReportService reportService)
        {
            _reportService = reportService;
        }
        
        [HttpGet]
        public async Task<IActionResult> GetReports([FromQuery] ReportQueryRequest request)
        {
            var result = await _reportService.GetReportsAsync(request);
            return Ok(result);
        }
        
        [HttpPost("{reportCode}/query")]
        public async Task<IActionResult> QueryReport(string reportCode, [FromBody] ReportQueryParams request)
        {
            var result = await _reportService.QueryReportAsync(reportCode, request);
            return Ok(result);
        }
        
        [HttpPost("{reportCode}/export")]
        public async Task<IActionResult> ExportReport(string reportCode, [FromBody] ReportExportRequest request)
        {
            var file = await _reportService.ExportReportAsync(reportCode, request);
            return File(file.Content, file.ContentType, file.FileName);
        }
    }
}
```

#### 3.2.2 Service: `Sys7000ReportService.cs`
```csharp
namespace RSL.IMS3.Application.Services
{
    public interface ISys7000ReportService
    {
        Task<PagedResult<ReportDto>> GetReportsAsync(ReportQueryRequest request);
        Task<ReportQueryResult> QueryReportAsync(string reportCode, ReportQueryParams request);
        Task<ExportFile> ExportReportAsync(string reportCode, ReportExportRequest request);
    }
    
    public class Sys7000ReportService : ISys7000ReportService
    {
        private readonly IReportQueryRepository _repository;
        private readonly IDapperRepository _dapper;
        
        // 實作方法...
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 報表查詢頁面 (`/reports/sys7000`)
- **路由**: `/reports/sys7000`
- **組件**: `Sys7000ReportQuery.vue`
- **功能**:
  - 報表列表顯示
  - 報表選擇
  - 查詢條件設定
  - 查詢結果顯示
  - 報表匯出
  - 報表列印

### 4.2 UI 組件設計

#### 4.2.1 報表選擇器 (`ReportSelector.vue`)
```vue
<template>
  <el-select v-model="selectedReport" placeholder="請選擇報表">
    <el-option
      v-for="report in reports"
      :key="report.reportCode"
      :label="report.reportName"
      :value="report.reportCode"
    />
  </el-select>
</template>
```

#### 4.2.2 查詢條件表單 (`QueryForm.vue`)
```vue
<template>
  <el-form :model="queryParams" label-width="120px">
    <el-form-item label="日期起">
      <el-date-picker v-model="queryParams.dateFrom" type="date" />
    </el-form-item>
    <el-form-item label="日期迄">
      <el-date-picker v-model="queryParams.dateTo" type="date" />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleQuery">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.3 查詢結果表格 (`QueryResultTable.vue`)
```vue
<template>
  <el-table :data="tableData" border stripe>
    <el-table-column
      v-for="column in columns"
      :key="column.prop"
      :prop="column.prop"
      :label="column.label"
      :width="column.width"
    />
  </el-table>
  <el-pagination
    v-model:current-page="pageIndex"
    v-model:page-size="pageSize"
    :total="totalCount"
    layout="total, sizes, prev, pager, next, jumper"
    @size-change="handleSizeChange"
    @current-change="handlePageChange"
  />
</template>
```

### 4.3 頁面流程

1. **進入報表查詢頁面**
   - 顯示報表列表
   - 選擇報表

2. **設定查詢條件**
   - 根據報表類型顯示對應的查詢條件
   - 輸入查詢參數

3. **執行查詢**
   - 呼叫 API 執行查詢
   - 顯示查詢結果

4. **操作結果**
   - 匯出報表（Excel、PDF）
   - 列印報表
   - 重新查詢

---

## 五、開發任務清單

### 5.1 資料庫開發
- [ ] 建立 `ReportQueries` 資料表
- [ ] 建立 `ReportQueryLogs` 資料表
- [ ] 建立相關索引
- [ ] 建立資料遷移腳本

### 5.2 後端開發
- [ ] 建立 `Sys7000ReportsController`
- [ ] 建立 `ISys7000ReportService` 介面
- [ ] 實作 `Sys7000ReportService`
- [ ] 建立 `IReportQueryRepository` 介面
- [ ] 實作 `ReportQueryRepository` (Dapper)
- [ ] 建立 DTO 類別
- [ ] 建立查詢邏輯（各報表類型）

### 5.3 前端開發
- [ ] 建立 `Sys7000ReportQuery.vue` 頁面
- [ ] 建立 `ReportSelector.vue` 組件
- [ ] 建立 `QueryForm.vue` 組件
- [ ] 建立 `QueryResultTable.vue` 組件
- [ ] 建立 API 服務 (`reportApi.ts`)
- [ ] 建立 Store (`reportStore.ts`)
- [ ] 建立路由設定

### 5.4 測試
- [ ] 單元測試（後端）
- [ ] 單元測試（前端）
- [ ] 整合測試
- [ ] E2E 測試

---

## 六、注意事項

1. **報表類型多樣性**: SYS7A00-SYS7A60 包含多種報表類型，需要針對每種報表類型實作對應的查詢邏輯
2. **查詢效能**: 報表查詢可能涉及大量資料，需要優化查詢效能，考慮使用快取機制
3. **查詢參數驗證**: 需要對查詢參數進行嚴格驗證，防止 SQL 注入
4. **權限控制**: 需要實作報表查詢的權限控制
5. **查詢記錄**: 記錄報表查詢記錄，用於審計和效能分析

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

