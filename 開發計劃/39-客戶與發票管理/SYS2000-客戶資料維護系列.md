# SYS2000 - 客戶資料維護系列 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS2000 系列
- **功能名稱**: 客戶資料維護系列
- **功能描述**: 提供客戶基本資料的新增、修改、刪除、查詢功能，包含客戶編號、客戶名稱、聯絡資訊、地址、付款條件等資訊管理
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2150_FI.ASP` (新增)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2150_FU.ASP` (修改)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2150_FD.ASP` (刪除)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2150_FQ.ASP` (查詢)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2150_FB.ASP` (瀏覽)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2150_PR.ASP` (報表)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2210_*.ASP` (財務憑證處理)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2310_*.ASP` (財務憑證錯誤處理)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2401_*.ASP` (財務憑證系列)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2410_*.ASP` (財務憑證處理)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS24A1_*.ASP` (財務憑證擴展功能)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2501_*.ASP` (財務憑證報表功能)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2610_*.ASP` (財務憑證瀏覽)

### 1.2 業務需求
- 管理客戶基本資料
- 支援客戶編號唯一性檢查
- 支援客戶分類管理
- 支援客戶聯絡人管理
- 支援客戶地址管理（多地址）
- 支援客戶付款條件設定
- 支援客戶信用額度管理
- 支援客戶稅務資訊管理
- 支援客戶銀行帳戶資訊管理
- 支援客戶歷史記錄查詢
- 支援客戶報表列印

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Customers` (客戶主檔)

```sql
CREATE TABLE [dbo].[Customers] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [CustomerId] NVARCHAR(50) NOT NULL, -- 客戶編號 (CUST_ID)
    [CustomerName] NVARCHAR(200) NOT NULL, -- 客戶名稱 (CUST_NAME)
    [CustomerType] NVARCHAR(20) NULL, -- 客戶類型 (CUST_TYPE, C:客戶, V:廠商)
    [TaxId] NVARCHAR(20) NULL, -- 統一編號 (TAX_ID)
    [ContactPerson] NVARCHAR(100) NULL, -- 聯絡人 (CONTACT_PERSON)
    [ContactPhone] NVARCHAR(50) NULL, -- 聯絡電話 (CONTACT_PHONE)
    [ContactEmail] NVARCHAR(100) NULL, -- 聯絡信箱 (CONTACT_EMAIL)
    [ContactFax] NVARCHAR(50) NULL, -- 傳真號碼 (CONTACT_FAX)
    [Address] NVARCHAR(500) NULL, -- 地址 (ADDRESS)
    [CityId] NVARCHAR(50) NULL, -- 城市代碼 (CITY_ID)
    [ZoneId] NVARCHAR(50) NULL, -- 區域代碼 (ZONE_ID)
    [ZipCode] NVARCHAR(10) NULL, -- 郵遞區號 (ZIP_CODE)
    [PaymentTerm] NVARCHAR(20) NULL, -- 付款條件 (PAYMENT_TERM)
    [CreditLimit] DECIMAL(18, 4) NULL DEFAULT 0, -- 信用額度 (CREDIT_LIMIT)
    [CurrencyId] NVARCHAR(10) NULL DEFAULT 'TWD', -- 幣別 (CURRENCY_ID)
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'A', -- 狀態 (STATUS, A:啟用, I:停用)
    [Memo] NVARCHAR(1000) NULL, -- 備註 (MEMO)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Customers] PRIMARY KEY CLUSTERED ([TKey] ASC),
    CONSTRAINT [UQ_Customers_CustomerId] UNIQUE ([CustomerId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_Customers_CustomerId] ON [dbo].[Customers] ([CustomerId]);
CREATE NONCLUSTERED INDEX [IX_Customers_CustomerName] ON [dbo].[Customers] ([CustomerName]);
CREATE NONCLUSTERED INDEX [IX_Customers_TaxId] ON [dbo].[Customers] ([TaxId]);
CREATE NONCLUSTERED INDEX [IX_Customers_CustomerType] ON [dbo].[Customers] ([CustomerType]);
CREATE NONCLUSTERED INDEX [IX_Customers_Status] ON [dbo].[Customers] ([Status]);
```

### 2.2 相關資料表

#### 2.2.1 `CustomerContacts` - 客戶聯絡人
```sql
CREATE TABLE [dbo].[CustomerContacts] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [CustomerId] NVARCHAR(50) NOT NULL, -- 客戶編號
    [ContactName] NVARCHAR(100) NOT NULL, -- 聯絡人姓名
    [ContactTitle] NVARCHAR(50) NULL, -- 職稱
    [ContactPhone] NVARCHAR(50) NULL, -- 電話
    [ContactMobile] NVARCHAR(50) NULL, -- 手機
    [ContactEmail] NVARCHAR(100) NULL, -- 信箱
    [ContactFax] NVARCHAR(50) NULL, -- 傳真
    [IsPrimary] BIT NULL DEFAULT 0, -- 是否主要聯絡人
    [Memo] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_CustomerContacts_Customers] FOREIGN KEY ([CustomerId]) REFERENCES [dbo].[Customers] ([CustomerId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_CustomerContacts_CustomerId] ON [dbo].[CustomerContacts] ([CustomerId]);
```

#### 2.2.2 `CustomerAddresses` - 客戶地址
```sql
CREATE TABLE [dbo].[CustomerAddresses] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [CustomerId] NVARCHAR(50) NOT NULL, -- 客戶編號
    [AddressType] NVARCHAR(20) NOT NULL, -- 地址類型 (BILLING:帳單地址, SHIPPING:送貨地址, REGISTERED:登記地址)
    [Address] NVARCHAR(500) NOT NULL, -- 地址
    [CityId] NVARCHAR(50) NULL, -- 城市代碼
    [ZoneId] NVARCHAR(50) NULL, -- 區域代碼
    [ZipCode] NVARCHAR(10) NULL, -- 郵遞區號
    [IsDefault] BIT NULL DEFAULT 0, -- 是否預設地址
    [Memo] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_CustomerAddresses_Customers] FOREIGN KEY ([CustomerId]) REFERENCES [dbo].[Customers] ([CustomerId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_CustomerAddresses_CustomerId] ON [dbo].[CustomerAddresses] ([CustomerId]);
CREATE NONCLUSTERED INDEX [IX_CustomerAddresses_AddressType] ON [dbo].[CustomerAddresses] ([AddressType]);
```

#### 2.2.3 `CustomerBankAccounts` - 客戶銀行帳戶
```sql
CREATE TABLE [dbo].[CustomerBankAccounts] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [CustomerId] NVARCHAR(50) NOT NULL, -- 客戶編號
    [BankId] NVARCHAR(50) NOT NULL, -- 銀行代碼
    [AccountNo] NVARCHAR(50) NOT NULL, -- 帳號
    [AccountName] NVARCHAR(200) NULL, -- 戶名
    [IsDefault] BIT NULL DEFAULT 0, -- 是否預設帳戶
    [Memo] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_CustomerBankAccounts_Customers] FOREIGN KEY ([CustomerId]) REFERENCES [dbo].[Customers] ([CustomerId]) ON DELETE CASCADE,
    CONSTRAINT [FK_CustomerBankAccounts_Banks] FOREIGN KEY ([BankId]) REFERENCES [dbo].[Banks] ([BankId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_CustomerBankAccounts_CustomerId] ON [dbo].[CustomerBankAccounts] ([CustomerId]);
```

### 2.3 資料字典

#### 2.3.1 Customers 資料表

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| TKey | BIGINT | - | NO | IDENTITY | 主鍵 | 自動遞增 |
| CustomerId | NVARCHAR | 50 | NO | - | 客戶編號 | 唯一，CUST_ID |
| CustomerName | NVARCHAR | 200 | NO | - | 客戶名稱 | CUST_NAME |
| CustomerType | NVARCHAR | 20 | YES | - | 客戶類型 | C:客戶, V:廠商 |
| TaxId | NVARCHAR | 20 | YES | - | 統一編號 | TAX_ID |
| ContactPerson | NVARCHAR | 100 | YES | - | 聯絡人 | CONTACT_PERSON |
| ContactPhone | NVARCHAR | 50 | YES | - | 聯絡電話 | CONTACT_PHONE |
| ContactEmail | NVARCHAR | 100 | YES | - | 聯絡信箱 | CONTACT_EMAIL |
| ContactFax | NVARCHAR | 50 | YES | - | 傳真號碼 | CONTACT_FAX |
| Address | NVARCHAR | 500 | YES | - | 地址 | ADDRESS |
| CityId | NVARCHAR | 50 | YES | - | 城市代碼 | CITY_ID |
| ZoneId | NVARCHAR | 50 | YES | - | 區域代碼 | ZONE_ID |
| ZipCode | NVARCHAR | 10 | YES | - | 郵遞區號 | ZIP_CODE |
| PaymentTerm | NVARCHAR | 20 | YES | - | 付款條件 | PAYMENT_TERM |
| CreditLimit | DECIMAL | 18,4 | YES | 0 | 信用額度 | CREDIT_LIMIT |
| CurrencyId | NVARCHAR | 10 | YES | 'TWD' | 幣別 | CURRENCY_ID |
| Status | NVARCHAR | 10 | NO | 'A' | 狀態 | A:啟用, I:停用 |
| Memo | NVARCHAR | 1000 | YES | - | 備註 | MEMO |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢客戶列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/customers`
- **說明**: 查詢客戶列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "CustomerId",
    "sortOrder": "ASC",
    "filters": {
      "customerId": "",
      "customerName": "",
      "customerType": "",
      "taxId": "",
      "status": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "tKey": 1,
          "customerId": "C001",
          "customerName": "測試客戶",
          "customerType": "C",
          "taxId": "12345678",
          "contactPerson": "張三",
          "contactPhone": "02-12345678",
          "status": "A"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆客戶
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/customers/{customerId}`
- **說明**: 根據客戶編號查詢單筆客戶資料（包含聯絡人、地址、銀行帳戶）
- **路徑參數**:
  - `customerId`: 客戶編號
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "tKey": 1,
      "customerId": "C001",
      "customerName": "測試客戶",
      "customerType": "C",
      "taxId": "12345678",
      "contactPerson": "張三",
      "contactPhone": "02-12345678",
      "contactEmail": "test@example.com",
      "contactFax": "02-12345679",
      "address": "台北市信義區信義路五段7號",
      "cityId": "TPE",
      "zoneId": "XINYI",
      "zipCode": "110",
      "paymentTerm": "NET30",
      "creditLimit": 1000000,
      "currencyId": "TWD",
      "status": "A",
      "memo": "備註",
      "contacts": [
        {
          "tKey": 1,
          "contactName": "張三",
          "contactTitle": "經理",
          "contactPhone": "02-12345678",
          "isPrimary": true
        }
      ],
      "addresses": [
        {
          "tKey": 1,
          "addressType": "BILLING",
          "address": "台北市信義區信義路五段7號",
          "isDefault": true
        }
      ],
      "bankAccounts": [
        {
          "tKey": 1,
          "bankId": "B001",
          "accountNo": "1234567890",
          "accountName": "測試客戶",
          "isDefault": true
        }
      ]
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.3 新增客戶
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/customers`
- **說明**: 新增客戶資料（可同時新增聯絡人、地址、銀行帳戶）
- **請求格式**:
  ```json
  {
    "customerId": "C001",
    "customerName": "測試客戶",
    "customerType": "C",
    "taxId": "12345678",
    "contactPerson": "張三",
    "contactPhone": "02-12345678",
    "contactEmail": "test@example.com",
    "contactFax": "02-12345679",
    "address": "台北市信義區信義路五段7號",
    "cityId": "TPE",
    "zoneId": "XINYI",
    "zipCode": "110",
    "paymentTerm": "NET30",
    "creditLimit": 1000000,
    "currencyId": "TWD",
    "status": "A",
    "memo": "備註",
    "contacts": [
      {
        "contactName": "張三",
        "contactTitle": "經理",
        "contactPhone": "02-12345678",
        "isPrimary": true
      }
    ],
    "addresses": [
      {
        "addressType": "BILLING",
        "address": "台北市信義區信義路五段7號",
        "cityId": "TPE",
        "zoneId": "XINYI",
        "zipCode": "110",
        "isDefault": true
      }
    ],
    "bankAccounts": [
      {
        "bankId": "B001",
        "accountNo": "1234567890",
        "accountName": "測試客戶",
        "isDefault": true
      }
    ]
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "新增成功",
    "data": {
      "customerId": "C001"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 修改客戶
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/customers/{customerId}`
- **說明**: 修改客戶資料
- **路徑參數**:
  - `customerId`: 客戶編號
- **請求格式**: 同新增，但 `customerId` 不可修改
- **回應格式**: 同新增

#### 3.1.5 刪除客戶
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/customers/{customerId}`
- **說明**: 刪除客戶資料（軟刪除，將狀態設為停用）
- **路徑參數**:
  - `customerId`: 客戶編號
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.6 批次刪除客戶
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/customers/batch`
- **說明**: 批次刪除多筆客戶
- **請求格式**:
  ```json
  {
    "customerIds": ["C001", "C002", "C003"]
  }
  ```

#### 3.1.7 檢查客戶編號是否存在
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/customers/check/{customerId}`
- **說明**: 檢查客戶編號是否已存在
- **路徑參數**:
  - `customerId`: 客戶編號
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "檢查完成",
    "data": {
      "exists": false
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

---

## 四、前端 UI 設計

### 4.1 客戶列表頁面

#### 4.1.1 頁面結構
- **路由**: `/customers`
- **組件**: `CustomerList.vue`
- **功能**:
  - 客戶列表顯示（表格）
  - 搜尋功能（客戶編號、客戶名稱、統一編號）
  - 篩選功能（客戶類型、狀態）
  - 分頁功能
  - 排序功能
  - 新增按鈕
  - 修改按鈕（單筆）
  - 刪除按鈕（單筆/批次）
  - 匯出按鈕

#### 4.1.2 表格欄位
- 客戶編號
- 客戶名稱
- 客戶類型
- 統一編號
- 聯絡人
- 聯絡電話
- 狀態
- 操作（修改、刪除、查看）

### 4.2 客戶新增/修改頁面

#### 4.2.1 頁面結構
- **路由**: `/customers/add` (新增), `/customers/edit/:customerId` (修改)
- **組件**: `CustomerForm.vue`
- **功能**:
  - 基本資料表單
  - 聯絡人管理（子表單）
  - 地址管理（子表單）
  - 銀行帳戶管理（子表單）
  - 儲存按鈕
  - 取消按鈕
  - 驗證功能

#### 4.2.2 表單欄位
- **基本資料**:
  - 客戶編號（新增時必填，修改時不可修改）
  - 客戶名稱（必填）
  - 客戶類型（下拉選單：客戶、廠商）
  - 統一編號
  - 聯絡人
  - 聯絡電話
  - 聯絡信箱
  - 傳真號碼
  - 地址
  - 城市（下拉選單）
  - 區域（下拉選單，依城市動態載入）
  - 郵遞區號
  - 付款條件（下拉選單）
  - 信用額度
  - 幣別（下拉選單）
  - 狀態（下拉選單：啟用、停用）
  - 備註

- **聯絡人子表單**:
  - 聯絡人姓名（必填）
  - 職稱
  - 電話
  - 手機
  - 信箱
  - 傳真
  - 是否主要聯絡人（單選）

- **地址子表單**:
  - 地址類型（下拉選單：帳單地址、送貨地址、登記地址）
  - 地址（必填）
  - 城市（下拉選單）
  - 區域（下拉選單，依城市動態載入）
  - 郵遞區號
  - 是否預設地址（單選）

- **銀行帳戶子表單**:
  - 銀行（下拉選單）
  - 帳號（必填）
  - 戶名
  - 是否預設帳戶（單選）

### 4.3 客戶查詢頁面

#### 4.3.1 頁面結構
- **路由**: `/customers/query`
- **組件**: `CustomerQuery.vue`
- **功能**:
  - 進階查詢表單
  - 查詢結果列表
  - 匯出功能

---

## 五、開發時程

### 5.1 後端開發（5天）
- Day 1: 資料庫設計與建立（1天）
- Day 2: Repository 層開發（1天）
- Day 3: Service 層開發（1天）
- Day 4: Controller 層開發（1天）
- Day 5: 單元測試與整合測試（1天）

### 5.2 前端開發（5天）
- Day 1: 客戶列表頁面開發（1天）
- Day 2: 客戶新增/修改頁面開發（2天）
- Day 3: 客戶查詢頁面開發（1天）
- Day 4: API 整合與測試（1天）

### 5.3 測試與優化（2天）
- Day 1: 功能測試（1天）
- Day 2: 效能優化與 Bug 修復（1天）

**總計**: 12天

---

## 六、注意事項

### 6.1 資料驗證
- 客戶編號必須唯一
- 統一編號格式驗證（8碼或10碼）
- 電子郵件格式驗證
- 電話號碼格式驗證
- 信用額度必須大於等於0

### 6.2 業務規則
- 刪除客戶時，需檢查是否有相關交易記錄，如有則不允許刪除，改為停用
- 客戶編號一旦建立不可修改
- 主要聯絡人只能有一個
- 每個地址類型只能有一個預設地址
- 只能有一個預設銀行帳戶

### 6.3 效能考量
- 客戶列表查詢需支援分頁，避免一次載入過多資料
- 客戶編號、客戶名稱、統一編號需建立索引以提升查詢效能
- 聯絡人、地址、銀行帳戶資料使用延遲載入（Lazy Loading）

### 6.4 安全性
- 客戶資料查詢需檢查使用者權限
- 客戶資料修改需記錄操作日誌
- 敏感資訊（如銀行帳號）需加密儲存

---

## 七、測試案例

### 7.1 單元測試

#### 7.1.1 新增客戶測試
- 測試新增客戶成功
- 測試客戶編號重複時新增失敗
- 測試必填欄位驗證
- 測試格式驗證（統一編號、電子郵件、電話）

#### 7.1.2 修改客戶測試
- 測試修改客戶成功
- 測試客戶編號不可修改
- 測試必填欄位驗證

#### 7.1.3 刪除客戶測試
- 測試刪除客戶成功（無相關交易）
- 測試有相關交易時刪除失敗，改為停用

#### 7.1.4 查詢客戶測試
- 測試查詢客戶列表（分頁、排序、篩選）
- 測試查詢單筆客戶（包含子資料）

### 7.2 整合測試

#### 7.2.1 API 整合測試
- 測試所有 API 端點
- 測試錯誤處理
- 測試權限驗證

#### 7.2.2 前端整合測試
- 測試頁面載入
- 測試表單驗證
- 測試資料提交
- 測試錯誤處理

### 7.3 效能測試
- 測試大量資料查詢效能
- 測試分頁效能
- 測試索引效能

---

## 八、參考資料

### 8.1 舊系統參考
- `WEB/IMS_CORE/ASP/SYS2000/` 目錄下的相關 ASP 檔案
- 舊系統資料庫結構（Oracle）

### 8.2 技術文件
- .NET Core Web API 文件
- Dapper 文件
- Vue 3 文件
- Element Plus 文件

### 8.3 相關功能
- 客戶查詢作業
- 客戶報表
- 財務憑證處理

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

