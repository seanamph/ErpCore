# SYS2000 - 郵件傳真作業系列 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS2000 系列
- **功能名稱**: 郵件傳真作業系列
- **功能描述**: 提供郵件與傳真發送功能，用於發送發票、報表等文件，支援自動發送、批次發送等功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS2000/自動郵件/` (自動郵件目錄)
  - `WEB/IMS_CORE/ASP/SYS2000/自動傳真/` (自動傳真目錄)
  - `WEB/IMS_CORE/ASP/SYS5000/` (郵件簡訊發送作業相關)

### 1.2 業務需求
- 支援郵件發送功能
- 支援傳真發送功能
- 支援自動發送排程
- 支援批次發送
- 支援發送記錄查詢
- 支援發送狀態追蹤
- 支援附件功能
- 支援範本功能

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `EmailFaxJobs` (郵件傳真作業記錄)

```sql
CREATE TABLE [dbo].[EmailFaxJobs] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [JobId] NVARCHAR(50) NOT NULL, -- 作業編號 (JOB_ID)
    [JobType] NVARCHAR(20) NOT NULL, -- 作業類型 (JOB_TYPE, EMAIL:郵件, FAX:傳真)
    [Subject] NVARCHAR(500) NULL, -- 主旨 (SUBJECT)
    [Recipient] NVARCHAR(500) NOT NULL, -- 收件人 (RECIPIENT)
    [Cc] NVARCHAR(500) NULL, -- 副本 (CC)
    [Bcc] NVARCHAR(500) NULL, -- 密件副本 (BCC)
    [Content] NVARCHAR(MAX) NULL, -- 內容 (CONTENT)
    [AttachmentPath] NVARCHAR(1000) NULL, -- 附件路徑 (ATTACHMENT_PATH)
    [Status] NVARCHAR(20) NOT NULL DEFAULT 'PENDING', -- 狀態 (STATUS, PENDING:待發送, SENT:已發送, FAILED:失敗)
    [SendDate] DATETIME2 NULL, -- 發送日期 (SEND_DATE)
    [SendUser] NVARCHAR(50) NULL, -- 發送人員 (SEND_USER)
    [ErrorMessage] NVARCHAR(1000) NULL, -- 錯誤訊息 (ERROR_MESSAGE)
    [RetryCount] INT NULL DEFAULT 0, -- 重試次數 (RETRY_COUNT)
    [MaxRetry] INT NULL DEFAULT 3, -- 最大重試次數 (MAX_RETRY)
    [ScheduleDate] DATETIME2 NULL, -- 排程日期 (SCHEDULE_DATE)
    [TemplateId] NVARCHAR(50) NULL, -- 範本編號 (TEMPLATE_ID)
    [Memo] NVARCHAR(1000) NULL, -- 備註 (MEMO)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_EmailFaxJobs] PRIMARY KEY CLUSTERED ([TKey] ASC),
    CONSTRAINT [UQ_EmailFaxJobs_JobId] UNIQUE ([JobId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_EmailFaxJobs_JobId] ON [dbo].[EmailFaxJobs] ([JobId]);
CREATE NONCLUSTERED INDEX [IX_EmailFaxJobs_Status] ON [dbo].[EmailFaxJobs] ([Status]);
CREATE NONCLUSTERED INDEX [IX_EmailFaxJobs_SendDate] ON [dbo].[EmailFaxJobs] ([SendDate]);
CREATE NONCLUSTERED INDEX [IX_EmailFaxJobs_JobType] ON [dbo].[EmailFaxJobs] ([JobType]);
```

### 2.2 相關資料表

#### 2.2.1 `EmailFaxTemplates` - 郵件傳真範本
```sql
CREATE TABLE [dbo].[EmailFaxTemplates] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [TemplateId] NVARCHAR(50) NOT NULL, -- 範本編號
    [TemplateName] NVARCHAR(200) NOT NULL, -- 範本名稱
    [TemplateType] NVARCHAR(20) NOT NULL, -- 範本類型 (EMAIL, FAX)
    [Subject] NVARCHAR(500) NULL, -- 主旨範本
    [Content] NVARCHAR(MAX) NULL, -- 內容範本
    [Variables] NVARCHAR(1000) NULL, -- 變數定義 (JSON格式)
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'A', -- 狀態
    [Memo] NVARCHAR(1000) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_EmailFaxTemplates] PRIMARY KEY CLUSTERED ([TKey] ASC),
    CONSTRAINT [UQ_EmailFaxTemplates_TemplateId] UNIQUE ([TemplateId])
);
```

#### 2.2.2 `EmailFaxLogs` - 郵件傳真發送記錄
```sql
CREATE TABLE [dbo].[EmailFaxLogs] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [JobId] NVARCHAR(50) NOT NULL, -- 作業編號
    [LogDate] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 記錄日期
    [LogType] NVARCHAR(20) NOT NULL, -- 記錄類型 (SEND, RETRY, ERROR, SUCCESS)
    [LogMessage] NVARCHAR(1000) NULL, -- 記錄訊息
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_EmailFaxLogs_EmailFaxJobs] FOREIGN KEY ([JobId]) REFERENCES [dbo].[EmailFaxJobs] ([JobId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_EmailFaxLogs_JobId] ON [dbo].[EmailFaxLogs] ([JobId]);
CREATE NONCLUSTERED INDEX [IX_EmailFaxLogs_LogDate] ON [dbo].[EmailFaxLogs] ([LogDate]);
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 發送郵件
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/email-fax/send-email`
- **說明**: 發送郵件
- **請求格式**:
  ```json
  {
    "recipient": "test@example.com",
    "cc": "",
    "bcc": "",
    "subject": "測試郵件",
    "content": "郵件內容",
    "attachmentPaths": ["path/to/file1.pdf", "path/to/file2.pdf"],
    "templateId": "",
    "scheduleDate": null
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "發送成功",
    "data": {
      "jobId": "JOB001",
      "status": "SENT",
      "sendDate": "2024-01-01T00:00:00"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 發送傳真
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/email-fax/send-fax`
- **說明**: 發送傳真
- **請求格式**: 類似郵件，但需傳真號碼

#### 3.1.3 批次發送
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/email-fax/batch-send`
- **說明**: 批次發送郵件或傳真

#### 3.1.4 查詢發送記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/email-fax/jobs`
- **說明**: 查詢發送記錄列表

#### 3.1.5 查詢單筆作業
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/email-fax/jobs/{jobId}`
- **說明**: 查詢單筆作業詳情（包含發送記錄）

#### 3.1.6 重試發送
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/email-fax/jobs/{jobId}/retry`
- **說明**: 重試發送失敗的作業

---

## 四、前端 UI 設計

### 4.1 郵件傳真發送頁面

#### 4.1.1 頁面結構
- **路由**: `/email-fax/send`
- **組件**: `EmailFaxSend.vue`
- **功能**:
  - 發送類型選擇（郵件/傳真）
  - 收件人輸入
  - 主旨輸入
  - 內容編輯器
  - 附件上傳
  - 範本選擇
  - 排程設定
  - 發送按鈕

### 4.2 發送記錄查詢頁面

#### 4.2.1 頁面結構
- **路由**: `/email-fax/jobs`
- **組件**: `EmailFaxJobs.vue`
- **功能**:
  - 發送記錄列表
  - 狀態篩選
  - 重試功能
  - 詳細記錄查看

---

## 五、開發時程

### 5.1 後端開發（6天）
- Day 1: 資料庫設計與建立（1天）
- Day 2: Repository 層開發（1天）
- Day 3: Service 層開發（郵件/傳真服務整合）（2天）
- Day 4: Controller 層開發（1天）
- Day 5: 單元測試與整合測試（1天）

### 5.2 前端開發（4天）
- Day 1: 郵件傳真發送頁面開發（2天）
- Day 2: 發送記錄查詢頁面開發（1天）
- Day 3: API 整合與測試（1天）

### 5.3 測試與優化（2天）
- Day 1: 功能測試（1天）
- Day 2: 效能優化與 Bug 修復（1天）

**總計**: 12天

---

## 六、注意事項

### 6.1 郵件服務整合
- 需整合 SMTP 服務
- 支援多種郵件伺服器設定
- 支援郵件認證

### 6.2 傳真服務整合
- 需整合傳真服務（如傳真閘道器）
- 支援傳真格式轉換

### 6.3 重試機制
- 失敗時自動重試
- 可設定最大重試次數
- 重試間隔設定

### 6.4 安全性
- 郵件傳真發送需檢查使用者權限
- 敏感資訊需加密
- 發送記錄需保存

---

## 七、測試案例

### 7.1 單元測試
- 測試郵件發送功能
- 測試傳真發送功能
- 測試批次發送功能
- 測試重試機制

### 7.2 整合測試
- 測試郵件服務整合
- 測試傳真服務整合
- 測試API端點

---

## 八、參考資料

### 8.1 舊系統參考
- `WEB/IMS_CORE/ASP/SYS2000/自動郵件/` 目錄
- `WEB/IMS_CORE/ASP/SYS2000/自動傳真/` 目錄
- `WEB/IMS_CORE/ASP/SYS5000/` 郵件簡訊發送作業

### 8.2 技術文件
- .NET Core MailKit 文件
- SMTP 設定文件
- 傳真服務整合文件

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

