# SYS2000 - 發票列印作業系列 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS2000 系列
- **功能名稱**: 發票列印作業系列
- **功能描述**: 提供發票列印功能，支援多種發票格式列印，包含一般發票、電子發票、變更發票等列印作業
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS2000/PnInvoice_*.asp` (各客戶代碼的發票列印頁面)
  - `WEB/IMS_CORE/ASP/SYS2000/PrintInvoice.asp` (通用發票列印頁面)
  - `WEB/IMS_CORE/ASP/SYS2000/PrnInvoice.asp` (發票列印頁面)
  - `WEB/IMS_CORE/ASP/SYS2000/PrnInvoice_RED.asp` (RED客戶發票列印頁面)
  - `WEB/IMS_CORE/ASP/SYS2000/PrnChgInvoice.asp` (變更發票列印頁面)
  - `WEB/IMS_CORE/ASP/SYS2000/SYS2P02_PR.ASP` (代扣款銷項發票套印作業)

### 1.2 業務需求
- 支援多種發票格式列印
- 支援客戶特定發票格式
- 支援發票重新列印
- 支援批次列印
- 支援發票封面列印設定
- 支援印表機設定
- 支援發票預覽功能
- 支援PDF格式輸出

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Invoices` (發票主檔)

```sql
CREATE TABLE [dbo].[Invoices] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [InvoiceNo] NVARCHAR(50) NOT NULL, -- 發票號碼 (INV_NO)
    [InvoiceType] NVARCHAR(20) NOT NULL, -- 發票類型 (INV_TYPE, NORMAL:一般, EINVOICE:電子發票, CHANGE:變更)
    [InvoiceDate] DATETIME2 NOT NULL, -- 發票日期 (INV_DATE)
    [CustomerId] NVARCHAR(50) NULL, -- 客戶編號 (CUST_ID)
    [StoreId] NVARCHAR(50) NULL, -- 店別代碼 (STORE_ID)
    [TotalAmount] DECIMAL(18, 4) NOT NULL DEFAULT 0, -- 總金額 (TOTAL_AMT)
    [TaxAmount] DECIMAL(18, 4) NULL DEFAULT 0, -- 稅額 (TAX_AMT)
    [Amount] DECIMAL(18, 4) NOT NULL DEFAULT 0, -- 金額 (AMOUNT)
    [CurrencyId] NVARCHAR(10) NULL DEFAULT 'TWD', -- 幣別 (CURRENCY_ID)
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'DRAFT', -- 狀態 (STATUS, DRAFT:草稿, ISSUED:已開立, CANCELLED:已作廢)
    [PrintCount] INT NULL DEFAULT 0, -- 列印次數 (PRINT_COUNT)
    [LastPrintDate] DATETIME2 NULL, -- 最後列印日期 (LAST_PRINT_DATE)
    [LastPrintUser] NVARCHAR(50) NULL, -- 最後列印人員 (LAST_PRINT_USER)
    [PrintFormat] NVARCHAR(50) NULL, -- 列印格式 (PRINT_FORMAT)
    [Memo] NVARCHAR(1000) NULL, -- 備註 (MEMO)
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Invoices] PRIMARY KEY CLUSTERED ([TKey] ASC),
    CONSTRAINT [UQ_Invoices_InvoiceNo] UNIQUE ([InvoiceNo])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_Invoices_InvoiceNo] ON [dbo].[Invoices] ([InvoiceNo]);
CREATE NONCLUSTERED INDEX [IX_Invoices_CustomerId] ON [dbo].[Invoices] ([CustomerId]);
CREATE NONCLUSTERED INDEX [IX_Invoices_InvoiceDate] ON [dbo].[Invoices] ([InvoiceDate]);
CREATE NONCLUSTERED INDEX [IX_Invoices_Status] ON [dbo].[Invoices] ([Status]);
```

### 2.2 相關資料表

#### 2.2.1 `InvoiceDetails` - 發票明細
```sql
CREATE TABLE [dbo].[InvoiceDetails] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [InvoiceNo] NVARCHAR(50) NOT NULL, -- 發票號碼
    [LineNum] INT NOT NULL, -- 行號 (LINE_NUM)
    [GoodsId] NVARCHAR(50) NULL, -- 商品編號 (G_ID)
    [GoodsName] NVARCHAR(200) NOT NULL, -- 商品名稱 (G_NAME)
    [Qty] DECIMAL(18, 4) NOT NULL DEFAULT 0, -- 數量 (QTY)
    [UnitPrice] DECIMAL(18, 4) NOT NULL, -- 單價 (UNIT_PRICE)
    [Amount] DECIMAL(18, 4) NOT NULL, -- 金額 (AMOUNT)
    [TaxRate] DECIMAL(5, 2) NULL DEFAULT 0, -- 稅率 (TAX_RATE)
    [TaxAmount] DECIMAL(18, 4) NULL DEFAULT 0, -- 稅額 (TAX_AMT)
    [UnitId] NVARCHAR(50) NULL, -- 單位 (UNIT_ID)
    [Memo] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_InvoiceDetails_Invoices] FOREIGN KEY ([InvoiceNo]) REFERENCES [dbo].[Invoices] ([InvoiceNo]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_InvoiceDetails_InvoiceNo] ON [dbo].[InvoiceDetails] ([InvoiceNo]);
```

#### 2.2.2 `InvoicePrintLogs` - 發票列印記錄
```sql
CREATE TABLE [dbo].[InvoicePrintLogs] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [InvoiceNo] NVARCHAR(50) NOT NULL, -- 發票號碼
    [PrintDate] DATETIME2 NOT NULL DEFAULT GETDATE(), -- 列印日期
    [PrintUser] NVARCHAR(50) NULL, -- 列印人員
    [PrintFormat] NVARCHAR(50) NULL, -- 列印格式
    [PrintType] NVARCHAR(20) NULL, -- 列印類型 (NORMAL:一般列印, RE_PRINT:重新列印)
    [PrinterName] NVARCHAR(100) NULL, -- 印表機名稱
    [PrintCount] INT NULL DEFAULT 1, -- 列印份數
    [Memo] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_InvoicePrintLogs_Invoices] FOREIGN KEY ([InvoiceNo]) REFERENCES [dbo].[Invoices] ([InvoiceNo])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_InvoicePrintLogs_InvoiceNo] ON [dbo].[InvoicePrintLogs] ([InvoiceNo]);
CREATE NONCLUSTERED INDEX [IX_InvoicePrintLogs_PrintDate] ON [dbo].[InvoicePrintLogs] ([PrintDate]);
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢發票列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/invoices`
- **說明**: 查詢發票列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "InvoiceNo",
    "sortOrder": "DESC",
    "filters": {
      "invoiceNo": "",
      "customerId": "",
      "invoiceDateFrom": "",
      "invoiceDateTo": "",
      "status": ""
    }
  }
  ```

#### 3.1.2 查詢單筆發票
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/invoices/{invoiceNo}`
- **說明**: 根據發票號碼查詢單筆發票資料（包含明細）

#### 3.1.3 預覽發票
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/invoices/{invoiceNo}/preview`
- **說明**: 預覽發票列印格式（HTML/PDF）
- **請求格式**:
  ```json
  {
    "printFormat": "STANDARD",
    "includeCover": true,
    "printerSettings": {
      "printerName": "",
      "paperSize": "A4"
    }
  }
  ```
- **回應格式**: HTML 或 PDF 二進位資料流

#### 3.1.4 列印發票
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/invoices/{invoiceNo}/print`
- **說明**: 列印發票（記錄列印記錄）
- **請求格式**: 同預覽
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "列印成功",
    "data": {
      "invoiceNo": "INV001",
      "printCount": 1,
      "printDate": "2024-01-01T00:00:00"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.5 批次列印發票
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/invoices/batch/print`
- **說明**: 批次列印多筆發票
- **請求格式**:
  ```json
  {
    "invoiceNos": ["INV001", "INV002", "INV003"],
    "printFormat": "STANDARD",
    "includeCover": true
  }
  ```

#### 3.1.6 查詢列印記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/invoices/{invoiceNo}/print-logs`
- **說明**: 查詢發票列印記錄

---

## 四、前端 UI 設計

### 4.1 發票列印頁面

#### 4.1.1 頁面結構
- **路由**: `/invoices/print`
- **組件**: `InvoicePrint.vue`
- **功能**:
  - 發票查詢表單
  - 發票列表顯示
  - 發票預覽功能
  - 單筆列印按鈕
  - 批次列印按鈕
  - 列印設定（格式、印表機、封面等）
  - 列印記錄查詢

#### 4.1.2 發票預覽元件
- **組件**: `InvoicePreview.vue`
- **功能**:
  - 顯示發票預覽內容
  - 支援多種發票格式顯示
  - 列印按鈕
  - 下載PDF按鈕

---

## 五、開發時程

### 5.1 後端開發（5天）
- Day 1: 資料庫設計與建立（1天）
- Day 2: Repository 層開發（1天）
- Day 3: Service 層開發（1天）
- Day 4: Controller 層開發（1天）
- Day 5: 單元測試與整合測試（1天）

### 5.2 前端開發（5天）
- Day 1: 發票列印頁面開發（2天）
- Day 2: 發票預覽元件開發（2天）
- Day 3: API 整合與測試（1天）

### 5.3 測試與優化（2天）
- Day 1: 功能測試（1天）
- Day 2: 效能優化與 Bug 修復（1天）

**總計**: 12天

---

## 六、注意事項

### 6.1 列印格式
- 支援多種發票格式（標準格式、客戶特定格式）
- 支援發票封面列印設定
- 支援印表機設定（紙張大小、方向等）

### 6.2 列印記錄
- 每次列印需記錄列印記錄
- 記錄列印人員、列印時間、列印格式等資訊
- 支援列印記錄查詢

### 6.3 安全性
- 發票列印需檢查使用者權限
- 發票列印需記錄操作日誌
- 防止未授權列印

---

## 七、測試案例

### 7.1 單元測試
- 測試發票查詢功能
- 測試發票預覽功能
- 測試發票列印功能
- 測試批次列印功能
- 測試列印記錄功能

### 7.2 整合測試
- 測試API端點
- 測試前端頁面
- 測試列印功能

---

## 八、參考資料

### 8.1 舊系統參考
- `WEB/IMS_CORE/ASP/SYS2000/` 目錄下的發票列印相關 ASP 檔案

### 8.2 技術文件
- .NET Core Web API 文件
- PDF 產生庫文件（iTextSharp）
- Vue 3 文件

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

