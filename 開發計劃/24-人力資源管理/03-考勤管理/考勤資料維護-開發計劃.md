# 考勤資料維護 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: Attendance
- **功能名稱**: 考勤資料維護
- **功能描述**: 提供員工考勤資料的新增、修改、刪除、查詢功能，包含出勤日期、上班時間、下班時間、請假、加班等資訊管理
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/Attendance/` 相關檔案
  - `IMS3/HANSHIN/IMS3/Attendance/` 相關檔案

### 1.2 業務需求
- 管理員工出勤記錄
- 支援請假申請與審核
- 支援加班申請與審核
- 支援補打卡作業
- 支援考勤異常處理
- 支援考勤統計與報表

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Attendance`

```sql
CREATE TABLE [dbo].[Attendance] (
    [AttendanceId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [EmployeeId] NVARCHAR(50) NOT NULL,
    [AttendanceDate] DATE NOT NULL,
    [CheckInTime] DATETIME2 NULL,
    [CheckOutTime] DATETIME2 NULL,
    [WorkHours] DECIMAL(5,2) NULL,
    [OvertimeHours] DECIMAL(5,2) NULL DEFAULT 0,
    [LeaveType] NVARCHAR(20) NULL, -- FULL:全天假, HALF:半天假, HOUR:時假
    [LeaveHours] DECIMAL(5,2) NULL DEFAULT 0,
    [LeaveReason] NVARCHAR(500) NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'NORMAL', -- NORMAL:正常, LATE:遲到, EARLY:早退, ABSENT:缺勤, LEAVE:請假
    [IsHoliday] BIT NOT NULL DEFAULT 0,
    [IsWeekend] BIT NOT NULL DEFAULT 0,
    [Notes] NVARCHAR(500) NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_Attendance] PRIMARY KEY CLUSTERED ([AttendanceId] ASC),
    CONSTRAINT [FK_Attendance_Employees] FOREIGN KEY ([EmployeeId]) REFERENCES [dbo].[Employees] ([EmployeeId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_Attendance_EmployeeId] ON [dbo].[Attendance] ([EmployeeId]);
CREATE NONCLUSTERED INDEX [IX_Attendance_AttendanceDate] ON [dbo].[Attendance] ([AttendanceDate]);
CREATE NONCLUSTERED INDEX [IX_Attendance_EmployeeId_Date] ON [dbo].[Attendance] ([EmployeeId], [AttendanceDate]);
CREATE NONCLUSTERED INDEX [IX_Attendance_Status] ON [dbo].[Attendance] ([Status]);
```

### 2.2 相關資料表

#### 2.2.1 `LeaveApplications` - 請假申請
```sql
CREATE TABLE [dbo].[LeaveApplications] (
    [LeaveApplicationId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [EmployeeId] NVARCHAR(50) NOT NULL,
    [LeaveType] NVARCHAR(20) NOT NULL, -- ANNUAL:年假, SICK:病假, PERSONAL:事假, OTHER:其他
    [StartDate] DATE NOT NULL,
    [EndDate] DATE NOT NULL,
    [StartTime] TIME NULL,
    [EndTime] TIME NULL,
    [TotalHours] DECIMAL(5,2) NOT NULL,
    [Reason] NVARCHAR(500) NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'PENDING', -- PENDING:待審核, APPROVED:已核准, REJECTED:已駁回
    [ApproverId] NVARCHAR(50) NULL,
    [ApprovedAt] DATETIME2 NULL,
    [RejectReason] NVARCHAR(500) NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_LeaveApplications_Employees] FOREIGN KEY ([EmployeeId]) REFERENCES [dbo].[Employees] ([EmployeeId])
);
```

#### 2.2.2 `OvertimeApplications` - 加班申請
```sql
CREATE TABLE [dbo].[OvertimeApplications] (
    [OvertimeApplicationId] UNIQUEIDENTIFIER NOT NULL PRIMARY KEY DEFAULT NEWID(),
    [EmployeeId] NVARCHAR(50) NOT NULL,
    [OvertimeDate] DATE NOT NULL,
    [StartTime] TIME NOT NULL,
    [EndTime] TIME NOT NULL,
    [OvertimeHours] DECIMAL(5,2) NOT NULL,
    [Reason] NVARCHAR(500) NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'PENDING', -- PENDING:待審核, APPROVED:已核准, REJECTED:已駁回
    [ApproverId] NVARCHAR(50) NULL,
    [ApprovedAt] DATETIME2 NULL,
    [RejectReason] NVARCHAR(500) NULL,
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_OvertimeApplications_Employees] FOREIGN KEY ([EmployeeId]) REFERENCES [dbo].[Employees] ([EmployeeId])
);
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| AttendanceId | UNIQUEIDENTIFIER | - | NO | NEWID() | 考勤記錄編號 | 主鍵 |
| EmployeeId | NVARCHAR | 50 | NO | - | 員工編號 | 外鍵至員工表 |
| AttendanceDate | DATE | - | NO | - | 出勤日期 | - |
| CheckInTime | DATETIME2 | - | YES | - | 上班時間 | - |
| CheckOutTime | DATETIME2 | - | YES | - | 下班時間 | - |
| WorkHours | DECIMAL | 5,2 | YES | - | 工作時數 | - |
| OvertimeHours | DECIMAL | 5,2 | YES | 0 | 加班時數 | - |
| LeaveType | NVARCHAR | 20 | YES | - | 請假類型 | FULL:全天假, HALF:半天假, HOUR:時假 |
| LeaveHours | DECIMAL | 5,2 | YES | 0 | 請假時數 | - |
| LeaveReason | NVARCHAR | 500 | YES | - | 請假事由 | - |
| Status | NVARCHAR | 10 | NO | 'NORMAL' | 考勤狀態 | NORMAL:正常, LATE:遲到, EARLY:早退, ABSENT:缺勤, LEAVE:請假 |
| IsHoliday | BIT | - | NO | 0 | 是否假日 | - |
| IsWeekend | BIT | - | NO | 0 | 是否週末 | - |
| Notes | NVARCHAR | 500 | YES | - | 備註 | - |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢考勤記錄列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/attendance`
- **說明**: 查詢考勤記錄列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "AttendanceDate",
    "sortOrder": "DESC",
    "filters": {
      "employeeId": "",
      "startDate": "2024-01-01",
      "endDate": "2024-01-31",
      "status": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "attendanceId": "guid",
          "employeeId": "E001",
          "employeeName": "張三",
          "attendanceDate": "2024-01-01",
          "checkInTime": "2024-01-01T09:00:00",
          "checkOutTime": "2024-01-01T18:00:00",
          "workHours": 8.0,
          "overtimeHours": 0,
          "status": "NORMAL"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆考勤記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/attendance/{attendanceId}`
- **說明**: 根據考勤記錄編號查詢單筆考勤記錄
- **路徑參數**:
  - `attendanceId`: 考勤記錄編號
- **回應格式**: 同查詢列表的單筆資料格式

#### 3.1.3 新增考勤記錄
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/attendance`
- **說明**: 新增考勤記錄（通常用於補打卡）
- **請求格式**:
  ```json
  {
    "employeeId": "E001",
    "attendanceDate": "2024-01-01",
    "checkInTime": "2024-01-01T09:00:00",
    "checkOutTime": "2024-01-01T18:00:00",
    "workHours": 8.0,
    "overtimeHours": 0,
    "status": "NORMAL",
    "notes": "補打卡"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "新增成功",
    "data": {
      "attendanceId": "guid"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 修改考勤記錄
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/attendance/{attendanceId}`
- **說明**: 修改考勤記錄（通常用於修正打卡時間）
- **路徑參數**:
  - `attendanceId`: 考勤記錄編號
- **請求格式**: 同新增，但 `attendanceId` 不可修改
- **回應格式**: 同新增

#### 3.1.5 刪除考勤記錄
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/attendance/{attendanceId}`
- **說明**: 刪除考勤記錄
- **路徑參數**:
  - `attendanceId`: 考勤記錄編號
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.6 打卡作業
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/attendance/check-in` 或 `/api/v1/attendance/check-out`
- **說明**: 員工打卡（上班/下班）
- **請求格式**:
  ```json
  {
    "employeeId": "E001",
    "checkTime": "2024-01-01T09:00:00",
    "location": "公司大門"
  }
  ```

#### 3.1.7 補打卡作業
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/attendance/supplement`
- **說明**: 補打卡作業
- **請求格式**:
  ```json
  {
    "employeeId": "E001",
    "attendanceDate": "2024-01-01",
    "checkInTime": "2024-01-01T09:00:00",
    "checkOutTime": "2024-01-01T18:00:00",
    "reason": "忘記打卡"
  }
  ```

### 3.2 後端實作類別

#### 3.2.1 Controller: `AttendanceController.cs`
```csharp
namespace RSL.IMS3.Api.Controllers
{
    [ApiController]
    [Route("api/v1/attendance")]
    [Authorize]
    public class AttendanceController : ControllerBase
    {
        private readonly IAttendanceService _attendanceService;
        
        public AttendanceController(IAttendanceService attendanceService)
        {
            _attendanceService = attendanceService;
        }
        
        [HttpGet]
        public async Task<ActionResult<ApiResponse<PagedResult<AttendanceDto>>>> GetAttendance([FromQuery] AttendanceQueryDto query)
        {
            // 實作查詢邏輯
        }
        
        [HttpGet("{attendanceId}")]
        public async Task<ActionResult<ApiResponse<AttendanceDto>>> GetAttendanceById(Guid attendanceId)
        {
            // 實作查詢單筆邏輯
        }
        
        [HttpPost]
        public async Task<ActionResult<ApiResponse<Guid>>> CreateAttendance([FromBody] CreateAttendanceDto dto)
        {
            // 實作新增邏輯
        }
        
        [HttpPut("{attendanceId}")]
        public async Task<ActionResult<ApiResponse>> UpdateAttendance(Guid attendanceId, [FromBody] UpdateAttendanceDto dto)
        {
            // 實作修改邏輯
        }
        
        [HttpDelete("{attendanceId}")]
        public async Task<ActionResult<ApiResponse>> DeleteAttendance(Guid attendanceId)
        {
            // 實作刪除邏輯
        }
        
        [HttpPost("check-in")]
        public async Task<ActionResult<ApiResponse>> CheckIn([FromBody] CheckInDto dto)
        {
            // 實作打卡邏輯
        }
        
        [HttpPost("check-out")]
        public async Task<ActionResult<ApiResponse>> CheckOut([FromBody] CheckOutDto dto)
        {
            // 實作下班打卡邏輯
        }
        
        [HttpPost("supplement")]
        public async Task<ActionResult<ApiResponse>> SupplementAttendance([FromBody] SupplementAttendanceDto dto)
        {
            // 實作補打卡邏輯
        }
    }
}
```

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 考勤記錄列表頁面 (`AttendanceList.vue`)
- **路徑**: `/hr/attendance`
- **功能**: 顯示考勤記錄列表，支援查詢、新增、修改、刪除、補打卡
- **主要元件**:
  - 查詢表單 (AttendanceSearchForm)
  - 資料表格 (AttendanceDataTable)
  - 新增/修改對話框 (AttendanceDialog)
  - 補打卡對話框 (SupplementAttendanceDialog)
  - 刪除確認對話框

#### 4.1.2 打卡頁面 (`CheckInOut.vue`)
- **路徑**: `/hr/check-in-out`
- **功能**: 員工打卡頁面
- **主要元件**:
  - 打卡按鈕
  - 打卡記錄顯示

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`AttendanceSearchForm.vue`)
```vue
<template>
  <el-form :model="searchForm" inline>
    <el-form-item label="員工編號">
      <el-input v-model="searchForm.employeeId" placeholder="請輸入員工編號" />
    </el-form-item>
    <el-form-item label="出勤日期">
      <el-date-picker
        v-model="searchForm.dateRange"
        type="daterange"
        range-separator="至"
        start-placeholder="開始日期"
        end-placeholder="結束日期"
      />
    </el-form-item>
    <el-form-item label="考勤狀態">
      <el-select v-model="searchForm.status" placeholder="請選擇狀態">
        <el-option label="正常" value="NORMAL" />
        <el-option label="遲到" value="LATE" />
        <el-option label="早退" value="EARLY" />
        <el-option label="缺勤" value="ABSENT" />
        <el-option label="請假" value="LEAVE" />
      </el-select>
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
    </el-form-item>
  </el-form>
</template>
```

#### 4.2.2 資料表格元件 (`AttendanceDataTable.vue`)
```vue
<template>
  <div>
    <el-table :data="attendanceList" v-loading="loading">
      <el-table-column prop="employeeName" label="員工姓名" width="120" />
      <el-table-column prop="attendanceDate" label="出勤日期" width="120" />
      <el-table-column prop="checkInTime" label="上班時間" width="150" />
      <el-table-column prop="checkOutTime" label="下班時間" width="150" />
      <el-table-column prop="workHours" label="工作時數" width="100" />
      <el-table-column prop="overtimeHours" label="加班時數" width="100" />
      <el-table-column prop="status" label="狀態" width="100">
        <template #default="{ row }">
          <el-tag :type="getStatusType(row.status)">
            {{ getStatusText(row.status) }}
          </el-tag>
        </template>
      </el-table-column>
      <el-table-column label="操作" width="200" fixed="right">
        <template #default="{ row }">
          <el-button type="primary" size="small" @click="handleEdit(row)">修改</el-button>
          <el-button type="warning" size="small" @click="handleSupplement(row)">補打卡</el-button>
          <el-button type="danger" size="small" @click="handleDelete(row)">刪除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      v-model:current-page="pagination.pageIndex"
      v-model:page-size="pagination.pageSize"
      :total="pagination.totalCount"
      :page-sizes="[10, 20, 50, 100]"
      layout="total, sizes, prev, pager, next, jumper"
      @size-change="handleSizeChange"
      @current-change="handlePageChange"
    />
  </div>
</template>
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (1天)
- [ ] 建立資料表結構
- [ ] 建立索引
- [ ] 建立外鍵約束
- [ ] 建立預設值
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (4天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 驗證邏輯實作
- [ ] 打卡邏輯實作
- [ ] 補打卡邏輯實作
- [ ] 單元測試

### 5.3 階段三: 前端開發 (4天)
- [ ] API 呼叫函數
- [ ] 列表頁面開發
- [ ] 新增/修改對話框開發
- [ ] 查詢表單開發
- [ ] 資料表格開發
- [ ] 打卡頁面開發
- [ ] 補打卡對話框開發
- [ ] 表單驗證
- [ ] 元件測試

### 5.4 階段四: 整合測試 (1天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試
- [ ] 安全性測試

### 5.5 階段五: 文件與部署 (1天)
- [ ] API 文件更新
- [ ] 使用者手冊
- [ ] 部署文件

**總計**: 11天

---

## 六、注意事項

### 6.1 安全性
- 敏感資料必須加密傳輸 (HTTPS)
- 必須實作權限檢查
- 打卡記錄不可隨意修改
- 補打卡需要審核機制

### 6.2 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 必須使用快取機制
- 打卡操作需要即時回應

### 6.3 資料驗證
- 員工編號必須存在
- 出勤日期必須在有效範圍內
- 上班時間必須早於下班時間
- 工作時數必須正確計算
- 狀態值必須在允許範圍內

### 6.4 業務邏輯
- 同一員工同一天只能有一筆考勤記錄
- 打卡時間必須在合理範圍內
- 請假記錄需要與考勤記錄關聯
- 加班記錄需要與考勤記錄關聯
- 考勤異常需要標記並通知

---

## 七、測試案例

### 7.1 單元測試
- [ ] 新增考勤記錄成功
- [ ] 新增考勤記錄失敗 (重複日期)
- [ ] 修改考勤記錄成功
- [ ] 修改考勤記錄失敗 (不存在)
- [ ] 刪除考勤記錄成功
- [ ] 查詢考勤記錄列表成功
- [ ] 查詢單筆考勤記錄成功
- [ ] 打卡作業成功
- [ ] 補打卡作業成功

### 7.2 整合測試
- [ ] 完整 CRUD 流程測試
- [ ] 權限檢查測試
- [ ] 資料驗證測試
- [ ] 錯誤處理測試
- [ ] 打卡流程測試

### 7.3 效能測試
- [ ] 大量資料查詢測試
- [ ] 並發打卡測試
- [ ] 並發操作測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ASP/Attendance/` 相關檔案
- `IMS3/HANSHIN/IMS3/Attendance/` 相關檔案

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

