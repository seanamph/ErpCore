# SYS3330-SYS33B0 - 會員查詢作業系列 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS3330-SYS33B0 系列
- **功能名稱**: 會員查詢作業系列
- **功能描述**: 提供會員資料的查詢、報表功能，包含會員基本資料查詢、會員交易記錄查詢、會員積分查詢、會員卡片查詢等
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS3000/SYS3330_FQ.ASP` (查詢)
  - `WEB/IMS_CORE/ASP/SYS3000/SYS3330_PR.ASP` (報表)
  - `WEB/IMS_CORE/ASP/SYS3000/SYS33B0_PR.ASP` (會員回門禮卡號補登作業報表)

### 1.2 業務需求
- 支援會員基本資料查詢
- 支援會員交易記錄查詢
- 支援會員積分查詢
- 支援會員卡片查詢
- 支援會員回門禮卡號補登作業
- 支援多條件組合查詢
- 支援查詢結果匯出（Excel/PDF）
- 支援報表列印

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Members` (會員主檔)
參考 `SYS3310-SYS3320-會員資料維護系列.md` 中的資料表設計

### 2.2 相關資料表

#### 2.2.1 `MemberTransactions` - 會員交易記錄
```sql
CREATE TABLE [dbo].[MemberTransactions] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [MemberId] NVARCHAR(50) NOT NULL, -- 會員編號
    [TransactionDate] DATETIME2 NOT NULL, -- 交易日期
    [TransactionType] NVARCHAR(20) NOT NULL, -- 交易類型 (PURCHASE:購買, RETURN:退貨, POINT_EARN:積分獲得, POINT_USE:積分使用)
    [TransactionNo] NVARCHAR(50) NULL, -- 交易單號
    [Amount] DECIMAL(18, 4) NULL DEFAULT 0, -- 交易金額
    [Points] DECIMAL(18, 4) NULL DEFAULT 0, -- 積分變動
    [PointsBalance] DECIMAL(18, 4) NULL DEFAULT 0, -- 積分餘額
    [ShopId] NVARCHAR(50) NULL, -- 分店代碼
    [StoreId] NVARCHAR(50) NULL, -- 專櫃代碼
    [Notes] NVARCHAR(500) NULL, -- 備註
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_MemberTransactions_Members] FOREIGN KEY ([MemberId]) REFERENCES [dbo].[Members] ([MemberId]) ON DELETE CASCADE
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_MemberTransactions_MemberId] ON [dbo].[MemberTransactions] ([MemberId]);
CREATE NONCLUSTERED INDEX [IX_MemberTransactions_TransactionDate] ON [dbo].[MemberTransactions] ([TransactionDate]);
CREATE NONCLUSTERED INDEX [IX_MemberTransactions_TransactionType] ON [dbo].[MemberTransactions] ([TransactionType]);
```

#### 2.2.2 `MemberExchangeLogs` - 會員回門禮卡號補登記錄
```sql
CREATE TABLE [dbo].[MemberExchangeLogs] (
    [TKey] BIGINT NOT NULL PRIMARY KEY IDENTITY(1,1),
    [LogDate] DATETIME2 NOT NULL, -- 記錄日期
    [CardNo] NVARCHAR(50) NOT NULL, -- 卡片號碼
    [Notes] NVARCHAR(500) NULL, -- 備註
    [Status] NVARCHAR(10) NULL, -- 狀態
    [BTime] DATETIME2 NULL, -- 建立時間
    [BUser] NVARCHAR(50) NULL, -- 建立者
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [FK_MemberExchangeLogs_Members] FOREIGN KEY ([CardNo]) REFERENCES [dbo].[Members] ([CardNo])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_MemberExchangeLogs_LogDate] ON [dbo].[MemberExchangeLogs] ([LogDate]);
CREATE NONCLUSTERED INDEX [IX_MemberExchangeLogs_CardNo] ON [dbo].[MemberExchangeLogs] ([CardNo]);
```

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢會員列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/members/query`
- **說明**: 根據條件查詢會員列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "MemberId",
    "sortOrder": "ASC",
    "filters": {
      "memberId": "",
      "memberName": "",
      "personalId": "",
      "phone": "",
      "mobile": "",
      "email": "",
      "memberLevel": "",
      "status": "",
      "cardNo": "",
      "joinDateFrom": "",
      "joinDateTo": ""
    }
  }
  ```
- **回應格式**: 標準列表回應格式

#### 3.1.2 查詢會員交易記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/members/{memberId}/transactions`
- **說明**: 查詢指定會員的交易記錄
- **路徑參數**:
  - `memberId`: 會員編號
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "transactionDateFrom": "",
    "transactionDateTo": "",
    "transactionType": ""
  }
  ```
- **回應格式**: 標準列表回應格式

#### 3.1.3 查詢會員回門禮卡號補登記錄
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/members/exchange-logs`
- **說明**: 查詢會員回門禮卡號補登記錄
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "logDate": "",
    "cardNo": ""
  }
  ```
- **回應格式**: 標準列表回應格式

#### 3.1.4 匯出會員查詢結果
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/members/query/export`
- **說明**: 匯出會員查詢結果為Excel或PDF
- **請求格式**:
  ```json
  {
    "exportType": "EXCEL", // EXCEL 或 PDF
    "filters": {
      "memberId": "",
      "memberName": "",
      "personalId": "",
      "phone": "",
      "mobile": "",
      "email": "",
      "memberLevel": "",
      "status": "",
      "cardNo": "",
      "joinDateFrom": "",
      "joinDateTo": ""
    }
  }
  ```
- **回應格式**: 檔案下載

#### 3.1.5 列印會員報表
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/members/query/print`
- **說明**: 列印會員查詢報表
- **請求格式**: 同匯出
- **回應格式**: PDF檔案

---

## 四、前端 UI 設計

### 4.1 頁面結構

#### 4.1.1 會員查詢頁面 (`MemberQuery.vue`)
- **路徑**: `/store/members/query`
- **功能**: 會員資料查詢，支援多條件組合查詢
- **主要元件**:
  - 查詢表單 (MemberQueryForm)
  - 資料表格 (MemberDataTable)
  - 匯出按鈕
  - 列印按鈕

#### 4.1.2 會員交易記錄查詢頁面 (`MemberTransactionQuery.vue`)
- **路徑**: `/store/members/:memberId/transactions`
- **功能**: 查詢指定會員的交易記錄

#### 4.1.3 會員回門禮卡號補登查詢頁面 (`MemberExchangeLogQuery.vue`)
- **路徑**: `/store/members/exchange-logs`
- **功能**: 查詢會員回門禮卡號補登記錄

### 4.2 UI 元件設計

#### 4.2.1 查詢表單元件 (`MemberQueryForm.vue`)
```vue
<template>
  <el-form :model="queryForm" inline>
    <el-form-item label="會員編號">
      <el-input v-model="queryForm.memberId" placeholder="請輸入會員編號" />
    </el-form-item>
    <el-form-item label="會員姓名">
      <el-input v-model="queryForm.memberName" placeholder="請輸入會員姓名" />
    </el-form-item>
    <el-form-item label="身份證字號">
      <el-input v-model="queryForm.personalId" placeholder="請輸入身份證字號" />
    </el-form-item>
    <el-form-item label="電話">
      <el-input v-model="queryForm.phone" placeholder="請輸入電話" />
    </el-form-item>
    <el-form-item label="手機">
      <el-input v-model="queryForm.mobile" placeholder="請輸入手機" />
    </el-form-item>
    <el-form-item label="電子郵件">
      <el-input v-model="queryForm.email" placeholder="請輸入電子郵件" />
    </el-form-item>
    <el-form-item label="會員等級">
      <el-select v-model="queryForm.memberLevel" placeholder="請選擇會員等級">
        <el-option v-for="level in memberLevelList" :key="level.levelId" :label="level.levelName" :value="level.levelId" />
      </el-select>
    </el-form-item>
    <el-form-item label="狀態">
      <el-select v-model="queryForm.status" placeholder="請選擇狀態">
        <el-option label="啟用" value="A" />
        <el-option label="停用" value="I" />
        <el-option label="暫停" value="S" />
      </el-select>
    </el-form-item>
    <el-form-item label="卡片號碼">
      <el-input v-model="queryForm.cardNo" placeholder="請輸入卡片號碼" />
    </el-form-item>
    <el-form-item label="加入日期">
      <el-date-picker
        v-model="queryForm.joinDateRange"
        type="daterange"
        range-separator="至"
        start-placeholder="開始日期"
        end-placeholder="結束日期"
      />
    </el-form-item>
    <el-form-item>
      <el-button type="primary" @click="handleSearch">查詢</el-button>
      <el-button @click="handleReset">重置</el-button>
      <el-button type="success" @click="handleExport">匯出</el-button>
      <el-button type="info" @click="handlePrint">列印</el-button>
    </el-form-item>
  </el-form>
</template>
```

---

## 五、開發時程

### 5.1 階段一: 資料庫設計 (1天)
- [ ] 建立相關資料表結構
- [ ] 建立索引
- [ ] 建立外鍵約束
- [ ] 資料庫遷移腳本

### 5.2 階段二: 後端開發 (2天)
- [ ] Entity 類別建立
- [ ] Repository 實作
- [ ] Service 實作
- [ ] Controller 實作
- [ ] DTO 類別建立
- [ ] 查詢邏輯實作
- [ ] 匯出功能實作
- [ ] 列印功能實作

### 5.3 階段三: 前端開發 (2天)
- [ ] API 呼叫函數
- [ ] 查詢頁面開發
- [ ] 查詢表單開發
- [ ] 資料表格開發
- [ ] 匯出功能開發
- [ ] 列印功能開發

### 5.4 階段四: 整合測試 (1天)
- [ ] API 整合測試
- [ ] 端對端測試
- [ ] 效能測試

**總計**: 6天

---

## 六、注意事項

### 6.1 效能
- 大量資料查詢必須使用分頁
- 必須建立適當的索引
- 複雜查詢必須優化

### 6.2 資料驗證
- 查詢條件必須驗證
- 日期範圍必須驗證

### 6.3 安全性
- 敏感資料必須加密傳輸 (HTTPS)
- 必須實作權限檢查
- 匯出功能必須限制權限

---

## 七、測試案例

### 7.1 單元測試
- [ ] 查詢會員列表成功
- [ ] 查詢會員交易記錄成功
- [ ] 查詢會員回門禮卡號補登記錄成功
- [ ] 匯出功能測試
- [ ] 列印功能測試

### 7.2 整合測試
- [ ] 完整查詢流程測試
- [ ] 權限檢查測試
- [ ] 錯誤處理測試

---

## 八、參考資料

### 8.1 舊程式碼
- `WEB/IMS_CORE/ASP/SYS3000/SYS3330_FQ.ASP`
- `WEB/IMS_CORE/ASP/SYS3000/SYS3330_PR.ASP`
- `WEB/IMS_CORE/ASP/SYS3000/SYS33B0_PR.ASP`

---

**文件版本**: v1.0  
**建立日期**: 2024-01-01  
**最後更新**: 2024-01-01

