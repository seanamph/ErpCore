# SYS6381-SYS63A0 - 樓層查詢作業系列 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS6381-SYS63A0 系列
- **功能名稱**: 樓層查詢作業系列
- **功能描述**: 提供樓層資料的查詢、報表功能，包含樓層編號、樓層名稱、樓層資訊、商店統計等查詢功能
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS6000/SYS6381_FQ.ASP` (查詢)
  - `WEB/IMS_CORE/ASP/SYS6000/SYS6381_PR.ASP` (報表)
  - `WEB/IMS_CORE/ASP/SYS6000/SYS63A0_FQ.ASP` (查詢)
  - `WEB/IMS_CORE/ASP/SYS6000/SYS63A0_PR.ASP` (報表)
  - `WEB/IMS_CORE/ASP/SYS6000/SYS6360_FLOOR_LIST.ASP` (樓層列表)

### 1.2 業務需求
- 查詢樓層基本資料資訊
- 支援多條件組合查詢
- 支援樓層統計資訊查詢
- 支援樓層商店數量統計
- 支援樓層報表列印
- 支援樓層資料匯出

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `Floors` (樓層資料)

```sql
CREATE TABLE [dbo].[Floors] (
    [FloorId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [FloorName] NVARCHAR(100) NOT NULL,
    [FloorNameEn] NVARCHAR(100) NULL,
    [FloorNumber] INT NULL, -- 樓層號碼
    [Description] NVARCHAR(500) NULL,
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'A', -- A:啟用, I:停用
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE()
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_Floors_FloorNumber] ON [dbo].[Floors] ([FloorNumber]);
CREATE NONCLUSTERED INDEX [IX_Floors_Status] ON [dbo].[Floors] ([Status]);
```

### 2.2 相關資料表

#### 2.2.1 `ShopFloors` - 商店樓層對應（用於統計）
```sql
-- 參考 SYS6110-SYS6140-商店資料維護系列.md 中的 ShopFloors 表定義
```

### 2.3 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| FloorId | NVARCHAR | 50 | NO | - | 樓層代碼 | 主鍵 |
| FloorName | NVARCHAR | 100 | NO | - | 樓層名稱 | - |
| FloorNameEn | NVARCHAR | 100 | YES | - | 樓層英文名稱 | - |
| FloorNumber | INT | - | YES | - | 樓層號碼 | - |
| Description | NVARCHAR | 500 | YES | - | 說明 | - |
| Status | NVARCHAR | 10 | NO | 'A' | 狀態 | A:啟用, I:停用 |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢樓層列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/floors/query`
- **說明**: 查詢樓層列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "FloorNumber",
    "sortOrder": "ASC",
    "filters": {
      "floorId": "",
      "floorName": "",
      "floorNumber": null,
      "status": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "floorId": "FLOOR001",
          "floorName": "一樓",
          "floorNameEn": "1F",
          "floorNumber": 1,
          "description": "一樓說明",
          "status": "A",
          "shopCount": 10,
          "createdAt": "2024-01-01T00:00:00Z"
        }
      ],
      "totalCount": 50,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 3
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆樓層
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/floors/{floorId}`
- **說明**: 根據樓層代碼查詢單筆樓層資料
- **路徑參數**:
  - `floorId`: 樓層代碼
- **回應格式**: 同查詢列表單筆資料格式

#### 3.1.3 樓層統計查詢
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/floors/statistics`
- **說明**: 查詢樓層統計資訊（商店數量、商店類型分布等）
- **請求參數**:
  ```json
  {
    "floorId": "",
    "includeShopDetails": false
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "totalFloors": 10,
      "activeFloors": 8,
      "totalShops": 50,
      "floorStatistics": [
        {
          "floorId": "FLOOR001",
          "floorName": "一樓",
          "shopCount": 10,
          "activeShopCount": 8
        }
      ]
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 樓層報表查詢
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/floors/report`
- **說明**: 查詢樓層報表資料
- **請求參數**:
  ```json
  {
    "floorId": "",
    "reportType": "DETAIL", // DETAIL:明細, SUMMARY:彙總
    "includeShops": true
  }
  ```
- **回應格式**: 同查詢列表，但包含更多報表相關欄位

#### 3.1.5 樓層資料匯出
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/floors/export`
- **說明**: 匯出樓層查詢結果（Excel/PDF）
- **請求格式**:
  ```json
  {
    "filters": {
      "floorId": "",
      "floorName": "",
      "status": ""
    },
    "exportFormat": "EXCEL", // EXCEL, PDF
    "columns": ["floorId", "floorName", "floorNumber", "status", "shopCount"]
  }
  ```
- **回應格式**: 返回檔案下載連結或檔案內容

---

## 四、前端 UI 設計

### 4.1 查詢頁面 (`FloorQuery.vue`)

#### 4.1.1 頁面結構
- **查詢條件區塊**
  - 樓層代碼輸入框
  - 樓層名稱輸入框
  - 樓層號碼輸入框
  - 狀態下拉選單（全部/啟用/停用）
  - 查詢按鈕、重置按鈕

- **查詢結果區塊**
  - 資料表格（Element Plus Table）
    - 樓層代碼
    - 樓層名稱
    - 樓層英文名稱
    - 樓層號碼
    - 狀態
    - 商店數量
    - 建立時間
    - 操作欄位（查看詳情、報表）
  - 分頁組件
  - 匯出按鈕（Excel/PDF）

#### 4.1.2 功能按鈕
- **查詢**: 執行查詢作業
- **重置**: 清空查詢條件
- **匯出Excel**: 匯出查詢結果為Excel
- **匯出PDF**: 匯出查詢結果為PDF
- **報表**: 開啟報表頁面
- **統計**: 開啟統計頁面

### 4.2 統計頁面 (`FloorStatistics.vue`)

#### 4.2.1 頁面結構
- **統計圖表區塊**
  - 樓層商店數量統計圖（柱狀圖/圓餅圖）
  - 樓層狀態分布圖
  - 樓層商店類型分布圖

- **統計資料表格**
  - 樓層代碼
  - 樓層名稱
  - 商店總數
  - 啟用商店數
  - 停用商店數

### 4.3 報表頁面 (`FloorReport.vue`)

#### 4.3.1 頁面結構
- **報表設定區塊**
  - 報表類型選擇（明細/彙總）
  - 是否包含商店資料
  - 報表格式選擇

- **報表預覽區塊**
  - 報表內容顯示
  - 列印按鈕
  - 匯出按鈕

---

## 五、開發時程

### 5.1 後端開發 (5天)
- Day 1-2: 資料庫查詢邏輯開發（查詢、統計）
- Day 3: API 端點開發
- Day 4: 報表功能開發
- Day 5: 匯出功能開發、測試

### 5.2 前端開發 (5天)
- Day 1-2: 查詢頁面開發
- Day 3: 統計頁面開發
- Day 4: 報表頁面開發
- Day 5: 整合測試、優化

### 5.3 測試 (2天)
- Day 1: 單元測試、整合測試
- Day 2: 使用者驗收測試

**總計**: 12天

---

## 六、注意事項

### 6.1 資料庫
- 樓層查詢需要關聯商店資料表進行統計
- 注意查詢效能，建議使用索引優化
- 大量資料查詢時需要分頁處理

### 6.2 API
- 查詢API需要支援多條件組合查詢
- 統計API需要考慮資料量，避免效能問題
- 匯出功能需要處理大量資料的情況

### 6.3 前端
- 查詢結果表格需要支援排序功能
- 統計圖表需要使用圖表庫（如 ECharts）
- 報表列印需要處理分頁問題

### 6.4 效能
- 大量資料查詢時需要優化SQL查詢
- 統計查詢可以考慮使用快取機制
- 匯出功能建議使用非同步處理

---

## 七、測試案例

### 7.1 查詢功能測試
- **測試案例1**: 查詢所有樓層
  - 輸入: 無條件
  - 預期: 返回所有樓層資料

- **測試案例2**: 根據樓層代碼查詢
  - 輸入: floorId = "FLOOR001"
  - 預期: 返回樓層代碼為FLOOR001的資料

- **測試案例3**: 多條件組合查詢
  - 輸入: floorName = "一樓", status = "A"
  - 預期: 返回符合條件的樓層資料

### 7.2 統計功能測試
- **測試案例1**: 查詢樓層統計
  - 輸入: 無條件
  - 預期: 返回所有樓層的統計資訊

- **測試案例2**: 查詢特定樓層統計
  - 輸入: floorId = "FLOOR001"
  - 預期: 返回FLOOR001的統計資訊

### 7.3 報表功能測試
- **測試案例1**: 產生明細報表
  - 輸入: reportType = "DETAIL"
  - 預期: 產生包含詳細資料的報表

- **測試案例2**: 產生彙總報表
  - 輸入: reportType = "SUMMARY"
  - 預期: 產生彙總資料的報表

### 7.4 匯出功能測試
- **測試案例1**: 匯出Excel
  - 輸入: exportFormat = "EXCEL"
  - 預期: 產生Excel檔案並可下載

- **測試案例2**: 匯出PDF
  - 輸入: exportFormat = "PDF"
  - 預期: 產生PDF檔案並可下載

---

## 八、參考資料

### 8.1 相關開發計劃
- [SYS6310-SYS6370-樓層資料維護系列.md](./SYS6310-SYS6370-樓層資料維護系列.md)
- [SYS6110-SYS6140-商店資料維護系列.md](../01-商店管理/SYS6110-SYS6140-商店資料維護系列.md)

### 8.2 技術文件
- Element Plus Table 文件
- ECharts 圖表庫文件
- Excel匯出功能文件
- PDF產生功能文件

### 8.3 舊程式參考
- `WEB/IMS_CORE/ASP/SYS6000/SYS6381_FQ.ASP`
- `WEB/IMS_CORE/ASP/SYS6000/SYS63A0_FQ.ASP`
- `WEB/IMS_CORE/ASP/SYS6000/SYS6360_FLOOR_LIST.ASP`

