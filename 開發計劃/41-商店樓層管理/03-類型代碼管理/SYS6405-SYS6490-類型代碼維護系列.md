# SYS6405-SYS6490 - 類型代碼維護系列 開發計劃

## 一、功能概述

### 1.1 功能說明
- **功能代碼**: SYS6405-SYS6490 系列
- **功能名稱**: 類型代碼維護系列
- **功能描述**: 提供類型代碼資料的新增、修改、刪除、查詢功能，包含類型代碼、類型名稱、類型分類、狀態等資訊管理
- **參考舊程式**: 
  - `WEB/IMS_CORE/ASP/SYS6000/SYS6405_*.ASP` (類型代碼相關功能)
  - `WEB/IMS_CORE/ASP/SYS6000/SYS6460_*.ASP` (類型代碼相關功能)
  - `WEB/IMS_CORE/ASP/SYS6000/SYS6490_*.ASP` (類型代碼相關功能)
  - `WEB/IMS_CORE/ASP/SYS6000/BIG_TYPE_LIST.ASP` (大類列表)
  - `WEB/IMS_CORE/ASP/SYS6000/MIDDLE_TYPE_LIST.ASP` (中類列表)
  - `WEB/IMS_CORE/ASP/SYS6000/CODE_LIST.ASP` (代碼列表)

### 1.2 業務需求
- 管理類型代碼基本資料資訊
- 支援類型代碼的新增、修改、刪除、查詢
- 支援類型代碼分類管理（大類、中類、小類）
- 支援類型代碼階層結構管理
- 記錄類型代碼的建立與變更資訊
- 支援類型代碼狀態管理（啟用/停用）

---

## 二、資料庫設計 (Schema)

### 2.1 主要資料表: `TypeCodes` (類型代碼主檔)

```sql
CREATE TABLE [dbo].[TypeCodes] (
    [TypeCodeId] NVARCHAR(50) NOT NULL PRIMARY KEY,
    [TypeCode] NVARCHAR(50) NOT NULL, -- 類型代碼
    [TypeName] NVARCHAR(200) NOT NULL, -- 類型名稱
    [TypeNameEn] NVARCHAR(200) NULL, -- 類型英文名稱
    [TypeCategory] NVARCHAR(50) NULL, -- 類型分類 (BIG:大類, MIDDLE:中類, SMALL:小類)
    [ParentTypeCodeId] NVARCHAR(50) NULL, -- 父類型代碼ID
    [TypeLevel] INT NULL DEFAULT 1, -- 類型階層 (1:大類, 2:中類, 3:小類)
    [SortOrder] INT NULL DEFAULT 0, -- 排序順序
    [Description] NVARCHAR(500) NULL, -- 說明
    [Status] NVARCHAR(10) NOT NULL DEFAULT 'A', -- A:啟用, I:停用
    [CreatedBy] NVARCHAR(50) NULL,
    [CreatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    [UpdatedBy] NVARCHAR(50) NULL,
    [UpdatedAt] DATETIME2 NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_TypeCodes] PRIMARY KEY CLUSTERED ([TypeCodeId] ASC),
    CONSTRAINT [FK_TypeCodes_Parent] FOREIGN KEY ([ParentTypeCodeId]) REFERENCES [dbo].[TypeCodes] ([TypeCodeId])
);

-- 索引
CREATE NONCLUSTERED INDEX [IX_TypeCodes_TypeCode] ON [dbo].[TypeCodes] ([TypeCode]);
CREATE NONCLUSTERED INDEX [IX_TypeCodes_TypeCategory] ON [dbo].[TypeCodes] ([TypeCategory]);
CREATE NONCLUSTERED INDEX [IX_TypeCodes_ParentTypeCodeId] ON [dbo].[TypeCodes] ([ParentTypeCodeId]);
CREATE NONCLUSTERED INDEX [IX_TypeCodes_Status] ON [dbo].[TypeCodes] ([Status]);
CREATE NONCLUSTERED INDEX [IX_TypeCodes_TypeLevel] ON [dbo].[TypeCodes] ([TypeLevel]);
```

### 2.2 資料字典

| 欄位名稱 | 資料類型 | 長度 | 允許NULL | 預設值 | 說明 | 備註 |
|---------|---------|------|---------|--------|------|------|
| TypeCodeId | NVARCHAR | 50 | NO | - | 類型代碼ID | 主鍵 |
| TypeCode | NVARCHAR | 50 | NO | - | 類型代碼 | 唯一 |
| TypeName | NVARCHAR | 200 | NO | - | 類型名稱 | - |
| TypeNameEn | NVARCHAR | 200 | YES | - | 類型英文名稱 | - |
| TypeCategory | NVARCHAR | 50 | YES | - | 類型分類 | BIG:大類, MIDDLE:中類, SMALL:小類 |
| ParentTypeCodeId | NVARCHAR | 50 | YES | - | 父類型代碼ID | 外鍵至TypeCodes |
| TypeLevel | INT | - | YES | 1 | 類型階層 | 1:大類, 2:中類, 3:小類 |
| SortOrder | INT | - | YES | 0 | 排序順序 | - |
| Description | NVARCHAR | 500 | YES | - | 說明 | - |
| Status | NVARCHAR | 10 | NO | 'A' | 狀態 | A:啟用, I:停用 |
| CreatedBy | NVARCHAR | 50 | YES | - | 建立者 | - |
| CreatedAt | DATETIME2 | - | NO | GETDATE() | 建立時間 | - |
| UpdatedBy | NVARCHAR | 50 | YES | - | 更新者 | - |
| UpdatedAt | DATETIME2 | - | NO | GETDATE() | 更新時間 | - |

---

## 三、後端 API 設計

### 3.1 API 端點列表

#### 3.1.1 查詢類型代碼列表
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/type-codes`
- **說明**: 查詢類型代碼列表，支援分頁、排序、篩選
- **請求參數**:
  ```json
  {
    "pageIndex": 1,
    "pageSize": 20,
    "sortField": "SortOrder",
    "sortOrder": "ASC",
    "filters": {
      "typeCode": "",
      "typeName": "",
      "typeCategory": "",
      "typeLevel": null,
      "status": ""
    }
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": {
      "items": [
        {
          "typeCodeId": "TYPE001",
          "typeCode": "BIG001",
          "typeName": "大類一",
          "typeNameEn": "Big Category 1",
          "typeCategory": "BIG",
          "parentTypeCodeId": null,
          "typeLevel": 1,
          "sortOrder": 1,
          "status": "A"
        }
      ],
      "totalCount": 100,
      "pageIndex": 1,
      "pageSize": 20,
      "totalPages": 5
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.2 查詢單筆類型代碼
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/type-codes/{typeCodeId}`
- **說明**: 根據類型代碼ID查詢單筆類型代碼資料
- **路徑參數**:
  - `typeCodeId`: 類型代碼ID
- **回應格式**: 同查詢列表單筆資料格式

#### 3.1.3 查詢類型代碼樹狀結構
- **HTTP 方法**: `GET`
- **路徑**: `/api/v1/type-codes/tree`
- **說明**: 查詢類型代碼的樹狀結構（包含父子關係）
- **請求參數**:
  ```json
  {
    "typeCategory": "",
    "includeDisabled": false
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "查詢成功",
    "data": [
      {
        "typeCodeId": "TYPE001",
        "typeCode": "BIG001",
        "typeName": "大類一",
        "typeLevel": 1,
        "children": [
          {
            "typeCodeId": "TYPE002",
            "typeCode": "MID001",
            "typeName": "中類一",
            "typeLevel": 2,
            "children": []
          }
        ]
      }
    ],
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.4 新增類型代碼
- **HTTP 方法**: `POST`
- **路徑**: `/api/v1/type-codes`
- **說明**: 新增類型代碼資料
- **請求格式**:
  ```json
  {
    "typeCode": "BIG001",
    "typeName": "大類一",
    "typeNameEn": "Big Category 1",
    "typeCategory": "BIG",
    "parentTypeCodeId": null,
    "typeLevel": 1,
    "sortOrder": 1,
    "description": "說明",
    "status": "A"
  }
  ```
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "新增成功",
    "data": {
      "typeCodeId": "TYPE001"
    },
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.5 修改類型代碼
- **HTTP 方法**: `PUT`
- **路徑**: `/api/v1/type-codes/{typeCodeId}`
- **說明**: 修改類型代碼資料
- **路徑參數**:
  - `typeCodeId`: 類型代碼ID
- **請求格式**: 同新增，但 `typeCodeId` 不可修改
- **回應格式**: 同新增

#### 3.1.6 刪除類型代碼
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/type-codes/{typeCodeId}`
- **說明**: 刪除類型代碼資料（需檢查是否有子類型代碼）
- **路徑參數**:
  - `typeCodeId`: 類型代碼ID
- **回應格式**:
  ```json
  {
    "success": true,
    "code": 200,
    "message": "刪除成功",
    "data": null,
    "timestamp": "2024-01-01T00:00:00Z"
  }
  ```

#### 3.1.7 批次刪除類型代碼
- **HTTP 方法**: `DELETE`
- **路徑**: `/api/v1/type-codes/batch`
- **說明**: 批次刪除多筆類型代碼
- **請求格式**:
  ```json
  {
    "typeCodeIds": ["TYPE001", "TYPE002"]
  }
  ```

---

## 四、前端 UI 設計

### 4.1 維護頁面 (`TypeCodeMaintenance.vue`)

#### 4.1.1 頁面結構
- **查詢條件區塊**
  - 類型代碼輸入框
  - 類型名稱輸入框
  - 類型分類下拉選單（全部/大類/中類/小類）
  - 類型階層下拉選單
  - 狀態下拉選單（全部/啟用/停用）
  - 查詢按鈕、重置按鈕

- **資料維護區塊**
  - 樹狀結構顯示（Element Plus Tree）
  - 資料表格（Element Plus Table）
    - 類型代碼
    - 類型名稱
    - 類型英文名稱
    - 類型分類
    - 類型階層
    - 排序順序
    - 狀態
    - 操作欄位（新增、修改、刪除）
  - 分頁組件

#### 4.1.2 功能按鈕
- **新增**: 開啟新增對話框
- **修改**: 開啟修改對話框
- **刪除**: 刪除選取的類型代碼（需確認）
- **批次刪除**: 批次刪除選取的類型代碼
- **查詢**: 執行查詢作業
- **重置**: 清空查詢條件
- **匯出**: 匯出查詢結果

### 4.2 新增/修改對話框 (`TypeCodeDialog.vue`)

#### 4.2.1 表單欄位
- 類型代碼（必填，新增時可輸入，修改時不可修改）
- 類型名稱（必填）
- 類型英文名稱
- 類型分類（下拉選單：大類/中類/小類）
- 父類型代碼（下拉選單，根據類型分類動態載入）
- 類型階層（自動計算或手動設定）
- 排序順序（數字輸入）
- 說明（文字區域）
- 狀態（下拉選單：啟用/停用）

---

## 五、開發時程

### 5.1 後端開發 (6天)
- Day 1-2: 資料庫設計與查詢邏輯開發
- Day 3: API 端點開發（查詢、新增、修改、刪除）
- Day 4: 樹狀結構查詢API開發
- Day 5: 批次操作API開發
- Day 6: 測試與優化

### 5.2 前端開發 (6天)
- Day 1-2: 維護頁面開發
- Day 3: 樹狀結構顯示開發
- Day 4: 新增/修改對話框開發
- Day 5: 批次操作功能開發
- Day 6: 整合測試、優化

### 5.3 測試 (2天)
- Day 1: 單元測試、整合測試
- Day 2: 使用者驗收測試

**總計**: 14天

---

## 六、注意事項

### 6.1 資料庫
- 類型代碼需要支援階層結構（父子關係）
- 刪除類型代碼時需要檢查是否有子類型代碼
- 注意查詢效能，建議使用索引優化

### 6.2 API
- 樹狀結構查詢需要遞迴處理
- 刪除操作需要檢查關聯資料
- 批次操作需要處理交易

### 6.3 前端
- 樹狀結構顯示需要使用Tree組件
- 新增/修改時需要動態載入父類型代碼選項
- 刪除前需要確認是否有子類型代碼

### 6.4 業務邏輯
- 類型階層需要自動計算或手動設定
- 排序順序需要支援拖曳排序
- 類型代碼需要唯一性檢查

---

## 七、測試案例

### 7.1 新增功能測試
- **測試案例1**: 新增大類類型代碼
  - 輸入: typeCategory = "BIG", typeLevel = 1
  - 預期: 成功新增大類類型代碼

- **測試案例2**: 新增中類類型代碼（需指定父類型）
  - 輸入: typeCategory = "MIDDLE", parentTypeCodeId = "TYPE001"
  - 預期: 成功新增中類類型代碼

### 7.2 修改功能測試
- **測試案例1**: 修改類型代碼名稱
  - 輸入: typeCodeId = "TYPE001", typeName = "新名稱"
  - 預期: 成功修改類型代碼名稱

### 7.3 刪除功能測試
- **測試案例1**: 刪除無子類型代碼的類型代碼
  - 輸入: typeCodeId = "TYPE001"（無子類型）
  - 預期: 成功刪除

- **測試案例2**: 刪除有子類型代碼的類型代碼
  - 輸入: typeCodeId = "TYPE001"（有子類型）
  - 預期: 刪除失敗，提示需先刪除子類型代碼

### 7.4 查詢功能測試
- **測試案例1**: 查詢所有類型代碼
  - 輸入: 無條件
  - 預期: 返回所有類型代碼

- **測試案例2**: 查詢樹狀結構
  - 輸入: 無條件
  - 預期: 返回樹狀結構的類型代碼

---

## 八、參考資料

### 8.1 相關開發計劃
- [SYS6501-SYS6560-類型代碼查詢系列.md](./SYS6501-SYS6560-類型代碼查詢系列.md)
- [SYS6110-SYS6140-商店資料維護系列.md](../01-商店管理/SYS6110-SYS6140-商店資料維護系列.md)

### 8.2 技術文件
- Element Plus Tree 文件
- Element Plus Table 文件
- 樹狀結構處理文件

### 8.3 舊程式參考
- `WEB/IMS_CORE/ASP/SYS6000/SYS6405_*.ASP`
- `WEB/IMS_CORE/ASP/SYS6000/SYS6460_*.ASP`
- `WEB/IMS_CORE/ASP/SYS6000/SYS6490_*.ASP`
- `WEB/IMS_CORE/ASP/SYS6000/BIG_TYPE_LIST.ASP`
- `WEB/IMS_CORE/ASP/SYS6000/MIDDLE_TYPE_LIST.ASP`
- `WEB/IMS_CORE/ASP/SYS6000/CODE_LIST.ASP`

